<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re:mod_python and connection to database. (Rodion)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3Amod_python%20and%20connection%20to%20database.%20%28Rodion%29&In-Reply-To=227210.97103.qm%40web23301.mail.ird.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024329.html">
   <LINK REL="Next"  HREF="024333.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re:mod_python and connection to database. (Rodion)</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3Amod_python%20and%20connection%20to%20database.%20%28Rodion%29&In-Reply-To=227210.97103.qm%40web23301.mail.ird.yahoo.com"
       TITLE="[mod_python] Re:mod_python and connection to database. (Rodion)">graham.dumpleton at gmail.com
       </A><BR>
    <I>Sat Oct 13 20:06:15 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024329.html">[mod_python] Re:mod_python and connection to database. (Rodion)
</A></li>
        <LI>Next message: <A HREF="024333.html">[mod_python] Re:mod_python and connection to database.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24331">[ date ]</a>
              <a href="thread.html#24331">[ thread ]</a>
              <a href="subject.html#24331">[ subject ]</a>
              <a href="author.html#24331">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hmm, I not sure if this is an answer to your own question or you are
replying to a really old post, as I don't remember the question.

Either way, the code being presented as an example on the way to solve
this is unsafe for a number of reasons.

The first reason is that it isn't thread protected and thus isn't safe
in a multithread process such as when Apache UNIX worker MPM or
Windows winnt MPM is used. This is because multiple handlers could be
executing concurrently and both decide the global database handle
needs to be created. This could result in wasted resources.

A second possible problem which can occur is where the global database
handle and the code for creating it, is placed in a code module which
is the subject of automatic reloading. So, once threading issues are
dealt with then okay, but do not go putting it in the same code file
as your mod_python handlers, or in general anywhere in the document
tree. Instead put it in a module somewhere else on sys.path outside of
the document tree. For an example of why this can be a problem see:

  <A HREF="http://groups.google.com/group/sqlalchemy/browse_thread/thread/5193bc7598f045fb#">http://groups.google.com/group/sqlalchemy/browse_thread/thread/5193bc7598f045fb#</A>

Also ensure you read documentation for import_module() in:

  <A HREF="http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html">http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html</A>

It mentions a bit about resource leakage and transferring data from
old module to new module. Ensure you are using mod_python 3.3.1
though, as older versions were a bit less predictable.

  <A HREF="http://www.dscpl.com.au/wiki/ModPython/Articles/ModuleImportingIsBroken">http://www.dscpl.com.au/wiki/ModPython/Articles/ModuleImportingIsBroken</A>

Graham

On 14/10/2007, Thimios Katsoulis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">thkatsou at yahoo.gr</A>&gt; wrote:
&gt;<i> Hello.
</I>&gt;<i>
</I>&gt;<i> Sorry for my poor english. Here is my mod_python code. This is a simple
</I>&gt;<i> URL shorter:
</I>&gt;<i>
</I>&gt;<i> from mod_python import apache, util
</I>&gt;<i> import psycopg2 as psycopg
</I>&gt;<i>
</I>&gt;<i> def handler(req):
</I>&gt;<i>      req.content_type = &quot;text/plain&quot;
</I>&gt;<i>      url_id = req.args
</I>&gt;<i>      connection = psycopg.connect(&quot;dbname=my_db&quot;)
</I>&gt;<i>      cursor = connection.cursor()
</I>&gt;<i>      cursor.execute(&quot;&quot;&quot;SELECT myurl FROM urls WHERE myid=%s&quot;&quot;&quot;,(url_id))
</I>&gt;<i>      original_url = cursor.fetchone()[0]
</I>&gt;<i>      connection.close()
</I>&gt;<i>      util.redirect(req,original_url)
</I>&gt;<i>      req.status = apache.DONE
</I>&gt;<i>      return apache.DONE
</I>&gt;<i>
</I>&gt;<i> This programme connects database everytime, but I want(need) force him
</I>&gt;<i> to connect it continously
</I>&gt;<i>
</I>&gt;<i> This script connects database everytime (psycopg.connect(&quot;dbname=my_db&quot;)
</I>&gt;<i> , but I nedd force to stay conneceted with it continously. It is
</I>&gt;<i> possible to make that in mod_python ? I have mod_python 3.2.10
</I>&gt;<i>
</I>&gt;<i> Thanks in advance.
</I>&gt;<i> rdn
</I>&gt;<i> ---------------
</I>&gt;<i>
</I>&gt;<i> Yes mod_python can maintain global variables per interpreter, so you can open once the connection
</I>&gt;<i> and all subsequent requests will use the opened connection.
</I>&gt;<i> You have to declare your connection variable as global e.g. :
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     def getConn(self):
</I>&gt;<i>
</I>&gt;<i>         try:
</I>&gt;<i>             if _conn == None:
</I>&gt;<i>                 self.openConn()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         except NameError:
</I>&gt;<i>             self.openConn()
</I>&gt;<i>         return _conn
</I>&gt;<i>
</I>&gt;<i>     def openConn(self):
</I>&gt;<i>
</I>&gt;<i>         global _conn
</I>&gt;<i>         _conn = connect(self.ConnStr)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So when you want to access it you call self.getConn().
</I>&gt;<i> The _conn global variable will instantiate once for each mod_python apache process.
</I>&gt;<i> You can include some apache.log_error calls in the code above to watch
</I>&gt;<i> for yourself when the  _conn varible gets instantiated and when it is retreived as global.
</I>&gt;<i> Please take notice from what I have observed that while you maintain open connections to DB (postgresql too in my case)
</I>&gt;<i> you cannot change structure of the tables etc in the DB..
</I>&gt;<i> Of course if you are using modules and not objects you have to alter  the code to  support (removing self ..) modules.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ___________________________________________________________
</I>&gt;<i> &#935;&#961;&#951;&#963;&#953;&#956;&#959;&#960;&#959;&#953;&#949;&#943;&#964;&#949; Yahoo!;
</I>&gt;<i> &#914;&#945;&#961;&#949;&#952;&#942;&#954;&#945;&#964;&#949; &#964;&#945; &#949;&#957;&#959;&#967;&#955;&#951;&#964;&#953;&#954;&#940; &#956;&#951;&#957;&#973;&#956;&#945;&#964;&#945; (spam); &#932;&#959; Yahoo! Mail
</I>&gt;<i> &#948;&#953;&#945;&#952;&#941;&#964;&#949;&#953; &#964;&#951;&#957; &#954;&#945;&#955;&#973;&#964;&#949;&#961;&#951; &#948;&#965;&#957;&#945;&#964;&#942; &#960;&#961;&#959;&#963;&#964;&#945;&#963;&#943;&#945; &#954;&#945;&#964;&#940; &#964;&#969;&#957; &#949;&#957;&#959;&#967;&#955;&#951;&#964;&#953;&#954;&#974;&#957;
</I>&gt;<i> &#956;&#951;&#957;&#965;&#956;&#940;&#964;&#969;&#957; <A HREF="http://login.yahoo.com/config/mail?.intl=gr">http://login.yahoo.com/config/mail?.intl=gr</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024329.html">[mod_python] Re:mod_python and connection to database. (Rodion)
</A></li>
	<LI>Next message: <A HREF="024333.html">[mod_python] Re:mod_python and connection to database.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24331">[ date ]</a>
              <a href="thread.html#24331">[ thread ]</a>
              <a href="subject.html#24331">[ subject ]</a>
              <a href="author.html#24331">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
