<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Concurrence and virtual host interpreter python
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Concurrence%20and%20virtual%20host%20interpreter%20python&In-Reply-To=46FEA6A7.4030800%40jgassociates.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="024267.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Concurrence and virtual host interpreter python</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Pau Freixes</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Concurrence%20and%20virtual%20host%20interpreter%20python&In-Reply-To=46FEA6A7.4030800%40jgassociates.ca"
       TITLE="[mod_python] Concurrence and virtual host interpreter python">pfreixes at milnou.net
       </A><BR>
    <I>Mon Oct  1 03:08:19 EDT 2007</I>
    <P><UL>
        
        <LI>Next message: <A HREF="024267.html">[mod_python] mod_python or apache scalability?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24265">[ date ]</a>
              <a href="thread.html#24265">[ thread ]</a>
              <a href="subject.html#24265">[ subject ]</a>
              <a href="author.html#24265">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Jim,

Thanks for your answer, and yes i didn't think with kind of mpm was work
in my apache environment, and of course this it's very important.

I m working with mpm-prefork module, for php and debian restrictions ( I
don't like open a discussion about this :) )

OK first, i test another time my index.py script with ab tool. And the
results are :

Server Software:        Apache/2.2.3
Server Hostname:        pfreixes.mynewsonline.com
Server Port:            80

Document Path:          /index.py
Document Length:        120 bytes

Concurrency Level:      4
Time taken for tests:   9.173665 seconds
Complete requests:      4
Failed requests:        0
Write errors:           0
Total transferred:      1420 bytes
HTML transferred:       480 bytes
Requests per second:    0.44 [#/sec] (mean)
Time per request:       9173.665 [ms] (mean)
Time per request:       2293.416 [ms] (mean, across all concurrent
requests)
Transfer rate:          0.11 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0   24  16.5     33      33
Processing:  9087 9123  39.6   9136    9173
Waiting:       83  112  28.4    135     139
Total:       9120 9147  27.2   9169    9173

Ok and the log of apache server is

192.168.0.222 - - [01/Oct/2007:08:48:03 +0200] &quot;GET /index.py HTTP/1.0&quot;
200 120 &quot;-&quot; &quot;ApacheBench/2.0.40-dev&quot;
192.168.0.222 - - [01/Oct/2007:08:48:03 +0200] &quot;GET /index.py HTTP/1.0&quot;
200 120 &quot;-&quot; &quot;ApacheBench/2.0.40-dev&quot;
192.168.0.222 - - [01/Oct/2007:08:48:03 +0200] &quot;GET /index.py HTTP/1.0&quot;
200 120 &quot;-&quot; &quot;ApacheBench/2.0.40-dev&quot;
192.168.0.222 - - [01/Oct/2007:08:48:03 +0200] &quot;GET /index.py HTTP/1.0&quot;
200 120 &quot;-&quot; &quot;ApacheBench/2.0.40-dev&quot;


My index.py, it's like this

    for i in range(1,10):
        req.write(&quot;Value is %d\r\n&quot; % VALUE)
        time.sleep(1)

        # change global variable
        VALUE = VALUE + 1;

In definitive, the request share cpu time, why ? this is not a ease
response because this can be for only kernel scheduling between the
process ( every hit is a diferent process ) or becasuse a same
interpreters shared with process are linked with some SHM/IPC mechanism.

But at this point, i think the best question about all environment is how
python share a subinterpreter in a multi fork environment ?  Any ideas
about this ?

This is not my objective, :P. I need learn in a pure thread environment
but i think a some of culture about internal python mechanism can be
positive for me.

Thks to all.


A 29/9/2007, &quot;Jim Gallacher&quot; &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jpg at jgassociates.ca</A>&gt; va escriure:

&gt;<i>Pau Freixes wrote:
</I>&gt;&gt;<i> Hi to all, Im new in a list.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Well, this last days I was work for testing and learn how work with multi
</I>&gt;&gt;<i> thread and multi interpreter environment in embedding python in C
</I>&gt;&gt;<i> applications, and of course mod_python it's a excellent place for
</I>&gt;&gt;<i> understand this.
</I>&gt;<i>
</I>&gt;<i>You'll need to throw multi-process into the mix of things to understand.
</I>&gt;<i>  I'm not actually sure if mod_python *is* an excellent environment for
</I>&gt;<i>your learning endeavours as there are a number of complicating factors
</I>&gt;<i>introduced by apache and your browser.
</I>&gt;<i>
</I>&gt;<i>The behaviour that you'll see will depend on which apache mpm you are
</I>&gt;<i>using: prefork, worker or winnt. If you haven't already done so you
</I>&gt;<i>should take a look at <A HREF="http://httpd.apache.org/docs/2.0/mpm.html">http://httpd.apache.org/docs/2.0/mpm.html</A>
</I>&gt;<i>
</I>&gt;<i>In order to effectively answer your questions you'll need to let us know
</I>&gt;<i>  us know which mpm you are using. Also, what are you using as your
</I>&gt;<i>client?
</I>&gt;<i>
</I>&gt;&gt;<i> Ok, with my lectures and test with mod_python code, i have a some
</I>&gt;&gt;<i> questions, somebody can help me for understand this concepts ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. I was try multi concurrence in a virtual host python script with this
</I>&gt;&gt;<i> easy code
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> def handler(req):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     # Request Content Type
</I>&gt;&gt;<i>     req.content_type = &quot;text/plain&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     VALUE2 = 1
</I>&gt;&gt;<i>     for i in range(1,10):
</I>&gt;&gt;<i>         req.write(&quot;Value is %d\r\n&quot; % VALUE2)
</I>&gt;&gt;<i>         time.sleep(5)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         # change global variable
</I>&gt;&gt;<i>         VALUE2 = VALUE2 + 1;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     req.write(&quot;Hellow World&quot;)
</I>&gt;&gt;<i>     return apache.OK
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And my surprise it's that apache only process the next request when the
</I>&gt;&gt;<i> previous request has been served. !!
</I>&gt;&gt;<i> I don't understand this strange behavior, because mod_python it's made
</I>&gt;&gt;<i> for accept concurrent threads in same interpreter, and i test a similar
</I>&gt;&gt;<i> situation  in a c code and it's possible do run some threads at same
</I>&gt;&gt;<i> time in same interpreter.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> time.sleep(5) it's a pretty situation for python core for change the
</I>&gt;&gt;<i> context and release GIL and assign to this to other thread. yes ?
</I>&gt;<i>
</I>&gt;<i>Are you sure you're not seeing an artifact of the browser keeping the
</I>&gt;<i>connection open? If this is the case then your request is being
</I>&gt;<i>serialized by apache and the GIL doesn't enter into it.
</I>&gt;<i>
</I>&gt;<i>You could play with your apache config (KeepAlive off and so on), but
</I>&gt;<i>it's likely easier to use a different test client such as wget. Also,
</I>&gt;<i>modify your req.write() calls to immediately flush the data, which will
</I>&gt;<i>make it easier to see what's going on. eg. req.write(&quot;something&quot;,1)
</I>&gt;<i>
</I>&gt;<i>Open multiple terminals and run the following in each simultaneously (or
</I>&gt;<i>as near as you can make it).
</I>&gt;<i>
</I>&gt;<i>wget -S -O - <A HREF="http://..../index.py">http://..../index.py</A>
</I>&gt;<i>
</I>&gt;<i>I think you'll see that mod_python is behaving exactly as you'd expect.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. And de second question it's in similar situation, when you reuse a
</I>&gt;&gt;<i> interpreter for all request to same virtual host, with this code :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> import time
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> VALUE = 1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> def handler(req):
</I>&gt;&gt;<i>     global VALUE
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     # Request Content Type
</I>&gt;&gt;<i>     req.content_type = &quot;text/plain&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     for i in range(1,10):
</I>&gt;&gt;<i>         req.write(&quot;Value is %d\r\n&quot; % VALUE)
</I>&gt;&gt;<i>         time.sleep(5)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         # change global variable
</I>&gt;&gt;<i>         VALUE = VALUE + 1;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     req.write(&quot;Hellow World&quot;)
</I>&gt;&gt;<i>     return apache.OK
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> VALUE it's a global variable for de index.py, and subsequent request for
</I>&gt;&gt;<i> the same url (<A HREF="http://...../index.py">http://...../index.py</A>) show one incremental value for
</I>&gt;&gt;<i> VALUE. For example, this two request produced this two results
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://...../index.py">http://...../index.py</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Value is 1
</I>&gt;&gt;<i> Value is 2
</I>&gt;&gt;<i> Value is 3
</I>&gt;&gt;<i> Value is 4
</I>&gt;&gt;<i> Value is 5
</I>&gt;&gt;<i> Value is 6
</I>&gt;&gt;<i> Value is 7
</I>&gt;&gt;<i> Value is 8
</I>&gt;&gt;<i> Value is 9
</I>&gt;&gt;<i> Hellow World
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://...../index.py">http://...../index.py</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Value is 10
</I>&gt;&gt;<i> Value is 11
</I>&gt;&gt;<i> Value is 12
</I>&gt;&gt;<i> Value is 13
</I>&gt;&gt;<i> Value is 14
</I>&gt;&gt;<i> Value is 15
</I>&gt;&gt;<i> Value is 16
</I>&gt;&gt;<i> Value is 17
</I>&gt;&gt;<i> Value is 18
</I>&gt;&gt;<i> Hellow World
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ok, this situation it's really and i think its very normal because only
</I>&gt;&gt;<i> callback to handler it's made with the same interpreter and VALUE is
</I>&gt;&gt;<i> not re assigned to value 1, may be ?
</I>&gt;<i>
</I>&gt;<i>The statement &quot;VALUE = 1&quot; is only evaluated when the module (index.py)
</I>&gt;<i>is first loaded. It is not re-evaluated for each request. Note however
</I>&gt;<i>that VALUE should *not* be considered a global variable. Depending on
</I>&gt;<i>which apache mpm is being used you could have multiple, independent
</I>&gt;<i>copies of VALUE. Using the mpm-prefork and the default MaxClients value
</I>&gt;<i>of 256, you could potentially have 256 copies of VALUE if your server is
</I>&gt;<i>under a heavy load. A similar situation exists with mpm-worker where you
</I>&gt;<i>could still have a number of independent multi-threaded child processes.
</I>&gt;<i>
</I>&gt;&gt;<i> 3. And the most important question, why mod_python not use a separate
</I>&gt;&gt;<i> interpreters for all request ?
</I>&gt;<i>
</I>&gt;<i>I'm not 100% sure what you are asking. Do you mean a separate
</I>&gt;<i>interpreter for each request? If so then the resource usage would be
</I>&gt;<i>unacceptably high. The default is to have a separate subinterpreter for
</I>&gt;<i>each virtual host.
</I>&gt;<i>
</I>&gt;<i>Jim
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="024267.html">[mod_python] mod_python or apache scalability?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24265">[ date ]</a>
              <a href="thread.html#24265">[ thread ]</a>
              <a href="subject.html#24265">[ subject ]</a>
              <a href="author.html#24265">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
