<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] mod_python or apache scalability?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20or%20apache%20scalability%3F&In-Reply-To=022001c8040b%2431c20790%24954616b0%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024267.html">
   <LINK REL="Next"  HREF="024274.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] mod_python or apache scalability?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20or%20apache%20scalability%3F&In-Reply-To=022001c8040b%2431c20790%24954616b0%24%40com"
       TITLE="[mod_python] mod_python or apache scalability?">graham.dumpleton at gmail.com
       </A><BR>
    <I>Mon Oct  1 07:12:26 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024267.html">[mod_python] mod_python or apache scalability?
</A></li>
        <LI>Next message: <A HREF="024274.html">[mod_python] mod_python or apache scalability?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24269">[ date ]</a>
              <a href="thread.html#24269">[ thread ]</a>
              <a href="subject.html#24269">[ subject ]</a>
              <a href="author.html#24269">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In order so we can understand things better ...

1. Please explain what application you are running on top of
mod_python. Show the Apache configuration applying to the application
you are running on top of mod_python.

2. Explain why you are running prefork and not worker MPM. Are you
also running some PHP application that will not work with worker MPM?

3. Explain what the relationship is between your mod_python
application and your memory hogging twisted back end processes, ie.,
do they communicate with each other and how.

4. Indicate how big your Apache and twisted processes are growing.

5. Indicate whether you have used the netstat program to try and
determine how many socket connections are being held open by Apache
and twisted processes.

6. Indicate whether you have tried changing the Apache configuration
for how many keep alive connections are maintained and how long keep
alive connections are kept open. For some guidance on these see recent
blog post at:

  <A HREF="http://lucumr.pocoo.org/cogitations/2007/09/30/pushing-apache-performance">http://lucumr.pocoo.org/cogitations/2007/09/30/pushing-apache-performance</A>

7. Indicate what range of values you have experimented with for
MaxRequestsPerChild.

At the moment the description of your problem is a bit vague so all
the above detail would help immensely as far as us being able to given
any ideas.

Please try not to gloss over details, the more details you give the
more helpful we might be able to be. For example, you don't even
mention that your system is shared with some very large twisted
processes. I only know that this might be the case from a short
followup you made to HTTPD dev list. When you say twisted, I presume
though you mean Python Twisted framework.

Graham

On 01/10/2007, Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at matusis.com</A>&gt; wrote:
&gt;<i> I am sorry in advance if this turns out to be an apache-related issue, but
</I>&gt;<i> when I posted this on apache list, it has been suggested that it might be an
</I>&gt;<i> application issue, so I am reposting it here.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> We are running a busy mod_python/3.1.4 Python/2.4.1 server on 2.6.9 kernel,
</I>&gt;<i> that suddenly becomes very slow- requests either time out, or it takes
</I>&gt;<i> 10-20sec to serve a 1K thumbnail.
</I>&gt;<i> It is somewhat correlated with load spikes, but not perfectly (by looking at
</I>&gt;<i> the bandwidth graph, it never happens during the low bandwidth periods at
</I>&gt;<i> night, but it does not coincide with peaks of b/w)
</I>&gt;<i>
</I>&gt;<i> When we initially encountered an apache overload, it was always accompanied
</I>&gt;<i> with
</I>&gt;<i>
</I>&gt;<i> [error] server reached MaxClients setting, consider raising the MaxClients
</I>&gt;<i> setting
</I>&gt;<i>
</I>&gt;<i> in the apache error log. We also got
</I>&gt;<i>
</I>&gt;<i> kernel: possible SYN flooding on port 80. Sending cookies.
</I>&gt;<i>
</I>&gt;<i> in /var/log/messages system log.
</I>&gt;<i>
</I>&gt;<i> After that I raised MaxClients from 200 to 300. The problem initially
</I>&gt;<i> disappeared, but after our bandwidth grew a bit more, we got this behavior
</I>&gt;<i> again.
</I>&gt;<i> Now apache crashes (becomes very slow) silently, with no warning in apache
</I>&gt;<i> error logs at all (although we still get SYN flood message in the system
</I>&gt;<i> log)
</I>&gt;<i> When apache is this 'slow' regime, /server-status still shows available
</I>&gt;<i> slots, i.e. MaxClients is not reached.
</I>&gt;<i>
</I>&gt;<i> This is the relevant part of httpd.conf:
</I>&gt;<i>
</I>&gt;<i> ServerLimit 300
</I>&gt;<i> # we are using prefork MPM
</I>&gt;<i> StartServers 10
</I>&gt;<i> MinSpareServers 5
</I>&gt;<i> MaxSpareServers 20
</I>&gt;<i> MaxClients 300
</I>&gt;<i> MaxRequestsPerChild 10000
</I>&gt;<i> MaxMemFree 2500
</I>&gt;<i>
</I>&gt;<i> The server has 4GB of physical RAM and 4GB of swap. During these apache
</I>&gt;<i> &quot;slowdowns&quot;, the swap size is still 0 and vmstat shows no swapping at all.
</I>&gt;<i> I suspect the problem may be in
</I>&gt;<i>
</I>&gt;<i> MaxMemFree 2500
</I>&gt;<i>
</I>&gt;<i> but then I would expect some kind of&quot;out of memory&quot; errors in the logs?
</I>&gt;<i>
</I>&gt;<i> I am posting it on this list since I have not gotten a response in the users
</I>&gt;<i> list, and I think it's a bug for two reasons:
</I>&gt;<i>
</I>&gt;<i> 1) When apache is in this slow &quot;degraded&quot; regime, I would expect a log
</I>&gt;<i> message in the apache error log, with an explanation why.
</I>&gt;<i>
</I>&gt;<i> 3) If this is related to resource exhaustion, I would expect the server to
</I>&gt;<i> recover from this regime by itself when the load subsides, but this is not
</I>&gt;<i> the case. Only apachectl start/stop recovers the server.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I></PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024267.html">[mod_python] mod_python or apache scalability?
</A></li>
	<LI>Next message: <A HREF="024274.html">[mod_python] mod_python or apache scalability?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24269">[ date ]</a>
              <a href="thread.html#24269">[ thread ]</a>
              <a href="subject.html#24269">[ subject ]</a>
              <a href="author.html#24269">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
