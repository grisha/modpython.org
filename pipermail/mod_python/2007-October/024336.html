<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: Mod_python Digest, Vol 55, Issue 19
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20Mod_python%20Digest%2C%20Vol%2055%2C%20Issue%2019&In-Reply-To=869563.43216.qm%40web23301.mail.ird.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024335.html">
   <LINK REL="Next"  HREF="024337.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: Mod_python Digest, Vol 55, Issue 19</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20Mod_python%20Digest%2C%20Vol%2055%2C%20Issue%2019&In-Reply-To=869563.43216.qm%40web23301.mail.ird.yahoo.com"
       TITLE="[mod_python] Re: Mod_python Digest, Vol 55, Issue 19">graham.dumpleton at gmail.com
       </A><BR>
    <I>Mon Oct 15 22:09:06 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024335.html">[mod_python] Re: Mod_python Digest, Vol 55, Issue 19
</A></li>
        <LI>Next message: <A HREF="024337.html">[mod_python] Reading data from a POST using chuncked mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24336">[ date ]</a>
              <a href="thread.html#24336">[ thread ]</a>
              <a href="subject.html#24336">[ subject ]</a>
              <a href="author.html#24336">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/10/2007, Thimios Katsoulis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">thkatsou at yahoo.gr</A>&gt; wrote:
&gt;<i> On 15/10/2007, Thimios Katsoulis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">thkatsou at yahoo.gr</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;Hmm, I not sure if this is an answer to your own question or you are
</I>&gt;<i> &gt; &gt;replying to a really old post, as I don't remember the question.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;Either way, the code being presented as an example on the way to solve
</I>&gt;<i> &gt; &gt;this is unsafe for a number of reasons.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;The first reason is that it isn't thread protected and thus isn't safe
</I>&gt;<i> &gt; &gt;in a multithread process such as when Apache UNIX worker MPM or
</I>&gt;<i> &gt; &gt;Windows winnt MPM is used. This is because multiple handlers could be
</I>&gt;<i> &gt; &gt;executing concurrently and both decide the global database handle
</I>&gt;<i> &gt; &gt;needs to be created.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; What you mean by multiple handlers ? Multithreaded apache that has multiple threads
</I>&gt;<i> &gt; in each process? So in this case global variables are shared
</I>&gt;<i> &gt;  between different threads in the same process
</I>&gt;<i> &gt; right?
</I>&gt;<i>
</I>&gt;<i> &gt;Correct, and if code running in multiple threads try and set or update
</I>&gt;<i> &gt;the global data they can interfere with each other. Standard
</I>&gt;<i> &gt;multithread programming issues.
</I>&gt;<i>
</I>&gt;<i> By the way is this the default behavior of apache and mod_python meaning:
</I>&gt;<i>   + multiple mod_python threads  that each run  a single application (mod_python handler)
</I>&gt;<i> or maybe
</I>&gt;<i> Multiple apache processes +  multiple  mod_python threads  even more than one per application (virtual host)?
</I>
You only have threads when using an Apache MPM that uses multithreading. See:

  <A HREF="http://www.dscpl.com.au/wiki/ModPython/Articles/TheProcessInterpreterModel">http://www.dscpl.com.au/wiki/ModPython/Articles/TheProcessInterpreterModel</A>

or for an updated version, albeit focused around mod_wsgi, read:

  <A HREF="http://code.google.com/p/modwsgi/wiki/ProcessesAndThreading">http://code.google.com/p/modwsgi/wiki/ProcessesAndThreading</A>

&gt;<i> Is there a way that we can determine hoe we run ?
</I>&gt;<i> Perhaps through apache.mpm_query?
</I>&gt;<i> Noticing in mpm_query :
</I>&gt;<i> AP_MPMQ_IS_THREADED        = 2  # MPM can do threading
</I>
For an example of how the WSGI environment flags are calculated in a
mod_python WSGI adapter see:

  <A HREF="http://www.aminus.org/blogs/index.php/fumanchu/2005/11/06/wsgi_wrapper_for_mod_python">http://www.aminus.org/blogs/index.php/fumanchu/2005/11/06/wsgi_wrapper_for_mod_python</A>

So yes, AP_MPMQ_IS_THREADED does come in to play.

&gt;<i> Does this mean we run in multiple threads per apache process mode?
</I>
Yes, a single handler may have multiple threads running concurrently
within it for different requests.

&gt;<i> And asking again: Running in multiple threads means
</I>&gt;<i> even  more than one thread per mod_python virtual host, or just a thread for each
</I>&gt;<i> virtual host(that is handled by a mod_python handler)?
</I>
The Apache thread pool is shared across all requests regardless of
what VirtualHost definitions exist or how many mod_python handlers may
be used.

&gt;<i> And something else : multiple threads share only global variables or also
</I>&gt;<i> other kinds of variables class members for example?
</I>
It is all exactly the same as if you were running a standard Python
program which used multiple threads.

&gt;<i> &gt; &gt;This could result in wasted resources.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Wasted resources? Pls explain.
</I>&gt;<i>
</I>&gt;<i> &gt;If the Python destructor of a class object instance doesn't release
</I>&gt;<i> &gt;resources correctly, for example, doesn't close off database
</I>&gt;<i> &gt;connections, then they will become unreachable and just consume and
</I>&gt;<i> &gt;thus reduce the maximum number of connections you could use. Even if
</I>&gt;<i> &gt;the destructor does do the correct thing, if there is an object
</I>&gt;<i> &gt;reference count cycle, Python may not be able to garbage collect it
</I>&gt;<i> &gt;and so it may never be destroyed anyway and release the resources.
</I>&gt;<i>
</I>&gt;<i> &quot;object reference count cycle&quot;?.
</I>&gt;<i> &gt;From what I 've noticed on module reloading the global connection object is recreated.
</I>&gt;<i> So the number of open connections to DB (postgres in my case) increments 1, but after a while the old connection closes (python garbage collecting, postgresql?) and so there is no problem.
</I>&gt;<i>
</I>&gt;<i> Of course it will still be a problem if multiple processes are created and the number of open connections reach the database connection limit.
</I>
Not in the same way as that would be by design, whereas the resource
leakage isn't.

&gt;<i> Just have to notice that this whole thing with keeping the connection open speeds a mod_python/ psycopg2/ postgresql  web app very much.
</I>&gt;<i> In my case noticed speed ups up to 300%.
</I>&gt;<i>
</I>&gt;<i> Anyway I think it would be very handful a tutorial about
</I>&gt;<i> &quot;A global's life in mod_python&quot; covering topics like the global variable context.
</I>
For a start, see document on process/interpreter model. Other than
that, not much different to standard Python programs.

&gt;<i> &gt; &gt;A second possible problem which can occur is where the global database
</I>&gt;<i> &gt; &gt;handle and the code for creating it, is placed in a code module which
</I>&gt;<i> &gt; &gt;is the subject of automatic reloading.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have now realized that in every reload of the file even if the global variable
</I>&gt;<i> &gt;  was created in previous invocation  it is re-created.
</I>&gt;<i> &gt; But why ? Once it's created as global shouldn't it exist after first invocation of the module
</I>&gt;<i> &gt;  and thus not be recreated ?
</I>&gt;<i>
</I>&gt;<i> &gt;Because that is the consequences of reloading modules, you either
</I>&gt;<i> &gt;reload on top of the existing module and thus replace the existing
</I>&gt;<i> &gt;value,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Sorry don't get you. An example please.
</I>&gt;<i> A global variable's context is the module where it is created?
</I>&gt;<i> If you reload this module the global variable becomes not reachable?
</I>
Consider:

  a = Class()
  a = Class()

The first instance of 'a' is no longer reachable.

If there was a reference count cycle then it may not be deleted
immediately and will be be dependent on garbage collection cycle
kicking in and attempting to break the cycle before it can be deleted.
This may not occur immediately and thus the unreachable object
instance may be using up resources. In worst case, garbage collector
may not be able to break cycle and it will never be destroyed and so
resources will never be released.

&gt;<i> &gt;or you reload the module into a fresh module and discard the
</I>&gt;<i> &gt;old.
</I>&gt;<i>
</I>&gt;<i> Are you pointing a technique here?
</I>
Yes and this is the one used by mod_python. The reasons were explained
in document on why mod_python module importing was broken in older
versions.

Graham

&gt;<i> &gt;How are you going to do it so you retain the global data in a
</I>&gt;<i> &gt;generic way?
</I>&gt;<i>
</I>&gt;<i> &gt;Graham
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; So, once threading issues are
</I>&gt;<i> &gt; &gt;dealt with then okay, but do not go putting it in the same code file
</I>&gt;<i> &gt; &gt;as your mod_python handlers, or in general anywhere in the document
</I>&gt;<i> &gt; &gt;tree. Instead put it in a module somewhere else on sys.path outside of
</I>&gt;<i> &gt; &gt;the document tree. For an example of why this can be a problem see:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;  <A HREF="http://groups.google.com/group/sqlalchemy/browse_thread/thread/5193bc7598f045fb#">http://groups.google.com/group/sqlalchemy/browse_thread/thread/5193bc7598f045fb#</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;Also ensure you read documentation for import_module() in:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  &gt; <A HREF="http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html">http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;It mentions a bit about resource leakage and transferring data from
</I>&gt;<i> &gt; &gt;old module to new module. Ensure you are using mod_python 3.3.1
</I>&gt;<i> &gt; &gt;though, as older versions were a bit less predictable.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;  <A HREF="http://www.dscpl.com.au/wiki/ModPython/Articles/ModuleImportingIsBroken">http://www.dscpl.com.au/wiki/ModPython/Articles/ModuleImportingIsBroken</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Graham
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 14/10/2007, Thimios Katsoulis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">thkatsou at yahoo.gr</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; Hello.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Sorry for my poor english. Here is my mod_python code. This is a simple
</I>&gt;<i> &gt; &gt; URL shorter:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; from mod_python import apache, util
</I>&gt;<i> &gt; &gt; import psycopg2 as psycopg
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; def handler(req):
</I>&gt;<i> &gt; &gt;      req.content_type = &quot;text/plain&quot;
</I>&gt;<i> &gt; &gt;      url_id = req.args
</I>&gt;<i> &gt; &gt;      connection = psycopg.connect(&quot;dbname=my_db&quot;)
</I>&gt;<i> &gt; &gt;      cursor = connection.cursor()
</I>&gt;<i> &gt; &gt;      cursor.execute(&quot;&quot;&quot;SELECT myurl FROM urls WHERE myid=%s&quot;&quot;&quot;,(url_id))
</I>&gt;<i> &gt; &gt;      original_url = cursor.fetchone()[0]
</I>&gt;<i> &gt; &gt;      connection.close()
</I>&gt;<i> &gt; &gt;      util.redirect(req,original_url)
</I>&gt;<i> &gt; &gt;      req.status = apache.DONE
</I>&gt;<i> &gt; &gt;      return apache.DONE
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; This programme connects database everytime, but I want(need) force him
</I>&gt;<i> &gt; &gt; to connect it continously
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; This script connects database everytime (psycopg.connect(&quot;dbname=my_db&quot;)
</I>&gt;<i> &gt; &gt; , but I nedd force to stay conneceted with it continously. It is
</I>&gt;<i> &gt; &gt; possible to make that in mod_python ? I have mod_python 3.2.10
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Thanks in advance.
</I>&gt;<i> &gt; &gt; rdn
</I>&gt;<i> &gt; &gt; ---------------
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Yes mod_python can maintain global variables per interpreter, so you can open once the connection
</I>&gt;<i> &gt; &gt; and all subsequent requests will use the opened connection.
</I>&gt;<i> &gt; &gt; You have to declare your connection variable as global e.g. :
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;     def getConn(self):
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;         try:
</I>&gt;<i> &gt; &gt;             if _conn == None:
</I>&gt;<i> &gt; &gt;                 self.openConn()
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;         except NameError:
</I>&gt;<i> &gt; &gt;             self.openConn()
</I>&gt;<i> &gt; &gt;         return _conn
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;     def openConn(self):
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;         global _conn
</I>&gt;<i> &gt; &gt;         _conn = connect(self.ConnStr)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; So when you want to access it you call self.getConn().
</I>&gt;<i> &gt; &gt; The _conn global variable will instantiate once for each mod_python apache process.
</I>&gt;<i> &gt; &gt; You can include some apache.log_error calls in the code above to watch
</I>&gt;<i> &gt; &gt; for yourself when the  _conn varible gets instantiated and when it is retreived as global.
</I>&gt;<i> &gt; &gt; Please take notice from what I have observed that while you maintain open connections to DB (postgresql too in my case)
</I>&gt;<i> &gt; &gt; you cannot change structure of the tables etc in the DB..
</I>&gt;<i> &gt; &gt; Of course if you are using modules and not objects you have to alter  the code to  support (removing self ..) modules.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ___________________________________________________________
</I>&gt;<i> &#935;&#961;&#951;&#963;&#953;&#956;&#959;&#960;&#959;&#953;&#949;&#943;&#964;&#949; Yahoo!;
</I>&gt;<i> &#914;&#945;&#961;&#949;&#952;&#942;&#954;&#945;&#964;&#949; &#964;&#945; &#949;&#957;&#959;&#967;&#955;&#951;&#964;&#953;&#954;&#940; &#956;&#951;&#957;&#973;&#956;&#945;&#964;&#945; (spam); &#932;&#959; Yahoo! Mail
</I>&gt;<i> &#948;&#953;&#945;&#952;&#941;&#964;&#949;&#953; &#964;&#951;&#957; &#954;&#945;&#955;&#973;&#964;&#949;&#961;&#951; &#948;&#965;&#957;&#945;&#964;&#942; &#960;&#961;&#959;&#963;&#964;&#945;&#963;&#943;&#945; &#954;&#945;&#964;&#940; &#964;&#969;&#957; &#949;&#957;&#959;&#967;&#955;&#951;&#964;&#953;&#954;&#974;&#957;
</I>&gt;<i> &#956;&#951;&#957;&#965;&#956;&#940;&#964;&#969;&#957; <A HREF="http://login.yahoo.com/config/mail?.intl=gr">http://login.yahoo.com/config/mail?.intl=gr</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024335.html">[mod_python] Re: Mod_python Digest, Vol 55, Issue 19
</A></li>
	<LI>Next message: <A HREF="024337.html">[mod_python] Reading data from a POST using chuncked mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24336">[ date ]</a>
              <a href="thread.html#24336">[ thread ]</a>
              <a href="subject.html#24336">[ subject ]</a>
              <a href="author.html#24336">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
