<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Input filter content-length problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Input%20filter%20content-length%20problem&In-Reply-To=6bcfeef70710091534p501b7955xb554552959177167%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024318.html">
   <LINK REL="Next"  HREF="024321.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Input filter content-length problem</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Input%20filter%20content-length%20problem&In-Reply-To=6bcfeef70710091534p501b7955xb554552959177167%40mail.gmail.com"
       TITLE="[mod_python] Input filter content-length problem">graham.dumpleton at gmail.com
       </A><BR>
    <I>Tue Oct  9 18:53:28 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024318.html">[mod_python] Input filter content-length problem
</A></li>
        <LI>Next message: <A HREF="024321.html">[mod_python] Problem getting mod_python working on Win32
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24320">[ date ]</a>
              <a href="thread.html#24320">[ thread ]</a>
              <a href="subject.html#24320">[ subject ]</a>
              <a href="author.html#24320">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/10/2007, Amos Latteier &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">amos at latteier.com</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm creating an input filter to rewrite POSTed form data before
</I>&gt;<i> handling. It works great with one exception:
</I>&gt;<i>
</I>&gt;<i>   * My filter changes the length of the request body (since it writes
</I>&gt;<i> more than it reads), but I cannot figure out how to change the
</I>&gt;<i> Content-Length header to match.
</I>&gt;<i>
</I>&gt;<i> So the program that handles for form data sees the changes that my
</I>&gt;<i> input filter makes, but it sees the original Content-Length header,
</I>&gt;<i> and thus misses some of the data that my filter adds to the request
</I>&gt;<i> body.
</I>&gt;<i>
</I>&gt;<i> I've tried changing the content length by doing:
</I>&gt;<i>
</I>&gt;<i> filter.req.headers_in['Content-Length'] = str(len(my_new_request_body))
</I>&gt;<i>
</I>&gt;<i> before I make any calls to filter.write(). However this doesn't affect
</I>&gt;<i> the Content-Length header.
</I>&gt;<i>
</I>&gt;<i> I'd be grateful for any suggestions. Thanks!
</I>
You can't change the content length.

First off, there are problems in mod_python that can result in loss of
input data if the request content is mutated and thus ends up being
more than originally posted. This is because mod_python wrongly pays
attention to the Content-Length header and doesn't read more than
that. Details in:

  <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-215">http://issues.apache.org/jira/browse/MODPYTHON-215</A>

I can't remember if this is the full answer, but the only way around
it is to wipe the Content-Length header entirely. This though can only
be done if you are using Apache 2.2 and is done using the mod_filter
directives described in:

  <A HREF="http://httpd.apache.org/docs/2.2/mod/mod_filter.html">http://httpd.apache.org/docs/2.2/mod/mod_filter.html</A>

to designate that your input filter changes the content length of the
input. By doing this, Apache will wipe the Content-Length header for
you so that applications will not get an incorrect value.

This means though that an application must be written simply to read
all available input and not expect that content length can be used.
This can cause problems though with certain applications. For example,
if using any WSGI based application you are effectively stuffed as the
WSGI protocol doesn't support the concept of mutating input filters
that change the incoming content length. Instead, WSGI applications
expect Content-Length to be defined and that will read that amount of
data and nothing more. That WSGI is deficient in this respect is known
and raised as an issue to be solved in WSGI 2.0. See:

  <A HREF="http://www.wsgi.org/wsgi/WSGI_2.0">http://www.wsgi.org/wsgi/WSGI_2.0</A>

As documented in the referenced issues, mod_python also has issues in
its form processing support.

Graham
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024318.html">[mod_python] Input filter content-length problem
</A></li>
	<LI>Next message: <A HREF="024321.html">[mod_python] Problem getting mod_python working on Win32
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24320">[ date ]</a>
              <a href="thread.html#24320">[ thread ]</a>
              <a href="subject.html#24320">[ subject ]</a>
              <a href="author.html#24320">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
