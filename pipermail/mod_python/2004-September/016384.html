<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Circular references starting from the request object
	are not collected
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Circular%20references%20starting%20from%20the%20request%20object%0A%09are%20not%20collected&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016397.html">
   <LINK REL="Next"  HREF="016385.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Circular references starting from the request object
	are not collected</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Nicolas Lehuen</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Circular%20references%20starting%20from%20the%20request%20object%0A%09are%20not%20collected&In-Reply-To="
       TITLE="[mod_python] Circular references starting from the request object
	are not collected">nicolas at lehuen.com
       </A><BR>
    <I>Thu Sep  9 19:49:47 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="016397.html">[mod_python] [ANNOUNCE] SnakeSkin: Python Application Toolkit
</A></li>
        <LI>Next message: <A HREF="016385.html">[mod_python] Circular references starting from the request object
	are not collected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16384">[ date ]</a>
              <a href="thread.html#16384">[ thread ]</a>
              <a href="subject.html#16384">[ subject ]</a>
              <a href="author.html#16384">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm running Apache 2.0.50, mod_python 3.1.3 with Python 2.3.4 on Windows XP
Pro and Windows 2000 server.

I finally found a source for the memory leaks I have been observing for a
while now : if you store an object in the request object that reference
directly or indirectly the request object itself, it builds a circular
reference. This circular reference does not seem to be garbage collected.

The test handler : 

from mod_python import apache

def handler(req):
    # req.foobar=req
    req.content_type='text/html'
    req.write('OK')
    return apache.OK

I used Apache Benchmark :

ab -c 5 -n 100000 <A HREF="http://localhost/test.py">http://localhost/test.py</A>

With the comment line, everything is OK, I do not see any memory leak.

If I uncomment the 'req.reqs=[req]' line, the memory leak shows up. My
Apache process normally uses around 20 MB without the comment, and in 30
seconds of running the above handler (comment removed) with the above Apache
Benchmark command, it reaches 125 MB !

Normally, circular reference are collected by the garbage collector of
Python, but unfortunately when defining object from C, you have to do a few
tricks to support this :

<A HREF="http://www.python.org/doc/2.3.4/api/supporting-cycle-detection.html">http://www.python.org/doc/2.3.4/api/supporting-cycle-detection.html</A>

It seems that this is not done in mod_python, by having a look at
requestobject.c.

I find this quite a big problem, and I don't find any workaround except
&quot;Don't reference the request object from anywhere that might be referenced
by the request object&quot;, which is a pretty big limitation, quite annoying in
the application I'm building.

Best regards,

Nicolas Lehuen

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016397.html">[mod_python] [ANNOUNCE] SnakeSkin: Python Application Toolkit
</A></li>
	<LI>Next message: <A HREF="016385.html">[mod_python] Circular references starting from the request object
	are not collected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16384">[ date ]</a>
              <a href="thread.html#16384">[ thread ]</a>
              <a href="subject.html#16384">[ subject ]</a>
              <a href="author.html#16384">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
