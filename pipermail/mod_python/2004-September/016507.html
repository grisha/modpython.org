<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Mac OS X / Apache 2.0 / mod_python 3.1.3 / Python 2.3.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mac%20OS%20X%20/%20Apache%202.0%20/%20mod_python%203.1.3%20/%20Python%202.3.&In-Reply-To=1091677032.58339%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016502.html">
   <LINK REL="Next"  HREF="016509.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Mac OS X / Apache 2.0 / mod_python 3.1.3 / Python 2.3.</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mac%20OS%20X%20/%20Apache%202.0%20/%20mod_python%203.1.3%20/%20Python%202.3.&In-Reply-To=1091677032.58339%40dscpl.com.au"
       TITLE="[mod_python] Mac OS X / Apache 2.0 / mod_python 3.1.3 / Python 2.3.">grahamd at dscpl.com.au
       </A><BR>
    <I>Fri Sep 24 00:37:14 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="016502.html">[mod_python] mod_python + mod_ssl
</A></li>
        <LI>Next message: <A HREF="016509.html">[mod_python] Mac OS X / Apache 2.0 / mod_python 3.1.3 / Python
	2.3.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16507">[ date ]</a>
              <a href="thread.html#16507">[ thread ]</a>
              <a href="subject.html#16507">[ subject ]</a>
              <a href="author.html#16507">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A while back, I posted as to how I managed to get standard Apache 1.3 and
Python 2.3 as supplied with the Mac OS X (10.3.5) operating system, working
with the older mod_python 2.7.10. Specifically, a hack was required because
the Python framework library as supplied with the Mac was appearing to
already be initialised when mod_python was initialised, even though it hadn't.
The original email and the hack made is attached below.

Anyway, I have now installed Apache 2.0.51 and mod_python 3.1.3 and have
run up against the exact same problem. Remembering, this is with the
version of Python that comes with the operating system, ie., Python 2.3.
I even rebuilt my box from scratch recently so it is a relatively fresh install
of Mac OS X.

My question is whether anyone running Apache 2.0 and mod_python 3.1.3
on Mac OS X, has done so by using the version of Python that comes with
the operating system? The various posts I have seen talk about having
downloaded the more recent Python 2.3.4 and compiling it from scratch.
Ie., not using that supplied with the operating system.

If this is the case, and everyone has been building a new version of Python,
it suggests that the problem I am seeing is generic to Python 2.3 that comes
with the Mac and applies to any version of mod_python. Alternatively, it
comes about because of underlying problems with how the loadable object
for mod_python is being created on the Mac.

On Aug 04 21:37, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Subject: Re: [mod_python] Status of Mac OS X / Apache 1.3 / mod_python 2.7.10.
</I>&gt;<i>
</I>&gt;<i> On Aug 04 15:26, Justin Ryan &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jryan at qutang.net</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Subject: Re: [mod_python] Status of Mac OS X / Apache 1.3 / mod_python 2.7.10.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Be careful when playing with the file/directory/link/whateva that is 
</I>&gt;<i> &gt; /System/Library/Frameworks/Python.Framework.  I ran into some wierdness 
</I>&gt;<i> &gt; trying to change this into a symlink and move it around (i.e. change it 
</I>&gt;<i> &gt; back and forth from pointing to Apple's python and my own).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Also, take care when using the 'python' command after installing your 
</I>&gt;<i> &gt; own framework build.  It's kind of a pain to get a framework build to 
</I>&gt;<i> &gt; stick python, pythonw, etc.. in /usr/bin - all of my stuff was in 
</I>&gt;<i> &gt; /usr/local/bin, even though I passed --prefix=/usr to the configure 
</I>&gt;<i> &gt; script.
</I>&gt;<i> 
</I>&gt;<i> I would agree and why I didn't want to go down the path of having to replace
</I>&gt;<i> the standard version of Python on MacOSX with a newer version to get mod_python
</I>&gt;<i> to work. Similarly, I didn't want to be replacing their version of Apache.
</I>&gt;<i> 
</I>&gt;<i> Anyway, listed below is the changes I had to make to get it to build and work
</I>&gt;<i> on MacOSX (10.3.3) with the standard Python (2.3) and Apache (1.3) that come
</I>&gt;<i> with the operating system.
</I>&gt;<i> 
</I>&gt;<i> First off, after running configure, change &quot;src/Makefile&quot; and replace:
</I>&gt;<i> 
</I>&gt;<i>   /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/config/libpython2.3.a
</I>&gt;<i> 
</I>&gt;<i> with:
</I>&gt;<i> 
</I>&gt;<i>   -framework Python
</I>&gt;<i> 
</I>&gt;<i> in LIBS variable.
</I>&gt;<i> 
</I>&gt;<i> Second, in the same makefile, change CFLAGS and add in:
</I>&gt;<i> 
</I>&gt;<i>   -DEAPI
</I>&gt;<i> 
</I>&gt;<i> as a compiler option.
</I>&gt;<i> 
</I>&gt;<i> This will allow mod_python to build, but the result will crash.
</I>&gt;<i> 
</I>&gt;<i> Final step is to modify src/mod_python.c. The diff is below. There are
</I>&gt;<i> more comments after that diff as to why the original code is wrong anyway.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> *** mod_python.c.dist   Tue May 29 06:00:41 2001
</I>&gt;<i> --- mod_python.c        Thu Aug  5 13:21:22 2004
</I>&gt;<i> ***************
</I>&gt;<i> *** 260,265 ****
</I>&gt;<i> --- 260,268 ----
</I>&gt;<i>   
</I>&gt;<i>       char buff[255];
</I>&gt;<i>   
</I>&gt;<i> +     /* fudge for Mac OS X with Apache 1.3 where Py_IsInitialized() broke */
</I>&gt;<i> +     static int initialized = 0;
</I>&gt;<i> + 
</I>&gt;<i>       /* pool given to us in ChildInit. We use it for 
</I>&gt;<i>          server.register_cleanup() */
</I>&gt;<i>       pool *child_init_pool = NULL;
</I>&gt;<i> ***************
</I>&gt;<i> *** 272,279 ****
</I>&gt;<i>       ap_add_version_component(buff);
</I>&gt;<i>   
</I>&gt;<i>       /* initialize global Python interpreter if necessary */
</I>&gt;<i> !     if (! Py_IsInitialized()) 
</I>&gt;<i>       {
</I>&gt;<i>   
</I>&gt;<i>         /* initialze the interpreter */
</I>&gt;<i>         Py_Initialize();
</I>&gt;<i> --- 275,283 ----
</I>&gt;<i>       ap_add_version_component(buff);
</I>&gt;<i>   
</I>&gt;<i>       /* initialize global Python interpreter if necessary */
</I>&gt;<i> !     if (initialized == 0 || ! Py_IsInitialized())
</I>&gt;<i>       {
</I>&gt;<i> +         initialized = 1;
</I>&gt;<i>   
</I>&gt;<i>         /* initialze the interpreter */
</I>&gt;<i>         Py_Initialize();
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The problem on MacOSX is that Py_IsInitialized() is returning true on the
</I>&gt;<i> first time it is called even though Python hadn't up until that point actually
</I>&gt;<i> been initialised. This means initialisation is skipped and the first time
</I>&gt;<i> something tries to use Python methods later, it crashes.
</I>&gt;<i> 
</I>&gt;<i> To my mind the use of Py_IsInitialized() is partly bogus anyway. This is
</I>&gt;<i> because if someone did come up with a different apache module which
</I>&gt;<i> also tried to use Python and it got loaded first and called Py_Initialize(),
</I>&gt;<i> it would mean when mod_python got loaded it would skip initialisation
</I>&gt;<i> and wouldn't initialise as a result the &quot;interpreters&quot; dictionary nor would
</I>&gt;<i> it necessarily initialise threading if the other module didn't do it.
</I>&gt;<i> 
</I>&gt;<i> Thus, even though people might reckon that this patch may only be
</I>&gt;<i> relevant to the MacOSX problem I have, I would disagree, because I would
</I>&gt;<i> say the code is wrong anyway.
</I>&gt;<i> 
</I>&gt;<i> As a demonstration, you might modify the code and add an extra call to
</I>&gt;<i> Py_Initialize() just prior to the &quot;if&quot; statement where Py_IsInitialized() is
</I>&gt;<i> called as if it was done somewhere else. Do this and mod_python should
</I>&gt;<i> by observation break since &quot;interpreters&quot; will never get set as described above.
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Graham Dumpleton (<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>)
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>
--
Graham Dumpleton (<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>)
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016502.html">[mod_python] mod_python + mod_ssl
</A></li>
	<LI>Next message: <A HREF="016509.html">[mod_python] Mac OS X / Apache 2.0 / mod_python 3.1.3 / Python
	2.3.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16507">[ date ]</a>
              <a href="thread.html#16507">[ thread ]</a>
              <a href="subject.html#16507">[ subject ]</a>
              <a href="author.html#16507">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
