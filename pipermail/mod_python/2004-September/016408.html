<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Circular references starting from the request object
	are not collected
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Circular%20references%20starting%20from%20the%20request%20object%0A%09are%20not%20collected&In-Reply-To=20040910061722.54D09186122%40postfix4-1.free.fr">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016404.html">
   <LINK REL="Next"  HREF="016412.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Circular references starting from the request object
	are not collected</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Gregory (Grisha) Trubetskoy</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Circular%20references%20starting%20from%20the%20request%20object%0A%09are%20not%20collected&In-Reply-To=20040910061722.54D09186122%40postfix4-1.free.fr"
       TITLE="[mod_python] Circular references starting from the request object
	are not collected">grisha at modpython.org
       </A><BR>
    <I>Fri Sep 10 11:32:19 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="016404.html">[mod_python] Circular references starting from the request object
	are not collected
</A></li>
        <LI>Next message: <A HREF="016412.html">[mod_python] Circular references starting from the request
	objectare not collected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16408">[ date ]</a>
              <a href="thread.html#16408">[ thread ]</a>
              <a href="subject.html#16408">[ subject ]</a>
              <a href="author.html#16408">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On Fri, 10 Sep 2004, Nicolas Lehuen wrote:

&gt;<i> Meanwhile, manually deleting the reference in a finally block at the end of
</I>&gt;<i> the handler does the trick...
</I>
Keep in mind that doing it at the end of the handler won't always work, as 
handler's execution can be aborted in the middle if, for exampe, the 
client decides to suddenly disconnect. This is exactly why Apache has 
cleanups - cleanups run even if the handler errored out and is aborted.

&gt;<i> But there is a leak remaining, which means I have to search thoroughly 
</I>&gt;<i> through the code to find where this circular reference is built, and 
</I>&gt;<i> delete a link from the reference chain when the request processing is 
</I>&gt;<i> over. No exactly what I'd expect from a high level language.
</I>
Well it's not really an artifact of the language. Mod_python keeps the 
interpreter persistent throughout requests, and therefore you need to 
think in terms of a long-running service, including whatching out for 
memory leaks. Fortunately, Apache does a lion's share of work in this 
respect and provides tools like cleanups. I don't have much experience 
with pure-Python servers, but I imagine the memory situation is much worse 
when it comes to servers such as Zope, webware or twisted - anyone have 
any experience with this?

&gt;<i> I also had a look at how to support circular references in native coded
</I>&gt;<i> objects (
</I>&gt;<i> <A HREF="http://www.python.org/doc/2.3.4/api/supporting-cycle-detection.html">http://www.python.org/doc/2.3.4/api/supporting-cycle-detection.html</A> ). It
</I>&gt;<i> seems that it can be done without changing too much in requestobject.c,
</I>&gt;<i> namely by modifying MpRequest_FromRequest, request_dealloc and
</I>&gt;<i> MpRequest_Type and adding a tp_traverse and a tp_clear handler. The only
</I>&gt;<i> thing I don't see is how to get the extraneous attributes of the request
</I>&gt;<i> object (since I must traverse them in the traverse_tp handler). I just
</I>&gt;<i> managed to build mod_python from source, so I may try to work on this this
</I>&gt;<i> week-end.
</I>
If you can get it to a point where you have a patch, that would be 
fantastic. Also, internal stuff like this is better discussed on the 
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">python-dev at httpd.apache.org</A> list - it's very low volume with much higher 
low-level expertiese on it.

Thanks,

Grisha

&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Nicolas
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Mike Bayer wrote :
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> workaround: use a weakref for one side of the circular reference.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> import weakref
</I>&gt;&gt;&gt;&gt;<i> req.foobar = weakref.ref(myfoobar)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Indeed, I thought about using a weakref, alas the request object
</I>&gt;&gt;&gt;<i> cannot be weak referenced (there again, native code must
</I>&gt;&gt;<i> implement a
</I>&gt;&gt;&gt;<i> few trick to support weak references).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Regards,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Nicolas
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I></PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016404.html">[mod_python] Circular references starting from the request object
	are not collected
</A></li>
	<LI>Next message: <A HREF="016412.html">[mod_python] Circular references starting from the request
	objectare not collected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16408">[ date ]</a>
              <a href="thread.html#16408">[ thread ]</a>
              <a href="subject.html#16408">[ subject ]</a>
              <a href="author.html#16408">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
