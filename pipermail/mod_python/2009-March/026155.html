<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] multiple processing of the same python script by the
	handler
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20multiple%20processing%20of%20the%20same%20python%20script%20by%20the%0A%09handler&In-Reply-To=200903312126.09568.webmaster%40world-vr.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026154.html">
   <LINK REL="Next"  HREF="026117.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] multiple processing of the same python script by the
	handler</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20multiple%20processing%20of%20the%20same%20python%20script%20by%20the%0A%09handler&In-Reply-To=200903312126.09568.webmaster%40world-vr.com"
       TITLE="[mod_python] multiple processing of the same python script by the
	handler">graham.dumpleton at gmail.com
       </A><BR>
    <I>Tue Mar 31 20:44:58 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="026154.html">[mod_python] multiple processing of the same python script by the
	handler
</A></li>
        <LI>Next message: <A HREF="026117.html">[mod_python] mod_python session/form based user authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26155">[ date ]</a>
              <a href="thread.html#26155">[ thread ]</a>
              <a href="subject.html#26155">[ subject ]</a>
              <a href="author.html#26155">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>You have the registration of the logger inside a function which is
called multiple times. It needs to be a global scope in the module so
it is only done once. See below.

2009/4/1 David Sfiligoi &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">webmaster at world-vr.com</A>&gt;:
&gt;<i> Hi Graham,
</I>&gt;<i>
</I>&gt;<i> Thanks for the quick response. &#160; I have implemented a module which I place
</I>&gt;<i> in / (literally) for ensuring that the test works. &#160; I then also wrote a
</I>&gt;<i> small stress test app which would hit the script with a parameter which
</I>&gt;<i> increments at each request to see so I can see if there is multiplicity of
</I>&gt;<i> logging. &#160; Unfortunately there was still multiple entries of the same log
</I>&gt;<i> data. &#160;I should &#160;say that the data received by the server on the other end of
</I>&gt;<i> the socket is now unique(seems to be so far anyway). So thank you for
</I>&gt;<i> assisting :-) &#160; The issue with the logging module still baffles me. &#160;Perhaps
</I>&gt;<i> somebody else on the list has input?
</I>&gt;<i>
</I>&gt;<i> def handler(req):
</I>&gt;<i> &#160; &#160;davelogger = apache.import_module(&quot;/davelogger.py&quot;)
</I>&gt;<i> &#160; &#160;request_data = util.FieldStorage(req)
</I>&gt;<i> &#160; &#160;clientip = req.get_remote_host(apache.REMOTE_NOLOOKUP)
</I>&gt;<i> &#160; &#160;geoip = 'NL'
</I>&gt;<i> &#160; &#160;str_req_data = str(clientip) + &quot;| CC: &quot; + str(geoip) + &quot;| &quot;
</I>&gt;<i> &#160; &#160;str_req_datadb = &quot;ip: &quot; + str(clientip) + &quot;| CC: &quot; + str(geoip) + &quot;| &quot;
</I>&gt;<i> &#160; &#160;for key in request_data:
</I>&gt;<i> &#160; &#160; &#160; &#160;str_req_datadb += &quot;| &quot; + str(key) + &quot;: &quot; + str(request_data[key])
</I>&gt;<i> &#160; &#160; &#160; &#160;str_req_data += str(key) + &quot;: &quot; + str(request_data[key]) + &quot;| &quot;
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;davelogger.logdata(str_req_data[:-2],str_req_datadb)
</I>&gt;<i> &#160; &#160;return apache.OK
</I>&gt;<i>
</I>&gt;<i> davelogger.py module:
</I>&gt;<i>
</I>&gt;<i> def logdata(data,datadb):
</I>&gt;<i> &#160; &#160;logger = logging.getLogger('mylogger.py')
</I>&gt;<i> &#160; &#160;logging_handler =
</I>&gt;<i> logging.FileHandler('/usr/local/apache2/htdocs/mylog.log')
</I>&gt;<i> &#160; &#160;formatter = logging.Formatter('%(asctime)s %(levelname)s %(message)s')
</I>&gt;<i> &#160; &#160;logging_handler.setFormatter(formatter)
</I>&gt;<i> &#160; &#160;logger.addHandler(logging_handler)
</I>&gt;<i> &#160; &#160;logger.setLevel(logging.INFO)
</I>
Parts of above initialisation should be at global scope in module, not
inside function which is called multiple times.

Graham

&gt;<i>
</I>&gt;<i> &#160; &#160;curtime = datetime.now().isoformat(' ')
</I>&gt;<i> &#160; &#160;try:
</I>&gt;<i> &#160; &#160; &#160; &#160;s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
</I>&gt;<i> &#160; &#160; &#160; &#160;s.settimeout(0.5)
</I>&gt;<i> &#160; &#160; &#160; &#160;s.connect(('10.0.0.2', 8199))
</I>&gt;<i> &#160; &#160; &#160; &#160;message = &quot;date: &quot; + str(curtime[:-4] + &quot;| &quot; + datadb)
</I>&gt;<i> &#160; &#160; &#160; &#160;len_sent = s.send(message)
</I>&gt;<i> &#160; &#160; &#160; &#160;s.close()
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;except:
</I>&gt;<i> &#160; &#160; &#160; &#160;data += '| dbupdate: failed|'
</I>&gt;<i> &#160; &#160; &#160; &#160;pass
</I>&gt;<i> &#160; &#160;logger.info(data)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> log data from the logger module
</I>&gt;<i> 2009-03-29 23:28:48,452 INFO 10.0.0.2| CC: NL| x: 195
</I>&gt;<i> 2009-03-29 23:28:48,452 INFO 10.0.0.2| CC: NL| x: 195
</I>&gt;<i> 2009-03-29 23:28:48,452 INFO 10.0.0.2| CC: NL| x: 195
</I>&gt;<i> 2009-03-29 23:28:48,452 INFO 10.0.0.2| CC: NL| x: 195
</I>&gt;<i> 2009-03-29 23:28:48,452 INFO 10.0.0.2| CC: NL| x: 195
</I>&gt;<i> 2009-03-29 23:28:48,452 INFO 10.0.0.2| CC: NL| x: 195
</I>&gt;<i> 2009-03-29 23:28:48,452 INFO 10.0.0.2| CC: NL| x: 195
</I>&gt;<i> 2009-03-29 23:28:48,500 INFO 10.0.0.2| CC: NL| x: 196
</I>&gt;<i> 2009-03-29 23:28:48,500 INFO 10.0.0.2| CC: NL| x: 196
</I>&gt;<i> 2009-03-29 23:28:48,500 INFO 10.0.0.2| CC: NL| x: 196
</I>&gt;<i> 2009-03-29 23:28:48,500 INFO 10.0.0.2| CC: NL| x: 196
</I>&gt;<i> 2009-03-29 23:28:48,500 INFO 10.0.0.2| CC: NL| x: 196
</I>&gt;<i> 2009-03-29 23:28:48,500 INFO 10.0.0.2| CC: NL| x: 196
</I>&gt;<i>
</I>&gt;<i> stdout from the socket server:
</I>&gt;<i> {'date': '2009-03-29
</I>&gt;<i> 23:28:48', 'ip': '10.0.0.2', 'CC': 'NL', 'eventid': '0de8b6b1b019d19bc3e7eb5ca986cdcade75e20587211569eebdfcc8', 'x': '194'}
</I>&gt;<i> {'date': '2009-03-29
</I>&gt;<i> 23:28:48', 'ip': '10.0.0.2', 'CC': 'NL', 'eventid': 'bc728c0113bb35d748bf2be0fae52a85242c87a0d41495aeee9d69c0', 'x': '195'}
</I>&gt;<i> {'date': '2009-03-29
</I>&gt;<i> 23:28:48', 'ip': '10.0.0.2', 'CC': 'NL', 'eventid': '9f946b3948d2f2b84b241e25f1a05f2260e53a98a7d1af5a61787f38', 'x': '196'}
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sunday 29 March 2009 09:33:46 pm you wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> 2009/3/30 David Sfiligoi &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">webmaster at world-vr.com</A>&gt;:
</I>&gt;&gt;<i> &gt; Hi Graham,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Yes I agree defining my logger outside the mod python handler was a bad
</I>&gt;&gt;<i> &gt; idea. Using the req.log_error works of course. &#160;Obviously if I wanted
</I>&gt;&gt;<i> &gt; integrate this into all the other apps that revolve around those logs,
</I>&gt;&gt;<i> &gt; i'd have to write a converter or change each apps which parses the log
</I>&gt;&gt;<i> &gt; data.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I'd like to understand this a bit better, perhaps I have the wrong basic
</I>&gt;&gt;<i> &gt; idea on how the python handler works in overall, but if I install the log
</I>&gt;&gt;<i> &gt; handler in the handler function and delete the log objects before ending,
</I>&gt;&gt;<i> &gt; shouldn't that take care of the multiple logging issue?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Or are you saying that each piece of code that should not produce
</I>&gt;&gt;<i> &gt; multiple entries of the same thing should really be inside a module so I
</I>&gt;&gt;<i> &gt; can let import_module() take care of it?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Put logging initialisation in a completely separate module outside of
</I>&gt;&gt;<i> document tree and not inside of the handler code files. Setup
</I>&gt;&gt;<i> PythonPath if need be where that separate module is located, &#160;and then
</I>&gt;&gt;<i> have handler code files import that module from that other location.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This should ensure that the logging initialisation code is imported
</I>&gt;&gt;<i> and run only once per process. If you intentionally then change the
</I>&gt;&gt;<i> logging initialisation module code, you will need to restart Apache.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Im seeing the same 'multiplicity' issue when I open a socket while in
</I>&gt;&gt;<i> &gt; handler function. This is really what trigger the question.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That I can't explain at this point. I was assuming that your
</I>&gt;&gt;<i> duplicated logging may have been confusing the issue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Thanks,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; David
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; On Sunday 29 March 2009 05:45:01 am Graham Dumpleton wrote:
</I>&gt;&gt;<i> &gt;&gt; If you change a mod_python handler script, it will be automatically
</I>&gt;&gt;<i> &gt;&gt; reloaded. This would be a problem in your code as you installed a log
</I>&gt;&gt;<i> &gt;&gt; handler each time it is loaded into the same process. Having multiple
</I>&gt;&gt;<i> &gt;&gt; instances of the log handler installed would result in the same
</I>&gt;&gt;<i> &gt;&gt; information possibly being logged multiple times.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I would suggest you add inside your handler script:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &#160; req.log_error(&quot;I have been called&quot;)
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; If that appears twice in the Apache error log file then I would be
</I>&gt;&gt;<i> &gt;&gt; concerned, otherwise I would say the problem is with your use of the
</I>&gt;&gt;<i> &gt;&gt; logging module.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Also read about import_module() in:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &#160; <A HREF="http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html">http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html</A>
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; as it explains a bit about module reloading and the way to preserve
</I>&gt;&gt;<i> &gt;&gt; global data or avoid stuff which performs additive operations each
</I>&gt;&gt;<i> &gt;&gt; time it is loaded.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Graham
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026154.html">[mod_python] multiple processing of the same python script by the
	handler
</A></li>
	<LI>Next message: <A HREF="026117.html">[mod_python] mod_python session/form based user authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26155">[ date ]</a>
              <a href="thread.html#26155">[ thread ]</a>
              <a href="subject.html#26155">[ subject ]</a>
              <a href="author.html#26155">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
