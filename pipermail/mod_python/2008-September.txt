From davidf at sjsoft.com  Mon Sep  1 02:39:31 2008
From: davidf at sjsoft.com (easton doris)
Date: Mon Sep  1 04:26:56 2008
Subject: [mod_python] Angel Dark Anal Porn
Message-ID: <000801c90c0c$0444a11e$74c9d695@okfcu>

#UwZRPCe
Black whore gets her pussy pounded by big black cock!!>>>>	
.nxOeKjR
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080901/73c3ff2d/attachment.html
From dave6502 at googlemail.com  Wed Sep  3 07:43:18 2008
From: dave6502 at googlemail.com (dave selby)
Date: Wed Sep  3 07:43:21 2008
Subject: [mod_python] mod_python.publisher and mod_python.psp possible ?
Message-ID: <f52017b60809030443p305edd58xcbee549ee2b56acc@mail.gmail.com>

Hi All,

I have been changing over my PHP server side scripts to mod-python
very successfully. So far I have been using the following apache
config ...

        AddHandler mod_python .py
        PythonHandler mod_python.publisher
        # Display python errors to web browser - useful for debug
        PythonDebug On


However some of my old code uses embedded PHP inside the HTML., so I added

       AddHandler mod_python .py
        PythonHandler mod_python.publisher
        PythonHandler mod_python.psp
        # Display python errors to web browser - useful for debug
        PythonDebug On

This seems to break PythonHandler mod_python.publisher, I am guessing
it just redefines the PythonHandler.
Is there a way to have both mod-python running as a server side script
& also embedded in HTML code ?

Cheers

Dave



-- 

Please avoid sending me Word or PowerPoint attachments.
See http://www.gnu.org/philosophy/no-word-attachments.html
From list at joreybump.com  Wed Sep  3 08:57:53 2008
From: list at joreybump.com (Jorey Bump)
Date: Wed Sep  3 08:58:04 2008
Subject: [mod_python] mod_python.publisher and mod_python.psp possible
 ?
In-Reply-To: <f52017b60809030443p305edd58xcbee549ee2b56acc@mail.gmail.com>
References: <f52017b60809030443p305edd58xcbee549ee2b56acc@mail.gmail.com>
Message-ID: <48BE89D1.1000105@joreybump.com>

dave selby wrote, at 09/03/2008 07:43 AM:

> I have been changing over my PHP server side scripts to mod-python
> very successfully. So far I have been using the following apache
> config ...
> 
>         AddHandler mod_python .py
>         PythonHandler mod_python.publisher
>         # Display python errors to web browser - useful for debug
>         PythonDebug On
> 
> However some of my old code uses embedded PHP inside the HTML., so I added
> 
>        AddHandler mod_python .py
>         PythonHandler mod_python.publisher
>         PythonHandler mod_python.psp
>         # Display python errors to web browser - useful for debug
>         PythonDebug On
> 
> This seems to break PythonHandler mod_python.publisher, I am guessing
> it just redefines the PythonHandler.
> Is there a way to have both mod-python running as a server side script
> & also embedded in HTML code ?

You can assign different handlers to different extensions like this:

   AddHandler mod_python .py .psp
   PythonHandler mod_python.publisher | .py
   PythonHandler mod_python.psp | .psp


From sideh101 at hotmail.fr  Thu Sep  4 11:03:30 2008
From: sideh101 at hotmail.fr (steve boutabi)
Date: Thu Sep  4 11:03:38 2008
Subject: [mod_python] [SPAM] PythonAuthenHandler troubles!!!
Message-ID: <BAY113-W334DC09398B980AD996F81F9590@phx.gbl>


Hi, i'm working on a project in Python in which i have enable reading and modifying documents with OpenOffice through  WebDav.
The trouble comes when i try to give the authentification phase to mod-python, it simply doesn't work

here is my site.conf:
<Directory "/opt/monsite">
     Dav On
     AddHandler mod_python .odt
     PythonAuthenHandler myscript
     PythonDebug On
     AuthType Basic
     AuthName "Mosaic"
     <Limit PUT POST DELETE PROPFIND PROPPATCH MKCOL COPY MOVE LOCK UNLOCK>
        Require valid-user
     </Limit>
</Directory>



if i try to add an AuthAuthoritative Off directive, Apache don't start telling me that this command is misspelled or that some module is missing.
if i try to add a PythonHandler, i must handle everything, thus i loose WebDav functionality.

I want only authentification to be handeled by PythonAuthenHandler the rest by Apache-WebDAV


_________________________________________________________________
T?l?phonez gratuitement ? tous vos proches avec Windows Live Messenger? !? T?l?chargez-le maintenant !
http://www.windowslive.fr/messenger/1.asp
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080904/7b61cce0/attachment.html
From graham.dumpleton at gmail.com  Thu Sep  4 18:49:24 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Thu Sep  4 18:49:25 2008
Subject: [mod_python] [SPAM] PythonAuthenHandler troubles!!!
In-Reply-To: <BAY113-W334DC09398B980AD996F81F9590@phx.gbl>
References: <BAY113-W334DC09398B980AD996F81F9590@phx.gbl>
Message-ID: <88e286470809041549p63f1b96arc89a48f483b42bc5@mail.gmail.com>

2008/9/5 steve boutabi <sideh101@hotmail.fr>:
> Hi, i'm working on a project in Python in which i have enable reading and
> modifying documents with OpenOffice through  WebDav.
> The trouble comes when i try to give the authentification phase to
> mod-python, it simply doesn't work
>
> here is my site.conf:
> <Directory "/opt/monsite">
>      Dav On
>      AddHandler mod_python .odt
>      PythonAuthenHandler myscript
>      PythonDebug On
>      AuthType Basic
>      AuthName "Mosaic"
>      <Limit PUT POST DELETE PROPFIND PROPPATCH MKCOL COPY MOVE LOCK UNLOCK>
>         Require valid-user
>      </Limit>
> </Directory>
>
>
>
> if i try to add an AuthAuthoritative Off directive, Apache don't start
> telling me that this command is misspelled or that some module is missing.
> if i try to add a PythonHandler, i must handle everything, thus i loose
> WebDav functionality.
>
> I want only authentification to be handeled by PythonAuthenHandler the rest
> by Apache-WebDAV

If you only want authentication to be handled by mod_python, why do you have:

  AddHandler mod_python .odt

That only applies to content handler phase and may confused DAV.

Other than that, don't really understand what you are trying to say in
'don't start telling me that this command is misspelled or that some
module is missing'. Also doesn't help that you don't supply what is in
your authenhandler.

FWIW, if all you are using mod_python for is a custom basic auth
provider, you may be better off using mod_wsgi instead as its support
for auth providers is simpler to use than doing a full authentication
handler for mod_python.

See:

  http://code.google.com/p/modwsgi/wiki/AccessControlMechanisms

Graham
From graham.dumpleton at gmail.com  Fri Sep  5 05:48:18 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Fri Sep  5 05:48:20 2008
Subject: [mod_python] [SPAM] PythonAuthenHandler troubles!!!
In-Reply-To: <BAY113-W49E11F7DF08956166C14DF9580@phx.gbl>
References: <BAY113-W334DC09398B980AD996F81F9590@phx.gbl>
	<88e286470809041549p63f1b96arc89a48f483b42bc5@mail.gmail.com>
	<BAY113-W49E11F7DF08956166C14DF9580@phx.gbl>
Message-ID: <88e286470809050248x446e50e7v539564cb27e142fa@mail.gmail.com>

Please keep the discussion on the mailing list.

If Apache doesn't understand AuthAuthoritative then you aren't using
Apache 2.0, but most likely Apache 2.2.

For Apache 2.2 it is AuthBasicAuthoritative.

This suggests your configuration may be wrong in other ways as Apache
2.2 auth configuration is a bit different due to the addition of auth
provider mechanism in 2.2

BTW, the authenhandler() is technically wrong for a lot of reasons and
yes I know that means the mod_python documentation is broken. It may
work, but only because mod_python does some hacks it shouldn't to
catch lazy programmers. :-)

I'd really suggest you use auth mechanism in mod_wsgi instead as doing
it right in mod_python is a PITA and more work than it needs to be.

Graham

2008/9/5 steve boutabi <sideh101@hotmail.fr>:
> Thank's Graham
>
> When i remove, ''AddHandler mod_python .odt'' it still don't pass the
> authentification to the PythonAuthenHandler
> and it simply open the document, without asking for login and password.
> And if i add a Require valid-user, it asks for login and password, and then
> Show a 500 error Internal error, complaining that there's no AuthUserFile
> which means that the authentification is still done by apache through the
> user files system.
> A solution maybe A AuthAuthoritative Off directive but appache says he
> doesn't understand it
>
> For information the authentification function contains only :
>
> def authenhandler(req):
>     pw = req.get_basic_auth_pw()
>     user = req.user
>
>     if user == "spam" and pw == "eggs":
>        return apache.OK
>     else:
>        return apache.HTTP_UNAUTHORIZED
>
>
>                                                Steven. Paris
>
>
>> Date: Fri, 5 Sep 2008 08:49:24 +1000
>> From: graham.dumpleton@gmail.com
>> To: sideh101@hotmail.fr
>> Subject: Re: [mod_python] [SPAM] PythonAuthenHandler troubles!!!
>> CC: mod_python@modpython.org
>>
>> 2008/9/5 steve boutabi <sideh101@hotmail.fr>:
>> > Hi, i'm working on a project in Python in which i have enable reading
>> > and
>> > modifying documents with OpenOffice through WebDav.
>> > The trouble comes when i try to give the authentification phase to
>> > mod-python, it simply doesn't work
>> >
>> > here is my site.conf:
>> > <Directory "/opt/monsite">
>> > Dav On
>> > AddHandler mod_python .odt
>> > PythonAuthenHandler myscript
>> > PythonDebug On
>> > AuthType Basic
>> > AuthName "Mosaic"
>> > <Limit PUT POST DELETE PROPFIND PROPPATCH MKCOL COPY MOVE LOCK UNLOCK>
>> > Require valid-user
>> > </Limit>
>> > </Directory>
>> >
>> >
>> >
>> > if i try to add an AuthAuthoritative Off directive, Apache don't start
>> > telling me that this command is misspelled or that some module is
>> > missing.
>> > if i try to add a PythonHandler, i must handle everything, thus i loose
>> > WebDav functionality.
>> >
>> > I want only authentification to be handeled by PythonAuthenHandler the
>> > rest
>> > by Apache-WebDAV
>>
>> If you only want authentication to be handled by mod_python, why do you
>> have:
>>
>> AddHandler mod_python .odt
>>
>> That only applies to content handler phase and may confused DAV.
>>
>> Other than that, don't really understand what you are trying to say in
>> 'don't start telling me that this command is misspelled or that some
>> module is missing'. Also doesn't help that you don't supply what is in
>> your authenhandler.
>>
>> FWIW, if all you are using mod_python for is a custom basic auth
>> provider, you may be better off using mod_wsgi instead as its support
>> for auth providers is simpler to use than doing a full authentication
>> handler for mod_python.
>>
>> See:
>>
>> http://code.google.com/p/modwsgi/wiki/AccessControlMechanisms
>>
>> Graham
>
> ________________________________
> Discutez sur Messenger o? que vous soyez ! Mettez Messenger sur votre mobile
> !

From martijn at xs4us.nu  Mon Sep  8 06:30:31 2008
From: martijn at xs4us.nu (Martijn Moeling)
Date: Mon Sep  8 06:30:40 2008
Subject: [mod_python] Cookieless sessions
Message-ID: <B6C73A5E30565245BB6D32B5F5DF7A52120506@sense.emmastraat.pijnacker>

Hi there,

I am currently working over the Session part of mod_python, let me
explain why.

I am developing a system for over 3 years now which is based on MP and
which has several features to make it scaleable by using a backend
database server and multiple frond end machines to serve pages, data etc
to the browser.

Since it is highly based on load balancing, I needed to store the
session in my database and not in the provided methods of Session.py, so
(I posted this to this mailinglist a long time ago) I extended
Session.Py with the possibility to store session objects/data in MySQL
using MySQLdb.

Now I'm reworking the system to SQLAlchemy and came across the idea to
use cookieless sessions if possible to enable my system to run on
systems where cookies are disabled, Did anyone do so or might this be a
useful contribution to MP? Any tips/comments are usefull

Martijn

From edgardalvescosta at gmail.com  Mon Sep  8 07:48:38 2008
From: edgardalvescosta at gmail.com (Edgard Alves da Costa)
Date: Mon Sep  8 07:48:41 2008
Subject: [mod_python] Problem with with apache2 and mod_python
Message-ID: <718f28970809080448hc736bb4oc4876d4138027b10@mail.gmail.com>

Hi all,

After a beging sucessfully in mod_python, some friends told me that working
with zope/plone would give a large vision of how i could work with script
python and web.

The trip was good, but i prefer the way of mod_python.

Well, i turned back my apache server and i'm having a little problem with
the configuration.

My apache2:
<Directory /var/wwww/pwww/>
        SetHandler mod_python
       PythonHandler mod_python.publisher
       PythonDebug On
     </Directory>
or
<Directory /var/wwww/pwww/>
        AddHandler mod_python .py
       PythonHandler mod_python.publisher
       PythonDebug On
     </Directory>
In the browser a i have the scripts like a common txt files. like:

def teste():
	s="""\
	<html>
	<body>
	Teste
	</body></html>"""

	return s

What is wrong??

The version of the softwares:
Apache/2.2.8 (Ubuntu) mod_python/3.3.1 Python/2.5.2 Server

-- 
Edgard Alves Costa

www.prontuarioeletronico.odo.br
LinuxUser:443056
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080908/5e8e26ab/attachment.html
From edgardalvescosta at gmail.com  Mon Sep  8 09:52:23 2008
From: edgardalvescosta at gmail.com (edgard)
Date: Mon Sep  8 09:52:35 2008
Subject: [mod_python] Problem with with apache2 and mod_python
Message-ID: <1220881943.7301.11.camel@ubuntuserver>

Clodoaldo

Very good observation. But the four "w" isn't the problem.

I made a modification in the ../sites-avaible/default.

<Directory /var/www/pwww>

The firefox show me that the file pwww not exist.

But, if i left with the four 'w' the firefox show this:
Index of /pwww
    [ICO]
     Name
Last modified
     Size
 Description
       
______________
[DIR]
Parent
Directory
 
            - 
[ ]
pyteste
   08-Sep-2008
        09:31 
           36 
[TXT]
pyteste.py
   08-Sep-2008
        09:52 
           93 
[ ]
pyteste2
   08-Sep-2008
        09:29 
           79 
       
______________
Apache/2.2.8 (Ubuntu) mod_python/3.3.1 Python/2.5.2 Server.

What is this????????? With path error goes. With the right path not
goes.

I reallly don't understand................



Edgard Costa

edgardalvescosta@gmail.com




From edgardalvescosta at gmail.com  Mon Sep  8 10:23:33 2008
From: edgardalvescosta at gmail.com (edgard)
Date: Mon Sep  8 10:23:44 2008
Subject: [mod_python] Fix the problem
Message-ID: <1220883813.7301.14.camel@ubuntuserver>

Hi evevybody

With the Cloaldo's observation and another handler provide by
webpython.codepoint.net the problem was fixed.

Thanks for all

EdgardCosta

From list at joreybump.com  Mon Sep  8 10:31:10 2008
From: list at joreybump.com (Jorey Bump)
Date: Mon Sep  8 10:31:45 2008
Subject: [mod_python] Problem with with apache2 and mod_python
In-Reply-To: <718f28970809080448hc736bb4oc4876d4138027b10@mail.gmail.com>
References: <718f28970809080448hc736bb4oc4876d4138027b10@mail.gmail.com>
Message-ID: <48C5372E.3020009@joreybump.com>

Edgard Alves da Costa wrote, at 09/08/2008 07:48 AM:

> In the browser a i have the scripts like a common txt files. like:
> 
> def teste():
> 	s="""\
> 	<html>
> 	<body>
> 	Teste
> 	</body></html>"""
> 
> 	return s
> 
> 
> What is wrong??

Check your apache error log. Is mod_python loading? You should see a 
line like this:

[Mon Sep 01 08:30:15 2008] [notice] mod_python: Creating 8 session 
mutexes based on 256 max processes and 0 max threads.

Did you do what Ubuntu needs you to do to load the module?




From dzhelil at gmail.com  Mon Sep  8 13:14:39 2008
From: dzhelil at gmail.com (Dzhelil Rufat)
Date: Mon Sep  8 13:14:45 2008
Subject: [mod_python] excluding files from traversal
Message-ID: <f057d48d0809081014m40275a76rabc278ad4c0ae6@mail.gmail.com>

Hello,

I have an index.py and a bunch of other python libraries in my mod_python
directory. I use the publisher as my mod_python handler.

I would like for publisher to traverse only the index.py file and not any of
the library python files that reside in the same directory. How can I
specify this in httpd.conf?

I tried something like

SetHandler mod_python index.py

but that did not work.

Right now, I use the following configuration for httpd.conf:

<Directory /mod_python_dir>
    SetHandler mod_python
    PythonHandler mod_python.publisher
    PythonDebug On
</Directory>


Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080908/ab3fec1e/attachment.html
From clodoaldo.pinto.neto at gmail.com  Mon Sep  8 13:47:26 2008
From: clodoaldo.pinto.neto at gmail.com (Clodoaldo)
Date: Mon Sep  8 13:47:32 2008
Subject: [mod_python] excluding files from traversal
In-Reply-To: <f057d48d0809081014m40275a76rabc278ad4c0ae6@mail.gmail.com>
References: <f057d48d0809081014m40275a76rabc278ad4c0ae6@mail.gmail.com>
Message-ID: <a595de7a0809081047p4fe2fcf7y7c953bc3b0068447@mail.gmail.com>

2008/9/8 Dzhelil Rufat <dzhelil@gmail.com>:
> Hello,
>
> I have an index.py and a bunch of other python libraries in my mod_python
> directory. I use the publisher as my mod_python handler.
>
> I would like for publisher to traverse only the index.py file and not any of
> the library python files that reside in the same directory. How can I
> specify this in httpd.conf?
>
> I tried something like
>
> SetHandler mod_python index.py
>
> but that did not work.
>
> Right now, I use the following configuration for httpd.conf:
>
> <Directory /mod_python_dir>
>     SetHandler mod_python
>     PythonHandler mod_python.publisher
>     PythonDebug On
> </Directory>

The best aproach would be to put those files out of the site root tree
like in /home/my_site_modules

Regards, Clodoaldo Pinto Neto

> Thank you.
>
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
>
From florian.leitner at cnio.es  Mon Sep  8 14:21:00 2008
From: florian.leitner at cnio.es (Florian Leitner)
Date: Mon Sep  8 14:21:09 2008
Subject: [mod_python] Trouble loading mod_python Mac Os X
Message-ID: <11E0B13C-D363-4E09-99B5-91E20D4E8B64@cnio.es>

I, too, have the same problem as Alex Lurthu loading mod_python. I am  
using an OSX Server (10.5.3), ppc64 architecture. After solving the  
architecture problem, I get these error messages:

[Mon Sep 08 19:42:55 2008] [error] (9)Bad file descriptor:  
apr_pollset_poll: (listen)
httpd: Syntax error on line 164 of /private/etc/apache2/httpd.conf:  
Can't locate API module structure `pyhton25_module' in file /usr/ 
libexec/apache2/mod_python.so: dlsym(0x100206d00, pyhton25_module):  
symbol not found

(pyhton25_module is the name I gave mod_python in the OSX server  
Apache configuration)
I then followed Graham's advice to get the latest SVN version. This  
helps solving the architecture problem without any manual  
interventions (i.e., I just configure/make/install, and the can go  
"directly" to the "symbol not found" error), but the symbol error does  
not get resolved. Then, I found a blog describing this "symbol not  
found" error because OSX Server is calling /usr/bin/envvars when  
executing apachectl, which contains these lines:

DYLD_LIBRARY_PATH="/usr/lib:$DYLD_LIBRARY_PATH"
export DYLD_LIBRARY_PATH

I commented out those as advised, but obviously without help - the  
symbol error also persists after recompiling mod_python with those  
line commented and/or calling /usr/sbin/httpd directly. Also launching  
httpd with different architecture flags (using

/usr/bin/arch -arch <some arch> /usr/sbin/httpd -D FOREGROUND

) does not help. Also, the output of otool looks nice:

/usr/libexec/apache2/mod_python.so:
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current  
version 111.1.1)
	/System/Library/Frameworks/Python.framework/Versions/2.5/Python  
(compatibility version 2.5.0, current version 2.5.1)
	/usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current  
version 1.0.0)

Just as the file output:

/usr/libexec/apache2/mod_python.so: Mach-O universal binary with 4  
architectures
/usr/libexec/apache2/mod_python.so (for architecture ppc7400):	Mach-O  
bundle ppc
/usr/libexec/apache2/mod_python.so (for architecture ppc64):	Mach-O 64- 
bit bundle ppc64
/usr/libexec/apache2/mod_python.so (for architecture i386):	Mach-O  
bundle i386
/usr/libexec/apache2/mod_python.so (for architecture x86_64):	Mach-O  
64-bit bundle x86_64

So I am quite clueless now. Any ideas? Thanks!

-Florian

=Architecture:
ppc64 (G5)
=OS:
OSX Server 10.5.4
=Apache:
2.2.8/Unix
=mod_python:
SVN version, and 3.3.1
=Python:
2.5.1 (OSX 10.5.4 default version)

--
Florian Leitner
fleitner@cnio.es
http://www.CNIO.es

BioCreative MetaServer:
http://bcms.bioinfo.cnio.es

Spanish National Cancer Research Centre
Structural and Computational Biology Unit
C/ Melchor Fernandez Almagro, 3
E-28029 Madrid


**NOTA DE CONFIDENCIALIDAD** Este correo electrónico, y en su caso los ficheros adjuntos, pueden contener información protegida para el uso exclusivo de su destinatario. Se prohíbe la distribución, reproducción o cualquier otro tipo de transmisión por parte de otra persona que no sea el destinatario. Si usted recibe por error este correo, se ruega comunicarlo al remitente y borrar el mensaje recibido.
**CONFIDENTIALITY NOTICE** This email communication and any attachments may contain confidential and privileged information for the sole use of the designated recipient named above. Distribution, reproduction or any other use of this transmission by any party other than the intended recipient is prohibited. If you are not the intended recipient please contact the sender and delete all copies.

From florian.leitner at cnio.es  Mon Sep  8 14:30:38 2008
From: florian.leitner at cnio.es (Florian Leitner)
Date: Mon Sep  8 14:30:52 2008
Subject: Fwd: [mod_python] Trouble loading mod_python Mac Os X
References: <11E0B13C-D363-4E09-99B5-91E20D4E8B64@cnio.es>
Message-ID: <7FCF2196-1741-4D56-922E-33CDAB54B7EF@cnio.es>

Followup/solved:

I was obviously sitting on my brain, it seems... After writing this  
mail, I went through it and realized that I am doing something very,  
very funny... Instead of using the module name "Python_module", I had  
put "pyhton25_module", i.e., not only the wrong name, but even written  
wrong. Well, anyways, I'm happy it's working... :-D

Begin forwarded message:

> From: Florian Leitner <florian.leitner@cnio.es>
> Date: Mon, 08.09.2008 20:21:00  GMT+02:00
> To: mod_python@modpython.org
> Subject: Re: [mod_python] Trouble loading mod_python Mac Os X
>
> I, too, have the same problem as Alex Lurthu loading mod_python. I  
> am using an OSX Server (10.5.3), ppc64 architecture. After solving  
> the architecture problem, I get these error messages:
>
> [Mon Sep 08 19:42:55 2008] [error] (9)Bad file descriptor:  
> apr_pollset_poll: (listen)
> httpd: Syntax error on line 164 of /private/etc/apache2/httpd.conf:  
> Can't locate API module structure `pyhton25_module' in file /usr/ 
> libexec/apache2/mod_python.so: dlsym(0x100206d00, pyhton25_module):  
> symbol not found
>
> (pyhton25_module is the name I gave mod_python in the OSX server  
> Apache configuration)
> I then followed Graham's advice to get the latest SVN version. This  
> helps solving the architecture problem without any manual  
> interventions (i.e., I just configure/make/install, and the can go  
> "directly" to the "symbol not found" error), but the symbol error  
> does not get resolved. Then, I found a blog describing this "symbol  
> not found" error because OSX Server is calling /usr/bin/envvars when  
> executing apachectl, which contains these lines:
>
> DYLD_LIBRARY_PATH="/usr/lib:$DYLD_LIBRARY_PATH"
> export DYLD_LIBRARY_PATH
>
> I commented out those as advised, but obviously without help - the  
> symbol error also persists after recompiling mod_python with those  
> line commented and/or calling /usr/sbin/httpd directly. Also  
> launching httpd with different architecture flags (using
>
> /usr/bin/arch -arch <some arch> /usr/sbin/httpd -D FOREGROUND
>
> ) does not help. Also, the output of otool looks nice:
>
> /usr/libexec/apache2/mod_python.so:
> 	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current  
> version 111.1.1)
> 	/System/Library/Frameworks/Python.framework/Versions/2.5/Python  
> (compatibility version 2.5.0, current version 2.5.1)
> 	/usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current  
> version 1.0.0)
>
> Just as the file output:
>
> /usr/libexec/apache2/mod_python.so: Mach-O universal binary with 4  
> architectures
> /usr/libexec/apache2/mod_python.so (for architecture ppc7400):	Mach- 
> O bundle ppc
> /usr/libexec/apache2/mod_python.so (for architecture ppc64):	Mach-O  
> 64-bit bundle ppc64
> /usr/libexec/apache2/mod_python.so (for architecture i386):	Mach-O  
> bundle i386
> /usr/libexec/apache2/mod_python.so (for architecture x86_64):	Mach-O  
> 64-bit bundle x86_64
>
> So I am quite clueless now. Any ideas? Thanks!
>
> -Florian
>
> =Architecture:
> ppc64 (G5)
> =OS:
> OSX Server 10.5.4
> =Apache:
> 2.2.8/Unix
> =mod_python:
> SVN version, and 3.3.1
> =Python:
> 2.5.1 (OSX 10.5.4 default version)
>
> --
> Florian Leitner
> fleitner@cnio.es
> http://www.CNIO.es
>
> BioCreative MetaServer:
> http://bcms.bioinfo.cnio.es
>
> Spanish National Cancer Research Centre
> Structural and Computational Biology Unit
> C/ Melchor Fernandez Almagro, 3
> E-28029 Madrid
>
>
> **NOTA DE CONFIDENCIALIDAD** Este correo electr?nico, y en su caso  
> los ficheros adjuntos, pueden contener informaci?n protegida para el  
> uso exclusivo de su destinatario. Se proh?be la distribuci?n,  
> reproducci?n o cualquier otro tipo de transmisi?n por parte de otra  
> persona que no sea el destinatario. Si usted recibe por error este  
> correo, se ruega comunicarlo al remitente y borrar el mensaje  
> recibido.
> **CONFIDENTIALITY NOTICE** This email communication and any  
> attachments may contain confidential and privileged information for  
> the sole use of the designated recipient named above. Distribution,  
> reproduction or any other use of this transmission by any party  
> other than the intended recipient is prohibited. If you are not the  
> intended recipient please contact the sender and delete all copies.
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

--
Florian Leitner
fleitner@cnio.es
http://www.CNIO.es

BioCreative MetaServer:
http://bcms.bioinfo.cnio.es

Spanish National Cancer Research Centre
Structural and Computational Biology Unit
C/ Melchor Fernandez Almagro, 3
E-28029 Madrid



**NOTA DE CONFIDENCIALIDAD** Este correo electr?nico, y en su caso los ficheros adjuntos, pueden contener informaci?n protegida para el uso exclusivo de su destinatario. Se proh?be la distribuci?n, reproducci?n o cualquier otro tipo de transmisi?n por parte de otra persona que no sea el destinatario. Si usted recibe por error este correo, se ruega comunicarlo al remitente y borrar el mensaje recibido.
**CONFIDENTIALITY NOTICE** This email communication and any attachments may contain confidential and privileged information for the sole use of the designated recipient named above. Distribution, reproduction or any other use of this transmission by any party other than the intended recipient is prohibited. If you are not the intended recipient please contact the sender and delete all copies.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080908/71d7fa03/attachment-0001.html
From tmmoyer at cse.psu.edu  Thu Sep 11 08:18:21 2008
From: tmmoyer at cse.psu.edu (Thomas Moyer)
Date: Thu Sep 11 08:18:26 2008
Subject: [mod_python] Performance Question
Message-ID: <2CB7C4C8-530D-4136-912D-AC17E7E5D611@cse.psu.edu>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

I am having some problems with performance when using mod_python to  
serve some dynamic content.  The request handler gathers information  
being generated by background processes on the system, and then  
creates a simple XML document that is sent to the client. Here is the  
code I am using with some explanation.

     requestedFilePath = "/" + req.filename.split("/")[-1] 
[:-4].replace("_", "/").replace("-",".")
     sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
     sock.connect(ATTService)
     Attest = message.recvMsg(sock)[0]
     sock.close()

     fmt = "%ds" % len(requestedFilePath)
     msg = struct.pack(fmt, requestedFilePath)
     sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
     sock.connect(MHTService)
     message.sendMsg(sock, msg, fmt)
     MHTList = message.recvMsg(sock)[0]
     sock.close()

     req.content_type = 'text/xml'
     req.write("<ACA>%s%s</ACA>" % (Attest,MHTList))
     return apache.OK

There are 3 different pieces here.  The first block connects to a  
daemon running on the system that is monitoring the system. I connect  
to a Unix domain socket and receive the most recent information it  
has.  I then do the same thing with another daemon that is gathering  
information about files that are available on the system. Finally I  
combine these two blocks of information and send it to the client.

My problem is, when I start using benchmarking tools like JMeter, and  
I put the system under any sort of load (100 clients for example), the  
first recvMsg call (Attest = message.recvMsg(sock)[0]) takes about 12  
seconds to complete per client.  I watch top during the run and see  
that the apache processes are completely occupied (usually showing 120+ 
% CPU usage).  The system running apache is an 8-core machine with  
16GB of RAM so I'm pretty sure there isn't a resource problem for  
either memory or processor.

I'm not really sure where to look next to understand why a simple  
socket recv() call is taking 12 seconds to complete.  The amount of  
data being recv()'d is ~80K of text if that makes a difference.

~tom
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.8 (Darwin)

iEYEARECAAYFAkjJDI0ACgkQa7Yypxfw9TeOPwCfb29vCZlna6WZL9X/SASxT4Ms
cxYAnRyDlcMF6gWuSgdT8HHPnq1Urs/H
=NPk2
-----END PGP SIGNATURE-----
From scarfboy at gmail.com  Thu Sep 11 09:06:53 2008
From: scarfboy at gmail.com (Bart)
Date: Thu Sep 11 09:06:59 2008
Subject: [mod_python] Performance Question
In-Reply-To: <2CB7C4C8-530D-4136-912D-AC17E7E5D611@cse.psu.edu>
References: <2CB7C4C8-530D-4136-912D-AC17E7E5D611@cse.psu.edu>
Message-ID: <b71082d80809110606j65c3dcebq55b736fa72a6ab31@mail.gmail.com>

I'm not sure whether this is relevant,
but I vaguely recall that time in send()/recv() show up as CPU time
since it's actually polling behind the scenes, so could it be that
those background processes are causing most of that CPU through
(computation+networking) delay that they cause at that level of
parallelism?

It sounds a little too extreme for it to be that, though. Have you
tested other, similar setups, e.g. doing the same parallelism test
through a command line script outside apache (e.g. by firing off ~100
threads that do the same)?

Regards,
--Bart


On Thu, Sep 11, 2008 at 2:18 PM, Thomas Moyer <tmmoyer@cse.psu.edu> wrote:
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA1
>
> I am having some problems with performance when using mod_python to serve
> some dynamic content.  The request handler gathers information being
> generated by background processes on the system, and then creates a simple
> XML document that is sent to the client. Here is the code I am using with
> some explanation.
>
>    requestedFilePath = "/" + req.filename.split("/")[-1][:-4].replace("_",
> "/").replace("-",".")
>    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
>    sock.connect(ATTService)
>    Attest = message.recvMsg(sock)[0]
>    sock.close()
>
>    fmt = "%ds" % len(requestedFilePath)
>    msg = struct.pack(fmt, requestedFilePath)
>    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
>    sock.connect(MHTService)
>    message.sendMsg(sock, msg, fmt)
>    MHTList = message.recvMsg(sock)[0]
>    sock.close()
>
>    req.content_type = 'text/xml'
>    req.write("<ACA>%s%s</ACA>" % (Attest,MHTList))
>    return apache.OK
>
> There are 3 different pieces here.  The first block connects to a daemon
> running on the system that is monitoring the system. I connect to a Unix
> domain socket and receive the most recent information it has.  I then do the
> same thing with another daemon that is gathering information about files
> that are available on the system. Finally I combine these two blocks of
> information and send it to the client.
>
> My problem is, when I start using benchmarking tools like JMeter, and I put
> the system under any sort of load (100 clients for example), the first
> recvMsg call (Attest = message.recvMsg(sock)[0]) takes about 12 seconds to
> complete per client.  I watch top during the run and see that the apache
> processes are completely occupied (usually showing 120+% CPU usage).  The
> system running apache is an 8-core machine with 16GB of RAM so I'm pretty
> sure there isn't a resource problem for either memory or processor.
>
> I'm not really sure where to look next to understand why a simple socket
> recv() call is taking 12 seconds to complete.  The amount of data being
> recv()'d is ~80K of text if that makes a difference.
>
> ~tom
> -----BEGIN PGP SIGNATURE-----
> Version: GnuPG v1.4.8 (Darwin)
>
> iEYEARECAAYFAkjJDI0ACgkQa7Yypxfw9TeOPwCfb29vCZlna6WZL9X/SASxT4Ms
> cxYAnRyDlcMF6gWuSgdT8HHPnq1Urs/H
> =NPk2
> -----END PGP SIGNATURE-----
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From tmmoyer at cse.psu.edu  Thu Sep 11 09:11:00 2008
From: tmmoyer at cse.psu.edu (Thomas Moyer)
Date: Thu Sep 11 09:11:04 2008
Subject: [mod_python] Performance Question
In-Reply-To: <b71082d80809110606j65c3dcebq55b736fa72a6ab31@mail.gmail.com>
References: <2CB7C4C8-530D-4136-912D-AC17E7E5D611@cse.psu.edu>
	<b71082d80809110606j65c3dcebq55b736fa72a6ab31@mail.gmail.com>
Message-ID: <48D01F52-54F0-45F9-ADAE-D0CC313CC227@cse.psu.edu>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

I've monitored the time spent by the background process to handle one  
request, and the numbers are as expected (i.e. very short times to  
handle a request).  Also monitoring top during the run shows my  
background process as nearly idle during this whole test. Never more  
than 1-2% CPU usage.  The computation in the background process is  
nil.  It merely takes a string of XML it has previously generated and  
sends it to the mod_python module.  Networking should also be nil  
because I am using Unix domain sockets which are local to the system  
and therefor bypass the network stack and simply move bytes around in  
memory.

~tom

On Sep 11, 2008, at 9:06 AM, Bart wrote:

> I'm not sure whether this is relevant,
> but I vaguely recall that time in send()/recv() show up as CPU time
> since it's actually polling behind the scenes, so could it be that
> those background processes are causing most of that CPU through
> (computation+networking) delay that they cause at that level of
> parallelism?
>
> It sounds a little too extreme for it to be that, though. Have you
> tested other, similar setups, e.g. doing the same parallelism test
> through a command line script outside apache (e.g. by firing off ~100
> threads that do the same)?
>
> Regards,
> --Bart
>
>
> On Thu, Sep 11, 2008 at 2:18 PM, Thomas Moyer <tmmoyer@cse.psu.edu>  
> wrote:
>> -----BEGIN PGP SIGNED MESSAGE-----
>> Hash: SHA1
>>
>> I am having some problems with performance when using mod_python to  
>> serve
>> some dynamic content.  The request handler gathers information being
>> generated by background processes on the system, and then creates a  
>> simple
>> XML document that is sent to the client. Here is the code I am  
>> using with
>> some explanation.
>>
>>   requestedFilePath = "/" + req.filename.split("/")[-1] 
>> [:-4].replace("_",
>> "/").replace("-",".")
>>   sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
>>   sock.connect(ATTService)
>>   Attest = message.recvMsg(sock)[0]
>>   sock.close()
>>
>>   fmt = "%ds" % len(requestedFilePath)
>>   msg = struct.pack(fmt, requestedFilePath)
>>   sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
>>   sock.connect(MHTService)
>>   message.sendMsg(sock, msg, fmt)
>>   MHTList = message.recvMsg(sock)[0]
>>   sock.close()
>>
>>   req.content_type = 'text/xml'
>>   req.write("<ACA>%s%s</ACA>" % (Attest,MHTList))
>>   return apache.OK
>>
>> There are 3 different pieces here.  The first block connects to a  
>> daemon
>> running on the system that is monitoring the system. I connect to a  
>> Unix
>> domain socket and receive the most recent information it has.  I  
>> then do the
>> same thing with another daemon that is gathering information about  
>> files
>> that are available on the system. Finally I combine these two  
>> blocks of
>> information and send it to the client.
>>
>> My problem is, when I start using benchmarking tools like JMeter,  
>> and I put
>> the system under any sort of load (100 clients for example), the  
>> first
>> recvMsg call (Attest = message.recvMsg(sock)[0]) takes about 12  
>> seconds to
>> complete per client.  I watch top during the run and see that the  
>> apache
>> processes are completely occupied (usually showing 120+% CPU  
>> usage).  The
>> system running apache is an 8-core machine with 16GB of RAM so I'm  
>> pretty
>> sure there isn't a resource problem for either memory or processor.
>>
>> I'm not really sure where to look next to understand why a simple  
>> socket
>> recv() call is taking 12 seconds to complete.  The amount of data  
>> being
>> recv()'d is ~80K of text if that makes a difference.
>>
>> ~tom
>> -----BEGIN PGP SIGNATURE-----
>> Version: GnuPG v1.4.8 (Darwin)
>>
>> iEYEARECAAYFAkjJDI0ACgkQa7Yypxfw9TeOPwCfb29vCZlna6WZL9X/SASxT4Ms
>> cxYAnRyDlcMF6gWuSgdT8HHPnq1Urs/H
>> =NPk2
>> -----END PGP SIGNATURE-----
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python


- --
Thomas Moyer
Graduate Student
CSE Department
Penn State University
tmmoyer@cse.psu.edu
http://www.cse.psu.edu/~tmmoyer

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.8 (Darwin)

iEYEARECAAYFAkjJGOQACgkQa7Yypxfw9TcPtACgjXtIoSOMjIRJHw8OQXNfSL0I
2ewAoKG02WbJ8c56Cf61803AERx+2ekv
=qWaY
-----END PGP SIGNATURE-----
From graham.dumpleton at gmail.com  Thu Sep 11 19:00:15 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Thu Sep 11 19:00:17 2008
Subject: [mod_python] Performance Question
In-Reply-To: <2CB7C4C8-530D-4136-912D-AC17E7E5D611@cse.psu.edu>
References: <2CB7C4C8-530D-4136-912D-AC17E7E5D611@cse.psu.edu>
Message-ID: <88e286470809111600g29707397tcd32df1fece9ec45@mail.gmail.com>

How many Apache processes do you have configured to be started up?

Are you using worker or prefork MPM?

If worker, how many threads in each process?

How fat is your application?

Do you preload/precalculate data when application loaded?

Especially if you are using prefork MPM and only have small number of
initial Apache processes configured, then hitting it with 100
concurrent requests is going to force Apache to start a lot more
processes to handle the requests. If your application is fat, or does
a lot of preloading of data, then starting up those processes will
take time and so initial requests will appear to be slow.

Graham

2008/9/11 Thomas Moyer <tmmoyer@cse.psu.edu>:
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA1
>
> I am having some problems with performance when using mod_python to serve
> some dynamic content.  The request handler gathers information being
> generated by background processes on the system, and then creates a simple
> XML document that is sent to the client. Here is the code I am using with
> some explanation.
>
>    requestedFilePath = "/" + req.filename.split("/")[-1][:-4].replace("_",
> "/").replace("-",".")
>    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
>    sock.connect(ATTService)
>    Attest = message.recvMsg(sock)[0]
>    sock.close()
>
>    fmt = "%ds" % len(requestedFilePath)
>    msg = struct.pack(fmt, requestedFilePath)
>    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
>    sock.connect(MHTService)
>    message.sendMsg(sock, msg, fmt)
>    MHTList = message.recvMsg(sock)[0]
>    sock.close()
>
>    req.content_type = 'text/xml'
>    req.write("<ACA>%s%s</ACA>" % (Attest,MHTList))
>    return apache.OK
>
> There are 3 different pieces here.  The first block connects to a daemon
> running on the system that is monitoring the system. I connect to a Unix
> domain socket and receive the most recent information it has.  I then do the
> same thing with another daemon that is gathering information about files
> that are available on the system. Finally I combine these two blocks of
> information and send it to the client.
>
> My problem is, when I start using benchmarking tools like JMeter, and I put
> the system under any sort of load (100 clients for example), the first
> recvMsg call (Attest = message.recvMsg(sock)[0]) takes about 12 seconds to
> complete per client.  I watch top during the run and see that the apache
> processes are completely occupied (usually showing 120+% CPU usage).  The
> system running apache is an 8-core machine with 16GB of RAM so I'm pretty
> sure there isn't a resource problem for either memory or processor.
>
> I'm not really sure where to look next to understand why a simple socket
> recv() call is taking 12 seconds to complete.  The amount of data being
> recv()'d is ~80K of text if that makes a difference.
>
> ~tom
> -----BEGIN PGP SIGNATURE-----
> Version: GnuPG v1.4.8 (Darwin)
>
> iEYEARECAAYFAkjJDI0ACgkQa7Yypxfw9TeOPwCfb29vCZlna6WZL9X/SASxT4Ms
> cxYAnRyDlcMF6gWuSgdT8HHPnq1Urs/H
> =NPk2
> -----END PGP SIGNATURE-----
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From Peter.Bleackley at rd.bbc.co.uk  Fri Sep 12 11:00:11 2008
From: Peter.Bleackley at rd.bbc.co.uk (Peter Bleackley)
Date: Fri Sep 12 11:00:23 2008
Subject: [mod_python] Problem with Cookies and databases
Message-ID: <7.0.1.0.2.20080912153504.0250dfa0@rd.bbc.co.uk>

A web application I'm writing has an "email a friend" function in it, 
which is failing for reasons I don't understand. I'll send the 
relevant bits of the code here (anything unrelated to the problem is omitted).
This is running under the Publisher handler.

from mod_python import apache,Cookie,util
from pysqlite2 import dbapi2 as sqlite

def login(req):
	username=req.form['user']
# Irrelevant code omitted
	demographics=sqlite.connect('database.db') #Not the real filename
	cursor=demographics.cursor()
# Skip
	userid=cursor.execute("select rowid in logins where 
username=?",(username,)).fetchone()[0]
	cur=cursor.execute('insert into sessions (userid) values (?)',(userid,)))
	sessionid=cur.lastrowid
	sessioncookie=Cookie.Cookie('sessionid',sessionid)
	Cookie.add_cookie(req,sessioncookie)
	demographics.commit()
#Rest of this function is irrelevant

def email(req):
	sessioncookie=Cookie.getcookies(req)
	sessionid=int(sessioncookie['sessionid'].value)
	demographics=sqlite.connect('database.db')
	cursor=demographics.cursor()
	userid=cursor.execute('select userid from sessions where 
rowid=?',(sessionid,)).fetchone()[0]

At this point I get


TypeError: unsubscriptable object


which, in my experience, usually means that fetchone() has returned 
None. I can't work out why it's doing this, as the sessionid obtained 
from the Cookie should be the same value as was set when the user 
logged in, and that was a rowid from the database table I'm 
searching. Anybody got an ideas what's wrong here?

Dr Peter J Bleackley
Research Engineer
BBC Research.

From clodoaldo.pinto.neto at gmail.com  Fri Sep 12 12:04:18 2008
From: clodoaldo.pinto.neto at gmail.com (Clodoaldo)
Date: Fri Sep 12 12:04:21 2008
Subject: [mod_python] Problem with Cookies and databases
In-Reply-To: <7.0.1.0.2.20080912153504.0250dfa0@rd.bbc.co.uk>
References: <7.0.1.0.2.20080912153504.0250dfa0@rd.bbc.co.uk>
Message-ID: <a595de7a0809120904w4b40b3faped21117f20c92dd7@mail.gmail.com>

2008/9/12 Peter Bleackley <Peter.Bleackley@rd.bbc.co.uk>:
> A web application I'm writing has an "email a friend" function in it, which
> is failing for reasons I don't understand. I'll send the relevant bits of
> the code here (anything unrelated to the problem is omitted).
> This is running under the Publisher handler.
>
> from mod_python import apache,Cookie,util
> from pysqlite2 import dbapi2 as sqlite
>
> def login(req):
>        username=req.form['user']
> # Irrelevant code omitted
>        demographics=sqlite.connect('database.db') #Not the real filename
>        cursor=demographics.cursor()
> # Skip
>        userid=cursor.execute("select rowid in logins where
> username=?",(username,)).fetchone()[0]
>        cur=cursor.execute('insert into sessions (userid) values
> (?)',(userid,)))
>        sessionid=cur.lastrowid
>        sessioncookie=Cookie.Cookie('sessionid',sessionid)
>        Cookie.add_cookie(req,sessioncookie)
>        demographics.commit()
> #Rest of this function is irrelevant
>
> def email(req):
>        sessioncookie=Cookie.getcookies(req)
>        sessionid=int(sessioncookie['sessionid'].value)

Are you sure sessionid has an int value? Use this to check:
          req.log_error('sessionid: %s' % repr(sessionid))
It will be output to the Apache error log.

>        demographics=sqlite.connect('database.db')
>        cursor=demographics.cursor()
>        userid=cursor.execute('select userid from sessions where
> rowid=?',(sessionid,)).fetchone()[0]

Try changing sessionid for an int constant which you know exists in the table.
        userid=cursor.execute('select userid from sessions where
rowid=?',(1,)).fetchone()[0]

Regards, Clodoaldo Pinto Neto

> At this point I get
>
>
> TypeError: unsubscriptable object
>
>
> which, in my experience, usually means that fetchone() has returned None. I
> can't work out why it's doing this, as the sessionid obtained from the
> Cookie should be the same value as was set when the user logged in, and that
> was a rowid from the database table I'm searching. Anybody got an ideas
> what's wrong here?
>
> Dr Peter J Bleackley
> Research Engineer
> BBC Research.
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From Peter.Bleackley at rd.bbc.co.uk  Tue Sep 16 08:47:53 2008
From: Peter.Bleackley at rd.bbc.co.uk (Peter Bleackley)
Date: Tue Sep 16 08:48:05 2008
Subject: [mod_python] My web application is now up and running
Message-ID: <7.0.1.0.2.20080916134116.0259ffe0@rd.bbc.co.uk>

Thank you to everybody on the list who's helped me fix the bugs in 
the web application I've been working on. My app, an experiment to 
train a neural network to recognise emotions from gestures, is now up 
and running and can be seen in action at
http://callas.kw.bbc.co.uk/EmotionRecognition.html

Dr Peter J Bleackley
Research Engineer
BBC Research 

From mattb at wageslavery.org  Tue Sep 23 03:55:29 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Tue Sep 23 03:30:41 2008
Subject: [mod_python] requests are blocking when using req.sendfile
Message-ID: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>

i'm having an issue with our site, which seems to be directly
related to using req.sendfile.  on our site, we have secure music
downloads.  the user has to go through a series of steps in order to
gain access to the music (fyi, we run a legitimate service, not a
pirate or warez site).  just some background info..  basically we
can't offer a direct download link or the security can be bypassed. 
so downloading is done through the handler, which runs the checks,
and if everything looks good, the file is sent to the browser using
req.sendfile with the local path to the file on disk.

it works..  but the problem is, requests start backing up whenever a
download is being sent.  it looks like new requests are being sent
to the apache process that is tied up sending the download file.  i
don't understand why this is happening though.  i would think that
while it's sending the file, no new requests would be queued in that
process.  i can verify this easily by downloading a file, and while
it's downloading, clicking on a link on the site from the same
window in which i downloaded in.  the request will stay in the WAIT
state (according to mod_status) until the download is finished, then
the page will load and the queue will clear up.  now if i change the
download link to a static file, served directly by apache, this
problem disappears.

what can i do to fix this?  it's a major issue right now.  many
times a day you can go to the site and it will hang for perhaps 1 to
3 minutes, then it will load, due to the above described situation.

version notes:

CentOS release 5 (Final)
apache 2.2.3
mod_python 3.2

using prefork compiled into apache.  misc apache configuration:

KeepAlive Off

<IfModule prefork.c>
 StartServers       8
 MinSpareServers    5
 MaxSpareServers   20
 ServerLimit      256
 MaxClients       256
 MaxRequestsPerChild  4000
</IfModule>

thank you for your time and consideration..

- m@

From graham.dumpleton at gmail.com  Tue Sep 23 04:05:09 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Tue Sep 23 04:05:15 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809230105l268e5aefh391107b552cb50fd@mail.gmail.com>

And what happens if you stop using an older version of mod_python and
use the latest version?

In other words, upgrade to mod_python 3.3.1 and then we may be able to
help. The older versions have various bugs in them and there is no
point us trying to debug an issue that may have already been fixed.

Graham

2008/9/23 Matt Barnicle <mattb@wageslavery.org>:
> i'm having an issue with our site, which seems to be directly
> related to using req.sendfile.  on our site, we have secure music
> downloads.  the user has to go through a series of steps in order to
> gain access to the music (fyi, we run a legitimate service, not a
> pirate or warez site).  just some background info..  basically we
> can't offer a direct download link or the security can be bypassed.
> so downloading is done through the handler, which runs the checks,
> and if everything looks good, the file is sent to the browser using
> req.sendfile with the local path to the file on disk.
>
> it works..  but the problem is, requests start backing up whenever a
> download is being sent.  it looks like new requests are being sent
> to the apache process that is tied up sending the download file.  i
> don't understand why this is happening though.  i would think that
> while it's sending the file, no new requests would be queued in that
> process.  i can verify this easily by downloading a file, and while
> it's downloading, clicking on a link on the site from the same
> window in which i downloaded in.  the request will stay in the WAIT
> state (according to mod_status) until the download is finished, then
> the page will load and the queue will clear up.  now if i change the
> download link to a static file, served directly by apache, this
> problem disappears.
>
> what can i do to fix this?  it's a major issue right now.  many
> times a day you can go to the site and it will hang for perhaps 1 to
> 3 minutes, then it will load, due to the above described situation.
>
> version notes:
>
> CentOS release 5 (Final)
> apache 2.2.3
> mod_python 3.2
>
> using prefork compiled into apache.  misc apache configuration:
>
> KeepAlive Off
>
> <IfModule prefork.c>
>  StartServers       8
>  MinSpareServers    5
>  MaxSpareServers   20
>  ServerLimit      256
>  MaxClients       256
>  MaxRequestsPerChild  4000
> </IfModule>
>
> thank you for your time and consideration..
>
> - m@
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From mattb at wageslavery.org  Tue Sep 23 15:07:13 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Tue Sep 23 14:42:23 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809230105l268e5aefh391107b552cb50fd@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809230105l268e5aefh391107b552cb50fd@mail.gmail.com>
Message-ID: <60900.69.111.193.161.1222196833.squirrel@webmail.wageslavery.org>

well, there are a couple reasons why i didn't try that straight
away.  i'm not really the best at sysadmin type stuff.  if something
were to go wrong this is our one and only live server at the moment
so i avoid upgrading packages unless i know it's necessary.  i
didn't realize before but we're actually using v3.2.8.  it's pretty
recent, however if you think that the installing the latest version
is essential towards figuring out the problem i will do it.

- m@

> And what happens if you stop using an older version of mod_python
> and use the latest version?
>
> In other words, upgrade to mod_python 3.3.1 and then we may be
able to
> help. The older versions have various bugs in them and there is no
> point us trying to debug an issue that may have already been fixed.
>
> Graham
>
> 2008/9/23 Matt Barnicle <mattb@wageslavery.org>:
>> i'm having an issue with our site, which seems to be directly
>> related to using req.sendfile.  on our site, we have secure music
>> downloads.  the user has to go through a series of steps in order
>> to
>> gain access to the music (fyi, we run a legitimate service, not a
>> pirate or warez site).  just some background info..  basically we
>> can't offer a direct download link or the security can be
>> bypassed.
>> so downloading is done through the handler, which runs the checks,
>> and if everything looks good, the file is sent to the browser
>> using
>> req.sendfile with the local path to the file on disk.
>>
>> it works..  but the problem is, requests start backing up whenever
>> a
>> download is being sent.  it looks like new requests are being sent
>> to the apache process that is tied up sending the download file.
>> i
>> don't understand why this is happening though.  i would think that
>> while it's sending the file, no new requests would be queued in
>> that
>> process.  i can verify this easily by downloading a file, and
>> while
>> it's downloading, clicking on a link on the site from the same
>> window in which i downloaded in.  the request will stay in the
>> WAIT
>> state (according to mod_status) until the download is finished,
>> then
>> the page will load and the queue will clear up.  now if i change
>> the
>> download link to a static file, served directly by apache, this
>> problem disappears.
>>
>> what can i do to fix this?  it's a major issue right now.  many
>> times a day you can go to the site and it will hang for perhaps 1
>> to
>> 3 minutes, then it will load, due to the above described
>> situation.
>>
>> version notes:
>>
>> CentOS release 5 (Final)
>> apache 2.2.3
>> mod_python 3.2
>>
>> using prefork compiled into apache.  misc apache configuration:
>>
>> KeepAlive Off
>>
>> <IfModule prefork.c>
>>  StartServers       8
>>  MinSpareServers    5
>>  MaxSpareServers   20
>>  ServerLimit      256
>>  MaxClients       256
>>  MaxRequestsPerChild  4000
>> </IfModule>
>>
>> thank you for your time and consideration..
>>
>> - m@
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>


From brooklinetom at gmail.com  Tue Sep 23 15:10:51 2008
From: brooklinetom at gmail.com (Tom Stambaugh)
Date: Tue Sep 23 15:10:54 2008
Subject: [mod_python] Apache 2.2.9 + ModPython 3.3.1?
Message-ID: <ad96ea740809231210i105fb58en93c779baca3f06a4@mail.gmail.com>

My current apache 2.2.8/mod_python 3.3.1 configuration is working very
nicely. Sadly, however, the log rotate mechanism of apache v2.2.8 is broken
-- after a rotate, the instance continues to log entries into access_log.1
instead of (the new) access_log. This apache bug is apparently fixed in
v2.2.9.

If I can do so without breaking things, I'd like to upgrade the apache
server to v 2.2.9 -- but it isn't worth doing if it's going to send me into
configuration hell for three days.

Does anybody know if apache v2.2.9 works with mod_python 3.3.1? The server
is running an old (fedora core3/core4) linux.

Thx,
Tom
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080923/77bd27a8/attachment.html
From graham.dumpleton at gmail.com  Tue Sep 23 18:51:11 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Tue Sep 23 18:51:13 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <60900.69.111.193.161.1222196833.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809230105l268e5aefh391107b552cb50fd@mail.gmail.com>
	<60900.69.111.193.161.1222196833.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809231551t59d7dc94wee5047806598925b@mail.gmail.com>

2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
> well, there are a couple reasons why i didn't try that straight
> away.  i'm not really the best at sysadmin type stuff.  if something
> were to go wrong this is our one and only live server at the moment
> so i avoid upgrading packages unless i know it's necessary.  i
> didn't realize before but we're actually using v3.2.8.  it's pretty
> recent, however if you think that the installing the latest version
> is essential towards figuring out the problem i will do it.

That is not pretty recent, it is 2 1/2 years old. There have one minor
and one more significant release since then.

You can see what has changed or been fixed in between version you are
using and latest version at:

  http://www.modpython.org/live/current/doc-html/app-changes-from-3.2.10.html
  http://www.modpython.org/live/current/doc-html/app-changes.html

It may indeed not be necessary to upgrade, but it would have been a good start.

When I get the chance I will look again at your post then and see if I
can work out what you are talking about. Be patient, I may not get to
it straight away.

Graham

> - m@
>
>> And what happens if you stop using an older version of mod_python
>> and use the latest version?
>>
>> In other words, upgrade to mod_python 3.3.1 and then we may be
> able to
>> help. The older versions have various bugs in them and there is no
>> point us trying to debug an issue that may have already been fixed.
>>
>> Graham
>>
>> 2008/9/23 Matt Barnicle <mattb@wageslavery.org>:
>>> i'm having an issue with our site, which seems to be directly
>>> related to using req.sendfile.  on our site, we have secure music
>>> downloads.  the user has to go through a series of steps in order
>>> to
>>> gain access to the music (fyi, we run a legitimate service, not a
>>> pirate or warez site).  just some background info..  basically we
>>> can't offer a direct download link or the security can be
>>> bypassed.
>>> so downloading is done through the handler, which runs the checks,
>>> and if everything looks good, the file is sent to the browser
>>> using
>>> req.sendfile with the local path to the file on disk.
>>>
>>> it works..  but the problem is, requests start backing up whenever
>>> a
>>> download is being sent.  it looks like new requests are being sent
>>> to the apache process that is tied up sending the download file.
>>> i
>>> don't understand why this is happening though.  i would think that
>>> while it's sending the file, no new requests would be queued in
>>> that
>>> process.  i can verify this easily by downloading a file, and
>>> while
>>> it's downloading, clicking on a link on the site from the same
>>> window in which i downloaded in.  the request will stay in the
>>> WAIT
>>> state (according to mod_status) until the download is finished,
>>> then
>>> the page will load and the queue will clear up.  now if i change
>>> the
>>> download link to a static file, served directly by apache, this
>>> problem disappears.
>>>
>>> what can i do to fix this?  it's a major issue right now.  many
>>> times a day you can go to the site and it will hang for perhaps 1
>>> to
>>> 3 minutes, then it will load, due to the above described
>>> situation.
>>>
>>> version notes:
>>>
>>> CentOS release 5 (Final)
>>> apache 2.2.3
>>> mod_python 3.2
>>>
>>> using prefork compiled into apache.  misc apache configuration:
>>>
>>> KeepAlive Off
>>>
>>> <IfModule prefork.c>
>>>  StartServers       8
>>>  MinSpareServers    5
>>>  MaxSpareServers   20
>>>  ServerLimit      256
>>>  MaxClients       256
>>>  MaxRequestsPerChild  4000
>>> </IfModule>
>>>
>>> thank you for your time and consideration..
>>>
>>> - m@
>>>
>>> _______________________________________________
>>> Mod_python mailing list
>>> Mod_python@modpython.org
>>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>>
>>
>
>
>
From graham.dumpleton at gmail.com  Tue Sep 23 18:54:54 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Tue Sep 23 18:54:59 2008
Subject: [mod_python] Apache 2.2.9 + ModPython 3.3.1?
In-Reply-To: <ad96ea740809231210i105fb58en93c779baca3f06a4@mail.gmail.com>
References: <ad96ea740809231210i105fb58en93c779baca3f06a4@mail.gmail.com>
Message-ID: <88e286470809231554g4058ef0cgf01a37b87bfd5970@mail.gmail.com>

Apache people do not break APIs between minor patch revision nor
change how existing configuration works. As such, you shouldn't even
need to recompile mod_python, provided that same Apache MPM is used
when you upgrade to 2.2.9. You also shouldn't even need to change the
Apache configuration files.

Graham

2008/9/24 Tom Stambaugh <brooklinetom@gmail.com>:
> My current apache 2.2.8/mod_python 3.3.1 configuration is working very
> nicely. Sadly, however, the log rotate mechanism of apache v2.2.8 is broken
> -- after a rotate, the instance continues to log entries into access_log.1
> instead of (the new) access_log. This apache bug is apparently fixed in
> v2.2.9.
>
> If I can do so without breaking things, I'd like to upgrade the apache
> server to v 2.2.9 -- but it isn't worth doing if it's going to send me into
> configuration hell for three days.
>
> Does anybody know if apache v2.2.9 works with mod_python 3.3.1? The server
> is running an old (fedora core3/core4) linux.
>
> Thx,
> Tom
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
>
From mattb at wageslavery.org  Tue Sep 23 19:22:46 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Tue Sep 23 18:57:52 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809231551t59d7dc94wee5047806598925b@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809230105l268e5aefh391107b552cb50fd@mail.gmail.com>
	<60900.69.111.193.161.1222196833.squirrel@webmail.wageslavery.org>
	<88e286470809231551t59d7dc94wee5047806598925b@mail.gmail.com>
Message-ID: <49236.75.57.243.239.1222212166.squirrel@webmail.wageslavery.org>

> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>> well, there are a couple reasons why i didn't try that straight
>> away.  i'm not really the best at sysadmin type stuff.  if something
>> were to go wrong this is our one and only live server at the moment
>> so i avoid upgrading packages unless i know it's necessary.  i
>> didn't realize before but we're actually using v3.2.8.  it's pretty
>> recent, however if you think that the installing the latest version
>> is essential towards figuring out the problem i will do it.
>
> That is not pretty recent, it is 2 1/2 years old. There have one
minor
> and one more significant release since then.

ok, noted...

> You can see what has changed or been fixed in between version you are
> using and latest version at:
>
>   http://www.modpython.org/live/current/doc-html/app-changes-from-3.2.10.html
>   http://www.modpython.org/live/current/doc-html/app-changes.html
>
> It may indeed not be necessary to upgrade, but it would have been a
> good start.

the other reason i didn't mention is more of a package management
reason.  we're using centos and the latest version available by yum
is the one that's installed now..  but i am now looking into it and
will attempt the manual download / install.

> When I get the chance I will look again at your post then and see
if I
> can work out what you are talking about. Be patient, I may not get
> to it straight away.
>
> Graham

ok, sure.  i assume that sort of thing anyway   :-)

thanks,

>> - m@
>>
>>> And what happens if you stop using an older version of mod_python
>>> and use the latest version?
>>>
>>> In other words, upgrade to mod_python 3.3.1 and then we may be
able to
>>> help. The older versions have various bugs in them and there is no
>>> point us trying to debug an issue that may have already been
>>> fixed.
>>>
>>> Graham
>>>
>>> 2008/9/23 Matt Barnicle <mattb@wageslavery.org>:
>>>> i'm having an issue with our site, which seems to be directly
>>>> related to using req.sendfile.  on our site, we have secure
>>>> music
>>>> downloads.  the user has to go through a series of steps in
>>>> order
>>>> to
>>>> gain access to the music (fyi, we run a legitimate service, not
>>>> a
>>>> pirate or warez site).  just some background info..  basically
>>>> we
>>>> can't offer a direct download link or the security can be
>>>> bypassed.
>>>> so downloading is done through the handler, which runs the
>>>> checks,
>>>> and if everything looks good, the file is sent to the browser
>>>> using
>>>> req.sendfile with the local path to the file on disk.
>>>>
>>>> it works..  but the problem is, requests start backing up
>>>> whenever
>>>> a
>>>> download is being sent.  it looks like new requests are being
>>>> sent
>>>> to the apache process that is tied up sending the download file.
>>>> i
>>>> don't understand why this is happening though.  i would think
>>>> that
>>>> while it's sending the file, no new requests would be queued in
>>>> that
>>>> process.  i can verify this easily by downloading a file, and
>>>> while
>>>> it's downloading, clicking on a link on the site from the same
>>>> window in which i downloaded in.  the request will stay in the
>>>> WAIT
>>>> state (according to mod_status) until the download is finished,
>>>> then
>>>> the page will load and the queue will clear up.  now if i change
>>>> the
>>>> download link to a static file, served directly by apache, this
>>>> problem disappears.
>>>>
>>>> what can i do to fix this?  it's a major issue right now.  many
>>>> times a day you can go to the site and it will hang for perhaps
>>>> 1
>>>> to
>>>> 3 minutes, then it will load, due to the above described
>>>> situation.
>>>>
>>>> version notes:
>>>>
>>>> CentOS release 5 (Final)
>>>> apache 2.2.3
>>>> mod_python 3.2
>>>>
>>>> using prefork compiled into apache.  misc apache configuration:
>>>>
>>>> KeepAlive Off
>>>>
>>>> <IfModule prefork.c>
>>>>  StartServers       8
>>>>  MinSpareServers    5
>>>>  MaxSpareServers   20
>>>>  ServerLimit      256
>>>>  MaxClients       256
>>>>  MaxRequestsPerChild  4000
>>>> </IfModule>
>>>>
>>>> thank you for your time and consideration..
>>>>
>>>> - m@
>>>>
>>>> _______________________________________________
>>>> Mod_python mailing list
>>>> Mod_python@modpython.org
>>>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>>>
>>>
>>
>>
>>
>


From brooklinetom at gmail.com  Tue Sep 23 19:12:18 2008
From: brooklinetom at gmail.com (Tom Stambaugh)
Date: Tue Sep 23 19:12:24 2008
Subject: [mod_python] Apache 2.2.9 + ModPython 3.3.1?
Message-ID: <ad96ea740809231612v1007b14fk1764037452b95a04@mail.gmail.com>

That's good news, I'm always nervous when I touch *anything* on the server.
If somebody can confirm that this is, in fact, the case, then I'll feel even
better. I any case, think I'll wait until I'm sure I can undo any changes I
try before I do anything.

Thanks for the quick & helpful reply!

Thx,
Tom

> Apache people do not break APIs between minor patch revision nor
> change how existing configuration works. As such, you shouldn't even
> need to recompile mod_python, provided that same Apache MPM is used
> when you upgrade to 2.2.9. You also shouldn't even need to change the
> Apache configuration files.
>
> Graham
>
> 2008/9/24 Tom Stambaugh <brooklinetom@gmail.com>:
>> My current apache 2.2.8/mod_python 3.3.1 configuration is working very
>> nicely. Sadly, however, the log rotate mechanism of apache v2.2.8 is
broken
>> -- after a rotate, the instance continues to log entries into
access_log.1
>> instead of (the new) access_log. This apache bug is apparently fixed in
>> v2.2.9.
>>
>> If I can do so without breaking things, I'd like to upgrade the apache
>> server to v 2.2.9 -- but it isn't worth doing if it's going to send me
into
>> configuration hell for three days.
>>
>> Does anybody know if apache v2.2.9 works with mod_python 3.3.1? The
server
>> is running an old (fedora core3/core4) linux.
>>
>> Thx,
>> Tom
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080923/4f7cce33/attachment-0001.html
From clodoaldo.pinto.neto at gmail.com  Tue Sep 23 19:14:13 2008
From: clodoaldo.pinto.neto at gmail.com (Clodoaldo Pinto Neto)
Date: Tue Sep 23 19:14:16 2008
Subject: [mod_python] Apache 2.2.9 + ModPython 3.3.1?
In-Reply-To: <ad96ea740809231210i105fb58en93c779baca3f06a4@mail.gmail.com>
References: <ad96ea740809231210i105fb58en93c779baca3f06a4@mail.gmail.com>
Message-ID: <a595de7a0809231614u716f3cf8h386f5aa5964526fc@mail.gmail.com>

2008/9/23 Tom Stambaugh <brooklinetom@gmail.com>:
> My current apache 2.2.8/mod_python 3.3.1 configuration is working very
> nicely. Sadly, however, the log rotate mechanism of apache v2.2.8 is broken
> -- after a rotate, the instance continues to log entries into access_log.1
> instead of (the new) access_log. This apache bug is apparently fixed in
> v2.2.9.

Are you sure it is an apache bug? Did you check your
/etc/logrotate.d/httpd file? It should have something like this:

/var/log/httpd/*log {
    missingok
    notifempty
    sharedscripts
    postrotate
        /bin/kill -HUP `cat /var/run/httpd.pid 2>/dev/null` 2> /dev/null || true
    endscript
}

I guess your script is not killing apache.

Regards, Clodoaldo

> If I can do so without breaking things, I'd like to upgrade the apache
> server to v 2.2.9 -- but it isn't worth doing if it's going to send me into
> configuration hell for three days.
>
> Does anybody know if apache v2.2.9 works with mod_python 3.3.1? The server
> is running an old (fedora core3/core4) linux.
>
> Thx,
> Tom
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
>
From brooklinetom at gmail.com  Tue Sep 23 19:46:42 2008
From: brooklinetom at gmail.com (Tom Stambaugh)
Date: Tue Sep 23 19:46:44 2008
Subject: [mod_python] Apache 2.2.9 + ModPython 3.3.1?
Message-ID: <ad96ea740809231646n55d63ceftd0ab5b30433649c9@mail.gmail.com>

Yes, it is bug# 44433 in the apache bugzilla. Sadly, it appears that it may
not have been fixed in 2.2.9 after all.

See:
http://issues.apache.org/bugzilla/show_bug.cgi?id=44433
http://bugs.gentoo.org/show_bug.cgi?id=110556

In any case, this is NOT a mod_python issue, let's drop it....

Thx,
Tom

2008/9/23 Tom Stambaugh <brooklinetom@gmail.com>:
> My current apache 2.2.8/mod_python 3.3.1 configuration is working very
> nicely. Sadly, however, the log rotate mechanism of apache v2.2.8 is
broken
> -- after a rotate, the instance continues to log entries into access_log.1
> instead of (the new) access_log. This apache bug is apparently fixed in
> v2.2.9.

Are you sure it is an apache bug? Did you check your
/etc/logrotate.d/httpd file? It should have something like this:

/var/log/httpd/*log {
    missingok
    notifempty
    sharedscripts
    postrotate
        /bin/kill -HUP `cat /var/run/httpd.pid 2>/dev/null` 2> /dev/null ||
true
    endscript
}

I guess your script is not killing apache.

Regards, Clodoaldo

> If I can do so without breaking things, I'd like to upgrade the apache
> server to v 2.2.9 -- but it isn't worth doing if it's going to send me
into
> configuration hell for three days.
>
> Does anybody know if apache v2.2.9 works with mod_python 3.3.1? The server
> is running an old (fedora core3/core4) linux.
>
> Thx,
> Tom
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080923/0b05bc31/attachment.html
From mattb at wageslavery.org  Tue Sep 23 21:35:05 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Tue Sep 23 21:10:12 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809231551t59d7dc94wee5047806598925b@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809230105l268e5aefh391107b552cb50fd@mail.gmail.com>
	<60900.69.111.193.161.1222196833.squirrel@webmail.wageslavery.org>
	<88e286470809231551t59d7dc94wee5047806598925b@mail.gmail.com>
Message-ID: <51516.76.195.10.42.1222220105.squirrel@webmail.wageslavery.org>

fyi, i have now installed mod_python 3.3.1 from source, restarted
apache and verified installation, and the same problem is happening.

# python
>>> import mod_python
>>> mod_python.version
'3.3.1'

- m@

> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>> well, there are a couple reasons why i didn't try that straight
>> away.  i'm not really the best at sysadmin type stuff.  if
>> something
>> were to go wrong this is our one and only live server at the
>> moment
>> so i avoid upgrading packages unless i know it's necessary.  i
>> didn't realize before but we're actually using v3.2.8.  it's
>> pretty
>> recent, however if you think that the installing the latest
>> version
>> is essential towards figuring out the problem i will do it.
>
> That is not pretty recent, it is 2 1/2 years old. There have one
> minor
> and one more significant release since then.
>
> You can see what has changed or been fixed in between version you
> are
> using and latest version at:
>
>   http://www.modpython.org/live/current/doc-html/app-changes-from-3.2.10.html
>   http://www.modpython.org/live/current/doc-html/app-changes.html
>
> It may indeed not be necessary to upgrade, but it would have been a
> good start.
>
> When I get the chance I will look again at your post then and see if
> I
> can work out what you are talking about. Be patient, I may not get
> to
> it straight away.
>
> Graham
>
>> - m@
>>
>>> And what happens if you stop using an older version of mod_python
>>> and use the latest version?
>>>
>>> In other words, upgrade to mod_python 3.3.1 and then we may be
>> able to
>>> help. The older versions have various bugs in them and there is
>>> no
>>> point us trying to debug an issue that may have already been
>>> fixed.
>>>
>>> Graham
>>>
>>> 2008/9/23 Matt Barnicle <mattb@wageslavery.org>:
>>>> i'm having an issue with our site, which seems to be directly
>>>> related to using req.sendfile.  on our site, we have secure
>>>> music
>>>> downloads.  the user has to go through a series of steps in
>>>> order
>>>> to
>>>> gain access to the music (fyi, we run a legitimate service, not
>>>> a
>>>> pirate or warez site).  just some background info..  basically
>>>> we
>>>> can't offer a direct download link or the security can be
>>>> bypassed.
>>>> so downloading is done through the handler, which runs the
>>>> checks,
>>>> and if everything looks good, the file is sent to the browser
>>>> using
>>>> req.sendfile with the local path to the file on disk.
>>>>
>>>> it works..  but the problem is, requests start backing up
>>>> whenever
>>>> a
>>>> download is being sent.  it looks like new requests are being
>>>> sent
>>>> to the apache process that is tied up sending the download file.
>>>> i
>>>> don't understand why this is happening though.  i would think
>>>> that
>>>> while it's sending the file, no new requests would be queued in
>>>> that
>>>> process.  i can verify this easily by downloading a file, and
>>>> while
>>>> it's downloading, clicking on a link on the site from the same
>>>> window in which i downloaded in.  the request will stay in the
>>>> WAIT
>>>> state (according to mod_status) until the download is finished,
>>>> then
>>>> the page will load and the queue will clear up.  now if i change
>>>> the
>>>> download link to a static file, served directly by apache, this
>>>> problem disappears.
>>>>
>>>> what can i do to fix this?  it's a major issue right now.  many
>>>> times a day you can go to the site and it will hang for perhaps
>>>> 1
>>>> to
>>>> 3 minutes, then it will load, due to the above described
>>>> situation.
>>>>
>>>> version notes:
>>>>
>>>> CentOS release 5 (Final)
>>>> apache 2.2.3
>>>> mod_python 3.2
>>>>
>>>> using prefork compiled into apache.  misc apache configuration:
>>>>
>>>> KeepAlive Off
>>>>
>>>> <IfModule prefork.c>
>>>>  StartServers       8
>>>>  MinSpareServers    5
>>>>  MaxSpareServers   20
>>>>  ServerLimit      256
>>>>  MaxClients       256
>>>>  MaxRequestsPerChild  4000
>>>> </IfModule>
>>>>
>>>> thank you for your time and consideration..
>>>>
>>>> - m@
>>>>
>>>> _______________________________________________
>>>> Mod_python mailing list
>>>> Mod_python@modpython.org
>>>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>>>
>>>
>>
>>
>>
>


From graham.dumpleton at gmail.com  Tue Sep 23 21:19:15 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Tue Sep 23 21:19:17 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>

2008/9/23 Matt Barnicle <mattb@wageslavery.org>:
> i'm having an issue with our site, which seems to be directly
> related to using req.sendfile.  on our site, we have secure music
> downloads.  the user has to go through a series of steps in order to
> gain access to the music (fyi, we run a legitimate service, not a
> pirate or warez site).  just some background info..  basically we
> can't offer a direct download link or the security can be bypassed.
> so downloading is done through the handler, which runs the checks,
> and if everything looks good, the file is sent to the browser using
> req.sendfile with the local path to the file on disk.
>
> it works..  but the problem is, requests start backing up whenever a
> download is being sent.  it looks like new requests are being sent
> to the apache process that is tied up sending the download file.  i
> don't understand why this is happening though.  i would think that
> while it's sending the file, no new requests would be queued in that
> process.  i can verify this easily by downloading a file, and while
> it's downloading, clicking on a link on the site from the same
> window in which i downloaded in.  the request will stay in the WAIT
> state (according to mod_status) until the download is finished, then
> the page will load and the queue will clear up.  now if i change the
> download link to a static file, served directly by apache, this
> problem disappears.
>
> what can i do to fix this?  it's a major issue right now.  many
> times a day you can go to the site and it will hang for perhaps 1 to
> 3 minutes, then it will load, due to the above described situation.
>
> version notes:
>
> CentOS release 5 (Final)
> apache 2.2.3
> mod_python 3.2
>
> using prefork compiled into apache.  misc apache configuration:
>
> KeepAlive Off
>
> <IfModule prefork.c>
>  StartServers       8
>  MinSpareServers    5
>  MaxSpareServers   20
>  ServerLimit      256
>  MaxClients       256
>  MaxRequestsPerChild  4000
> </IfModule>
>
> thank you for your time and consideration..

Are you setting a content length on the response before calling req.sendfile()?

How many concurrent requests for these files are you receiving and how
long does it take to download a file?

Graham

Graham
From mattb at wageslavery.org  Tue Sep 23 22:07:04 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Tue Sep 23 21:42:11 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
Message-ID: <52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>

> 2008/9/23 Matt Barnicle <mattb@wageslavery.org>:
>> i'm having an issue with our site, which seems to be directly
>> related to using req.sendfile.  on our site, we have secure music
>> downloads.  the user has to go through a series of steps in order
>> to
>> gain access to the music (fyi, we run a legitimate service, not a
>> pirate or warez site).  just some background info..  basically we
>> can't offer a direct download link or the security can be
>> bypassed.
>> so downloading is done through the handler, which runs the checks,
>> and if everything looks good, the file is sent to the browser
>> using
>> req.sendfile with the local path to the file on disk.
>>
>> it works..  but the problem is, requests start backing up whenever
>> a
>> download is being sent.  it looks like new requests are being sent
>> to the apache process that is tied up sending the download file.
>> i
>> don't understand why this is happening though.  i would think that
>> while it's sending the file, no new requests would be queued in
>> that
>> process.  i can verify this easily by downloading a file, and
>> while
>> it's downloading, clicking on a link on the site from the same
>> window in which i downloaded in.  the request will stay in the
>> WAIT
>> state (according to mod_status) until the download is finished,
>> then
>> the page will load and the queue will clear up.  now if i change
>> the
>> download link to a static file, served directly by apache, this
>> problem disappears.
>>
>> what can i do to fix this?  it's a major issue right now.  many
>> times a day you can go to the site and it will hang for perhaps 1
>> to
>> 3 minutes, then it will load, due to the above described
>> situation.
>>
>> version notes:
>>
>> CentOS release 5 (Final)
>> apache 2.2.3
>> mod_python 3.2
>>
>> using prefork compiled into apache.  misc apache configuration:
>>
>> KeepAlive Off
>>
>> <IfModule prefork.c>
>>  StartServers       8
>>  MinSpareServers    5
>>  MaxSpareServers   20
>>  ServerLimit      256
>>  MaxClients       256
>>  MaxRequestsPerChild  4000
>> </IfModule>
>>
>> thank you for your time and consideration..
>
> Are you setting a content length on the response before calling
> req.sendfile()?
>
> How many concurrent requests for these files are you receiving and
> how
> long does it take to download a file?
>
> Graham

yes, i believe so..  now that you mention it, i haven't verified the
file size from the code below, i will do that to be sure.  here is
the code:

file_path = self.conf.run.app_folder + 'public' + download.path
file_stat = os.stat(file_path)
file_size = str(file_stat.st_size)

self.req.headers_out['Content-Length'] = file_size
self.req.headers_out['Content-Disposition'] = 'attachment;
filename=%s' % os.path.basename(file_path)

bytes_sent = self.req.sendfile(file_path)

- m@

From graham.dumpleton at gmail.com  Tue Sep 23 21:55:58 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Tue Sep 23 21:56:03 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>

2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>> Are you setting a content length on the response before calling
>> req.sendfile()?
>>
>> How many concurrent requests for these files are you receiving and
>> how
>> long does it take to download a file?
>>
>> Graham
>
> yes, i believe so..  now that you mention it, i haven't verified the
> file size from the code below, i will do that to be sure.  here is
> the code:
>
> file_path = self.conf.run.app_folder + 'public' + download.path
> file_stat = os.stat(file_path)
> file_size = str(file_stat.st_size)
>
> self.req.headers_out['Content-Length'] = file_size
> self.req.headers_out['Content-Disposition'] = 'attachment;
> filename=%s' % os.path.basename(file_path)
>
> bytes_sent = self.req.sendfile(file_path)

BTW, now that you are using mod_python 3.3.1, instead of using
req.sendfile(), you could possibly delegate serving of the static file
back to Apache. From memory this can be done using:

  req.filename = self.conf.run.app_folder + 'public' + download.path
  req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
  return apache.DECLINED

By returning apache.DECLINED you say mod_python handler will not
actually handle it, and by having updated req.filename and
req.fileinfo updated to new file, when it falls through to
default-handler it should serve it as static file.

Doing it this way should bypass prior Apache access control checks.
Thus file doesn't need to be in Apache document tree or anywhere else
that is accessible.

I believe doing it this way also has benefit that Apache will
automatically set various headers that you probably wouldn't be.

Please let us know if this alternate method works.

Graham
From mattb at wageslavery.org  Thu Sep 25 01:12:11 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Thu Sep 25 00:47:12 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
	<88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
Message-ID: <64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>

> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>> Are you setting a content length on the response before calling
>>> req.sendfile()?
>>>
>>> How many concurrent requests for these files are you receiving and
>>> how long does it take to download a file?
>>>
>>> Graham
>>
>> yes, i believe so..  now that you mention it, i haven't verified the
>> file size from the code below, i will do that to be sure.  here is
>> the code:
>>
>> file_path = self.conf.run.app_folder + 'public' + download.path
>> file_stat = os.stat(file_path)
>> file_size = str(file_stat.st_size)
>>
>> self.req.headers_out['Content-Length'] = file_size
>> self.req.headers_out['Content-Disposition'] = 'attachment;
>> filename=%s' % os.path.basename(file_path)
>>
>> bytes_sent = self.req.sendfile(file_path)
>
> BTW, now that you are using mod_python 3.3.1, instead of using
> req.sendfile(), you could possibly delegate serving of the static
file
> back to Apache. From memory this can be done using:
>
>   req.filename = self.conf.run.app_folder + 'public' + download.path
>   req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>   return apache.DECLINED
>
> By returning apache.DECLINED you say mod_python handler will not
> actually handle it, and by having updated req.filename and
> req.fileinfo updated to new file, when it falls through to
> default-handler it should serve it as static file.
>
> Doing it this way should bypass prior Apache access control checks.
> Thus file doesn't need to be in Apache document tree or anywhere else
> that is accessible.
>
> I believe doing it this way also has benefit that Apache will
> automatically set various headers that you probably wouldn't be.
>
> Please let us know if this alternate method works.
>
> Graham

i'm trying to get this working, but running into a snag..  i'm
actually running a custom written MVC framework to serve the site
pages.  the way it was written was to have mod_python be the handler
for all requests, and a rewrite rule is written to route all
requests through index.psp which sits in the document root.  i tried
adding this code to the index.psp but found quickly that it wouldn't
work.  so it seemed to me that the correct way to do it was to
change the way pages are served, and run everything through a proper
request handler, which could return the apache status as described
above.  had to restructure some of the code, but i did eventually
*sort of* get it working.

first, i can't seem to figure out how to get all requests, no matter
what the URI, to be processed through the handler (which for all
intents and purposes let's call the base controller).  i tried the
following but it doesn't seem to do what i want:

DocumentRoot /var/www/my/application/public
<Directory /var/www/my/application/public>
 AddHandler python-program .py
 PythonHandler myhandler
</Directory>

with the above configuration, when i go to the home page, i see a
directory listing instead of the handler being executed..

the previous way this was working was to put a rewrite rule in
.htaccess that routes all requests through index.psp.  so i tried
changing that to route everything through myhandler.py, and that
does sort of work, but then i can't seem to read the uri that's in
the location bar.  when i read req.uri, it's just /myhandler.py. 
the way we were doing that before was with the following code, which
no longer works now that i'm serving out of a custom handler, it
throws an error:

req.add_common_vars()
env_vars = req.subprocess_env
uri = env_vars['REDIRECT_URL'].strip('/')

i'm so close to getting this working!

thanks for your help,

- m@

From graham.dumpleton at gmail.com  Thu Sep 25 01:16:38 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Thu Sep 25 01:16:42 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
	<88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>

2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>> Are you setting a content length on the response before calling
>>>> req.sendfile()?
>>>>
>>>> How many concurrent requests for these files are you receiving and
>>>> how long does it take to download a file?
>>>>
>>>> Graham
>>>
>>> yes, i believe so..  now that you mention it, i haven't verified the
>>> file size from the code below, i will do that to be sure.  here is
>>> the code:
>>>
>>> file_path = self.conf.run.app_folder + 'public' + download.path
>>> file_stat = os.stat(file_path)
>>> file_size = str(file_stat.st_size)
>>>
>>> self.req.headers_out['Content-Length'] = file_size
>>> self.req.headers_out['Content-Disposition'] = 'attachment;
>>> filename=%s' % os.path.basename(file_path)
>>>
>>> bytes_sent = self.req.sendfile(file_path)
>>
>> BTW, now that you are using mod_python 3.3.1, instead of using
>> req.sendfile(), you could possibly delegate serving of the static
> file
>> back to Apache. From memory this can be done using:
>>
>>   req.filename = self.conf.run.app_folder + 'public' + download.path
>>   req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>   return apache.DECLINED
>>
>> By returning apache.DECLINED you say mod_python handler will not
>> actually handle it, and by having updated req.filename and
>> req.fileinfo updated to new file, when it falls through to
>> default-handler it should serve it as static file.
>>
>> Doing it this way should bypass prior Apache access control checks.
>> Thus file doesn't need to be in Apache document tree or anywhere else
>> that is accessible.
>>
>> I believe doing it this way also has benefit that Apache will
>> automatically set various headers that you probably wouldn't be.
>>
>> Please let us know if this alternate method works.
>>
>> Graham
>
> i'm trying to get this working, but running into a snag..  i'm
> actually running a custom written MVC framework to serve the site
> pages.  the way it was written was to have mod_python be the handler
> for all requests, and a rewrite rule is written to route all
> requests through index.psp which sits in the document root.  i tried
> adding this code to the index.psp but found quickly that it wouldn't
> work.  so it seemed to me that the correct way to do it was to
> change the way pages are served, and run everything through a proper
> request handler, which could return the apache status as described
> above.  had to restructure some of the code, but i did eventually
> *sort of* get it working.
>
> first, i can't seem to figure out how to get all requests, no matter
> what the URI, to be processed through the handler (which for all
> intents and purposes let's call the base controller).  i tried the
> following but it doesn't seem to do what i want:
>
> DocumentRoot /var/www/my/application/public
> <Directory /var/www/my/application/public>
>  AddHandler python-program .py
>  PythonHandler myhandler
> </Directory>

Use SetHandler instead of AddHandler.

  DocumentRoot /var/www/my/application/public
  <Directory /var/www/my/application/public>
   SetHandler python-program
   PythonHandler myhandler
  </Directory>

Graham

> with the above configuration, when i go to the home page, i see a
> directory listing instead of the handler being executed..
>
> the previous way this was working was to put a rewrite rule in
> .htaccess that routes all requests through index.psp.  so i tried
> changing that to route everything through myhandler.py, and that
> does sort of work, but then i can't seem to read the uri that's in
> the location bar.  when i read req.uri, it's just /myhandler.py.
> the way we were doing that before was with the following code, which
> no longer works now that i'm serving out of a custom handler, it
> throws an error:
>
> req.add_common_vars()
> env_vars = req.subprocess_env
> uri = env_vars['REDIRECT_URL'].strip('/')
>
> i'm so close to getting this working!
>
> thanks for your help,
>
> - m@
>
>
From mattb at wageslavery.org  Fri Sep 26 01:42:40 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Fri Sep 26 01:17:35 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
	<88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
	<88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
Message-ID: <56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>

> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>> Are you setting a content length on the response before calling
>>>>> req.sendfile()?
>>>>>
>>>>> How many concurrent requests for these files are you receiving
and
>>>>> how long does it take to download a file?
>>>>>
>>>>> Graham
>>>>
>>>> yes, i believe so..  now that you mention it, i haven't verified
>>>> the file size from the code below, i will do that to be sure. 
here
>>>> is the code:
>>>>
>>>> file_path = self.conf.run.app_folder + 'public' + download.path
>>>> file_stat = os.stat(file_path)
>>>> file_size = str(file_stat.st_size)
>>>>
>>>> self.req.headers_out['Content-Length'] = file_size
>>>> self.req.headers_out['Content-Disposition'] = 'attachment;
>>>> filename=%s' % os.path.basename(file_path)
>>>>
>>>> bytes_sent = self.req.sendfile(file_path)
>>>
>>> BTW, now that you are using mod_python 3.3.1, instead of using
>>> req.sendfile(), you could possibly delegate serving of the
static file
>>> back to Apache. From memory this can be done using:
>>>
>>>   req.filename = self.conf.run.app_folder + 'public' +
>>> download.path
>>>   req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>>   return apache.DECLINED
>>>
>>> By returning apache.DECLINED you say mod_python handler will not
>>> actually handle it, and by having updated req.filename and
>>> req.fileinfo updated to new file, when it falls through to
>>> default-handler it should serve it as static file.
>>>
>>> Doing it this way should bypass prior Apache access control checks.
>>> Thus file doesn't need to be in Apache document tree or anywhere
else
>>> that is accessible.
>>>
>>> I believe doing it this way also has benefit that Apache will
>>> automatically set various headers that you probably wouldn't be.
>>>
>>> Please let us know if this alternate method works.
>>>
>>> Graham
>> i tried the following but it doesn't seem to do what i want:
>>
>> DocumentRoot /var/www/my/application/public
>> <Directory /var/www/my/application/public>
>>  AddHandler python-program .py
>>  PythonHandler myhandler
>> </Directory>
>
> Use SetHandler instead of AddHandler.
>
>   DocumentRoot /var/www/my/application/public
>   <Directory /var/www/my/application/public>
>    SetHandler python-program
>    PythonHandler myhandler
>   </Directory>
>
> Graham

ok, getting closer..  now i get a 404 error in the browser saying
'The requested URL /download/file/3 was not found on this server.'
and in the apache logs:

File does not exist:
/var/www/application/public/downloads/music/music.zip/file/3

so it looks like it's taking the last part of the URI and appending
it to the physical filename and looking for that...  the request URI
is 'http://example.com/download/file/3'.  the 'download' controller
is what manages the music downloads.

- m@

From graham.dumpleton at gmail.com  Fri Sep 26 01:30:09 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Fri Sep 26 01:30:14 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
	<88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
	<88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>

Try adding:

  req.path_info = ''

Graham

2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>>> Are you setting a content length on the response before calling
>>>>>> req.sendfile()?
>>>>>>
>>>>>> How many concurrent requests for these files are you receiving
> and
>>>>>> how long does it take to download a file?
>>>>>>
>>>>>> Graham
>>>>>
>>>>> yes, i believe so..  now that you mention it, i haven't verified
>>>>> the file size from the code below, i will do that to be sure.
> here
>>>>> is the code:
>>>>>
>>>>> file_path = self.conf.run.app_folder + 'public' + download.path
>>>>> file_stat = os.stat(file_path)
>>>>> file_size = str(file_stat.st_size)
>>>>>
>>>>> self.req.headers_out['Content-Length'] = file_size
>>>>> self.req.headers_out['Content-Disposition'] = 'attachment;
>>>>> filename=%s' % os.path.basename(file_path)
>>>>>
>>>>> bytes_sent = self.req.sendfile(file_path)
>>>>
>>>> BTW, now that you are using mod_python 3.3.1, instead of using
>>>> req.sendfile(), you could possibly delegate serving of the
> static file
>>>> back to Apache. From memory this can be done using:
>>>>
>>>>   req.filename = self.conf.run.app_folder + 'public' +
>>>> download.path
>>>>   req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>>>   return apache.DECLINED
>>>>
>>>> By returning apache.DECLINED you say mod_python handler will not
>>>> actually handle it, and by having updated req.filename and
>>>> req.fileinfo updated to new file, when it falls through to
>>>> default-handler it should serve it as static file.
>>>>
>>>> Doing it this way should bypass prior Apache access control checks.
>>>> Thus file doesn't need to be in Apache document tree or anywhere
> else
>>>> that is accessible.
>>>>
>>>> I believe doing it this way also has benefit that Apache will
>>>> automatically set various headers that you probably wouldn't be.
>>>>
>>>> Please let us know if this alternate method works.
>>>>
>>>> Graham
>>> i tried the following but it doesn't seem to do what i want:
>>>
>>> DocumentRoot /var/www/my/application/public
>>> <Directory /var/www/my/application/public>
>>>  AddHandler python-program .py
>>>  PythonHandler myhandler
>>> </Directory>
>>
>> Use SetHandler instead of AddHandler.
>>
>>   DocumentRoot /var/www/my/application/public
>>   <Directory /var/www/my/application/public>
>>    SetHandler python-program
>>    PythonHandler myhandler
>>   </Directory>
>>
>> Graham
>
> ok, getting closer..  now i get a 404 error in the browser saying
> 'The requested URL /download/file/3 was not found on this server.'
> and in the apache logs:
>
> File does not exist:
> /var/www/application/public/downloads/music/music.zip/file/3
>
> so it looks like it's taking the last part of the URI and appending
> it to the physical filename and looking for that...  the request URI
> is 'http://example.com/download/file/3'.  the 'download' controller
> is what manages the music downloads.
>
> - m@
>
>
From mattb at wageslavery.org  Fri Sep 26 03:04:19 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Fri Sep 26 02:39:14 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
	<88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
	<88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
	<88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
Message-ID: <57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>

ok, that worked..  but unfortunately the blocking issue is still
happening.  i've verified that the download controller is returning
apache.DECLINED and the file downloads ok.

- m@

> Try adding:
>
>   req.path_info = ''
>
> Graham
>
> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>> Are you setting a content length on the response before
>>>>>>> calling
>>>>>>> req.sendfile()?
>>>>>>>
>>>>>>> How many concurrent requests for these files are you
>>>>>>> receiving
>> and
>>>>>>> how long does it take to download a file?
>>>>>>>
>>>>>>> Graham
>>>>>>
>>>>>> yes, i believe so..  now that you mention it, i haven't
>>>>>> verified
>>>>>> the file size from the code below, i will do that to be sure.
>> here
>>>>>> is the code:
>>>>>>
>>>>>> file_path = self.conf.run.app_folder + 'public' +
>>>>>> download.path
>>>>>> file_stat = os.stat(file_path)
>>>>>> file_size = str(file_stat.st_size)
>>>>>>
>>>>>> self.req.headers_out['Content-Length'] = file_size
>>>>>> self.req.headers_out['Content-Disposition'] = 'attachment;
>>>>>> filename=%s' % os.path.basename(file_path)
>>>>>>
>>>>>> bytes_sent = self.req.sendfile(file_path)
>>>>>
>>>>> BTW, now that you are using mod_python 3.3.1, instead of using
>>>>> req.sendfile(), you could possibly delegate serving of the
>> static file
>>>>> back to Apache. From memory this can be done using:
>>>>>
>>>>>   req.filename = self.conf.run.app_folder + 'public' +
>>>>> download.path
>>>>>   req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>>>>   return apache.DECLINED
>>>>>
>>>>> By returning apache.DECLINED you say mod_python handler will
>>>>> not
>>>>> actually handle it, and by having updated req.filename and
>>>>> req.fileinfo updated to new file, when it falls through to
>>>>> default-handler it should serve it as static file.
>>>>>
>>>>> Doing it this way should bypass prior Apache access control
>>>>> checks.
>>>>> Thus file doesn't need to be in Apache document tree or
>>>>> anywhere
>> else
>>>>> that is accessible.
>>>>>
>>>>> I believe doing it this way also has benefit that Apache will
>>>>> automatically set various headers that you probably wouldn't
>>>>> be.
>>>>>
>>>>> Please let us know if this alternate method works.
>>>>>
>>>>> Graham
>>>> i tried the following but it doesn't seem to do what i want:
>>>>
>>>> DocumentRoot /var/www/my/application/public
>>>> <Directory /var/www/my/application/public>
>>>>  AddHandler python-program .py
>>>>  PythonHandler myhandler
>>>> </Directory>
>>>
>>> Use SetHandler instead of AddHandler.
>>>
>>>   DocumentRoot /var/www/my/application/public
>>>   <Directory /var/www/my/application/public>
>>>    SetHandler python-program
>>>    PythonHandler myhandler
>>>   </Directory>
>>>
>>> Graham
>>
>> ok, getting closer..  now i get a 404 error in the browser saying
>> 'The requested URL /download/file/3 was not found on this server.'
>> and in the apache logs:
>>
>> File does not exist:
>> /var/www/application/public/downloads/music/music.zip/file/3
>>
>> so it looks like it's taking the last part of the URI and
>> appending
>> it to the physical filename and looking for that...  the request
>> URI
>> is 'http://example.com/download/file/3'.  the 'download'
>> controller
>> is what manages the music downloads.
>>
>> - m@
>>
>>
>


From graham.dumpleton at gmail.com  Fri Sep 26 02:43:30 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Fri Sep 26 02:43:35 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
	<88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
	<88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
	<88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
	<57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809252343h658d2f10o36426d93a334d1ea@mail.gmail.com>

One last thing to add then. If this doesn't work, I'll have to just
try it myself. :-)

  req.handler = 'default-handler'

Graham

2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
> ok, that worked..  but unfortunately the blocking issue is still
> happening.  i've verified that the download controller is returning
> apache.DECLINED and the file downloads ok.
>
> - m@
>
>> Try adding:
>>
>>   req.path_info = ''
>>
>> Graham
>>
>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>>>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>> Are you setting a content length on the response before
>>>>>>>> calling
>>>>>>>> req.sendfile()?
>>>>>>>>
>>>>>>>> How many concurrent requests for these files are you
>>>>>>>> receiving
>>> and
>>>>>>>> how long does it take to download a file?
>>>>>>>>
>>>>>>>> Graham
>>>>>>>
>>>>>>> yes, i believe so..  now that you mention it, i haven't
>>>>>>> verified
>>>>>>> the file size from the code below, i will do that to be sure.
>>> here
>>>>>>> is the code:
>>>>>>>
>>>>>>> file_path = self.conf.run.app_folder + 'public' +
>>>>>>> download.path
>>>>>>> file_stat = os.stat(file_path)
>>>>>>> file_size = str(file_stat.st_size)
>>>>>>>
>>>>>>> self.req.headers_out['Content-Length'] = file_size
>>>>>>> self.req.headers_out['Content-Disposition'] = 'attachment;
>>>>>>> filename=%s' % os.path.basename(file_path)
>>>>>>>
>>>>>>> bytes_sent = self.req.sendfile(file_path)
>>>>>>
>>>>>> BTW, now that you are using mod_python 3.3.1, instead of using
>>>>>> req.sendfile(), you could possibly delegate serving of the
>>> static file
>>>>>> back to Apache. From memory this can be done using:
>>>>>>
>>>>>>   req.filename = self.conf.run.app_folder + 'public' +
>>>>>> download.path
>>>>>>   req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>>>>>   return apache.DECLINED
>>>>>>
>>>>>> By returning apache.DECLINED you say mod_python handler will
>>>>>> not
>>>>>> actually handle it, and by having updated req.filename and
>>>>>> req.fileinfo updated to new file, when it falls through to
>>>>>> default-handler it should serve it as static file.
>>>>>>
>>>>>> Doing it this way should bypass prior Apache access control
>>>>>> checks.
>>>>>> Thus file doesn't need to be in Apache document tree or
>>>>>> anywhere
>>> else
>>>>>> that is accessible.
>>>>>>
>>>>>> I believe doing it this way also has benefit that Apache will
>>>>>> automatically set various headers that you probably wouldn't
>>>>>> be.
>>>>>>
>>>>>> Please let us know if this alternate method works.
>>>>>>
>>>>>> Graham
>>>>> i tried the following but it doesn't seem to do what i want:
>>>>>
>>>>> DocumentRoot /var/www/my/application/public
>>>>> <Directory /var/www/my/application/public>
>>>>>  AddHandler python-program .py
>>>>>  PythonHandler myhandler
>>>>> </Directory>
>>>>
>>>> Use SetHandler instead of AddHandler.
>>>>
>>>>   DocumentRoot /var/www/my/application/public
>>>>   <Directory /var/www/my/application/public>
>>>>    SetHandler python-program
>>>>    PythonHandler myhandler
>>>>   </Directory>
>>>>
>>>> Graham
>>>
>>> ok, getting closer..  now i get a 404 error in the browser saying
>>> 'The requested URL /download/file/3 was not found on this server.'
>>> and in the apache logs:
>>>
>>> File does not exist:
>>> /var/www/application/public/downloads/music/music.zip/file/3
>>>
>>> so it looks like it's taking the last part of the URI and
>>> appending
>>> it to the physical filename and looking for that...  the request
>>> URI
>>> is 'http://example.com/download/file/3'.  the 'download'
>>> controller
>>> is what manages the music downloads.
>>>
>>> - m@
>>>
>>>
>>
>
>
>
From mattb at wageslavery.org  Fri Sep 26 03:46:58 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Fri Sep 26 03:21:51 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809252343h658d2f10o36426d93a334d1ea@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<88e286470809231819hdf71a59m210dd696f64d9237@mail.gmail.com>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
	<88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
	<88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
	<88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
	<57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>
	<88e286470809252343h658d2f10o36426d93a334d1ea@mail.gmail.com>
Message-ID: <58334.98.210.193.72.1222415218.squirrel@webmail.wageslavery.org>

nope  :-(

> One last thing to add then. If this doesn't work, I'll have to just
> try it myself. :-)
>
>   req.handler = 'default-handler'
>
> Graham
>
> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>> ok, that worked..  but unfortunately the blocking issue is still
>> happening.  i've verified that the download controller is
>> returning
>> apache.DECLINED and the file downloads ok.
>>
>> - m@
>>
>>> Try adding:
>>>
>>>   req.path_info = ''
>>>
>>> Graham
>>>
>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>> Are you setting a content length on the response before
>>>>>>>>> calling
>>>>>>>>> req.sendfile()?
>>>>>>>>>
>>>>>>>>> How many concurrent requests for these files are you
>>>>>>>>> receiving
>>>> and
>>>>>>>>> how long does it take to download a file?
>>>>>>>>>
>>>>>>>>> Graham
>>>>>>>>
>>>>>>>> yes, i believe so..  now that you mention it, i haven't
>>>>>>>> verified
>>>>>>>> the file size from the code below, i will do that to be
>>>>>>>> sure.
>>>> here
>>>>>>>> is the code:
>>>>>>>>
>>>>>>>> file_path = self.conf.run.app_folder + 'public' +
>>>>>>>> download.path
>>>>>>>> file_stat = os.stat(file_path)
>>>>>>>> file_size = str(file_stat.st_size)
>>>>>>>>
>>>>>>>> self.req.headers_out['Content-Length'] = file_size
>>>>>>>> self.req.headers_out['Content-Disposition'] = 'attachment;
>>>>>>>> filename=%s' % os.path.basename(file_path)
>>>>>>>>
>>>>>>>> bytes_sent = self.req.sendfile(file_path)
>>>>>>>
>>>>>>> BTW, now that you are using mod_python 3.3.1, instead of
>>>>>>> using
>>>>>>> req.sendfile(), you could possibly delegate serving of the
>>>> static file
>>>>>>> back to Apache. From memory this can be done using:
>>>>>>>
>>>>>>>   req.filename = self.conf.run.app_folder + 'public' +
>>>>>>> download.path
>>>>>>>   req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>>>>>>   return apache.DECLINED
>>>>>>>
>>>>>>> By returning apache.DECLINED you say mod_python handler will
>>>>>>> not
>>>>>>> actually handle it, and by having updated req.filename and
>>>>>>> req.fileinfo updated to new file, when it falls through to
>>>>>>> default-handler it should serve it as static file.
>>>>>>>
>>>>>>> Doing it this way should bypass prior Apache access control
>>>>>>> checks.
>>>>>>> Thus file doesn't need to be in Apache document tree or
>>>>>>> anywhere
>>>> else
>>>>>>> that is accessible.
>>>>>>>
>>>>>>> I believe doing it this way also has benefit that Apache will
>>>>>>> automatically set various headers that you probably wouldn't
>>>>>>> be.
>>>>>>>
>>>>>>> Please let us know if this alternate method works.
>>>>>>>
>>>>>>> Graham
>>>>>> i tried the following but it doesn't seem to do what i want:
>>>>>>
>>>>>> DocumentRoot /var/www/my/application/public
>>>>>> <Directory /var/www/my/application/public>
>>>>>>  AddHandler python-program .py
>>>>>>  PythonHandler myhandler
>>>>>> </Directory>
>>>>>
>>>>> Use SetHandler instead of AddHandler.
>>>>>
>>>>>   DocumentRoot /var/www/my/application/public
>>>>>   <Directory /var/www/my/application/public>
>>>>>    SetHandler python-program
>>>>>    PythonHandler myhandler
>>>>>   </Directory>
>>>>>
>>>>> Graham
>>>>
>>>> ok, getting closer..  now i get a 404 error in the browser
>>>> saying
>>>> 'The requested URL /download/file/3 was not found on this
>>>> server.'
>>>> and in the apache logs:
>>>>
>>>> File does not exist:
>>>> /var/www/application/public/downloads/music/music.zip/file/3
>>>>
>>>> so it looks like it's taking the last part of the URI and
>>>> appending
>>>> it to the physical filename and looking for that...  the request
>>>> URI
>>>> is 'http://example.com/download/file/3'.  the 'download'
>>>> controller
>>>> is what manages the music downloads.
>>>>
>>>> - m@
>>>>
>>>>
>>>
>>
>>
>>
>


From graham.dumpleton at gmail.com  Fri Sep 26 05:51:39 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Fri Sep 26 05:51:45 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <58334.98.210.193.72.1222415218.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
	<88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
	<88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
	<88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
	<57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>
	<88e286470809252343h658d2f10o36426d93a334d1ea@mail.gmail.com>
	<58334.98.210.193.72.1222415218.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809260251x4348b7dbr7e001fbba606edcc@mail.gmail.com>

What does your handler actually do? The following works for me no problems.

from mod_python import apache

def handler(req):
    req.filename = '/etc/services'
    req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
    return apache.DECLINED

Does the file exist prior to calling apr.stat()?

Apache even sets the output headers okay:

HTTP/1.1 200 OK
Date: Fri, 26 Sep 2008 09:50:33 GMT
Server: Apache/2.2.8 (Unix) mod_python/3.3.2-dev-20080311 Python/2.5.1
mod_ssl/2.2.8 OpenSSL/0.9.7l DAV/2 mod_wsgi/3.0-TRUNK
Last-Modified: Sun, 23 Sep 2007 21:37:31 GMT
ETag: "535d-a5847-43ad44fac1cc0"
Accept-Ranges: bytes
Content-Length: 677959
Connection: close
Content-Type: text/plain

Ie., ETag and length etc.

Graham

2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
> nope  :-(
>
>> One last thing to add then. If this doesn't work, I'll have to just
>> try it myself. :-)
>>
>>   req.handler = 'default-handler'
>>
>> Graham
>>
>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>> ok, that worked..  but unfortunately the blocking issue is still
>>> happening.  i've verified that the download controller is
>>> returning
>>> apache.DECLINED and the file downloads ok.
>>>
>>> - m@
>>>
>>>> Try adding:
>>>>
>>>>   req.path_info = ''
>>>>
>>>> Graham
>>>>
>>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>>> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>>> Are you setting a content length on the response before
>>>>>>>>>> calling
>>>>>>>>>> req.sendfile()?
>>>>>>>>>>
>>>>>>>>>> How many concurrent requests for these files are you
>>>>>>>>>> receiving
>>>>> and
>>>>>>>>>> how long does it take to download a file?
>>>>>>>>>>
>>>>>>>>>> Graham
>>>>>>>>>
>>>>>>>>> yes, i believe so..  now that you mention it, i haven't
>>>>>>>>> verified
>>>>>>>>> the file size from the code below, i will do that to be
>>>>>>>>> sure.
>>>>> here
>>>>>>>>> is the code:
>>>>>>>>>
>>>>>>>>> file_path = self.conf.run.app_folder + 'public' +
>>>>>>>>> download.path
>>>>>>>>> file_stat = os.stat(file_path)
>>>>>>>>> file_size = str(file_stat.st_size)
>>>>>>>>>
>>>>>>>>> self.req.headers_out['Content-Length'] = file_size
>>>>>>>>> self.req.headers_out['Content-Disposition'] = 'attachment;
>>>>>>>>> filename=%s' % os.path.basename(file_path)
>>>>>>>>>
>>>>>>>>> bytes_sent = self.req.sendfile(file_path)
>>>>>>>>
>>>>>>>> BTW, now that you are using mod_python 3.3.1, instead of
>>>>>>>> using
>>>>>>>> req.sendfile(), you could possibly delegate serving of the
>>>>> static file
>>>>>>>> back to Apache. From memory this can be done using:
>>>>>>>>
>>>>>>>>   req.filename = self.conf.run.app_folder + 'public' +
>>>>>>>> download.path
>>>>>>>>   req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>>>>>>>   return apache.DECLINED
>>>>>>>>
>>>>>>>> By returning apache.DECLINED you say mod_python handler will
>>>>>>>> not
>>>>>>>> actually handle it, and by having updated req.filename and
>>>>>>>> req.fileinfo updated to new file, when it falls through to
>>>>>>>> default-handler it should serve it as static file.
>>>>>>>>
>>>>>>>> Doing it this way should bypass prior Apache access control
>>>>>>>> checks.
>>>>>>>> Thus file doesn't need to be in Apache document tree or
>>>>>>>> anywhere
>>>>> else
>>>>>>>> that is accessible.
>>>>>>>>
>>>>>>>> I believe doing it this way also has benefit that Apache will
>>>>>>>> automatically set various headers that you probably wouldn't
>>>>>>>> be.
>>>>>>>>
>>>>>>>> Please let us know if this alternate method works.
>>>>>>>>
>>>>>>>> Graham
>>>>>>> i tried the following but it doesn't seem to do what i want:
>>>>>>>
>>>>>>> DocumentRoot /var/www/my/application/public
>>>>>>> <Directory /var/www/my/application/public>
>>>>>>>  AddHandler python-program .py
>>>>>>>  PythonHandler myhandler
>>>>>>> </Directory>
>>>>>>
>>>>>> Use SetHandler instead of AddHandler.
>>>>>>
>>>>>>   DocumentRoot /var/www/my/application/public
>>>>>>   <Directory /var/www/my/application/public>
>>>>>>    SetHandler python-program
>>>>>>    PythonHandler myhandler
>>>>>>   </Directory>
>>>>>>
>>>>>> Graham
>>>>>
>>>>> ok, getting closer..  now i get a 404 error in the browser
>>>>> saying
>>>>> 'The requested URL /download/file/3 was not found on this
>>>>> server.'
>>>>> and in the apache logs:
>>>>>
>>>>> File does not exist:
>>>>> /var/www/application/public/downloads/music/music.zip/file/3
>>>>>
>>>>> so it looks like it's taking the last part of the URI and
>>>>> appending
>>>>> it to the physical filename and looking for that...  the request
>>>>> URI
>>>>> is 'http://example.com/download/file/3'.  the 'download'
>>>>> controller
>>>>> is what manages the music downloads.
>>>>>
>>>>> - m@
>>>>>
>>>>>
>>>>
>>>
>>>
>>>
>>
>
>
>
From thkatsou at yahoo.gr  Fri Sep 26 17:23:44 2008
From: thkatsou at yahoo.gr (Thimios Katsoulis)
Date: Fri Sep 26 17:23:49 2008
Subject: [mod_python] MADPY 0.2 beta released - hip hip hooray
Message-ID: <206700.35552.qm@web26404.mail.ukl.yahoo.com>

Hello to all.

I am very pleased to announce the first release of MADPY, a cms built on mod_python , under an open source license (bsd) .
It was just released today so there is not so much info on 
the site. However you can find an installation manual .
Site's address is http://www.madpy.org.
I am working on madpy for nearly 2 years and already have deployed 4 sites on top of it.
Some characteristics in short that may interest you are:

1.It uses Postgresql as DB backend and cheetah as templating engine.
  It also uses psycopg2 , pil , and PyRSS2Gen. 

2. It has an MVC like mechanism named madata (see lib/madata and most of     edit actions in content_types objects like lib/content_types/Page.py etc..)


3. Built for multilingual sites,

4. Aims to be simple to debug and understand.

5. Url to object mapping and clean url's 
 
read more in http://www.madpy.org

Feel free to join in madpy.org , if you have any questions or you are interested and like to contribute in some way.

A forum  will also be set up.
To download first version 0.2.beta pls visit
http://www.madpy.org/en/download

For installation instructions see INSTALL.TXT inside the tarball or visit:
http://www.madpy.org/en/documentation/installation.

Cheers 
Thimios Katsoulis

?? ????
?????? ?????????










      
___________________________________________________________ 
?????????????? Yahoo!; 
?????????? ?? ?????????? ???????? (spam); ?? Yahoo! Mail 
???????? ??? ???????? ?????? ????????? ???? ??? ??????????? 
????????? http://login.yahoo.com/config/mail?.intl=gr 


From mattb at wageslavery.org  Fri Sep 26 21:58:56 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Fri Sep 26 21:33:45 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809260251x4348b7dbr7e001fbba606edcc@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<52303.75.62.111.62.1222222024.squirrel@webmail.wageslavery.org>
	<88e286470809231855pbdbe8c9s3df09cc8290a69ee@mail.gmail.com>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
	<88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
	<88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
	<57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>
	<88e286470809252343h658d2f10o36426d93a334d1ea@mail.gmail.com>
	<58334.98.210.193.72.1222415218.squirrel@webmail.wageslavery.org>
	<88e286470809260251x4348b7dbr7e001fbba606edcc@mail.gmail.com>
Message-ID: <62971.98.210.193.72.1222480736.squirrel@webmail.wageslavery.org>

sorry maybe i wasn't being clear..  i did get your code suggestions
working, so that i've replaced the req.sendfile code with the
apache.DECLINED code.  and it is sending the file ok and i'm
downloading it ok, but it doesn't fix the problem as i originally
posted, that the downloading is causing apache to block me when i
click on links while the download is happening.

- m@

> What does your handler actually do? The following works for me no
> problems.
>
> from mod_python import apache
>
> def handler(req):
>     req.filename = '/etc/services'
>     req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>     return apache.DECLINED
>
> Does the file exist prior to calling apr.stat()?
>
> Apache even sets the output headers okay:
>
> HTTP/1.1 200 OK
> Date: Fri, 26 Sep 2008 09:50:33 GMT
> Server: Apache/2.2.8 (Unix) mod_python/3.3.2-dev-20080311
> Python/2.5.1
> mod_ssl/2.2.8 OpenSSL/0.9.7l DAV/2 mod_wsgi/3.0-TRUNK
> Last-Modified: Sun, 23 Sep 2007 21:37:31 GMT
> ETag: "535d-a5847-43ad44fac1cc0"
> Accept-Ranges: bytes
> Content-Length: 677959
> Connection: close
> Content-Type: text/plain
>
> Ie., ETag and length etc.
>
> Graham
>
> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>> nope  :-(
>>
>>> One last thing to add then. If this doesn't work, I'll have to
>>> just
>>> try it myself. :-)
>>>
>>>   req.handler = 'default-handler'
>>>
>>> Graham
>>>
>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>> ok, that worked..  but unfortunately the blocking issue is still
>>>> happening.  i've verified that the download controller is
>>>> returning
>>>> apache.DECLINED and the file downloads ok.
>>>>
>>>> - m@
>>>>
>>>>> Try adding:
>>>>>
>>>>>   req.path_info = ''
>>>>>
>>>>> Graham
>>>>>
>>>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>>>> Are you setting a content length on the response before
>>>>>>>>>>> calling
>>>>>>>>>>> req.sendfile()?
>>>>>>>>>>>
>>>>>>>>>>> How many concurrent requests for these files are you
>>>>>>>>>>> receiving
>>>>>> and
>>>>>>>>>>> how long does it take to download a file?
>>>>>>>>>>>
>>>>>>>>>>> Graham
>>>>>>>>>>
>>>>>>>>>> yes, i believe so..  now that you mention it, i haven't
>>>>>>>>>> verified
>>>>>>>>>> the file size from the code below, i will do that to be
>>>>>>>>>> sure.
>>>>>> here
>>>>>>>>>> is the code:
>>>>>>>>>>
>>>>>>>>>> file_path = self.conf.run.app_folder + 'public' +
>>>>>>>>>> download.path
>>>>>>>>>> file_stat = os.stat(file_path)
>>>>>>>>>> file_size = str(file_stat.st_size)
>>>>>>>>>>
>>>>>>>>>> self.req.headers_out['Content-Length'] = file_size
>>>>>>>>>> self.req.headers_out['Content-Disposition'] = 'attachment;
>>>>>>>>>> filename=%s' % os.path.basename(file_path)
>>>>>>>>>>
>>>>>>>>>> bytes_sent = self.req.sendfile(file_path)
>>>>>>>>>
>>>>>>>>> BTW, now that you are using mod_python 3.3.1, instead of
>>>>>>>>> using
>>>>>>>>> req.sendfile(), you could possibly delegate serving of the
>>>>>> static file
>>>>>>>>> back to Apache. From memory this can be done using:
>>>>>>>>>
>>>>>>>>>   req.filename = self.conf.run.app_folder + 'public' +
>>>>>>>>> download.path
>>>>>>>>>   req.finfo = apache.stat(req.filename,
>>>>>>>>> apache.APR_FINFO_MIN)
>>>>>>>>>   return apache.DECLINED
>>>>>>>>>
>>>>>>>>> By returning apache.DECLINED you say mod_python handler
>>>>>>>>> will
>>>>>>>>> not
>>>>>>>>> actually handle it, and by having updated req.filename and
>>>>>>>>> req.fileinfo updated to new file, when it falls through to
>>>>>>>>> default-handler it should serve it as static file.
>>>>>>>>>
>>>>>>>>> Doing it this way should bypass prior Apache access control
>>>>>>>>> checks.
>>>>>>>>> Thus file doesn't need to be in Apache document tree or
>>>>>>>>> anywhere
>>>>>> else
>>>>>>>>> that is accessible.
>>>>>>>>>
>>>>>>>>> I believe doing it this way also has benefit that Apache
>>>>>>>>> will
>>>>>>>>> automatically set various headers that you probably
>>>>>>>>> wouldn't
>>>>>>>>> be.
>>>>>>>>>
>>>>>>>>> Please let us know if this alternate method works.
>>>>>>>>>
>>>>>>>>> Graham
>>>>>>>> i tried the following but it doesn't seem to do what i want:
>>>>>>>>
>>>>>>>> DocumentRoot /var/www/my/application/public
>>>>>>>> <Directory /var/www/my/application/public>
>>>>>>>>  AddHandler python-program .py
>>>>>>>>  PythonHandler myhandler
>>>>>>>> </Directory>
>>>>>>>
>>>>>>> Use SetHandler instead of AddHandler.
>>>>>>>
>>>>>>>   DocumentRoot /var/www/my/application/public
>>>>>>>   <Directory /var/www/my/application/public>
>>>>>>>    SetHandler python-program
>>>>>>>    PythonHandler myhandler
>>>>>>>   </Directory>
>>>>>>>
>>>>>>> Graham
>>>>>>
>>>>>> ok, getting closer..  now i get a 404 error in the browser
>>>>>> saying
>>>>>> 'The requested URL /download/file/3 was not found on this
>>>>>> server.'
>>>>>> and in the apache logs:
>>>>>>
>>>>>> File does not exist:
>>>>>> /var/www/application/public/downloads/music/music.zip/file/3
>>>>>>
>>>>>> so it looks like it's taking the last part of the URI and
>>>>>> appending
>>>>>> it to the physical filename and looking for that...  the
>>>>>> request
>>>>>> URI
>>>>>> is 'http://example.com/download/file/3'.  the 'download'
>>>>>> controller
>>>>>> is what manages the music downloads.
>>>>>>
>>>>>> - m@
>>>>>>
>>>>>>
>>>>>
>>>>
>>>>
>>>>
>>>
>>
>>
>>
>


From graham.dumpleton at gmail.com  Sat Sep 27 00:26:01 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Sat Sep 27 00:26:05 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <62971.98.210.193.72.1222480736.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
	<88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
	<88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
	<57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>
	<88e286470809252343h658d2f10o36426d93a334d1ea@mail.gmail.com>
	<58334.98.210.193.72.1222415218.squirrel@webmail.wageslavery.org>
	<88e286470809260251x4348b7dbr7e001fbba606edcc@mail.gmail.com>
	<62971.98.210.193.72.1222480736.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809262126u5ed2c7a0s5c97e832d5d3a960@mail.gmail.com>

I ask again what I asked before and which you didn't answer.

How many concurrent requests for these files are you receiving and how
long does it take to download a file?

In respect of your original comment

> it works..  but the problem is, requests start backing up whenever a
> download is being sent.  it looks like new requests are being sent
> to the apache process that is tied up sending the download file.  i
> don't understand why this is happening though.  i would think that
> while it's sending the file, no new requests would be queued in that
> process.

If you are truly using prefork MPM, then new requests cant be sent to
the busy process as requests are effectively accepted by a process
only when it is ready to handle a request.

Please verify which MPM is being used by running:

  httpd -V

How many httpd processes are running at the time you are making
requests that appear to be blocked?

What happens if you make requests at same time from a different web
browser or from another box, are they also stalled?

Are you using any AJAX stuff on client side for handling the download?

Graham

2008/9/27 Matt Barnicle <mattb@wageslavery.org>:
> sorry maybe i wasn't being clear..  i did get your code suggestions
> working, so that i've replaced the req.sendfile code with the
> apache.DECLINED code.  and it is sending the file ok and i'm
> downloading it ok, but it doesn't fix the problem as i originally
> posted, that the downloading is causing apache to block me when i
> click on links while the download is happening.
>
> - m@
>
>> What does your handler actually do? The following works for me no
>> problems.
>>
>> from mod_python import apache
>>
>> def handler(req):
>>     req.filename = '/etc/services'
>>     req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>     return apache.DECLINED
>>
>> Does the file exist prior to calling apr.stat()?
>>
>> Apache even sets the output headers okay:
>>
>> HTTP/1.1 200 OK
>> Date: Fri, 26 Sep 2008 09:50:33 GMT
>> Server: Apache/2.2.8 (Unix) mod_python/3.3.2-dev-20080311
>> Python/2.5.1
>> mod_ssl/2.2.8 OpenSSL/0.9.7l DAV/2 mod_wsgi/3.0-TRUNK
>> Last-Modified: Sun, 23 Sep 2007 21:37:31 GMT
>> ETag: "535d-a5847-43ad44fac1cc0"
>> Accept-Ranges: bytes
>> Content-Length: 677959
>> Connection: close
>> Content-Type: text/plain
>>
>> Ie., ETag and length etc.
>>
>> Graham
>>
>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>> nope  :-(
>>>
>>>> One last thing to add then. If this doesn't work, I'll have to
>>>> just
>>>> try it myself. :-)
>>>>
>>>>   req.handler = 'default-handler'
>>>>
>>>> Graham
>>>>
>>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>> ok, that worked..  but unfortunately the blocking issue is still
>>>>> happening.  i've verified that the download controller is
>>>>> returning
>>>>> apache.DECLINED and the file downloads ok.
>>>>>
>>>>> - m@
>>>>>
>>>>>> Try adding:
>>>>>>
>>>>>>   req.path_info = ''
>>>>>>
>>>>>> Graham
>>>>>>
>>>>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>>>>> Are you setting a content length on the response before
>>>>>>>>>>>> calling
>>>>>>>>>>>> req.sendfile()?
>>>>>>>>>>>>
>>>>>>>>>>>> How many concurrent requests for these files are you
>>>>>>>>>>>> receiving
>>>>>>> and
>>>>>>>>>>>> how long does it take to download a file?
>>>>>>>>>>>>
>>>>>>>>>>>> Graham
>>>>>>>>>>>
>>>>>>>>>>> yes, i believe so..  now that you mention it, i haven't
>>>>>>>>>>> verified
>>>>>>>>>>> the file size from the code below, i will do that to be
>>>>>>>>>>> sure.
>>>>>>> here
>>>>>>>>>>> is the code:
>>>>>>>>>>>
>>>>>>>>>>> file_path = self.conf.run.app_folder + 'public' +
>>>>>>>>>>> download.path
>>>>>>>>>>> file_stat = os.stat(file_path)
>>>>>>>>>>> file_size = str(file_stat.st_size)
>>>>>>>>>>>
>>>>>>>>>>> self.req.headers_out['Content-Length'] = file_size
>>>>>>>>>>> self.req.headers_out['Content-Disposition'] = 'attachment;
>>>>>>>>>>> filename=%s' % os.path.basename(file_path)
>>>>>>>>>>>
>>>>>>>>>>> bytes_sent = self.req.sendfile(file_path)
>>>>>>>>>>
>>>>>>>>>> BTW, now that you are using mod_python 3.3.1, instead of
>>>>>>>>>> using
>>>>>>>>>> req.sendfile(), you could possibly delegate serving of the
>>>>>>> static file
>>>>>>>>>> back to Apache. From memory this can be done using:
>>>>>>>>>>
>>>>>>>>>>   req.filename = self.conf.run.app_folder + 'public' +
>>>>>>>>>> download.path
>>>>>>>>>>   req.finfo = apache.stat(req.filename,
>>>>>>>>>> apache.APR_FINFO_MIN)
>>>>>>>>>>   return apache.DECLINED
>>>>>>>>>>
>>>>>>>>>> By returning apache.DECLINED you say mod_python handler
>>>>>>>>>> will
>>>>>>>>>> not
>>>>>>>>>> actually handle it, and by having updated req.filename and
>>>>>>>>>> req.fileinfo updated to new file, when it falls through to
>>>>>>>>>> default-handler it should serve it as static file.
>>>>>>>>>>
>>>>>>>>>> Doing it this way should bypass prior Apache access control
>>>>>>>>>> checks.
>>>>>>>>>> Thus file doesn't need to be in Apache document tree or
>>>>>>>>>> anywhere
>>>>>>> else
>>>>>>>>>> that is accessible.
>>>>>>>>>>
>>>>>>>>>> I believe doing it this way also has benefit that Apache
>>>>>>>>>> will
>>>>>>>>>> automatically set various headers that you probably
>>>>>>>>>> wouldn't
>>>>>>>>>> be.
>>>>>>>>>>
>>>>>>>>>> Please let us know if this alternate method works.
>>>>>>>>>>
>>>>>>>>>> Graham
>>>>>>>>> i tried the following but it doesn't seem to do what i want:
>>>>>>>>>
>>>>>>>>> DocumentRoot /var/www/my/application/public
>>>>>>>>> <Directory /var/www/my/application/public>
>>>>>>>>>  AddHandler python-program .py
>>>>>>>>>  PythonHandler myhandler
>>>>>>>>> </Directory>
>>>>>>>>
>>>>>>>> Use SetHandler instead of AddHandler.
>>>>>>>>
>>>>>>>>   DocumentRoot /var/www/my/application/public
>>>>>>>>   <Directory /var/www/my/application/public>
>>>>>>>>    SetHandler python-program
>>>>>>>>    PythonHandler myhandler
>>>>>>>>   </Directory>
>>>>>>>>
>>>>>>>> Graham
>>>>>>>
>>>>>>> ok, getting closer..  now i get a 404 error in the browser
>>>>>>> saying
>>>>>>> 'The requested URL /download/file/3 was not found on this
>>>>>>> server.'
>>>>>>> and in the apache logs:
>>>>>>>
>>>>>>> File does not exist:
>>>>>>> /var/www/application/public/downloads/music/music.zip/file/3
>>>>>>>
>>>>>>> so it looks like it's taking the last part of the URI and
>>>>>>> appending
>>>>>>> it to the physical filename and looking for that...  the
>>>>>>> request
>>>>>>> URI
>>>>>>> is 'http://example.com/download/file/3'.  the 'download'
>>>>>>> controller
>>>>>>> is what manages the music downloads.
>>>>>>>
>>>>>>> - m@
>>>>>>>
>>>>>>>
>>>>>>
>>>>>
>>>>>
>>>>>
>>>>
>>>
>>>
>>>
>>
>
>
>
From mattb at wageslavery.org  Sat Sep 27 18:21:39 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Sat Sep 27 17:56:24 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809262126u5ed2c7a0s5c97e832d5d3a960@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<64109.75.62.6.226.1222319531.squirrel@webmail.wageslavery.org>
	<88e286470809242216k55eb458jd1e1f2145858fb75@mail.gmail.com>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
	<88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
	<57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>
	<88e286470809252343h658d2f10o36426d93a334d1ea@mail.gmail.com>
	<58334.98.210.193.72.1222415218.squirrel@webmail.wageslavery.org>
	<88e286470809260251x4348b7dbr7e001fbba606edcc@mail.gmail.com>
	<62971.98.210.193.72.1222480736.squirrel@webmail.wageslavery.org>
	<88e286470809262126u5ed2c7a0s5c97e832d5d3a960@mail.gmail.com>
Message-ID: <50221.76.201.171.202.1222554099.squirrel@webmail.wageslavery.org>

> I ask again what I asked before and which you didn't answer.
>
> How many concurrent requests for these files are you receiving and
how
> long does it take to download a file?

sorry for not answering that earlier.  there aren't all that many. 
we get one or two requests for various pages about every 30 seconds
during normal traffic, sometimes that number goes up.  we only get
requests for downloads occassionally.  a much smaller percentage of
the requests are for the downloads.  they are various sizes.  the
one that is getting the most requests right now is an 18 MB zip
file.  it takes around 30 seconds to 2 minutes on a DSL connection
to complete the download.  you can see for yourself here:

http://giveback.net/download/music/3

i kept the site hidden earlier, because i've posted some code from
of our infrastructure and thought i should keep who i'm working for
hidden for that reason, but i think it may help toward getting the
problem solved and i'm not so concerned anymore..  apologies if that
has hindered the process in any way.

> In respect of your original comment
>
>> it works..  but the problem is, requests start backing up whenever a
>> download is being sent.  it looks like new requests are being sent
>> to the apache process that is tied up sending the download file.  i
>> don't understand why this is happening though.  i would think that
>> while it's sending the file, no new requests would be queued in that
>> process.
>
> If you are truly using prefork MPM, then new requests cant be sent to
> the busy process as requests are effectively accepted by a process
> only when it is ready to handle a request.
>
> Please verify which MPM is being used by running:
>
>   httpd -V

# httpd -V
Server version: Apache/2.2.3
Server built:   Jan 15 2008 20:33:41
Server's Module Magic Number: 20051115:3
Server loaded:  APR 1.2.7, APR-Util 1.2.7
Compiled using: APR 1.2.7, APR-Util 1.2.7
Architecture:   64-bit
Server MPM:     Prefork
  threaded:     no
  forked:     yes (variable process count)
Server compiled with....
 -D APACHE_MPM_DIR="server/mpm/prefork"
 -D APR_HAS_SENDFILE
 -D APR_HAS_MMAP
 -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)
 -D APR_USE_SYSVSEM_SERIALIZE
 -D APR_USE_PTHREAD_SERIALIZE
 -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT
 -D APR_HAS_OTHER_CHILD
 -D AP_HAVE_RELIABLE_PIPED_LOGS
 -D DYNAMIC_MODULE_LIMIT=128

> How many httpd processes are running at the time you are making
> requests that appear to be blocked?

it varies.  could be less than 10, could be between 10 and 40.  i've
seen it happening with any number of processes, it doesn't seem to
affect things.

> What happens if you make requests at same time from a different web
> browser or from another box, are they also stalled?

it depends.  if i download in one browser, then surf around in
another one, i may very well be able to click around in the other
the entire time without any problems.  but i may also get the
blocking issue.  and sometimes i will load the site fresh for the
first time on some days, and it won't load at all for a few minutes,
then it will.  and in these times, i will check /server-status and
see a lot of requests in the WAIT state, and always when it's like
this, there are one ore more downloads happening.

> Are you using any AJAX stuff on client side for handling the
> download?
>
> Graham

no.  there is a lot of AJAX on the site, but none of it related to
downloads.

i wonder if this could be related to something else, maybe the
database pooling?  i can't really imagine why, but i do wonder now..
 as you said above, new requests really shouldn't be sent to busy
processes.  so i'm baffled.

- m@

> 2008/9/27 Matt Barnicle <mattb@wageslavery.org>:
>> sorry maybe i wasn't being clear..  i did get your code
>> suggestions
>> working, so that i've replaced the req.sendfile code with the
>> apache.DECLINED code.  and it is sending the file ok and i'm
>> downloading it ok, but it doesn't fix the problem as i originally
>> posted, that the downloading is causing apache to block me when i
>> click on links while the download is happening.
>>
>> - m@
>>
>>> What does your handler actually do? The following works for me no
>>> problems.
>>>
>>> from mod_python import apache
>>>
>>> def handler(req):
>>>     req.filename = '/etc/services'
>>>     req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>>     return apache.DECLINED
>>>
>>> Does the file exist prior to calling apr.stat()?
>>>
>>> Apache even sets the output headers okay:
>>>
>>> HTTP/1.1 200 OK
>>> Date: Fri, 26 Sep 2008 09:50:33 GMT
>>> Server: Apache/2.2.8 (Unix) mod_python/3.3.2-dev-20080311
>>> Python/2.5.1
>>> mod_ssl/2.2.8 OpenSSL/0.9.7l DAV/2 mod_wsgi/3.0-TRUNK
>>> Last-Modified: Sun, 23 Sep 2007 21:37:31 GMT
>>> ETag: "535d-a5847-43ad44fac1cc0"
>>> Accept-Ranges: bytes
>>> Content-Length: 677959
>>> Connection: close
>>> Content-Type: text/plain
>>>
>>> Ie., ETag and length etc.
>>>
>>> Graham
>>>
>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>> nope  :-(
>>>>
>>>>> One last thing to add then. If this doesn't work, I'll have to
>>>>> just
>>>>> try it myself. :-)
>>>>>
>>>>>   req.handler = 'default-handler'
>>>>>
>>>>> Graham
>>>>>
>>>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>>> ok, that worked..  but unfortunately the blocking issue is
>>>>>> still
>>>>>> happening.  i've verified that the download controller is
>>>>>> returning
>>>>>> apache.DECLINED and the file downloads ok.
>>>>>>
>>>>>> - m@
>>>>>>
>>>>>>> Try adding:
>>>>>>>
>>>>>>>   req.path_info = ''
>>>>>>>
>>>>>>> Graham
>>>>>>>
>>>>>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>>>>>> Are you setting a content length on the response before
>>>>>>>>>>>>> calling
>>>>>>>>>>>>> req.sendfile()?
>>>>>>>>>>>>>
>>>>>>>>>>>>> How many concurrent requests for these files are you
>>>>>>>>>>>>> receiving
>>>>>>>> and
>>>>>>>>>>>>> how long does it take to download a file?
>>>>>>>>>>>>>
>>>>>>>>>>>>> Graham
>>>>>>>>>>>>
>>>>>>>>>>>> yes, i believe so..  now that you mention it, i haven't
>>>>>>>>>>>> verified
>>>>>>>>>>>> the file size from the code below, i will do that to be
>>>>>>>>>>>> sure.
>>>>>>>> here
>>>>>>>>>>>> is the code:
>>>>>>>>>>>>
>>>>>>>>>>>> file_path = self.conf.run.app_folder + 'public' +
>>>>>>>>>>>> download.path
>>>>>>>>>>>> file_stat = os.stat(file_path)
>>>>>>>>>>>> file_size = str(file_stat.st_size)
>>>>>>>>>>>>
>>>>>>>>>>>> self.req.headers_out['Content-Length'] = file_size
>>>>>>>>>>>> self.req.headers_out['Content-Disposition'] =
>>>>>>>>>>>> 'attachment;
>>>>>>>>>>>> filename=%s' % os.path.basename(file_path)
>>>>>>>>>>>>
>>>>>>>>>>>> bytes_sent = self.req.sendfile(file_path)
>>>>>>>>>>>
>>>>>>>>>>> BTW, now that you are using mod_python 3.3.1, instead of
>>>>>>>>>>> using
>>>>>>>>>>> req.sendfile(), you could possibly delegate serving of
>>>>>>>>>>> the
>>>>>>>> static file
>>>>>>>>>>> back to Apache. From memory this can be done using:
>>>>>>>>>>>
>>>>>>>>>>>   req.filename = self.conf.run.app_folder + 'public' +
>>>>>>>>>>> download.path
>>>>>>>>>>>   req.finfo = apache.stat(req.filename,
>>>>>>>>>>> apache.APR_FINFO_MIN)
>>>>>>>>>>>   return apache.DECLINED
>>>>>>>>>>>
>>>>>>>>>>> By returning apache.DECLINED you say mod_python handler
>>>>>>>>>>> will
>>>>>>>>>>> not
>>>>>>>>>>> actually handle it, and by having updated req.filename
>>>>>>>>>>> and
>>>>>>>>>>> req.fileinfo updated to new file, when it falls through
>>>>>>>>>>> to
>>>>>>>>>>> default-handler it should serve it as static file.
>>>>>>>>>>>
>>>>>>>>>>> Doing it this way should bypass prior Apache access
>>>>>>>>>>> control
>>>>>>>>>>> checks.
>>>>>>>>>>> Thus file doesn't need to be in Apache document tree or
>>>>>>>>>>> anywhere
>>>>>>>> else
>>>>>>>>>>> that is accessible.
>>>>>>>>>>>
>>>>>>>>>>> I believe doing it this way also has benefit that Apache
>>>>>>>>>>> will
>>>>>>>>>>> automatically set various headers that you probably
>>>>>>>>>>> wouldn't
>>>>>>>>>>> be.
>>>>>>>>>>>
>>>>>>>>>>> Please let us know if this alternate method works.
>>>>>>>>>>>
>>>>>>>>>>> Graham
>>>>>>>>>> i tried the following but it doesn't seem to do what i
>>>>>>>>>> want:
>>>>>>>>>>
>>>>>>>>>> DocumentRoot /var/www/my/application/public
>>>>>>>>>> <Directory /var/www/my/application/public>
>>>>>>>>>>  AddHandler python-program .py
>>>>>>>>>>  PythonHandler myhandler
>>>>>>>>>> </Directory>
>>>>>>>>>
>>>>>>>>> Use SetHandler instead of AddHandler.
>>>>>>>>>
>>>>>>>>>   DocumentRoot /var/www/my/application/public
>>>>>>>>>   <Directory /var/www/my/application/public>
>>>>>>>>>    SetHandler python-program
>>>>>>>>>    PythonHandler myhandler
>>>>>>>>>   </Directory>
>>>>>>>>>
>>>>>>>>> Graham
>>>>>>>>
>>>>>>>> ok, getting closer..  now i get a 404 error in the browser
>>>>>>>> saying
>>>>>>>> 'The requested URL /download/file/3 was not found on this
>>>>>>>> server.'
>>>>>>>> and in the apache logs:
>>>>>>>>
>>>>>>>> File does not exist:
>>>>>>>> /var/www/application/public/downloads/music/music.zip/file/3
>>>>>>>>
>>>>>>>> so it looks like it's taking the last part of the URI and
>>>>>>>> appending
>>>>>>>> it to the physical filename and looking for that...  the
>>>>>>>> request
>>>>>>>> URI
>>>>>>>> is 'http://example.com/download/file/3'.  the 'download'
>>>>>>>> controller
>>>>>>>> is what manages the music downloads.
>>>>>>>>
>>>>>>>> - m@
>>>>>>>>
>>>>>>>>
>>>>>>>
>>>>>>
>>>>>>
>>>>>>
>>>>>
>>>>
>>>>
>>>>
>>>
>>
>>
>>
>


From rmoore787 at gmail.com  Sat Sep 27 17:58:28 2008
From: rmoore787 at gmail.com (Robert Moore)
Date: Sat Sep 27 17:58:32 2008
Subject: [mod_python] Configuring pyc directory
Message-ID: <d374c9d90809271458o2d887beexe8b55a70fd861949@mail.gmail.com>

Is there a way to configure mod python to read/write compiled pyc files for
externally imported modules in a directory other than the directory
containing the original py files?  I'm trying to secure an Apache server and
don't want the process compiling the pyc files to have write access to the
folder containing my libraries.

Thanks,
Robert
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080927/cf6de1b2/attachment.html
From graham.dumpleton at gmail.com  Sat Sep 27 19:30:49 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Sat Sep 27 19:30:55 2008
Subject: [mod_python] Configuring pyc directory
In-Reply-To: <d374c9d90809271458o2d887beexe8b55a70fd861949@mail.gmail.com>
References: <d374c9d90809271458o2d887beexe8b55a70fd861949@mail.gmail.com>
Message-ID: <88e286470809271630j3f53b04du49090003b9acca0f@mail.gmail.com>

2008/9/28 Robert Moore <rmoore787@gmail.com>:
> Is there a way to configure mod python to read/write compiled pyc files for
> externally imported modules in a directory other than the directory
> containing the original py files?

No. That is a restriction of Python itself.

> I'm trying to secure an Apache server and
> don't want the process compiling the pyc files to have write access to the
> folder containing my libraries.

Using Apache/mod_python, it usually runs as special Apache user which
wouldn't have write permission to directories where your source code
is anyway, so not usually a problem.

Graham
From graham.dumpleton at gmail.com  Sat Sep 27 19:34:35 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Sat Sep 27 19:34:42 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <50221.76.201.171.202.1222554099.squirrel@webmail.wageslavery.org>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
	<88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
	<57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>
	<88e286470809252343h658d2f10o36426d93a334d1ea@mail.gmail.com>
	<58334.98.210.193.72.1222415218.squirrel@webmail.wageslavery.org>
	<88e286470809260251x4348b7dbr7e001fbba606edcc@mail.gmail.com>
	<62971.98.210.193.72.1222480736.squirrel@webmail.wageslavery.org>
	<88e286470809262126u5ed2c7a0s5c97e832d5d3a960@mail.gmail.com>
	<50221.76.201.171.202.1222554099.squirrel@webmail.wageslavery.org>
Message-ID: <88e286470809271634r5ba3addav4bc3bf990ae28e8d@mail.gmail.com>

I haven't read this latest response, but have one guess al the same. I
will say first that working out what the problem has been has been
made more difficult by you not offering up any source code for your
handler to show exactly what you are doing.

Anyway, one viable explanation for the problem is that you are using
mod_python session objects. Session objects are not normally unlocked
until cleanup handler, which is after all response content has been
returned. Thus if sending a lot of data back, requests from the same
user will be locked out, as well as other users who are unfortunate
enough to have the session keys fall into the same session mutex lock
bucket.

If you are using sessions, just before you return from handler, do
something like:

  req.session.save() # if necessary
  req.session.unlock()

I only say 'req.session' here as that is recommended convention for
where you store it, you may well have it stored elsewhere.

Graham

2008/9/28 Matt Barnicle <mattb@wageslavery.org>:
>> I ask again what I asked before and which you didn't answer.
>>
>> How many concurrent requests for these files are you receiving and
> how
>> long does it take to download a file?
>
> sorry for not answering that earlier.  there aren't all that many.
> we get one or two requests for various pages about every 30 seconds
> during normal traffic, sometimes that number goes up.  we only get
> requests for downloads occassionally.  a much smaller percentage of
> the requests are for the downloads.  they are various sizes.  the
> one that is getting the most requests right now is an 18 MB zip
> file.  it takes around 30 seconds to 2 minutes on a DSL connection
> to complete the download.  you can see for yourself here:
>
> http://giveback.net/download/music/3
>
> i kept the site hidden earlier, because i've posted some code from
> of our infrastructure and thought i should keep who i'm working for
> hidden for that reason, but i think it may help toward getting the
> problem solved and i'm not so concerned anymore..  apologies if that
> has hindered the process in any way.
>
>> In respect of your original comment
>>
>>> it works..  but the problem is, requests start backing up whenever a
>>> download is being sent.  it looks like new requests are being sent
>>> to the apache process that is tied up sending the download file.  i
>>> don't understand why this is happening though.  i would think that
>>> while it's sending the file, no new requests would be queued in that
>>> process.
>>
>> If you are truly using prefork MPM, then new requests cant be sent to
>> the busy process as requests are effectively accepted by a process
>> only when it is ready to handle a request.
>>
>> Please verify which MPM is being used by running:
>>
>>   httpd -V
>
> # httpd -V
> Server version: Apache/2.2.3
> Server built:   Jan 15 2008 20:33:41
> Server's Module Magic Number: 20051115:3
> Server loaded:  APR 1.2.7, APR-Util 1.2.7
> Compiled using: APR 1.2.7, APR-Util 1.2.7
> Architecture:   64-bit
> Server MPM:     Prefork
>  threaded:     no
>  forked:     yes (variable process count)
> Server compiled with....
>  -D APACHE_MPM_DIR="server/mpm/prefork"
>  -D APR_HAS_SENDFILE
>  -D APR_HAS_MMAP
>  -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)
>  -D APR_USE_SYSVSEM_SERIALIZE
>  -D APR_USE_PTHREAD_SERIALIZE
>  -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT
>  -D APR_HAS_OTHER_CHILD
>  -D AP_HAVE_RELIABLE_PIPED_LOGS
>  -D DYNAMIC_MODULE_LIMIT=128
>
>> How many httpd processes are running at the time you are making
>> requests that appear to be blocked?
>
> it varies.  could be less than 10, could be between 10 and 40.  i've
> seen it happening with any number of processes, it doesn't seem to
> affect things.
>
>> What happens if you make requests at same time from a different web
>> browser or from another box, are they also stalled?
>
> it depends.  if i download in one browser, then surf around in
> another one, i may very well be able to click around in the other
> the entire time without any problems.  but i may also get the
> blocking issue.  and sometimes i will load the site fresh for the
> first time on some days, and it won't load at all for a few minutes,
> then it will.  and in these times, i will check /server-status and
> see a lot of requests in the WAIT state, and always when it's like
> this, there are one ore more downloads happening.
>
>> Are you using any AJAX stuff on client side for handling the
>> download?
>>
>> Graham
>
> no.  there is a lot of AJAX on the site, but none of it related to
> downloads.
>
> i wonder if this could be related to something else, maybe the
> database pooling?  i can't really imagine why, but i do wonder now..
>  as you said above, new requests really shouldn't be sent to busy
> processes.  so i'm baffled.
>
> - m@
>
>> 2008/9/27 Matt Barnicle <mattb@wageslavery.org>:
>>> sorry maybe i wasn't being clear..  i did get your code
>>> suggestions
>>> working, so that i've replaced the req.sendfile code with the
>>> apache.DECLINED code.  and it is sending the file ok and i'm
>>> downloading it ok, but it doesn't fix the problem as i originally
>>> posted, that the downloading is causing apache to block me when i
>>> click on links while the download is happening.
>>>
>>> - m@
>>>
>>>> What does your handler actually do? The following works for me no
>>>> problems.
>>>>
>>>> from mod_python import apache
>>>>
>>>> def handler(req):
>>>>     req.filename = '/etc/services'
>>>>     req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
>>>>     return apache.DECLINED
>>>>
>>>> Does the file exist prior to calling apr.stat()?
>>>>
>>>> Apache even sets the output headers okay:
>>>>
>>>> HTTP/1.1 200 OK
>>>> Date: Fri, 26 Sep 2008 09:50:33 GMT
>>>> Server: Apache/2.2.8 (Unix) mod_python/3.3.2-dev-20080311
>>>> Python/2.5.1
>>>> mod_ssl/2.2.8 OpenSSL/0.9.7l DAV/2 mod_wsgi/3.0-TRUNK
>>>> Last-Modified: Sun, 23 Sep 2007 21:37:31 GMT
>>>> ETag: "535d-a5847-43ad44fac1cc0"
>>>> Accept-Ranges: bytes
>>>> Content-Length: 677959
>>>> Connection: close
>>>> Content-Type: text/plain
>>>>
>>>> Ie., ETag and length etc.
>>>>
>>>> Graham
>>>>
>>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>> nope  :-(
>>>>>
>>>>>> One last thing to add then. If this doesn't work, I'll have to
>>>>>> just
>>>>>> try it myself. :-)
>>>>>>
>>>>>>   req.handler = 'default-handler'
>>>>>>
>>>>>> Graham
>>>>>>
>>>>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>> ok, that worked..  but unfortunately the blocking issue is
>>>>>>> still
>>>>>>> happening.  i've verified that the download controller is
>>>>>>> returning
>>>>>>> apache.DECLINED and the file downloads ok.
>>>>>>>
>>>>>>> - m@
>>>>>>>
>>>>>>>> Try adding:
>>>>>>>>
>>>>>>>>   req.path_info = ''
>>>>>>>>
>>>>>>>> Graham
>>>>>>>>
>>>>>>>> 2008/9/26 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>>> 2008/9/25 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>>>>> 2008/9/24 Matt Barnicle <mattb@wageslavery.org>:
>>>>>>>>>>>>>> Are you setting a content length on the response before
>>>>>>>>>>>>>> calling
>>>>>>>>>>>>>> req.sendfile()?
>>>>>>>>>>>>>>
>>>>>>>>>>>>>> How many concurrent requests for these files are you
>>>>>>>>>>>>>> receiving
>>>>>>>>> and
>>>>>>>>>>>>>> how long does it take to download a file?
>>>>>>>>>>>>>>
>>>>>>>>>>>>>> Graham
>>>>>>>>>>>>>
>>>>>>>>>>>>> yes, i believe so..  now that you mention it, i haven't
>>>>>>>>>>>>> verified
>>>>>>>>>>>>> the file size from the code below, i will do that to be
>>>>>>>>>>>>> sure.
>>>>>>>>> here
>>>>>>>>>>>>> is the code:
>>>>>>>>>>>>>
>>>>>>>>>>>>> file_path = self.conf.run.app_folder + 'public' +
>>>>>>>>>>>>> download.path
>>>>>>>>>>>>> file_stat = os.stat(file_path)
>>>>>>>>>>>>> file_size = str(file_stat.st_size)
>>>>>>>>>>>>>
>>>>>>>>>>>>> self.req.headers_out['Content-Length'] = file_size
>>>>>>>>>>>>> self.req.headers_out['Content-Disposition'] =
>>>>>>>>>>>>> 'attachment;
>>>>>>>>>>>>> filename=%s' % os.path.basename(file_path)
>>>>>>>>>>>>>
>>>>>>>>>>>>> bytes_sent = self.req.sendfile(file_path)
>>>>>>>>>>>>
>>>>>>>>>>>> BTW, now that you are using mod_python 3.3.1, instead of
>>>>>>>>>>>> using
>>>>>>>>>>>> req.sendfile(), you could possibly delegate serving of
>>>>>>>>>>>> the
>>>>>>>>> static file
>>>>>>>>>>>> back to Apache. From memory this can be done using:
>>>>>>>>>>>>
>>>>>>>>>>>>   req.filename = self.conf.run.app_folder + 'public' +
>>>>>>>>>>>> download.path
>>>>>>>>>>>>   req.finfo = apache.stat(req.filename,
>>>>>>>>>>>> apache.APR_FINFO_MIN)
>>>>>>>>>>>>   return apache.DECLINED
>>>>>>>>>>>>
>>>>>>>>>>>> By returning apache.DECLINED you say mod_python handler
>>>>>>>>>>>> will
>>>>>>>>>>>> not
>>>>>>>>>>>> actually handle it, and by having updated req.filename
>>>>>>>>>>>> and
>>>>>>>>>>>> req.fileinfo updated to new file, when it falls through
>>>>>>>>>>>> to
>>>>>>>>>>>> default-handler it should serve it as static file.
>>>>>>>>>>>>
>>>>>>>>>>>> Doing it this way should bypass prior Apache access
>>>>>>>>>>>> control
>>>>>>>>>>>> checks.
>>>>>>>>>>>> Thus file doesn't need to be in Apache document tree or
>>>>>>>>>>>> anywhere
>>>>>>>>> else
>>>>>>>>>>>> that is accessible.
>>>>>>>>>>>>
>>>>>>>>>>>> I believe doing it this way also has benefit that Apache
>>>>>>>>>>>> will
>>>>>>>>>>>> automatically set various headers that you probably
>>>>>>>>>>>> wouldn't
>>>>>>>>>>>> be.
>>>>>>>>>>>>
>>>>>>>>>>>> Please let us know if this alternate method works.
>>>>>>>>>>>>
>>>>>>>>>>>> Graham
>>>>>>>>>>> i tried the following but it doesn't seem to do what i
>>>>>>>>>>> want:
>>>>>>>>>>>
>>>>>>>>>>> DocumentRoot /var/www/my/application/public
>>>>>>>>>>> <Directory /var/www/my/application/public>
>>>>>>>>>>>  AddHandler python-program .py
>>>>>>>>>>>  PythonHandler myhandler
>>>>>>>>>>> </Directory>
>>>>>>>>>>
>>>>>>>>>> Use SetHandler instead of AddHandler.
>>>>>>>>>>
>>>>>>>>>>   DocumentRoot /var/www/my/application/public
>>>>>>>>>>   <Directory /var/www/my/application/public>
>>>>>>>>>>    SetHandler python-program
>>>>>>>>>>    PythonHandler myhandler
>>>>>>>>>>   </Directory>
>>>>>>>>>>
>>>>>>>>>> Graham
>>>>>>>>>
>>>>>>>>> ok, getting closer..  now i get a 404 error in the browser
>>>>>>>>> saying
>>>>>>>>> 'The requested URL /download/file/3 was not found on this
>>>>>>>>> server.'
>>>>>>>>> and in the apache logs:
>>>>>>>>>
>>>>>>>>> File does not exist:
>>>>>>>>> /var/www/application/public/downloads/music/music.zip/file/3
>>>>>>>>>
>>>>>>>>> so it looks like it's taking the last part of the URI and
>>>>>>>>> appending
>>>>>>>>> it to the physical filename and looking for that...  the
>>>>>>>>> request
>>>>>>>>> URI
>>>>>>>>> is 'http://example.com/download/file/3'.  the 'download'
>>>>>>>>> controller
>>>>>>>>> is what manages the music downloads.
>>>>>>>>>
>>>>>>>>> - m@
>>>>>>>>>
>>>>>>>>>
>>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>
>>>>>
>>>>>
>>>>>
>>>>
>>>
>>>
>>>
>>
>
>
>
From mattb at wageslavery.org  Sat Sep 27 20:37:58 2008
From: mattb at wageslavery.org (Matt Barnicle)
Date: Sat Sep 27 20:12:43 2008
Subject: [mod_python] requests are blocking when using req.sendfile
In-Reply-To: <88e286470809271634r5ba3addav4bc3bf990ae28e8d@mail.gmail.com>
References: <59213.66.127.55.8.1222156529.squirrel@webmail.wageslavery.org>
	<56791.98.210.193.72.1222407760.squirrel@webmail.wageslavery.org>
	<88e286470809252230n2bbd90e7u395f70f7826cc520@mail.gmail.com>
	<57772.98.210.193.72.1222412659.squirrel@webmail.wageslavery.org>
	<88e286470809252343h658d2f10o36426d93a334d1ea@mail.gmail.com>
	<58334.98.210.193.72.1222415218.squirrel@webmail.wageslavery.org>
	<88e286470809260251x4348b7dbr7e001fbba606edcc@mail.gmail.com>
	<62971.98.210.193.72.1222480736.squirrel@webmail.wageslavery.org>
	<88e286470809262126u5ed2c7a0s5c97e832d5d3a960@mail.gmail.com>
	<50221.76.201.171.202.1222554099.squirrel@webmail.wageslavery.org>
	<88e286470809271634r5ba3addav4bc3bf990ae28e8d@mail.gmail.com>
Message-ID: <50957.76.201.171.202.1222562278.squirrel@webmail.wageslavery.org>

> I haven't read this latest response, but have one guess al the
same. I
> will say first that working out what the problem has been has been
> made more difficult by you not offering up any source code for your
> handler to show exactly what you are doing.

ok.  i will try to offer more details when i post in the future. 
there is a lot of code involved in a single request, as it's an MVC
style framework, so i wasn't really sure what to post and didn't
want to flood my email with source code.  i will definitely be more
attentive to that however.

> Anyway, one viable explanation for the problem is that you are using
> mod_python session objects. Session objects are not normally unlocked
> until cleanup handler, which is after all response content has been
> returned. Thus if sending a lot of data back, requests from the same
> user will be locked out, as well as other users who are unfortunate
> enough to have the session keys fall into the same session mutex lock
> bucket.
>
> If you are using sessions, just before you return from handler, do
> something like:
>
>   req.session.save() # if necessary
>   req.session.unlock()
>
> I only say 'req.session' here as that is recommended convention for
> where you store it, you may well have it stored elsewhere.
>
> Graham

well, hallelujah!  i tried this, and it is in fact working!!!  i'm
ecstatic!  thank you so much for all your assistance.

- m@

From okparanoid at free.fr  Sun Sep 28 07:09:39 2008
From: okparanoid at free.fr (okparanoid)
Date: Sun Sep 28 07:09:45 2008
Subject: [mod_python] AuthHandler to restrict ip adress only (no need to ask
 user for a password)
Message-ID: <48DF65F3.1010403@free.fr>

Hello !

I want to write a python program to restrict the access of urls by IP 
adress.

I have an authorize_access table in a Database with values : ip, 
datetime, url
this table is dynamically felt by an other program.

The need is that my python handle apache to choose if the url requested 
by an IP owner is authorized for this owner or not by matching the 3 
values correspond (ip, url, date) in the authorize_access table.

In fact this url correspond to dav documents.

The problem I have with Python Auth Handler is that, if I have well 
understand, it's only called with the apache directive "require valid user".
As a result apache ask the user for a couple login/password who is not 
needed in my case because my authHandler only take care of the adress ip.

Is there a solution to restrict access by ip without the need to prompt 
the user for login/password, by using mod_python or mod_wsgi ?

Cheers
From graham.dumpleton at gmail.com  Sun Sep 28 07:21:49 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Sun Sep 28 07:21:51 2008
Subject: [mod_python] AuthHandler to restrict ip adress only (no need to
	ask user for a password)
In-Reply-To: <48DF65F3.1010403@free.fr>
References: <48DF65F3.1010403@free.fr>
Message-ID: <88e286470809280421q66111818mb6c86ac7c2f4197e@mail.gmail.com>

2008/9/28 okparanoid <okparanoid@free.fr>:
> Hello !
>
> I want to write a python program to restrict the access of urls by IP
> adress.
>
> I have an authorize_access table in a Database with values : ip, datetime,
> url
> this table is dynamically felt by an other program.
>
> The need is that my python handle apache to choose if the url requested by
> an IP owner is authorized for this owner or not by matching the 3 values
> correspond (ip, url, date) in the authorize_access table.
>
> In fact this url correspond to dav documents.
>
> The problem I have with Python Auth Handler is that, if I have well
> understand, it's only called with the apache directive "require valid user".
> As a result apache ask the user for a couple login/password who is not
> needed in my case because my authHandler only take care of the adress ip.
>
> Is there a solution to restrict access by ip without the need to prompt the
> user for login/password, by using mod_python or mod_wsgi ?

In mod_wsgi you go:

  WSGIAccessScript /usr/local/wsgi/script/access.wsgi

and then that file would contain:

  def allow_access(environ, host):
      return host in ['localhost', '::1']

That is, returns True if want to allow access or False otherwise.

Obviously in your case your checking would be more complicated.

If you want a custom error page for forbidden, you would use
ErrorDocument to direct to handler URL which produces it.

For mod_wsgi see:

  http://code.google.com/p/modwsgi/wiki/AccessControlMechanisms#Host_Access_Controls

In mod_python you would use:

  PythonAccessHandler somemodule

and in that module it would contain:

  from mod_python import apache

  def accesshandler(req):
    if req.connection.remote_ip in ['localhost', '::1']:
      return apache.OK
    return apache.HTTP_FORBIDDEN

If you want a custom error page for forbidden, you would use
ErrorDocument to direct to handler URL which produces it, or have the
access handler itself produce it in the appropriate manner.

Graham
From drshade at gmail.com  Mon Sep 29 10:05:25 2008
From: drshade at gmail.com (Tom Wells)
Date: Mon Sep 29 10:05:31 2008
Subject: [mod_python] Mod_Python, Mod_Proxy, and Set-Cookie
Message-ID: <ed756d900809290705l76d19aa7o2c872587eb5c4907@mail.gmail.com>

Hi Group

I'm facing an interesting problem at the moment and wondered if anyone could
give me a pointer. Our setup is the following:
Apache running mod_python and mod_proxy, with python handlers for Authen and
Authz, we have an Oracle Application Server and a JRUN Application Server in
the back, which are where mod_proxy is configured to forward to. Our python
Authen and Authz handlers are responsible for getting and setting session
related cookies before proxying, or to redirect the user if the session
cookie is bad or he is not logged in (no cookie). Even if the user has a
valid cookie we refresh it every 2 minutes, i.e. generate a new cookie, add
the Set-Cookie header, then allow the request to continue (i.e. mod_proxy
kicks in and forwards the request to oracle or jrun). This is nice because
we have a single authentication model up front for multiple disparate web
applications in the back.

Now the good news is that this works really well, mostly. Browser requests
to and from the webserver correctly get and update cookies and
allow/disallow requests to be proxied. More specifically the "Set-Cookie"
header is present in responses where the cookie has been updated. This is
true for both the oracle and jrun application servers being proxied to.

HOWEVER - we have a rich client (desktop) app written in C# which has been
designed to POST to some of the oracle url's in order to fetch data, after
it performs a login. So it logs in, gets a fresh new cookie and regularly
hits the backend for data. For each request our Authen and Authz handlers
process the cookie and ensure the session is valid etc, and allow or
disallow the request (i.e. return apache.OK or do a
mod_python_util.redirect() to get rid of him). The problem is that requests
from this app don't ever get back a refreshed cookie (after 2 minutes) -
there is every indication according to my apache logs that my Authz handler
is calling the mod_python.Cookie.add_cookie(req, newCookie) function to set
the new cookie, and even printing out the list of headers_in and headers_out
in a fixuphandler shows the Set-Cookie header is present. BUT the Set-Cookie
never makes it back to the app as we have used fiddler2 and httpdebugger to
monitor the traffic.

So I blame the Oracle Application Server for eating the cookie somehow, but
surely as the cookie is added to the headers_out of the request it MUST go
back to the browser regardless of how it was proxied or whatever the proxied
application responds with?

Please help - getting desperate for a solution - any pointers as to track
down the issue would be greatly appreciated!

Thanks,
Tom

-- 
http://www.tomwells.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080929/672e16db/attachment.html
From drshade at gmail.com  Mon Sep 29 20:59:29 2008
From: drshade at gmail.com (Tom Wells)
Date: Mon Sep 29 20:59:37 2008
Subject: [mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie
In-Reply-To: <ed756d900809290705l76d19aa7o2c872587eb5c4907@mail.gmail.com>
References: <ed756d900809290705l76d19aa7o2c872587eb5c4907@mail.gmail.com>
Message-ID: <ed756d900809291759g2517afcej76439686876df841@mail.gmail.com>

Hi Mod_Pythonians,

So I managed to solve it - and it's clearly a bug in Apache 2.2.9 mod_proxy
as far as I can tell. I will be posting the bug to the Apache bug list, but
thought I would give you a quick explanation as I've found many a golden
nugget during my travels on this mailing list.

Basically if you're trying to set a cookie within a handler (mod_python or
otherwise I assume) and the response from the proxied resource starts with
the "HTTP/1.1 100 Continue" status line (because the request was a POST and
had an "Expect: 100-Continue") then you can forget about mod_proxy merging
the Set-Cookie in your out_headers from your handler with the response from
the proxied resource. I've been through most of the mod_proxy code this
evening and I can understand why, there are some hairy things in there
(around backwards compatibility and the ever changing HTTP goal posts of
long ago I suppose). Regular POSTs work great, which explains the mixed
results we were seeing between our various back-end web servers.

Of course everything works just perfectly in Apache 2.2.4 which happened to
be our development Apache version, and so we didn't stumble upon the issue
until during deployment on the production machines (which the ops team keep
patched to the latest Apache version).

Best Regards,
Tom

On Mon, Sep 29, 2008 at 10:05 AM, Tom Wells <drshade@gmail.com> wrote:

> Hi Group
>
> I'm facing an interesting problem at the moment and wondered if anyone
> could give me a pointer. Our setup is the following:
> Apache running mod_python and mod_proxy, with python handlers for Authen
> and Authz, we have an Oracle Application Server and a JRUN Application
> Server in the back, which are where mod_proxy is configured to forward to.
> Our python Authen and Authz handlers are responsible for getting and setting
> session related cookies before proxying, or to redirect the user if the
> session cookie is bad or he is not logged in (no cookie). Even if the user
> has a valid cookie we refresh it every 2 minutes, i.e. generate a new
> cookie, add the Set-Cookie header, then allow the request to continue (i.e.
> mod_proxy kicks in and forwards the request to oracle or jrun). This is nice
> because we have a single authentication model up front for multiple
> disparate web applications in the back.
>
> Now the good news is that this works really well, mostly. Browser requests
> to and from the webserver correctly get and update cookies and
> allow/disallow requests to be proxied. More specifically the "Set-Cookie"
> header is present in responses where the cookie has been updated. This is
> true for both the oracle and jrun application servers being proxied to.
>
> HOWEVER - we have a rich client (desktop) app written in C# which has been
> designed to POST to some of the oracle url's in order to fetch data, after
> it performs a login. So it logs in, gets a fresh new cookie and regularly
> hits the backend for data. For each request our Authen and Authz handlers
> process the cookie and ensure the session is valid etc, and allow or
> disallow the request (i.e. return apache.OK or do a
> mod_python_util.redirect() to get rid of him). The problem is that requests
> from this app don't ever get back a refreshed cookie (after 2 minutes) -
> there is every indication according to my apache logs that my Authz handler
> is calling the mod_python.Cookie.add_cookie(req, newCookie) function to set
> the new cookie, and even printing out the list of headers_in and headers_out
> in a fixuphandler shows the Set-Cookie header is present. BUT the Set-Cookie
> never makes it back to the app as we have used fiddler2 and httpdebugger to
> monitor the traffic.
>
> So I blame the Oracle Application Server for eating the cookie somehow, but
> surely as the cookie is added to the headers_out of the request it MUST go
> back to the browser regardless of how it was proxied or whatever the proxied
> application responds with?
>
> Please help - getting desperate for a solution - any pointers as to track
> down the issue would be greatly appreciated!
>
> Thanks,
> Tom
>
> --
> http://www.tomwells.org
>



-- 
http://www.tomwells.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080929/d19bcae5/attachment.html
From graham.dumpleton at gmail.com  Mon Sep 29 21:21:58 2008
From: graham.dumpleton at gmail.com (Graham Dumpleton)
Date: Mon Sep 29 21:22:03 2008
Subject: [mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie
In-Reply-To: <ed756d900809291759g2517afcej76439686876df841@mail.gmail.com>
References: <ed756d900809290705l76d19aa7o2c872587eb5c4907@mail.gmail.com>
	<ed756d900809291759g2517afcej76439686876df841@mail.gmail.com>
Message-ID: <88e286470809291821sb120ae8v4b9bd28fabca9e4d@mail.gmail.com>

It may be that your assumption that setting headers_out in a authnz
handler will always ensure that it appears in response, where authnz
handler is not providing the final response, is just wrong. The
correct way of ensuring this is possibly to use an output filter. That
way the setting of additional headers is from after true handler had
started returning response and so after when it has set headers
itself. That way no chance that content handler will ignore what you
may have already set in headers_out as you are overriding what it has
set. So, have a look at req.add_output_filter(). Only thing I don't
remember is whether mod_python output filters are registered at
correct level to allow modifications to response headers.

Graham

2008/9/30 Tom Wells <drshade@gmail.com>:
> Hi Mod_Pythonians,
>
> So I managed to solve it - and it's clearly a bug in Apache 2.2.9 mod_proxy
> as far as I can tell. I will be posting the bug to the Apache bug list, but
> thought I would give you a quick explanation as I've found many a golden
> nugget during my travels on this mailing list.
>
> Basically if you're trying to set a cookie within a handler (mod_python or
> otherwise I assume) and the response from the proxied resource starts with
> the "HTTP/1.1 100 Continue" status line (because the request was a POST and
> had an "Expect: 100-Continue") then you can forget about mod_proxy merging
> the Set-Cookie in your out_headers from your handler with the response from
> the proxied resource. I've been through most of the mod_proxy code this
> evening and I can understand why, there are some hairy things in there
> (around backwards compatibility and the ever changing HTTP goal posts of
> long ago I suppose). Regular POSTs work great, which explains the mixed
> results we were seeing between our various back-end web servers.
>
> Of course everything works just perfectly in Apache 2.2.4 which happened to
> be our development Apache version, and so we didn't stumble upon the issue
> until during deployment on the production machines (which the ops team keep
> patched to the latest Apache version).
>
> Best Regards,
> Tom
>
> On Mon, Sep 29, 2008 at 10:05 AM, Tom Wells <drshade@gmail.com> wrote:
>>
>> Hi Group
>>
>> I'm facing an interesting problem at the moment and wondered if anyone
>> could give me a pointer. Our setup is the following:
>> Apache running mod_python and mod_proxy, with python handlers for Authen
>> and Authz, we have an Oracle Application Server and a JRUN Application
>> Server in the back, which are where mod_proxy is configured to forward to.
>> Our python Authen and Authz handlers are responsible for getting and setting
>> session related cookies before proxying, or to redirect the user if the
>> session cookie is bad or he is not logged in (no cookie). Even if the user
>> has a valid cookie we refresh it every 2 minutes, i.e. generate a new
>> cookie, add the Set-Cookie header, then allow the request to continue (i.e.
>> mod_proxy kicks in and forwards the request to oracle or jrun). This is nice
>> because we have a single authentication model up front for multiple
>> disparate web applications in the back.
>>
>> Now the good news is that this works really well, mostly. Browser requests
>> to and from the webserver correctly get and update cookies and
>> allow/disallow requests to be proxied. More specifically the "Set-Cookie"
>> header is present in responses where the cookie has been updated. This is
>> true for both the oracle and jrun application servers being proxied to.
>>
>> HOWEVER - we have a rich client (desktop) app written in C# which has been
>> designed to POST to some of the oracle url's in order to fetch data, after
>> it performs a login. So it logs in, gets a fresh new cookie and regularly
>> hits the backend for data. For each request our Authen and Authz handlers
>> process the cookie and ensure the session is valid etc, and allow or
>> disallow the request (i.e. return apache.OK or do a
>> mod_python_util.redirect() to get rid of him). The problem is that requests
>> from this app don't ever get back a refreshed cookie (after 2 minutes) -
>> there is every indication according to my apache logs that my Authz handler
>> is calling the mod_python.Cookie.add_cookie(req, newCookie) function to set
>> the new cookie, and even printing out the list of headers_in and headers_out
>> in a fixuphandler shows the Set-Cookie header is present. BUT the Set-Cookie
>> never makes it back to the app as we have used fiddler2 and httpdebugger to
>> monitor the traffic.
>>
>> So I blame the Oracle Application Server for eating the cookie somehow,
>> but surely as the cookie is added to the headers_out of the request it MUST
>> go back to the browser regardless of how it was proxied or whatever the
>> proxied application responds with?
>>
>> Please help - getting desperate for a solution - any pointers as to track
>> down the issue would be greatly appreciated!
>>
>> Thanks,
>> Tom
>>
>> --
>> http://www.tomwells.org
>
>
>
> --
> http://www.tomwells.org
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
>
From drshade at gmail.com  Mon Sep 29 21:49:57 2008
From: drshade at gmail.com (Tom Wells)
Date: Mon Sep 29 21:50:04 2008
Subject: [mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie
In-Reply-To: <88e286470809291821sb120ae8v4b9bd28fabca9e4d@mail.gmail.com>
References: <ed756d900809290705l76d19aa7o2c872587eb5c4907@mail.gmail.com>
	<ed756d900809291759g2517afcej76439686876df841@mail.gmail.com>
	<88e286470809291821sb120ae8v4b9bd28fabca9e4d@mail.gmail.com>
Message-ID: <ed756d900809291849n7b6126a2x739fd37a19efc934@mail.gmail.com>

Good point and something that was bothering me before I looked at
mod_proxy_http.c - which clearly was built with the "intention" of merging
proxied responses with values already set in headers_out. But in terms of
defensive programming and designing for the unexpected, especially within a
flexible framework such as Apache is very good advice. I'll take a look at
add_output_filter() and see if it's a better option for me.

Thanks for your help as usual Graham.

Best Regards,
Tom

On Mon, Sep 29, 2008 at 9:21 PM, Graham Dumpleton <
graham.dumpleton@gmail.com> wrote:

> It may be that your assumption that setting headers_out in a authnz
> handler will always ensure that it appears in response, where authnz
> handler is not providing the final response, is just wrong. The
> correct way of ensuring this is possibly to use an output filter. That
> way the setting of additional headers is from after true handler had
> started returning response and so after when it has set headers
> itself. That way no chance that content handler will ignore what you
> may have already set in headers_out as you are overriding what it has
> set. So, have a look at req.add_output_filter(). Only thing I don't
> remember is whether mod_python output filters are registered at
> correct level to allow modifications to response headers.
>
> Graham
>
> 2008/9/30 Tom Wells <drshade@gmail.com>:
> > Hi Mod_Pythonians,
> >
> > So I managed to solve it - and it's clearly a bug in Apache 2.2.9
> mod_proxy
> > as far as I can tell. I will be posting the bug to the Apache bug list,
> but
> > thought I would give you a quick explanation as I've found many a golden
> > nugget during my travels on this mailing list.
> >
> > Basically if you're trying to set a cookie within a handler (mod_python
> or
> > otherwise I assume) and the response from the proxied resource starts
> with
> > the "HTTP/1.1 100 Continue" status line (because the request was a POST
> and
> > had an "Expect: 100-Continue") then you can forget about mod_proxy
> merging
> > the Set-Cookie in your out_headers from your handler with the response
> from
> > the proxied resource. I've been through most of the mod_proxy code this
> > evening and I can understand why, there are some hairy things in there
> > (around backwards compatibility and the ever changing HTTP goal posts of
> > long ago I suppose). Regular POSTs work great, which explains the mixed
> > results we were seeing between our various back-end web servers.
> >
> > Of course everything works just perfectly in Apache 2.2.4 which happened
> to
> > be our development Apache version, and so we didn't stumble upon the
> issue
> > until during deployment on the production machines (which the ops team
> keep
> > patched to the latest Apache version).
> >
> > Best Regards,
> > Tom
> >
> > On Mon, Sep 29, 2008 at 10:05 AM, Tom Wells <drshade@gmail.com> wrote:
> >>
> >> Hi Group
> >>
> >> I'm facing an interesting problem at the moment and wondered if anyone
> >> could give me a pointer. Our setup is the following:
> >> Apache running mod_python and mod_proxy, with python handlers for Authen
> >> and Authz, we have an Oracle Application Server and a JRUN Application
> >> Server in the back, which are where mod_proxy is configured to forward
> to.
> >> Our python Authen and Authz handlers are responsible for getting and
> setting
> >> session related cookies before proxying, or to redirect the user if the
> >> session cookie is bad or he is not logged in (no cookie). Even if the
> user
> >> has a valid cookie we refresh it every 2 minutes, i.e. generate a new
> >> cookie, add the Set-Cookie header, then allow the request to continue
> (i.e.
> >> mod_proxy kicks in and forwards the request to oracle or jrun). This is
> nice
> >> because we have a single authentication model up front for multiple
> >> disparate web applications in the back.
> >>
> >> Now the good news is that this works really well, mostly. Browser
> requests
> >> to and from the webserver correctly get and update cookies and
> >> allow/disallow requests to be proxied. More specifically the
> "Set-Cookie"
> >> header is present in responses where the cookie has been updated. This
> is
> >> true for both the oracle and jrun application servers being proxied to.
> >>
> >> HOWEVER - we have a rich client (desktop) app written in C# which has
> been
> >> designed to POST to some of the oracle url's in order to fetch data,
> after
> >> it performs a login. So it logs in, gets a fresh new cookie and
> regularly
> >> hits the backend for data. For each request our Authen and Authz
> handlers
> >> process the cookie and ensure the session is valid etc, and allow or
> >> disallow the request (i.e. return apache.OK or do a
> >> mod_python_util.redirect() to get rid of him). The problem is that
> requests
> >> from this app don't ever get back a refreshed cookie (after 2 minutes) -
> >> there is every indication according to my apache logs that my Authz
> handler
> >> is calling the mod_python.Cookie.add_cookie(req, newCookie) function to
> set
> >> the new cookie, and even printing out the list of headers_in and
> headers_out
> >> in a fixuphandler shows the Set-Cookie header is present. BUT the
> Set-Cookie
> >> never makes it back to the app as we have used fiddler2 and httpdebugger
> to
> >> monitor the traffic.
> >>
> >> So I blame the Oracle Application Server for eating the cookie somehow,
> >> but surely as the cookie is added to the headers_out of the request it
> MUST
> >> go back to the browser regardless of how it was proxied or whatever the
> >> proxied application responds with?
> >>
> >> Please help - getting desperate for a solution - any pointers as to
> track
> >> down the issue would be greatly appreciated!
> >>
> >> Thanks,
> >> Tom
> >>
> >> --
> >> http://www.tomwells.org
> >
> >
> >
> > --
> > http://www.tomwells.org
> >
> > _______________________________________________
> > Mod_python mailing list
> > Mod_python@modpython.org
> > http://mailman.modpython.org/mailman/listinfo/mod_python
> >
> >
>



-- 
http://www.tomwells.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080929/795c708c/attachment-0001.html
