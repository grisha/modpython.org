<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] mod_python executing old versions of my code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20executing%20old%20versions%20of%20my%20code&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020078.html">
   <LINK REL="Next"  HREF="020081.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] mod_python executing old versions of my code</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20executing%20old%20versions%20of%20my%20code&In-Reply-To="
       TITLE="[mod_python] mod_python executing old versions of my code">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Jan 24 18:15:08 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020078.html">[mod_python] mod_python executing old versions of my code
</A></li>
        <LI>Next message: <A HREF="020081.html">[mod_python] mod_python executing old versions of my code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20079">[ date ]</a>
              <a href="thread.html#20079">[ thread ]</a>
              <a href="subject.html#20079">[ subject ]</a>
              <a href="author.html#20079">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>What you are seeing is normal behaviour for mod_python for the way your
code is set up. It is one of a number of cases which highlight the
shortcomings of the module importing and automatic module reloading
system of mod_python. You can read more about some of the problems
with module importing here:

  <A HREF="http://www.dscpl.com.au/articles/modpython-003.html">http://www.dscpl.com.au/articles/modpython-003.html</A>

More information interspersed below.

James Paige wrote ..
&gt;<i> I'm new to mod_python... so maybe I have missed something fundamental 
</I>&gt;<i> here, but mod_python seems to be keeping several copies of my old code
</I>&gt;<i> in memory, so when I make changes and reload the page, sometimes I get
</I>&gt;<i> my changes, and sometimes I get a seemingly-random version of the code
</I>&gt;<i> that I have already changed.
</I>&gt;<i> 
</I>&gt;<i> Here is a simple test-case I set up.
</I>&gt;<i> 
</I>&gt;<i> Here is my .htaccess file:
</I>&gt;<i> 
</I>&gt;<i> -------------------------
</I>&gt;<i> SetHandler python-program
</I>&gt;<i> PythonHandler main
</I>&gt;<i> PythonDebug On
</I>&gt;<i> -------------------------
</I>&gt;<i> 
</I>&gt;<i> (I am using version 2.7.10 as shipped in Debian stable's 
</I>&gt;<i> libapache-mod-python package, which is why I am using &quot;python-program&quot;)
</I>&gt;<i> 
</I>&gt;<i> Here is my main.py
</I>&gt;<i> 
</I>&gt;<i> -----------------------------
</I>&gt;<i> from mod_python import apache
</I>&gt;<i> import testmodule
</I>&gt;<i> 
</I>&gt;<i> def handler(req):
</I>&gt;<i>      req.write(&quot;Hello World!&quot;)
</I>&gt;<i>      testmodule.foo(req)
</I>&gt;<i>      return apache.OK
</I>&gt;<i> -----------------------------
</I>&gt;<i> 
</I>&gt;<i> and here is the imported testmodule.py
</I>&gt;<i> 
</I>&gt;<i> --------------------------------
</I>&gt;<i> def foo(req):
</I>&gt;<i>     req.write('three blind mice')
</I>&gt;<i> --------------------------------
</I>&gt;<i> 
</I>&gt;<i> The first time I load this test in my web browser, I see the expected 
</I>&gt;<i> result:
</I>&gt;<i> 
</I>&gt;<i>    Hello World!three blind mice
</I>&gt;<i> 
</I>&gt;<i> I edit testmodule.py and change the string to something else:
</I>&gt;<i> 
</I>&gt;<i> --------------------------------------
</I>&gt;<i> def foo(req):
</I>&gt;<i>     req.write('mary had a little lamb')
</I>&gt;<i> --------------------------------------
</I>&gt;<i> 
</I>&gt;<i> I then reload my web browser. Sometimes this results in &quot;Hello 
</I>&gt;<i> World!mary had a little lamb&quot;, and sometimes it reuslts in &quot;Hello 
</I>&gt;<i> World!three blind mice&quot;
</I>
When you see what you expect, it is because the request was handled by a
different Apache child process which had never previously loaded your
code. Since it is the first time it has needed to load it, it will
obviously get the most recent version.

When you don't see what you expect, it is because the request was
handled by the the existing Apache child process which had already
loaded the code.

&gt;<i> I edit the string again, and hit reload again. Maybe I get the new 
</I>&gt;<i> string.... or maybe I get one of the strings I used previously. I keep
</I>&gt;<i> making changes to testmodule.py and I keep reloading the results, and 
</I>&gt;<i> the results are almost always wrong.
</I>&gt;<i> 
</I>&gt;<i> I know this is not a browser cache problem. I have cleared/disabled my
</I>&gt;<i> web-browser's cache.
</I>&gt;<i> 
</I>&gt;<i> I read about &quot;Multiple Interpreters&quot; in the documentation, and have 
</I>&gt;<i> tried to force my code to run in a single interpreter by adding:
</I>&gt;<i> 
</I>&gt;<i> PythonInterpreter &quot;test_interpreter&quot;
</I>&gt;<i> 
</I>&gt;<i> to my .htaccess file, but that makes no difference.
</I>&gt;<i> 
</I>&gt;<i> This problem only occurs in the included module. I can edit main.py and
</I>&gt;<i> my changes are always applied. I notice in the apache logs that 
</I>&gt;<i> everytime I reload the page I see:
</I>&gt;<i> 
</I>&gt;<i>    [notice] mod_python: (Re)importing main from None
</I>
The automatic module reloading only applies to the top most module,
ie., main.py, and not to anything imported using &quot;import&quot;.

&gt;<i> But I can find no way to force testmodule to be re-imported. What am I
</I>&gt;<i> doing wrong?
</I>
You are not doing anything wrong, the current system simply doesn't
work very well.

The best you can get is to use:

  from mod_python import apache
  import os

  __here__ = os.path.dirname(__file__)
  
  def handler(req):
       req.write(&quot;Hello World!&quot;)
       testmodule = apache.import_module(&quot;testmodule,path=[__here__])
       testmodule.foo(req)
       return apache.OK

This uses apache.import_module() on each request to import the module.
In practice though, if the file has not changed it just uses what is already
in the cache. If it has changed, you should then see the change.

You can't use apache.import_module() at global scope in the module and
get the same effect as that only gets executed when main.py is imported.
Thus you don't get the check for changes to testmodule.py on every
request.

I have a completely rewritten module importing system for mod_python
which addresses nearly all the issues it has. I will be making it available for
trialing after mod_python 3.2.6 is officially released. It will require though
having 3.2.6, which means it will be useless to you with 2.7.11.

Whether this new module importing system gets adopted is another
matter entirely though. Some have argued in the past that the current
arrangement is adequate even though it has known problems. ;-(

Graham
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020078.html">[mod_python] mod_python executing old versions of my code
</A></li>
	<LI>Next message: <A HREF="020081.html">[mod_python] mod_python executing old versions of my code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20079">[ date ]</a>
              <a href="thread.html#20079">[ thread ]</a>
              <a href="subject.html#20079">[ subject ]</a>
              <a href="author.html#20079">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
