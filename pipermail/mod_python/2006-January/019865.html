<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20child%20process%20XXXX%20still%20did%20not%20exit%2C%0A%09sending%20a%20SIGTERM&In-Reply-To=8393fff0601032217w3433596n1ce373153464f1cd%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019863.html">
   <LINK REL="Next"  HREF="019866.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20child%20process%20XXXX%20still%20did%20not%20exit%2C%0A%09sending%20a%20SIGTERM&In-Reply-To=8393fff0601032217w3433596n1ce373153464f1cd%40mail.gmail.com"
       TITLE="[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM">grahamd at dscpl.com.au
       </A><BR>
    <I>Wed Jan  4 05:29:36 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="019863.html">[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM
</A></li>
        <LI>Next message: <A HREF="019866.html">[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19865">[ date ]</a>
              <a href="thread.html#19865">[ thread ]</a>
              <a href="subject.html#19865">[ subject ]</a>
              <a href="author.html#19865">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 04/01/2006, at 5:17 PM, Martin Blais wrote:
&gt;<i> I think I got my hands on something here, here is what I got from a
</I>&gt;<i> gdb backtrace when I quickly attach before the child is killed:
</I>&gt;<i>
</I>&gt;<i> #0  0xb7bec054 in __pthread_sigsuspend () from /lib/libpthread.so.0
</I>&gt;<i> #1  0xb7bebe98 in __pthread_wait_for_restart_signal () from 
</I>&gt;<i> /lib/libpthread.so.0
</I>&gt;<i> #2  0xb7becd6b in sem_wait@@GLIBC_2.1 () from /lib/libpthread.so.0
</I>&gt;<i> #3  0xb7a2a54f in PyThread_acquire_lock () from
</I>&gt;<i> /usr/lib/apache2/modules/mod_python.so
</I>&gt;<i> #4  0xb7a2373e in PyThreadState_Delete () from
</I>&gt;<i> /usr/lib/apache2/modules/mod_python.so
</I>&gt;<i> #5  0xb7a232f8 in PyInterpreterState_Delete () from
</I>&gt;<i> /usr/lib/apache2/modules/mod_python.so
</I>&gt;<i> #6  0xb7a24663 in Py_EndInterpreter () from
</I>&gt;<i> /usr/lib/apache2/modules/mod_python.so
</I>&gt;<i> #7  0xb799ff08 in python_finalize () from 
</I>&gt;<i> /usr/lib/apache2/modules/mod_python.so
</I>&gt;<i> #8  0xb7ccb6ed in apr_pool_cleanup_run () from /usr/lib/libapr-0.so.0
</I>&gt;<i> #9  0xb7ccaf8d in apr_pool_destroy () from /usr/lib/libapr-0.so.0
</I>&gt;<i> #10 0x0806860c in ap_graceful_stop_signalled ()
</I>&gt;<i> #11 0xb7beeef5 in __pthread_sighandler () from /lib/libpthread.so.0
</I>&gt;<i> #12 &lt;signal handler called&gt;
</I>&gt;<i> #13 0xb7b750b8 in poll () from /lib/libc.so.6
</I>&gt;<i> #14 0xb7ccc2af in apr_poll () from /usr/lib/libapr-0.so.0
</I>&gt;<i> #15 0xb7ccca53 in apr_wait_for_io_or_timeout () from 
</I>&gt;<i> /usr/lib/libapr-0.so.0
</I>&gt;<i> #16 0xb7cc1f74 in apr_socket_recv () from /usr/lib/libapr-0.so.0
</I>&gt;<i> #17 0xb7dd9335 in apr_bucket_socket_create () from 
</I>&gt;<i> /usr/lib/libaprutil-0.so.0
</I>&gt;<i> #18 0xb7dd9bce in apr_brigade_split_line () from 
</I>&gt;<i> /usr/lib/libaprutil-0.so.0
</I>&gt;<i> #19 0x0807fdfb in ap_get_request_note ()
</I>&gt;<i> #20 0x080767a6 in ap_get_brigade ()
</I>&gt;<i> #21 0xb7f3db96 in ?? () from /usr/lib/apache2/modules/mod_logio.so
</I>&gt;<i> #22 0x08250d80 in ?? ()
</I>&gt;<i> #23 0x08272020 in ?? ()
</I>&gt;<i> #24 0x00000001 in ?? ()
</I>&gt;<i> #25 0x00000000 in ?? ()
</I>&gt;<i>
</I>&gt;<i> Apache terminates its children by sending them a signal in the first
</I>&gt;<i> place (#12).   Then, in the Python HEAD_LOCK
</I>&gt;<i> (Python-2.4.2/Python/pystate.c), I inspected the code and I can't find
</I>&gt;<i> a deadlock problem.  But the pthread semaphore seem to use a signal
</I>&gt;<i> itself (the name of the call in frame #0), and we're already in a
</I>&gt;<i> signal handler, isn't this prohibited?
</I>
The stack trace is a bit bogus from what I can tell. In the various MPMs
I looked at, the ap_graceful_stop_signalled() function simple sets a
variable and returns. It doesn't go calling apr_pool_destroy().

Anyway, seeing the stack trace I can see where the problem lies and can
simulate the situation with a test case.

What it all comes down to is the signal handler for a SIGTERM in the
child process is registered as:

   apr_signal(SIGTERM, just_die);

Thus when the SIGTERM is received it calls just_die(). The just_die()
function calls clean_child_exit(), which if there is found to be a
memory pool in existence for the child process calls apr_pool_destroy()
on that memory pool.

The problem then is that mod_python registers a cleanup handler
associated with that memory pool, namely python_finalize(). Ie., it
calls:

   apr_pool_cleanup_register(p, NULL, python_finalize, 
apr_pool_cleanup_null);

This means that when that memory pool is destroyed, the 
python_finalize()
function is being called, which is wrong in that situation for a couple
of reasons.

The first reason is that complex things should not be done from inside 
of
signal handlers unless the code which is called is heavily protected
against being called by signal handlers when in critical sections. There
is no way that general Python API functions are going to fall into that
category.

The second reason is that at the time that the signal occurs, the main
program thread is already deep within Python code and probably has 
various
locks acquired. When the signal handler calls into Py_Finalize() it is
most likely reaching a point where it wants to acquire the same lock
as the main program thread has and it effectively deadlocks as the
signal handler can't proceed until it gets the lock, but the main
program thread can't give it up while the signal handler is running.

At least this is the case on UNIX systems, where signal handlers
interrupt the execution of the main program thread, unlike Win32 where
signal handlers are a distinct thread in their own right.

My immediate question is why does Py_Finalize() even need to be called
within the context of the child process if it is simply being killed off
anyway. I know that for the Apache main process if doing a restart that
Py_Finalize() needs to be called as the same process is kept around,
but for a child process I don't see the point except maybe to flush
out stderr/stdout which aren't typically used in mod_python anyway.

Time now to work out why python_finalize() needs to be called. Maybe
it can't simply not do anything when called in the context of the child
process.

Graham

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019863.html">[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM
</A></li>
	<LI>Next message: <A HREF="019866.html">[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19865">[ date ]</a>
              <a href="thread.html#19865">[ thread ]</a>
              <a href="subject.html#19865">[ subject ]</a>
              <a href="author.html#19865">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
