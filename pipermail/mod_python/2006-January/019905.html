<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: streaming zipped data with publisher
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20streaming%20zipped%20data%20with%20publisher&In-Reply-To=f67813665ac250d00d1a912e7b0e2a30%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019893.html">
   <LINK REL="Next"  HREF="019906.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: streaming zipped data with publisher</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Daniel Nogradi</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20streaming%20zipped%20data%20with%20publisher&In-Reply-To=f67813665ac250d00d1a912e7b0e2a30%40dscpl.com.au"
       TITLE="[mod_python] Re: streaming zipped data with publisher">nogradi at gmail.com
       </A><BR>
    <I>Mon Jan  9 05:36:55 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="019893.html">[mod_python] streaming zipped data with publisher
</A></li>
        <LI>Next message: <A HREF="019906.html">[mod_python] Re: streaming zipped data with publisher
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19905">[ date ]</a>
              <a href="thread.html#19905">[ thread ]</a>
              <a href="subject.html#19905">[ subject ]</a>
              <a href="author.html#19905">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/8/06, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
&gt;<i> On 08/01/2006, at 8:55 AM, Sean Jamieson wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Sure it is, even with the temporary file option, all you have to do is
</I>&gt;<i> &gt; set the content-type header to application/x-gzipped or something like
</I>&gt;<i> &gt; that (application/octet-stream is always a fallback value; this forces
</I>&gt;<i> &gt; download, and doesn't allow it to recognize the file format for use
</I>&gt;<i> &gt; with an external application), then output the file (possibly setting
</I>&gt;<i> &gt; the Content-Length header first, to be polite)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; with or with out the file is your choice, all you have to do is output
</I>&gt;<i> &gt; the binary data, and no other output (not even a single space) or you
</I>&gt;<i> &gt; will corrupt it.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Daniel Nogradi wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Is it possible to &quot;stream&quot; zipped data using the publisher handler?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; In my situation I would create the zipped archive upon client input
</I>&gt;<i> &gt;&gt; and want to return the archive immediately. What I have in mind is
</I>&gt;<i> &gt;&gt; creating a zip archive (using the zipfile module perhaps) in memory
</I>&gt;<i> &gt;&gt; and than sending that to the client without actually creating a zip
</I>&gt;<i> &gt;&gt; file on the disk of the server.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; In case this would not be possible I could live with creating a
</I>&gt;<i> &gt;&gt; temporary file and returning that to the client, but at the moment the
</I>&gt;<i> &gt;&gt; only way I can do this is through a link (such as &lt;a
</I>&gt;<i> &gt;&gt; href='data.zip'&gt;click here&lt;/a&gt;)  but in this case it would be a 2-step
</I>&gt;<i> &gt;&gt; process: (1) user clicks on something which creates the archive and
</I>&gt;<i> &gt;&gt; sends back the link in html (2) user clicks on the link. Is it not
</I>&gt;<i> &gt;&gt; possible to send the zip file immediately after its creation?
</I>&gt;<i>
</I>&gt;<i> I am not sure you are talking about the same thing here. The &quot;zipfile&quot;
</I>&gt;<i> module is for creating an archive containing other enclosed files.
</I>&gt;<i> This is different to merely compressing any output returned from a
</I>&gt;<i> handler.
</I>&gt;<i>
</I>&gt;<i> If it was the case that it is only about compressing the output, doing
</I>&gt;<i> it inside a published function is possibly not a good idea anyway. A
</I>&gt;<i> better way would be to use the DEFLATE output filter as implemented by
</I>&gt;<i> the Apache mod_deflate module.
</I>&gt;<i>
</I>&gt;<i> This module is however only available in Apache 2.0 and is not compiled
</I>&gt;<i> in by default, so you have to enable its inclusion when &quot;configure&quot; is
</I>&gt;<i> run prior to building Apache. Also, at the moment, because mod_python
</I>&gt;<i> doesn't allow dynamic registration of output filters from a handler,
</I>&gt;<i> it would apply to all requests in a directory, or those returning a
</I>&gt;<i> certain type of output, or possibly by URL if you are tricky.
</I>&gt;<i>
</I>&gt;<i> Also should be pointed out that mod_deflate will only compress output
</I>&gt;<i> where the client says it is willing to accept it as gzip'd data by
</I>&gt;<i> having set the &quot;Accept-Encoding: gzip&quot; incoming header. One can forcibly
</I>&gt;<i> set this though from a handler to force it to do it anyway.
</I>&gt;<i>
</I>&gt;<i> Anyway, the point I am trying to make is there are perhaps better tools
</I>&gt;<i> for doing the job than trying to compress on the fly in Python code
</I>&gt;<i> running
</I>&gt;<i> under mod_python, although technically one could write the equivalent of
</I>&gt;<i> mod_deflate in Python if you wanted to. If you did write it in Python
</I>&gt;<i> though, you would still be better off installing it as an output filter.
</I>&gt;<i> For it all to work nicely may have to wait until mod_python 3.3 though,
</I>&gt;<i> where I hope to get some improvements made to working with filters.
</I>&gt;<i>
</I>&gt;<i>    <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-103">http://issues.apache.org/jira/browse/MODPYTHON-103</A>
</I>&gt;<i>    <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-104">http://issues.apache.org/jira/browse/MODPYTHON-104</A>
</I>&gt;<i>
</I>&gt;<i> Anyway, back to the original posters question. If I read the code for
</I>&gt;<i> the
</I>&gt;<i> &quot;zipfile&quot; module correctly, when you use the ZipFile class with &quot;w&quot; mode
</I>&gt;<i> to create a zip file, the first argument only needs to be a file like
</I>&gt;<i> object. That is, it doesn't need to be a actual file on disk. Instead it
</I>&gt;<i> could be an instance of the StringIO class. I have not use ZipFile to
</I>&gt;<i> create an archive, but something perhaps like the following may work.
</I>&gt;<i>
</I>&gt;<i>    import zipfile
</I>&gt;<i>    import StringIO
</I>&gt;<i>
</I>&gt;<i>    buffer = StringIO.StringIO()
</I>&gt;<i>    myzip = zipfile.ZipFile(buffer,&quot;w&quot;)
</I>&gt;<i>
</I>&gt;<i>    ... build up zip
</I>&gt;<i>
</I>&gt;<i>    myzip.close()
</I>&gt;<i>
</I>&gt;<i>    data = buffer.getvalue()
</I>&gt;<i>
</I>&gt;<i> After this, your zip file as a string will be in data and you can then
</I>&gt;<i> return it as the response content.
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>
Thanks all for the very useful info!

As Graham pointed out, I wasn't talking about zipping everything I
send to the clients, only zipping a file once in a while when users
request an archive of a bunch of files. And, more importantly, I don't
want to store the zip file, but create it upon request, send it, and
delete it.

It seems this StringIO solution is best. Only I'm not sure how I
return the 'data' (in your example) since I'm using the publisher
handler. As far as I understand, perhaps I'm wrong here, the publisher
handler does all header stuff by itself, but in this case I need to
set content length, content type, etc, so how does this go with
publisher?

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019893.html">[mod_python] streaming zipped data with publisher
</A></li>
	<LI>Next message: <A HREF="019906.html">[mod_python] Re: streaming zipped data with publisher
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19905">[ date ]</a>
              <a href="thread.html#19905">[ thread ]</a>
              <a href="subject.html#19905">[ subject ]</a>
              <a href="author.html#19905">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
