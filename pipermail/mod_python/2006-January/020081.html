<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] mod_python executing old versions of my code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20executing%20old%20versions%20of%20my%20code&In-Reply-To=1138144508.30648%40dscpl.user.openhosting.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020079.html">
   <LINK REL="Next"  HREF="020080.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] mod_python executing old versions of my code</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>James Paige</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20executing%20old%20versions%20of%20my%20code&In-Reply-To=1138144508.30648%40dscpl.user.openhosting.com"
       TITLE="[mod_python] mod_python executing old versions of my code">jamesp at westcoastaerospace.com
       </A><BR>
    <I>Tue Jan 24 19:12:45 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020079.html">[mod_python] mod_python executing old versions of my code
</A></li>
        <LI>Next message: <A HREF="020080.html">[mod_python] mod_python executing old versions of my code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20081">[ date ]</a>
              <a href="thread.html#20081">[ thread ]</a>
              <a href="subject.html#20081">[ subject ]</a>
              <a href="author.html#20081">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Wow, thank you Graham! That is a lot of good information. I think the 
workaround you offered will serve my purposes for now, and I do 
certainly hope that your proposed changes go into a future version of 
mod_python.

I have a hard time imagining how anyone could possibly argue that the 
current behavior is non-broken.

---
James Paige

Graham Dumpleton wrote:
&gt;<i> What you are seeing is normal behaviour for mod_python for the way your
</I>&gt;<i> code is set up. It is one of a number of cases which highlight the
</I>&gt;<i> shortcomings of the module importing and automatic module reloading
</I>&gt;<i> system of mod_python. You can read more about some of the problems
</I>&gt;<i> with module importing here:
</I>&gt;<i> 
</I>&gt;<i>   <A HREF="http://www.dscpl.com.au/articles/modpython-003.html">http://www.dscpl.com.au/articles/modpython-003.html</A>
</I>&gt;<i> 
</I>&gt;<i> More information interspersed below.
</I>&gt;<i> 
</I>&gt;<i> James Paige wrote ..
</I>&gt;&gt;<i> I'm new to mod_python... so maybe I have missed something fundamental 
</I>&gt;&gt;<i> here, but mod_python seems to be keeping several copies of my old code
</I>&gt;&gt;<i> in memory, so when I make changes and reload the page, sometimes I get
</I>&gt;&gt;<i> my changes, and sometimes I get a seemingly-random version of the code
</I>&gt;&gt;<i> that I have already changed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is a simple test-case I set up.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is my .htaccess file:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -------------------------
</I>&gt;&gt;<i> SetHandler python-program
</I>&gt;&gt;<i> PythonHandler main
</I>&gt;&gt;<i> PythonDebug On
</I>&gt;&gt;<i> -------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> (I am using version 2.7.10 as shipped in Debian stable's 
</I>&gt;&gt;<i> libapache-mod-python package, which is why I am using &quot;python-program&quot;)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is my main.py
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----------------------------
</I>&gt;&gt;<i> from mod_python import apache
</I>&gt;&gt;<i> import testmodule
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> def handler(req):
</I>&gt;&gt;<i>      req.write(&quot;Hello World!&quot;)
</I>&gt;&gt;<i>      testmodule.foo(req)
</I>&gt;&gt;<i>      return apache.OK
</I>&gt;&gt;<i> -----------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> and here is the imported testmodule.py
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --------------------------------
</I>&gt;&gt;<i> def foo(req):
</I>&gt;&gt;<i>     req.write('three blind mice')
</I>&gt;&gt;<i> --------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The first time I load this test in my web browser, I see the expected 
</I>&gt;&gt;<i> result:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    Hello World!three blind mice
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I edit testmodule.py and change the string to something else:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --------------------------------------
</I>&gt;&gt;<i> def foo(req):
</I>&gt;&gt;<i>     req.write('mary had a little lamb')
</I>&gt;&gt;<i> --------------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I then reload my web browser. Sometimes this results in &quot;Hello 
</I>&gt;&gt;<i> World!mary had a little lamb&quot;, and sometimes it reuslts in &quot;Hello 
</I>&gt;&gt;<i> World!three blind mice&quot;
</I>&gt;<i> 
</I>&gt;<i> When you see what you expect, it is because the request was handled by a
</I>&gt;<i> different Apache child process which had never previously loaded your
</I>&gt;<i> code. Since it is the first time it has needed to load it, it will
</I>&gt;<i> obviously get the most recent version.
</I>&gt;<i> 
</I>&gt;<i> When you don't see what you expect, it is because the request was
</I>&gt;<i> handled by the the existing Apache child process which had already
</I>&gt;<i> loaded the code.
</I>&gt;<i> 
</I>&gt;&gt;<i> I edit the string again, and hit reload again. Maybe I get the new 
</I>&gt;&gt;<i> string.... or maybe I get one of the strings I used previously. I keep
</I>&gt;&gt;<i> making changes to testmodule.py and I keep reloading the results, and 
</I>&gt;&gt;<i> the results are almost always wrong.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I know this is not a browser cache problem. I have cleared/disabled my
</I>&gt;&gt;<i> web-browser's cache.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I read about &quot;Multiple Interpreters&quot; in the documentation, and have 
</I>&gt;&gt;<i> tried to force my code to run in a single interpreter by adding:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> PythonInterpreter &quot;test_interpreter&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> to my .htaccess file, but that makes no difference.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This problem only occurs in the included module. I can edit main.py and
</I>&gt;&gt;<i> my changes are always applied. I notice in the apache logs that 
</I>&gt;&gt;<i> everytime I reload the page I see:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    [notice] mod_python: (Re)importing main from None
</I>&gt;<i> 
</I>&gt;<i> The automatic module reloading only applies to the top most module,
</I>&gt;<i> ie., main.py, and not to anything imported using &quot;import&quot;.
</I>&gt;<i> 
</I>&gt;&gt;<i> But I can find no way to force testmodule to be re-imported. What am I
</I>&gt;&gt;<i> doing wrong?
</I>&gt;<i> 
</I>&gt;<i> You are not doing anything wrong, the current system simply doesn't
</I>&gt;<i> work very well.
</I>&gt;<i> 
</I>&gt;<i> The best you can get is to use:
</I>&gt;<i> 
</I>&gt;<i>   from mod_python import apache
</I>&gt;<i>   import os
</I>&gt;<i> 
</I>&gt;<i>   __here__ = os.path.dirname(__file__)
</I>&gt;<i>   
</I>&gt;<i>   def handler(req):
</I>&gt;<i>        req.write(&quot;Hello World!&quot;)
</I>&gt;<i>        testmodule = apache.import_module(&quot;testmodule,path=[__here__])
</I>&gt;<i>        testmodule.foo(req)
</I>&gt;<i>        return apache.OK
</I>&gt;<i> 
</I>&gt;<i> This uses apache.import_module() on each request to import the module.
</I>&gt;<i> In practice though, if the file has not changed it just uses what is already
</I>&gt;<i> in the cache. If it has changed, you should then see the change.
</I>&gt;<i> 
</I>&gt;<i> You can't use apache.import_module() at global scope in the module and
</I>&gt;<i> get the same effect as that only gets executed when main.py is imported.
</I>&gt;<i> Thus you don't get the check for changes to testmodule.py on every
</I>&gt;<i> request.
</I>&gt;<i> 
</I>&gt;<i> I have a completely rewritten module importing system for mod_python
</I>&gt;<i> which addresses nearly all the issues it has. I will be making it available for
</I>&gt;<i> trialing after mod_python 3.2.6 is officially released. It will require though
</I>&gt;<i> having 3.2.6, which means it will be useless to you with 2.7.11.
</I>&gt;<i> 
</I>&gt;<i> Whether this new module importing system gets adopted is another
</I>&gt;<i> matter entirely though. Some have argued in the past that the current
</I>&gt;<i> arrangement is adequate even though it has known problems. ;-(
</I>&gt;<i> 
</I>&gt;<i> Graham
</I>&gt;<i> 
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020079.html">[mod_python] mod_python executing old versions of my code
</A></li>
	<LI>Next message: <A HREF="020080.html">[mod_python] mod_python executing old versions of my code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20081">[ date ]</a>
              <a href="thread.html#20081">[ thread ]</a>
              <a href="subject.html#20081">[ subject ]</a>
              <a href="author.html#20081">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
