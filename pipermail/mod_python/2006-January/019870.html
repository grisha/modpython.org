<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20child%20process%20XXXX%20still%20did%20not%20exit%2C%0A%09sending%20a%20SIGTERM&In-Reply-To=096aeb5e6def26f49b3952c888cc1b0e%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019866.html">
   <LINK REL="Next"  HREF="019861.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Martin Blais</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20child%20process%20XXXX%20still%20did%20not%20exit%2C%0A%09sending%20a%20SIGTERM&In-Reply-To=096aeb5e6def26f49b3952c888cc1b0e%40dscpl.com.au"
       TITLE="[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM">blais at furius.ca
       </A><BR>
    <I>Wed Jan  4 11:19:45 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="019866.html">[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM
</A></li>
        <LI>Next message: <A HREF="019861.html">[mod_python] Feature Request: Additions to mod_python.util
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19870">[ date ]</a>
              <a href="thread.html#19870">[ thread ]</a>
              <a href="subject.html#19870">[ subject ]</a>
              <a href="author.html#19870">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/4/06, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> The stack trace is a bit bogus from what I can tell. In the various MPMs
</I>&gt;<i> I looked at, the ap_graceful_stop_signalled() function simple sets a
</I>&gt;<i> variable and returns. It doesn't go calling apr_pool_destroy().
</I>
I'm still not sure how the normal termination communication message
between the apache parent and its child happens, I thought it was
supposed to be via the scoreboard, but the stack trace seems to
indicate via a signal.  When I attach gdb on the running child prior
to stopping the app, when I stop apache it gets SIGTERM right away,
and not when a timeout occurs.  I guess I should dig in apache and
libc now (won't happen for another 2 weeks, I have some important work
to move on to now for a deadline), to find out how the normal
termination is supposed to occur.

Note that if I attach gdb before I shutdown apache I can't reproduce
this stack trace.  I need to attach after I terminate apache to get to
this.




&gt;<i> Anyway, seeing the stack trace I can see where the problem lies and can
</I>&gt;<i> simulate the situation with a test case.
</I>&gt;<i>
</I>&gt;<i> What it all comes down to is the signal handler for a SIGTERM in the
</I>&gt;<i> child process is registered as:
</I>&gt;<i>
</I>&gt;<i>    apr_signal(SIGTERM, just_die);
</I>&gt;<i>
</I>&gt;<i> Thus when the SIGTERM is received it calls just_die(). The just_die()
</I>&gt;<i> function calls clean_child_exit(), which if there is found to be a
</I>&gt;<i> memory pool in existence for the child process calls apr_pool_destroy()
</I>&gt;<i> on that memory pool.
</I>&gt;<i>
</I>&gt;<i> The problem then is that mod_python registers a cleanup handler
</I>&gt;<i> associated with that memory pool, namely python_finalize(). Ie., it
</I>&gt;<i> calls:
</I>&gt;<i>
</I>&gt;<i>    apr_pool_cleanup_register(p, NULL, python_finalize,
</I>&gt;<i> apr_pool_cleanup_null);
</I>&gt;<i>
</I>&gt;<i> This means that when that memory pool is destroyed, the
</I>&gt;<i> python_finalize()
</I>&gt;<i> function is being called, which is wrong in that situation for a couple
</I>&gt;<i> of reasons.
</I>
Maybe we should change the way python_finalize() is being triggered.
Any ideas?


&gt;<i>
</I>&gt;<i> The first reason is that complex things should not be done from inside
</I>&gt;<i> of
</I>&gt;<i> signal handlers unless the code which is called is heavily protected
</I>&gt;<i> against being called by signal handlers when in critical sections. There
</I>&gt;<i> is no way that general Python API functions are going to fall into that
</I>&gt;<i> category.
</I>
Indeed.


&gt;<i> The second reason is that at the time that the signal occurs, the main
</I>&gt;<i> program thread is already deep within Python code and probably has
</I>&gt;<i> various
</I>&gt;<i> locks acquired. When the signal handler calls into Py_Finalize() it is
</I>
I don't know about that, the trace does not indicate that we're
processing a request at all.  But it could happen I suppose.

What we could/should do on that signal is to simply mark a variable
for later exiting the wait-loop.  That must be somewhere within the
apache libs.  This way we could terminate properly without being in a
signal handler.


&gt;<i> most likely reaching a point where it wants to acquire the same lock
</I>&gt;<i> as the main program thread has and it effectively deadlocks as the
</I>&gt;<i> signal handler can't proceed until it gets the lock, but the main
</I>&gt;<i> program thread can't give it up while the signal handler is running.
</I>&gt;<i>
</I>&gt;<i> At least this is the case on UNIX systems, where signal handlers
</I>&gt;<i> interrupt the execution of the main program thread, unlike Win32 where
</I>&gt;<i> signal handlers are a distinct thread in their own right.
</I>&gt;<i>
</I>&gt;<i> My immediate question is why does Py_Finalize() even need to be called
</I>&gt;<i> within the context of the child process if it is simply being killed off
</I>&gt;<i> anyway. I know that for the Apache main process if doing a restart that
</I>&gt;<i> Py_Finalize() needs to be called as the same process is kept around,
</I>&gt;<i> but for a child process I don't see the point except maybe to flush
</I>&gt;<i> out stderr/stdout which aren't typically used in mod_python anyway.
</I>
I'm still not convinced if it is being killed off or asked to
gracefully go down.


&gt;<i> Time now to work out why python_finalize() needs to be called. Maybe
</I>&gt;<i> it can't simply not do anything when called in the context of the child
</I>&gt;<i> process.
</I>

&gt;<i> Anyway, one could put:
</I>&gt;<i>
</I>&gt;<i>      if (child_init_pool)
</I>&gt;<i>          return APR_SUCCESS;
</I>&gt;<i>
</I>&gt;<i> at the start of python_finalize() and that would at least avoid any
</I>&gt;<i> problems
</I>&gt;<i> with the signal handler trying to do complicated stuff like call into
</I>&gt;<i> Python
</I>&gt;<i> and cause a deadlock.
</I>
&gt;<i> Can you at least try the above little addition to python_finalize() and
</I>&gt;<i> see if it makes any difference in your specific case.
</I>
Oh yes.  Problem completely gone... but then again python_finalize is
not being called for any of the children (I checked with some logging
traces), whilst before some of the children managed to terminate
gracefully.

Hmm, I think we either need to find a way to terminate outside of a
signal handler, or to forego calling Py_Finalize entirely (I don't
like the latter &quot;solution&quot;).

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019866.html">[mod_python] Re: child process XXXX still did not exit,
	sending a SIGTERM
</A></li>
	<LI>Next message: <A HREF="019861.html">[mod_python] Feature Request: Additions to mod_python.util
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19870">[ date ]</a>
              <a href="thread.html#19870">[ thread ]</a>
              <a href="subject.html#19870">[ subject ]</a>
              <a href="author.html#19870">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
