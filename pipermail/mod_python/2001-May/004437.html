<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Win32 threading issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Win32%20threading%20issue&In-Reply-To=000001c0d70d%24064b9fe0%244eb3bd9d%40softwareag.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004436.html">
   <LINK REL="Next"  HREF="004438.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Win32 threading issue</H1>
    <B>Chris Trengove</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Win32%20threading%20issue&In-Reply-To=000001c0d70d%24064b9fe0%244eb3bd9d%40softwareag.com"
       TITLE="[mod_python] Win32 threading issue">trengove at econdata.com.au
       </A><BR>
    <I>Tue May  8 13:34:46 EST 2001</I>
    <P><UL>
        <LI>Previous message: <A HREF="004436.html">[mod_python] Win32 threading issue
</A></li>
        <LI>Next message: <A HREF="004438.html">[mod_python] Win32 threading issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4437">[ date ]</a>
              <a href="thread.html#4437">[ thread ]</a>
              <a href="subject.html#4437">[ subject ]</a>
              <a href="author.html#4437">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<table border=0 width="100%"><tr><td>
<!--beginarticle-->
<PRE>St&#233;phane,

I would be great if you could find time to look at this.

I have been doing some more investigating, trying to understand just what
is going on. As I mentioned in my previous message, Py_BEGIN_ALLOW_THREADS
is called in the request object's write() method, so thread switching could
occur here. But thread switching should still occur in any case inside the
main Python interpreter loop. To test this, I tried the following script

from mod_python import apache
import thread

counter = None
LOOPLIMIT =
1000000

def handler(req):
   	global counter
    counter = 0
   	for i in
range(0,LOOPLIMIT):
        counter = counter + 1
    req.content_type =
&quot;text/plain&quot;
    req.send_http_header()
    req.write(&quot;%d: %d\n&quot; %
(thread.get_ident(),counter))
    return apache.OK

If I load this page once, I get a value of 1000000 back, as expected. If I
load the page from two clients &quot;simultaneously&quot; (or as fast as I can
activate each one), I get something like

Client 1
1908: 1200128
2016: 1354557
2024: 591402

Client 2
2004: 1698384
2012: 1800311
2028: 1205627

This is for three repetitions of the page load. As you can see, the Python
interpreter is definitely switching between threads, and producing crazy
results for the global counter variable, which is not protected by any lock.

This is all as expected. The puzzle is why the thread switching inside the
request object's module should be causing some problem, if that is indeed
where the trouble lies. I am wondering whether there is something in the
request object structure which is not totally thread-safe.

Incidentally, if I run enough repetitions of this test setup, I can
eventually get a situation where one thread crashes, and the other thread
(just at this point) returns a value like

632: 1515843&lt;LF&gt;568: 1572286

that is TWO thread IDs in the one message -- the write buffer of one thread
is being appended to by the other, somehow.

Some food for thought.
Chris

&gt;<i>I think this is true for *nix, but on windows,
</I>&gt;<i>you *must* use a multithreaded python.
</I>&gt;<i>
</I>&gt;<i>I'll try to have a look at your issue, but I've very
</I>&gt;<i>few time available these days.
</I>


</PRE>
<!--endarticle-->
</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004436.html">[mod_python] Win32 threading issue
</A></li>
	<LI>Next message: <A HREF="004438.html">[mod_python] Win32 threading issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4437">[ date ]</a>
              <a href="thread.html#4437">[ thread ]</a>
              <a href="subject.html#4437">[ subject ]</a>
              <a href="author.html#4437">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
