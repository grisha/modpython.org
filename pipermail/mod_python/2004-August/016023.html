<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Stopping Reimports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Stopping%20Reimports&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016020.html">
   <LINK REL="Next"  HREF="016025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Stopping Reimports</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Cu _</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Stopping%20Reimports&In-Reply-To="
       TITLE="[mod_python] Stopping Reimports">pc_ at one.lv
       </A><BR>
    <I>Tue Aug 10 15:47:01 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="016020.html">[mod_python] mptest.py testing failed
</A></li>
        <LI>Next message: <A HREF="016025.html">[mod_python] Stopping Reimports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16023">[ date ]</a>
              <a href="thread.html#16023">[ thread ]</a>
              <a href="subject.html#16023">[ subject ]</a>
              <a href="author.html#16023">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>mpy
Hello, 

I'd like to know if there is some elegant way to deal with the 
[notice] mod_python: (Re)importing module 'index' with path set to [...]

The mod_python.apache importing mechanism works correctly, the problem is,
it keeps reimporting the same files.

I don't think reimporting is the best solution for modules with same names but in different directories.

It degrades performance with unneeded imports. 

Then,
I try to use mod_python's sideeffect of not discarding variables when importing already 
loaded modules to cache frequently used data (If the module doesn't get reimported all the time, it's variables keep their values between subsequent requests). 
Every reimport causes the cached data to be reloaded.

Also, it pollutes error_log :)

My current &quot;solution&quot; is ugly, that's why I post here, maybe somebody will come up with something 
better.
The idea is - if i have to load a module &quot;my_module&quot;, which is at /path/to/my_files,
don't load it as my_module, but as path_to_my_files_my_module
That way, modules with same names will be assigned different names in sys.modules and won't
get reloaded all the time.

It's as using 
from path.to.my.files imort my_module as path_to_my_files_my_module
instead of
from path.to.my.files imort my_module

Modules loaded with import_module are usually used by pointers, not by symbolic names so, as for
me, it's ok to load it with a different name.

my mod_python/apache.py import_module() now looks like this:

def import_module(module_name, autoreload=1, log=0, path=None):
    &quot;&quot;&quot;
    Get the module to handle the request. If
    autoreload is on, then the module will be reloaded
    if it has changed since the last import.
    &quot;&quot;&quot;
    
    parts = module_name.split('.')    
    if path:
      path2 = '_'.join(path).replace('/','_').replace('.','_').replace('-','_')[1:] + '_'
      mn = path2 + module_name
    else:
      mn = module_name

    # (Re)import
    import sys
    if sys.modules.has_key(mn):
        module = sys.modules[mn]
    else:
        
        _apache.log_error('Has to load: '+str(mn)+ '('+str(module_name)+')', APLOG_NOERRNO|APLOG_NOTICE)
       
        for i in range(len(parts)):
            mname = &quot;.&quot;.join(parts[:i+1])
            f, p, d = imp.find_module(parts[i], path)
            try:
                _apache.log_error('Loading: '+mname, APLOG_NOERRNO|APLOG_NOTICE)
                module = imp.load_module(mname, f, p, d)
        
            finally:
                if f: f.close()
            if hasattr(module, &quot;__path__&quot;):
                path = module.__path__

        # dark magic
        if mn:
          if mn != mname:
            t = sys.modules.keys()
            t.sort()
            _apache.log_error('Current load: '+str(t), APLOG_NOERRNO|APLOG_NOTICE)
            _apache.log_error('Switching: '+mname+' &lt;-&gt; '+mn, APLOG_NOERRNO|APLOG_NOTICE)
            sys.modules[mn] = sys.modules[mname]
            del(sys.modules[mname])
  
            t = sys.modules.keys()
            t.sort()
            _apache.log_error('After switch: '+str(t), APLOG_NOERRNO|APLOG_NOTICE)

    return module

-------------------------------------------------------------------------------
<A HREF="http://www.one.lv">http://www.one.lv</A> - Tavs mobilais e-pasts!

Tagad lasi savu e-pastu ar mobilo telefonu - wap.one.lv!
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016020.html">[mod_python] mptest.py testing failed
</A></li>
	<LI>Next message: <A HREF="016025.html">[mod_python] Stopping Reimports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16023">[ date ]</a>
              <a href="thread.html#16023">[ thread ]</a>
              <a href="subject.html#16023">[ subject ]</a>
              <a href="author.html#16023">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
