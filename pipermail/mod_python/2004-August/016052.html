<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] The right way to handle sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20The%20right%20way%20to%20handle%20sessions&In-Reply-To=411BFA73.3090805%40apnic.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016047.html">
   <LINK REL="Next"  HREF="016057.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] The right way to handle sessions</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Amir Salihefendic</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20The%20right%20way%20to%20handle%20sessions&In-Reply-To=411BFA73.3090805%40apnic.net"
       TITLE="[mod_python] The right way to handle sessions">amix at amix.dk
       </A><BR>
    <I>Fri Aug 13 14:30:23 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="016047.html">[mod_python] The right way to handle sessions
</A></li>
        <LI>Next message: <A HREF="016057.html">[mod_python] The right way to handle sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16052">[ date ]</a>
              <a href="thread.html#16052">[ thread ]</a>
              <a href="subject.html#16052">[ subject ]</a>
              <a href="author.html#16052">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks a lot for your time spent on the reply, I appreciate it.

&quot;Under what circumstances do you call createSession() instead of 
getSameSession()?&quot;

Let's take another example:
I am making a blog-system where I need to have an admin section. I am 
using the publisher handler.
Simple forms post username and password to admin.py
Admin.py has an index function, which has username and password as 
input.
In the index function I check if the username and password match, if 
they do I create an session and store username and password.
Now, I need to redirect to a new function viewPosts (it's also located 
in the admin module).

In viewPosts I have to check if the right session is set - else 
somebody could do admin.py/viewPosts and get access to the admin 
section.

Of course, I could solve problem in many other ways:
- Send the SID to viewPosts
- Place everything in one function (i.e. place everything in 
admin.py/index)
- &quot;Append&quot; the session to the req object
- Make viewPosts private (i.e. do _viewPosts) and then I can only 
access it by going through admin.py/index
-etc.

Anyway, I am interested in knowing: What is the smartest way to 
&quot;share&quot;/access same session across functions (i.e. when you are 
internal &quot;redirecting&quot;)? Example of what I mean by &quot;redirecting&quot; (not 
working...):
def createSession(req):
     new_session = Session.Session(req)
     return getSameSession(req)

def getSameSession(req):
     same_session = Session.Session(req)
     return same_session.id()


My guess is to send the SID (working). This seems to be a very light 
and easy approach:
def createSession(req):
     new_session = Session.Session(req)
     new_session.unlock()

     #Check id
     req.write(new_session.id())

     return getSameSession(req, new_session.id())

def getSameSession(req, SID):
     same_session = Session.Session(req, SID)

     #Check id
     req.write(&quot;\n%s\n&quot; % same_session.id())

     return &quot;Done&quot;

(This is a solution I use now.) Of course this is very simplified 
example...

Med venlig hilsen / Kind regards
Amir Salihefendic
-----
What we do in life echoes in eternity
Den 13/8-2004, kl. 1.17, skrev Byron Ellacott:

&gt;<i> Amir Salihefendic wrote:
</I>&gt;&gt;<i> I welcome myself to this list ;-)
</I>&gt;<i>
</I>&gt;<i> Welcome!
</I>&gt;<i>
</I>&gt;<i> [working example]
</I>&gt;&gt;<i> def createSession(req):
</I>&gt;&gt;<i> def getSameSession(req):
</I>&gt;<i>
</I>&gt;<i> The important thing to note here is that the code is identical in both 
</I>&gt;<i> calls.  That is, if you call Session.Session(req) with no session ID 
</I>&gt;<i> in cookies, or the existing session ID has no matching session stored 
</I>&gt;<i> on disk, a new session ID is generated.
</I>&gt;<i>
</I>&gt;<i> But, the session is /not/ written to disk.
</I>&gt;<i>
</I>&gt;&gt;<i> def createSession(req):
</I>&gt;&gt;<i>     return getSameSession(req)
</I>&gt;&gt;<i> def getSameSession(req):
</I>&gt;&gt;<i>     return same_session.id()
</I>&gt;<i>
</I>&gt;<i> So when you change to calling getSameSession() from createSession() 
</I>&gt;<i> you are in fact creating /two/ sessions.  My guess would be that your 
</I>&gt;<i> apparent infinite loop is in fact a deadlock, caused by the fact that 
</I>&gt;<i> your second created session will be reusing the session ID created by 
</I>&gt;<i> the first one, and then attempting to establish a global lock on that 
</I>&gt;<i> session ID.  Bad.
</I>&gt;<i>
</I>&gt;&gt;<i> This does not work - it makes an infinitive loop..!  Now to fix this 
</I>&gt;&gt;<i> you need to unlock the session in createSession (.. I have no clue 
</I>&gt;&gt;<i> why you have to do this..?). And then you need to restart apache...  
</I>&gt;&gt;<i> i.e.:
</I>&gt;<i>
</I>&gt;<i> This bears up my analysis well.  The locking done by the Session 
</I>&gt;<i> module is an Apache-wide lock on the session ID.  So, when 
</I>&gt;<i> createSession() first creates a session, it locks that sid.  Then, it 
</I>&gt;<i> calls getSameSession() which attempts to lock the same sid.  The lock 
</I>&gt;<i> call blocks here, waiting for the first lock to be released, but that 
</I>&gt;<i> release will never come.  If you cause the first created session to 
</I>&gt;<i> unlock itself, you will not create a deadlock, but you will need to 
</I>&gt;<i> restart apache to break an existing deadlock.
</I>&gt;<i>
</I>&gt;&gt;<i> But this does not work quite well.. If you delete the Session:
</I>&gt;&gt;<i> And then you do this:
</I>&gt;&gt;<i> First time the id's aren't same - after that they are the same.
</I>&gt;<i>
</I>&gt;<i> When a session has been deleted, it is marked as invalid and calling 
</I>&gt;<i> .load() on that sid will fail.  .__init__() will create a new sid if 
</I>&gt;<i> .load() fails for an existing one, so I suspect you are seeing this 
</I>&gt;<i> behaviour.
</I>&gt;<i>
</I>&gt;<i> Overall, it seems you are making the session management process far 
</I>&gt;<i> more complicated than it needs to be.  Under what circumstances do you 
</I>&gt;<i> call createSession() instead of getSameSession() ?
</I>&gt;<i>
</I>&gt;<i> I am successfully using the Session module to handle an HTML forms 
</I>&gt;<i> based login system:
</I>&gt;<i>
</I>&gt;<i> session = Session.Session(req)
</I>&gt;<i> if NeedAuth and not session.has_key('username'):
</I>&gt;<i>     redirect(AuthPage)
</I>&gt;<i> ServePage(req)
</I>&gt;<i> session.save()
</I>&gt;<i> return apache.OK
</I>&gt;<i>
</I>&gt;<i> This is a simplification, since I use an extensible application object 
</I>&gt;<i> that allows you to change how sessions are generated and how users are 
</I>&gt;<i> authenticated, but it boils down to the above.  I create a new session 
</I>&gt;<i> or get an existing session.  I do not care which.  If the page being 
</I>&gt;<i> requested needs auth, but the session doesn't contain a username key, 
</I>&gt;<i> I redirect[1] to the login page, which stores the username value into 
</I>&gt;<i> the session if the user presents the right credentials.  Otherwise, I 
</I>&gt;<i> serve the requested page, then save the session, and Bob's a builder.
</I>&gt;<i>
</I>&gt;<i> Note that I cannot distinguish between an expired session and no 
</I>&gt;<i> session at all, but this is a limitation of the Session module.  I can 
</I>&gt;<i> distinguish between a new session and an existing session by calling 
</I>&gt;<i> session.is_new(), but that distinction turns out not to be very 
</I>&gt;<i> important.
</I>&gt;<i>
</I>&gt;<i> At some point, I will need to extract the sid from the cookie set 
</I>&gt;<i> myself, to be able to distinguish between a timed out session, an 
</I>&gt;<i> invalidated session, a missing session and a brand new session.  (Or 
</I>&gt;<i> else I'll have to patch the Session module, which I'm not real keen to 
</I>&gt;<i> do.)
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i> bje
</I>&gt;<i>
</I>&gt;<i> [1] The 'redirects' I do are simply changing what view my code 
</I>&gt;<i> believes it is processing, so execution continues down the line, and 
</I>&gt;<i> session.save() is called in due order.  If you're using an Apache 
</I>&gt;<i> internal redirect or a 302/303 redirect, you should ensure new 
</I>&gt;<i> sessions are saved as soon as created with &quot;if session.is_new(): 
</I>&gt;<i> session.save()&quot;.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016047.html">[mod_python] The right way to handle sessions
</A></li>
	<LI>Next message: <A HREF="016057.html">[mod_python] The right way to handle sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16052">[ date ]</a>
              <a href="thread.html#16052">[ thread ]</a>
              <a href="subject.html#16052">[ subject ]</a>
              <a href="author.html#16052">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
