From grahamd at dscpl.com.au  Fri Apr  1 06:18:21 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Fri Apr  1 06:18:30 2005
Subject: [mod_python] Internal redirect does not end processing and
	session is not saved on internal redirect - mpservlets
In-Reply-To: <42489712.30206@mischko.com>
References: <4248516F.3090903@mischko.com> <42489712.30206@mischko.com>
Message-ID: <45f6304547163e0843994176a445f63c@dscpl.com.au>

A delayed response. :-)

> Scott Chapman wrote:
>
>> Here's my uberServlet which demonstrates this "interesting" behavior. 
>>  If I use the external redirect and comment out the internal 
>> redirect, everything works perfectly.
>>
>> Note that I have changed mpservlets to call prep BEFORE auth.  This 
>> makes better sense to me.

It is never a good idea to change third party pages in a way that makes
yours different to everyone else. If you ever upgrade and forget the
change you had made you will break your own code.

Also, the "auth()" method provided with mpservlets is there specifically
for dealing with HTTP basic authentication and it doesn't look to me 
like
it is intended that it be overridden to substitute your own 
authentication
mechanism. That it is called before any session creation makes it hard 
to
do that anyway.

Rather than swap the order of "auth()" and "prep()" you would have been
better off simply doing your authentication and session management 
within
the scope of "respond()" and ignore the existing "auth()" method. Ie.,

   def respond(self):
     self.myauth()
     self.myrespond()

Where "myauth()" contains the code currently in your "auth()" and 
"myrespond()"
containing the code currently in your "respond()".

Do it that way and you don't have to fiddle the mpservlets code.

On 29/03/2005, at 9:45 AM, Scott Chapman wrote:

> I'm not sure how to transfer the session to the internal redirect at 
> this point.  It would be nice if that worked because I'm pretty sure 
> I'll need it later.  This is a brand new session and no cookie has 
> been sent to the browser at the time of the internal redirect so 
> things don't work very well there.  How should I transfer the session 
> to the internally redirected URI?

You can't transfer any new session through to a handler triggered as a 
result
of an internal redirection, AFAIK it must be bounced back to the 
browser in some
way.

There are other restrictions on using internal redirection as well 
which mean
it isn't the magic pill some might think it is.

First, you can't stash data in the req object and have it passed 
through the
internal redirect because only the original Apache req object core is 
passed
through.

Second, if the top level servlet handler has already processed the form
parameters, ie. with util.FieldStorage, and the form request was 
performed
as a POST, the handler triggered by the redirection will not be able to
access the form parameters. This is because util.FieldStorage has 
already
consumed all the request content, it can't be done a second time and the
first form object can't be passed through the req object. This problem
affects mod_python.publisher and mpservlets.

Third, (from memory) if the original URL mapped to a physical directory 
and
was a POST request, when an internal redirection is done it magically 
turns
into a GET request and even if the top level handler didn't process the
form data, the sub handler can't get to the form data as 
util.FieldStorage
thinks it was a GET request and not the POST request it was. This issue
came up sometime in the last month and I think that was what the outcome
was.

Anyway, hope this might make you think twice about relying too much on 
internal
redirections, at least in a system where some amount of processing is 
done
prior to the actual redirection. :-)

Graham

From donniejones18 at gmail.com  Fri Apr  1 13:14:34 2005
From: donniejones18 at gmail.com (donnie jones)
Date: Fri Apr  1 13:14:36 2005
Subject: [mod_python] Session always timeouts using XMLHttpRequest.
Message-ID: <ff876008050401101414935f73@mail.gmail.com>

Hello,

I am using modpython and my html uses an XMLHttpRequest from
javascript to call to the python script with the req publisher to load
the html into a particular part of the page.

But I am having problems because my session never gets the
sess.last_accessed updated
and it always timeouts(expires the session).  I am not sure why this
is happening...

Example code:
#######################
def testFunction(req, sid=""):
    sess = Session(req, sid, None, 30);
        if sess.is_new():
            req.write("""<p>Session expired, please \
            <a href="login.html">click here to relogin.</a></p>""");
       else:
           sess.load();
           u=sess['u'];
           p=sess['p'];
           sess.save();
           req.write("Welcome user: %s" %u);
           req.write("cookie: %s<br/>" % Cookie.get_cookies(req)['pysid']);
           req.write("sid: %s<br/>" % sess.id());
           req.write("last: %s<br/>" % sess.last_accessed());
########################
I intentionally have a very short timeout period of 30 seconds to make
testing easier...
The sid defaults to sid="" from the function call since I am not
passing the sid.
Each time I print out the sid and the pysid from the cookie they match, but as
mentioned last_accessed() never changes.
Any help would be grealy appreciated.

Thank you.
__
Donnie
From unselfishly at gmail.com  Sat Apr  2 20:10:32 2005
From: unselfishly at gmail.com (Keerati Inochanon)
Date: Sat Apr  2 20:10:33 2005
Subject: [mod_python] KeyError Exception when doing
	sys.modules[class.__module__] (vampire?)
Message-ID: <b16e3ab705040217102760acef@mail.gmail.com>

Hi,

I'm getting this exception:
Mod_python error: "PythonHandler vampire"

Traceback (most recent call last):

  File "/usr/lib/python2.3/site-packages/mod_python/apache.py", line
299, in HandlerDispatch
    result = object(req)

  File "/usr/lib/python2.3/site-packages/vampire/lookup.py", line 641,
in _handler
    result = _execute(req,objects[-1])

  File "/usr/lib/python2.3/site-packages/vampire/lookup.py", line 445,
in _execute
    return object(**args)

  File "/home/www/testing/upload.py", line 56, in handler
    FileHandler.processUpload(filename, destination)

  File "/home/www/testing/modules/FileHandler.py", line 149, in processUpload
    def getFileHandler(filename, module=sys.modules[FileHandler.__module__]):

KeyError: '_vampire_c5f8def7c7c8bbf5b9d75d365a5bbe67_37'
--

I'm not sure this it is related to vampire or not, but it seems to
happen when I do module loading through vampire. I tried to run the
same code with python import, and the code was running fine.

Here is my code snippet:

FileHandler.py:
------------------------------
import os
import sys
import vampire

config = vampire.loadConfig(__req__, ".vampire")
directory = config.get("Modules", "common")
SessionManagement = vampire.importModule("SessionManagement", directory)
Settings = vampire.importModule("Settings", directory, __req__)

class FileHandler:
...
...
...

class XYZFileHandler:
...
...
...

def processUpload(filename, directory):
  "Process the user-uploaded files"

  def getFileHandler(filename, module=sys.modules[FileHandler.__module__]):
    "Return the file handler class according to the file extension"
    
    subclass = "%sFileHandler" % os.path.splitext(filename)[1].upper()[1:]
    return hasattr(module, subclass) and getattr(module, subclass) or
FileHandler
  
  getFileHandler(filename)(filename, directory)
------------------------------------------------
upload.py:
from mod_python import apache, util
from mod_python.Session import Session
import vampire
import os

config = vampire.loadConfig(__req__, ".vampire")
directory = config.get("Modules", "common")
SessionManagement = vampire.importModule("SessionManagement", directory)
Settings = vampire.importModule("Settings", directory)
FileHandler = vampire.importModule("FileHandler", directory, __req__)
Utility = vampire.importModule("Utility", directory, __req__)

def handler(req, **kwargs):
...
...
  FileHandler.processUpload(filename, destination)
...
...

---------------------------------------------------
What am I doing wrong? Please let me know if you need more
information. Thank you very much in advance.

Best regards,
Keerati Inochanon
From grahamd at dscpl.com.au  Sat Apr  2 20:25:47 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Apr  2 20:25:56 2005
Subject: [mod_python] KeyError Exception when doing
	sys.modules[class.__module__] (vampire?)
In-Reply-To: <b16e3ab705040217102760acef@mail.gmail.com>
References: <b16e3ab705040217102760acef@mail.gmail.com>
Message-ID: <9c0c3d82cd611db7a2d9334fc303fd96@dscpl.com.au>

Vampire doesn't use the "imp" module for doing imports and as such the 
imported
modules do not appear in sys.modules.

What exactly are you trying to do? Am a bit concerned about the way you 
might
be doing things as it may cause problems with automatic module 
reloading. If
you can give an english description of what you want to do, may be able 
to
suggest a more appropriate way of doing it.

That said, you can probably say:

   module = 
vampire.ModuleCache().moduleInfo(FileHandler.__module__).module

On 03/04/2005, at 11:10 AM, Keerati Inochanon wrote:

> Hi,
>
> I'm getting this exception:
> Mod_python error: "PythonHandler vampire"
>
> Traceback (most recent call last):
>
>   File "/usr/lib/python2.3/site-packages/mod_python/apache.py", line
> 299, in HandlerDispatch
>     result = object(req)
>
>   File "/usr/lib/python2.3/site-packages/vampire/lookup.py", line 641,
> in _handler
>     result = _execute(req,objects[-1])
>
>   File "/usr/lib/python2.3/site-packages/vampire/lookup.py", line 445,
> in _execute
>     return object(**args)
>
>   File "/home/www/testing/upload.py", line 56, in handler
>     FileHandler.processUpload(filename, destination)
>
>   File "/home/www/testing/modules/FileHandler.py", line 149, in 
> processUpload
>     def getFileHandler(filename, 
> module=sys.modules[FileHandler.__module__]):
>
> KeyError: '_vampire_c5f8def7c7c8bbf5b9d75d365a5bbe67_37'
> --
>
> I'm not sure this it is related to vampire or not, but it seems to
> happen when I do module loading through vampire. I tried to run the
> same code with python import, and the code was running fine.
>
> Here is my code snippet:
>
> FileHandler.py:
> ------------------------------
> import os
> import sys
> import vampire
>
> config = vampire.loadConfig(__req__, ".vampire")
> directory = config.get("Modules", "common")
> SessionManagement = vampire.importModule("SessionManagement", 
> directory)
> Settings = vampire.importModule("Settings", directory, __req__)
>
> class FileHandler:
> ...
> ...
> ...
>
> class XYZFileHandler:
> ...
> ...
> ...
>
> def processUpload(filename, directory):
>   "Process the user-uploaded files"
>
>   def getFileHandler(filename, 
> module=sys.modules[FileHandler.__module__]):
>     "Return the file handler class according to the file extension"
>
>     subclass = "%sFileHandler" % 
> os.path.splitext(filename)[1].upper()[1:]
>     return hasattr(module, subclass) and getattr(module, subclass) or
> FileHandler
>
>   getFileHandler(filename)(filename, directory)
> ------------------------------------------------
> upload.py:
> from mod_python import apache, util
> from mod_python.Session import Session
> import vampire
> import os
>
> config = vampire.loadConfig(__req__, ".vampire")
> directory = config.get("Modules", "common")
> SessionManagement = vampire.importModule("SessionManagement", 
> directory)
> Settings = vampire.importModule("Settings", directory)
> FileHandler = vampire.importModule("FileHandler", directory, __req__)
> Utility = vampire.importModule("Utility", directory, __req__)
>
> def handler(req, **kwargs):
> ...
> ...
>   FileHandler.processUpload(filename, destination)
> ...
> ...
>
> ---------------------------------------------------
> What am I doing wrong? Please let me know if you need more
> information. Thank you very much in advance.
>
> Best regards,
> Keerati Inochanon
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From grahamd at dscpl.com.au  Sat Apr  2 20:30:36 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Apr  2 20:30:42 2005
Subject: [mod_python] KeyError Exception when doing
	sys.modules[class.__module__] (vampire?)
In-Reply-To: <b16e3ab705040217102760acef@mail.gmail.com>
References: <b16e3ab705040217102760acef@mail.gmail.com>
Message-ID: <346a824ee2c240831ddbf53b7818623a@dscpl.com.au>


On 03/04/2005, at 11:10 AM, Keerati Inochanon wrote:

> def processUpload(filename, directory):
>   "Process the user-uploaded files"
>
>   def getFileHandler(filename, 
> module=sys.modules[FileHandler.__module__]):
>     "Return the file handler class according to the file extension"
>
>     subclass = "%sFileHandler" % 
> os.path.splitext(filename)[1].upper()[1:]
>     return hasattr(module, subclass) and getattr(module, subclass) or
> FileHandler
>
>   getFileHandler(filename)(filename, directory)

How about using "globals()" instead of trying to get access to the 
module.

def processUpload(filename, directory):
   "Process the user-uploaded files"

   def getFileHandler(filename):
     "Return the file handler class according to the file extension"

     subclass = "%sFileHandler" % 
os.path.splitext(filename)[1].upper()[1:]
     return globals().get(subclass,FileHandler)

   getFileHandler(filename)(filename, directory)

Think I worked out what you were trying to do.

From unselfishly at gmail.com  Sat Apr  2 21:39:55 2005
From: unselfishly at gmail.com (Keerati Inochanon)
Date: Sat Apr  2 21:39:57 2005
Subject: [mod_python] KeyError Exception when doing
	sys.modules[class.__module__] (vampire?)
In-Reply-To: <346a824ee2c240831ddbf53b7818623a@dscpl.com.au>
References: <b16e3ab705040217102760acef@mail.gmail.com>
	<346a824ee2c240831ddbf53b7818623a@dscpl.com.au>
Message-ID: <b16e3ab705040218391d71407e@mail.gmail.com>

Hi,

Thank you very much for the fast response. I was trying to get a
reference to the object based on name, as I found in the Dive Into
Python tutorial:
http://www.diveintopython.org/file_handling/more_on_modules.html.

It seems that using globals() will also a give similar result. I think
that will work too. Thank you very much! I appreciate it.

Best regards,
Keerati Inochanon

On Apr 2, 2005 8:30 PM, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> 
> On 03/04/2005, at 11:10 AM, Keerati Inochanon wrote:
> 
> > def processUpload(filename, directory):
> >   "Process the user-uploaded files"
> >
> >   def getFileHandler(filename,
> > module=sys.modules[FileHandler.__module__]):
> >     "Return the file handler class according to the file extension"
> >
> >     subclass = "%sFileHandler" %
> > os.path.splitext(filename)[1].upper()[1:]
> >     return hasattr(module, subclass) and getattr(module, subclass) or
> > FileHandler
> >
> >   getFileHandler(filename)(filename, directory)
> 
> How about using "globals()" instead of trying to get access to the
> module.
> 
> def processUpload(filename, directory):
>    "Process the user-uploaded files"
> 
>    def getFileHandler(filename):
>      "Return the file handler class according to the file extension"
> 
>      subclass = "%sFileHandler" %
> os.path.splitext(filename)[1].upper()[1:]
>      return globals().get(subclass,FileHandler)
> 
>    getFileHandler(filename)(filename, directory)
> 
> Think I worked out what you were trying to do.
> 
>
From kevin.roberts at nunatak.com.au  Mon Apr  4 01:51:13 2005
From: kevin.roberts at nunatak.com.au (Kevin Roberts)
Date: Mon Apr  4 01:51:05 2005
Subject: [mod_python] XP Authentication problems over Apache and WebDAV
Message-ID: <004801c538da$4f87c110$0700a8c0@gollum>

Skipped content of type multipart/alternative-------------- next part --------------
No virus found in this outgoing message.
Checked by AVG Anti-Virus.
Version: 7.0.308 / Virus Database: 266.9.1 - Release Date: 1/04/2005
From kevin.roberts at nunatak.com.au  Mon Apr  4 01:56:30 2005
From: kevin.roberts at nunatak.com.au (Kevin Roberts)
Date: Mon Apr  4 01:56:22 2005
Subject: [mod_python] XP Authentication problems over Apache and WebDAV
Message-ID: <006a01c538db$0c7c6780$0700a8c0@gollum>

Hi All,

I'm interested to know if there is a solution to my problem, when trying to 
access WEBDAV folders on my Apache 1.3 server when using XP (SP2) Webfolders 
as the client.

There is a well known problem with XP (SP2) when authenticating over 
Webfolders as: "When Microsoft Windows XP attempts to connect to a webdav 
server, it insanely refuses to just send the username and password. It 
attempts to send either "domainlusername" or username@domain.
( a good description of the problem and fix for simple Basic authentication 
can be found at:
http://www.luluware.com/index.php?option=com_content&task=view&id=13&Itemid=38

I am using mod_python for my 'Basic' authentication as I want to communicate 
with my Server to find individual permissions on files and folders which are 
contained within the twistd python server that I have running on the box.
mod_python communication with my server is essential for my application and 
works well with ALL other clients, only falling over for Webfolders and XP 
(SP2).

I have tried numerous fixes including:
http://www.luluware.com/index.php?option=com_content&task=view&id=13&Itemid=38
http://www.hss.caltech.edu/help/unix/admin/web/apache-webdav-xp
(these two should give a good description of the problem)
and even desperately : - /
http://support.microsoft.com/default.aspx?scid=kb;en-us;841215
reistary hacking on the client machine.

But to no avail...
I assume that the above fixes are 'specifically' for simple 'Basic 
authentication' and will not work with mod_python as mod_python takes over 
control of Apaches layered request model ? (best guess)

But then again it could well be that my server is running...
Debian (Sarge - testing)
apache         1.3.33-3
libapache-mod-dav 1.0.3-9
libapache-mod-python 2.7.10-3

Has anybody come across the problem before ?
Is there a simple way within my python authentication script to rewirte the 
headers that XP sends to stip off the domainname part of the request?

Thanks

Kevin Roberts
Nunatak Systems Pty Ltd
http://www.nunatak.com.au/


PARTIAL APACHE CONFIGURATION
----

<VirtualHost>
...
DAVLockDB /opt/nunatak/software/web/smeagol/DAVLock
...
        AllowOverride Options
        Options +Indexes
        AddHandler mod_python .py
        PythonAuthenHandler gane_auth
        PythonOption Provider Nunatak
        PythonOption Customer smeagol
        PythonDebug On
        AuthType Basic
        AuthName "Smeagol's Webfolders"

        Dav On
        Require valid-user
...
</VirtualHost> 



-- 
No virus found in this outgoing message.
Checked by AVG Anti-Virus.
Version: 7.0.308 / Virus Database: 266.9.1 - Release Date: 1/04/2005

From grahamd at dscpl.com.au  Mon Apr  4 03:00:52 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Mon Apr  4 03:00:53 2005
Subject: [mod_python] XP Authentication problems over Apache and WebDAV
Message-ID: <1112598052.5640@dscpl.user.openhosting.com>

If you are using req.get_basic_auth_pw() and req.user, and the problem
is that it isn't coping with the particular format of the request header
then consider writing your own code to parse the header and thus deal
with any inconsistencies. You can get an idea of how to do it by looking
at the implementation of:

  mod_python.publisher.process_auth()

Online copy can be viewed at:

   https://svn.apache.org/repos/asf/httpd/mod_python/trunk/lib/python/mod_python/publisher.py

Is that helpful, or have I guessed wrongly about what the problem is?

Graham

Kevin Roberts wrote ..
> Hi All,
> 
> I'm interested to know if there is a solution to my problem, when trying
> to 
> access WEBDAV folders on my Apache 1.3 server when using XP (SP2) Webfolders
> as the client.
> 
> There is a well known problem with XP (SP2) when authenticating over 
> Webfolders as: "When Microsoft Windows XP attempts to connect to a webdav
> server, it insanely refuses to just send the username and password. It
> attempts to send either "domainlusername" or username@domain.
> ( a good description of the problem and fix for simple Basic authentication
> can be found at:
> http://www.luluware.com/index.php?option=com_content&task=view&id=13&Itemid=38
> 
> I am using mod_python for my 'Basic' authentication as I want to communicate
> with my Server to find individual permissions on files and folders which
> are 
> contained within the twistd python server that I have running on the box.
> mod_python communication with my server is essential for my application
> and 
> works well with ALL other clients, only falling over for Webfolders and
> XP 
> (SP2).
> 
> I have tried numerous fixes including:
> http://www.luluware.com/index.php?option=com_content&task=view&id=13&Itemid=38
> http://www.hss.caltech.edu/help/unix/admin/web/apache-webdav-xp
> (these two should give a good description of the problem)
> and even desperately : - /
> http://support.microsoft.com/default.aspx?scid=kb;en-us;841215
> reistary hacking on the client machine.
> 
> But to no avail...
> I assume that the above fixes are 'specifically' for simple 'Basic 
> authentication' and will not work with mod_python as mod_python takes over
> control of Apaches layered request model ? (best guess)
> 
> But then again it could well be that my server is running...
> Debian (Sarge - testing)
> apache         1.3.33-3
> libapache-mod-dav 1.0.3-9
> libapache-mod-python 2.7.10-3
> 
> Has anybody come across the problem before ?
> Is there a simple way within my python authentication script to rewirte
> the 
> headers that XP sends to stip off the domainname part of the request?
> 
> Thanks
> 
> Kevin Roberts
> Nunatak Systems Pty Ltd
> http://www.nunatak.com.au/
> 
> 
> PARTIAL APACHE CONFIGURATION
> ----
> 
> <VirtualHost>
> ...
> DAVLockDB /opt/nunatak/software/web/smeagol/DAVLock
> ...
>         AllowOverride Options
>         Options +Indexes
>         AddHandler mod_python .py
>         PythonAuthenHandler gane_auth
>         PythonOption Provider Nunatak
>         PythonOption Customer smeagol
>         PythonDebug On
>         AuthType Basic
>         AuthName "Smeagol's Webfolders"
> 
>         Dav On
>         Require valid-user
> ...
> </VirtualHost> 
> 
> 
> 
> -- 
> No virus found in this outgoing message.
> Checked by AVG Anti-Virus.
> Version: 7.0.308 / Virus Database: 266.9.1 - Release Date: 1/04/2005
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
From davin at wordpainter.net  Mon Apr  4 03:23:46 2005
From: davin at wordpainter.net (Davin Boling)
Date: Mon Apr  4 03:23:32 2005
Subject: [mod_python] XP Authentication problems over Apache and WebDAV
In-Reply-To: <004801c538da$4f87c110$0700a8c0@gollum>
References: <004801c538da$4f87c110$0700a8c0@gollum>
Message-ID: <4250EB82.4060603@wordpainter.net>

Kevin Roberts wrote:

> Hi All,
>  
> I'm interested to know if there is a solution to my problem, when trying 
> to access WEBDAV folders on my Apache 1.3 server when using XP (SP2) 
> Webfolders as the client.
>  

(snip)

I know well the problem you're speaking of, and it isn't specific to SP2 
either as it's present on my SP1 box as well. I know two ways of 
"tricking" the MS WebDAV driver into sending the proper authentication 
headers, but failing those you should fall back on Graham's advice. 
That's how I would do it as well, and he's far more experienced than I 
am at that particular method so I'll leave the technical details to him.


Try recreating the Web Folder with one of the following URLs and see of 
it fixes your problem. (keep the "redirect-carefully" stuff in your 
Apache config though)

1) Trailing hash method: http://yourdomain.net/webdav/path/#
2) Port-80 method: http://yourdomain.net:80/webdav/path/


I'm also going to warn you, even if you can get around the 
authentication problem there's still a chance that it won't work 
perfectly. I don't know what causes it exactly, but on some 
configurations (like my home PC, sigh) the web folder will have an 
extremely long delay when opened. Checking the Apache log reveals a few 
PROPFIND requests...after 10 minutes or so the window will either 
display contents finally, or lock up for good.

That much I can't help you with, and you'll need to persue further 
assistance with another mailing list. And if you do figure out what 
causes that specific problem, PLEASE let me know in a personal e-mail. :D


From donniejones18 at gmail.com  Tue Apr  5 08:55:09 2005
From: donniejones18 at gmail.com (donnie jones)
Date: Tue Apr  5 08:55:11 2005
Subject: [mod_python] Re: Session always timeouts using XMLHttpRequest.
In-Reply-To: <ff876008050401101414935f73@mail.gmail.com>
References: <ff876008050401101414935f73@mail.gmail.com>
Message-ID: <ff876008050405055520083cb@mail.gmail.com>

Any ideas of things to try to fix this problem?
Thank you.
__
Donnie


On Fri, 1 Apr 2005 13:14:34 -0500, donnie jones <donniejones18@gmail.com> wrote:
> Hello,
> 
> I am using modpython and my html uses an XMLHttpRequest from
> javascript to call to the python script with the req publisher to load
> the html into a particular part of the page.
> 
> But I am having problems because my session never gets the
> sess.last_accessed updated
> and it always timeouts(expires the session).  I am not sure why this
> is happening...
> 
> Example code:
> #######################
> def testFunction(req, sid=""):
>     sess = Session(req, sid, None, 30);
>         if sess.is_new():
>             req.write("""<p>Session expired, please \
>             <a href="login.html">click here to relogin.</a></p>""");
>        else:
>            sess.load();
>            u=sess['u'];
>            p=sess['p'];
>            sess.save();
>            req.write("Welcome user: %s" %u);
>            req.write("cookie: %s<br/>" % Cookie.get_cookies(req)['pysid']);
>            req.write("sid: %s<br/>" % sess.id());
>            req.write("last: %s<br/>" % sess.last_accessed());
> ########################
> I intentionally have a very short timeout period of 30 seconds to make
> testing easier...
> The sid defaults to sid="" from the function call since I am not
> passing the sid.
> Each time I print out the sid and the pysid from the cookie they match, but
> as
> mentioned last_accessed() never changes.
> Any help would be grealy appreciated.
> 
> Thank you.
> __
> Donnie
>
From nicolas.lehuen at gmail.com  Tue Apr  5 09:09:05 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Tue Apr  5 09:09:07 2005
Subject: [mod_python] Re: Session always timeouts using XMLHttpRequest.
In-Reply-To: <ff876008050405055520083cb@mail.gmail.com>
References: <ff876008050401101414935f73@mail.gmail.com>
	<ff876008050405055520083cb@mail.gmail.com>
Message-ID: <c298f2d705040506092624439f@mail.gmail.com>

Are you sure your client-side XMLHttpRequest object correctly handles
cookies and send them to the server ? If not, then you're out of luck.
You could try passing the session id as an URL parameter, though. In
any case, this is a client-side problem, not one in mod_python.

Regards,

Nicolas

On Apr 5, 2005 2:55 PM, donnie jones <donniejones18@gmail.com> wrote:
> 
> Any ideas of things to try to fix this problem?
> Thank you.
> __
> Donnie
> 
> 
> On Fri, 1 Apr 2005 13:14:34 -0500, donnie jones <donniejones18@gmail.com> wrote:
> > Hello,
> >
> > I am using modpython and my html uses an XMLHttpRequest from
> > javascript to call to the python script with the req publisher to load
> > the html into a particular part of the page.
> >
> > But I am having problems because my session never gets the
> > sess.last_accessed updated
> > and it always timeouts(expires the session).  I am not sure why this
> > is happening...
> >
> > Example code:
> > #######################
> > def testFunction(req, sid=""):
> >     sess = Session(req, sid, None, 30);
> >         if sess.is_new():
> >             req.write("""<p>Session expired, please \
> >             <a href="login.html">click here to relogin.</a></p>""");
> >        else:
> >            sess.load();
> >            u=sess['u'];
> >            p=sess['p'];
> >            sess.save();
> >            req.write("Welcome user: %s" %u);
> >            req.write("cookie: %s<br/>" % Cookie.get_cookies(req)['pysid']);
> >            req.write("sid: %s<br/>" % sess.id());
> >            req.write("last: %s<br/>" % sess.last_accessed());
> > ########################
> > I intentionally have a very short timeout period of 30 seconds to make
> > testing easier...
> > The sid defaults to sid="" from the function call since I am not
> > passing the sid.
> > Each time I print out the sid and the pysid from the cookie they match, but
> > as
> > mentioned last_accessed() never changes.
> > Any help would be grealy appreciated.
> >
> > Thank you.
> > __
> > Donnie
> >
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From Tom.Holden at ascendview.com  Tue Apr  5 12:28:43 2005
From: Tom.Holden at ascendview.com (Tom Holden)
Date: Tue Apr  5 12:28:51 2005
Subject: [mod_python] Custom Logging in Apache 2.0.53 with Mod_Python
Message-ID: <64819F4B3A2D7D489D12A2B03A77F99A0107C2@avenger.Ascendview.local>

I'm Tom Holden at http://www.ascendview.com

I want to do custom Apache for Win logging with Python.  I want to send
"Access" data from Apache out a socket.  

First step is the ability to gather "Access" data from Apache.   The
stuff that would be sent to a "CustomLog" ... I want to send somewhere
else.

I read an article that said this is possible.

So, I have python2.3, apache for win 2.0.53, and mod_python 3.0.4
running.

I do something very similar in IIS with a C++ ISAPI filter.   I see
Apache supports ISAPI Extensions.  But Extensions are different.
Anyway, I also see there is a way (on Unix) to send this data via
"CustomLog" to the Unix syslog.   

I thought maybe it would be as simple as specifying an IP and a port.
Doesn't look like that is true.

Now I want to use Python to do this.

This mod_python module rocks.

Tom H.

WildMetrix 2005 ... All your Wildest dreams...

From shuying at gmail.com  Wed Apr  6 00:59:26 2005
From: shuying at gmail.com (Shuying Wang)
Date: Wed Apr  6 00:59:31 2005
Subject: [mod_python] redirects with cgihandler
Message-ID: <75fa0c3a05040521593cbda5f4@mail.gmail.com>

Hi,

I'm using the cgihandler with mod_python3.0.3, Apache2.0.46 and
python2.2.3. I would like to know how I'm meant do url redirections.
My code looks something like this:

try: 
     .....
      print "Location: %s\n" % url 
except:
        pass
which works as a regular CGI script (ie. it redirects to the specified
url). It's definitely not hitting the exception and  but redirection
isn't happening either.

 Thanks in advance,
Shuying
From David.Bear at asu.edu  Wed Apr  6 14:45:57 2005
From: David.Bear at asu.edu (David Bear)
Date: Wed Apr  6 14:46:03 2005
Subject: [mod_python] installing on apache 1.x server
Message-ID: <20050406184557.GA2254@asu.edu>

The last time I tried to work with mod_python the install package (a
freebsd port) told me I needed NON-Threading python. since I used zope
this was not an option (unless I installed a separate python)

I am wondering if that is still the case. I am using apache 1.3.x. and
have python 2.4.x installed.

If it still is required to have non-threading python, are they any
recommendations on how to setup up both pythons on the same system,
and have mod-python find the 'right' one?

-- 
David Bear
phone: 	480-965-8257
fax: 	480-965-9189
College of Public Programs/ASU
Wilson Hall 232
Tempe, AZ 85287-0803
 "Beware the IP portfolio, everyone will be suspect of trespassing"
From dharana at dharana.net  Wed Apr  6 15:31:32 2005
From: dharana at dharana.net (dharana)
Date: Wed Apr  6 15:31:37 2005
Subject: [mod_python] Sessions performance and some numbers
Message-ID: <42543914.9060807@dharana.net>

Hello,

I've just started using mod_python, I wrote my own handler and some modules.

After a bit of work i saw what I believed was bad performance, and I
started profiling.

What I've found is this:

ab -n 100 http://localhost/not_found.html
Trying to fetch non-existant file, that is, just apache: 623 req/sec)

ab -n 100 http://localhost/python_bare.py
It's only contents are "def handler(req): return": 324 req/sec

ab -n 100 http://localhost/python_session.py
Contents of python_session.py
---------------
def handler(req):
   from mod_python import Session
   req.sess = Session.Session(req)
   req.sess.save()
   return
---------------

8 req/sec !!!!

As we can't use MemorySession on Linux (Linux is multiprocess, right?)
what are the possible alternatives? Would a custom FileSession ala PHP
be faster?

I found an old post from 2001 where some people recommended using a
custom Session Server but I don't know if this recommendation still holds.

Server:
Hardware: CPU 1ghz, 1Gb RAM 133Mhz, 7200 rpm ATA hdd and negligible load
Software: Debian stable, apache 2.0.52 prefork, mod_python 3.1, python 2.4

Thanks in advance for any advice.


PD: Just for the record, a similar php_bare test with "function test() {
return; } test();" and in the same conditions brought 316 req/sec.

-- 
Juan Alonso
http://gamersmafia.com | http://laflecha.net


From huzaifa at hostway.com  Wed Apr  6 16:09:42 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Wed Apr  6 16:09:50 2005
Subject: [mod_python] Req object shared?
Message-ID: <42544206.8010705@hostway.com>

Does mod_python share the req object between all requests?  I am running 
into a problem with FieldStorage parsing the value for dropdowns as 
lists of two selection both of which are the same.  For example, when I 
view the form values from FieldStorage I see the following for the 
values of all the dropdown fields:

dd_field: ['val1','val2']

Anybody else run into this issue?  Its intermittent, it doesn't happen 
everytime, just every now and then.

Any help will be appreciated.

Thanks

Huzaifa Tapal

From barry.pearce at copyrightwitness.net  Wed Apr  6 17:10:49 2005
From: barry.pearce at copyrightwitness.net (Barry Pearce)
Date: Wed Apr  6 17:09:15 2005
Subject: [mod_python] Re: Mod_python Digest, Vol 25, Issue 6
In-Reply-To: <200504061600.j36G04T9032612@modpython.org>
References: <200504061600.j36G04T9032612@modpython.org>
Message-ID: <42545059.8080301@copyrightwitness.net>

Hi,

> I'm using the cgihandler with mod_python3.0.3, Apache2.0.46 and
> python2.2.3. I would like to know how I'm meant do url redirections.
> My code looks something like this:
> 
> try: 
>      .....
>       print "Location: %s\n" % url 
> except:
>         pass
> which works as a regular CGI script (ie. it redirects to the specified
> url). It's definitely not hitting the exception and  but redirection
> isn't happening either.

Shouldn't that be a header? Set you want to use the methods to set it as 
a header. Alternatively you can do a server-side redirect using

request.internal_redirect('/my_page_on_this_server')

Which keeps the delivery of the page secret (allows URL masking).
Alternatively you could use

util.redirect(request, 'http://newlocation')

Which provides the more usual redirect based on http headers.

Hope this helps,
Barry
From grahamd at dscpl.com.au  Wed Apr  6 17:25:06 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Apr  6 17:25:15 2005
Subject: [mod_python] installing on apache 1.x server
In-Reply-To: <20050406184557.GA2254@asu.edu>
References: <20050406184557.GA2254@asu.edu>
Message-ID: <644522b8ca20c6673c912df0ca4e1306@dscpl.com.au>


On 07/04/2005, at 4:45 AM, David Bear wrote:

> The last time I tried to work with mod_python the install package (a
> freebsd port) told me I needed NON-Threading python. since I used zope
> this was not an option (unless I installed a separate python)
>
> I am wondering if that is still the case. I am using apache 1.3.x. and
> have python 2.4.x installed.
>
> If it still is required to have non-threading python, are they any
> recommendations on how to setup up both pythons on the same system,
> and have mod-python find the 'right' one?

The issue with threading on FreeBSD is that the POSIX thread library
functions reside in libc_r and not libc. When Apache is built, it only
links with libc and thus the thread functions aren't available normally.

You would either have to rebuild Apache and have it link with -lc_r
or follow advice given in FAQ entry:

   http://www.modpython.org/FAQ/faqw.py?req=show&file=faq02.011.htp

If you don't have any ability to rebuild Apache or change the 
environment
in which it starts because you are using an ISP who doesn't give you
that access, then you have a problem.

Overall, if you can solve this problem, there should be no issue with
using a thread enabled version of Python, you would just need to be very
careful if you actually wanted to use threads in your Python code and
make sure you don't call back into Apache from a thread because Apache
itself will not be thread safe.

Graham

From grahamd at dscpl.com.au  Wed Apr  6 17:35:47 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Apr  6 17:35:55 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <42543914.9060807@dharana.net>
References: <42543914.9060807@dharana.net>
Message-ID: <86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>


On 07/04/2005, at 5:31 AM, dharana wrote:
> ab -n 100 http://localhost/python_session.py
> Contents of python_session.py
> ---------------
> def handler(req):
>   from mod_python import Session
>   req.sess = Session.Session(req)
>   req.sess.save()
>   return
> ---------------
>
> 8 req/sec !!!!
>
> As we can't use MemorySession on Linux (Linux is multiprocess, right?)
> what are the possible alternatives?

On Linux, you could build Apache with the worker "MPM" and restrict the
number of processes to 1 but many threads and then a MemorySession would
be used.

> Would a custom FileSession ala PHP
> be faster?
>
> I found an old post from 2001 where some people recommended using a
> custom Session Server but I don't know if this recommendation still 
> holds.

Someone posted something a bit more recent which used a database for
doing sessions.

   http://www.modpython.org/pipermail/mod_python/2005-March/017651.html

Thus that sort of thing is definitely possible.

My only other comment is to ask that you made sure you weren't testing
immediately after an Apache restart and before any other requests had
come in, but after already having done some requests. I ask this because
there will be some initial startup costs for loading of modules etc,
although how much depends on your code a bit. Thus, you should try to
make sure you factor out such possibilities.

Graham

From grahamd at dscpl.com.au  Wed Apr  6 17:46:35 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Apr  6 17:46:43 2005
Subject: [mod_python] Req object shared?
In-Reply-To: <42544206.8010705@hostway.com>
References: <42544206.8010705@hostway.com>
Message-ID: <d992b0706e19c860bcd31ecbd63b8f1f@dscpl.com.au>


On 07/04/2005, at 6:09 AM, Huzaifa Tapal wrote:

> Does mod_python share the req object between all requests?

For each distinct request a separate "req" object is created.

> I am running into a problem with FieldStorage parsing the value for  
> dropdowns as lists of two selection both of which are the same.  For  
> example, when I view the form values from FieldStorage I see the  
> following for the values of all the dropdown fields:
>
> dd_field: ['val1','val2']
>
> Anybody else run into this issue?  Its intermittent, it doesn't happen  
> everytime, just every now and then.

Suggest you post the actual HTML for a cut down version form which still
shows the problem. I also would suggest setting the target of the form
to be the URL:

    
http://www.dscpl.com.au/projects/vampire/examples/utilities/form- 
values.html

This mod_python handler will display back the form values and will given
you an independent bit of code to try your form against to see if it is
somehow your handler.

Note that this handler uses Vampire and Vampire's structured form  
handling
mode is enabled. If you use "-" or "." in your form parameter names you
might get strange results. :-(

BTW, what version of mod_python are you using?

Graham

From grahamd at dscpl.com.au  Wed Apr  6 19:50:56 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Apr  6 19:51:11 2005
Subject: [mod_python] Req object shared?
Message-ID: <1112831456.30564@dscpl.user.openhosting.com>

Jamieson Becker wrote ..
> btw, everyone, I also posted a quick and dirty mod_python status page to
> the FAQ on the mod_python site.. it basically pprints your field data
> for you, among other things. If you're familiar with mod_php's phpinfo()
> page, this is the same idea..

URL for the FAQ challenged is:

  http://www.modpython.org/FAQ/faqw.py?req=show&file=faq03.019.htp

I also have one but not currently as extensive as your one as far as
details displayed as I didn't want to be revealing important stuff about
my site given that I have it up as a live example.

  http://www.dscpl.com.au/projects/vampire/examples/utilities/request-details.html

Hmmm, maybe I shouldn't be posting that, as it currently shows that
my site is held together with string and proxy redirects while I move
to my new site. :-(

The code for various utilities I provide with Vampire can be seen online
by browsing:

  http://svn.dscpl.com.au/vampire/trunk/examples/utilities/

Unfortuately, SVN doesn't seem to set "text/plain" content type and
browser thus don't show you the actual source code properly. :-(

To see it properly can also go:

  http://www.dscpl.com.au/projects/vampire/source/examples/utilities/request-details.html
  http://www.dscpl.com.au/projects/vampire/source/examples/utilities/request-details.py
  http://www.dscpl.com.au/projects/vampire/source/examples/utilities/form-values.html
  http://www.dscpl.com.au/projects/vampire/source/examples/utilities/request-details.py

This is using a special handler which allows you to source the active
source code used to render my own site.

  http://www.dscpl.com.au/projects/vampire/source/source.py

Since the Vampire source package is also my actual web site for the
package, no too hard to work out what to stick after "source" in that
URL and you can see most stuff with it being nicely formatted.
  
> Can you do an announcement on the list of vampyre with the features and
> how easy it is to install? (Is it in Debian by any chance? Does it
> require Python 2.something?)

Vampire has been announced on the list at each release. The site is:

  http://www.dscpl.com.au/projects/vampire

A quick overview is:

    http://www.dscpl.com.au/projects/vampire/articles/vampire-001.html

The last release (1.5), will work with Python 2.3 and later. It is supposed to
work with Python 2.2 but I used a feature was only introduced in Python 2.3.
The version in the source repository works with Python 2.2 though.

Vampire should work with both mod_python 2.7.X or 3.X. Ie., you can still
use Apache 1.3 and older mod_python. A good thing about this is that the
drop in replacement for publisher works the same on old and new mod_python
where that supplied with mod_python doesn't.

It is provided with a standard distutils "setup.py" file form installation. Sorry,
no RPMs, although if you have the tools you can possibly create one using
the distutils "setup.py" file.

Graham
From grahamd at dscpl.com.au  Wed Apr  6 20:49:02 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Apr  6 20:49:10 2005
Subject: [mod_python] Req object shared?
Message-ID: <1112834942.1563@dscpl.user.openhosting.com>

Jamieson Becker wrote ..
> btw, Graham, what's the best way to handle error management with
> mod_python? log it to a db? catch all exceptions and throw them in a
> file? Is the best pythonic way to throw errors to throw exceptions, or
> should you return an error code from your functions? Any good tips or
> hints here? I've actually been using Jabber to throw errors and debug
> info in real time at me while coding, but Jabber 1x screws up the order
> of the messages. Jabber 2x works great but there's a noticeable delay
> while the page is generated.

Error management isn't something I have gone into really. So far
I have only been using mod_python for simple static based web site
construction and simple forms based utilities talking to some live
applications using XML-RPC where I am the primary user. In the
first instance, no errors to report, in the latter I am the only real user
and so I have PythonDebug still On.

It is interesting to see you using Jabber though. Do you have to
create a seperate socket connection to Jabber each time or does the
connection to it persist? Does the message delivery aspects of the
Jabber Python client run in a separate thread or when you publish
a log message does it block until it has been delivered to the Jabber
server and that is why you get a delay?

If you are interested in this ability to get real time information out
of Apache, you might be interested in one of my other projects.
This project gives some similar capabilties to Jabber, ie., request
and reply messaging, plus presence and publish and subscribe
features. This package though is targeted specifically at application
development which needs to be spread across multiple processes
and platforms. This is different to Jabber where its main purpose
is user focused instant messaging and using it in applications has
come along later.

With my package I already have it working to the point where each
Apache subprocess can connect into the messaging system and
thus request handlers can initiate remote calls against a backend
application. One can even have services running in the Apache
processes themselves and services running within distinct Python
interpreters within the same Apache process can even talk amongst
themselves at the same time as Apache is handling HTTP requests.
The underlying message delivery runs in a separate thread and all
socket communications is event driven, so true blocking of the
system doesn't occur.

Anyway, getting back to what you are doing with logging, with this
system any error which you want logged could be published by
a service associated with that Python interpreter in the Apache
process. Another service running in the backend application could
be subscribed to all these published log messages and it could
collect them and log them to a file or even show them in realtime
via a GUI if desired. Probably not much different to what you are
doing, but using a different system.

For reference, the package I am talking about is OSE. Information
can be found at:

  http://ose.sourceforge.net

The documentation for the Python wrappers is at:

  http://ose.sourceforge.net/browse.php?group=python-manual&entry=manual.htm

Documentation doesn't as such explain how to hook it into Apache
though as ability to do that is only in beta version of 8.0 whereas
documentation describes version 7.0.

I can give further details and finally get around to incorporating an
example into Vampire if there is interest.


Graham
From David.Bear at asu.edu  Wed Apr  6 23:00:22 2005
From: David.Bear at asu.edu (David Bear)
Date: Wed Apr  6 23:00:53 2005
Subject: [mod_python] installing on apache 1.x server
In-Reply-To: <644522b8ca20c6673c912df0ca4e1306@dscpl.com.au>
References: <20050406184557.GA2254@asu.edu>
	<644522b8ca20c6673c912df0ca4e1306@dscpl.com.au>
Message-ID: <20050407030022.GG2254@asu.edu>

On Thu, Apr 07, 2005 at 07:25:06AM +1000, Graham Dumpleton wrote:
> 
> On 07/04/2005, at 4:45 AM, David Bear wrote:
> 
> >The last time I tried to work with mod_python the install package (a
> >freebsd port) told me I needed NON-Threading python. since I used zope
> >this was not an option (unless I installed a separate python)
> >
> >I am wondering if that is still the case. I am using apache 1.3.x. and
> >have python 2.4.x installed.
> >
> >If it still is required to have non-threading python, are they any
> >recommendations on how to setup up both pythons on the same system,
> >and have mod-python find the 'right' one?
> 
> The issue with threading on FreeBSD is that the POSIX thread library
> functions reside in libc_r and not libc. When Apache is built, it only
> links with libc and thus the thread functions aren't available normally.
> 
> You would either have to rebuild Apache and have it link with -lc_r
> or follow advice given in FAQ entry:
> 
>   http://www.modpython.org/FAQ/faqw.py?req=show&file=faq02.011.htp
> 
> If you don't have any ability to rebuild Apache or change the 
> environment
> in which it starts because you are using an ISP who doesn't give you
> that access, then you have a problem.

thanks for the information. I suppose I now have 2 questions.

freebsd related: when I attempt to install mod_python 2.x from the
ports collection I get this:

creating Doc/Makefile
analyzing dependencies
Error: Python installation in /usr/local uses threads. mod_python
requires
it to be built without threads. Please deinstall & rebuild/reinstall
Python with
WITHOUT_THREADS set.
*** Error code 1

Stop in /usr/ports/www/mod_python.
------------

any idea how I force the build without actually recompiling python?

second question is..

is it now time to really look at apache 2. I've been under the
impression that apache 1 was more stable (security wise) on unix like
systems.

any advice?
> 
> Overall, if you can solve this problem, there should be no issue with
> using a thread enabled version of Python, you would just need to be very
> careful if you actually wanted to use threads in your Python code and
> make sure you don't call back into Apache from a thread because Apache
> itself will not be thread safe.
> 
> Graham

-- 
David Bear
phone: 	480-965-8257
fax: 	480-965-9189
College of Public Programs/ASU
Wilson Hall 232
Tempe, AZ 85287-0803
 "Beware the IP portfolio, everyone will be suspect of trespassing"
From grahamd at dscpl.com.au  Wed Apr  6 23:26:23 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Apr  6 23:26:25 2005
Subject: [mod_python] installing on apache 1.x server
Message-ID: <1112844383.4716@dscpl.user.openhosting.com>

David Bear wrote ..
> On Thu, Apr 07, 2005 at 07:25:06AM +1000, Graham Dumpleton wrote:
> freebsd related: when I attempt to install mod_python 2.x from the
> ports collection I get this:
> 
> creating Doc/Makefile
> analyzing dependencies
> Error: Python installation in /usr/local uses threads. mod_python
> requires
> it to be built without threads. Please deinstall & rebuild/reinstall
> Python with
> WITHOUT_THREADS set.
> *** Error code 1

Which exact versions of mod_python 2.X and Python are you using. Looks to be
old as mod_python 2.7.10+ versions have a warning:

  echo "  ****** WARNING ******"
  echo "  Python is compiled with thread support. Apache 1.3 does not use threads."
  echo "  On some systems this will cause problems during compilation, on others "
  echo "  it may result in unpredictable behaviour of your Apache server. Yet on"
  echo "  others it will work just fine. The recommended approach is to compile"
  echo "  Python without thread support in a separate location and specify it with"
  echo "  --with-python option to this ./configure script."

I don't see that it actually prevents you from using Python with threads
and certainly I have used threaded Python on Mac OSX with Apache 1.3.

> any idea how I force the build without actually recompiling python?

If not using mod_python 2.7.10 or later, get down the newer version and
you might find it will let you keep going anyway, although if you are using
a new enough version of Python where bool type is supported, it may not
even detect you have thread support anyway as configure uses check
which only works prior to bool type being introduced.

> second question is..
> 
> is it now time to really look at apache 2. I've been under the
> impression that apache 1 was more stable (security wise) on unix like
> systems.

I think that argument is getting a bit thin these days. I thought the main
reason that people still use Apache 1.3 is that the PHP people seem to
still recommend it over Apache 2.0. This is something that some Apache
folks haven't been pleased about.

You might read through:

  http://shiflett.org/archive/86

This is one site which tries to document the issues.

Graham
From dharana at dharana.net  Thu Apr  7 06:08:06 2005
From: dharana at dharana.net (dharana)
Date: Thu Apr  7 06:08:16 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
Message-ID: <42550686.3010804@dharana.net>


Graham Dumpleton wrote:
> 
> On 07/04/2005, at 5:31 AM, dharana wrote:
> 
> [...]
> 
> Someone posted something a bit more recent which used a database for
> doing sessions.
> 
>   http://www.modpython.org/pipermail/mod_python/2005-March/017651.html
> 
> Thus that sort of thing is definitely possible.

I've made a basic FileSession class. Please look at this numbers (I did 
the test 10 times each and averaged:

With a clean mp_sess dbm db:

   ab -n 100 http://localhost/sessions_dbm.py
   Requests per second:    83.03 [#/sec] (mean)



With an mp_sess dbm db with 1500 sessions:

   ab -n 100 http://localhost/sessions_dbm.py
   Requests per second:    6.05 [#/sec] (mean)



Same tests with the single but working FileSession implementation show this:

No files in tmp dir:
   ab -n 100 http://localhost/sessions_file.py
   Requests per second:    189.14 [#/sec] (mean)

With 1500 files in tmp dir:
   ab -n 100 http://localhost/sessions_file.py
   Requests per second:    166.67 [#/sec] (mean)


Before each test I did the following:

- apachectl restart
- ran a preliminar ab -n 500 so modules get loaded and cached
- erase the session files without restarting apache
- ran each test

> 
> My only other comment is to ask that you made sure you weren't testing
> immediately after an Apache restart and before any other requests had
> come in, but after already having done some requests. I ask this because
> there will be some initial startup costs for loading of modules etc,
> although how much depends on your code a bit. Thus, you should try to
> make sure you factor out such possibilities.
> 

If you want I can send my modified Session.py with the new FileSession 
class for review. The only thing left is the possibility of specifying 
hash dirs to store the files to improve scalability over very busy sites.

-- 
Juan Alonso
http://gamersmafia.com | http://laflecha.net

From grahamd at dscpl.com.au  Thu Apr  7 06:19:26 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr  7 06:19:36 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <42550686.3010804@dharana.net>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
Message-ID: <887ae6bd9aca159c5532ee3895892535@dscpl.com.au>


On 07/04/2005, at 8:08 PM, dharana wrote:
> If you want I can send my modified Session.py with the new FileSession 
> class for review.

There probably shouldn't have been a need for you to copy/modify the 
actual
Session.py file which came with mod_python as your derived version could
live quite happily in its own module and simply used the installed 
Session
module.

Anyway, by all means post your code as sure it will be of interest to
someone, if not now then maybe in the future. If there are any problems
in what you have done, someone is also bound to point it out.

Graham

From dharana at dharana.net  Thu Apr  7 11:01:34 2005
From: dharana at dharana.net (dharana)
Date: Thu Apr  7 11:01:43 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
Message-ID: <42554B4E.1000004@dharana.net>



Graham Dumpleton wrote:
> 
> On 07/04/2005, at 8:08 PM, dharana wrote:
> 
>> If you want I can send my modified Session.py with the new FileSession 
>> class for review.
> 
> 
> There probably shouldn't have been a need for you to copy/modify the actual
> Session.py file which came with mod_python as your derived version could
> live quite happily in its own module and simply used the installed Session
> module.
> 

I presumptuously thought that it could fit into the official mod_python 
package due to it's high performance when compared to DbmSession.

 >
> Anyway, by all means post your code as sure it will be of interest to
> someone, if not now then maybe in the future. If there are any problems
> in what you have done, someone is also bound to point it out.
> 

Here it goes. Please point out any obvious problem. Apart from being new 
to mod_python I'm also new to Python in general. For example, I don't 
think the exception handling I've put is completely correct.


In anticipation for any possible attachment problems i pasted it 
directly. (I have read PEP 0008 and the 4 spaces indentation level 
recommendation but I'm in a hurry right now, sorry.)


--- FileSession.py -----------------------------------------------------
import cPickle
import tempfile

from mod_python import Session

tempdir = tempfile.gettempdir()


class FileSession(Session.BaseSession):

   def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):

     Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
                          timeout=timeout, lock=lock)

   def do_cleanup(self):
     import os

     # is there any faster way of doing this?
     for f in os.listdir(tempdir):
       if f.find('mp_sess_', 0, 11) == -1:
         continue

       fp = file('%s%s' % (tempdir, f))
       dict = cPickle.load(fp)
       fp.close()

       if (time() - dict['_accessed']) > dict['_timeout']:
         os.unlink('%s%s' % (tempdir, f))


   def do_load(self):
     try:
     # again, is there a more pythonic way of doing this check?
       fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
     except Exception:
       return None
     else:
       try:
         data = cPickle.load(fp)
         fp.close()
         return data

       except Exception:
         fp.close()
         pass


   def do_save(self, dict):
     fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
     cPickle.dump(dict, fp)
     fp.close()


   def do_delete(self):
     try:
       unlink('%s/mp_sess_%s' % (tempdir, self._sid))
     except Exception:
       pass
------------------------------------------------------------------------

-- 
Juan Alonso
http://gamersmafia.com | http://laflecha.net
-------------- next part --------------
import cPickle
import tempfile

from mod_python import Session

tempdir = tempfile.gettempdir()


class FileSession(Session.BaseSession):

  def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):

    Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
                         timeout=timeout, lock=lock)

  def do_cleanup(self):
    import os

    # is there any faster way of doing this?
    for f in os.listdir(tempdir):
      if f.find('mp_sess_', 0, 11) == -1:
        continue

      fp = file('%s%s' % (tempdir, f))
      dict = cPickle.load(fp)
      fp.close()

      if (time() - dict['_accessed']) > dict['_timeout']:
        os.unlink('%s%s' % (tempdir, f))


  def do_load(self):
    try:
    # again, is there a more pythonic way of doing this check?
      fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
    except Exception:
      return None
    else:
      try:
        data = cPickle.load(fp)
        fp.close()
        return data

      except Exception:
        fp.close()
        pass


  def do_save(self, dict):
    fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
    cPickle.dump(dict, fp)
    fp.close()


  def do_delete(self):
    try:
      unlink('%s/mp_sess_%s' % (tempdir, self._sid))
    except Exception: 
      pass
From huzaifa at hostway.com  Thu Apr  7 11:36:55 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Thu Apr  7 11:37:02 2005
Subject: [mod_python] Req object shared?
In-Reply-To: <d992b0706e19c860bcd31ecbd63b8f1f@dscpl.com.au>
References: <42544206.8010705@hostway.com>
	<d992b0706e19c860bcd31ecbd63b8f1f@dscpl.com.au>
Message-ID: <42555397.5050701@hostway.com>

Hello Graham,

Thanks for your reply.  After doing some more testing, my colleague was 
able to recreate this problem only using Internet Explorer.  Pretty 
much, on the form if we click the form post button real fast multiple 
times, IE somehow posts multiple values for the dropdown lists to the 
servers.  I was able to verify this by testing in IE and Mozilla and 
this only seems to happen in IE.  I also used an IE plugin named 
HTTPWatch which provides client side POST data for every request the 
browser sends.

This does not seem to be an issue with the applicaiton running in CGI, 
however, when running in mod_python, because the request is processed so 
fast, I am guessing this becomes an issue.

Thanks for all your help.

Hozi

Graham Dumpleton wrote:

>
> On 07/04/2005, at 6:09 AM, Huzaifa Tapal wrote:
>
>> Does mod_python share the req object between all requests?
>
>
> For each distinct request a separate "req" object is created.
>
>> I am running into a problem with FieldStorage parsing the value for  
>> dropdowns as lists of two selection both of which are the same.  For  
>> example, when I view the form values from FieldStorage I see the  
>> following for the values of all the dropdown fields:
>>
>> dd_field: ['val1','val2']
>>
>> Anybody else run into this issue?  Its intermittent, it doesn't 
>> happen  everytime, just every now and then.
>
>
> Suggest you post the actual HTML for a cut down version form which still
> shows the problem. I also would suggest setting the target of the form
> to be the URL:
>
>    http://www.dscpl.com.au/projects/vampire/examples/utilities/form- 
> values.html
>
> This mod_python handler will display back the form values and will given
> you an independent bit of code to try your form against to see if it is
> somehow your handler.
>
> Note that this handler uses Vampire and Vampire's structured form  
> handling
> mode is enabled. If you use "-" or "." in your form parameter names you
> might get strange results. :-(
>
> BTW, what version of mod_python are you using?
>
> Graham
>
>

From nicolas.lehuen at gmail.com  Thu Apr  7 12:14:13 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Thu Apr  7 12:14:14 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <42554B4E.1000004@dharana.net>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
Message-ID: <c298f2d7050407091434bc224a@mail.gmail.com>

Hi,

Your code seems perfect to me. We could indeed add an extra hash to
the directory name so that all sessions do not end in the same
directory ; but I guess this is not needed on modern FS like ReiserFS
or WinFS.

Also, the unlink call in do_delete needs an "os." to be correct...

If everybody is OK I could integrate your class into the Session.py
module, so that it becomes a standard session implementation in the
next release. Grisha, Graham, what do you think ?

Just as a note, the DbmSession relies on the anydbm module ; maybe the
crappy performance were due to the fact that anydbm reverted to a
crappy implementation, not the fastest (?) Berkeley-DB based one.

Regards,

Nicolas

On Apr 7, 2005 5:01 PM, dharana <dharana@dharana.net> wrote:
> 
> 
> Graham Dumpleton wrote:
> >
> > On 07/04/2005, at 8:08 PM, dharana wrote:
> >
> >> If you want I can send my modified Session.py with the new FileSession
> >> class for review.
> >
> >
> > There probably shouldn't have been a need for you to copy/modify the actual
> > Session.py file which came with mod_python as your derived version could
> > live quite happily in its own module and simply used the installed Session
> > module.
> >
> 
> I presumptuously thought that it could fit into the official mod_python
> package due to it's high performance when compared to DbmSession.
> 
>  >
> > Anyway, by all means post your code as sure it will be of interest to
> > someone, if not now then maybe in the future. If there are any problems
> > in what you have done, someone is also bound to point it out.
> >
> 
> Here it goes. Please point out any obvious problem. Apart from being new
> to mod_python I'm also new to Python in general. For example, I don't
> think the exception handling I've put is completely correct.
> 
> In anticipation for any possible attachment problems i pasted it
> directly. (I have read PEP 0008 and the 4 spaces indentation level
> recommendation but I'm in a hurry right now, sorry.)
> 
> --- FileSession.py -----------------------------------------------------
> import cPickle
> import tempfile
> 
> from mod_python import Session
> 
> tempdir = tempfile.gettempdir()
> 
> class FileSession(Session.BaseSession):
> 
>    def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
> 
>      Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
>                           timeout=timeout, lock=lock)
> 
>    def do_cleanup(self):
>      import os
> 
>      # is there any faster way of doing this?
>      for f in os.listdir(tempdir):
>        if f.find('mp_sess_', 0, 11) == -1:
>          continue
> 
>        fp = file('%s%s' % (tempdir, f))
>        dict = cPickle.load(fp)
>        fp.close()
> 
>        if (time() - dict['_accessed']) > dict['_timeout']:
>          os.unlink('%s%s' % (tempdir, f))
> 
>    def do_load(self):
>      try:
>      # again, is there a more pythonic way of doing this check?
>        fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
>      except Exception:
>        return None
>      else:
>        try:
>          data = cPickle.load(fp)
>          fp.close()
>          return data
> 
>        except Exception:
>          fp.close()
>          pass
> 
>    def do_save(self, dict):
>      fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
>      cPickle.dump(dict, fp)
>      fp.close()
> 
>    def do_delete(self):
>      try:
>        unlink('%s/mp_sess_%s' % (tempdir, self._sid))
>      except Exception:
>        pass
> ------------------------------------------------------------------------
> 
> --
> Juan Alonso
> http://gamersmafia.com | http://laflecha.net
> 
> 
> import cPickle
> import tempfile
> 
> from mod_python import Session
> 
> tempdir = tempfile.gettempdir()
> 
> class FileSession(Session.BaseSession):
> 
>   def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
> 
>     Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
>                          timeout=timeout, lock=lock)
> 
>   def do_cleanup(self):
>     import os
> 
>     # is there any faster way of doing this?
>     for f in os.listdir(tempdir):
>       if f.find('mp_sess_', 0, 11) == -1:
>         continue
> 
>       fp = file('%s%s' % (tempdir, f))
>       dict = cPickle.load(fp)
>       fp.close()
> 
>       if (time() - dict['_accessed']) > dict['_timeout']:
>         os.unlink('%s%s' % (tempdir, f))
> 
>   def do_load(self):
>     try:
>     # again, is there a more pythonic way of doing this check?
>       fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
>     except Exception:
>       return None
>     else:
>       try:
>         data = cPickle.load(fp)
>         fp.close()
>         return data
> 
>       except Exception:
>         fp.close()
>         pass
> 
>   def do_save(self, dict):
>     fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
>     cPickle.dump(dict, fp)
>     fp.close()
> 
>   def do_delete(self):
>     try:
>       unlink('%s/mp_sess_%s' % (tempdir, self._sid))
>     except Exception:
>       pass
> 
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 
> 
>
From grisha at modpython.org  Thu Apr  7 12:26:20 2005
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Thu Apr  7 12:26:33 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <42554B4E.1000004@dharana.net>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
Message-ID: <20050407122457.H75107@grisha.dyndns.org>


There is no way that pickling stuff into a file is faster than a dbm.

Do you know which DBM implementation you were using in your tests?

Grisha

On Thu, 7 Apr 2005, dharana wrote:

>
>
> Graham Dumpleton wrote:
>> 
>> On 07/04/2005, at 8:08 PM, dharana wrote:
>> 
>>> If you want I can send my modified Session.py with the new FileSession 
>>> class for review.
>> 
>> 
>> There probably shouldn't have been a need for you to copy/modify the 
>> actual
>> Session.py file which came with mod_python as your derived version could
>> live quite happily in its own module and simply used the installed Session
>> module.
>> 
>
> I presumptuously thought that it could fit into the official mod_python 
> package due to it's high performance when compared to DbmSession.
>
>>
>> Anyway, by all means post your code as sure it will be of interest to
>> someone, if not now then maybe in the future. If there are any problems
>> in what you have done, someone is also bound to point it out.
>> 
>
> Here it goes. Please point out any obvious problem. Apart from being new to 
> mod_python I'm also new to Python in general. For example, I don't think the 
> exception handling I've put is completely correct.
>
>
> In anticipation for any possible attachment problems i pasted it directly. (I 
> have read PEP 0008 and the 4 spaces indentation level recommendation but I'm 
> in a hurry right now, sorry.)
>
>
> --- FileSession.py -----------------------------------------------------
> import cPickle
> import tempfile
>
> from mod_python import Session
>
> tempdir = tempfile.gettempdir()
>
>
> class FileSession(Session.BaseSession):
>
>  def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
>
>    Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
>                         timeout=timeout, lock=lock)
>
>  def do_cleanup(self):
>    import os
>
>    # is there any faster way of doing this?
>    for f in os.listdir(tempdir):
>      if f.find('mp_sess_', 0, 11) == -1:
>        continue
>
>      fp = file('%s%s' % (tempdir, f))
>      dict = cPickle.load(fp)
>      fp.close()
>
>      if (time() - dict['_accessed']) > dict['_timeout']:
>        os.unlink('%s%s' % (tempdir, f))
>
>
>  def do_load(self):
>    try:
>    # again, is there a more pythonic way of doing this check?
>      fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
>    except Exception:
>      return None
>    else:
>      try:
>        data = cPickle.load(fp)
>        fp.close()
>        return data
>
>      except Exception:
>        fp.close()
>        pass
>
>
>  def do_save(self, dict):
>    fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
>    cPickle.dump(dict, fp)
>    fp.close()
>
>
>  def do_delete(self):
>    try:
>      unlink('%s/mp_sess_%s' % (tempdir, self._sid))
>    except Exception:
>      pass
> ------------------------------------------------------------------------
>
> -- 
> Juan Alonso
> http://gamersmafia.com | http://laflecha.net
>
From grisha at modpython.org  Thu Apr  7 12:36:28 2005
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Thu Apr  7 12:36:44 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <c298f2d7050407091434bc224a@mail.gmail.com>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
	<c298f2d7050407091434bc224a@mail.gmail.com>
Message-ID: <20050407122735.S75107@grisha.dyndns.org>


I'd like to hear some explanation of the problem with DBM sessions first.

also - how hard is it to make the code below attempt to unpickle arbitrary 
stuff (potential security problem)?

grisha

On Thu, 7 Apr 2005, Nicolas Lehuen wrote:

> Hi,
>
> Your code seems perfect to me. We could indeed add an extra hash to
> the directory name so that all sessions do not end in the same
> directory ; but I guess this is not needed on modern FS like ReiserFS
> or WinFS.
>
> Also, the unlink call in do_delete needs an "os." to be correct...
>
> If everybody is OK I could integrate your class into the Session.py
> module, so that it becomes a standard session implementation in the
> next release. Grisha, Graham, what do you think ?
>
> Just as a note, the DbmSession relies on the anydbm module ; maybe the
> crappy performance were due to the fact that anydbm reverted to a
> crappy implementation, not the fastest (?) Berkeley-DB based one.
>
> Regards,
>
> Nicolas
>
> On Apr 7, 2005 5:01 PM, dharana <dharana@dharana.net> wrote:
>>
>>
>> Graham Dumpleton wrote:
>>>
>>> On 07/04/2005, at 8:08 PM, dharana wrote:
>>>
>>>> If you want I can send my modified Session.py with the new FileSession
>>>> class for review.
>>>
>>>
>>> There probably shouldn't have been a need for you to copy/modify the actual
>>> Session.py file which came with mod_python as your derived version could
>>> live quite happily in its own module and simply used the installed Session
>>> module.
>>>
>>
>> I presumptuously thought that it could fit into the official mod_python
>> package due to it's high performance when compared to DbmSession.
>>
>> >
>>> Anyway, by all means post your code as sure it will be of interest to
>>> someone, if not now then maybe in the future. If there are any problems
>>> in what you have done, someone is also bound to point it out.
>>>
>>
>> Here it goes. Please point out any obvious problem. Apart from being new
>> to mod_python I'm also new to Python in general. For example, I don't
>> think the exception handling I've put is completely correct.
>>
>> In anticipation for any possible attachment problems i pasted it
>> directly. (I have read PEP 0008 and the 4 spaces indentation level
>> recommendation but I'm in a hurry right now, sorry.)
>>
>> --- FileSession.py -----------------------------------------------------
>> import cPickle
>> import tempfile
>>
>> from mod_python import Session
>>
>> tempdir = tempfile.gettempdir()
>>
>> class FileSession(Session.BaseSession):
>>
>>    def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
>>
>>      Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
>>                           timeout=timeout, lock=lock)
>>
>>    def do_cleanup(self):
>>      import os
>>
>>      # is there any faster way of doing this?
>>      for f in os.listdir(tempdir):
>>        if f.find('mp_sess_', 0, 11) == -1:
>>          continue
>>
>>        fp = file('%s%s' % (tempdir, f))
>>        dict = cPickle.load(fp)
>>        fp.close()
>>
>>        if (time() - dict['_accessed']) > dict['_timeout']:
>>          os.unlink('%s%s' % (tempdir, f))
>>
>>    def do_load(self):
>>      try:
>>      # again, is there a more pythonic way of doing this check?
>>        fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
>>      except Exception:
>>        return None
>>      else:
>>        try:
>>          data = cPickle.load(fp)
>>          fp.close()
>>          return data
>>
>>        except Exception:
>>          fp.close()
>>          pass
>>
>>    def do_save(self, dict):
>>      fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
>>      cPickle.dump(dict, fp)
>>      fp.close()
>>
>>    def do_delete(self):
>>      try:
>>        unlink('%s/mp_sess_%s' % (tempdir, self._sid))
>>      except Exception:
>>        pass
>> ------------------------------------------------------------------------
>>
>> --
>> Juan Alonso
>> http://gamersmafia.com | http://laflecha.net
>>
>>
>> import cPickle
>> import tempfile
>>
>> from mod_python import Session
>>
>> tempdir = tempfile.gettempdir()
>>
>> class FileSession(Session.BaseSession):
>>
>>   def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
>>
>>     Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
>>                          timeout=timeout, lock=lock)
>>
>>   def do_cleanup(self):
>>     import os
>>
>>     # is there any faster way of doing this?
>>     for f in os.listdir(tempdir):
>>       if f.find('mp_sess_', 0, 11) == -1:
>>         continue
>>
>>       fp = file('%s%s' % (tempdir, f))
>>       dict = cPickle.load(fp)
>>       fp.close()
>>
>>       if (time() - dict['_accessed']) > dict['_timeout']:
>>         os.unlink('%s%s' % (tempdir, f))
>>
>>   def do_load(self):
>>     try:
>>     # again, is there a more pythonic way of doing this check?
>>       fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
>>     except Exception:
>>       return None
>>     else:
>>       try:
>>         data = cPickle.load(fp)
>>         fp.close()
>>         return data
>>
>>       except Exception:
>>         fp.close()
>>         pass
>>
>>   def do_save(self, dict):
>>     fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
>>     cPickle.dump(dict, fp)
>>     fp.close()
>>
>>   def do_delete(self):
>>     try:
>>       unlink('%s/mp_sess_%s' % (tempdir, self._sid))
>>     except Exception:
>>       pass
>>
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>>
>>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From nicolas.lehuen at gmail.com  Thu Apr  7 13:03:39 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Thu Apr  7 13:03:42 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <20050407122457.H75107@grisha.dyndns.org>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
	<20050407122457.H75107@grisha.dyndns.org>
Message-ID: <c298f2d705040710034eddb8de@mail.gmail.com>

Grisha, the dbm implementation is pickling to the dbm which stores in
a file. It's an extra layer of implementation, so reduced performances
can be expected.

BTW, both implementation could save time and space by pickling with
the protocol 2 instead of the protocol 0.

Regards,
Nicolas

On Apr 7, 2005 6:26 PM, Gregory (Grisha) Trubetskoy
<grisha@modpython.org> wrote:
> 
> There is no way that pickling stuff into a file is faster than a dbm.
> 
> Do you know which DBM implementation you were using in your tests?
> 
> Grisha
> 
> On Thu, 7 Apr 2005, dharana wrote:
> 
> >
> >
> > Graham Dumpleton wrote:
> >>
> >> On 07/04/2005, at 8:08 PM, dharana wrote:
> >>
> >>> If you want I can send my modified Session.py with the new FileSession
> >>> class for review.
> >>
> >>
> >> There probably shouldn't have been a need for you to copy/modify the
> >> actual
> >> Session.py file which came with mod_python as your derived version could
> >> live quite happily in its own module and simply used the installed Session
> >> module.
> >>
> >
> > I presumptuously thought that it could fit into the official mod_python
> > package due to it's high performance when compared to DbmSession.
> >
> >>
> >> Anyway, by all means post your code as sure it will be of interest to
> >> someone, if not now then maybe in the future. If there are any problems
> >> in what you have done, someone is also bound to point it out.
> >>
> >
> > Here it goes. Please point out any obvious problem. Apart from being new to
> > mod_python I'm also new to Python in general. For example, I don't think the
> > exception handling I've put is completely correct.
> >
> >
> > In anticipation for any possible attachment problems i pasted it directly. (I
> > have read PEP 0008 and the 4 spaces indentation level recommendation but I'm
> > in a hurry right now, sorry.)
> >
> >
> > --- FileSession.py -----------------------------------------------------
> > import cPickle
> > import tempfile
> >
> > from mod_python import Session
> >
> > tempdir = tempfile.gettempdir()
> >
> >
> > class FileSession(Session.BaseSession):
> >
> >  def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
> >
> >    Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
> >                         timeout=timeout, lock=lock)
> >
> >  def do_cleanup(self):
> >    import os
> >
> >    # is there any faster way of doing this?
> >    for f in os.listdir(tempdir):
> >      if f.find('mp_sess_', 0, 11) == -1:
> >        continue
> >
> >      fp = file('%s%s' % (tempdir, f))
> >      dict = cPickle.load(fp)
> >      fp.close()
> >
> >      if (time() - dict['_accessed']) > dict['_timeout']:
> >        os.unlink('%s%s' % (tempdir, f))
> >
> >
> >  def do_load(self):
> >    try:
> >    # again, is there a more pythonic way of doing this check?
> >      fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
> >    except Exception:
> >      return None
> >    else:
> >      try:
> >        data = cPickle.load(fp)
> >        fp.close()
> >        return data
> >
> >      except Exception:
> >        fp.close()
> >        pass
> >
> >
> >  def do_save(self, dict):
> >    fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
> >    cPickle.dump(dict, fp)
> >    fp.close()
> >
> >
> >  def do_delete(self):
> >    try:
> >      unlink('%s/mp_sess_%s' % (tempdir, self._sid))
> >    except Exception:
> >      pass
> > ------------------------------------------------------------------------
> >
> > --
> > Juan Alonso
> > http://gamersmafia.com | http://laflecha.net
> >
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From jg.lists at sympatico.ca  Thu Apr  7 15:39:56 2005
From: jg.lists at sympatico.ca (Jim Gallacher)
Date: Thu Apr  7 15:39:45 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <c298f2d7050407091434bc224a@mail.gmail.com>
References: <42543914.9060807@dharana.net>	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>	<42550686.3010804@dharana.net>	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>	<42554B4E.1000004@dharana.net>
	<c298f2d7050407091434bc224a@mail.gmail.com>
Message-ID: <42558C8C.8030905@sympatico.ca>

Nicolas Lehuen wrote:
> Hi,
> 
> Your code seems perfect to me. We could indeed add an extra hash to
> the directory name so that all sessions do not end in the same
> directory ; but I guess this is not needed on modern FS like ReiserFS
> or WinFS.
> 
> Also, the unlink call in do_delete needs an "os." to be correct...
> 
> If everybody is OK I could integrate your class into the Session.py
> module, so that it becomes a standard session implementation in the
> next release. 

Shouldn't a lock be aquired and released before reading and writing the 
session to a file?

Regards,
Jim

> Grisha, Graham, what do you think ?
> 
> Just as a note, the DbmSession relies on the anydbm module ; maybe the
> crappy performance were due to the fact that anydbm reverted to a
> crappy implementation, not the fastest (?) Berkeley-DB based one.
> 
> Regards,
> 
> Nicolas
> 
> On Apr 7, 2005 5:01 PM, dharana <dharana@dharana.net> wrote:
> 
>>
>>Graham Dumpleton wrote:
>>
>>>On 07/04/2005, at 8:08 PM, dharana wrote:
>>>
>>>
>>>>If you want I can send my modified Session.py with the new FileSession
>>>>class for review.
>>>
>>>
>>>There probably shouldn't have been a need for you to copy/modify the actual
>>>Session.py file which came with mod_python as your derived version could
>>>live quite happily in its own module and simply used the installed Session
>>>module.
>>>
>>
>>I presumptuously thought that it could fit into the official mod_python
>>package due to it's high performance when compared to DbmSession.
>>
>> >
>>
>>>Anyway, by all means post your code as sure it will be of interest to
>>>someone, if not now then maybe in the future. If there are any problems
>>>in what you have done, someone is also bound to point it out.
>>>
>>
>>Here it goes. Please point out any obvious problem. Apart from being new
>>to mod_python I'm also new to Python in general. For example, I don't
>>think the exception handling I've put is completely correct.
>>
>>In anticipation for any possible attachment problems i pasted it
>>directly. (I have read PEP 0008 and the 4 spaces indentation level
>>recommendation but I'm in a hurry right now, sorry.)
>>
>>--- FileSession.py -----------------------------------------------------
>>import cPickle
>>import tempfile
>>
>>from mod_python import Session
>>
>>tempdir = tempfile.gettempdir()
>>
>>class FileSession(Session.BaseSession):
>>
>>   def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
>>
>>     Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
>>                          timeout=timeout, lock=lock)
>>
>>   def do_cleanup(self):
>>     import os
>>
>>     # is there any faster way of doing this?
>>     for f in os.listdir(tempdir):
>>       if f.find('mp_sess_', 0, 11) == -1:
>>         continue
>>
>>       fp = file('%s%s' % (tempdir, f))
>>       dict = cPickle.load(fp)
>>       fp.close()
>>
>>       if (time() - dict['_accessed']) > dict['_timeout']:
>>         os.unlink('%s%s' % (tempdir, f))
>>
>>   def do_load(self):
>>     try:
>>     # again, is there a more pythonic way of doing this check?
>>       fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
>>     except Exception:
>>       return None
>>     else:
>>       try:
>>         data = cPickle.load(fp)
>>         fp.close()
>>         return data
>>
>>       except Exception:
>>         fp.close()
>>         pass
>>
>>   def do_save(self, dict):
>>     fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
>>     cPickle.dump(dict, fp)
>>     fp.close()
>>
>>   def do_delete(self):
>>     try:
>>       unlink('%s/mp_sess_%s' % (tempdir, self._sid))
>>     except Exception:
>>       pass
>>------------------------------------------------------------------------
>>
>>--
>>Juan Alonso
>>http://gamersmafia.com | http://laflecha.net
>>
>>
>>import cPickle
>>import tempfile
>>
>>from mod_python import Session
>>
>>tempdir = tempfile.gettempdir()
>>
>>class FileSession(Session.BaseSession):
>>
>>  def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
>>
>>    Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
>>                         timeout=timeout, lock=lock)
>>
>>  def do_cleanup(self):
>>    import os
>>
>>    # is there any faster way of doing this?
>>    for f in os.listdir(tempdir):
>>      if f.find('mp_sess_', 0, 11) == -1:
>>        continue
>>
>>      fp = file('%s%s' % (tempdir, f))
>>      dict = cPickle.load(fp)
>>      fp.close()
>>
>>      if (time() - dict['_accessed']) > dict['_timeout']:
>>        os.unlink('%s%s' % (tempdir, f))
>>
>>  def do_load(self):
>>    try:
>>    # again, is there a more pythonic way of doing this check?
>>      fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
>>    except Exception:
>>      return None
>>    else:
>>      try:
>>        data = cPickle.load(fp)
>>        fp.close()
>>        return data
>>
>>      except Exception:
>>        fp.close()
>>        pass
>>
>>  def do_save(self, dict):
>>    fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
>>    cPickle.dump(dict, fp)
>>    fp.close()
>>
>>  def do_delete(self):
>>    try:
>>      unlink('%s/mp_sess_%s' % (tempdir, self._sid))
>>    except Exception:
>>      pass
>>
>>
>>_______________________________________________
>>Mod_python mailing list
>>Mod_python@modpython.org
>>http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>>
>>
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 

From nicolas.lehuen at gmail.com  Thu Apr  7 16:59:10 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Thu Apr  7 16:59:14 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <42558C8C.8030905@sympatico.ca>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
	<c298f2d7050407091434bc224a@mail.gmail.com>
	<42558C8C.8030905@sympatico.ca>
Message-ID: <c298f2d705040713593d958c27@mail.gmail.com>

On Apr 7, 2005 9:39 PM, Jim Gallacher <jg.lists@sympatico.ca> wrote:
> Nicolas Lehuen wrote:
> > Hi,
> >
> > Your code seems perfect to me. We could indeed add an extra hash to
> > the directory name so that all sessions do not end in the same
> > directory ; but I guess this is not needed on modern FS like ReiserFS
> > or WinFS.
> >
> > Also, the unlink call in do_delete needs an "os." to be correct...
> >
> > If everybody is OK I could integrate your class into the Session.py
> > module, so that it becomes a standard session implementation in the
> > next release.
> 
> Shouldn't a lock be aquired and released before reading and writing the
> session to a file?

Yeah, of course, though we could rely on the native filesystem locking
capabilities.

Regards,
Nicolas

> 
> Regards,
> Jim
> 
> > Grisha, Graham, what do you think ?
> >
> > Just as a note, the DbmSession relies on the anydbm module ; maybe the
> > crappy performance were due to the fact that anydbm reverted to a
> > crappy implementation, not the fastest (?) Berkeley-DB based one.
> >
> > Regards,
> >
> > Nicolas
> >
> > On Apr 7, 2005 5:01 PM, dharana <dharana@dharana.net> wrote:
> >
> >>
> >>Graham Dumpleton wrote:
> >>
> >>>On 07/04/2005, at 8:08 PM, dharana wrote:
> >>>
> >>>
> >>>>If you want I can send my modified Session.py with the new FileSession
> >>>>class for review.
> >>>
> >>>
> >>>There probably shouldn't have been a need for you to copy/modify the actual
> >>>Session.py file which came with mod_python as your derived version could
> >>>live quite happily in its own module and simply used the installed Session
> >>>module.
> >>>
> >>
> >>I presumptuously thought that it could fit into the official mod_python
> >>package due to it's high performance when compared to DbmSession.
> >>
> >> >
> >>
> >>>Anyway, by all means post your code as sure it will be of interest to
> >>>someone, if not now then maybe in the future. If there are any problems
> >>>in what you have done, someone is also bound to point it out.
> >>>
> >>
> >>Here it goes. Please point out any obvious problem. Apart from being new
> >>to mod_python I'm also new to Python in general. For example, I don't
> >>think the exception handling I've put is completely correct.
> >>
> >>In anticipation for any possible attachment problems i pasted it
> >>directly. (I have read PEP 0008 and the 4 spaces indentation level
> >>recommendation but I'm in a hurry right now, sorry.)
> >>
> >>--- FileSession.py -----------------------------------------------------
> >>import cPickle
> >>import tempfile
> >>
> >>from mod_python import Session
> >>
> >>tempdir = tempfile.gettempdir()
> >>
> >>class FileSession(Session.BaseSession):
> >>
> >>   def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
> >>
> >>     Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
> >>                          timeout=timeout, lock=lock)
> >>
> >>   def do_cleanup(self):
> >>     import os
> >>
> >>     # is there any faster way of doing this?
> >>     for f in os.listdir(tempdir):
> >>       if f.find('mp_sess_', 0, 11) == -1:
> >>         continue
> >>
> >>       fp = file('%s%s' % (tempdir, f))
> >>       dict = cPickle.load(fp)
> >>       fp.close()
> >>
> >>       if (time() - dict['_accessed']) > dict['_timeout']:
> >>         os.unlink('%s%s' % (tempdir, f))
> >>
> >>   def do_load(self):
> >>     try:
> >>     # again, is there a more pythonic way of doing this check?
> >>       fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
> >>     except Exception:
> >>       return None
> >>     else:
> >>       try:
> >>         data = cPickle.load(fp)
> >>         fp.close()
> >>         return data
> >>
> >>       except Exception:
> >>         fp.close()
> >>         pass
> >>
> >>   def do_save(self, dict):
> >>     fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
> >>     cPickle.dump(dict, fp)
> >>     fp.close()
> >>
> >>   def do_delete(self):
> >>     try:
> >>       unlink('%s/mp_sess_%s' % (tempdir, self._sid))
> >>     except Exception:
> >>       pass
> >>------------------------------------------------------------------------
> >>
> >>--
> >>Juan Alonso
> >>http://gamersmafia.com | http://laflecha.net
> >>
> >>
> >>import cPickle
> >>import tempfile
> >>
> >>from mod_python import Session
> >>
> >>tempdir = tempfile.gettempdir()
> >>
> >>class FileSession(Session.BaseSession):
> >>
> >>  def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
> >>
> >>    Session.BaseSession.__init__(self, req, sid=sid, secret=secret,
> >>                         timeout=timeout, lock=lock)
> >>
> >>  def do_cleanup(self):
> >>    import os
> >>
> >>    # is there any faster way of doing this?
> >>    for f in os.listdir(tempdir):
> >>      if f.find('mp_sess_', 0, 11) == -1:
> >>        continue
> >>
> >>      fp = file('%s%s' % (tempdir, f))
> >>      dict = cPickle.load(fp)
> >>      fp.close()
> >>
> >>      if (time() - dict['_accessed']) > dict['_timeout']:
> >>        os.unlink('%s%s' % (tempdir, f))
> >>
> >>  def do_load(self):
> >>    try:
> >>    # again, is there a more pythonic way of doing this check?
> >>      fp = file('%s/mp_sess_%s' % (tempdir, self._sid))
> >>    except Exception:
> >>      return None
> >>    else:
> >>      try:
> >>        data = cPickle.load(fp)
> >>        fp.close()
> >>        return data
> >>
> >>      except Exception:
> >>        fp.close()
> >>        pass
> >>
> >>  def do_save(self, dict):
> >>    fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
> >>    cPickle.dump(dict, fp)
> >>    fp.close()
> >>
> >>  def do_delete(self):
> >>    try:
> >>      unlink('%s/mp_sess_%s' % (tempdir, self._sid))
> >>    except Exception:
> >>      pass
> >>
> >>
> >>_______________________________________________
> >>Mod_python mailing list
> >>Mod_python@modpython.org
> >>http://mailman.modpython.org/mailman/listinfo/mod_python
> >>
> >>
> >>
> >
> > _______________________________________________
> > Mod_python mailing list
> > Mod_python@modpython.org
> > http://mailman.modpython.org/mailman/listinfo/mod_python
> >
> 
>
From nicolas.lehuen at gmail.com  Thu Apr  7 17:26:01 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Thu Apr  7 17:26:03 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <c298f2d705040713593d958c27@mail.gmail.com>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
	<c298f2d7050407091434bc224a@mail.gmail.com>
	<42558C8C.8030905@sympatico.ca>
	<c298f2d705040713593d958c27@mail.gmail.com>
Message-ID: <c298f2d70504071426260f8367@mail.gmail.com>

On Apr 7, 2005 10:59 PM, Nicolas Lehuen <nicolas.lehuen@gmail.com> wrote:
> On Apr 7, 2005 9:39 PM, Jim Gallacher <jg.lists@sympatico.ca> wrote:
> > Nicolas Lehuen wrote:
> > > Hi,
> > >
> > > Your code seems perfect to me. We could indeed add an extra hash to
> > > the directory name so that all sessions do not end in the same
> > > directory ; but I guess this is not needed on modern FS like ReiserFS
> > > or WinFS.
> > >
> > > Also, the unlink call in do_delete needs an "os." to be correct...
> > >
> > > If everybody is OK I could integrate your class into the Session.py
> > > module, so that it becomes a standard session implementation in the
> > > next release.
> >
> > Shouldn't a lock be aquired and released before reading and writing the
> > session to a file?
> 
> Yeah, of course, though we could rely on the native filesystem locking
> capabilities.
> 
> Regards,
> Nicolas

[switching to python-dev]

Woops, sorry, I did not see that the locking problem is handled in
BaseSession. From what I read in the source code, the locking is
handled with the granularity of one lock per session, am I right ? So,
as we have one file per session, we can reuse the same locking
mechanisms in do_load, do_save and do_delete. Does this sound OK to
you ?

I've seen a few problems in your implementation, so I've took the
liberty of modifying it I've checked it in so that anybody with commit
rights can modify the code. Here it is :

http://svn.apache.org/repos/asf/httpd/mod_python/trunk/lib/python/mod_python/FileSession.py

Basically, I've added a few try...finally to make sure that opened
files are closed, but I've not done anything yet about the tempdir
issue, the locking issue or changing the pickling protocol. It's
coming soon.

Eventually, we could bring back the FileSession class into the Session
module ; I've put it in its own file for now so that we don't bring
too much noise with this new feature. Ideally I should build a branch
for this but I'm not too self-confident about branching and merging in
subversion...

Regards,
Nicolas
From grahamd at dscpl.com.au  Thu Apr  7 17:42:39 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr  7 17:42:59 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <c298f2d70504071426260f8367@mail.gmail.com>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
	<c298f2d7050407091434bc224a@mail.gmail.com>
	<42558C8C.8030905@sympatico.ca>
	<c298f2d705040713593d958c27@mail.gmail.com>
	<c298f2d70504071426260f8367@mail.gmail.com>
Message-ID: <ed967b85878c01daa58b54c10ab82588@dscpl.com.au>

I am going to show my ignorance of how sessions are internally 
implemented
here, but what happens if you happened to have two distinct instances of
Apache running on the same machine? Ie., not one instance of Apache 
listening
on two ports, but two instances each listening on their own ports.

What I am getting at here is that will both instances of Apache if using
mod_python, use the same "mp_sess.dbm" file in "/tmp". Is the way that
information is stored in the database about sessions mean that each 
instance
of Apache sees a different set of session information, or because it is 
the
same database, the session information is effectively shared between the
two and thus a user could login to a session through one instance of
Apache and pick up that session automatically through the other.

Note I am not talking here about prefork and multiple Apache sub 
processes,
I am talking about multiple instances of Apache as a whole.

I haven't looked at the FileSession code yet, but what would it do in 
this
case.

Anyway, I know that in practice this may be rarely done, but just 
curious.

Graham

From grahamd at dscpl.com.au  Thu Apr  7 18:10:10 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr  7 18:10:17 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <ed967b85878c01daa58b54c10ab82588@dscpl.com.au>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
	<c298f2d7050407091434bc224a@mail.gmail.com>
	<42558C8C.8030905@sympatico.ca>
	<c298f2d705040713593d958c27@mail.gmail.com>
	<c298f2d70504071426260f8367@mail.gmail.com>
	<ed967b85878c01daa58b54c10ab82588@dscpl.com.au>
Message-ID: <f4b428c6d2ca81ede7d200ff984a8330@dscpl.com.au>


On 08/04/2005, at 7:42 AM, Graham Dumpleton wrote:

> I am going to show my ignorance of how sessions are internally 
> implemented
> here, ....

Another silly question about something I was wandering about recently
when adding support for login hooks into Vampire in order to support
session based login mechanisms.

The question is, if one doesn't explicitly invalidate a session, how
does its record get deleted from the session database? How would such
an inactive/expired sessions be cleaned out in a file based mechanism
where there is one file per session?

Anyway, probably time to start looking at the code to work it out 
myself.
Thought I would still ask though. :-)

Graham

From nicolas.lehuen at gmail.com  Thu Apr  7 18:23:46 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Thu Apr  7 18:23:50 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <ed967b85878c01daa58b54c10ab82588@dscpl.com.au>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
	<c298f2d7050407091434bc224a@mail.gmail.com>
	<42558C8C.8030905@sympatico.ca>
	<c298f2d705040713593d958c27@mail.gmail.com>
	<c298f2d70504071426260f8367@mail.gmail.com>
	<ed967b85878c01daa58b54c10ab82588@dscpl.com.au>
Message-ID: <c298f2d705040715234297f638@mail.gmail.com>

On Apr 7, 2005 11:42 PM, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> I am going to show my ignorance of how sessions are internally
> implemented
> here, but what happens if you happened to have two distinct instances of
> Apache running on the same machine? Ie., not one instance of Apache
> listening
> on two ports, but two instances each listening on their own ports.
> 
> What I am getting at here is that will both instances of Apache if using
> mod_python, use the same "mp_sess.dbm" file in "/tmp". Is the way that
> information is stored in the database about sessions mean that each
> instance
> of Apache sees a different set of session information, or because it is
> the
> same database, the session information is effectively shared between the
> two and thus a user could login to a session through one instance of
> Apache and pick up that session automatically through the other.
> 
> Note I am not talking here about prefork and multiple Apache sub
> processes,
> I am talking about multiple instances of Apache as a whole.
> 
> I haven't looked at the FileSession code yet, but what would it do in
> this
> case.
> 
> Anyway, I know that in practice this may be rarely done, but just
> curious.
> 
> Graham

Currently, DBMSessions are stored in a directory return by tempdir().
Under Windows, this always returns the same temporary directory
(e:\windows\temp on my machine). So both instances will work on the
same DBM file. Now, if the dbm implementation is bsddb, it should pose
no problem. If it is another implementation, you can expect big
problems.

With this implementation of FileSession, a collision is also possible,
but it will happen only of the two Apache instance build the same
session id. As long as no two session have the same session id,
everything will be allright. If a collision occurs, only the two
sessions will suffer, the other ones will still be OK. So I guess
FileSession would handle this situation more gracefully.

Anyway, I think the directory where session data is stored should be
defined by a PythonOption directive, it would be cleaner.

Regards,
Nicolas
From nicolas.lehuen at gmail.com  Thu Apr  7 19:01:00 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Thu Apr  7 19:01:09 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <f4b428c6d2ca81ede7d200ff984a8330@dscpl.com.au>
References: <42543914.9060807@dharana.net> <42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
	<c298f2d7050407091434bc224a@mail.gmail.com>
	<42558C8C.8030905@sympatico.ca>
	<c298f2d705040713593d958c27@mail.gmail.com>
	<c298f2d70504071426260f8367@mail.gmail.com>
	<ed967b85878c01daa58b54c10ab82588@dscpl.com.au>
	<f4b428c6d2ca81ede7d200ff984a8330@dscpl.com.au>
Message-ID: <c298f2d705040716012aee8bb5@mail.gmail.com>

On Apr 8, 2005 12:10 AM, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> 
> On 08/04/2005, at 7:42 AM, Graham Dumpleton wrote:
> 
> > I am going to show my ignorance of how sessions are internally
> > implemented
> > here, ....
> 
> Another silly question about something I was wandering about recently
> when adding support for login hooks into Vampire in order to support
> session based login mechanisms.
> 
> The question is, if one doesn't explicitly invalidate a session, how
> does its record get deleted from the session database? How would such
> an inactive/expired sessions be cleaned out in a file based mechanism
> where there is one file per session?
> 
> Anyway, probably time to start looking at the code to work it out
> myself.
> Thought I would still ask though. :-)
> 
> Graham

The method used to do this is strange but it may work. Each time a
Session is loaded, a random test is performed to see whether sessions
must be cleaned or not. If the test succeeds (by default, you have one
chance on 1000), the session are cleaned : depending on the subclass,
each session's timeout is checked, and if a session gets too old, it
is deleted.

The session manager I have implemented uses a special "garbage
collecting" thread, but it's not portable to environments where
threading is not available. So I guess this method is the simplest one
that could do the task...

Regards,
Nicolas
From jarrod.roberson at gmail.com  Thu Apr  7 20:53:45 2005
From: jarrod.roberson at gmail.com (jarrod roberson)
Date: Thu Apr  7 20:53:47 2005
Subject: [mod_python] Question about PythonImport and how to fully qualify
	module names in relation to docroot of Apache2
Message-ID: <2389d473050407175326bc5b1b@mail.gmail.com>

my docroot is /www

I have sub dirs with __init__.py files in /www/test

and a python file testapp.py in /www/test

PythonImport test main_interpreter

doesnt work

PythonImport test.testapp main_interpreter

doesnt work either?

any ideas
-- 
If you don't know what you want, you probably need a nap.
From grahamd at dscpl.com.au  Thu Apr  7 21:08:25 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr  7 21:08:27 2005
Subject: [mod_python] Question about PythonImport and how to fully
	qualifymodule names in relation to docroot of Apache2
Message-ID: <1112922505.308@dscpl.user.openhosting.com>

jarrod roberson wrote ..
> my docroot is /www
> 
> I have sub dirs with __init__.py files in /www/test
> 
> and a python file testapp.py in /www/test
> 
> PythonImport test main_interpreter
> 
> doesnt work
> 
> PythonImport test.testapp main_interpreter
> 
> doesnt work either?
> 
> any ideas

PythonImport must be defined at global scope and as such there
will have been no modifications to sys.path corresponding to any
PythonHandler declarations. Thus, you need to explicitly set the
PythonPath directive to include any locations which should be
searched for your module. If this isn't being done by you now, you
are most likely importing the "test" module that comes with Python
and not your own. It isn't actually wise to use a module name for
your own stuff which is the same as one that comes with Python.

Thus, try setting PythonPath. If you are already, post the snippet
of your Apache configuration where you are setting everything
for mod_python. Also show what error messages you might be
getting in the Apache log file. You might have to shutdown Apache
to ensure that Python import error messages in this case are being
flushed to the log.

Graham

From jg.lists at sympatico.ca  Thu Apr  7 22:27:08 2005
From: jg.lists at sympatico.ca (Jim Gallacher)
Date: Thu Apr  7 22:26:56 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <c298f2d70504071426260f8367@mail.gmail.com>
References: <42543914.9060807@dharana.net>	
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>	
	<42550686.3010804@dharana.net>	
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>	
	<42554B4E.1000004@dharana.net>	
	<c298f2d7050407091434bc224a@mail.gmail.com>	
	<42558C8C.8030905@sympatico.ca>	
	<c298f2d705040713593d958c27@mail.gmail.com>
	<c298f2d70504071426260f8367@mail.gmail.com>
Message-ID: <4255EBFC.9010501@sympatico.ca>

Nicolas Lehuen wrote:
> On Apr 7, 2005 10:59 PM, Nicolas Lehuen <nicolas.lehuen@gmail.com> wrote:
> 
>>On Apr 7, 2005 9:39 PM, Jim Gallacher <jg.lists@sympatico.ca> wrote:
>>
>>>Nicolas Lehuen wrote:
>>>
>>>>Hi,
>>>>
>>>>Your code seems perfect to me. We could indeed add an extra hash to
>>>>the directory name so that all sessions do not end in the same
>>>>directory ; but I guess this is not needed on modern FS like ReiserFS
>>>>or WinFS.
>>>>
>>>>Also, the unlink call in do_delete needs an "os." to be correct...
>>>>
>>>>If everybody is OK I could integrate your class into the Session.py
>>>>module, so that it becomes a standard session implementation in the
>>>>next release.
>>>
>>>Shouldn't a lock be aquired and released before reading and writing the
>>>session to a file?
>>
>>Yeah, of course, though we could rely on the native filesystem locking
>>capabilities.
>>
>>Regards,
>>Nicolas
> 
> 
> [switching to python-dev]
> 
> Woops, sorry, I did not see that the locking problem is handled in
> BaseSession. From what I read in the source code, the locking is
> handled with the granularity of one lock per session, am I right ? So,
> as we have one file per session, we can reuse the same locking
> mechanisms in do_load, do_save and do_delete. Does this sound OK to
> you ?

I read it the same way. Why not borrow the locking mechanism used by 
DbmSession? For example:

def do_save(self, dict):
     _apache._global_lock(self._req.server, None, 0)
     fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
     try:
         cPickle.dump(dict, fp)
     finally:
         fp.close()
         _apache._global_unlock(self._req.server, None, 0)


> I've seen a few problems in your implementation, so I've took the
> liberty of modifying it I've checked it in so that anybody with commit
> rights can modify the code. Here it is :
> 
> http://svn.apache.org/repos/asf/httpd/mod_python/trunk/lib/python/mod_python/FileSession.py
> 
> Basically, I've added a few try...finally to make sure that opened
> files are closed, but I've not done anything yet about the tempdir
> issue, the locking issue or changing the pickling protocol. It's
> coming soon.

I've also hacked together a (non-working) version that handles the 
locking and the tempdir issue. Brain a little fuzzy right now, but I'll 
fix it tomorrow and post it - unless you get to it first, Nicolas - :)

Regards,
Jim

From tusharpatil1982 at rediffmail.com  Fri Apr  8 01:40:01 2005
From: tusharpatil1982 at rediffmail.com (tushar liladhar patil)
Date: Fri Apr  8 01:38:37 2005
Subject: [mod_python] In URGENT Need of "API for Printing report in python"
Message-ID: <20050408054001.23340.qmail@mailweb33.rediffmail.com>

  
R/Sir,
      I am Tushar Patil. I m working on python2.3.4 using mandrake10.1 as a platform, with NGO called as SVS software. We are developing a kind of CBT(computer Based Training).So I m in Urgent need of "Report Printing", API's in python.
      Please do the needful, 
Thanking you,
Tushar..
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050408/77156480/attachment.html
From nicolas.lehuen at gmail.com  Fri Apr  8 02:16:05 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Fri Apr  8 02:16:06 2005
Subject: [mod_python] Sessions performance and some numbers
In-Reply-To: <4255EBFC.9010501@sympatico.ca>
References: <42543914.9060807@dharana.net>
	<86d7dc3de3e30864cb6b6b282b63ceb4@dscpl.com.au>
	<42550686.3010804@dharana.net>
	<887ae6bd9aca159c5532ee3895892535@dscpl.com.au>
	<42554B4E.1000004@dharana.net>
	<c298f2d7050407091434bc224a@mail.gmail.com>
	<42558C8C.8030905@sympatico.ca>
	<c298f2d705040713593d958c27@mail.gmail.com>
	<c298f2d70504071426260f8367@mail.gmail.com>
	<4255EBFC.9010501@sympatico.ca>
Message-ID: <c298f2d7050407231646e4d2d7@mail.gmail.com>

On Apr 8, 2005 4:27 AM, Jim Gallacher <jg.lists@sympatico.ca> wrote:
> Nicolas Lehuen wrote:
> > On Apr 7, 2005 10:59 PM, Nicolas Lehuen <nicolas.lehuen@gmail.com> wrote:
> >
> >>On Apr 7, 2005 9:39 PM, Jim Gallacher <jg.lists@sympatico.ca> wrote:
> >>
> >>>Nicolas Lehuen wrote:
> >>>
> >>>>Hi,
> >>>>
> >>>>Your code seems perfect to me. We could indeed add an extra hash to
> >>>>the directory name so that all sessions do not end in the same
> >>>>directory ; but I guess this is not needed on modern FS like ReiserFS
> >>>>or WinFS.
> >>>>
> >>>>Also, the unlink call in do_delete needs an "os." to be correct...
> >>>>
> >>>>If everybody is OK I could integrate your class into the Session.py
> >>>>module, so that it becomes a standard session implementation in the
> >>>>next release.
> >>>
> >>>Shouldn't a lock be aquired and released before reading and writing the
> >>>session to a file?
> >>
> >>Yeah, of course, though we could rely on the native filesystem locking
> >>capabilities.
> >>
> >>Regards,
> >>Nicolas
> >
> >
> > [switching to python-dev]
> >
> > Woops, sorry, I did not see that the locking problem is handled in
> > BaseSession. From what I read in the source code, the locking is
> > handled with the granularity of one lock per session, am I right ? So,
> > as we have one file per session, we can reuse the same locking
> > mechanisms in do_load, do_save and do_delete. Does this sound OK to
> > you ?
> 
> I read it the same way. Why not borrow the locking mechanism used by
> DbmSession? For example:
> 
> def do_save(self, dict):
>      _apache._global_lock(self._req.server, None, 0)
>      fp = file('%s/mp_sess_%s' % (tempdir, self._sid), 'w+')
>      try:
>          cPickle.dump(dict, fp)
>      finally:
>          fp.close()
>          _apache._global_unlock(self._req.server, None, 0)
> 
> 
> > I've seen a few problems in your implementation, so I've took the
> > liberty of modifying it I've checked it in so that anybody with commit
> > rights can modify the code. Here it is :
> >
> > http://svn.apache.org/repos/asf/httpd/mod_python/trunk/lib/python/mod_python/FileSession.py
> >
> > Basically, I've added a few try...finally to make sure that opened
> > files are closed, but I've not done anything yet about the tempdir
> > issue, the locking issue or changing the pickling protocol. It's
> > coming soon.
> 
> I've also hacked together a (non-working) version that handles the
> locking and the tempdir issue. Brain a little fuzzy right now, but I'll
> fix it tomorrow and post it - unless you get to it first, Nicolas - :)
> 
> Regards,
> Jim
> 
> 

Well, I had a go last night, but my brain was a little fuzzy too, so I
don't mind a double-check. I didn't use the global lock n? 0, which
would serialize all access to all sessions, but a lock named after the
session, just like it was done in BaseSession.lock() and
BaseSession.unlock().

BTW, I'm not sure I understand the current locking system in
BaseSession : it looks to me as if the lock on the session was held
for the duration of the whole request (the lock being released during
the request cleanup). Grisha, is this true ? If this is so, then there
is no need to lock anything in FileSession, as the BaseSession already
ensure a proper level of locking.

Regards,
Nicolas

From grahamd at dscpl.com.au  Fri Apr  8 02:22:56 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Fri Apr  8 02:22:57 2005
Subject: [mod_python] In URGENT Need of "API for Printing report in python"
Message-ID: <1112941376.25587@dscpl.user.openhosting.com>

tushar liladhar patil wrote ..
>   
> R/Sir,
>       I am Tushar Patil. I m working on python2.3.4 using mandrake10.1
> as a platform, with NGO called as SVS software. We are developing a kind
> of CBT(computer Based Training).So I m in Urgent need of "Report Printing",
> API's in python.

Reports in what output format and with input from what data source?

If one needs to generate reports where the output format is PDF, good
choices are reportlab and trml2pdf. Web sites are:

  http://www.reportlab.org
  http://www.openreport.org

Live example of both being used to generate output with mod_python
can be found at:

  http://www.dscpl.com.au/projects/vampire/examples/reportlab/reportlab-demo.pdf
  http://www.dscpl.com.au/projects/vampire/examples/reportlab/trml2pdf-demo.pdf

These examples focus more on showing graphics, but the packages
can be used to textual output as well.

Source input for these two examples is:

  http://www.dscpl.com.au/projects/vampire/source/examples/reportlab/reportlab-demo.py
  
  http://www.dscpl.com.au/projects/vampire/source/examples/reportlab/trml2pdf-demo.rml
  http://www.dscpl.com.au/projects/vampire/source/examples/reportlab/_handler.py

The examples utilitise Vampire, but could be made to work within
other mod_python based systems.

If all you want is to generate HTML based reports, any of the various
packages for mod_python could be used.

Graham
From dharana at dharana.net  Fri Apr  8 04:36:43 2005
From: dharana at dharana.net (dharana)
Date: Fri Apr  8 04:36:54 2005
Subject: [mod_python] No space left on device: Failed to create global mutex
Message-ID: <4256429B.5040105@dharana.net>

This morning after some tests I noticed hda1 was running out of space 
(236Mb left) so I cleaned it and tried to restart apache. Then apache 
died and this is was the logs say:


/var/log # tail /usr/local/hosting/logs/error_log
[Fri Apr 08 10:30:07 2005] [notice] Digest: done
[Fri Apr 08 10:30:08 2005] [notice] mod_python: Creating 32 session 
mutexes based on 150 max processes and 0 max threads.
[Fri Apr 08 10:30:08 2005] [error] (28)No space left on device: 
mod_python: Failed to create global mutex 0 of 32 (/tmp/mpmtx27
090).
Configuration Failed
[Fri Apr 08 10:31:07 2005] [notice] suEXEC mechanism enabled (wrapper: 
/usr/local/hosting/bin/suexec)
[Fri Apr 08 10:31:07 2005] [notice] Digest: generating secret for digest 
authentication ...
[Fri Apr 08 10:31:07 2005] [notice] Digest: done
[Fri Apr 08 10:31:08 2005] [notice] mod_python: Creating 32 session 
mutexes based on 150 max processes and 0 max threads.
[Fri Apr 08 10:31:08 2005] [error] (28)No space left on device: 
mod_python: Failed to create global mutex 0 of 32 (/tmp/mpmtx27
460).
Configuration Failed



I believe it has plenty of space:

/var/log # LC_ALL=en df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/hda1             5.5G  4.6G  709M  87% /
/dev/hdc1             113G   74G   33G  69% /var
/dev/hda2              30G   17G   12G  58% /var/backups


/var/log # LC_ALL=en df -i
Filesystem            Inodes   IUsed   IFree IUse% Mounted on
/dev/hda1             732960  174583  558377   24% /
/dev/hdc1            15089664  150185 14939479    1% /var
/dev/hda2            4030464  122784 3907680    4% /var/backups



Before I got this error I created 10000+ files in /tmp but deleted them 
afterwards (testing FileSession).

-- 
Juan Alonso
http://gamersmafia.com | http://laflecha.net

From atrus at stackworks.net  Fri Apr  8 05:24:09 2005
From: atrus at stackworks.net (Yann Ramin)
Date: Fri Apr  8 05:24:13 2005
Subject: [mod_python] No space left on device: Failed to create global
	mutex
In-Reply-To: <4256429B.5040105@dharana.net>
References: <4256429B.5040105@dharana.net>
Message-ID: <42564DB9.6060703@stackworks.net>


You actually need to increase the amount of SysV Semaphores on your system.

I use (in /etc/sysctl.conf):
kernel.sem = 512 32000 100 512
(set the options in this file by running sysctl -p).

Yann


dharana wrote:
> This morning after some tests I noticed hda1 was running out of space 
> (236Mb left) so I cleaned it and tried to restart apache. Then apache 
> died and this is was the logs say:
> 
> 
> /var/log # tail /usr/local/hosting/logs/error_log
> [Fri Apr 08 10:30:07 2005] [notice] Digest: done
> [Fri Apr 08 10:30:08 2005] [notice] mod_python: Creating 32 session 
> mutexes based on 150 max processes and 0 max threads.
> [Fri Apr 08 10:30:08 2005] [error] (28)No space left on device: 
> mod_python: Failed to create global mutex 0 of 32 (/tmp/mpmtx27
> 090).
> Configuration Failed
> [Fri Apr 08 10:31:07 2005] [notice] suEXEC mechanism enabled (wrapper: 
> /usr/local/hosting/bin/suexec)
> [Fri Apr 08 10:31:07 2005] [notice] Digest: generating secret for digest 
> authentication ...
> [Fri Apr 08 10:31:07 2005] [notice] Digest: done
> [Fri Apr 08 10:31:08 2005] [notice] mod_python: Creating 32 session 
> mutexes based on 150 max processes and 0 max threads.
> [Fri Apr 08 10:31:08 2005] [error] (28)No space left on device: 
> mod_python: Failed to create global mutex 0 of 32 (/tmp/mpmtx27
> 460).
> Configuration Failed
> 
> 
> 
> I believe it has plenty of space:
> 
> /var/log # LC_ALL=en df -h
> Filesystem            Size  Used Avail Use% Mounted on
> /dev/hda1             5.5G  4.6G  709M  87% /
> /dev/hdc1             113G   74G   33G  69% /var
> /dev/hda2              30G   17G   12G  58% /var/backups
> 
> 
> /var/log # LC_ALL=en df -i
> Filesystem            Inodes   IUsed   IFree IUse% Mounted on
> /dev/hda1             732960  174583  558377   24% /
> /dev/hdc1            15089664  150185 14939479    1% /var
> /dev/hda2            4030464  122784 3907680    4% /var/backups
> 
> 
> 
> Before I got this error I created 10000+ files in /tmp but deleted them 
> afterwards (testing FileSession).
> 

From dharana at dharana.net  Fri Apr  8 05:50:17 2005
From: dharana at dharana.net (dharana)
Date: Fri Apr  8 05:50:26 2005
Subject: [mod_python] No space left on device: Failed to create global
	mutex
In-Reply-To: <42564DB9.6060703@stackworks.net>
References: <4256429B.5040105@dharana.net> <42564DB9.6060703@stackworks.net>
Message-ID: <425653D9.4070206@dharana.net>

Thank you, it works now. Maybe it should be added to the FAQ?

http://www.modpython.org/FAQ/faqw.py?req=new&section=2

Yann Ramin wrote:
> 
> You actually need to increase the amount of SysV Semaphores on your system.
> 
> I use (in /etc/sysctl.conf):
> kernel.sem = 512 32000 100 512
> (set the options in this file by running sysctl -p).
> 
> Yann
> 
> 
> dharana wrote:
> 
>> This morning after some tests I noticed hda1 was running out of space 
>> (236Mb left) so I cleaned it and tried to restart apache. Then apache 
>> died and this is was the logs say:
>>
>>
>> /var/log # tail /usr/local/hosting/logs/error_log
>> [Fri Apr 08 10:30:07 2005] [notice] Digest: done
>> [Fri Apr 08 10:30:08 2005] [notice] mod_python: Creating 32 session 
>> mutexes based on 150 max processes and 0 max threads.
>> [Fri Apr 08 10:30:08 2005] [error] (28)No space left on device: 
>> mod_python: Failed to create global mutex 0 of 32 (/tmp/mpmtx27
>> 090).
>> Configuration Failed
>> [Fri Apr 08 10:31:07 2005] [notice] suEXEC mechanism enabled (wrapper: 
>> /usr/local/hosting/bin/suexec)
>> [Fri Apr 08 10:31:07 2005] [notice] Digest: generating secret for 
>> digest authentication ...
>> [Fri Apr 08 10:31:07 2005] [notice] Digest: done
>> [Fri Apr 08 10:31:08 2005] [notice] mod_python: Creating 32 session 
>> mutexes based on 150 max processes and 0 max threads.
>> [Fri Apr 08 10:31:08 2005] [error] (28)No space left on device: 
>> mod_python: Failed to create global mutex 0 of 32 (/tmp/mpmtx27
>> 460).
>> Configuration Failed
>>
>>
>>
>> I believe it has plenty of space:
>>
>> /var/log # LC_ALL=en df -h
>> Filesystem            Size  Used Avail Use% Mounted on
>> /dev/hda1             5.5G  4.6G  709M  87% /
>> /dev/hdc1             113G   74G   33G  69% /var
>> /dev/hda2              30G   17G   12G  58% /var/backups
>>
>>
>> /var/log # LC_ALL=en df -i
>> Filesystem            Inodes   IUsed   IFree IUse% Mounted on
>> /dev/hda1             732960  174583  558377   24% /
>> /dev/hdc1            15089664  150185 14939479    1% /var
>> /dev/hda2            4030464  122784 3907680    4% /var/backups
>>
>>
>>
>> Before I got this error I created 10000+ files in /tmp but deleted 
>> them afterwards (testing FileSession).
>>
> 
> 
> 
> 

-- 
Juan Alonso
http://gamersmafia.com | http://laflecha.net

From jason at ruff.com  Fri Apr  8 11:42:16 2005
From: jason at ruff.com (Jason Lanquist)
Date: Fri Apr  8 11:42:31 2005
Subject: [mod_python] How to stop reimporting modules
Message-ID: <4256A658.CF7953A1@ruff.com>

Hi, I've got a page that refreshes itself every 45 seconds (fetching
dynamic content).  When it does this, the following line is added to the
apache error_log:

[notice] mod_python: (Re)importing module 'rt_track' with path set to
'['/home/hh4/public_htm
l']'

rt_track is not a py file, rather it's defined in index.py.  index.py
doesn't get updated very much at all anymore so I'm wondering why it has
to reimport each time?

Currently I have a couple of people beta testing this site but only
after a couple of hours, our error_log file is quite big with these
[notice] entries being added so frequently.  I dread to think of looking
at the log once more people start using it.  If this isn't a problem, is
there a way to get it to stop reimporting rt_track.  Is there a problem
with the way I am setup?

I'm running Linux Slackware 2.4.22 kernel
            Apache 2.0.49
            mod_python 3.1.3
            Python 2.3.3

mod_python setup in httpd.conf
---------------------
...
<Directory "/home/hh4/public_html/">
  AllowOverride All
  PythonInterpPerDirectory On
</Directory>
...
---------------------

/home/hh4/.htaccess
---------------------
SetHandler mod_python
PythonHandler mod_python.publisher
PythonDebug On
<Files ~ "\.(gif|jpe?g|png|class|js|wav|css)$">
  SetHandler default
</Files>
---------------------

I saw in the archives that turning PythonDebug Off will stop this but
since I am still in the debugging mode, PythonDebug is extremely helpful
to us so I would like to not have to turn that off.

Thanks,

Jason Lanquist
From grahamd at dscpl.com.au  Fri Apr  8 17:45:56 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Fri Apr  8 17:46:05 2005
Subject: [mod_python] How to stop reimporting modules
In-Reply-To: <4256A658.CF7953A1@ruff.com>
References: <4256A658.CF7953A1@ruff.com>
Message-ID: <8195757cbeefb6691814205629a1324a@dscpl.com.au>

Turning off module autoreloading probably will not actually help.
It is a known problem when using the same module name in multiple
directories such as with "index.py". see:

   http://issues.apache.org/jira/browse/MODPYTHON-9
   http://issues.apache.org/jira/browse/MODPYTHON-10
   http://issues.apache.org/jira/browse/MODPYTHON-11

Only choice if using mod_python.publisher is to make sure every
Python code file on the site is uniquely named.

Only other alternative is to investigate the drop in replacement
for mod_python.publisher that comes with Vampire and which tries
to address this specific issue. The version in Vampire isn't 100%
compatible because of the way in which it goes about fixing this
and other problems in mod_python.publisher, so depending on how
complicated your site, it may or may not be a trivial matter to
switch over.

Vampire can be found at:

   http://www.dscpl.com.au/projects/vampire

Graham

On 09/04/2005, at 1:42 AM, Jason Lanquist wrote:

> Hi, I've got a page that refreshes itself every 45 seconds (fetching
> dynamic content).  When it does this, the following line is added to 
> the
> apache error_log:
>
> [notice] mod_python: (Re)importing module 'rt_track' with path set to
> '['/home/hh4/public_htm
> l']'
>
> rt_track is not a py file, rather it's defined in index.py.  index.py
> doesn't get updated very much at all anymore so I'm wondering why it 
> has
> to reimport each time?
>
> Currently I have a couple of people beta testing this site but only
> after a couple of hours, our error_log file is quite big with these
> [notice] entries being added so frequently.  I dread to think of 
> looking
> at the log once more people start using it.  If this isn't a problem, 
> is
> there a way to get it to stop reimporting rt_track.  Is there a problem
> with the way I am setup?
>
> I'm running Linux Slackware 2.4.22 kernel
>             Apache 2.0.49
>             mod_python 3.1.3
>             Python 2.3.3
>
> mod_python setup in httpd.conf
> ---------------------
> ...
> <Directory "/home/hh4/public_html/">
>   AllowOverride All
>   PythonInterpPerDirectory On
> </Directory>
> ...
> ---------------------
>
> /home/hh4/.htaccess
> ---------------------
> SetHandler mod_python
> PythonHandler mod_python.publisher
> PythonDebug On
> <Files ~ "\.(gif|jpe?g|png|class|js|wav|css)$">
>   SetHandler default
> </Files>
> ---------------------
>
> I saw in the archives that turning PythonDebug Off will stop this but
> since I am still in the debugging mode, PythonDebug is extremely 
> helpful
> to us so I would like to not have to turn that off.
>
> Thanks,
>
> Jason Lanquist
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From jarrod.roberson at gmail.com  Fri Apr  8 17:57:58 2005
From: jarrod.roberson at gmail.com (jarrod roberson)
Date: Fri Apr  8 17:58:00 2005
Subject: [mod_python] How to control,
	specify or predict the order in which PythonHandler's
	process requests?
Message-ID: <2389d47305040814572da0a873@mail.gmail.com>

I need to be able to make sure my handler fires before say the mod_dav handler.
I there a way to enforce this.

What I have handlers that need to fire in a specific order?
-- 
If you don't know what you want, you probably need a nap.
From tusharpatil1982 at rediffmail.com  Sat Apr  9 00:18:28 2005
From: tusharpatil1982 at rediffmail.com (tushar liladhar patil)
Date: Sat Apr  9 00:16:56 2005
Subject: [mod_python] How to Connect printer in python2.3.4/pygtk2.0? pl
	it's very URGENT!!!
Message-ID: <20050409041828.22440.qmail@webmail35.rediffmail.com>

  
R/sir,
        I m Tushar Patil, Working in NGO called SVS Software. We are developing CBT (computer Based Training), by using python2.3.4,glade2.0 and mandrake10.1 linux as a platform for this.
        So I m in need of some API's for Printer connection in python, so that, these API's can interact with OS and the OS will give me the dialog box of priter, like in JAVA we have Printable interface.I had searched for reportlab but uptill i did'nt found any way to communicate with OS for Printer connection.
        So please if any one knows about this pl.. let me inform immediatly it's very urgent...and please do the needful, Im waiting for the nice reply.
Thanking u,
Tushar

SVS Software.
Near Dandekar Bridge,
Pune.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050409/c7cf2abf/attachment.html
From grahamd at dscpl.com.au  Sat Apr  9 00:36:20 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Apr  9 00:36:26 2005
Subject: [mod_python] How to Connect printer in python2.3.4/pygtk2.0? pl
	it's very URGENT!!!
In-Reply-To: <20050409041828.22440.qmail@webmail35.rediffmail.com>
References: <20050409041828.22440.qmail@webmail35.rediffmail.com>
Message-ID: <0d4a01688de01b0973213f32ddf37a85@dscpl.com.au>

Try posting your question on:

   http://groups-beta.google.com/group/comp.lang.python?hl=en

The mailing list you are posting on an the moment is specifically for
mod_python development under Apache and your need seems not to be
related to that so post somewhere more appropriate.

Your question perhaps isn't even really about Python at all, but
how to spool print jobs under Linux in general. You should perhaps
look in to what "lp" and "lpr" are on UNIX systems or "CUPS".

Graham

On 09/04/2005, at 2:18 PM, tushar liladhar patil wrote:

>  ?
>  R/sir,
>  ? ? ? ? I m Tushar Patil, Working in NGO called SVS Software. We are 
> developing CBT (computer Based Training), by using 
> python2.3.4,glade2.0 and mandrake10.1 linux as a platform for this.
>  ? ? ? ? So I m in need of some API's for Printer connection in 
> python, so that, these API's can interact with OS and the OS will give 
> me the dialog box of priter, like in JAVA we have Printable 
> interface.I had searched for reportlab but uptill i did'nt found any 
> way to communicate with OS for Printer connection.
>  ? ? ? ? So please if any one knows about this pl.. let me inform 
> immediatly it's very urgent...and please do the needful, Im waiting 
> for the nice reply.
>  Thanking u,
>  Tushar
>
>  SVS Software.
>  Near Dandekar Bridge,
>  Pune.
>
>
>  <inbox.gif>_______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python


From barry.pearce at copyrightwitness.net  Sat Apr  9 12:17:58 2005
From: barry.pearce at copyrightwitness.net (Barry Pearce)
Date: Sat Apr  9 12:16:00 2005
Subject: [mod_python] How to stop reimporting modules
In-Reply-To: <200504091600.j39G050n014402@modpython.org>
References: <200504091600.j39G050n014402@modpython.org>
Message-ID: <42580036.4070602@copyrightwitness.net>

Hi,

This is an interesting issue - I have my own handler but I have a 
problem where mod_python does NOT cause modules to be reloaded - despite 
having changed on the disk I would have expected the module to 
reload...but it stays the same until I restart the web server - perhaps 
there is something Im doing wrong!!

I really dont want to restart the apache server to upgrade my software - 
it kills all current sessions and downloads....

Any ideas?

Cheers,
Barry
From jg.lists at sympatico.ca  Sat Apr  9 12:56:43 2005
From: jg.lists at sympatico.ca (Jim Gallacher)
Date: Sat Apr  9 12:56:25 2005
Subject: [mod_python] How to stop reimporting modules
In-Reply-To: <42580036.4070602@copyrightwitness.net>
References: <200504091600.j39G050n014402@modpython.org>
	<42580036.4070602@copyrightwitness.net>
Message-ID: <4258094B.5000505@sympatico.ca>

Barry Pearce wrote:
> Hi,
> 
> This is an interesting issue - I have my own handler but I have a 
> problem where mod_python does NOT cause modules to be reloaded - despite 
> having changed on the disk I would have expected the module to 
> reload...but it stays the same until I restart the web server - perhaps 
> there is something Im doing wrong!!
> 
> I really dont want to restart the apache server to upgrade my software - 
> it kills all current sessions and downloads....
> 
> Any ideas?

My impression is that the handler specified in the apache PythonHandler 
directive does not get reloaded when changed. Of course I may be 
completely off the mark here.

For my code, the PythonHandler cms.publisher is just a stub that does a 
little pre-processing and then uses apache.import_module() to get my 
real handler. It's apache.import_module that does the reloading magic, 
and so I avoid restarting apache when my handler code changes. I figure 
once my code has pretty much settled down, I can change the 
PythonHandler to specify the real handler.

Regards,
Jim


From barry.pearce at copyrightwitness.net  Sat Apr  9 13:36:04 2005
From: barry.pearce at copyrightwitness.net (Barry Pearce)
Date: Sat Apr  9 13:33:51 2005
Subject: [mod_python] How to stop reimporting modules
In-Reply-To: <4258094B.5000505@sympatico.ca>
References: <200504091600.j39G050n014402@modpython.org>
	<42580036.4070602@copyrightwitness.net>
	<4258094B.5000505@sympatico.ca>
Message-ID: <42581284.8030406@copyrightwitness.net>

Hi Jim,

>> This is an interesting issue - I have my own handler but I have a 
>> problem where mod_python does NOT cause modules to be reloaded - 
>> despite having changed on the disk I would have expected the module to 
>> reload...but it stays the same until I restart the web server - 
>> perhaps there is something Im doing wrong!!
>>
>> I really dont want to restart the apache server to upgrade my software 
>> - it kills all current sessions and downloads....
>>
>> Any ideas?
> 
> 
> My impression is that the handler specified in the apache PythonHandler 
> directive does not get reloaded when changed. Of course I may be 
> completely off the mark here.

Ah. OK....thats why everything that it in turn imports also remains 
fixed in memory...its just a pain in the bum when I change something 
that the re-import does not take place.

> For my code, the PythonHandler cms.publisher is just a stub that does a 
> little pre-processing and then uses apache.import_module() to get my 
> real handler. It's apache.import_module that does the reloading magic, 
> and so I avoid restarting apache when my handler code changes. I figure 
> once my code has pretty much settled down, I can change the 
> PythonHandler to specify the real handler.

The issue comes during upgrade of live sites with many users with 
concurrent sessions and no 'quiet' period per say where a restart could 
be sensibly placed.

Interestingly I have been using a large number of python files and using 
the standard python import - however, if the top level module is not 
reimported it will never execute any of the other import statements.

Interesting...sorry im rambling...

Perhaps I need to re-evaluate my import strategy and call 
apache.import_module() instead of just relying on the python import...

Now I dont want it all checked on each request - but maybe I can write a 
handler that I can send a request to which re-evalutes all imported 
modules and then appropriately reloads them...

hmmm...?

any ideas?

Cheers,
Barry
From jg.lists at sympatico.ca  Sat Apr  9 15:25:25 2005
From: jg.lists at sympatico.ca (Jim Gallacher)
Date: Sat Apr  9 15:25:27 2005
Subject: [mod_python] How to stop reimporting modules
In-Reply-To: <42581284.8030406@copyrightwitness.net>
References: <200504091600.j39G050n014402@modpython.org>
	<42580036.4070602@copyrightwitness.net>
	<4258094B.5000505@sympatico.ca>
	<42581284.8030406@copyrightwitness.net>
Message-ID: <42582C25.4090305@sympatico.ca>

Hi Barry,

Barry Pearce wrote:
> Hi Jim,
> 
>>> This is an interesting issue - I have my own handler but I have a 
>>> problem where mod_python does NOT cause modules to be reloaded - 
>>> despite having changed on the disk I would have expected the module 
>>> to reload...but it stays the same until I restart the web server - 
>>> perhaps there is something Im doing wrong!!
>>>
>>> I really dont want to restart the apache server to upgrade my 
>>> software - it kills all current sessions and downloads....
>>>
>>> Any ideas?
>>
>>
>>
>> My impression is that the handler specified in the apache 
>> PythonHandler directive does not get reloaded when changed. Of course 
>> I may be completely off the mark here.
> 
> 
> Ah. OK....thats why everything that it in turn imports also remains 
> fixed in memory...its just a pain in the bum when I change something 
> that the re-import does not take place.
> 
>> For my code, the PythonHandler cms.publisher is just a stub that does 
>> a little pre-processing and then uses apache.import_module() to get my 
>> real handler. It's apache.import_module that does the reloading magic, 
>> and so I avoid restarting apache when my handler code changes. I 
>> figure once my code has pretty much settled down, I can change the 
>> PythonHandler to specify the real handler.
> 
> 
> The issue comes during upgrade of live sites with many users with 
> concurrent sessions and no 'quiet' period per say where a restart could 
> be sensibly placed.
> 
> Interestingly I have been using a large number of python files and using 
> the standard python import - however, if the top level module is not 
> reimported it will never execute any of the other import statements.
> 
> Interesting...sorry im rambling...
> 
> Perhaps I need to re-evaluate my import strategy and call 
> apache.import_module() instead of just relying on the python import...
> 
> Now I dont want it all checked on each request - but maybe I can write a 
> handler that I can send a request to which re-evalutes all imported 
> modules and then appropriately reloads them...

I don't think this will work in the apache prefork model. (I have no 
idea about the threaded model). In the prefork, each child process has 
it's own copy of the python interpreter and modules. Your call to the 
special handler will only cause the child that handles that request to 
reload. All the other children will still have a copy of the old 
modules. You have to make sure that each child gets a new copy - which 
is what happens when you restart apache. All the child processes are 
killed and then new ones created which will import the new modules.

So maybe your main handler can check a flag defined by a PythonOption 
directive and reload as necessary? Thus each child process will be 
forced to reload it's modules.

def handler(req):
    opts = req.get_options()
    reload_modules = int(opts.get('RELOAD_MODULES', '0'))

    if reload_modules:
         do_magic_module_reload()

    ... handle request ...

Edit your apache conf file for the site:
   PythonOption RELOAD_MODULES 1

Run 'apache reload' to read the config file changes. Subsequent requests 
will see the flag and reload of any modified modules. Once everything 
seems to be working change the flag back to 0 and run 'apache reload'.

Or how about having a version variable defined with module scope and a 
corresponding PythonOption directive.

# your publisher module
__version__ = 41

def handler(req):
    opts = req.get_options()
    if opts.has_key('MODULE_VERSION'):
        version = int(opts['MODULE_VERSION'])
        if __version__ < version:
            do_magic_module_reload()
            __version__ = version

    ... handle request ...

And in your apache config:
PythonOption MODULE_VERSION 42

There, all you need to do now is write the code for 
do_magic_module_reload(). Oh, and send me copy when you're done. :)

But seriously, apache.import_module won't do what you want, but it looks 
like an interesting place to start. Python introspection is a new topic 
for me, but I don't think a solution to this problem is too difficult.

Regards,
Jim





From gomo at datafull.com  Sat Apr  9 15:38:35 2005
From: gomo at datafull.com (Gonzalo =?ISO-8859-1?Q?Sainz-Tr=E1paga?=)
Date: Sat Apr  9 15:41:11 2005
Subject: [mod_python] Dictionary persistance weirdness
Message-ID: <1113075515.29460.59.camel@localhost>

Hi,
I'm building my first application with mod_python. I am using Ian
Bicking's SQLObject, validators and HTMLfill among other tools.
I built a custom handler that parses the url and loads an external
module, passing it a request object and eventually, an ID integer that
is extracted from the URI.

Example:
http://site.com/race.py/4/signup will trigger "import race;
race.signup(4,req)" and that function will provide a form in order for
people to sign themselves up for race 4.

Form handling and data parsing (for POST or GET data) is done in
separate modules that are imported when needed, so race.py actually
imports formgen.py and formgen.py imports VarsWrapper (from wrappers.py)
in order to parse data for his form and tell whether he needs to print
an error message, or the input is valid.

The process works fine up to races.py: it gets the POSTed data fine, but
then if I try to pass the variables received to the form handler, the
handler will only receive them correctly on the first call to it after a
server restart. For later calls, the form handler sticks to the values
received on his first request.

Code snippets:

-- race.py -------------------------
def signup(id,req):
    from formgen import FormInscripcion

    v = VarsWrapper(req)
    c = v.get_vars()

    f = FormInscripcion(id)
    
    tpl.locals.contenido = f.handle(c)
    return tpl.get_html()


-- formgen.py -------------------------

class FormInscripcion:
(...)
    def handle(self,vars):
        # check for sent data
        if ('id_regata',str(self.id_regata)) in vars.items():
            return self._post(vars) # triggers a data handler
        else: 
            return self._form() # shows the clean form
(...)


-- wrappers.py -------------------------
class VarsWrapper:
    def __init__(self,req):
        self.fs = util.FieldStorage(req)

    def get_vars():
        d = {}
        for each in self.fs.list:
            self.d[x.name] = x.value
        return d


So again, the problem arises when calling FormInscripcion.handle() for
the 2nd time or more: it will stick to the data received on the 1st
request passed to it. If i print the variable dictionary (c in race.py,
vars in formgen.py) after the form, c will change with new POST data, as
vars will stay constant after the 1st request.
The weird thing is that i'm passing data from pyhandler.py to race.py in
the same way that i'm passing it from race.py to formgen.py, and it
refuses to work correctly in the latter.
I have already tried pretty much every single possible cause for this
oddity with no consistent results, so i'm pretty confident that there's
something i'm missing that's not inherent to my app's logic, but to my
app's login combined with some mod_python specific complication.
In short: i'm going nuts!
Sorry for all the writing, but I really hope somebody can help me.
Thanks in advance,

-- 
Gonzalo Sainz-Tr?paga (GomoX)
GnuPG Fingerprint: A0AF 3BBF EB93 7EFE 6628  C5A5 F073 9442 6DE4 A497
Public Key: http://pgp.mit.edu:11371/pks/lookup?op=get&search=0x6DE4A497
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: This is a digitally signed message part
Url : http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050409/d59b9ae4/attachment.bin
From mike at mrlventures.com  Sat Apr  9 17:06:02 2005
From: mike at mrlventures.com (Mike Solomon)
Date: Sat Apr  9 17:06:09 2005
Subject: [mod_python] All spawned threads in Restricted Exection Mode
Message-ID: <acdbe31f024b8ed130d32f878769f9ce@mrlventures.com>

I too see this problem and it's driving me bananas.

I've got Apache 2.0.53, mod_python 3.1.4, python 2.4 installed under 
SuSE 9.1. My servlet code and apache config are exactly the same as 
Alan's (to minimize potential setup variables.)

My specific problem is that pickling causes this unmarshal error:

(it doesn't seem to matter what i pickle, or if i use cPickle vs pickle)

Traceback (most recent call last):
   File "/home/msolomon/test/zclient/client.py", line 10, in
   RuntimeError: cannot unmarshal code objects in restricted execution 
mode

That line looks like this:
  9:  obj = None
10:  in_a_pickle = pickle.dumps(obj, 2)


Now here is a very strange observation - this exception does not occur 
if I put the contents of client.py into threadtest.py - it only happens 
when the code is imported.

I'm not sure why threads appear to be executing in restricted mode - 
but if that is the problem, I guess I'd like to know how to turn that 
off.  Despite stumbling onto a few occurrences of this problem, I have 
yet to see a solution posted anywhere.

If either of you gentlemen have any additional insight, I would 
appreciate it.

------

My servlet looks like this (threadtest.py):

import mod_python
from zclient.client import Client

def handler(req):
   c = Client()
   req.write(str(c.perform()))
   return mod_python.apache.OK


This is zclient/client.py:

import cPickle as pickle
import threading, traceback

class Client:
   def thread_op(self, results):
     try:
       obj = None
       in_a_pickle = pickle.dumps(obj, 2)
       results.append('ok')
     except Exception, e:
       results.extend(traceback.format_exc().split('\n'))

   def perform(self):
     results = []
     t = threading.Thread(target=self.thread_op, args=(results,))
     t.start()
     t.join()
     return str(results)

From grahamd at dscpl.com.au  Sat Apr  9 17:43:55 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Apr  9 17:44:06 2005
Subject: [mod_python] How to stop reimporting modules
In-Reply-To: <42582C25.4090305@sympatico.ca>
References: <200504091600.j39G050n014402@modpython.org>
	<42580036.4070602@copyrightwitness.net>
	<4258094B.5000505@sympatico.ca>
	<42581284.8030406@copyrightwitness.net>
	<42582C25.4090305@sympatico.ca>
Message-ID: <c0ab874df8940011f3f5eb1c39fe53b4@dscpl.com.au>

I am starting to sound like a broken record, but the module importing 
system in
Vampire addresses all these sorts of problems with modifications to sub 
imports
and will reload unchanged parent modules even when it is only a sub 
import that
has changed. Thus it is possible when using Vampire to make changes 
without
restarting Apache and they will all be picked up correctly.

There is so far only one class of problem I know of where when using 
Vampire one
would still need to do a restart. This is where objects are cached and 
type
comparisons are being done between cached objects and some class type 
they are
meant to be created from. This can still fail because on a reload the 
type
object itself could be replaced and therefore will not match the type 
object
of a cached instance of a previous version. This problem also occurs in 
the
standard mod_python module loading system and isn't Vampire specific 
though.

I'll go into this more or point to previous posts I have made on this 
topic if
you are genuinely interested in trying to switch to Vampire.

Note that Vampire isn't a framework which requires you to change 
absolutely
everything. It doesn't force you to use a specific templating system. 
Its main
purpose is to expand on the basic selection mechanism for handlers in 
mod_python
and address all these module reloading issues by providing an alternate 
module
loading system.

Graham

On 10/04/2005, at 5:25 AM, Jim Gallacher wrote:

> Hi Barry,
>
> Barry Pearce wrote:
>> Hi Jim,
>>>> This is an interesting issue - I have my own handler but I have a 
>>>> problem where mod_python does NOT cause modules to be reloaded - 
>>>> despite having changed on the disk I would have expected the module 
>>>> to reload...but it stays the same until I restart the web server - 
>>>> perhaps there is something Im doing wrong!!
>>>>
>>>> I really dont want to restart the apache server to upgrade my 
>>>> software - it kills all current sessions and downloads....
>>>>
>>>> Any ideas?
>>>
>>>
>>>
>>> My impression is that the handler specified in the apache 
>>> PythonHandler directive does not get reloaded when changed. Of 
>>> course I may be completely off the mark here.
>> Ah. OK....thats why everything that it in turn imports also remains 
>> fixed in memory...its just a pain in the bum when I change something 
>> that the re-import does not take place.
>>> For my code, the PythonHandler cms.publisher is just a stub that 
>>> does a little pre-processing and then uses apache.import_module() to 
>>> get my real handler. It's apache.import_module that does the 
>>> reloading magic, and so I avoid restarting apache when my handler 
>>> code changes. I figure once my code has pretty much settled down, I 
>>> can change the PythonHandler to specify the real handler.
>> The issue comes during upgrade of live sites with many users with 
>> concurrent sessions and no 'quiet' period per say where a restart 
>> could be sensibly placed.
>> Interestingly I have been using a large number of python files and 
>> using the standard python import - however, if the top level module 
>> is not reimported it will never execute any of the other import 
>> statements.
>> Interesting...sorry im rambling...
>> Perhaps I need to re-evaluate my import strategy and call 
>> apache.import_module() instead of just relying on the python 
>> import...
>> Now I dont want it all checked on each request - but maybe I can 
>> write a handler that I can send a request to which re-evalutes all 
>> imported modules and then appropriately reloads them...
>
> I don't think this will work in the apache prefork model. (I have no 
> idea about the threaded model). In the prefork, each child process has 
> it's own copy of the python interpreter and modules. Your call to the 
> special handler will only cause the child that handles that request to 
> reload. All the other children will still have a copy of the old 
> modules. You have to make sure that each child gets a new copy - which 
> is what happens when you restart apache. All the child processes are 
> killed and then new ones created which will import the new modules.
>
> So maybe your main handler can check a flag defined by a PythonOption 
> directive and reload as necessary? Thus each child process will be 
> forced to reload it's modules.
>
> def handler(req):
>    opts = req.get_options()
>    reload_modules = int(opts.get('RELOAD_MODULES', '0'))
>
>    if reload_modules:
>         do_magic_module_reload()
>
>    ... handle request ...
>
> Edit your apache conf file for the site:
>   PythonOption RELOAD_MODULES 1
>
> Run 'apache reload' to read the config file changes. Subsequent 
> requests will see the flag and reload of any modified modules. Once 
> everything seems to be working change the flag back to 0 and run 
> 'apache reload'.
>
> Or how about having a version variable defined with module scope and a 
> corresponding PythonOption directive.
>
> # your publisher module
> __version__ = 41
>
> def handler(req):
>    opts = req.get_options()
>    if opts.has_key('MODULE_VERSION'):
>        version = int(opts['MODULE_VERSION'])
>        if __version__ < version:
>            do_magic_module_reload()
>            __version__ = version
>
>    ... handle request ...
>
> And in your apache config:
> PythonOption MODULE_VERSION 42
>
> There, all you need to do now is write the code for 
> do_magic_module_reload(). Oh, and send me copy when you're done. :)
>
> But seriously, apache.import_module won't do what you want, but it 
> looks like an interesting place to start. Python introspection is a 
> new topic for me, but I don't think a solution to this problem is too 
> difficult.
>
> Regards,
> Jim
>
>
>
>
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From dharana at dharana.net  Sat Apr  9 17:59:16 2005
From: dharana at dharana.net (dharana)
Date: Sat Apr  9 17:59:26 2005
Subject: [mod_python] How to stop reimporting modules
In-Reply-To: <c0ab874df8940011f3f5eb1c39fe53b4@dscpl.com.au>
References: <200504091600.j39G050n014402@modpython.org>	<42580036.4070602@copyrightwitness.net>	<4258094B.5000505@sympatico.ca>	<42581284.8030406@copyrightwitness.net>	<42582C25.4090305@sympatico.ca>
	<c0ab874df8940011f3f5eb1c39fe53b4@dscpl.com.au>
Message-ID: <42585034.4020401@dharana.net>

One small question. If the issue of submodules being cached by 
mod_python is so frequent, shouldn't be an indicator that perhaps 
something should be changed?

I know there are archives. I know it may probable has been answered many 
times before but everytime I'm coding with mod_python I have a terminal 
with buffers full of "apachectl restart" and as Python is an interpreted 
language, not a compiled one I always find it weird to need to do that.

Isn't it trivial or correct to import the vampire caching mechanism into 
mod_python and _only_ use it with an specific apache Python* directive?

Graham Dumpleton wrote:
> I am starting to sound like a broken record, but the module importing 
> system in
> Vampire addresses all these sorts of problems with modifications to sub 
> imports
> and will reload unchanged parent modules even when it is only a sub 
> import that
> has changed. Thus it is possible when using Vampire to make changes without
> restarting Apache and they will all be picked up correctly.
> 
> There is so far only one class of problem I know of where when using 
> Vampire one
> would still need to do a restart. This is where objects are cached and type
> comparisons are being done between cached objects and some class type 
> they are
> meant to be created from. This can still fail because on a reload the type
> object itself could be replaced and therefore will not match the type 
> object
> of a cached instance of a previous version. This problem also occurs in the
> standard mod_python module loading system and isn't Vampire specific 
> though.
> 
> I'll go into this more or point to previous posts I have made on this 
> topic if
> you are genuinely interested in trying to switch to Vampire.
> 
> Note that Vampire isn't a framework which requires you to change absolutely
> everything. It doesn't force you to use a specific templating system. 
> Its main
> purpose is to expand on the basic selection mechanism for handlers in 
> mod_python
> and address all these module reloading issues by providing an alternate 
> module
> loading system.
> 
> Graham
> 
> On 10/04/2005, at 5:25 AM, Jim Gallacher wrote:
> 
>> Hi Barry,
>>
>> Barry Pearce wrote:
>>
>>> Hi Jim,
>>>
>>>>> This is an interesting issue - I have my own handler but I have a 
>>>>> problem where mod_python does NOT cause modules to be reloaded - 
>>>>> despite having changed on the disk I would have expected the module 
>>>>> to reload...but it stays the same until I restart the web server - 
>>>>> perhaps there is something Im doing wrong!!
>>>>>
>>>>> I really dont want to restart the apache server to upgrade my 
>>>>> software - it kills all current sessions and downloads....
>>>>>
>>>>> Any ideas?
>>>>
>>>>
>>>>
>>>>
>>>> My impression is that the handler specified in the apache 
>>>> PythonHandler directive does not get reloaded when changed. Of 
>>>> course I may be completely off the mark here.
>>>
>>> Ah. OK....thats why everything that it in turn imports also remains 
>>> fixed in memory...its just a pain in the bum when I change something 
>>> that the re-import does not take place.
>>>
>>>> For my code, the PythonHandler cms.publisher is just a stub that 
>>>> does a little pre-processing and then uses apache.import_module() to 
>>>> get my real handler. It's apache.import_module that does the 
>>>> reloading magic, and so I avoid restarting apache when my handler 
>>>> code changes. I figure once my code has pretty much settled down, I 
>>>> can change the PythonHandler to specify the real handler.
>>>
>>> The issue comes during upgrade of live sites with many users with 
>>> concurrent sessions and no 'quiet' period per say where a restart 
>>> could be sensibly placed.
>>> Interestingly I have been using a large number of python files and 
>>> using the standard python import - however, if the top level module 
>>> is not reimported it will never execute any of the other import 
>>> statements.
>>> Interesting...sorry im rambling...
>>> Perhaps I need to re-evaluate my import strategy and call 
>>> apache.import_module() instead of just relying on the python import...
>>> Now I dont want it all checked on each request - but maybe I can 
>>> write a handler that I can send a request to which re-evalutes all 
>>> imported modules and then appropriately reloads them...
>>
>>
>> I don't think this will work in the apache prefork model. (I have no 
>> idea about the threaded model). In the prefork, each child process has 
>> it's own copy of the python interpreter and modules. Your call to the 
>> special handler will only cause the child that handles that request to 
>> reload. All the other children will still have a copy of the old 
>> modules. You have to make sure that each child gets a new copy - which 
>> is what happens when you restart apache. All the child processes are 
>> killed and then new ones created which will import the new modules.
>>
>> So maybe your main handler can check a flag defined by a PythonOption 
>> directive and reload as necessary? Thus each child process will be 
>> forced to reload it's modules.
>>
>> def handler(req):
>>    opts = req.get_options()
>>    reload_modules = int(opts.get('RELOAD_MODULES', '0'))
>>
>>    if reload_modules:
>>         do_magic_module_reload()
>>
>>    ... handle request ...
>>
>> Edit your apache conf file for the site:
>>   PythonOption RELOAD_MODULES 1
>>
>> Run 'apache reload' to read the config file changes. Subsequent 
>> requests will see the flag and reload of any modified modules. Once 
>> everything seems to be working change the flag back to 0 and run 
>> 'apache reload'.
>>
>> Or how about having a version variable defined with module scope and a 
>> corresponding PythonOption directive.
>>
>> # your publisher module
>> __version__ = 41
>>
>> def handler(req):
>>    opts = req.get_options()
>>    if opts.has_key('MODULE_VERSION'):
>>        version = int(opts['MODULE_VERSION'])
>>        if __version__ < version:
>>            do_magic_module_reload()
>>            __version__ = version
>>
>>    ... handle request ...
>>
>> And in your apache config:
>> PythonOption MODULE_VERSION 42
>>
>> There, all you need to do now is write the code for 
>> do_magic_module_reload(). Oh, and send me copy when you're done. :)
>>
>> But seriously, apache.import_module won't do what you want, but it 
>> looks like an interesting place to start. Python introspection is a 
>> new topic for me, but I don't think a solution to this problem is too 
>> difficult.
>>
>> Regards,
>> Jim
>>
>>
>>
>>
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
> 
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 
> 
> 

-- 
Juan Alonso

From grahamd at dscpl.com.au  Sat Apr  9 20:59:16 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Apr  9 20:59:24 2005
Subject: [mod_python] How to stop reimporting modules
In-Reply-To: <42585034.4020401@dharana.net>
References: <200504091600.j39G050n014402@modpython.org>	<42580036.4070602@copyrightwitness.net>	<4258094B.5000505@sympatico.ca>	<42581284.8030406@copyrightwitness.net>	<42582C25.4090305@sympatico.ca>
	<c0ab874df8940011f3f5eb1c39fe53b4@dscpl.com.au>
	<42585034.4020401@dharana.net>
Message-ID: <3db54281adc688f68f0c15f18fc658a9@dscpl.com.au>


On 10/04/2005, at 7:59 AM, dharana wrote:

> One small question. If the issue of submodules being cached by 
> mod_python is so frequent, shouldn't be an indicator that perhaps 
> something should be changed?
>
> I know there are archives. I know it may probable has been answered 
> many times before but everytime I'm coding with mod_python I have a 
> terminal with buffers full of "apachectl restart" and as Python is an 
> interpreted language, not a compiled one I always find it weird to 
> need to do that.
>
> Isn't it trivial or correct to import the vampire caching mechanism 
> into mod_python and _only_ use it with an specific apache Python* 
> directive?

It isn't trivial to fix the problems in the mod_python module loading 
mechanism
because to address some of the issues would most likely necessitate 
breaking backward
compatibility. Some people have also expressed the view that they 
believe the current
system is fine and that although it has limitations that that is life 
and one should
accept it and code based on certain conventions which avoid any 
specific problems.

Overall, one could fix a couple of problems that it would be hard to 
argue are not
bugs, but other changes aren't likely to happen, as it means a change 
in the basic
concept of how one sees how module imports should be handled. Thus one 
would probably
find it quite hard to reach any consensus, especially if it means that 
one can't
guarantee that all existing code will work the same way without changes.

Graham

From jarrod.roberson at gmail.com  Sat Apr  9 22:57:04 2005
From: jarrod.roberson at gmail.com (jarrod roberson)
Date: Sat Apr  9 22:57:06 2005
Subject: [mod_python] How do you specify the order in which mod_python
	Handlers are called?
Message-ID: <2389d47305040919576b9c7b5f@mail.gmail.com>

I need to make sure multiple mod_python handlers are called in a specific order.
I also need to make sure they are before and/or after other "built in"
handlers such as mod_dav.

I am using Apache2 and mod_python 3.1.4, I can't find any examples or
specific details on this, and as I am not an Apache2 expert ( yet )
reading thru the apache docs is not going very fast.
From grahamd at dscpl.com.au  Sun Apr 10 03:18:00 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Apr 10 03:18:08 2005
Subject: [mod_python] How do you specify the order in which mod_python
	Handlers are called?
In-Reply-To: <2389d47305040919576b9c7b5f@mail.gmail.com>
References: <2389d47305040919576b9c7b5f@mail.gmail.com>
Message-ID: <c4fe2162bf438c1271b5675b549353be@dscpl.com.au>


On 10/04/2005, at 12:57 PM, jarrod roberson wrote:

> I need to make sure multiple mod_python handlers are called in a 
> specific order.
> I also need to make sure they are before and/or after other "built in"
> handlers such as mod_dav.
>
> I am using Apache2 and mod_python 3.1.4, I can't find any examples or
> specific details on this, and as I am not an Apache2 expert ( yet )
> reading thru the apache docs is not going very fast.

In terms of specific order of processing, for any type of handler,
the documentation says:

   All request handler directives have the following syntax:

      Python*Handler handler [handler ...] [ | .ext [.ext ...] ]

   Where handler is a callable object that accepts a single argument -
   request object, and .ext is a file extension.

   Multiple handlers can be specified on a single line, in which case
   they will be called sequentially, from left to right. Same handler
   directives can be specified multiple times as well, with the same
   result - all handlers listed will be executed sequentially, from
   first to last. If any handler in the sequence returns a value
   other than apache.OK, then execution of all subsequent handlers
   is aborted.

For each request, there are also different phases of processing. Taken
from the documentation index, these are:

	? 	5.1.2 PythonPostReadRequestHandler
	? 	5.1.3 PythonTransHandler
	? 	5.1.4 PythonHeaderParserHandler
	? 	5.1.5 PythonInitHandler
	? 	5.1.6 PythonAccessHandler
	? 	5.1.7 PythonAuthenHandler
	? 	5.1.8 PythonAuthzHandler
	? 	5.1.9 PythonTypeHandler
	? 	5.1.10 PythonFixupHandler
	? 	5.1.11 PythonHandler
	? 	5.1.12 PythonLogHandler
	? 	5.1.13 PythonCleanupHandler

They are in general supposed to be executed in that order if they are
defined. Noting though that authenhandler and authzhandler are only
executed if there is also appropriate configuration information in the
Apache configuration file which triggers their use. Some of the earlier
phases are also only triggered in certain situations.

Now take as example a .htaccess file which contains:

   SetHandler mod_python

   PythonHeaderParserHandler mptest::headerparser
   PythonAccessHandler mptest::accesshandler
   PythonHandler mptest::handler
   PythonLogHandler mptest::loghandler
   PythonCleanupHandler mptest::cleanuphandler

and "mptest.py" contains:

   from mod_python import apache
   import time

   class _Handler:
     def __init__(self,phase,status=apache.OK,delay=0):
       self.__phase = phase
       self.__status = status
       self.__delay = delay
     def __call__(self,req):
       req.log_error("</%s>"%self.__phase)
       time.sleep(self.__delay)
       req.log_error("<%s>"%self.__phase)
       return self.__status

   postreadrequesthandler = _Handler("postreadrequesthandler")
   transhandler = _Handler("transhandler")
   headerparserhandler = _Handler("headerparserhandler")
   inithandler = _Handler("inithandler")
   accesshandler = _Handler("accesshandler")
   authenhandler = _Handler("authenhandler")
   authzhandler = _Handler("authzhandler")
   typehandler = _Handler("typehandler")
   fixuphandler = _Handler("fixuphandler")
   handler = _Handler("handler",status=apache.DECLINED)
   loghandler = _Handler("loghandler")
   cleanuphandler = _Handler("cleanup")

If I request a plain text file residing in that directory in the log
file I will see:

   [Sun Apr 10 02:56:46 2005] [notice] mod_python: (Re)importing module 
'mptest'
   [Sun Apr 10 02:56:46 2005] [error] [client 128.121.126.33] 
</accesshandler>
   [Sun Apr 10 02:56:46 2005] [error] [client 128.121.126.33] 
<accesshandler>
   [Sun Apr 10 02:56:46 2005] [error] [client 128.121.126.33] </handler>
   [Sun Apr 10 02:56:46 2005] [error] [client 128.121.126.33] <handler>
   [Sun Apr 10 02:56:46 2005] [error] [client 128.121.126.33] 
</loghandler>
   [Sun Apr 10 02:56:46 2005] [error] [client 128.121.126.33] 
<loghandler>
   [Sun Apr 10 02:56:47 2005] [error] [client 128.121.126.33] </cleanup>
   [Sun Apr 10 02:56:47 2005] [error] [client 128.121.126.33] <cleanup>

Note that because apache.DECLINED was returned from handler(), Apache 
will
fall back to using the "default-handler" and will serve up the raw 
contents
of the file.

Unfortunately, if the file requested was a ".php" file, the raw contents
of the file will be returned and not the processed output from running
the PHP module on the raw file.

What to do to still have the ".php" file processed but the other handler
phases still be executed by mod_python isn't obvious though. What you 
need
to know is that the "SetHandler" and "AddHandler" directives only apply 
to
the "PythonHandler" directive and not to all the others.

Thus, if the following .htaccess file is instead used:

   #SetHandler mod_python

   PythonHeaderParserHandler mptest::headerparser
   PythonAccessHandler mptest::accesshandler
   PythonHandler mptest::handler
   PythonLogHandler mptest::loghandler
   PythonCleanupHandler mptest::cleanuphandler

Ie., comment out the "SetHandler", then "PythonHandler" directive 
doesn't
get applied. Make a request against a ".php" file in the directory and 
one
sees in the log file:

   [Sun Apr 10 03:01:18 2005] [notice] mod_python: (Re)importing module 
'mptest'
   [Sun Apr 10 03:01:18 2005] [error] [client 128.121.126.33] 
</accesshandler>
   [Sun Apr 10 03:01:18 2005] [error] [client 128.121.126.33] 
<accesshandler>
   [Sun Apr 10 03:01:18 2005] [error] [client 128.121.126.33] 
</loghandler>
   [Sun Apr 10 03:01:18 2005] [error] [client 128.121.126.33] 
<loghandler>
   [Sun Apr 10 03:01:18 2005] [error] [client 128.121.126.33] </cleanup>
   [Sun Apr 10 03:01:18 2005] [error] [client 128.121.126.33] <cleanup>

Note that "handler()" isn't called, the others still are and I get my 
rendered
PHP output displayed in the browser.

Thus you can see that a non mod_python content handler can be mixed 
with other
handlers which do use mod_python. If you were to add time delays in the 
various
phases to slow things done, you would see that the "PHP" output will 
appear on
your browser at the point where "handler()" would otherwise be called. 
This
therefore indicates that the log handler and later phases only get 
executed
after the PHP module has been executed to return the page content.

In terms of mod_dav, as far as I can see, if you don't set AddHandler or
SetHandler directives, you should be able to define an access handler or
log handler etc and mod_dav will be called where the handler would 
otherwise.

One final thing to try with the above is set the .htaccess file to 
contain
only:

   PythonHandlerModule mptest

When I know request the ".php" file I see:

   [Sun Apr 10 03:08:47 2005] [notice] mod_python: (Re)importing module 
'mptest'
   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
</headerparserhandler>
   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
<headerparserhandler>
   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
</accesshandler>
   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
<accesshandler>
   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
</loghandler>
   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
<loghandler>
   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] </cleanup>
   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] <cleanup>

I don't quite understand why the header parser handler is executed when 
the
"PythonHandlerModule" directive is used, but not when 
"PythonHeaderParserHandler"
is used explicitly.

BTW, "PythonHandlerModule" is actually broken. It works here because a 
handler
for every phase is defined. According to the documentation it is meant 
to
ignore the fact that a handler for a phase isn't there and simply just 
call
those which are. It doesn't do this though and raises a 500 error. 
Problem is
logged as:

   http://issues.apache.org/jira/browse/MODPYTHON-46

I inadvertently fixed this in an older version of Vampire in an 
alternate
way I provided of defining non content handlers, but then I broke it 
again
in one of the more recent versions. Have fixed it again for next 
version. :-)

Anyway, the only thing I didn't explain here was when you have:

   PythonHandler a b c

or:

   PythonHandler a
   PythonHandler b
   PythonHandler c

I think the documentation I quote about this at the start was reasonably
clear on that one though.

Hope this explains things. If it doesn't, you should perhaps explain the
specific problem you are having.

Graham


From grahamd at dscpl.com.au  Sun Apr 10 03:29:23 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Apr 10 03:29:32 2005
Subject: [mod_python] How do you specify the order in which mod_python
	Handlers are called?
In-Reply-To: <c4fe2162bf438c1271b5675b549353be@dscpl.com.au>
References: <2389d47305040919576b9c7b5f@mail.gmail.com>
	<c4fe2162bf438c1271b5675b549353be@dscpl.com.au>
Message-ID: <4cc71a187c69b34c635ab6a57796ff03@dscpl.com.au>


On 10/04/2005, at 5:18 PM, Graham Dumpleton wrote:
> One final thing to try with the above is set the .htaccess file to 
> contain
> only:
>
>   PythonHandlerModule mptest
>
> When I know request the ".php" file I see:
>
>   [Sun Apr 10 03:08:47 2005] [notice] mod_python: (Re)importing module 
> 'mptest'
>   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
> </headerparserhandler>
>   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
> <headerparserhandler>
>   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
> </accesshandler>
>   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
> <accesshandler>
>   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
> </loghandler>
>   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] 
> <loghandler>
>   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] </cleanup>
>   [Sun Apr 10 03:08:47 2005] [error] [client 128.121.126.33] <cleanup>
>
> I don't quite understand why the header parser handler is executed 
> when the
> "PythonHandlerModule" directive is used, but not when 
> "PythonHeaderParserHandler"
> is used explicitly.


Hmmm, obvious why really. I can't spell. Or at least I used the wrong 
name. The
.htaccess file should have been.

   PythonHeaderParserHandler mptest::headerparserhandler
   PythonAccessHandler mptest::accesshandler
   PythonHandler mptest::handler
   PythonLogHandler mptest::loghandler
   PythonCleanupHandler mptest::cleanuphandler

Then I get:

   [Sun Apr 10 03:25:42 2005] [notice] mod_python: (Re)importing module 
'mptest'
   [Sun Apr 10 03:25:42 2005] [error] [client 128.121.126.33] 
</headerparserhandler>
   [Sun Apr 10 03:25:42 2005] [error] [client 128.121.126.33] 
<headerparserhandler>
   [Sun Apr 10 03:25:42 2005] [error] [client 128.121.126.33] 
</accesshandler>
   [Sun Apr 10 03:25:42 2005] [error] [client 128.121.126.33] 
<accesshandler>
   [Sun Apr 10 03:25:42 2005] [error] [client 128.121.126.33] 
</loghandler>
   [Sun Apr 10 03:25:42 2005] [error] [client 128.121.126.33] 
<loghandler>
   [Sun Apr 10 03:25:42 2005] [error] [client 128.121.126.33] </cleanup>
   [Sun Apr 10 03:25:42 2005] [error] [client 128.121.126.33] <cleanup>

Whoops. :-)

The reason I didn't pick up that I had the wrong name is linked to the 
bug
with PythonHandlerModule. In short, the check of when to be silent is 
the
wrong way around and it complains when PythonHandlerModule is used and a
handler isn't defined, but not when the explicit directive is used as 
it should.

Graham

From jarrod.roberson at gmail.com  Sun Apr 10 12:16:34 2005
From: jarrod.roberson at gmail.com (jarrod roberson)
Date: Sun Apr 10 12:16:35 2005
Subject: [mod_python] How do you specify the order in which mod_python
	Handlers are called?
In-Reply-To: <c4fe2162bf438c1271b5675b549353be@dscpl.com.au>
References: <2389d47305040919576b9c7b5f@mail.gmail.com>
	<c4fe2162bf438c1271b5675b549353be@dscpl.com.au>
Message-ID: <2389d47305041009167569b41@mail.gmail.com>

Thanks for the reply Graham, I understand everything about the phases
firing in the order listed in the documentation. I THINK I understand
how to get my mod_python handlers to play nice with the other
handlers. The one thing that is still not clear is handler order when
there are multiple handlers of the same class/type.

basically the problem I am trying to solve is I want to do some
pre-processing before mod_dav gets called. I want to implement some
quota checking, some dir restrictions based on some headers existance
and a couple of other housekeeping tasts before mod_dav gets the
request and then do some cleanup ( commiting or rollingback
transaction ) after mod_dav gets finished.

I figured the correct place to put the quota check and dir
restrictions based on headers is in PythonAuthzHandler. Simply because
if any of the quota checks or other checks fail then mod_dav should
never actually see the request.

I could put them all in one PythonAuthzHandler but that is really not
as "clean" as I would like because each of the tasks are not really
coupled to each other in any way.

So if I have 3 different PythonAuthzHandler's and I want them to
process in a specific order, I have to put them all in one line? Or
can I list them sequentically as in the last part of your response?
That part I did not understand.
From alan at goatpunch.com  Sun Apr 10 16:20:52 2005
From: alan at goatpunch.com (Alan Davies)
Date: Sun Apr 10 16:20:53 2005
Subject: [mod_python] All spawned threads in Restricted Exection Mode
In-Reply-To: <acdbe31f024b8ed130d32f878769f9ce@mrlventures.com>
References: <acdbe31f024b8ed130d32f878769f9ce@mrlventures.com>
Message-ID: <1113164452.19589.231539123@webmail.messagingengine.com>

If you don't need the features of Python 2.4, you could try going back
to Python 2.3.4 (not 2.3.5), which is how I have avoided the problem
for now.

--Alan

On Sat, 9 Apr 2005 14:06:02 -0700, "Mike Solomon" <mike@mrlventures.com>
said:
> I too see this problem and it's driving me bananas.
> 
> I've got Apache 2.0.53, mod_python 3.1.4, python 2.4 installed under 
> SuSE 9.1. My servlet code and apache config are exactly the same as 
> Alan's (to minimize potential setup variables.)
> 
> My specific problem is that pickling causes this unmarshal error:
> 
> (it doesn't seem to matter what i pickle, or if i use cPickle vs pickle)
> 
> Traceback (most recent call last):
>    File "/home/msolomon/test/zclient/client.py", line 10, in
>    RuntimeError: cannot unmarshal code objects in restricted execution 
> mode
> 
> That line looks like this:
>   9:  obj = None
> 10:  in_a_pickle = pickle.dumps(obj, 2)
> 
> 
> Now here is a very strange observation - this exception does not occur 
> if I put the contents of client.py into threadtest.py - it only happens 
> when the code is imported.
> 
> I'm not sure why threads appear to be executing in restricted mode - 
> but if that is the problem, I guess I'd like to know how to turn that 
> off.  Despite stumbling onto a few occurrences of this problem, I have 
> yet to see a solution posted anywhere.
> 
> If either of you gentlemen have any additional insight, I would 
> appreciate it.
> 
> ------
> 
> My servlet looks like this (threadtest.py):
> 
> import mod_python
> from zclient.client import Client
> 
> def handler(req):
>    c = Client()
>    req.write(str(c.perform()))
>    return mod_python.apache.OK
> 
> 
> This is zclient/client.py:
> 
> import cPickle as pickle
> import threading, traceback
> 
> class Client:
>    def thread_op(self, results):
>      try:
>        obj = None
>        in_a_pickle = pickle.dumps(obj, 2)
>        results.append('ok')
>      except Exception, e:
>        results.extend(traceback.format_exc().split('\n'))
> 
>    def perform(self):
>      results = []
>      t = threading.Thread(target=self.thread_op, args=(results,))
>      t.start()
>      t.join()
>      return str(results)
> 
From grahamd at dscpl.com.au  Sun Apr 10 17:22:20 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Apr 10 17:22:26 2005
Subject: [mod_python] How do you specify the order in which mod_python
	Handlers are called?
In-Reply-To: <2389d47305041009167569b41@mail.gmail.com>
References: <2389d47305040919576b9c7b5f@mail.gmail.com>
	<c4fe2162bf438c1271b5675b549353be@dscpl.com.au>
	<2389d47305041009167569b41@mail.gmail.com>
Message-ID: <c4d3cc5256160b39d996be7b0b699a9b@dscpl.com.au>


On 11/04/2005, at 2:16 AM, jarrod roberson wrote:
> So if I have 3 different PythonAuthzHandler's and I want them to
> process in a specific order, I have to put them all in one line? Or
> can I list them sequentically as in the last part of your response?
> That part I did not understand.

Based on what documentation says, I believe either is okay. You can
probably use a combination of both. Ie.,

   PythonAuthzHandler a
   PythonAuthzHandler b c

Thus, executed in order "a", "b", "c".

The easiest way to check these things is to write a little test which
dumps logging from each to the log file and see the order.

Graham

From mike at mrlventures.com  Sun Apr 10 18:35:21 2005
From: mike at mrlventures.com (Mike Solomon)
Date: Sun Apr 10 18:35:29 2005
Subject: [mod_python] All spawned threads in Restricted Exection Mode
In-Reply-To: <1113164452.19589.231539123@webmail.messagingengine.com>
References: <acdbe31f024b8ed130d32f878769f9ce@mrlventures.com>
	<1113164452.19589.231539123@webmail.messagingengine.com>
Message-ID: <705de83fc0e67de2dd7363edbe990847@mrlventures.com>

Yes, it was several hours after I made that post that I located this 
gem, which pointed me in that direction.

http://mail.python.org/pipermail/python-bugs-list/2005-March/028011.html

I haven't made any commitments to python 2.4 yet, so it looks like I'll 
just have to wait.

Thanks for the pointer.

-ms

On Apr 10, 2005, at 1:20 PM, Alan Davies wrote:

> If you don't need the features of Python 2.4, you could try going back
> to Python 2.3.4 (not 2.3.5), which is how I have avoided the problem
> for now.
>
> --Alan
>
> On Sat, 9 Apr 2005 14:06:02 -0700, "Mike Solomon" 
> <mike@mrlventures.com>
> said:
>> I too see this problem and it's driving me bananas.
>>
>> I've got Apache 2.0.53, mod_python 3.1.4, python 2.4 installed under
>> SuSE 9.1. My servlet code and apache config are exactly the same as
>> Alan's (to minimize potential setup variables.)
>>
>> My specific problem is that pickling causes this unmarshal error:
>>
>> (it doesn't seem to matter what i pickle, or if i use cPickle vs 
>> pickle)
>>
>> Traceback (most recent call last):
>>    File "/home/msolomon/test/zclient/client.py", line 10, in
>>    RuntimeError: cannot unmarshal code objects in restricted execution
>> mode
>>
>> That line looks like this:
>>   9:  obj = None
>> 10:  in_a_pickle = pickle.dumps(obj, 2)
>>
>>
>> Now here is a very strange observation - this exception does not occur
>> if I put the contents of client.py into threadtest.py - it only 
>> happens
>> when the code is imported.
>>
>> I'm not sure why threads appear to be executing in restricted mode -
>> but if that is the problem, I guess I'd like to know how to turn that
>> off.  Despite stumbling onto a few occurrences of this problem, I have
>> yet to see a solution posted anywhere.
>>
>> If either of you gentlemen have any additional insight, I would
>> appreciate it.
>>
>> ------
>>
>> My servlet looks like this (threadtest.py):
>>
>> import mod_python
>> from zclient.client import Client
>>
>> def handler(req):
>>    c = Client()
>>    req.write(str(c.perform()))
>>    return mod_python.apache.OK
>>
>>
>> This is zclient/client.py:
>>
>> import cPickle as pickle
>> import threading, traceback
>>
>> class Client:
>>    def thread_op(self, results):
>>      try:
>>        obj = None
>>        in_a_pickle = pickle.dumps(obj, 2)
>>        results.append('ok')
>>      except Exception, e:
>>        results.extend(traceback.format_exc().split('\n'))
>>
>>    def perform(self):
>>      results = []
>>      t = threading.Thread(target=self.thread_op, args=(results,))
>>      t.start()
>>      t.join()
>>      return str(results)
>>

From Gyula.Toke at pfizer.com  Wed Apr 13 09:59:15 2005
From: Gyula.Toke at pfizer.com (Toke, Gyula)
Date: Wed Apr 13 10:03:05 2005
Subject: [mod_python] mod_python 3.1.4 issue with Apache 2.0.53
Message-ID: <C1A0732B7389E047BBB380444467FA210123CB33@sanemaexm01.emea.pfizer.com>

Hello there,
 
has anybody seen the following
 
on Sun Solaris 8:
 
$ pwd
/path_to_builds/mod_python-3.1.4
$ /path_to_apache/2.0.53/bin/apxs -q CC
gcc
$ which gcc
/usr/local/bin/gcc
$ /usr/local/bin/gcc --version
2.95.3
$ /path_to_python/2.3.5/bin/python
Python 2.3.5 (#4, Apr 13 2005, 12:37:44)
[GCC 2.95.3 20010315 (release)] on sunos5
Type "help", "copyright", "credits" or "license" for more information.
>>> ^D
$
$ ./configure --with-apxs=/path_to_apache/2.0.53/bin/apxs
--with-python=/path_to_python/2.3.5/bin/python
...
$ make
...
/path_to_apache/2.0.53/build/libtool --silent --mode=link gcc -o
mod_python.la -rpath /path_to_apache/2.0.53/modules -module -avoid-version
hlistobject.lo hlist.lo filterobject.lo connobject.lo serverobject.lo
util.lo tableobject.lo requestobject.lo _apachemodule.lo mod_python.lo
-L/usr/local/lib -L/path_to_python/2.3.5/lib/python2.3/config -lm
-lpython2.3 -lresolv -lsocket -lnsl -lrt -ldl -lpthread -lm _eprintf.o
_floatdidf.o _muldi3.o
*** Warning: Linking the shared library mod_python.la against the
non-libtool
*** objects _eprintf.o _floatdidf.o _muldi3.o is not portable!
...
 
and here comes a long list which ends with:
 
printf 0x154
/path_to_python/2.3.5/lib/python2.3/config/libpython2.3.a(dynload_shlib.o)
printf 0x7c
/path_to_python/2.3.5/lib/python2.3/config/libpython2.3.a(acceler.o)
printf 0xb0
/path_to_python/2.3.5/lib/python2.3/config/libpython2.3.a(acceler.o)
printf 0x114
/path_to_python/2.3.5/lib/python2.3/config/libpython2.3.a(acceler.o)
ld: fatal: relocations remain against allocatable but non-writable sections
collect2: ld returned 1 exit status
apxs:Error: Command failed with rc=65536
.
make[1]: *** [mod_python.so] Error 1
make[1]: Leaving directory `/path_to_builds/mod_python-3.1.4/src'
make: *** [do_dso] Error 2
$
 
In the relocation list above, every single entry is about
/path_to_python/2.3.5/lib/python2.3/config/libpython2.3.a file.
 
We have Apache 2.0.52 server with mod_python 3.1.3 (with Python 2.3.4) up
and running and I did not have any problems with the installation. I tried
to install mod_python 3.1.3 (with Python 2.3.4) on apache 2.0.53, but the
problem seems to be the same.
 
Does anybody have any idea what could go wrong, what I am doing wrong??
 
Thanks,
Gyula
 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050413/eec37ca5/attachment.html
From scottie at mischko.com  Thu Apr 14 00:00:19 2005
From: scottie at mischko.com (Scott Chapman)
Date: Thu Apr 14 00:00:23 2005
Subject: [mod_python] How to do your own error handler pages in mpservlets?
Message-ID: <425DEAD3.8030507@mischko.com>

I don't recall seeing any docs on how to do your own pages for error 
returns, such as HTTP_FORBIDDEN, etc.

Can someone give me some pointers?

TIA,
Scott
From rune.hansen at scanmine.com  Thu Apr 14 02:20:58 2005
From: rune.hansen at scanmine.com (Rune Hansen)
Date: Thu Apr 14 02:21:09 2005
Subject: [mod_python] How to do your own error handler pages in mpservlets?
In-Reply-To: <425DEAD3.8030507@mischko.com>
References: <425DEAD3.8030507@mischko.com>
Message-ID: <ba07b3601a1c9b93885e832ee0844027@scanmine.com>

On 14. apr. 2005, at 06.00, Scott Chapman wrote:

> I don't recall seeing any docs on how to do your own pages for error 
> returns, such as HTTP_FORBIDDEN, etc.
>
> Can someone give me some pointers?
>
> TIA,
> Scott

I've built up a library of error functions that I always include in my 
mod_python applications.
"""
def raise400(logmsg,server):
     """Log an explanatory error message and send 400 to the client"""
     apache.log_error(logmsg, apache.APLOG_ERR, server)
     raise apache.SERVER_RETURN, apache.HTTP_BAD_REQUEST

def raise401(logmsg,server):
     """Log an explanatory error message and send 401 to the client"""
     apache.log_error(logmsg, apache.APLOG_ERR, server)
     raise apache.SERVER_RETURN, apache.HTTP_UNAUTHORIZED

def raise403(logmsg,server):
     """Log an explanatory error message and send 403 to the client"""
     apache.log_error(logmsg, apache.APLOG_ERR, server)
     raise apache.SERVER_RETURN, apache.HTTP_FORBIDDEN

def raise404(logmsg,server):
     """Log an explanatory error message and send 404 to the client"""
     apache.log_error(logmsg, apache.APLOG_ERR, server)
     raise apache.SERVER_RETURN, apache.HTTP_NOT_FOUND

def raise415(logmsg,server):
     """Log an explanatory error message and send 415 to the client"""
     apache.log_error(logmsg, apache.APLOG_ERR, server)
     raise apache.SERVER_RETURN, apache.HTTP_UNSUPPORTED_MEDIA_TYPE

def raise500(logmsg,server):
     """Log an explanatory error message and send 500 to the client"""
     apache.log_error(logmsg, apache.APLOG_ERR, server)
     raise apache.SERVER_RETURN, apache.HTTP_INTERNAL_SERVER_ERROR

def raise501(logmsg,server):
     """Log an explanatory error message and send 501 to the client"""
     apache.log_error(logmsg, apache.APLOG_ERR, server)
     raise apache.SERVER_RETURN, apache.HTTP_NOT_IMPLEMENTED
"""

I think these are quite handy although they will only return Apaches 
default error pages.

regards
/rune

---------------------------------------------------------------------
Behind the firewall, nobody can hear you scream...
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: text/enriched
Size: 2117 bytes
Desc: not available
Url : http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050414/f0138388/attachment.bin
From grahamd at dscpl.com.au  Thu Apr 14 03:19:45 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr 14 03:19:48 2005
Subject: [mod_python] How to do your own error handler pages in mpservlets?
Message-ID: <1113463185.31269@dscpl.user.openhosting.com>

Scott Chapman wrote ..
> I don't recall seeing any docs on how to do your own pages for error 
> returns, such as HTTP_FORBIDDEN, etc.
> 
> Can someone give me some pointers?

Have a look at the Apache ErrorDocument directive.

  http://httpd.apache.org/docs-2.0/mod/core.html#errordocument

I have never tried to see how this interacts with mod_python and whether
an error generated by mod_python with no content will be redirected
to URLs specified using ErrorDocument. I don't have the time to try now
but will later. You might want to play with it your self. Set the error
document to some URL managed by a mpservlet handler.

Graham
From mod_python-maillist at uebergeek.de  Thu Apr 14 08:54:52 2005
From: mod_python-maillist at uebergeek.de (Adrian Immler)
Date: Thu Apr 14 08:53:56 2005
Subject: [mod_python] POST variables with SetHandler ?
Message-ID: <EaGgzRT4.1113483292.7236700.aimmler@localhost>

hello !

i have apache configured with these lines:

  <Directory /....../htdocs/mp>
    AddHandler mod_python .py
    PythonHandler init
    PythonDebug On
  </Directory>
  <Directory /....../htdocs/music>
    SetHandler mod_python
    PythonHandler mod_python.publisher
    PythonDebug On
  </Directory>

somehow in /music i cant access the POST variables but in /mp i can, with
absolutely the same code:

def function(req):
  req.content_type = "text/html"
  fs = FieldStorage(req)
  for key in fs.keys():
    req.write( key + ": "+ fs.getfirst(key) + "<br>\n" )

has this something to do with AddHandler and SetHandler, if yes, how can
i achive it that it also works with SetHandler ?

thanks for feedback in advance !


adrian

From list at joreybump.com  Thu Apr 14 10:15:55 2005
From: list at joreybump.com (Jorey Bump)
Date: Thu Apr 14 10:16:04 2005
Subject: [mod_python] POST variables with SetHandler ?
In-Reply-To: <EaGgzRT4.1113483292.7236700.aimmler@localhost>
References: <EaGgzRT4.1113483292.7236700.aimmler@localhost>
Message-ID: <425E7B1B.9070706@joreybump.com>

Adrian Immler wrote:

> def function(req):
>   req.content_type = "text/html"
>   fs = FieldStorage(req)
>   for key in fs.keys():
>     req.write( key + ": "+ fs.getfirst(key) + "<br>\n" )

This function is not appropriate for Publisher, which automatically 
handles most of the overhead in your code. Publisher makes form data 
available in the dictionary-like object, req.form:

# foo.py
def showformdata(req):
     formdata = {}
     for key in req.form.keys():
         formdata[key] = req.form[key]
     return formdata

Access the above function like this:

  http://localhost/foo/showformdata?a=123&b=456&b=789

It should return this:

  {'a': '123', 'b': ['456', '789']}

Note that a list will be created if multiple values are returned for the 
same key.
From huzaifa at hostway.com  Thu Apr 14 10:41:46 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Thu Apr 14 10:41:51 2005
Subject: [mod_python] Shared Memory
Message-ID: <425E812A.3040606@hostway.com>

If I have two directories in my cgi-bin such as "mp1" and "mp2" that i 
have setup in httpd.conf to be process by mod_python in two separate 
configuration blocks such as:

<Directory "/home/user/www/cgi-bin/mp1">
    AddHandler mod_python .py
    PythonHandler mptest
    PythonDebug On
    PythonAutoReload On
</Directory>

<Directory "/home/user/www/cgi-bin/mp2">
    AddHandler mod_python .py
    PythonHandler mptest
    PythonDebug On
    PythonAutoReload On
</Directory>

Would modules loaded in the application of mp1 be cached and shared with 
module being used in mp2 and vice-versa?  The reason I ask is that I 
have somewhat of a similar setup where I have a production framework 
running under mod_python in say "mp1" and then a beta framework running 
under mod_python in say "mp2" and they both reference a separate 
production and beta installations of the applications, however, when 
running the beta application (which gets updated before pushing to 
production for testing) I get errors from the beta application 
refrencing a library module in the production which are not updated with 
new code.

Any ideas on how I can setup a beta installation and production 
installation of the mod_python framework on the same server so that both 
access their own shared memory?

Huzaifa

From list at joreybump.com  Thu Apr 14 10:59:04 2005
From: list at joreybump.com (Jorey Bump)
Date: Thu Apr 14 10:59:24 2005
Subject: [mod_python] Shared Memory
In-Reply-To: <425E812A.3040606@hostway.com>
References: <425E812A.3040606@hostway.com>
Message-ID: <425E8538.5000708@joreybump.com>

Huzaifa Tapal wrote:
> If I have two directories in my cgi-bin such as "mp1" and "mp2" that i 
> have setup in httpd.conf to be process by mod_python in two separate 
> configuration blocks such as:
> 
> <Directory "/home/user/www/cgi-bin/mp1">
>    AddHandler mod_python .py
>    PythonHandler mptest
>    PythonDebug On
>    PythonAutoReload On
> </Directory>
> 
> <Directory "/home/user/www/cgi-bin/mp2">
>    AddHandler mod_python .py
>    PythonHandler mptest
>    PythonDebug On
>    PythonAutoReload On
> </Directory>
> 
> Would modules loaded in the application of mp1 be cached and shared with 
> module being used in mp2 and vice-versa? 

Yes, by default they will share the interpreter. An interpreter is 
created for each virtual host.

> The reason I ask is that I 
> have somewhat of a similar setup where I have a production framework 
> running under mod_python in say "mp1" and then a beta framework running 
> under mod_python in say "mp2" and they both reference a separate 
> production and beta installations of the applications, however, when 
> running the beta application (which gets updated before pushing to 
> production for testing) I get errors from the beta application 
> refrencing a library module in the production which are not updated with 
> new code.
> 
> Any ideas on how I can setup a beta installation and production 
> installation of the mod_python framework on the same server so that both 
> access their own shared memory?

The easiest way is to create separate virtual hosts. This will be the 
safest and most flexible, by far. It is also possible to control the 
creation of interpreters somewhat using special directives:

  http://www.modpython.org/live/current/doc-html/dir-other.html

These work very well, but can add a layer of complexity that you won't 
have to deal with if you use separate virtual hosts.
From list at joreybump.com  Thu Apr 14 11:49:24 2005
From: list at joreybump.com (Jorey Bump)
Date: Thu Apr 14 11:49:29 2005
Subject: [mod_python] Re: Shared Memory
In-Reply-To: <33a85067050414080978369039@mail.gmail.com>
References: <425E812A.3040606@hostway.com> <425E8538.5000708@joreybump.com>
	<33a85067050414080978369039@mail.gmail.com>
Message-ID: <425E9104.7030306@joreybump.com>

Nathan Olberding wrote:
> Is this behavior documented? I've only skimmed documentation, but this
> one caught me off guard. My solution was to just change the names of
> all my .py files and restart Apache. I'd consider it a feature, but
> it's definitely a "gotcha".

It's well documented:

  http://www.modpython.org/live/current/doc-html/pyapi-interps.html

You could say that mod_python is quite unlike other embedded
interpreters (but then again, aren't they all?), so there will be many
"gotchas". The manual is short, and a thorough reading is highly
recommended. This definitely isn't PHP. :)

From lbruno at republico.estv.ipv.pt  Thu Apr 14 14:50:34 2005
From: lbruno at republico.estv.ipv.pt (Luis Bruno)
Date: Thu Apr 14 14:25:12 2005
Subject: [mod_python] POST variables with SetHandler ?
In-Reply-To: <EaGgzRT4.1113483292.7236700.aimmler@localhost>
References: <EaGgzRT4.1113483292.7236700.aimmler@localhost>
Message-ID: <20050414195034.000064a7@LAB2-10.esi>

Adrian Immler wrote:
>   <Directory /....../htdocs/music>
>     SetHandler mod_python
>     PythonHandler mod_python.publisher
>   </Directory>
> 
> somehow in /music i cant access the POST variables

I'll try to make it short; with mod_python.publisher, you can do this:

http://example.com/user.py/save?name=LuisBruno&password=aybabtu

| def save(req, username, password):
|     pass

I think GET and POST work the same way; if more arguments are specified
by the HTTP client than you expect, those are discarded (unless you use
**kwargs). I *think* if some non-keyword arguments aren't specified,
they are set to None.

I gleaned this from:
http://www.modpython.org/live/current/doc-html/hand-pub-alg-args.html

Cheers,
-- 
Luis "Flames gladly accepted if my memory is wrong" Bruno
From kelliehobbs at yahoo.com  Fri Apr 15 15:07:24 2005
From: kelliehobbs at yahoo.com (kellie hobbs)
Date: Fri Apr 15 15:07:31 2005
Subject: [mod_python] Mod_python can't open lib
Message-ID: <20050415190724.12416.qmail@web51708.mail.yahoo.com>

Hello,

I'm using mod_python 3.1.3, and mxODBC. I can successfully connect to
our database through ODBC using Python, but when I try to connect with
mod_python, I get an error:

mxODBC.OperationalError: ('IM003', 0, "[unixODBC][Driver Manager]Can't
open
 lib '/apps/progress/dlc/odbc/lib/pgpro918.so' : ld.so.1:
/usr/local/bin/python: fatal: libpgmfront.so: open failed: No such file
or
 directory", 6044)

Any ideas? The LD_LIBRARY_PATH and ODBCINI environment variables are
set exactly the same in the Python and mod_python scripts.

Thanks.

Kellie Hobbs

__________________________________________________
Do You Yahoo!?
Tired of spam?  Yahoo! Mail has the best spam protection around 
http://mail.yahoo.com 
From dave at davebritton.com  Fri Apr 15 15:40:09 2005
From: dave at davebritton.com (Dave Britton)
Date: Fri Apr 15 15:40:18 2005
Subject: [mod_python] mod_python to MySQL
Message-ID: <029101c541f2$ef62d550$080aa8c0@DAVE>

What's the best way to connect mod_python to a MySQL database? I can't seem to get MySQL_db to install - it says: 
=======
gcc -pthread -shared build/temp.linux-i686-2.3/_mysql.o -lmysqlclient -lz -lcrypt -lnsl -lm] -lmysqlclient_r -o build/lib.linux-i686-2.3/_mysql.so
/usr/bin/ld: cannot find -lmysqlclient
collect2: ld returned 1 exit status
error: command 'gcc' failed with exit status 1
======
and I wondered if there is another connector that is better suited for mod_python. Or, does anyone have any ideas about why I get the gcc library linking error if MySQL_db is the connector of choice.

Dave Britton
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050415/0983fda1/attachment.html
From list at joreybump.com  Fri Apr 15 16:20:41 2005
From: list at joreybump.com (Jorey Bump)
Date: Fri Apr 15 16:20:56 2005
Subject: [mod_python] mod_python to MySQL
In-Reply-To: <029101c541f2$ef62d550$080aa8c0@DAVE>
References: <029101c541f2$ef62d550$080aa8c0@DAVE>
Message-ID: <42602219.6030400@joreybump.com>

Dave Britton wrote:
> What's the best way to connect mod_python to a MySQL database? I can't 
> seem to get MySQL_db to install - it says:
> =======
> gcc -pthread -shared build/temp.linux-i686-2.3/_mysql.o -lmysqlclient 
> -lz -lcrypt -lnsl -lm] -lmysqlclient_r -o build/lib.linux-i686-2.3/_mysql.so
> /usr/bin/ld: cannot find -lmysqlclient
> collect2: ld returned 1 exit status
> error: command 'gcc' failed with exit status 1
> ======

What Linux distribution are you using? Do you have the mysqlclient 
development files installed?
From grisha at modpython.org  Fri Apr 15 22:24:49 2005
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Fri Apr 15 22:24:59 2005
Subject: [mod_python] Using RSA with mod_python cookies for single sign-on
Message-ID: <20050415222204.A50319@grisha.dyndns.org>


Just thought I'd share this technique for those who are interested. This 
is how RSA public key signatures can be used in cookies to provide single 
sign-on (SSN) capability without the servers having to communicate with 
each other for authentication.

http://www.openvps.org/Plone/docs/developer/musings/ssignon

Grisha
From azurit at pobox.sk  Sat Apr 16 04:12:04 2005
From: azurit at pobox.sk (azurIt)
Date: Sat Apr 16 04:04:14 2005
Subject: [mod_python] mod_python to MySQL
Message-ID: <200504160812.j3G8C058008591@www7.pobox.sk>

hi,
the problem can be also in MySQL version - older versions of 4.0.x 
are not supported and it's even not possible to compile MySQL-python 
(i had the same problem). If you are useing MySQL 4.0.x try to 
upgrade to the latest version (for now it's 4.0.24).

azurIt


> Dave Britton wrote:
> > What's the best way to connect mod_python to a MySQL database? I 
can't 
> > seem to get MySQL_db to install - it says:
> > =======
> > gcc -pthread -shared build/temp.linux-i686-2.3/_mysql.o -
lmysqlclient 
> > -lz -lcrypt -lnsl -lm] -lmysqlclient_r -o build/lib.linux-i686-
2.3/_mysql.so
> > /usr/bin/ld: cannot find -lmysqlclient
> > collect2: ld returned 1 exit status
> > error: command 'gcc' failed with exit status 1
> > ======
> 
> What Linux distribution are you using? Do you have the mysqlclient 
> development files installed?
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 

____________________________________
Vsetko o SuperStar
http://superstar.atlas.sk


From barry.pearce at copyrightwitness.net  Sat Apr 16 16:10:39 2005
From: barry.pearce at copyrightwitness.net (Barry Pearce)
Date: Sat Apr 16 16:08:36 2005
Subject: [mod_python] 
	Re: Mod_python Digest, Vol 25, Issue 19 - MySQL issues.
In-Reply-To: <200504161600.j3GG06OT002254@modpython.org>
References: <200504161600.j3GG06OT002254@modpython.org>
Message-ID: <4261713F.8080902@copyrightwitness.net>

Hi All,

>    2. mod_python to MySQL (Dave Britton)
>    3. Re: mod_python to MySQL (Jorey Bump)
>    5. Re: mod_python to MySQL (azurIt)
> ------------------------------
> 
> Message: 2
> Date: Fri, 15 Apr 2005 15:40:09 -0400
> From: "Dave Britton" <dave@davebritton.com>
> Subject: [mod_python] mod_python to MySQL
> 
> What's the best way to connect mod_python to a MySQL database? I can't seem to get MySQL_db to install - it says: 

MySQLdb without a doubt. Works VERY well with mod_python - Im use 
mod_python 3.1.3 python 2.3.4 and MySQL 4.1.10a with MySQLdb 1.20 (under 
   Linux) and 1.0.0 (under win32 but needs patching with a small fix for 
timestamp fields...i can send it!)

> =======
> gcc -pthread -shared build/temp.linux-i686-2.3/_mysql.o -lmysqlclient -lz -lcrypt -lnsl -lm] -lmysqlclient_r -o build/lib.linux-i686-2.3/_mysql.so
> /usr/bin/ld: cannot find -lmysqlclient
> collect2: ld returned 1 exit status
> error: command 'gcc' failed with exit status 1
> ======
> and I wondered if there is another connector that is better suited for mod_python. Or, does anyone have any ideas about why I get the gcc library linking error if MySQL_db is the connector of choice.

Firstly you probably dont want mysqlclient. You probably want 
mysqlclient_r which is the reentrant thread-safe version. You link line 
seems to have both - very worrying...Ill check my compilation...

Is MySQL located in default location? Where did you install it to? Have 
you checked the include & library paths to make sure the MySQL libs and 
includes are on the right path.

I compiled up 1.2.0 only 2 days ago under SuSE9.0 with no problems.

 > ------------------------------

>>What's the best way to connect mod_python to a MySQL database? I can't 
>>seem to get MySQL_db to install - it says:
>>=======
>>gcc -pthread -shared build/temp.linux-i686-2.3/_mysql.o -lmysqlclient 
>>-lz -lcrypt -lnsl -lm] -lmysqlclient_r -o build/lib.linux-i686-2.3/_mysql.so
>>/usr/bin/ld: cannot find -lmysqlclient
>>collect2: ld returned 1 exit status
>>error: command 'gcc' failed with exit status 1
>>======
> 
> 
> What Linux distribution are you using? Do you have the mysqlclient 
> development files installed?

Now I dont have these installed. I think I also downloaded the dynamic 
client libraries RPM in addition to the standard package.

> ------------------------------
> 
> Message: 5
> Date: Sat, 16 Apr 2005 10:12:04 +0200
> From: azurIt <azurit@pobox.sk>
> Subject: Re: [mod_python] mod_python to MySQL
> To: Mod_python@modpython.org

> the problem can be also in MySQL version - older versions of 4.0.x 
> are not supported and it's even not possible to compile MySQL-python 
> (i had the same problem). If you are useing MySQL 4.0.x try to 
> upgrade to the latest version (for now it's 4.0.24).


Current stable is 4.1.10a. MySQLdb works well with this 1.2.0 is the 
best. But if you need it on windows use the 1.0.0 binary and then patch 
the times.py file.

-- 
Regards

Barry Pearce
From azurit at pobox.sk  Sat Apr 16 17:21:32 2005
From: azurit at pobox.sk (azurIt)
Date: Sat Apr 16 17:21:40 2005
Subject: [mod_python]  Re: Mod_python Digest, Vol 25, Issue 19 - MySQL issues.
Message-ID: <200504162121.j3GLLWte003031@www5.pobox.sk>


> Current stable is 4.1.10a. MySQLdb works well with this 1.2.0 is 
the 
> best. But if you need it on windows use the 1.0.0 binary and then 
patch 
> the times.py file.

i was talking about latest 4.0.x version, not 4.1.x, and both of them 
are stable :) and as i said, MySQL-python will not compile with older 
4.0.x versions of MySQL.

azurIt

_______________________________________________________________________
?asopisy prin??aj?ce aktu?lne inform?cie z oblasti dan?, ??tovn?ctva,
miezd, personalistiky, odme?ovania vo forme odborn?ch ?l?nkov, koment?rov
a praktick?ch pr?kladov.
N?jdete na str?nke http://www.epi.sk/pp.htm


From dan.nelson at transcom.com.au  Mon Apr 18 00:30:30 2005
From: dan.nelson at transcom.com.au (Dan Nelson)
Date: Mon Apr 18 00:30:43 2005
Subject: [mod_python] Lost
Message-ID: <015401c543cf$5a82cce0$0300a8c0@Dan>

Maybe someone can point me in the right direction, point out some good 
documentation.

A bit of background:  I'm a C/C++ programmer, primarily with embedded 
applications.  I've recently been playing with Python and have writen a 
basic server application that interfaces to a database.  I'd like to also 
access that database via a web application, and Python seems to be the 
logical choice.  I don't know very much about web applications other than 
some very basic html.

I'm a bit lost and the documentation seems to be a bit scant.  The doco 
probably assumes that the reader has a basic knowledge that I don't have. 
What I'm probably looking for is something like "Building Web Apps With 
Python", but I don't think it exists.  Maybe most Python web application 
people have started with Perl and know the concepts, and then transfer them 
to Python.  I'm jumping in cold.

For example, there is a 'req' object that the handler sees.  But I can't 
find any attributes or methods for it, other than a very few that are in the 
documentation.  I did find an Apache request object, and it does seem to 
share many of the attributes, but I had to find which ones by trial and 
error.  From some of the things I've read, I've seen req.send_http_header(), 
and req.form.submit, but I don't know how to get to there if I don't even 
have any doco on the req object.

Hope the above makes sense.

Thanks

Dan 

From grahamd at dscpl.com.au  Mon Apr 18 01:26:02 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Mon Apr 18 01:26:04 2005
Subject: [mod_python] Lost
Message-ID: <1113801962.28728@dscpl.user.openhosting.com>

> For example, there is a 'req' object that the handler sees.  But I can't
> find any attributes or methods for it, other than a very few that are in
> the 
> documentation.  I did find an Apache request object, and it does seem to
> share many of the attributes, but I had to find which ones by trial and
> error.  From some of the things I've read, I've seen req.send_http_header(),
> and req.form.submit, but I don't know how to get to there if I don't even
> have any doco on the req object.

The "req" object documentation, it is at:

  http://www.modpython.org/live/current/doc-html/pyapi-mprequest.html

Is this the Apache request object documentation you had already found,
or are you talking about the really low level Apache C level struct and
associated C functions?

Graham
From dan.nelson at transcom.com.au  Mon Apr 18 01:28:56 2005
From: dan.nelson at transcom.com.au (Dan Nelson)
Date: Mon Apr 18 01:29:11 2005
Subject: [mod_python] Lost
References: <1113801962.28728@dscpl.user.openhosting.com>
Message-ID: <016601c543d7$85d42670$0300a8c0@Dan>

Thanks,

I was just having another look at the doco and realised that I'd missed a 
chunk, the bit that you've just sent me.  That's the starting point that I 
need, I'm sure that it will make more sense now.

Thanks for the reply.

Dan

----- Original Message ----- 
From: "Graham Dumpleton" <grahamd@dscpl.com.au>
To: "Dan Nelson" <dan.nelson@transcom.com.au>
Cc: <mod_python@modpython.org>
Sent: Monday, 18 April, 2005 1:26 PM
Subject: Re: [mod_python] Lost


>> For example, there is a 'req' object that the handler sees.  But I can't
>> find any attributes or methods for it, other than a very few that are in
>> the
>> documentation.  I did find an Apache request object, and it does seem to
>> share many of the attributes, but I had to find which ones by trial and
>> error.  From some of the things I've read, I've seen 
>> req.send_http_header(),
>> and req.form.submit, but I don't know how to get to there if I don't even
>> have any doco on the req object.
>
> The "req" object documentation, it is at:
>
>  http://www.modpython.org/live/current/doc-html/pyapi-mprequest.html
>
> Is this the Apache request object documentation you had already found,
> or are you talking about the really low level Apache C level struct and
> associated C functions?
>
> Graham
> 

From administrator at leebrown.org  Mon Apr 18 08:00:57 2005
From: administrator at leebrown.org (Lee Brown)
Date: Mon Apr 18 08:03:27 2005
Subject: [mod_python] Lost
In-Reply-To: <016601c543d7$85d42670$0300a8c0@Dan>
Message-ID: <5EB25CE001E2@underdog>

Greetings!

You might find this book to be useful for general python/web applications,
although it doesn't cover Mod Python specifically:

Python Web Programming
Steve Holden
New Riders Publishing
ISBN 0-7357-1090-2

Best Regards,
Lee E. Brown
(administrator@leebrown.org)

-----Original Message-----
From: mod_python-bounces@modpython.org
[mailto:mod_python-bounces@modpython.org] On Behalf Of Dan Nelson
Sent: Monday, April 18, 2005 1:29 AM
To: Graham Dumpleton
Cc: mod_python@modpython.org
Subject: Re: [mod_python] Lost

Thanks,

I was just having another look at the doco and realised that I'd missed a
chunk, the bit that you've just sent me.  That's the starting point that I
need, I'm sure that it will make more sense now.

Thanks for the reply.

Dan

----- Original Message -----
From: "Graham Dumpleton" <grahamd@dscpl.com.au>
To: "Dan Nelson" <dan.nelson@transcom.com.au>
Cc: <mod_python@modpython.org>
Sent: Monday, 18 April, 2005 1:26 PM
Subject: Re: [mod_python] Lost


>> For example, there is a 'req' object that the handler sees.  But I can't
>> find any attributes or methods for it, other than a very few that are in
>> the
>> documentation.  I did find an Apache request object, and it does seem to
>> share many of the attributes, but I had to find which ones by trial and
>> error.  From some of the things I've read, I've seen 
>> req.send_http_header(),
>> and req.form.submit, but I don't know how to get to there if I don't even
>> have any doco on the req object.
>
> The "req" object documentation, it is at:
>
>  http://www.modpython.org/live/current/doc-html/pyapi-mprequest.html
>
> Is this the Apache request object documentation you had already found,
> or are you talking about the really low level Apache C level struct and
> associated C functions?
>
> Graham
> 

_______________________________________________
Mod_python mailing list
Mod_python@modpython.org
http://mailman.modpython.org/mailman/listinfo/mod_python

From davidf at sjsoft.com  Mon Apr 18 08:24:46 2005
From: davidf at sjsoft.com (David Fraser)
Date: Mon Apr 18 08:25:16 2005
Subject: [mod_python] Using RSA with mod_python cookies for single sign-on
In-Reply-To: <20050415222204.A50319@grisha.dyndns.org>
References: <20050415222204.A50319@grisha.dyndns.org>
Message-ID: <4263A70E.4060102@sjsoft.com>

Gregory (Grisha) Trubetskoy wrote:

>
> Just thought I'd share this technique for those who are interested. 
> This is how RSA public key signatures can be used in cookies to 
> provide single sign-on (SSN) capability without the servers having to 
> communicate with each other for authentication.
>
> http://www.openvps.org/Plone/docs/developer/musings/ssignon

Nice article.
Slightly tangential, but I recently wanted to do RSA without any C 
libraries (Pure Python) and was amazed by how easy it was...
http://www.cypherspace.org/adam/rsa/python.html
Of course to interoperate with other code you need to be able to handle 
certificates etc, the following libraries are useful:
ASN.1 encoding / decoding, and OAEP padding:
http://www.mixminion.net/cvs/src/minion/lib/mixminion/Crypto.py

David
From JFeghhi at visa.com  Mon Apr 18 09:45:07 2005
From: JFeghhi at visa.com (Feghhi, Jalil)
Date: Mon Apr 18 09:47:41 2005
Subject: [mod_python] Encoding Question
Message-ID: <8C53AAFA2050EE40BDCDB9455DA7D63401FAC77A@sw720ex020.visa.com>


1. I download a page in PSP using urllib and now want to convert and
keep it as utf-8? What calls should I make to convert the encoding of
the page to utf8? 

2. Is this a good approach? Can I keep any pages in any languages in
this way and return them when requested in utf-8?

By the way, I have set my default encoding in Python to utf8.

Thanks,

-Jalil


From bo at softwave.se  Mon Apr 18 13:13:59 2005
From: bo at softwave.se (Bo Jangeborg)
Date: Mon Apr 18 13:13:54 2005
Subject: [mod_python] Calling PHP pages
Message-ID: <4263EAD7.6030907@softwave.se>

Hello

I need to call a login routine to allow my python pages to coexist with 
my current
php pages. For this to work I need to pass the cookie information to the 
php page.

I am using the python urllib and are calling the page with the data 
option in the hope
that this will pass the cookie information along. This however does not 
seem to work.

filehandle = 
urllib.urlopen('http://fakeurl.com/login_py.php',data=urllib.urlencode(req.headers_in))

Am I on the right track, or is there another way ?

Bo Jangeborg
Softwave
From nick at dd.revealed.net  Mon Apr 18 13:50:49 2005
From: nick at dd.revealed.net (Nick)
Date: Mon Apr 18 13:51:07 2005
Subject: [mod_python] Calling PHP pages
In-Reply-To: <4263EAD7.6030907@softwave.se>
References: <4263EAD7.6030907@softwave.se>
Message-ID: <4263F379.4040900@dd.revealed.net>

You really want to be using urllib2.urlopen with a urllib2.Request object.

Nick

Bo Jangeborg wrote:
> Hello
> 
> I need to call a login routine to allow my python pages to coexist with 
> my current
> php pages. For this to work I need to pass the cookie information to the 
> php page.
> 
> I am using the python urllib and are calling the page with the data 
> option in the hope
> that this will pass the cookie information along. This however does not 
> seem to work.
> 
> filehandle = 
> urllib.urlopen('http://fakeurl.com/login_py.php',data=urllib.urlencode(req.headers_in)) 
> 
> 
> Am I on the right track, or is there another way ?
> 
> Bo Jangeborg
> Softwave
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From azurit at pobox.sk  Mon Apr 18 13:57:45 2005
From: azurit at pobox.sk (azurIt)
Date: Mon Apr 18 13:57:48 2005
Subject: [mod_python] Calling PHP pages
Message-ID: <200504181757.j3IHviHo025410@www4.pobox.sk>

hi,

maybe this will not help you but it's a way too :)
you can pass that cookie as a variable to php, something like:
filehandle = urllib.urlope('http://fakeurl.com/login_py.php?cookie=%
s' % cookie,data=urllib.urlencode(req.headers_in))

and then you can take it from php script (well, some changes in php 
will be probably needed).

..or you can try to add Set-Cookie part of header to the req object 
before calling that:

req.headers_in.add("Set-Cookie", "cookie=%s" % cookie)
but i don't know if this is possible :) i was adding such a things 
only to the headers_out so i can't tell now. hope it helps :)

azurIt


> Hello
> 
> I need to call a login routine to allow my python pages to coexist 
with 
> my current
> php pages. For this to work I need to pass the cookie information 
to the 
> php page.
> 
> I am using the python urllib and are calling the page with the 
data 
> option in the hope
> that this will pass the cookie information along. This however 
does not 
> seem to work.
> 
> filehandle = 
> urllib.urlopen
('http://fakeurl.com/login_py.php',data=urllib.urlencode
(req.headers_in))
> 
> Am I on the right track, or is there another way ?
> 
> Bo Jangeborg
> Softwave
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 

____________________________________
Vsetko o SuperStar
http://superstar.atlas.sk


From bo at softwave.se  Mon Apr 18 15:20:55 2005
From: bo at softwave.se (Bo Jangeborg)
Date: Mon Apr 18 15:20:56 2005
Subject: [mod_python] Calling PHP pages
In-Reply-To: <4263F379.4040900@dd.revealed.net>
References: <4263EAD7.6030907@softwave.se> <4263F379.4040900@dd.revealed.net>
Message-ID: <42640897.8060903@softwave.se>


Nick wrote:

> You really want to be using urllib2.urlopen with a urllib2.Request 
> object.
>
I really do, thanks !
Here is the solution.

php_req = urllib2.Request(url='http://fakeurl.com/login_py.php')
php_req.add_header('Cookie',req.headers_in['Cookie'])
filehandle = urllib2.urlopen(php_req)

Bo)


> Nick
>
> Bo Jangeborg wrote:
>
>> Hello
>>
>> I need to call a login routine to allow my python pages to coexist 
>> with my current
>> php pages. For this to work I need to pass the cookie information to 
>> the php page.
>>
>> I am using the python urllib and are calling the page with the data 
>> option in the hope
>> that this will pass the cookie information along. This however does 
>> not seem to work.
>>
>> filehandle = 
>> urllib.urlopen('http://fakeurl.com/login_py.php',data=urllib.urlencode(req.headers_in)) 
>>
>>
>> Am I on the right track, or is there another way ?
>>
>> Bo Jangeborg
>> Softwave
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>
>
>
>

From huzaifa at hostway.com  Wed Apr 20 14:56:29 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Wed Apr 20 14:56:34 2005
Subject: [mod_python] SSL Socket Problem
Message-ID: <4266A5DD.7000102@hostway.com>

Hello All,

I am having a problem with making SSL socket connections in my 
mod_python application running with python 2.3.5.  The error I keep 
getting back is "TypeError: ssl() argument 1 must be _socket.socket, not 
_socketobject".  What is odd is that if I restart the apache2 web 
server, the error goes away and all the calls return back with a 
message.  However, after about 20 or so minutes we start getting this 
error almost instantaneously without any kind of message going out at all.

Here is the full traceback:

         con.endheaders()
        File "/usr/lib/python2.3/httplib.py", line 715, in endheaders
         self._send_output()
        File "/usr/lib/python2.3/httplib.py", line 600, in _send_output
         self.send(msg)
        File "/usr/lib/python2.3/httplib.py", line 567, in send
         self.connect()
        File "/usr/lib/python2.3/httplib.py", line 988, in connect
         ssl = socket.ssl(sock, self.key_file, self.cert_file)
        File "/usr/lib/python2.3/socket.py", line 73, in ssl
         return _realssl(sock, keyfile, certfile)
     TypeError: ssl() argument 1 must be _socket.socket, not _socketobject

I have the same application running on another machine with python 2.3.4 
and I can't replicate it in there.  Do you guys know of any known issues 
with sockets and ssl with python 2.3.5?

Any help would be appreciated.

Hozi

From bram-lists at phoenux.org  Wed Apr 20 20:56:13 2005
From: bram-lists at phoenux.org (Bram)
Date: Wed Apr 20 20:55:37 2005
Subject: [mod_python] vampire.importModule from module import
	function/class? 
Message-ID: <4266FA2D.9090900@phoenux.org>

Are there any special options that can be given to 
vampire.importModule() that duplicates "from module import 
function/class" style imports or should I just stick to the long dotted 
notations for calling these functions/classes? It sure would be nice to 
only have to load the code for the functions/classes I needed.

Thanks,
Bram.
From grahamd at dscpl.com.au  Wed Apr 20 21:14:42 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Apr 20 21:14:49 2005
Subject: [mod_python] Re: vampire.importModule from module import
	function/class? 
In-Reply-To: <4266FA2D.9090900@phoenux.org>
References: <4266FA2D.9090900@phoenux.org>
Message-ID: <2c278bf37893b7ba5ec9d098b78012eb@dscpl.com.au>


On 21/04/2005, at 10:56 AM, Bram wrote:

> Are there any special options that can be given to 
> vampire.importModule() that duplicates "from module import 
> function/class" style imports or should I just stick to the long 
> dotted notations for calling these functions/classes? It sure would be 
> nice to only have to load the code for the functions/classes I needed.

I think you misunderstand what "from module import function/class" does.
It still loads the whole contents of the module into the process. It
doesn't selectively load just the bits you indicate. It is in effect a
short cut for saying:

   import mymodule
   myfunction = mymodule.myfunction
   myclass = mymodule.myclass

As an example, try the following:

   from base64 import decode
   print globals()
   import sys
   print dir(sys.modules["base64"])

So, "decode" may be the only thing in your namespace, but the whole 
module
still exists in sys.modules.

To avoid dotted notation, you can setup references in your local 
namespace
using:

   mymodule = vampire.importModule("mymodule",directory)
   myfunction = mymodule.myfunction
   myclass = mymodule.myclass

Note that the autoreloading mechanism of the Vampire import system 
actually
relies on the module being in the globals namespace if imported at that
level, as it uses that as a means of determining parent/child import
dependencies and thus when it needs to reimport a parent because of a
change in a child.

Thus, although you could say:

   mymodule = vampire.importModule("mymodule",directory)
   myfunction = mymodule.myfunction
   myclass = mymodule.myclass
   del mymodule  ### BAD

you would then cause the full abilities of the autoreloading mechanism
to not work properly.

BTW, Vampire doesn't put its loaded modules in sys.modules so if you go
looking there for them, you will not find them.

Graham



From dan.nelson at transcom.com.au  Wed Apr 20 21:16:21 2005
From: dan.nelson at transcom.com.au (Dan Nelson)
Date: Wed Apr 20 21:16:37 2005
Subject: [mod_python] SSL Socket Problem
References: <4266A5DD.7000102@hostway.com>
Message-ID: <016c01c5460f$bb43e590$0300a8c0@Dan>

If it's working for a while and then you get an error, perhaps it has 
something to do with apache reaching some limit, queueing/caching, too many 
threads, too many sockets...  That might be a place to start looking.

Dan


----- Original Message ----- 
From: "Huzaifa Tapal" <huzaifa@hostway.com>
To: <mod_python@modpython.org>
Sent: Thursday, 21 April, 2005 2:56 AM
Subject: [mod_python] SSL Socket Problem


> Hello All,
>
> I am having a problem with making SSL socket connections in my mod_python 
> application running with python 2.3.5.  The error I keep getting back is 
> "TypeError: ssl() argument 1 must be _socket.socket, not _socketobject". 
> What is odd is that if I restart the apache2 web server, the error goes 
> away and all the calls return back with a message.  However, after about 
> 20 or so minutes we start getting this error almost instantaneously 
> without any kind of message going out at all.
>
> Here is the full traceback:
>
>         con.endheaders()
>        File "/usr/lib/python2.3/httplib.py", line 715, in endheaders
>         self._send_output()
>        File "/usr/lib/python2.3/httplib.py", line 600, in _send_output
>         self.send(msg)
>        File "/usr/lib/python2.3/httplib.py", line 567, in send
>         self.connect()
>        File "/usr/lib/python2.3/httplib.py", line 988, in connect
>         ssl = socket.ssl(sock, self.key_file, self.cert_file)
>        File "/usr/lib/python2.3/socket.py", line 73, in ssl
>         return _realssl(sock, keyfile, certfile)
>     TypeError: ssl() argument 1 must be _socket.socket, not _socketobject
>
> I have the same application running on another machine with python 2.3.4 
> and I can't replicate it in there.  Do you guys know of any known issues 
> with sockets and ssl with python 2.3.5?
>
> Any help would be appreciated.
>
> Hozi
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 

From stephen at vermeulen.ca  Wed Apr 20 23:39:20 2005
From: stephen at vermeulen.ca (Stephen Vermeulen)
Date: Wed Apr 20 23:39:19 2005
Subject: [mod_python] Attempting to use mod_python on a site which uses
	digest autentication
Message-ID: <42672068.2000607@vermeulen.ca>

I am trying to use the publisher handler. I have a basic test using 
mod_python working, but when I add
digest authentication to the directories on the web server it stops 
working. I am not trying to handle the
authentication with mod_python, rather I'm letting apache do its thing.

The test python script looks like:

def email(req, name, email, comment):
    s = """\
Dear %s,<br>
Thank you for your comment:
<blockquote>
%s
</blockquote>
We will hound you without mercy at: <b>%s</b>
</html>""" % (name, comment, email)
    return s

and the apache directory block (which does not work) looks like:

<Directory /home/files/web/extras>
AuthName "test"
AuthType Digest
AuthDigestFile "/etc/apache2/digestusers"
require user testuser
AddHandler mod_python .py
PythonHandler mod_python.publisher
PythonDebug On
#allow from all
</Directory>

and I get the following error message in the browser (firefox):
-----------


  Bad Request

Your browser sent a request that this server could not understand.


---------

If I switch it to the following (i.e. turn off authentication) it works:

<Directory /home/files/web/extras>
#AuthName "test"
#AuthType Digest
#AuthDigestFile "/etc/apache2/digestusers"
#require user testuser
AddHandler mod_python .py
PythonHandler mod_python.publisher
PythonDebug On
allow from all
</Directory>

---------

If I switch it to doing basic authentication with the the following it 
also works:

<Directory /home/files/web/extras>
AuthName "test"
AuthType Basic
AuthUserFile "/etc/apache2/basicusers"
require user testuser
AddHandler mod_python .py
PythonHandler mod_python.publisher
PythonDebug On
#allow from all
</Directory>

This is all with an Apache 2 server on Linux.


Thanks,

Stephen

From grahamd at dscpl.com.au  Thu Apr 21 00:11:37 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr 21 00:11:44 2005
Subject: [mod_python] Attempting to use mod_python on a site which uses
	digest autentication
In-Reply-To: <42672068.2000607@vermeulen.ca>
References: <42672068.2000607@vermeulen.ca>
Message-ID: <556753125c4da69b9b08563a05c4e1cf@dscpl.com.au>


On 21/04/2005, at 1:39 PM, Stephen Vermeulen wrote:

> I am trying to use the publisher handler. I have a basic test using 
> mod_python working, but when I add
> digest authentication to the directories on the web server it stops 
> working. I am not trying to handle the
> authentication with mod_python, rather I'm letting apache do its thing.

Probably could be regarded as a bug in mod_python.publisher. I
will log a bug report if I truly determine that it is.

Specifically it always triggers process_auth() for each request
and it assumes that it is "Basic" authorisation mechanism. Ie.,

     if not user and req.headers_in.has_key("Authorization"):
         try:
             s = req.headers_in["Authorization"][6:]
             s = base64.decodestring(s)
             user, passwd = s.split(":", 1)
         except:
             raise apache.SERVER_RETURN, apache.HTTP_BAD_REQUEST

What it probably should do is:

     if not user and req.headers_in.has_key("Authorization"):
         try:
             authtype,data = 
req.headers_in["Authorization"].split(None,1)
	       if authtype != "Basic":
                ... log a warning perhaps ???
                return realm,user,passwd
             s = req.headers_in["Authorization"][6:]
             s = base64.decodestring(s)
             user, passwd = s.split(":", 1)
         except:
             raise apache.SERVER_RETURN, apache.HTTP_BAD_REQUEST

Not sure what else you could do if not "Basic" and other authentication
type is not supported besides silently return.

The vampire::publisher module probably fares no better with this either
as although I check for basic authentication, ie.,

   # If authorisation credentials provided, determine if
   # it is an accepted scheme and if it is then extract
   # user and passwd.

   user = None
   passwd = None

   if req.headers_in.has_key("Authorization"):
     try:
       header = req.headers_in["Authorization"]
       scheme,credentials = header.split(" ",1)
       credentials = credentials.strip()

       scheme = scheme.lower()
       if scheme == "basic":
         credentials = base64.decodestring(credentials)
         user,passwd = string.split(credentials,":",1)
       else:
         raise apache.SERVER_RETURN, apache.HTTP_BAD_REQUEST
     except:
       raise apache.SERVER_RETURN, apache.HTTP_BAD_REQUEST

I still return a bad request error if it isn't.

If in Vampire you use vampire.Publisher() within the context of a basic
content handler, in Vampire 1.6 you can disable the default login 
handler
to avoid the problem. Wasn't intending to allow disabling of the login
handler in vampire::publisher because mod_python.publisher didn't, but
will have to cater for this issue somehow now I guess. One option may
be to only try and do something with the "Authorization" header if it is
found necessary that it is actually needed. Ie,. that there are __auth__
definitions actually present that need to be checked.

Anyway, if you understand any of that ramble and you want to come to
the dark side that is vampire::publisher, sure I can provide a quick
fix which solves the problem for that. :-)

Graham

From grahamd at dscpl.com.au  Thu Apr 21 00:51:56 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr 21 00:52:03 2005
Subject: [mod_python] Attempting to use mod_python on a site which uses
	digest autentication
In-Reply-To: <556753125c4da69b9b08563a05c4e1cf@dscpl.com.au>
References: <42672068.2000607@vermeulen.ca>
	<556753125c4da69b9b08563a05c4e1cf@dscpl.com.au>
Message-ID: <e12149b4568d21e6d483089afd148be5@dscpl.com.au>


On 21/04/2005, at 2:11 PM, Graham Dumpleton wrote:

>
> On 21/04/2005, at 1:39 PM, Stephen Vermeulen wrote:
>
>> I am trying to use the publisher handler. I have a basic test using 
>> mod_python working, but when I add
>> digest authentication to the directories on the web server it stops 
>> working. I am not trying to handle the
>> authentication with mod_python, rather I'm letting apache do its 
>> thing.
>
> Probably could be regarded as a bug in mod_python.publisher. I
> will log a bug report if I truly determine that it is.

Logged as:

   http://issues.apache.org/jira/browse/MODPYTHON-47

> If in Vampire you use vampire.Publisher() within the context of a basic
> content handler, in Vampire 1.6 you can disable the default login 
> handler
> to avoid the problem. Wasn't intending to allow disabling of the login
> handler in vampire::publisher because mod_python.publisher didn't, but
> will have to cater for this issue somehow now I guess. One option may
> be to only try and do something with the "Authorization" header if it 
> is
> found necessary that it is actually needed. Ie,. that there are 
> __auth__
> definitions actually present that need to be checked.
>
> Anyway, if you understand any of that ramble and you want to come to
> the dark side that is vampire::publisher, sure I can provide a quick
> fix which solves the problem for that. :-)

Have fixed this problem for vampire::publisher, the mod_python.publisher
equivalent in Vampire. If you don't know about Vampire check out:

   http://www.dscpl.com.au/projects/vampire

You would need to check out working version of Vampire from the 
subversion
repository to get this fix though if you want to try it out.

Graham

From stephen at vermeulen.ca  Thu Apr 21 10:01:34 2005
From: stephen at vermeulen.ca (Stephen Vermeulen)
Date: Thu Apr 21 10:01:37 2005
Subject: [mod_python] Attempting to use mod_python on a site which uses
	digest autentication
In-Reply-To: <e12149b4568d21e6d483089afd148be5@dscpl.com.au>
References: <42672068.2000607@vermeulen.ca>
	<556753125c4da69b9b08563a05c4e1cf@dscpl.com.au>
	<e12149b4568d21e6d483089afd148be5@dscpl.com.au>
Message-ID: <4267B23E.3030503@vermeulen.ca>

Graham Dumpleton wrote:

>
> On 21/04/2005, at 2:11 PM, Graham Dumpleton wrote:
>
>>
>> On 21/04/2005, at 1:39 PM, Stephen Vermeulen wrote:
>>
>>> I am trying to use the publisher handler. I have a basic test using 
>>> mod_python working, but when I add
>>> digest authentication to the directories on the web server it stops 
>>> working. I am not trying to handle the
>>> authentication with mod_python, rather I'm letting apache do its thing.
>>
>>
>> Probably could be regarded as a bug in mod_python.publisher. I
>> will log a bug report if I truly determine that it is.
>
>
> Logged as:
>
>   http://issues.apache.org/jira/browse/MODPYTHON-47

Thanks, at least now I know about the limitation.  While searching 
around for
more help on this I eventually came across this:

http://www.modpython.org/pipermail/mod_python/2004-April/015452.html

artical from 2004 which references this:

http://www.modpython.org/pipermail/mod_python/2002-September/013071.html

artical which looks like it might contain a fix for this that was 
submitted in 2002?



>
> Graham
>
>
Stephen

From bud at comune.grosseto.it  Thu Apr 21 12:45:12 2005
From: bud at comune.grosseto.it (Bud P. Bruegger)
Date: Thu Apr 21 12:39:25 2005
Subject: [mod_python] how to set req.user?
Message-ID: <5.2.1.1.0.20050421184447.0296c9e8@mail.comune.grosseto.it>

Hello,

I would like to write a simple handler that sets the REMOTE_USER 
cgi-variable.  The incentive of this is that no matter how the user 
authenticates (with HTTP BASIC or with SSL client-cert-auth and 
+fakeBasicAuth), I would like to present the same person ID to the (cgi) 
application.  In particular, I would like to set REMOTE_USER to the 
national unique person identifier (similar to a U.S. social security 
number).  For example, the handler should take the HTTP BASIC user name or 
Distinguished Name returned by mod_ssl, use it to look up the national 
person ID, and then assign it to REMOTE_USER.

My problem is that the Request Member "user" documented to be 
read-only.  Does this mean that I have to intervene some time after the 
authentication phase and before the request is passed off to the cgi 
application?  Should I maybe act on req.subprocess_env in the Fixup handler?
Maybe it is relevant that in a simple test with Apache 1.3, a SetEnv 
REMOTE_USER <someLiteral> worked and was visible from the CGI App.

Many thanks in advance for any help
-b


-------------------------------------------------------------------------------------------------
Ing. Bud P. Bruegger, Ph.D.                 +39-0564-488577 
(voice),  -21139 (fax)
Servizio Elaborazione Dati                    e-mail:  bud@comune.grosseto.it
Comune di 
Grosseto                            http://www.comune.grosseto.it/cie/
Via Ginori, 
43                                      http://OpenPortalGuard.sf.net
58100 Grosseto (Tuscany, Italy)           jabber:  bud@amessage.info

Free Software in Public Administration:  not just a good idea, but a necessity

Perfection is attained, not when there is nothing more to be added, but 
when there is nothing more to be taken away -- Antoine de Saint-Exupery  

From grisha at modpython.org  Thu Apr 21 14:54:02 2005
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Thu Apr 21 14:54:17 2005
Subject: [mod_python] how to set req.user?
In-Reply-To: <5.2.1.1.0.20050421184447.0296c9e8@mail.comune.grosseto.it>
References: <5.2.1.1.0.20050421184447.0296c9e8@mail.comune.grosseto.it>
Message-ID: <20050421145247.V71813@grisha.dyndns.org>


That's a documentation error. req.user has been writable for quite a while 
now.

Grisha

On Thu, 21 Apr 2005, Bud P. Bruegger wrote:

> Hello,
>
> I would like to write a simple handler that sets the REMOTE_USER 
> cgi-variable.  The incentive of this is that no matter how the user 
> authenticates (with HTTP BASIC or with SSL client-cert-auth and 
> +fakeBasicAuth), I would like to present the same person ID to the (cgi) 
> application.  In particular, I would like to set REMOTE_USER to the national 
> unique person identifier (similar to a U.S. social security number).  For 
> example, the handler should take the HTTP BASIC user name or Distinguished 
> Name returned by mod_ssl, use it to look up the national person ID, and then 
> assign it to REMOTE_USER.
>
> My problem is that the Request Member "user" documented to be read-only. 
> Does this mean that I have to intervene some time after the authentication 
> phase and before the request is passed off to the cgi application?  Should I 
> maybe act on req.subprocess_env in the Fixup handler?
> Maybe it is relevant that in a simple test with Apache 1.3, a SetEnv 
> REMOTE_USER <someLiteral> worked and was visible from the CGI App.
>
> Many thanks in advance for any help
> -b
>
>
> -------------------------------------------------------------------------------------------------
> Ing. Bud P. Bruegger, Ph.D.                 +39-0564-488577 (voice),  -21139 
> (fax)
> Servizio Elaborazione Dati                    e-mail:  bud@comune.grosseto.it
> Comune di Grosseto 
> http://www.comune.grosseto.it/cie/
> Via Ginori, 43 
> http://OpenPortalGuard.sf.net
> 58100 Grosseto (Tuscany, Italy)           jabber:  bud@amessage.info
>
> Free Software in Public Administration:  not just a good idea, but a 
> necessity
>
> Perfection is attained, not when there is nothing more to be added, but when 
> there is nothing more to be taken away -- Antoine de Saint-Exupery 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From grahamd at dscpl.com.au  Thu Apr 21 18:30:26 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr 21 18:30:33 2005
Subject: [mod_python] Attempting to use mod_python on a site which uses
	digest autentication
In-Reply-To: <4267B23E.3030503@vermeulen.ca>
References: <42672068.2000607@vermeulen.ca>
	<556753125c4da69b9b08563a05c4e1cf@dscpl.com.au>
	<e12149b4568d21e6d483089afd148be5@dscpl.com.au>
	<4267B23E.3030503@vermeulen.ca>
Message-ID: <4ac634eb22ed5bdfb89783938b8518ab@dscpl.com.au>


On 22/04/2005, at 12:01 AM, Stephen Vermeulen wrote:

> Graham Dumpleton wrote:
>
>>
>> On 21/04/2005, at 2:11 PM, Graham Dumpleton wrote:
>>
>>>
>>> On 21/04/2005, at 1:39 PM, Stephen Vermeulen wrote:
>>>
>>>> I am trying to use the publisher handler. I have a basic test using  
>>>> mod_python working, but when I add
>>>> digest authentication to the directories on the web server it stops  
>>>> working. I am not trying to handle the
>>>> authentication with mod_python, rather I'm letting apache do its  
>>>> thing.
>>>
>>>
>>> Probably could be regarded as a bug in mod_python.publisher. I
>>> will log a bug report if I truly determine that it is.
>>
>>
>> Logged as:
>>
>>   http://issues.apache.org/jira/browse/MODPYTHON-47
>
> Thanks, at least now I know about the limitation.  While searching  
> around for
> more help on this I eventually came across this:
>
> http://www.modpython.org/pipermail/mod_python/2004-April/015452.html
>
> artical from 2004 which references this:
>
> http://www.modpython.org/pipermail/mod_python/2002-September/ 
> 013071.html
>
> artical which looks like it might contain a fix for this that was  
> submitted in 2002?

Good hunting.

Have added a reference to this previous posting to the bug report.

From grahamd at dscpl.com.au  Thu Apr 21 21:39:24 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr 21 21:39:31 2005
Subject: [mod_python] ANN: Vampire 1.6 is now available.
Message-ID: <a9772c67905e9ec5f4f3fe6660be572d@dscpl.com.au>

Vampire 1.6 is now available.

    http://www.dscpl.com.au/projects/vampire

    http://www.dscpl.com.au/downloads/vampire-1.6-20050422.tar.gz

Vampire is an extension module for mod_python, which provides a more 
flexible
dispatch mechanism for basic content handlers, as well as an alternative
implementation of the mod_python.publisher module. A range of other 
useful
features are also provided which make using mod_python a much more 
pleasant
experience.

For a quick overview of the features that Vampire provides check out:

   http://www.dscpl.com.au/projects/vampire/articles/vampire-001.html

For a full list of changes in this new version check out:

   http://www.dscpl.com.au/projects/vampire/changes.html

A couple of bugs have been fixed in this version, along with some new 
features
and improvements. The supplied example of how to use mod_python/Vampire 
with
Cheetah templates has also been improved.

Problems fixed include a bug in the module import mechanism which was 
causing
thread lockups when import modules were doing sub imports and the 
system was
heavily loaded with requests against the same resource. Plus changes to 
allow
Digest or other forms of authentication to be carried out by Apache and 
not have
Vampire get in the way by throwing back a bad request error due to not 
knowing
anything about that specific authentication type.

Most significant new feature is a way of overriding login 
authentication and
access hooks so that an alternate mechanism to Basic authentication can 
be used.
This allows for example a session based mechanism using a web form for 
login
to be easily used. An example illustrating use of sessions is supplied.

Enjoy.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From grahamd at dscpl.com.au  Fri Apr 22 17:27:52 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Fri Apr 22 17:28:00 2005
Subject: [mod_python] ANN: Vampire 1.6 is now available.
In-Reply-To: <426924C3.60205@vermeulen.ca>
References: <a9772c67905e9ec5f4f3fe6660be572d@dscpl.com.au>
	<426924C3.60205@vermeulen.ca>
Message-ID: <a37174f15210fc644350eff4f215fbb8@dscpl.com.au>

I have heard that with some Linux distros that Python distutils which
"setup.py" uses doesn't work properly if you don't have the full
python-dev version of Pythoninstalled.

Thus, see if the Debian packaging system provides a "python" and
"python-dev" package and make sure you install both.

On 23/04/2005, at 2:22 AM, Stephen Vermeulen wrote:

> Graham Dumpleton wrote:
>
>> Vampire 1.6 is now available.
>>
>>    http://www.dscpl.com.au/projects/vampire
>>
>>    http://www.dscpl.com.au/downloads/vampire-1.6-20050422.tar.gz
>
> I downloaded this, unpacked it and tried to set it up, but ran into an  
> error executing
> the "python setup.py install" phase, here's the console log (I ran all  
> this as root):
>
> -----------------------------
>
> orion:/home/files/downloads/python/vampire/vampire-1.6-20050422/ 
> software# python setup.py build
> running build
> running build_py
> creating build
> creating build/lib
> creating build/lib/vampire
> copying vampire/__init__.py -> build/lib/vampire
> copying vampire/cache.py -> build/lib/vampire
> copying vampire/config.py -> build/lib/vampire
> copying vampire/forms.py -> build/lib/vampire
> copying vampire/lookup.py -> build/lib/vampire
> copying vampire/markup.py -> build/lib/vampire
> copying vampire/xmlrpc.py -> build/lib/vampire
> orion:/home/files/downloads/python/vampire/vampire-1.6-20050422/ 
> software# python setup.py install
> running install
> error: invalid Python installation: unable to open  
> /usr/lib/python2.3/config/Makefile (No such file or directory)
> orion:/home/files/downloads/python/vampire/vampire-1.6-20050422/ 
> software# pythonPython 2.3.5 (#2, Feb  9 2005, 00:38:15)
> [GCC 3.3.5 (Debian 1:3.3.5-8)] on linux2
> Type "help", "copyright", "credits" or "license" for more information.
> >>>
> orion:/home/files/downloads/python/vampire/vampire-1.6-20050422/ 
> software#
>
> ---------------------------------
>
> I checked, and while my Linux has /usr/lib/python2.3 it does not have  
> the config directory.
>
> Stephen
>

From grahamd at dscpl.com.au  Sat Apr 23 03:41:13 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Apr 23 03:41:26 2005
Subject: [mod_python] Passing information through req.internal_redirect().
Message-ID: <ce9d853255fd0a89006acaa2610ab695@dscpl.com.au>

There has been a few times on the list where questions have been asked 
about
how to pass information through a "req.internal_redirect()" call. The 
problem
is that any data which is stashed in the "req" object isn't available 
to the
target of the internal redirect because Apache/mod_python constructs a 
new
"req" object for the subsequent handler invocation.

Turns out there is actually a way of passing at least some information. 
This
is done by adding new key/values to the "req.subprocess_env" table. 
This table
is held within Apache data structures associated with the request and 
contents
of it are propagated through to the target of the internal redirect. 
The only
trick is that the key names get modified when the redirect occurs. You 
also
can only store string values.

Take for example a handler which contains:

   from mod_python import apache
   import os

   def handler(req):
     req.subprocess_env.add("XXX","YYY")
     req.internal_redirect(os.path.split(req.uri)[0]+'/page')
     return apache.OK

and is accessed as:

   /~grahamd/redirect/redirect

And a second handler which is triggered as the target of the redirect 
which
contains:

   from mod_python import apache

   def handler(req):
     req.content_type = "text/plain"
     for key in req.subprocess_env.keys():
       print >> req, key, "=", req.subprocess_env[key]
     return apache.OK

That is, URL for this is:

   /~grahamd/redirect/page

The result of making a request against the first URL is that 
redirection to
the second occurs, with the output being:

   REDIRECT_GATEWAY_INTERFACE = CGI/1.1
   REDIRECT_SERVER_PROTOCOL = HTTP/1.1
   REDIRECT_REQUEST_METHOD = GET
   REDIRECT_QUERY_STRING =
   REDIRECT_REQUEST_URI = /~grahamd/redirect/redirect
   REDIRECT_SCRIPT_NAME = /~grahamd/redirect/redirect
   REDIRECT_XXX = YYY
   REDIRECT_STATUS = 200
   GATEWAY_INTERFACE = CGI/1.1
   SERVER_PROTOCOL = HTTP/1.1
   REQUEST_METHOD = GET
   QUERY_STRING =
   REQUEST_URI = /~grahamd/redirect/redirect
   SCRIPT_NAME = /~grahamd/redirect/page

As can be seen, the key/value pair of "XXX" and "YYY" have persisted, 
although
the key name is now "REDIRECT_XXX". One can also see that other 
preexisting
variables set by Apache for the original request are also propagated as 
well,
with similar key name change.

That one can pass a newly created value would be useful where for 
example a
initial handler had created a new session object as it could store the 
session
ID in this table such that it is accessible to the second handler. In 
the past
people have noticed how in redirects both handlers end up creating 
separate
new session IDs if the first handler had to create one, because the new 
session
ID is lost and not usable by the second handler.

The information propagated about the initial request is useful as well 
for the
fact that the original URI is present. This could be used by the second 
handler
in some way.

As an example, when using the ErrorDocument directive, Apache uses an 
internal
redirect to redirect to the page when it is a local URI. As documented 
in:

   http://httpd.apache.org/docs-2.0/custom-error.html

the req.subprocess_env would contain the "REDIRECT_*" values shown 
above. In
this case the internal redirect is being done in Apache itself, but 
there is
no reason that you couldn't implement your own version of the 
ErrorDocument
functionality in your own custom handler code.

Anyway, thought I would put together this ramble about this stuff when 
I found
that this could be done since it may have been a solution to problems a 
few
people had faced before, but that it could be done doesn't seem to have 
ever
been mentioned on the mailing list before. At least now anyone 
searching the
archives may find this. :-)

Enjoy.

Graham

From grisha at modpython.org  Sat Apr 23 22:47:31 2005
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Sat Apr 23 22:47:42 2005
Subject: [mod_python] Passing information through req.internal_redirect().
In-Reply-To: <ce9d853255fd0a89006acaa2610ab695@dscpl.com.au>
References: <ce9d853255fd0a89006acaa2610ab695@dscpl.com.au>
Message-ID: <20050423224638.D24298@grisha.dyndns.org>


How about req.notes - does that work? That may be a more appropriate table 
to use than subprocess_env.

Grisha

On Sat, 23 Apr 2005, Graham Dumpleton wrote:

> There has been a few times on the list where questions have been asked about
> how to pass information through a "req.internal_redirect()" call. The problem
> is that any data which is stashed in the "req" object isn't available to the
> target of the internal redirect because Apache/mod_python constructs a new
> "req" object for the subsequent handler invocation.
>
> Turns out there is actually a way of passing at least some information. This
> is done by adding new key/values to the "req.subprocess_env" table. This 
> table
> is held within Apache data structures associated with the request and 
> contents
> of it are propagated through to the target of the internal redirect. The only
> trick is that the key names get modified when the redirect occurs. You also
> can only store string values.
>
> Take for example a handler which contains:
>
>  from mod_python import apache
>  import os
>
>  def handler(req):
>    req.subprocess_env.add("XXX","YYY")
>    req.internal_redirect(os.path.split(req.uri)[0]+'/page')
>    return apache.OK
>
> and is accessed as:
>
>  /~grahamd/redirect/redirect
>
> And a second handler which is triggered as the target of the redirect which
> contains:
>
>  from mod_python import apache
>
>  def handler(req):
>    req.content_type = "text/plain"
>    for key in req.subprocess_env.keys():
>      print >> req, key, "=", req.subprocess_env[key]
>    return apache.OK
>
> That is, URL for this is:
>
>  /~grahamd/redirect/page
>
> The result of making a request against the first URL is that redirection to
> the second occurs, with the output being:
>
>  REDIRECT_GATEWAY_INTERFACE = CGI/1.1
>  REDIRECT_SERVER_PROTOCOL = HTTP/1.1
>  REDIRECT_REQUEST_METHOD = GET
>  REDIRECT_QUERY_STRING =
>  REDIRECT_REQUEST_URI = /~grahamd/redirect/redirect
>  REDIRECT_SCRIPT_NAME = /~grahamd/redirect/redirect
>  REDIRECT_XXX = YYY
>  REDIRECT_STATUS = 200
>  GATEWAY_INTERFACE = CGI/1.1
>  SERVER_PROTOCOL = HTTP/1.1
>  REQUEST_METHOD = GET
>  QUERY_STRING =
>  REQUEST_URI = /~grahamd/redirect/redirect
>  SCRIPT_NAME = /~grahamd/redirect/page
>
> As can be seen, the key/value pair of "XXX" and "YYY" have persisted, 
> although
> the key name is now "REDIRECT_XXX". One can also see that other preexisting
> variables set by Apache for the original request are also propagated as well,
> with similar key name change.
>
> That one can pass a newly created value would be useful where for example a
> initial handler had created a new session object as it could store the 
> session
> ID in this table such that it is accessible to the second handler. In the 
> past
> people have noticed how in redirects both handlers end up creating separate
> new session IDs if the first handler had to create one, because the new 
> session
> ID is lost and not usable by the second handler.
>
> The information propagated about the initial request is useful as well for 
> the
> fact that the original URI is present. This could be used by the second 
> handler
> in some way.
>
> As an example, when using the ErrorDocument directive, Apache uses an 
> internal
> redirect to redirect to the page when it is a local URI. As documented in:
>
>  http://httpd.apache.org/docs-2.0/custom-error.html
>
> the req.subprocess_env would contain the "REDIRECT_*" values shown above. In
> this case the internal redirect is being done in Apache itself, but there is
> no reason that you couldn't implement your own version of the ErrorDocument
> functionality in your own custom handler code.
>
> Anyway, thought I would put together this ramble about this stuff when I 
> found
> that this could be done since it may have been a solution to problems a few
> people had faced before, but that it could be done doesn't seem to have ever
> been mentioned on the mailing list before. At least now anyone searching the
> archives may find this. :-)
>
> Enjoy.
>
> Graham
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From grahamd at dscpl.com.au  Sun Apr 24 01:49:23 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Apr 24 01:49:31 2005
Subject: [mod_python] Passing information through req.internal_redirect().
In-Reply-To: <20050423224638.D24298@grisha.dyndns.org>
References: <ce9d853255fd0a89006acaa2610ab695@dscpl.com.au>
	<20050423224638.D24298@grisha.dyndns.org>
Message-ID: <187bb04ca7d3cec716989da5b20682ba@dscpl.com.au>

> How about req.notes - does that work? That may be a more appropriate 
> table to use than subprocess_env.
>
> Grisha

Nothing I put in "req.notes" survives the redirect.

There is some stuff in there:

   python_init_ran = 1
   mod_userdir_user = grahamd

The "python_init_ran" is put there by either of:

   PythonHeaderParserHandler
   PythonPostReadRequestHandler

code in mod_python.c and seems to be a bookkeeping flag to ensure that:

   PythonInitHandler

is only run once.

The "moduserdir_user" setting seems to be inherited from Apache.

Thus, "req.notes" appears to be created for each invocation of request
handler phases.

However, if one instead uses "req.connection.notes", ie., notes object 
which
exists in the connection object, then they are preserved.

So therefore have two ways of passing information, either in the table 
object
"req.subprocess_env" or in table object "req.connection.notes". In the 
latter,
the key names are preserved as they were whereas in 
"req.subprocess_env" they
get "REDIRECT_" prefixed.

Because it is a table object in both cases, value can still only be a 
string.

Information in "req.subprocess_env" is still useful in its own right if 
the
original URI was required.

Anyway, useful stuff to know even though I am not sure I have a use for 
it
at the moment.

Graham

On 24/04/2005, at 12:47 PM, Gregory (Grisha) Trubetskoy wrote:

> On Sat, 23 Apr 2005, Graham Dumpleton wrote:
>
>> There has been a few times on the list where questions have been 
>> asked about
>> how to pass information through a "req.internal_redirect()" call. The 
>> problem
>> is that any data which is stashed in the "req" object isn't available 
>> to the
>> target of the internal redirect because Apache/mod_python constructs 
>> a new
>> "req" object for the subsequent handler invocation.
>>
>> Turns out there is actually a way of passing at least some 
>> information. This
>> is done by adding new key/values to the "req.subprocess_env" table. 
>> This table
>> is held within Apache data structures associated with the request and 
>> contents
>> of it are propagated through to the target of the internal redirect. 
>> The only
>> trick is that the key names get modified when the redirect occurs. 
>> You also
>> can only store string values.
>>
>> Take for example a handler which contains:
>>
>>  from mod_python import apache
>>  import os
>>
>>  def handler(req):
>>    req.subprocess_env.add("XXX","YYY")
>>    req.internal_redirect(os.path.split(req.uri)[0]+'/page')
>>    return apache.OK
>>
>> and is accessed as:
>>
>>  /~grahamd/redirect/redirect
>>
>> And a second handler which is triggered as the target of the redirect 
>> which
>> contains:
>>
>>  from mod_python import apache
>>
>>  def handler(req):
>>    req.content_type = "text/plain"
>>    for key in req.subprocess_env.keys():
>>      print >> req, key, "=", req.subprocess_env[key]
>>    return apache.OK
>>
>> That is, URL for this is:
>>
>>  /~grahamd/redirect/page
>>
>> The result of making a request against the first URL is that 
>> redirection to
>> the second occurs, with the output being:
>>
>>  REDIRECT_GATEWAY_INTERFACE = CGI/1.1
>>  REDIRECT_SERVER_PROTOCOL = HTTP/1.1
>>  REDIRECT_REQUEST_METHOD = GET
>>  REDIRECT_QUERY_STRING =
>>  REDIRECT_REQUEST_URI = /~grahamd/redirect/redirect
>>  REDIRECT_SCRIPT_NAME = /~grahamd/redirect/redirect
>>  REDIRECT_XXX = YYY
>>  REDIRECT_STATUS = 200
>>  GATEWAY_INTERFACE = CGI/1.1
>>  SERVER_PROTOCOL = HTTP/1.1
>>  REQUEST_METHOD = GET
>>  QUERY_STRING =
>>  REQUEST_URI = /~grahamd/redirect/redirect
>>  SCRIPT_NAME = /~grahamd/redirect/page
>>
>> As can be seen, the key/value pair of "XXX" and "YYY" have persisted, 
>> although
>> the key name is now "REDIRECT_XXX". One can also see that other 
>> preexisting
>> variables set by Apache for the original request are also propagated 
>> as well,
>> with similar key name change.
>>
>> That one can pass a newly created value would be useful where for 
>> example a
>> initial handler had created a new session object as it could store 
>> the session
>> ID in this table such that it is accessible to the second handler. In 
>> the past
>> people have noticed how in redirects both handlers end up creating 
>> separate
>> new session IDs if the first handler had to create one, because the 
>> new session
>> ID is lost and not usable by the second handler.
>>
>> The information propagated about the initial request is useful as 
>> well for the
>> fact that the original URI is present. This could be used by the 
>> second handler
>> in some way.
>>
>> As an example, when using the ErrorDocument directive, Apache uses an 
>> internal
>> redirect to redirect to the page when it is a local URI. As 
>> documented in:
>>
>>  http://httpd.apache.org/docs-2.0/custom-error.html
>>
>> the req.subprocess_env would contain the "REDIRECT_*" values shown 
>> above. In
>> this case the internal redirect is being done in Apache itself, but 
>> there is
>> no reason that you couldn't implement your own version of the 
>> ErrorDocument
>> functionality in your own custom handler code.
>>
>> Anyway, thought I would put together this ramble about this stuff 
>> when I found
>> that this could be done since it may have been a solution to problems 
>> a few
>> people had faced before, but that it could be done doesn't seem to 
>> have ever
>> been mentioned on the mailing list before. At least now anyone 
>> searching the
>> archives may find this. :-)
>>
>> Enjoy.
>>
>> Graham
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>

From nicolas.lehuen at gmail.com  Sun Apr 24 03:29:06 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Sun Apr 24 03:29:08 2005
Subject: [mod_python] Passing information through req.internal_redirect().
In-Reply-To: <187bb04ca7d3cec716989da5b20682ba@dscpl.com.au>
References: <ce9d853255fd0a89006acaa2610ab695@dscpl.com.au>
	<20050423224638.D24298@grisha.dyndns.org>
	<187bb04ca7d3cec716989da5b20682ba@dscpl.com.au>
Message-ID: <c298f2d705042400291ab66ad2@mail.gmail.com>

I didn't test it, but it seems the 'prev' member field could help you
get the initial request object after an internal redirect. Quoting
from the documentation :

http://www.modpython.org/live/current/doc-html/pyapi-mprequest-mem.html

next
    If this is an internal redirect, the request object we redirect
to. (Read-Only)

prev
    If this is an internal redirect, the request object we redirect
from. (Read-Only)

Regards,
Nicolas

On 4/24/05, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> > How about req.notes - does that work? That may be a more appropriate
> > table to use than subprocess_env.
> >
> > Grisha
> 
> Nothing I put in "req.notes" survives the redirect.
> 
> There is some stuff in there:
> 
>    python_init_ran = 1
>    mod_userdir_user = grahamd
> 
> The "python_init_ran" is put there by either of:
> 
>    PythonHeaderParserHandler
>    PythonPostReadRequestHandler
> 
> code in mod_python.c and seems to be a bookkeeping flag to ensure that:
> 
>    PythonInitHandler
> 
> is only run once.
> 
> The "moduserdir_user" setting seems to be inherited from Apache.
> 
> Thus, "req.notes" appears to be created for each invocation of request
> handler phases.
> 
> However, if one instead uses "req.connection.notes", ie., notes object
> which
> exists in the connection object, then they are preserved.
> 
> So therefore have two ways of passing information, either in the table
> object
> "req.subprocess_env" or in table object "req.connection.notes". In the
> latter,
> the key names are preserved as they were whereas in
> "req.subprocess_env" they
> get "REDIRECT_" prefixed.
> 
> Because it is a table object in both cases, value can still only be a
> string.
> 
> Information in "req.subprocess_env" is still useful in its own right if
> the
> original URI was required.
> 
> Anyway, useful stuff to know even though I am not sure I have a use for
> it
> at the moment.
> 
> Graham
> 
> On 24/04/2005, at 12:47 PM, Gregory (Grisha) Trubetskoy wrote:
> 
> > On Sat, 23 Apr 2005, Graham Dumpleton wrote:
> >
> >> There has been a few times on the list where questions have been
> >> asked about
> >> how to pass information through a "req.internal_redirect()" call. The
> >> problem
> >> is that any data which is stashed in the "req" object isn't available
> >> to the
> >> target of the internal redirect because Apache/mod_python constructs
> >> a new
> >> "req" object for the subsequent handler invocation.
> >>
> >> Turns out there is actually a way of passing at least some
> >> information. This
> >> is done by adding new key/values to the "req.subprocess_env" table.
> >> This table
> >> is held within Apache data structures associated with the request and
> >> contents
> >> of it are propagated through to the target of the internal redirect.
> >> The only
> >> trick is that the key names get modified when the redirect occurs.
> >> You also
> >> can only store string values.
> >>
> >> Take for example a handler which contains:
> >>
> >>  from mod_python import apache
> >>  import os
> >>
> >>  def handler(req):
> >>    req.subprocess_env.add("XXX","YYY")
> >>    req.internal_redirect(os.path.split(req.uri)[0]+'/page')
> >>    return apache.OK
> >>
> >> and is accessed as:
> >>
> >>  /~grahamd/redirect/redirect
> >>
> >> And a second handler which is triggered as the target of the redirect
> >> which
> >> contains:
> >>
> >>  from mod_python import apache
> >>
> >>  def handler(req):
> >>    req.content_type = "text/plain"
> >>    for key in req.subprocess_env.keys():
> >>      print >> req, key, "=", req.subprocess_env[key]
> >>    return apache.OK
> >>
> >> That is, URL for this is:
> >>
> >>  /~grahamd/redirect/page
> >>
> >> The result of making a request against the first URL is that
> >> redirection to
> >> the second occurs, with the output being:
> >>
> >>  REDIRECT_GATEWAY_INTERFACE = CGI/1.1
> >>  REDIRECT_SERVER_PROTOCOL = HTTP/1.1
> >>  REDIRECT_REQUEST_METHOD = GET
> >>  REDIRECT_QUERY_STRING =
> >>  REDIRECT_REQUEST_URI = /~grahamd/redirect/redirect
> >>  REDIRECT_SCRIPT_NAME = /~grahamd/redirect/redirect
> >>  REDIRECT_XXX = YYY
> >>  REDIRECT_STATUS = 200
> >>  GATEWAY_INTERFACE = CGI/1.1
> >>  SERVER_PROTOCOL = HTTP/1.1
> >>  REQUEST_METHOD = GET
> >>  QUERY_STRING =
> >>  REQUEST_URI = /~grahamd/redirect/redirect
> >>  SCRIPT_NAME = /~grahamd/redirect/page
> >>
> >> As can be seen, the key/value pair of "XXX" and "YYY" have persisted,
> >> although
> >> the key name is now "REDIRECT_XXX". One can also see that other
> >> preexisting
> >> variables set by Apache for the original request are also propagated
> >> as well,
> >> with similar key name change.
> >>
> >> That one can pass a newly created value would be useful where for
> >> example a
> >> initial handler had created a new session object as it could store
> >> the session
> >> ID in this table such that it is accessible to the second handler. In
> >> the past
> >> people have noticed how in redirects both handlers end up creating
> >> separate
> >> new session IDs if the first handler had to create one, because the
> >> new session
> >> ID is lost and not usable by the second handler.
> >>
> >> The information propagated about the initial request is useful as
> >> well for the
> >> fact that the original URI is present. This could be used by the
> >> second handler
> >> in some way.
> >>
> >> As an example, when using the ErrorDocument directive, Apache uses an
> >> internal
> >> redirect to redirect to the page when it is a local URI. As
> >> documented in:
> >>
> >>  http://httpd.apache.org/docs-2.0/custom-error.html
> >>
> >> the req.subprocess_env would contain the "REDIRECT_*" values shown
> >> above. In
> >> this case the internal redirect is being done in Apache itself, but
> >> there is
> >> no reason that you couldn't implement your own version of the
> >> ErrorDocument
> >> functionality in your own custom handler code.
> >>
> >> Anyway, thought I would put together this ramble about this stuff
> >> when I found
> >> that this could be done since it may have been a solution to problems
> >> a few
> >> people had faced before, but that it could be done doesn't seem to
> >> have ever
> >> been mentioned on the mailing list before. At least now anyone
> >> searching the
> >> archives may find this. :-)
> >>
> >> Enjoy.
> >>
> >> Graham
> >>
> >> _______________________________________________
> >> Mod_python mailing list
> >> Mod_python@modpython.org
> >> http://mailman.modpython.org/mailman/listinfo/mod_python
> >>
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>

From grahamd at dscpl.com.au  Sun Apr 24 03:36:17 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Apr 24 03:36:34 2005
Subject: [mod_python] Passing information through req.internal_redirect().
In-Reply-To: <c298f2d705042400291ab66ad2@mail.gmail.com>
References: <ce9d853255fd0a89006acaa2610ab695@dscpl.com.au>
	<20050423224638.D24298@grisha.dyndns.org>
	<187bb04ca7d3cec716989da5b20682ba@dscpl.com.au>
	<c298f2d705042400291ab66ad2@mail.gmail.com>
Message-ID: <b47ede8bc65ac07b02fcb05e143c25fd@dscpl.com.au>

I'll check in a while, but suspect that that still isn't going to give
access to any Python specific stuff that has been stashed in the "req"
object. I remember that one of the past mailing list messages was about
someone having tried this and found it wasn't possible. I would imagine
though that "req.prev.notes" would give you access to the table object
of previous request object, since the table object is stored in Apache.

Graham

On 24/04/2005, at 5:29 PM, Nicolas Lehuen wrote:

> I didn't test it, but it seems the 'prev' member field could help you
> get the initial request object after an internal redirect. Quoting
> from the documentation :
>
> http://www.modpython.org/live/current/doc-html/pyapi-mprequest-mem.html
>
> next
>     If this is an internal redirect, the request object we redirect
> to. (Read-Only)
>
> prev
>     If this is an internal redirect, the request object we redirect
> from. (Read-Only)
>
> Regards,
> Nicolas
>
> On 4/24/05, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>>> How about req.notes - does that work? That may be a more appropriate
>>> table to use than subprocess_env.
>>>
>>> Grisha
>>
>> Nothing I put in "req.notes" survives the redirect.
>>
>> There is some stuff in there:
>>
>>    python_init_ran = 1
>>    mod_userdir_user = grahamd
>>
>> The "python_init_ran" is put there by either of:
>>
>>    PythonHeaderParserHandler
>>    PythonPostReadRequestHandler
>>
>> code in mod_python.c and seems to be a bookkeeping flag to ensure 
>> that:
>>
>>    PythonInitHandler
>>
>> is only run once.
>>
>> The "moduserdir_user" setting seems to be inherited from Apache.
>>
>> Thus, "req.notes" appears to be created for each invocation of request
>> handler phases.
>>
>> However, if one instead uses "req.connection.notes", ie., notes object
>> which
>> exists in the connection object, then they are preserved.
>>
>> So therefore have two ways of passing information, either in the table
>> object
>> "req.subprocess_env" or in table object "req.connection.notes". In the
>> latter,
>> the key names are preserved as they were whereas in
>> "req.subprocess_env" they
>> get "REDIRECT_" prefixed.
>>
>> Because it is a table object in both cases, value can still only be a
>> string.
>>
>> Information in "req.subprocess_env" is still useful in its own right 
>> if
>> the
>> original URI was required.
>>
>> Anyway, useful stuff to know even though I am not sure I have a use 
>> for
>> it
>> at the moment.
>>
>> Graham
>>
>> On 24/04/2005, at 12:47 PM, Gregory (Grisha) Trubetskoy wrote:
>>
>>> On Sat, 23 Apr 2005, Graham Dumpleton wrote:
>>>
>>>> There has been a few times on the list where questions have been
>>>> asked about
>>>> how to pass information through a "req.internal_redirect()" call. 
>>>> The
>>>> problem
>>>> is that any data which is stashed in the "req" object isn't 
>>>> available
>>>> to the
>>>> target of the internal redirect because Apache/mod_python constructs
>>>> a new
>>>> "req" object for the subsequent handler invocation.
>>>>
>>>> Turns out there is actually a way of passing at least some
>>>> information. This
>>>> is done by adding new key/values to the "req.subprocess_env" table.
>>>> This table
>>>> is held within Apache data structures associated with the request 
>>>> and
>>>> contents
>>>> of it are propagated through to the target of the internal redirect.
>>>> The only
>>>> trick is that the key names get modified when the redirect occurs.
>>>> You also
>>>> can only store string values.
>>>>
>>>> Take for example a handler which contains:
>>>>
>>>>  from mod_python import apache
>>>>  import os
>>>>
>>>>  def handler(req):
>>>>    req.subprocess_env.add("XXX","YYY")
>>>>    req.internal_redirect(os.path.split(req.uri)[0]+'/page')
>>>>    return apache.OK
>>>>
>>>> and is accessed as:
>>>>
>>>>  /~grahamd/redirect/redirect
>>>>
>>>> And a second handler which is triggered as the target of the 
>>>> redirect
>>>> which
>>>> contains:
>>>>
>>>>  from mod_python import apache
>>>>
>>>>  def handler(req):
>>>>    req.content_type = "text/plain"
>>>>    for key in req.subprocess_env.keys():
>>>>      print >> req, key, "=", req.subprocess_env[key]
>>>>    return apache.OK
>>>>
>>>> That is, URL for this is:
>>>>
>>>>  /~grahamd/redirect/page
>>>>
>>>> The result of making a request against the first URL is that
>>>> redirection to
>>>> the second occurs, with the output being:
>>>>
>>>>  REDIRECT_GATEWAY_INTERFACE = CGI/1.1
>>>>  REDIRECT_SERVER_PROTOCOL = HTTP/1.1
>>>>  REDIRECT_REQUEST_METHOD = GET
>>>>  REDIRECT_QUERY_STRING =
>>>>  REDIRECT_REQUEST_URI = /~grahamd/redirect/redirect
>>>>  REDIRECT_SCRIPT_NAME = /~grahamd/redirect/redirect
>>>>  REDIRECT_XXX = YYY
>>>>  REDIRECT_STATUS = 200
>>>>  GATEWAY_INTERFACE = CGI/1.1
>>>>  SERVER_PROTOCOL = HTTP/1.1
>>>>  REQUEST_METHOD = GET
>>>>  QUERY_STRING =
>>>>  REQUEST_URI = /~grahamd/redirect/redirect
>>>>  SCRIPT_NAME = /~grahamd/redirect/page
>>>>
>>>> As can be seen, the key/value pair of "XXX" and "YYY" have 
>>>> persisted,
>>>> although
>>>> the key name is now "REDIRECT_XXX". One can also see that other
>>>> preexisting
>>>> variables set by Apache for the original request are also propagated
>>>> as well,
>>>> with similar key name change.
>>>>
>>>> That one can pass a newly created value would be useful where for
>>>> example a
>>>> initial handler had created a new session object as it could store
>>>> the session
>>>> ID in this table such that it is accessible to the second handler. 
>>>> In
>>>> the past
>>>> people have noticed how in redirects both handlers end up creating
>>>> separate
>>>> new session IDs if the first handler had to create one, because the
>>>> new session
>>>> ID is lost and not usable by the second handler.
>>>>
>>>> The information propagated about the initial request is useful as
>>>> well for the
>>>> fact that the original URI is present. This could be used by the
>>>> second handler
>>>> in some way.
>>>>
>>>> As an example, when using the ErrorDocument directive, Apache uses 
>>>> an
>>>> internal
>>>> redirect to redirect to the page when it is a local URI. As
>>>> documented in:
>>>>
>>>>  http://httpd.apache.org/docs-2.0/custom-error.html
>>>>
>>>> the req.subprocess_env would contain the "REDIRECT_*" values shown
>>>> above. In
>>>> this case the internal redirect is being done in Apache itself, but
>>>> there is
>>>> no reason that you couldn't implement your own version of the
>>>> ErrorDocument
>>>> functionality in your own custom handler code.
>>>>
>>>> Anyway, thought I would put together this ramble about this stuff
>>>> when I found
>>>> that this could be done since it may have been a solution to 
>>>> problems
>>>> a few
>>>> people had faced before, but that it could be done doesn't seem to
>>>> have ever
>>>> been mentioned on the mailing list before. At least now anyone
>>>> searching the
>>>> archives may find this. :-)
>>>>
>>>> Enjoy.
>>>>
>>>> Graham
>>>>
>>>> _______________________________________________
>>>> Mod_python mailing list
>>>> Mod_python@modpython.org
>>>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>>>
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>

From grahamd at dscpl.com.au  Sun Apr 24 03:57:50 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Apr 24 03:58:02 2005
Subject: [mod_python] Passing information through req.internal_redirect().
In-Reply-To: <b47ede8bc65ac07b02fcb05e143c25fd@dscpl.com.au>
References: <ce9d853255fd0a89006acaa2610ab695@dscpl.com.au>
	<20050423224638.D24298@grisha.dyndns.org>
	<187bb04ca7d3cec716989da5b20682ba@dscpl.com.au>
	<c298f2d705042400291ab66ad2@mail.gmail.com>
	<b47ede8bc65ac07b02fcb05e143c25fd@dscpl.com.au>
Message-ID: <a529e1be3f53d9e2384c79d5669049b1@dscpl.com.au>

Confirmed state of play. Using "req.prev" does not give access to any
Python specific stuff stashed in "req" by handler which did redirect.
One can as suspected though, use "req.prev.notes" to access data saved
in the "req.notes" of the previous request object, giving a third
place one can save data away.

Obviously if using the "notes" table objects, the subsequent handler
needs to be something that has access to them, whereas  
"req.subprocess_env"
table data can be probably easily be accessed by a handler written in
a totally different language and not in mod_python at all. :-)

Graham

On 24/04/2005, at 5:36 PM, Graham Dumpleton wrote:

> I'll check in a while, but suspect that that still isn't going to give
> access to any Python specific stuff that has been stashed in the "req"
> object. I remember that one of the past mailing list messages was about
> someone having tried this and found it wasn't possible. I would imagine
> though that "req.prev.notes" would give you access to the table object
> of previous request object, since the table object is stored in Apache.
>
> Graham
>
> On 24/04/2005, at 5:29 PM, Nicolas Lehuen wrote:
>
>> I didn't test it, but it seems the 'prev' member field could help you
>> get the initial request object after an internal redirect. Quoting
>> from the documentation :
>>
>> http://www.modpython.org/live/current/doc-html/pyapi-mprequest- 
>> mem.html
>>
>> next
>>     If this is an internal redirect, the request object we redirect
>> to. (Read-Only)
>>
>> prev
>>     If this is an internal redirect, the request object we redirect
>> from. (Read-Only)
>>
>> Regards,
>> Nicolas
>>
>> On 4/24/05, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>>>> How about req.notes - does that work? That may be a more appropriate
>>>> table to use than subprocess_env.
>>>>
>>>> Grisha
>>>
>>> Nothing I put in "req.notes" survives the redirect.
>>>
>>> There is some stuff in there:
>>>
>>>    python_init_ran = 1
>>>    mod_userdir_user = grahamd
>>>
>>> The "python_init_ran" is put there by either of:
>>>
>>>    PythonHeaderParserHandler
>>>    PythonPostReadRequestHandler
>>>
>>> code in mod_python.c and seems to be a bookkeeping flag to ensure  
>>> that:
>>>
>>>    PythonInitHandler
>>>
>>> is only run once.
>>>
>>> The "moduserdir_user" setting seems to be inherited from Apache.
>>>
>>> Thus, "req.notes" appears to be created for each invocation of  
>>> request
>>> handler phases.
>>>
>>> However, if one instead uses "req.connection.notes", ie., notes  
>>> object
>>> which
>>> exists in the connection object, then they are preserved.
>>>
>>> So therefore have two ways of passing information, either in the  
>>> table
>>> object
>>> "req.subprocess_env" or in table object "req.connection.notes". In  
>>> the
>>> latter,
>>> the key names are preserved as they were whereas in
>>> "req.subprocess_env" they
>>> get "REDIRECT_" prefixed.
>>>
>>> Because it is a table object in both cases, value can still only be a
>>> string.
>>>
>>> Information in "req.subprocess_env" is still useful in its own right  
>>> if
>>> the
>>> original URI was required.
>>>
>>> Anyway, useful stuff to know even though I am not sure I have a use  
>>> for
>>> it
>>> at the moment.
>>>
>>> Graham
>>>
>>> On 24/04/2005, at 12:47 PM, Gregory (Grisha) Trubetskoy wrote:
>>>
>>>> On Sat, 23 Apr 2005, Graham Dumpleton wrote:
>>>>
>>>>> There has been a few times on the list where questions have been
>>>>> asked about
>>>>> how to pass information through a "req.internal_redirect()" call.  
>>>>> The
>>>>> problem
>>>>> is that any data which is stashed in the "req" object isn't  
>>>>> available
>>>>> to the
>>>>> target of the internal redirect because Apache/mod_python  
>>>>> constructs
>>>>> a new
>>>>> "req" object for the subsequent handler invocation.
>>>>>
>>>>> Turns out there is actually a way of passing at least some
>>>>> information. This
>>>>> is done by adding new key/values to the "req.subprocess_env" table.
>>>>> This table
>>>>> is held within Apache data structures associated with the request  
>>>>> and
>>>>> contents
>>>>> of it are propagated through to the target of the internal  
>>>>> redirect.
>>>>> The only
>>>>> trick is that the key names get modified when the redirect occurs.
>>>>> You also
>>>>> can only store string values.
>>>>>
>>>>> Take for example a handler which contains:
>>>>>
>>>>>  from mod_python import apache
>>>>>  import os
>>>>>
>>>>>  def handler(req):
>>>>>    req.subprocess_env.add("XXX","YYY")
>>>>>    req.internal_redirect(os.path.split(req.uri)[0]+'/page')
>>>>>    return apache.OK
>>>>>
>>>>> and is accessed as:
>>>>>
>>>>>  /~grahamd/redirect/redirect
>>>>>
>>>>> And a second handler which is triggered as the target of the  
>>>>> redirect
>>>>> which
>>>>> contains:
>>>>>
>>>>>  from mod_python import apache
>>>>>
>>>>>  def handler(req):
>>>>>    req.content_type = "text/plain"
>>>>>    for key in req.subprocess_env.keys():
>>>>>      print >> req, key, "=", req.subprocess_env[key]
>>>>>    return apache.OK
>>>>>
>>>>> That is, URL for this is:
>>>>>
>>>>>  /~grahamd/redirect/page
>>>>>
>>>>> The result of making a request against the first URL is that
>>>>> redirection to
>>>>> the second occurs, with the output being:
>>>>>
>>>>>  REDIRECT_GATEWAY_INTERFACE = CGI/1.1
>>>>>  REDIRECT_SERVER_PROTOCOL = HTTP/1.1
>>>>>  REDIRECT_REQUEST_METHOD = GET
>>>>>  REDIRECT_QUERY_STRING =
>>>>>  REDIRECT_REQUEST_URI = /~grahamd/redirect/redirect
>>>>>  REDIRECT_SCRIPT_NAME = /~grahamd/redirect/redirect
>>>>>  REDIRECT_XXX = YYY
>>>>>  REDIRECT_STATUS = 200
>>>>>  GATEWAY_INTERFACE = CGI/1.1
>>>>>  SERVER_PROTOCOL = HTTP/1.1
>>>>>  REQUEST_METHOD = GET
>>>>>  QUERY_STRING =
>>>>>  REQUEST_URI = /~grahamd/redirect/redirect
>>>>>  SCRIPT_NAME = /~grahamd/redirect/page
>>>>>
>>>>> As can be seen, the key/value pair of "XXX" and "YYY" have  
>>>>> persisted,
>>>>> although
>>>>> the key name is now "REDIRECT_XXX". One can also see that other
>>>>> preexisting
>>>>> variables set by Apache for the original request are also  
>>>>> propagated
>>>>> as well,
>>>>> with similar key name change.
>>>>>
>>>>> That one can pass a newly created value would be useful where for
>>>>> example a
>>>>> initial handler had created a new session object as it could store
>>>>> the session
>>>>> ID in this table such that it is accessible to the second handler.  
>>>>> In
>>>>> the past
>>>>> people have noticed how in redirects both handlers end up creating
>>>>> separate
>>>>> new session IDs if the first handler had to create one, because the
>>>>> new session
>>>>> ID is lost and not usable by the second handler.
>>>>>
>>>>> The information propagated about the initial request is useful as
>>>>> well for the
>>>>> fact that the original URI is present. This could be used by the
>>>>> second handler
>>>>> in some way.
>>>>>
>>>>> As an example, when using the ErrorDocument directive, Apache uses  
>>>>> an
>>>>> internal
>>>>> redirect to redirect to the page when it is a local URI. As
>>>>> documented in:
>>>>>
>>>>>  http://httpd.apache.org/docs-2.0/custom-error.html
>>>>>
>>>>> the req.subprocess_env would contain the "REDIRECT_*" values shown
>>>>> above. In
>>>>> this case the internal redirect is being done in Apache itself, but
>>>>> there is
>>>>> no reason that you couldn't implement your own version of the
>>>>> ErrorDocument
>>>>> functionality in your own custom handler code.
>>>>>
>>>>> Anyway, thought I would put together this ramble about this stuff
>>>>> when I found
>>>>> that this could be done since it may have been a solution to  
>>>>> problems
>>>>> a few
>>>>> people had faced before, but that it could be done doesn't seem to
>>>>> have ever
>>>>> been mentioned on the mailing list before. At least now anyone
>>>>> searching the
>>>>> archives may find this. :-)
>>>>>
>>>>> Enjoy.
>>>>>
>>>>> Graham
>>>>>
>>>>> _______________________________________________
>>>>> Mod_python mailing list
>>>>> Mod_python@modpython.org
>>>>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>>>>
>>>
>>> _______________________________________________
>>> Mod_python mailing list
>>> Mod_python@modpython.org
>>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>>
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From christopher.jackson at gmail.com  Mon Apr 25 08:58:58 2005
From: christopher.jackson at gmail.com (Chris Jackson)
Date: Mon Apr 25 08:59:02 2005
Subject: [mod_python] Passing information through req.internal_redirect().
In-Reply-To: <a529e1be3f53d9e2384c79d5669049b1@dscpl.com.au>
References: <ce9d853255fd0a89006acaa2610ab695@dscpl.com.au>
	<20050423224638.D24298@grisha.dyndns.org>
	<187bb04ca7d3cec716989da5b20682ba@dscpl.com.au>
	<c298f2d705042400291ab66ad2@mail.gmail.com>
	<b47ede8bc65ac07b02fcb05e143c25fd@dscpl.com.au>
	<a529e1be3f53d9e2384c79d5669049b1@dscpl.com.au>
Message-ID: <4d11484d050425055856fbe3c0@mail.gmail.com>

This is all very intersting...and useful information.  I just wish
there was a more standard built-in way of doing this, but I guess
req.subprocess_env will suffice for now.

One could call add_common_vars() to add "extra" data to subprocess_env
as well.  It's also intresting that you mention the req.subprocess_env
table is handled by Apache and can be access in a cross-lingual
fashion; Perhaps even across different processes and separate
"applications."

Thanks for pointing this info out to us.

~= Chris =~

On 4/24/05, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> Confirmed state of play. Using "req.prev" does not give access to any
> Python specific stuff stashed in "req" by handler which did redirect.
> One can as suspected though, use "req.prev.notes" to access data saved
> in the "req.notes" of the previous request object, giving a third
> place one can save data away.
> 
> Obviously if using the "notes" table objects, the subsequent handler
> needs to be something that has access to them, whereas
> "req.subprocess_env"
> table data can be probably easily be accessed by a handler written in
> a totally different language and not in mod_python at all. :-)
> 
> Graham
> 
> On 24/04/2005, at 5:36 PM, Graham Dumpleton wrote:
> 
> > I'll check in a while, but suspect that that still isn't going to give
> > access to any Python specific stuff that has been stashed in the "req"
> > object. I remember that one of the past mailing list messages was about
> > someone having tried this and found it wasn't possible. I would imagine
> > though that "req.prev.notes" would give you access to the table object
> > of previous request object, since the table object is stored in Apache.
> >
> > Graham
> >
> > On 24/04/2005, at 5:29 PM, Nicolas Lehuen wrote:
> >
> >> I didn't test it, but it seems the 'prev' member field could help you
> >> get the initial request object after an internal redirect. Quoting
> >> from the documentation :
> >>
> >> http://www.modpython.org/live/current/doc-html/pyapi-mprequest-
> >> mem.html
> >>
> >> next
> >>     If this is an internal redirect, the request object we redirect
> >> to. (Read-Only)
> >>
> >> prev
> >>     If this is an internal redirect, the request object we redirect
> >> from. (Read-Only)
> >>
> >> Regards,
> >> Nicolas
> >>
> >> On 4/24/05, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> >>>> How about req.notes - does that work? That may be a more appropriate
> >>>> table to use than subprocess_env.
> >>>>
> >>>> Grisha
> >>>
> >>> Nothing I put in "req.notes" survives the redirect.
> >>>
> >>> There is some stuff in there:
> >>>
> >>>    python_init_ran = 1
> >>>    mod_userdir_user = grahamd
> >>>
> >>> The "python_init_ran" is put there by either of:
> >>>
> >>>    PythonHeaderParserHandler
> >>>    PythonPostReadRequestHandler
> >>>
> >>> code in mod_python.c and seems to be a bookkeeping flag to ensure
> >>> that:
> >>>
> >>>    PythonInitHandler
> >>>
> >>> is only run once.
> >>>
> >>> The "moduserdir_user" setting seems to be inherited from Apache.
> >>>
> >>> Thus, "req.notes" appears to be created for each invocation of
> >>> request
> >>> handler phases.
> >>>
> >>> However, if one instead uses "req.connection.notes", ie., notes
> >>> object
> >>> which
> >>> exists in the connection object, then they are preserved.
> >>>
> >>> So therefore have two ways of passing information, either in the
> >>> table
> >>> object
> >>> "req.subprocess_env" or in table object "req.connection.notes". In
> >>> the
> >>> latter,
> >>> the key names are preserved as they were whereas in
> >>> "req.subprocess_env" they
> >>> get "REDIRECT_" prefixed.
> >>>
> >>> Because it is a table object in both cases, value can still only be a
> >>> string.
> >>>
> >>> Information in "req.subprocess_env" is still useful in its own right
> >>> if
> >>> the
> >>> original URI was required.
> >>>
> >>> Anyway, useful stuff to know even though I am not sure I have a use
> >>> for
> >>> it
> >>> at the moment.
> >>>
> >>> Graham
> >>>
> >>> On 24/04/2005, at 12:47 PM, Gregory (Grisha) Trubetskoy wrote:
> >>>
> >>>> On Sat, 23 Apr 2005, Graham Dumpleton wrote:
> >>>>
> >>>>> There has been a few times on the list where questions have been
> >>>>> asked about
> >>>>> how to pass information through a "req.internal_redirect()" call.
> >>>>> The
> >>>>> problem
> >>>>> is that any data which is stashed in the "req" object isn't
> >>>>> available
> >>>>> to the
> >>>>> target of the internal redirect because Apache/mod_python
> >>>>> constructs
> >>>>> a new
> >>>>> "req" object for the subsequent handler invocation.
> >>>>>
> >>>>> Turns out there is actually a way of passing at least some
> >>>>> information. This
> >>>>> is done by adding new key/values to the "req.subprocess_env" table.
> >>>>> This table
> >>>>> is held within Apache data structures associated with the request
> >>>>> and
> >>>>> contents
> >>>>> of it are propagated through to the target of the internal
> >>>>> redirect.
> >>>>> The only
> >>>>> trick is that the key names get modified when the redirect occurs.
> >>>>> You also
> >>>>> can only store string values.
> >>>>>
> >>>>> Take for example a handler which contains:
> >>>>>
> >>>>>  from mod_python import apache
> >>>>>  import os
> >>>>>
> >>>>>  def handler(req):
> >>>>>    req.subprocess_env.add("XXX","YYY")
> >>>>>    req.internal_redirect(os.path.split(req.uri)[0]+'/page')
> >>>>>    return apache.OK
> >>>>>
> >>>>> and is accessed as:
> >>>>>
> >>>>>  /~grahamd/redirect/redirect
> >>>>>
> >>>>> And a second handler which is triggered as the target of the
> >>>>> redirect
> >>>>> which
> >>>>> contains:
> >>>>>
> >>>>>  from mod_python import apache
> >>>>>
> >>>>>  def handler(req):
> >>>>>    req.content_type = "text/plain"
> >>>>>    for key in req.subprocess_env.keys():
> >>>>>      print >> req, key, "=", req.subprocess_env[key]
> >>>>>    return apache.OK
> >>>>>
> >>>>> That is, URL for this is:
> >>>>>
> >>>>>  /~grahamd/redirect/page
> >>>>>
> >>>>> The result of making a request against the first URL is that
> >>>>> redirection to
> >>>>> the second occurs, with the output being:
> >>>>>
> >>>>>  REDIRECT_GATEWAY_INTERFACE = CGI/1.1
> >>>>>  REDIRECT_SERVER_PROTOCOL = HTTP/1.1
> >>>>>  REDIRECT_REQUEST_METHOD = GET
> >>>>>  REDIRECT_QUERY_STRING =
> >>>>>  REDIRECT_REQUEST_URI = /~grahamd/redirect/redirect
> >>>>>  REDIRECT_SCRIPT_NAME = /~grahamd/redirect/redirect
> >>>>>  REDIRECT_XXX = YYY
> >>>>>  REDIRECT_STATUS = 200
> >>>>>  GATEWAY_INTERFACE = CGI/1.1
> >>>>>  SERVER_PROTOCOL = HTTP/1.1
> >>>>>  REQUEST_METHOD = GET
> >>>>>  QUERY_STRING =
> >>>>>  REQUEST_URI = /~grahamd/redirect/redirect
> >>>>>  SCRIPT_NAME = /~grahamd/redirect/page
> >>>>>
> >>>>> As can be seen, the key/value pair of "XXX" and "YYY" have
> >>>>> persisted,
> >>>>> although
> >>>>> the key name is now "REDIRECT_XXX". One can also see that other
> >>>>> preexisting
> >>>>> variables set by Apache for the original request are also
> >>>>> propagated
> >>>>> as well,
> >>>>> with similar key name change.
> >>>>>
> >>>>> That one can pass a newly created value would be useful where for
> >>>>> example a
> >>>>> initial handler had created a new session object as it could store
> >>>>> the session
> >>>>> ID in this table such that it is accessible to the second handler.
> >>>>> In
> >>>>> the past
> >>>>> people have noticed how in redirects both handlers end up creating
> >>>>> separate
> >>>>> new session IDs if the first handler had to create one, because the
> >>>>> new session
> >>>>> ID is lost and not usable by the second handler.
> >>>>>
> >>>>> The information propagated about the initial request is useful as
> >>>>> well for the
> >>>>> fact that the original URI is present. This could be used by the
> >>>>> second handler
> >>>>> in some way.
> >>>>>
> >>>>> As an example, when using the ErrorDocument directive, Apache uses
> >>>>> an
> >>>>> internal
> >>>>> redirect to redirect to the page when it is a local URI. As
> >>>>> documented in:
> >>>>>
> >>>>>  http://httpd.apache.org/docs-2.0/custom-error.html
> >>>>>
> >>>>> the req.subprocess_env would contain the "REDIRECT_*" values shown
> >>>>> above. In
> >>>>> this case the internal redirect is being done in Apache itself, but
> >>>>> there is
> >>>>> no reason that you couldn't implement your own version of the
> >>>>> ErrorDocument
> >>>>> functionality in your own custom handler code.
> >>>>>
> >>>>> Anyway, thought I would put together this ramble about this stuff
> >>>>> when I found
> >>>>> that this could be done since it may have been a solution to
> >>>>> problems
> >>>>> a few
> >>>>> people had faced before, but that it could be done doesn't seem to
> >>>>> have ever
> >>>>> been mentioned on the mailing list before. At least now anyone
> >>>>> searching the
> >>>>> archives may find this. :-)
> >>>>>
> >>>>> Enjoy.
> >>>>>
> >>>>> Graham
> >>>>>
> >>>>> _______________________________________________
> >>>>> Mod_python mailing list
> >>>>> Mod_python@modpython.org
> >>>>> http://mailman.modpython.org/mailman/listinfo/mod_python
> >>>>>
> >>>
> >>> _______________________________________________
> >>> Mod_python mailing list
> >>> Mod_python@modpython.org
> >>> http://mailman.modpython.org/mailman/listinfo/mod_python
> >>>
> >
> > _______________________________________________
> > Mod_python mailing list
> > Mod_python@modpython.org
> > http://mailman.modpython.org/mailman/listinfo/mod_python
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>

From JFeghhi at visa.com  Mon Apr 25 11:36:44 2005
From: JFeghhi at visa.com (Feghhi, Jalil)
Date: Mon Apr 25 11:38:34 2005
Subject: [mod_python] Sesssion Management Questions
Message-ID: <8C53AAFA2050EE40BDCDB9455DA7D6340201920C@sw720ex020.visa.com>


I am trying to move my session management from PSP to python (.py) and
have come across a few issues/questions: 

- When I create a new session, do I need to call load and/or save after
creation?
- I assume each time I update the session, I need to do a load and then
a save. Is that correct?
- I assume each time I read from session, I need to do a load. Is that
right?
- Do I need to worry about lock/unlocking?

(FYI: I am using Apache in pre-fork mode so I get one process for each
request, in case that impacts the way I need to do session handling and
what should I do regarding the above questions.)

One issue I had with using session in PSP code what that I could not set
the session timeout after declaring a session variable? I got an error
to the effect the operation is not allowed after header are sent? Is
that a limitation of using session object in psp code or there are ways
to do this?


Regards,

-Jalil




From christopher.jackson at gmail.com  Mon Apr 25 12:20:39 2005
From: christopher.jackson at gmail.com (Chris Jackson)
Date: Mon Apr 25 12:20:44 2005
Subject: [mod_python] Sesssion Management Questions
In-Reply-To: <8C53AAFA2050EE40BDCDB9455DA7D6340201920C@sw720ex020.visa.com>
References: <8C53AAFA2050EE40BDCDB9455DA7D6340201920C@sw720ex020.visa.com>
Message-ID: <4d11484d0504250920382684be@mail.gmail.com>

Reading the following two threads is a good start:

1. Walkthrough dealing with Session Management
http://www.modpython.org/pipermail/mod_python/2005-January/017111.html

2. Alternatives to using Session object
http://www.modpython.org/pipermail/mod_python/2005-April/017920.html

~= Chris =~




On 4/25/05, Feghhi, Jalil <JFeghhi@visa.com> wrote:
> 
> I am trying to move my session management from PSP to python (.py) and
> have come across a few issues/questions:
> 
> - When I create a new session, do I need to call load and/or save after
> creation?
> - I assume each time I update the session, I need to do a load and then
> a save. Is that correct?
> - I assume each time I read from session, I need to do a load. Is that
> right?
> - Do I need to worry about lock/unlocking?
> 
> (FYI: I am using Apache in pre-fork mode so I get one process for each
> request, in case that impacts the way I need to do session handling and
> what should I do regarding the above questions.)
> 
> One issue I had with using session in PSP code what that I could not set
> the session timeout after declaring a session variable? I got an error
> to the effect the operation is not allowed after header are sent? Is
> that a limitation of using session object in psp code or there are ways
> to do this?
> 
> Regards,
> 
> -Jalil
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>

From hu.007 at 163.com  Tue Apr 26 13:30:48 2005
From: hu.007 at 163.com (=?utf-8?B?6IOh5YW05rSL?=)
Date: Tue Apr 26 13:31:06 2005
Subject: [mod_python] Session initializatin failes - unsubscriptable object
Message-ID: <200504261730.j3QHUm9q027695@modpython.org>

Hello!

	How to solve this problem? I have the same.
	mine: FreeBSD5.4rc3 + apache2.0.53 + python2.3 + mod_python3.1.4.
	http://www.modpython.org/pipermail/mod_python/2005-January/017113.html

Thanks!


From jg.lists at sympatico.ca  Tue Apr 26 14:58:49 2005
From: jg.lists at sympatico.ca (Jim Gallacher)
Date: Tue Apr 26 14:57:33 2005
Subject: [mod_python] Session initializatin failes - unsubscriptable object
In-Reply-To: <200504261730.j3QHUm9q027695@modpython.org>
References: <200504261730.j3QHUm9q027695@modpython.org>
Message-ID: <426E8F69.8030306@sympatico.ca>

??? wrote:
> Hello!
> 
> 	How to solve this problem? I have the same.
> 	mine: FreeBSD5.4rc3 + apache2.0.53 + python2.3 + mod_python3.1.4.
> 	http://www.modpython.org/pipermail/mod_python/2005-January/017113.html
> 

You really haven't given enough information. Any tracebacks? Anything in 
the error log? A code snippet from the offending code perhaps?

Regards,
Jim

From nicolas.lehuen at gmail.com  Tue Apr 26 16:36:50 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Tue Apr 26 16:36:52 2005
Subject: [mod_python] Session initializatin failes - unsubscriptable object
In-Reply-To: <200504261730.j3QHUm9q027695@modpython.org>
References: <200504261730.j3QHUm9q027695@modpython.org>
Message-ID: <c298f2d70504261336654c8d1e@mail.gmail.com>

Hi,

If you have the same problem, then the same solution applies. Just add
a line in your httpd.conf or .htaccess file containing :

PythonOption ApplicationPath '/'

Regards,
Nicolas

On 4/26/05,  <hu.007@163.com> wrote:
> Hello!
> 
>         How to solve this problem? I have the same.
>         mine: FreeBSD5.4rc3 + apache2.0.53 + python2.3 + mod_python3.1.4.
>         http://www.modpython.org/pipermail/mod_python/2005-January/017113.html
> 
> Thanks!
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>

From dharana at dharana.net  Tue Apr 26 17:20:27 2005
From: dharana at dharana.net (dharana)
Date: Tue Apr 26 17:20:27 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
Message-ID: <426EB09B.60804@dharana.net>

I'm using a custom handler which has just this:

-- (webapps/admin/)controller.py ----------
from mod_python import *

def handler(req):
     content_file = psp.PSP(req, string='hello world')
     return
-------------------------------------------


-- relevant part of httpd.conf ---------
<VirtualHost *>
   Servername admin.ozone2.int
   DocumentRoot /home/dharana/websites/ozone2/webapps/admin/

   <Directory /home/dharana/websites/ozone2/webapps/admin/>
       AllowOverride All
       AddHandler mod_python .py
       PythonHandler webapps.admin.controller
       PythonDebug On
       PythonPath "sys.path+['/home/dharana/websites/ozone2/']"
   </Directory>

   DirectoryIndex controller.py
   ErrorLog /var/log/apache/ozone2/admin.log
</VirtualHost>
-----------------------------------------


And when I run it I get a segfault. Relevant part of the log follows:

--- admin.log ------------------------------------------------------
[notice] suEXEC mechanism enabled (wrapper: /usr/local/hosting/bin/suexec)
[notice] Digest: generating secret for digest authentication ...
[notice] Digest: done
[notice] mod_python: Creating 32 session mutexes based on 150 max 
processes and 0 max threads.
[notice] Apache/2.0.52 (Unix) DAV/2 mod_python/3.1.4 Python/2.4 
configured -- resuming normal operations
[notice] mod_python: (Re)importing module 'webapps.admin.controller'
[notice] child pid 23919 exit signal Segmentation fault (11)
[notice] mod_python: (Re)importing module 'webapps.admin.controller'
[notice] child pid 23920 exit signal Segmentation fault (11)
--------------------------------------------------------------------


Writing to a file works ok but is too much overhead. Any ideas?

-
dharana

From grahamd at dscpl.com.au  Tue Apr 26 17:28:47 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 17:29:11 2005
Subject: [mod_python] Session initializatin failes - unsubscriptable object
In-Reply-To: <c298f2d70504261336654c8d1e@mail.gmail.com>
References: <200504261730.j3QHUm9q027695@modpython.org>
	<c298f2d70504261336654c8d1e@mail.gmail.com>
Message-ID: <8a87c05feb7adb9626dcf40cba4f5254@dscpl.com.au>

Adding that the reason is that you have specified the original  
PythonHandler
definition outside of any <Directory> directive in your configuration  
file.

Quote from previous bug report from this for more detail:

  The problem is caused by the way you have set up the Apache config  
file.

  If you do not specify AddHander/PythonHandler outside of a Directory
  directive it will work okay.

  Ie., use:

  # Enable debug under /psp directory
  <Directory /var/www/html/psp>
  AddHandler mod_python .psp
  AddHandler mod_python .psp_
  PythonHandler mod_python.psp
  PythonDebug On
  </Directory>

  If you specify AddHandler outside of the a Directory directive, when  
doing:

    dirpath = self._req.hlist.directory

  the dirpath variable will be set to None, which then cannot be indexed.

  The Session code should possibly check for this strange case, noting  
though
  that what you did in the first place is probably not recommended and  
could
  break other things as well.

The previous case was for PSP, but same thing if you use publisher  
handlers.

As Nicolas indicated, you can also set ApplicationPath explicitly if  
for some
reason you can't do things inside of a <Directory> directive.

On 27/04/2005, at 6:36 AM, Nicolas Lehuen wrote:

> Hi,
>
> If you have the same problem, then the same solution applies. Just add
> a line in your httpd.conf or .htaccess file containing :
>
> PythonOption ApplicationPath '/'
>
> Regards,
> Nicolas
>
> On 4/26/05, ~{:zPKQs~} <hu.007@163.com> wrote:
>> Hello!
>>
>>         How to solve this problem? I have the same.
>>         mine: FreeBSD5.4rc3 + apache2.0.53 + python2.3 +  
>> mod_python3.1.4.
>>          
>> http://www.modpython.org/pipermail/mod_python/2005-January/ 
>> 017113.html
>>
>> Thanks!
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From grahamd at dscpl.com.au  Tue Apr 26 17:34:48 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 17:34:55 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
In-Reply-To: <426EB09B.60804@dharana.net>
References: <426EB09B.60804@dharana.net>
Message-ID: <cd668e4f1acb033939973727c751beb6@dscpl.com.au>


On 27/04/2005, at 7:20 AM, dharana wrote:

> I'm using a custom handler which has just this:
>
> -- (webapps/admin/)controller.py ----------
> from mod_python import *
>
> def handler(req):
>     content_file = psp.PSP(req, string='hello world')
>     return

Unlikely to be the cause of your problem, but you could clean this up a 
bit.
First don't use "from mod_python import *". Safer to use:

   from mod_python import apache
   from mod_python import psp

   def handler(req):
     content_file = psp.PSP(req, string='hello world')
     return apache.OK

Import everything from mod_python will really pollute your module.  The
second thing was that you should return apache.OK and not None as later
can result in 500 HTTP error occurring.

I know you are probably trying to debug the problem and have cut things
down, but I think you are also missing:

   content_file.run()

Without that, nothing of the template will get displayed anyway.

Graham

From dharana at dharana.net  Tue Apr 26 17:51:03 2005
From: dharana at dharana.net (dharana)
Date: Tue Apr 26 17:51:02 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
In-Reply-To: <cd668e4f1acb033939973727c751beb6@dscpl.com.au>
References: <426EB09B.60804@dharana.net>
	<cd668e4f1acb033939973727c751beb6@dscpl.com.au>
Message-ID: <426EB7C7.4030307@dharana.net>



Graham Dumpleton wrote:
> 
> On 27/04/2005, at 7:20 AM, dharana wrote:
> 
>> I'm using a custom handler which has just this:
>>
>> -- (webapps/admin/)controller.py ----------
>> from mod_python import *
>>
>> def handler(req):
>>     content_file = psp.PSP(req, string='hello world')
>>     return
> 
> 
> Unlikely to be the cause of your problem, but you could clean this up a 
> bit.
> First don't use "from mod_python import *". Safer to use:
> 
>   from mod_python import apache
>   from mod_python import psp
> 
>   def handler(req):
>     content_file = psp.PSP(req, string='hello world')
>     return apache.OK
> 
> Import everything from mod_python will really pollute your module.  The
> second thing was that you should return apache.OK and not None as later
> can result in 500 HTTP error occurring.
> 
> I know you are probably trying to debug the problem and have cut things
> down, but I think you are also missing:
> 
>   content_file.run()
> 
> Without that, nothing of the template will get displayed anyway.


I had it setup like this as you know, I just tried to skip any module 
loading problem and to simplify it as much as I could.

I've a tail -f to the apache log file in a secondary console anyways.

--- newversion.py -----------
from mod_python import apache
from mod_python import psp

def handler(req):
     content_file = psp.PSP(req, string='hello world')
     content_file.run()
     return apache.OK
-----------------------------


It still segfaults. I'm running it on a debian box, but I remember 
experiencing this same problem months ago in another different server 
(both hardware and distro, it was gentoo 2004). Please, can anyone check 
if this happens to you too? I find it hard to believe it's 
dharana-specific if it happens in two completely different servers.

-
dharana

From grahamd at dscpl.com.au  Tue Apr 26 18:12:48 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 18:12:55 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
In-Reply-To: <426EB7C7.4030307@dharana.net>
References: <426EB09B.60804@dharana.net>
	<cd668e4f1acb033939973727c751beb6@dscpl.com.au>
	<426EB7C7.4030307@dharana.net>
Message-ID: <9f4387af79e092bc1b49d90c29633edc@dscpl.com.au>

The segmentation fault problems are generally caused by a mismatch in 
versions
of shared libraries that various packages have been compiled against. 
The main
culprits are libexpat, MySQL client libraries and sometimes Sleepycat 
DBM. The
clash is between the version expected by PHP or Apache, and that which 
may be
expected by a Python module being used. Because it is an environment 
issue, it
may well only affect you.

Confirm that the problem only arises when psp module is imported. Ie., 
comment
out the psp import and use of psp module in handler. Ie., handler just 
returns
apache.OK.

If it no longer fails, then add in the following imports to your 
handler, leaving
psp module commented out:

import sys
import os
import marshal
import new
from cgi import escape
import anydbm, whichdb
import tempfile

These are the imports in psp module. If it crashes, start commenting 
out the
imports bit by bit to see if one in particular is causing a problem. 
The anydbm
and whichdb modules could be a problem as far as shared libraries go, 
but the
remainder should be okay.

This sort of debugging process is all I can suggest at the moment.  
I'll try
your actual code later when I get a chance.

Graham

On 27/04/2005, at 7:51 AM, dharana wrote:

>
>
> Graham Dumpleton wrote:
>> On 27/04/2005, at 7:20 AM, dharana wrote:
>>> I'm using a custom handler which has just this:
>>>
>>> -- (webapps/admin/)controller.py ----------
>>> from mod_python import *
>>>
>>> def handler(req):
>>>     content_file = psp.PSP(req, string='hello world')
>>>     return
>> Unlikely to be the cause of your problem, but you could clean this up 
>> a bit.
>> First don't use "from mod_python import *". Safer to use:
>>   from mod_python import apache
>>   from mod_python import psp
>>   def handler(req):
>>     content_file = psp.PSP(req, string='hello world')
>>     return apache.OK
>> Import everything from mod_python will really pollute your module.  
>> The
>> second thing was that you should return apache.OK and not None as 
>> later
>> can result in 500 HTTP error occurring.
>> I know you are probably trying to debug the problem and have cut 
>> things
>> down, but I think you are also missing:
>>   content_file.run()
>> Without that, nothing of the template will get displayed anyway.
>
>
> I had it setup like this as you know, I just tried to skip any module 
> loading problem and to simplify it as much as I could.
>
> I've a tail -f to the apache log file in a secondary console anyways.
>
> --- newversion.py -----------
> from mod_python import apache
> from mod_python import psp
>
> def handler(req):
>     content_file = psp.PSP(req, string='hello world')
>     content_file.run()
>     return apache.OK
> -----------------------------
>
>
> It still segfaults. I'm running it on a debian box, but I remember 
> experiencing this same problem months ago in another different server 
> (both hardware and distro, it was gentoo 2004). Please, can anyone 
> check if this happens to you too? I find it hard to believe it's 
> dharana-specific if it happens in two completely different servers.
>
> -
> dharana

From dharana at dharana.net  Tue Apr 26 18:38:09 2005
From: dharana at dharana.net (dharana)
Date: Tue Apr 26 18:38:09 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
In-Reply-To: <9f4387af79e092bc1b49d90c29633edc@dscpl.com.au>
References: <426EB09B.60804@dharana.net>
	<cd668e4f1acb033939973727c751beb6@dscpl.com.au>
	<426EB7C7.4030307@dharana.net>
	<9f4387af79e092bc1b49d90c29633edc@dscpl.com.au>
Message-ID: <426EC2D1.7080401@dharana.net>

modified handler
-- -------------------------------------------------
from mod_python import apache
#from mod_python import psp

import sys
import os
import marshal
import new
from cgi import escape
import anydbm, whichdb
import tempfile

def handler(req):
#    content_file = psp.PSP(req, string='hello world')
#    content_file.run()
     return apache.OK
-----------------------------------------------------

It doesn't segfault like this.






I tried to hunt it a little bit deeper right into the mod_python's 
psp.py file:

-- site-packages/mod_python/psp.py snippet ---------------------
         if filename:

             # if filename is not absolute, default to our guess
             # of current directory
             if not os.path.isabs(filename):
                 base = os.path.split(req.filename)[0]
                 self.filename = os.path.join(base, filename)

             self.load_from_file()
         else:

             cached = mem_scache.get(string)
             if cached:
                 self.code = cached
             else:
(line 118)      self.code = _psp.parsestring(string)
                 mem_scache.store(string)
-----------------------------------------------------------------

Commenting out line 118 and trying to run the script in the previous 
email (the one that is causing the segfault) gives me this error:

--- traceback -------------------------------------------------------
Mod_python error: "PythonHandler webapps.admin.controller"

Traceback (most recent call last):

   File 
"/usr/local/hosting/lib/python2.4/site-packages/mod_python/apache.py", 
line 299, in HandlerDispatch
     result = object(req)

   File "/home/dharana/websites/ozone2/webapps/admin/controller.py", 
line 13, in handler
     content_file = psp.PSP(req, string='hello world')

   File 
"/usr/local/hosting/lib/python2.4/site-packages/mod_python/psp.py", line 
119, in __init__
     mem_scache.store(string)

TypeError: store() takes exactly 3 arguments (2 given)
-------------------------------------------------------------------

I don't know why this is failling, maybe it has something to do with the 
problem. _psp.parsestring(string) shouldn't modify "string" in any way 
nor should it be able to pass hidden args to the mem_scache.store() 
function, right?



Anyways, I tried to investigate it further but I couldn't go deeper than 
the mod_python source file src/_pspmodule.c (lines 129 to 160). My C 
skills are non-existent.






Grisha, if you read this, this is one of the previous references I found 
about the problem:

   http://www.modpython.org/pipermail/mod_python/2004-May/015552.html

Maybe the typo/bugfix didn't completely solve the problem at hand.



Graham Dumpleton wrote:
> The segmentation fault problems are generally caused by a mismatch in 
> versions
> of shared libraries that various packages have been compiled against. 
> The main
> culprits are libexpat, MySQL client libraries and sometimes Sleepycat 
> DBM. The
> clash is between the version expected by PHP or Apache, and that which 
> may be
> expected by a Python module being used. Because it is an environment 
> issue, it
> may well only affect you.

Thank you for the explanation!

-- 
dharana

From dharana at dharana.net  Tue Apr 26 18:49:08 2005
From: dharana at dharana.net (dharana)
Date: Tue Apr 26 18:49:10 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
In-Reply-To: <426EC2D1.7080401@dharana.net>
References: <426EB09B.60804@dharana.net>	<cd668e4f1acb033939973727c751beb6@dscpl.com.au>	<426EB7C7.4030307@dharana.net>	<9f4387af79e092bc1b49d90c29633edc@dscpl.com.au>
	<426EC2D1.7080401@dharana.net>
Message-ID: <426EC564.1080709@dharana.net>

There where 3 typos in psp.py. I could only fix them by temporarily 
commenting out the _psp.parsestring call. I leave to you the C side :)

I've included the patch file with the typos fixed. Hope it helps. I'm 
also forwarding to python-dev because I believe I've crossed the line again.

-----------------------------------------------------------------------
--- /usr/src/mod_python-3.1.4/lib/python/mod_python/psp.py      Sat Jan 
29 22:25:29 2005
+++ /usr/local/hosting/lib/python2.4/site-packages/mod_python/psp.py 
Wed Apr 27 00:43:06 2005
@@ -111,12 +111,12 @@
              self.load_from_file()
          else:

-            cached = strcache.get(string)
+            cached = mem_scache.get(string)
              if cached:
                  self.code = cached
              else:
                  self.code = _psp.parsestring(string)
-                strcache.store(string)
+                mem_scache.store(string, self.code)

      def cache_get(self, filename, mtime):

@@ -358,8 +358,8 @@

      def get(self, key):
          if self.cache.has_key(key):
-            hist, val = self.cache[key]
-            self.cache[key] = (hits+1, code)
+            hits, val = self.cache[key]
+            self.cache[key] = (hits+1, val)
              return val
          else:
              return None
-----------------------------------------------------------------------

dharana wrote:
> modified handler
> -- -------------------------------------------------
> from mod_python import apache
> #from mod_python import psp
> 
> import sys
> import os
> import marshal
> import new
> from cgi import escape
> import anydbm, whichdb
> import tempfile
> 
> def handler(req):
> #    content_file = psp.PSP(req, string='hello world')
> #    content_file.run()
>     return apache.OK
> -----------------------------------------------------
> 
> It doesn't segfault like this.
> 
> 
> 
> 
> 
> 
> I tried to hunt it a little bit deeper right into the mod_python's 
> psp.py file:
> 
> -- site-packages/mod_python/psp.py snippet ---------------------
>         if filename:
> 
>             # if filename is not absolute, default to our guess
>             # of current directory
>             if not os.path.isabs(filename):
>                 base = os.path.split(req.filename)[0]
>                 self.filename = os.path.join(base, filename)
> 
>             self.load_from_file()
>         else:
> 
>             cached = mem_scache.get(string)
>             if cached:
>                 self.code = cached
>             else:
> (line 118)      self.code = _psp.parsestring(string)
>                 mem_scache.store(string)
> -----------------------------------------------------------------
> 
> Commenting out line 118 and trying to run the script in the previous 
> email (the one that is causing the segfault) gives me this error:
> 
> --- traceback -------------------------------------------------------
> Mod_python error: "PythonHandler webapps.admin.controller"
> 
> Traceback (most recent call last):
> 
>   File 
> "/usr/local/hosting/lib/python2.4/site-packages/mod_python/apache.py", 
> line 299, in HandlerDispatch
>     result = object(req)
> 
>   File "/home/dharana/websites/ozone2/webapps/admin/controller.py", line 
> 13, in handler
>     content_file = psp.PSP(req, string='hello world')
> 
>   File 
> "/usr/local/hosting/lib/python2.4/site-packages/mod_python/psp.py", line 
> 119, in __init__
>     mem_scache.store(string)
> 
> TypeError: store() takes exactly 3 arguments (2 given)
> -------------------------------------------------------------------
> 
> I don't know why this is failling, maybe it has something to do with the 
> problem. _psp.parsestring(string) shouldn't modify "string" in any way 
> nor should it be able to pass hidden args to the mem_scache.store() 
> function, right?
> 
> 
> 
> Anyways, I tried to investigate it further but I couldn't go deeper than 
> the mod_python source file src/_pspmodule.c (lines 129 to 160). My C 
> skills are non-existent.
> 
> 
> 
> 
> 
> 
> Grisha, if you read this, this is one of the previous references I found 
> about the problem:
> 
>   http://www.modpython.org/pipermail/mod_python/2004-May/015552.html
> 
> Maybe the typo/bugfix didn't completely solve the problem at hand.
> 
> 
> 
> Graham Dumpleton wrote:
> 
>> The segmentation fault problems are generally caused by a mismatch in 
>> versions
>> of shared libraries that various packages have been compiled against. 
>> The main
>> culprits are libexpat, MySQL client libraries and sometimes Sleepycat 
>> DBM. The
>> clash is between the version expected by PHP or Apache, and that which 
>> may be
>> expected by a Python module being used. Because it is an environment 
>> issue, it
>> may well only affect you.
> 
> 
> Thank you for the explanation!
> 

-- 
dharana

From grisha at modpython.org  Tue Apr 26 18:56:49 2005
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Tue Apr 26 18:57:03 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
In-Reply-To: <426EC2D1.7080401@dharana.net>
References: <426EB09B.60804@dharana.net>
	<cd668e4f1acb033939973727c751beb6@dscpl.com.au>
	<426EB7C7.4030307@dharana.net>
	<9f4387af79e092bc1b49d90c29633edc@dscpl.com.au>
	<426EC2D1.7080401@dharana.net>
Message-ID: <20050426185530.L84053@grisha.dyndns.org>


Nope, this doesn't look to be in any way related.

Has anyone been able to reproduce the segfault?

On Wed, 27 Apr 2005, dharana wrote:

> Grisha, if you read this, this is one of the previous references I found 
> about the problem:
>
>  http://www.modpython.org/pipermail/mod_python/2004-May/015552.html
>
> Maybe the typo/bugfix didn't completely solve the problem at hand.
From grahamd at dscpl.com.au  Tue Apr 26 19:34:12 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 19:34:19 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
Message-ID: <1114558452.7046@dscpl.user.openhosting.com>

Grisha wrote ..
> 
> Nope, this doesn't look to be in any way related.
> 
> Has anyone been able to reproduce the segfault?
> 
> On Wed, 27 Apr 2005, dharana wrote:
> 
> > Grisha, if you read this, this is one of the previous references I found
> > about the problem:
> >
> >  http://www.modpython.org/pipermail/mod_python/2004-May/015552.html
> >
> > Maybe the typo/bugfix didn't completely solve the problem at hand.

Have got to work and been able to try it on Mac OS X.

I don't get a crash, but am able to verify the strcache typo as being
a problem that never seemed to get fixed in code.

[Wed Apr 27 09:29:51 2005] [error] [client 127.0.0.1] PythonHandler _handler: Traceback (most recent call last):
[Wed Apr 27 09:29:51 2005] [error] [client 127.0.0.1] PythonHandler _handler:   File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/apache.py", line 308, in HandlerDispatch\n    result = object(req)
[Wed Apr 27 09:29:51 2005] [error] [client 127.0.0.1] PythonHandler _handler:   File "/Users/grahamd/Sites/psp_crash/_handler.py", line 5, in handler\n    content_file = psp.PSP(req, string='hello world')
[Wed Apr 27 09:29:51 2005] [error] [client 127.0.0.1] PythonHandler _handler:   File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py", line 114, in __init__\n    cached = strcache.get(string)
[Wed Apr 27 09:29:51 2005] [error] [client 127.0.0.1] PythonHandler _handler: NameError: global name 'strcache' is not defined

Graham
From grahamd at dscpl.com.au  Tue Apr 26 19:46:53 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 19:47:03 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
Message-ID: <1114559213.13207@dscpl.user.openhosting.com>

dharana wrote ..
> -- site-packages/mod_python/psp.py snippet ---------------------
>          if filename:
> 
>              # if filename is not absolute, default to our guess
>              # of current directory
>              if not os.path.isabs(filename):
>                  base = os.path.split(req.filename)[0]
>                  self.filename = os.path.join(base, filename)
> 
>              self.load_from_file()
>          else:
> 
>              cached = mem_scache.get(string)
>              if cached:
>                  self.code = cached
>              else:
> (line 118)      self.code = _psp.parsestring(string)
>                  mem_scache.store(string)
> -----------------------------------------------------------------
> 
> Commenting out line 118 and trying to run the script in the previous 
> email (the one that is causing the segfault) gives me this error:
> 
> --- traceback -------------------------------------------------------
>
> ...
> TypeError: store() takes exactly 3 arguments (2 given)
> -------------------------------------------------------------------
> 
> I don't know why this is failling, maybe it has something to do with the
> problem. _psp.parsestring(string) shouldn't modify "string" in any way
> nor should it be able to pass hidden args to the mem_scache.store() 
> function, right?

The store() method is expecting a key and value argument. The string
would be the value argument, but what could the key be set to. Can't
see any way you could automagically produce a value for the key. You
can't use req.filename by itself as the file could create multiple PSP
objects with different strings.

My thinking is that you almost need to have the user of the PSP class
supply an argument to optionally tag the string based PSP object.
The default key could be req.filename and if that optional tag is set,
it could be appended to the req.filename separated by a "?" or other
magic character.

Thus:

  class PSP:
    
    def __init__(self, req, filename=None, string=None, vars={}, tag=""): 

       ...

            key = "%s?%s" % (req.filename,tag)
            cached = mem_scache.get(key,string)
            if cached:
                self.code = cached
            else:
                self.code = _psp.parsestring(string)
                mem_scache.store(key,string)                                          

Graham
From grahamd at dscpl.com.au  Tue Apr 26 20:14:37 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 20:14:38 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
Message-ID: <1114560876.27010@dscpl.user.openhosting.com>

Take two. I should go back to bed, managed to past a whole lot of code
in the cc mail address. In case it didn't get out, reposting.

Ignore this mail, I wrote total garbage. Too early in the morning to be
thinking. Fix by dharana was correct, the string is the key and the code
is the value. I'll shutup now. :-)

Graham Dumpleton wrote ..
> dharana wrote ..
> > -- site-packages/mod_python/psp.py snippet ---------------------
> >          if filename:
> > 
> >              # if filename is not absolute, default to our guess
> >              # of current directory
> >              if not os.path.isabs(filename):
> >                  base = os.path.split(req.filename)[0]
> >                  self.filename = os.path.join(base, filename)
> > 
> >              self.load_from_file()
> >          else:
> > 
> >              cached = mem_scache.get(string)
> >              if cached:
> >                  self.code = cached
> >              else:
> > (line 118)      self.code = _psp.parsestring(string)
> >                  mem_scache.store(string)
> > -----------------------------------------------------------------
> > 
> > Commenting out line 118 and trying to run the script in the previous
> > email (the one that is causing the segfault) gives me this error:
> > 
> > --- traceback -------------------------------------------------------
> >
> > ...
> > TypeError: store() takes exactly 3 arguments (2 given)
> > -------------------------------------------------------------------
> > 
> > I don't know why this is failling, maybe it has something to do with
> the
> > problem. _psp.parsestring(string) shouldn't modify "string" in any way
> > nor should it be able to pass hidden args to the mem_scache.store() 
> > function, right?
> 
> The store() method is expecting a key and value argument. The string
> would be the value argument, but what could the key be set to. Can't
> see any way you could automagically produce a value for the key. You
> can't use req.filename by itself as the file could create multiple PSP
> objects with different strings.
> 
> My thinking is that you almost need to have the user of the PSP class
> supply an argument to optionally tag the string based PSP object.
> The default key could be req.filename and if that optional tag is set,
> it could be appended to the req.filename separated by a "?" or other
> magic character.
> 
> Thus:
> 
>   class PSP:
>     
>     def __init__(self, req, filename=None, string=None, vars={}, tag=""):
> 
>        ...
> 
>             key = "%s?%s" % (req.filename,tag)
>             cached = mem_scache.get(key,string)
>             if cached:
>                 self.code = cached
>             else:
>                 self.code = _psp.parsestring(string)
>                 mem_scache.store(key,string)                          
> 
> Graham
From dharana at dharana.net  Tue Apr 26 20:22:20 2005
From: dharana at dharana.net (dharana)
Date: Tue Apr 26 20:22:25 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
In-Reply-To: <20050426185530.L84053@grisha.dyndns.org>
References: <426EB09B.60804@dharana.net>
	<cd668e4f1acb033939973727c751beb6@dscpl.com.au>
	<426EB7C7.4030307@dharana.net>
	<9f4387af79e092bc1b49d90c29633edc@dscpl.com.au>
	<426EC2D1.7080401@dharana.net>
	<20050426185530.L84053@grisha.dyndns.org>
Message-ID: <426EDB3C.2070408@dharana.net>

I tried in a gentoo laptop. Clean Apache 2.0.52 install, clean 
mod_python install (applied the small typos bugfix from my previous 
email). There is here a new entry wich may or may not tell you something 
new?

I installed this laptop a week ago. It's barebones in packages' terms.

New info about the segfault:

[Wed Apr 27 02:18:26 2005] [notice] mod_python: (Re)importing module 
'controller'
*** glibc detected *** double free or corruption (fasttop): 0x0834fb60 ***
[Wed Apr 27 02:18:27 2005] [notice] child pid 25756 exit signal Abort (6)


Gregory (Grisha) Trubetskoy wrote:
> 
> Nope, this doesn't look to be in any way related.
> 
> Has anyone been able to reproduce the segfault?
> 
> On Wed, 27 Apr 2005, dharana wrote:
> 
>> Grisha, if you read this, this is one of the previous references I 
>> found about the problem:
>>
>>  http://www.modpython.org/pipermail/mod_python/2004-May/015552.html
>>
>> Maybe the typo/bugfix didn't completely solve the problem at hand.
> 
> 
> 
From grahamd at dscpl.com.au  Tue Apr 26 20:24:25 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 20:24:27 2005
Subject: [Fwd: Re: [mod_python] psp.PSP(req,
	string='hello world') causessegfault]
Message-ID: <1114561465.32062@dscpl.user.openhosting.com>

It may not be your platform, but a problem in the C code part of PSP
modules after all. On Mac OSX, after making the Python changes you
give, it doesn't crash, but do get this warning in the logs.

[Wed Apr 27 10:21:14 2005] [notice] Apache/2.0.51 (Unix) mod_python/3.1.3 Python/2.3 configured -- resuming normal operations
*** malloc[595]: Deallocation of a pointer not malloced: 0x528050; This could be a double free(), or free() called with the middle of an allocated block; Try setting environment variable MallocHelp to see tools to help debug
*** malloc[595]: error for object 0x5102c0: Double free
[Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler: Traceback (most recent call last):
[Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:   File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/apache.py", line 308, in HandlerDispatch\n    result = object(req)
[Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:   File "/Users/grahamd/Sites/psp_crash/_handler.py", line 6, in handler\n    content_file.run()
[Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:   File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py", line 190, in run\n    if "session" in code.co_names:
[Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler: AttributeError: 'str' object has no attribute 'co_names' 

I haven't looked at the Python traceback bit yet, but the fact that malloc
is complaining suggests that some sort of memory manipulation is
wrong.

Graham


dharana wrote ..
> There where more typos. I think I've fixed them. I am now trying to 
> reproduce it in another machine. I'm starting to believe it must a 
> problem with my server setup what is causing the segfaults.
> 
> -------- Original Message --------
> Subject: Re: [mod_python] psp.PSP(req, string='hello world') causes segfault
> Date: Wed, 27 Apr 2005 00:49:08 +0200
> From: dharana <dharana@dharana.net>
> To: dharana <dharana@dharana.net>
> CC: Graham Dumpleton <grahamd@dscpl.com.au>,  mod_python list 
> <mod_python@modpython.org>,  python-dev@httpd.apache.org
> References: <426EB09B.60804@dharana.net> 
> <cd668e4f1acb033939973727c751beb6@dscpl.com.au> 
> <426EB7C7.4030307@dharana.net> 
> <9f4387af79e092bc1b49d90c29633edc@dscpl.com.au> 
> <426EC2D1.7080401@dharana.net>
> 
> There where 3 typos in psp.py. I could only fix them by temporarily
> commenting out the _psp.parsestring call. I leave to you the C side :)
> 
> I've included the patch file with the typos fixed. Hope it helps. I'm
> also forwarding to python-dev because I believe I've crossed the line again.
> 
> -----------------------------------------------------------------------
> --- /usr/src/mod_python-3.1.4/lib/python/mod_python/psp.py      Sat Jan
> 29 22:25:29 2005
> +++ /usr/local/hosting/lib/python2.4/site-packages/mod_python/psp.py
> Wed Apr 27 00:43:06 2005
> @@ -111,12 +111,12 @@
>               self.load_from_file()
>           else:
> 
> -            cached = strcache.get(string)
> +            cached = mem_scache.get(string)
>               if cached:
>                   self.code = cached
>               else:
>                   self.code = _psp.parsestring(string)
> -                strcache.store(string)
> +                mem_scache.store(string, self.code)
> 
>       def cache_get(self, filename, mtime):
> 
> @@ -358,8 +358,8 @@
> 
>       def get(self, key):
>           if self.cache.has_key(key):
> -            hist, val = self.cache[key]
> -            self.cache[key] = (hits+1, code)
> +            hits, val = self.cache[key]
> +            self.cache[key] = (hits+1, val)
>               return val
>           else:
>               return None
> -----------------------------------------------------------------------
> 
> -- 
> dharana
From grahamd at dscpl.com.au  Tue Apr 26 20:46:25 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 20:46:30 2005
Subject: [Fwd: Re: [mod_python] psp.PSP(req,
	string='hello world') causessegfault]
Message-ID: <1114562785.10375@dscpl.user.openhosting.com>

Following code in _psp_module_parsestring() looks suspect to me:

    yy_delete_buffer(bs, scanner);
    yylex_destroy(scanner);

There are already calls to yy_delete_buffer() in yylex_destroy(). If I
comment out the call to yy_delete_buffer() I no longer get the
double delete warning. I still get the Python error below though,
so that is the next thing to solve.

Graham

Graham Dumpleton wrote ..
> It may not be your platform, but a problem in the C code part of PSP
> modules after all. On Mac OSX, after making the Python changes you
> give, it doesn't crash, but do get this warning in the logs.
> 
> [Wed Apr 27 10:21:14 2005] [notice] Apache/2.0.51 (Unix) mod_python/3.1.3
> Python/2.3 configured -- resuming normal operations
> *** malloc[595]: Deallocation of a pointer not malloced: 0x528050; This
> could be a double free(), or free() called with the middle of an allocated
> block; Try setting environment variable MallocHelp to see tools to help
> debug
> *** malloc[595]: error for object 0x5102c0: Double free
> [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> Traceback (most recent call last):
> [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/apache.py",
> line 308, in HandlerDispatch\n    result = object(req)
> [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> File "/Users/grahamd/Sites/psp_crash/_handler.py", line 6, in handler\n
> content_file.run()
> [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py",
> line 190, in run\n    if "session" in code.co_names:
> [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> AttributeError: 'str' object has no attribute 'co_names' 
> 
> I haven't looked at the Python traceback bit yet, but the fact that malloc
> is complaining suggests that some sort of memory manipulation is
> wrong.
> 
> Graham
> 
> 
> dharana wrote ..
> > There where more typos. I think I've fixed them. I am now trying to 
> > reproduce it in another machine. I'm starting to believe it must a 
> > problem with my server setup what is causing the segfaults.
> > 
> > -------- Original Message --------
> > Subject: Re: [mod_python] psp.PSP(req, string='hello world') causes segfault
> > Date: Wed, 27 Apr 2005 00:49:08 +0200
> > From: dharana <dharana@dharana.net>
> > To: dharana <dharana@dharana.net>
> > CC: Graham Dumpleton <grahamd@dscpl.com.au>,  mod_python list 
> > <mod_python@modpython.org>,  python-dev@httpd.apache.org
> > References: <426EB09B.60804@dharana.net> 
> > <cd668e4f1acb033939973727c751beb6@dscpl.com.au> 
> > <426EB7C7.4030307@dharana.net> 
> > <9f4387af79e092bc1b49d90c29633edc@dscpl.com.au> 
> > <426EC2D1.7080401@dharana.net>
> > 
> > There where 3 typos in psp.py. I could only fix them by temporarily
> > commenting out the _psp.parsestring call. I leave to you the C side :)
> > 
> > I've included the patch file with the typos fixed. Hope it helps. I'm
> > also forwarding to python-dev because I believe I've crossed the line
> again.
> > 
> > -----------------------------------------------------------------------
> > --- /usr/src/mod_python-3.1.4/lib/python/mod_python/psp.py      Sat Jan
> > 29 22:25:29 2005
> > +++ /usr/local/hosting/lib/python2.4/site-packages/mod_python/psp.py
> > Wed Apr 27 00:43:06 2005
> > @@ -111,12 +111,12 @@
> >               self.load_from_file()
> >           else:
> > 
> > -            cached = strcache.get(string)
> > +            cached = mem_scache.get(string)
> >               if cached:
> >                   self.code = cached
> >               else:
> >                   self.code = _psp.parsestring(string)
> > -                strcache.store(string)
> > +                mem_scache.store(string, self.code)
> > 
> >       def cache_get(self, filename, mtime):
> > 
> > @@ -358,8 +358,8 @@
> > 
> >       def get(self, key):
> >           if self.cache.has_key(key):
> > -            hist, val = self.cache[key]
> > -            self.cache[key] = (hits+1, code)
> > +            hits, val = self.cache[key]
> > +            self.cache[key] = (hits+1, val)
> >               return val
> >           else:
> >               return None
> > -----------------------------------------------------------------------
> > 
> > -- 
> > dharana
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
From grahamd at dscpl.com.au  Tue Apr 26 21:02:11 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 21:02:33 2005
Subject: [Fwd: Re: [mod_python] psp.PSP(req,
	string='hello world') causessegfault]
Message-ID: <1114563730.18428@dscpl.user.openhosting.com>

The code in PSP constructor where code is first put in cache should be:

            cached = mem_scache.get(string)
            if cached:
                self.code = cached
            else:
                source = _psp.parsestring(string)
                code = compile(source, "__psp__", "exec")
                mem_scache.store(string,code)
                self.code = code                                                

Ie., code wasn't actually being compiled. Not sure what should be put
for second argument. It only gets displayed in error messages according
to documentation. Normally it would be the name of the module, but
there isn't one here.

It seems to work for me now. I'll try and get all these changes together
and post a bug report on JIRA.

Graham

Graham Dumpleton wrote ..
> Following code in _psp_module_parsestring() looks suspect to me:
> 
>     yy_delete_buffer(bs, scanner);
>     yylex_destroy(scanner);
> 
> There are already calls to yy_delete_buffer() in yylex_destroy(). If I
> comment out the call to yy_delete_buffer() I no longer get the
> double delete warning. I still get the Python error below though,
> so that is the next thing to solve.
> 
> Graham
> 
> Graham Dumpleton wrote ..
> > It may not be your platform, but a problem in the C code part of PSP
> > modules after all. On Mac OSX, after making the Python changes you
> > give, it doesn't crash, but do get this warning in the logs.
> > 
> > [Wed Apr 27 10:21:14 2005] [notice] Apache/2.0.51 (Unix) mod_python/3.1.3
> > Python/2.3 configured -- resuming normal operations
> > *** malloc[595]: Deallocation of a pointer not malloced: 0x528050; This
> > could be a double free(), or free() called with the middle of an allocated
> > block; Try setting environment variable MallocHelp to see tools to help
> > debug
> > *** malloc[595]: error for object 0x5102c0: Double free
> > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> > Traceback (most recent call last):
> > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> > File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/apache.py",
> > line 308, in HandlerDispatch\n    result = object(req)
> > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> > File "/Users/grahamd/Sites/psp_crash/_handler.py", line 6, in handler\n
> > content_file.run()
> > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> > File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py",
> > line 190, in run\n    if "session" in code.co_names:
> > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
> > AttributeError: 'str' object has no attribute 'co_names' 
> > 
> > I haven't looked at the Python traceback bit yet, but the fact that malloc
> > is complaining suggests that some sort of memory manipulation is
> > wrong.
> > 
> > Graham
> > 
> > 
> > dharana wrote ..
> > > There where more typos. I think I've fixed them. I am now trying to
> > > reproduce it in another machine. I'm starting to believe it must a
> > > problem with my server setup what is causing the segfaults.
> > > 
> > > -------- Original Message --------
> > > Subject: Re: [mod_python] psp.PSP(req, string='hello world') causes
> segfault
> > > Date: Wed, 27 Apr 2005 00:49:08 +0200
> > > From: dharana <dharana@dharana.net>
> > > To: dharana <dharana@dharana.net>
> > > CC: Graham Dumpleton <grahamd@dscpl.com.au>,  mod_python list 
> > > <mod_python@modpython.org>,  python-dev@httpd.apache.org
> > > References: <426EB09B.60804@dharana.net> 
> > > <cd668e4f1acb033939973727c751beb6@dscpl.com.au> 
> > > <426EB7C7.4030307@dharana.net> 
> > > <9f4387af79e092bc1b49d90c29633edc@dscpl.com.au> 
> > > <426EC2D1.7080401@dharana.net>
> > > 
> > > There where 3 typos in psp.py. I could only fix them by temporarily
> > > commenting out the _psp.parsestring call. I leave to you the C side
> :)
> > > 
> > > I've included the patch file with the typos fixed. Hope it helps. I'm
> > > also forwarding to python-dev because I believe I've crossed the line
> > again.
> > > 
> > > -----------------------------------------------------------------------
> > > --- /usr/src/mod_python-3.1.4/lib/python/mod_python/psp.py      Sat
> Jan
> > > 29 22:25:29 2005
> > > +++ /usr/local/hosting/lib/python2.4/site-packages/mod_python/psp.py
> > > Wed Apr 27 00:43:06 2005
> > > @@ -111,12 +111,12 @@
> > >               self.load_from_file()
> > >           else:
> > > 
> > > -            cached = strcache.get(string)
> > > +            cached = mem_scache.get(string)
> > >               if cached:
> > >                   self.code = cached
> > >               else:
> > >                   self.code = _psp.parsestring(string)
> > > -                strcache.store(string)
> > > +                mem_scache.store(string, self.code)
> > > 
> > >       def cache_get(self, filename, mtime):
> > > 
> > > @@ -358,8 +358,8 @@
> > > 
> > >       def get(self, key):
> > >           if self.cache.has_key(key):
> > > -            hist, val = self.cache[key]
> > > -            self.cache[key] = (hits+1, code)
> > > +            hits, val = self.cache[key]
> > > +            self.cache[key] = (hits+1, val)
> > >               return val
> > >           else:
> > >               return None
> > > -----------------------------------------------------------------------
> > > 
> > > -- 
> > > dharana
> > _______________________________________________
> > Mod_python mailing list
> > Mod_python@modpython.org
> > http://mailman.modpython.org/mailman/listinfo/mod_python
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
From gdamjan at mail.net.mk  Tue Apr 26 18:20:14 2005
From: gdamjan at mail.net.mk (Damjan)
Date: Tue Apr 26 21:10:11 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
In-Reply-To: <426EB7C7.4030307@dharana.net>
References: <426EB09B.60804@dharana.net>
	<cd668e4f1acb033939973727c751beb6@dscpl.com.au>
	<426EB7C7.4030307@dharana.net>
Message-ID: <20050426222014.GA32650@legolas.on.net.mk>

> --- newversion.py -----------
> from mod_python import apache
> from mod_python import psp
> 
> def handler(req):
>     content_file = psp.PSP(req, string='hello world')
>     content_file.run()
>     return apache.OK
> -----------------------------

On slackware-10.1, python-2.4, Apache-2.0.53, modpython-3.1.4 I get:

Mod_python error: "PythonHandler mptest"

Traceback (most recent call last):

  File "/usr/lib/python2.4/site-packages/mod_python/apache.py", line 299, in HandlerDispatch
    result = object(req)

  File "/home/www/modpython/mptest.py", line 37, in handler
    return psptest(req)

  File "/home/www/modpython/mptest.py", line 43, in psptest
    content_file = psp.PSP(req, string='hello world')

  File "/usr/lib/python2.4/site-packages/mod_python/psp.py", line 114, in __init__
    cached = strcache.get(string)

NameError: global name 'strcache' is not defined

Now searching google, finds this: 
http://www.modpython.org/pipermail/mod_python/2004-May/015552.html
But even after making the change in psp.py... then I get a segfault and this in
apache's error.log:
[Wed Apr 27 00:18:58 2005] [notice] mod_python: (Re)importing module 'mptest'
*** glibc detected *** double free or corruption (fasttop): 0x083c2db8 ***
/usr/lib/python2.4/site-packages/mod_python/apache.py:457:
DeprecationWarning: Non-ASCII character '\xe2' in
 file /home/www/modpython/mptest.py on line 10, but no encoding
declared; see http://www.python.org/peps/pep-0263.html for details
[Wed Apr 27 00:18:59 2005] [notice] child pid 422 exit signal Aborted (6)



-- 
damjan | ??????
This is my jabber ID --> damjan@bagra.net.mk <-- not my mail address!!!
From gdamjan at mail.net.mk  Tue Apr 26 21:32:53 2005
From: gdamjan at mail.net.mk (Damjan)
Date: Tue Apr 26 21:32:55 2005
Subject: [mod_python] psp.PSP(req, string='hello world') causes segfault
In-Reply-To: <20050426222014.GA32650@legolas.on.net.mk>
References: <426EB09B.60804@dharana.net>
	<cd668e4f1acb033939973727c751beb6@dscpl.com.au>
	<426EB7C7.4030307@dharana.net>
	<20050426222014.GA32650@legolas.on.net.mk>
Message-ID: <20050427013253.GA1358@legolas.on.net.mk>

> On slackware-10.1, python-2.4, Apache-2.0.53, modpython-3.1.4 I get:

BTW I also tried without PHP loaded, same thing happens.

> apache's error.log:
> [Wed Apr 27 00:18:58 2005] [notice] mod_python: (Re)importing module 'mptest'
> *** glibc detected *** double free or corruption (fasttop): 0x083c2db8 ***
> /usr/lib/python2.4/site-packages/mod_python/apache.py:457:
> DeprecationWarning: Non-ASCII character '\xe2' in
>  file /home/www/modpython/mptest.py on line 10, but no encoding
> declared; see http://www.python.org/peps/pep-0263.html for details
> [Wed Apr 27 00:18:59 2005] [notice] child pid 422 exit signal Aborted (6)

I guess, the pep-0263 error happens because of the segfault, since there
are no non-ASCII characters in that file (and I'm 100% sure of it).
Anyway even after adding # -*- coding: utf-8 -*- in the file I still get
this:
[Wed Apr 27 03:08:02 2005] [notice] mod_python: (Re)importing module 'mptest'
*** glibc detected *** double free or corruption (fasttop): 0x0819fcf0 ***
[Wed Apr 27 03:08:03 2005] [notice] child pid 1190 exit signal Aborted (6)


-- 
damjan | ??????
This is my jabber ID --> damjan@bagra.net.mk <-- not my mail address!!!
From grahamd at dscpl.com.au  Tue Apr 26 21:36:42 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 21:36:45 2005
Subject: [mod_python] psp.PSP(req,string='hello world') causessegfault]
Message-ID: <1114565802.2991@dscpl.user.openhosting.com>

I have put all the code changes together under the bug report:

  http://issues.apache.org/jira/browse/MODPYTHON-48

Links have been included back to some of the mailing list
messages for context.

If this doesn't solve everything let us know.

Graham

Graham Dumpleton wrote ..
> The code in PSP constructor where code is first put in cache should be:
> 
>             cached = mem_scache.get(string)
>             if cached:
>                 self.code = cached
>             else:
>                 source = _psp.parsestring(string)
>                 code = compile(source, "__psp__", "exec")
>                 mem_scache.store(string,code)
>                 self.code = code                                      
> 
> Ie., code wasn't actually being compiled. Not sure what should be put
> for second argument. It only gets displayed in error messages according
> to documentation. Normally it would be the name of the module, but
> there isn't one here.
> 
> It seems to work for me now. I'll try and get all these changes together
> and post a bug report on JIRA.
> 
> Graham
> 
> Graham Dumpleton wrote ..
> > Following code in _psp_module_parsestring() looks suspect to me:
> > 
> >     yy_delete_buffer(bs, scanner);
> >     yylex_destroy(scanner);
> > 
> > There are already calls to yy_delete_buffer() in yylex_destroy(). If
> I
> > comment out the call to yy_delete_buffer() I no longer get the
> > double delete warning. I still get the Python error below though,
> > so that is the next thing to solve.
> > 
> > Graham
> > 
> > Graham Dumpleton wrote ..
> > > It may not be your platform, but a problem in the C code part of PSP
> > > modules after all. On Mac OSX, after making the Python changes you
> > > give, it doesn't crash, but do get this warning in the logs.
> > > 
> > > [Wed Apr 27 10:21:14 2005] [notice] Apache/2.0.51 (Unix) mod_python/3.1.3
> > > Python/2.3 configured -- resuming normal operations
> > > *** malloc[595]: Deallocation of a pointer not malloced: 0x528050;
> This
> > > could be a double free(), or free() called with the middle of an allocated
> > > block; Try setting environment variable MallocHelp to see tools to
> help
> > > debug
> > > *** malloc[595]: error for object 0x5102c0: Double free
> > > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler
> _handler:
> > > Traceback (most recent call last):
> > > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler
> _handler:
> > > File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/apache.py",
> > > line 308, in HandlerDispatch\n    result = object(req)
> > > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler
> _handler:
> > > File "/Users/grahamd/Sites/psp_crash/_handler.py", line 6, in handler\n
> > > content_file.run()
> > > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler
> _handler:
> > > File "/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py",
> > > line 190, in run\n    if "session" in code.co_names:
> > > [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler
> _handler:
> > > AttributeError: 'str' object has no attribute 'co_names' 
> > > 
> > > I haven't looked at the Python traceback bit yet, but the fact that
> malloc
> > > is complaining suggests that some sort of memory manipulation is
> > > wrong.
> > > 
> > > Graham
> > > 
> > > 
> > > dharana wrote ..
> > > > There where more typos. I think I've fixed them. I am now trying
> to
> > > > reproduce it in another machine. I'm starting to believe it must
> a
> > > > problem with my server setup what is causing the segfaults.
> > > > 
> > > > -------- Original Message --------
> > > > Subject: Re: [mod_python] psp.PSP(req, string='hello world') causes
> > segfault
> > > > Date: Wed, 27 Apr 2005 00:49:08 +0200
> > > > From: dharana <dharana@dharana.net>
> > > > To: dharana <dharana@dharana.net>
> > > > CC: Graham Dumpleton <grahamd@dscpl.com.au>,  mod_python list 
> > > > <mod_python@modpython.org>,  python-dev@httpd.apache.org
> > > > References: <426EB09B.60804@dharana.net> 
> > > > <cd668e4f1acb033939973727c751beb6@dscpl.com.au> 
> > > > <426EB7C7.4030307@dharana.net> 
> > > > <9f4387af79e092bc1b49d90c29633edc@dscpl.com.au> 
> > > > <426EC2D1.7080401@dharana.net>
> > > > 
> > > > There where 3 typos in psp.py. I could only fix them by temporarily
> > > > commenting out the _psp.parsestring call. I leave to you the C side
> > :)
> > > > 
> > > > I've included the patch file with the typos fixed. Hope it helps.
> I'm
> > > > also forwarding to python-dev because I believe I've crossed the
> line
> > > again.
> > > > 
> > > > -----------------------------------------------------------------------
> > > > --- /usr/src/mod_python-3.1.4/lib/python/mod_python/psp.py      Sat
> > Jan
> > > > 29 22:25:29 2005
> > > > +++ /usr/local/hosting/lib/python2.4/site-packages/mod_python/psp.py
> > > > Wed Apr 27 00:43:06 2005
> > > > @@ -111,12 +111,12 @@
> > > >               self.load_from_file()
> > > >           else:
> > > > 
> > > > -            cached = strcache.get(string)
> > > > +            cached = mem_scache.get(string)
> > > >               if cached:
> > > >                   self.code = cached
> > > >               else:
> > > >                   self.code = _psp.parsestring(string)
> > > > -                strcache.store(string)
> > > > +                mem_scache.store(string, self.code)
> > > > 
> > > >       def cache_get(self, filename, mtime):
> > > > 
> > > > @@ -358,8 +358,8 @@
> > > > 
> > > >       def get(self, key):
> > > >           if self.cache.has_key(key):
> > > > -            hist, val = self.cache[key]
> > > > -            self.cache[key] = (hits+1, code)
> > > > +            hits, val = self.cache[key]
> > > > +            self.cache[key] = (hits+1, val)
> > > >               return val
> > > >           else:
> > > >               return None
> > > > -----------------------------------------------------------------------
> > > > 
> > > > -- 
> > > > dharana
> > > _______________________________________________
> > > Mod_python mailing list
> > > Mod_python@modpython.org
> > > http://mailman.modpython.org/mailman/listinfo/mod_python
> > _______________________________________________
> > Mod_python mailing list
> > Mod_python@modpython.org
> > http://mailman.modpython.org/mailman/listinfo/mod_python
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
From gdamjan at mail.net.mk  Tue Apr 26 22:47:11 2005
From: gdamjan at mail.net.mk (Damjan)
Date: Tue Apr 26 22:47:16 2005
Subject: [mod_python] psp.PSP(req,string='hello world') causessegfault]
In-Reply-To: <1114565802.2991@dscpl.user.openhosting.com>
References: <1114565802.2991@dscpl.user.openhosting.com>
Message-ID: <20050427024711.GA1664@legolas.on.net.mk>

> I have put all the code changes together under the bug report:
> 
>   http://issues.apache.org/jira/browse/MODPYTHON-48
> 
> Links have been included back to some of the mailing list
> messages for context.
> 
> If this doesn't solve everything let us know.

Aren't *unified* diff's the norm ussually? ... I have some problems
applying your patch:
$ patch -p2 < ~/psp.diff
patching file lib/python/mod_python/psp.py
missing header for context diff at line 54 of patch
patching file src/_pspmodule.c


-- 
damjan | ??????
This is my jabber ID --> damjan@bagra.net.mk <-- not my mail address!!!
From grisha at modpython.org  Tue Apr 26 23:04:09 2005
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Tue Apr 26 23:04:25 2005
Subject: [Fwd: Re: [mod_python] psp.PSP(req, string='hello world')
	causessegfault]
In-Reply-To: <1114563730.18428@dscpl.user.openhosting.com>
References: <1114563730.18428@dscpl.user.openhosting.com>
Message-ID: <20050426230229.K86583@grisha.dyndns.org>


On Tue, 26 Apr 2005, Graham Dumpleton wrote:

> The code in PSP constructor where code is first put in cache should be:
>
>            cached = mem_scache.get(string)
>            if cached:
>                self.code = cached
>            else:
>                source = _psp.parsestring(string)
>                code = compile(source, "__psp__", "exec")
>                mem_scache.store(string,code)
>                self.code = code
>
> Ie., code wasn't actually being compiled. Not sure what should be put
> for second argument. It only gets displayed in error messages according
> to documentation. Normally it would be the name of the module, but
> there isn't one here.

Something like "psp_parsestring" or even "psp parsestring" (dunno if 
spaces are allowed) is probably going to be more descriptive.

Just my $0.02

Grisha
From grahamd at dscpl.com.au  Tue Apr 26 23:11:52 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Apr 26 23:11:56 2005
Subject: [mod_python] psp.PSP(req,string='hello world') causessegfault]
Message-ID: <1114571512.17229@dscpl.user.openhosting.com>

Damjan wrote ..
> > I have put all the code changes together under the bug report:
> > 
> >   http://issues.apache.org/jira/browse/MODPYTHON-48
> > 
> > Links have been included back to some of the mailing list
> > messages for context.
> > 
> > If this doesn't solve everything let us know.
> 
> Aren't *unified* diff's the norm ussually? ... I have some problems
> applying your patch:
> $ patch -p2 < ~/psp.diff
> patching file lib/python/mod_python/psp.py
> missing header for context diff at line 54 of patch
> patching file src/_pspmodule.c

I used context diff because I feel it is easier for a person who is
manually trying to incorporate changes to see the difference.

I would suggest that you are a very rare person in as much as you
actually know what the "patch" program is. ;-)

Anyway, I can't explain why it isn't working. Even when I generate
a unified diff for that file in a distinct file, patch still dies.

/usr/local/src/mod_python-3.1.3 [597]$ patch -p2 --dry-run < ~/psp-3.diff 
missing header for unified diff at line 3 of patch
patching file src/_pspmodule.c                                                  

The unified diff it you want to try it is:

--- ../mod_python-3.1.3/src/_pspmodule.c        Tue Feb 17 06:47:27 2004
+++ src/_pspmodule.c    Wed Apr 27 10:43:51 2005
@@ -146,7 +146,7 @@
     bs = yy_scan_string(PyString_AsString(str), scanner);
     yylex(scanner);

-    yy_delete_buffer(bs, scanner);
+    /* yy_delete_buffer(bs, scanner); */
     yylex_destroy(scanner);

     psp_string_0(&parser->pycode); 

From hu.007 at 163.com  Wed Apr 27 02:56:57 2005
From: hu.007 at 163.com (Xingyang Hu)
Date: Wed Apr 27 02:57:07 2005
Subject: [mod_python] i have solved the session problem: initializatin
	failes - unsubscriptable object
Message-ID: <200504270657.j3R6uxlx027932@modpython.org>

mod_python,

	
	Thank Nicolas and Graham!
	The solution(I use the one Nicolas gives) is: 

======= 2005-04-27 05:28:47 =======

>Adding that the reason is that you have specified the original  
>PythonHandler
>definition outside of any <Directory> directive in your configuration  
>file.
>
>Quote from previous bug report from this for more detail:
>
>  The problem is caused by the way you have set up the Apache config  
>file.
>
>  If you do not specify AddHander/PythonHandler outside of a Directory
>  directive it will work okay.
>
>  Ie., use:
>
>  # Enable debug under /psp directory
>  <Directory /var/www/html/psp>
>  AddHandler mod_python .psp
>  AddHandler mod_python .psp_
>  PythonHandler mod_python.psp
>  PythonDebug On
>  </Directory>
>
>  If you specify AddHandler outside of the a Directory directive, when  
>doing:
>
>    dirpath = self._req.hlist.directory
>
>  the dirpath variable will be set to None, which then cannot be indexed.
>
>  The Session code should possibly check for this strange case, noting  
>though
>  that what you did in the first place is probably not recommended and  
>could
>  break other things as well.
>
>The previous case was for PSP, but same thing if you use publisher  
>handlers.
>
>As Nicolas indicated, you can also set ApplicationPath explicitly if  
>for some
>reason you can't do things inside of a <Directory> directive.
>
>On 27/04/2005, at 6:36 AM, Nicolas Lehuen wrote:
>
>> Hi,
>>
>> If you have the same problem, then the same solution applies. Just add
>> a line in your httpd.conf or .htaccess file containing :
>>
>> PythonOption ApplicationPath '/'
>>
>> Regards,
>> Nicolas
>>
>> On 4/26/05,  <hu.007@163.com> wrote:
>>> Hello!
>>>
>>>         How to solve this problem? I have the same.
>>>         mine: FreeBSD5.4rc3 + apache2.0.53 + python2.3 +  
>>> mod_python3.1.4.
>>>          
>>> http://www.modpython.org/pipermail/mod_python/2005-January/ 
>>> 017113.html
>>>
>>> Thanks!
>>>
>>> _______________________________________________
>>> Mod_python mailing list
>>> Mod_python@modpython.org
>>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>>
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>
>

= = = = = = = = = = = = = = = = = = = =
			



 
				 
Xingyang Hu
hu.007@163.com
2005-04-27


From huzaifa at hostway.com  Wed Apr 27 15:27:45 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Wed Apr 27 15:27:51 2005
Subject: [mod_python] SSL Socket Problem
In-Reply-To: <016c01c5460f$bb43e590$0300a8c0@Dan>
References: <4266A5DD.7000102@hostway.com> <016c01c5460f$bb43e590$0300a8c0@Dan>
Message-ID: <426FE7B1.2090102@hostway.com>

Hello Dan,

I have been doing some research and we checked tcpdump and netstats 
while the error is happening and there are no socket connections open.  
Is there a thread safety issue in httplib and socket?  What concerns me 
is that the ssl() method in socket.py is at the global level meaning 
that the somehow the sockets are being changed by multiple threads.

hozi

Dan Nelson wrote:

> If it's working for a while and then you get an error, perhaps it has 
> something to do with apache reaching some limit, queueing/caching, too 
> many threads, too many sockets...  That might be a place to start 
> looking.
>
> Dan
>
>
> ----- Original Message ----- From: "Huzaifa Tapal" <huzaifa@hostway.com>
> To: <mod_python@modpython.org>
> Sent: Thursday, 21 April, 2005 2:56 AM
> Subject: [mod_python] SSL Socket Problem
>
>
>> Hello All,
>>
>> I am having a problem with making SSL socket connections in my 
>> mod_python application running with python 2.3.5.  The error I keep 
>> getting back is "TypeError: ssl() argument 1 must be _socket.socket, 
>> not _socketobject". What is odd is that if I restart the apache2 web 
>> server, the error goes away and all the calls return back with a 
>> message.  However, after about 20 or so minutes we start getting this 
>> error almost instantaneously without any kind of message going out at 
>> all.
>>
>> Here is the full traceback:
>>
>>         con.endheaders()
>>        File "/usr/lib/python2.3/httplib.py", line 715, in endheaders
>>         self._send_output()
>>        File "/usr/lib/python2.3/httplib.py", line 600, in _send_output
>>         self.send(msg)
>>        File "/usr/lib/python2.3/httplib.py", line 567, in send
>>         self.connect()
>>        File "/usr/lib/python2.3/httplib.py", line 988, in connect
>>         ssl = socket.ssl(sock, self.key_file, self.cert_file)
>>        File "/usr/lib/python2.3/socket.py", line 73, in ssl
>>         return _realssl(sock, keyfile, certfile)
>>     TypeError: ssl() argument 1 must be _socket.socket, not 
>> _socketobject
>>
>> I have the same application running on another machine with python 
>> 2.3.4 and I can't replicate it in there.  Do you guys know of any 
>> known issues with sockets and ssl with python 2.3.5?
>>
>> Any help would be appreciated.
>>
>> Hozi
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>
>

From huzaifa at hostway.com  Wed Apr 27 15:43:43 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Wed Apr 27 15:43:49 2005
Subject: [mod_python] SSL Socket Problem
In-Reply-To: <426FE7B1.2090102@hostway.com>
References: <4266A5DD.7000102@hostway.com> <016c01c5460f$bb43e590$0300a8c0@Dan>
	<426FE7B1.2090102@hostway.com>
Message-ID: <426FEB6F.3090000@hostway.com>

Also, addiitional information from my research.  Here is the where the 
error is generated:

    def connect(self):
        "Connect to a host on a given (SSL) port."

        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((self.host, self.port))
        ssl = socket.ssl(sock, self.key_file, self.cert_file)
        self.sock = FakeSocket(sock, ssl)

based on the error and tcpdump, the socket is created fine, the 
connection is using the socket is made fine, the error occurs on calling 
ssl() method of the socket class.

    def ssl(sock, keyfile=None, certfile=None):
        if hasattr(sock, "_sock"):
            sock = sock._sock
        return _realssl(sock, keyfile, certfile)

above is what the ssl method on the modular level looks like.  The funny 
part is that the _sock attribute on the sock object has to be _sock.sock 
in order for connect() to work.  And we know that works since I see 
tcpdump connections being made without a problem.  Whats wierd is that 
when the sock object is passed to the ssl() method, that is when it 
somehow gets corrupted and the _sock attribute turns from _sock.sock 
type to _sockobject() type.

Hozi



Huzaifa Tapal wrote:

> Hello Dan,
>
> I have been doing some research and we checked tcpdump and netstats 
> while the error is happening and there are no socket connections 
> open.  Is there a thread safety issue in httplib and socket?  What 
> concerns me is that the ssl() method in socket.py is at the global 
> level meaning that the somehow the sockets are being changed by 
> multiple threads.
>
> hozi
>
> Dan Nelson wrote:
>
>> If it's working for a while and then you get an error, perhaps it has 
>> something to do with apache reaching some limit, queueing/caching, 
>> too many threads, too many sockets...  That might be a place to start 
>> looking.
>>
>> Dan
>>
>>
>> ----- Original Message ----- From: "Huzaifa Tapal" <huzaifa@hostway.com>
>> To: <mod_python@modpython.org>
>> Sent: Thursday, 21 April, 2005 2:56 AM
>> Subject: [mod_python] SSL Socket Problem
>>
>>
>>> Hello All,
>>>
>>> I am having a problem with making SSL socket connections in my 
>>> mod_python application running with python 2.3.5.  The error I keep 
>>> getting back is "TypeError: ssl() argument 1 must be _socket.socket, 
>>> not _socketobject". What is odd is that if I restart the apache2 web 
>>> server, the error goes away and all the calls return back with a 
>>> message.  However, after about 20 or so minutes we start getting 
>>> this error almost instantaneously without any kind of message going 
>>> out at all.
>>>
>>> Here is the full traceback:
>>>
>>>         con.endheaders()
>>>        File "/usr/lib/python2.3/httplib.py", line 715, in endheaders
>>>         self._send_output()
>>>        File "/usr/lib/python2.3/httplib.py", line 600, in _send_output
>>>         self.send(msg)
>>>        File "/usr/lib/python2.3/httplib.py", line 567, in send
>>>         self.connect()
>>>        File "/usr/lib/python2.3/httplib.py", line 988, in connect
>>>         ssl = socket.ssl(sock, self.key_file, self.cert_file)
>>>        File "/usr/lib/python2.3/socket.py", line 73, in ssl
>>>         return _realssl(sock, keyfile, certfile)
>>>     TypeError: ssl() argument 1 must be _socket.socket, not 
>>> _socketobject
>>>
>>> I have the same application running on another machine with python 
>>> 2.3.4 and I can't replicate it in there.  Do you guys know of any 
>>> known issues with sockets and ssl with python 2.3.5?
>>>
>>> Any help would be appreciated.
>>>
>>> Hozi
>>>
>>> _______________________________________________
>>> Mod_python mailing list
>>> Mod_python@modpython.org
>>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>>
>>
>>
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
>

From huzaifa at hostway.com  Thu Apr 28 18:22:16 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Thu Apr 28 18:22:28 2005
Subject: [mod_python] bug in apache.import_module
Message-ID: <42716218.407@hostway.com>

I think there is a bug in apache.import_module.  I am using 
apache.import_module passing in the path where I want the module 
imported from.  I am seeing a very odd result as to sometimes, the 
module that is loaded is not the right one.  Instead it loads a module 
that is of the same name but in a different directory.  Here is what is 
happening:

I have two modules of same name in 2 different directories as follows;

/home/user/dir1/moduleA
/home/user/dir123/moduleB

Lets say I restart apache and load up moduleA.  At that point there is 
an entry in sys.modules for moduleA.  Lets say then, I load up moduleB, 
now the original entry for moduleA is overwritten by this new entry.  
Now when I go back to load moduleA, I get back moduleB results. Here is why:

In apache.import_module if I pass in the path to load moduleA from 
'/home/user/dir1' and the last module was in '/home/user/dir123' then 
the check in import_module to make sure both modules aren't the same 
fails since it does a "file.startswith()" check on the path.  Since the 
path moduleA is in the path to moduleB, it loads the wrong module.

I see that somebody else had complained about this problem in mod_python 
1.3.1 but it still has not been patched.

Any ideas?

Hozi


From grahamd at dscpl.com.au  Thu Apr 28 18:35:14 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr 28 18:35:23 2005
Subject: [mod_python] bug in apache.import_module
In-Reply-To: <42716218.407@hostway.com>
References: <42716218.407@hostway.com>
Message-ID: <26af1568be4a496653c3e0ceec64c26f@dscpl.com.au>

See:

   http://issues.apache.org/jira/browse/MODPYTHON-9
   http://issues.apache.org/jira/browse/MODPYTHON-10
   http://issues.apache.org/jira/browse/MODPYTHON-11

There are various known issues with using same name module in different
directories.

The first one has been addressed for next version of mod_python.

Graham

On 29/04/2005, at 8:22 AM, Huzaifa Tapal wrote:

> I think there is a bug in apache.import_module.  I am using 
> apache.import_module passing in the path where I want the module 
> imported from.  I am seeing a very odd result as to sometimes, the 
> module that is loaded is not the right one.  Instead it loads a module 
> that is of the same name but in a different directory.  Here is what 
> is happening:
>
> I have two modules of same name in 2 different directories as follows;
>
> /home/user/dir1/moduleA
> /home/user/dir123/moduleB
>
> Lets say I restart apache and load up moduleA.  At that point there is 
> an entry in sys.modules for moduleA.  Lets say then, I load up 
> moduleB, now the original entry for moduleA is overwritten by this new 
> entry.  Now when I go back to load moduleA, I get back moduleB 
> results. Here is why:
>
> In apache.import_module if I pass in the path to load moduleA from 
> '/home/user/dir1' and the last module was in '/home/user/dir123' then 
> the check in import_module to make sure both modules aren't the same 
> fails since it does a "file.startswith()" check on the path.  Since 
> the path moduleA is in the path to moduleB, it loads the wrong module.
>
> I see that somebody else had complained about this problem in 
> mod_python 1.3.1 but it still has not been patched.
>
> Any ideas?
>
> Hozi
>
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From huzaifa at hostway.com  Thu Apr 28 19:02:43 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Thu Apr 28 19:02:55 2005
Subject: [mod_python] bug in apache.import_module
In-Reply-To: <26af1568be4a496653c3e0ceec64c26f@dscpl.com.au>
References: <42716218.407@hostway.com>
	<26af1568be4a496653c3e0ceec64c26f@dscpl.com.au>
Message-ID: <42716B93.1090003@hostway.com>

For my fix, I patched this issue by passing the import_module function 
the path with "/" in the end.  That way it distinguishes from 
/home/user/dir1 and /home/user/dir123

hozi

Graham Dumpleton wrote:

> See:
>
>   http://issues.apache.org/jira/browse/MODPYTHON-9
>   http://issues.apache.org/jira/browse/MODPYTHON-10
>   http://issues.apache.org/jira/browse/MODPYTHON-11
>
> There are various known issues with using same name module in different
> directories.
>
> The first one has been addressed for next version of mod_python.
>
> Graham
>
> On 29/04/2005, at 8:22 AM, Huzaifa Tapal wrote:
>
>> I think there is a bug in apache.import_module.  I am using 
>> apache.import_module passing in the path where I want the module 
>> imported from.  I am seeing a very odd result as to sometimes, the 
>> module that is loaded is not the right one.  Instead it loads a 
>> module that is of the same name but in a different directory.  Here 
>> is what is happening:
>>
>> I have two modules of same name in 2 different directories as follows;
>>
>> /home/user/dir1/moduleA
>> /home/user/dir123/moduleB
>>
>> Lets say I restart apache and load up moduleA.  At that point there 
>> is an entry in sys.modules for moduleA.  Lets say then, I load up 
>> moduleB, now the original entry for moduleA is overwritten by this 
>> new entry.  Now when I go back to load moduleA, I get back moduleB 
>> results. Here is why:
>>
>> In apache.import_module if I pass in the path to load moduleA from 
>> '/home/user/dir1' and the last module was in '/home/user/dir123' then 
>> the check in import_module to make sure both modules aren't the same 
>> fails since it does a "file.startswith()" check on the path.  Since 
>> the path moduleA is in the path to moduleB, it loads the wrong module.
>>
>> I see that somebody else had complained about this problem in 
>> mod_python 1.3.1 but it still has not been patched.
>>
>> Any ideas?
>>
>> Hozi
>>
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>
>
>

From grahamd at dscpl.com.au  Thu Apr 28 19:44:42 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Apr 28 19:44:44 2005
Subject: [mod_python] bug in apache.import_module
Message-ID: <1114731882.7600@dscpl.user.openhosting.com>

Nicolas, does the change you have already made for MODPYTHON-9
also address this slightly different variation on the problem?

Original report was based on same name module in parent and child
subdirectories, not sibling directories which share a common prefix
to the subdirectory name.

Graham

Huzaifa Tapal wrote ..
> For my fix, I patched this issue by passing the import_module function
> the path with "/" in the end.  That way it distinguishes from 
> /home/user/dir1 and /home/user/dir123
> 
> hozi
> 
> Graham Dumpleton wrote:
> 
> > See:
> >
> >   http://issues.apache.org/jira/browse/MODPYTHON-9
> >   http://issues.apache.org/jira/browse/MODPYTHON-10
> >   http://issues.apache.org/jira/browse/MODPYTHON-11
> >
> > There are various known issues with using same name module in different
> > directories.
> >
> > The first one has been addressed for next version of mod_python.
> >
> > Graham
> >
> > On 29/04/2005, at 8:22 AM, Huzaifa Tapal wrote:
> >
> >> I think there is a bug in apache.import_module.  I am using 
> >> apache.import_module passing in the path where I want the module 
> >> imported from.  I am seeing a very odd result as to sometimes, the 
> >> module that is loaded is not the right one.  Instead it loads a 
> >> module that is of the same name but in a different directory.  Here
> >> is what is happening:
> >>
> >> I have two modules of same name in 2 different directories as follows;
> >>
> >> /home/user/dir1/moduleA
> >> /home/user/dir123/moduleB
> >>
> >> Lets say I restart apache and load up moduleA.  At that point there
> >> is an entry in sys.modules for moduleA.  Lets say then, I load up 
> >> moduleB, now the original entry for moduleA is overwritten by this 
> >> new entry.  Now when I go back to load moduleA, I get back moduleB 
> >> results. Here is why:
> >>
> >> In apache.import_module if I pass in the path to load moduleA from 
> >> '/home/user/dir1' and the last module was in '/home/user/dir123' then
> >> the check in import_module to make sure both modules aren't the same
> >> fails since it does a "file.startswith()" check on the path.  Since
> >> the path moduleA is in the path to moduleB, it loads the wrong module.
> >>
> >> I see that somebody else had complained about this problem in 
> >> mod_python 1.3.1 but it still has not been patched.
> >>
> >> Any ideas?
> >>
> >> Hozi
> >>
> >>
> >> _______________________________________________
> >> Mod_python mailing list
> >> Mod_python@modpython.org
> >> http://mailman.modpython.org/mailman/listinfo/mod_python
> >
> >
> >
From nicolas.lehuen at gmail.com  Fri Apr 29 04:33:53 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Fri Apr 29 04:33:55 2005
Subject: [mod_python] bug in apache.import_module
In-Reply-To: <1114731882.7600@dscpl.user.openhosting.com>
References: <1114731882.7600@dscpl.user.openhosting.com>
Message-ID: <c298f2d705042901333282aa30@mail.gmail.com>

Sorry, reposting to the whole list :

Hi,

The change I've made for MODPYTHON-9 affects only the publisher
module. It solves the problem encountered when you had two pages, one
at /index.py, and the other at /foobar/index.py.

Huzaifa, what I don't understand here is whether moduleA has the same
name as moduleB, and whether you are using mod_python.publisher or
not.

If you use the publisher, your problem has been solved in the latest
development version, and the fix will be in the next release.

Anyway, if we put aside the fix specific to the publisher, the problem
you describe is real, and the workaround you provide is correct.

It is so correct that the only way I see of fixing that is to
integrate the workaround in the import_module function, that is to say
to check whether each path component passed in the path list argument
ends with a '/' (or '\'), and if not, add a '/' (or '\\'). This is
done easily in the first line of the function :

if path:
   path = map(lambda entry : (entry[-1]!='/' and entry+'/') or entry,path)

However, there is no easy way of telling what directory separator
should be used ; theoretically, os.sep gives us the correct directory
separator, but even under Win32 Apache admins are advised to use "/"
which is compatible (at the OS level). So, we might as well always use
"/".

What I fear is that adding all these checks to import_module will make
it a little bit too slow, so what about adding a line or two in the
documentation about the fact that all directories mentioned in the
path argument should end with a '/' ?

Regards,

Nicolas

On 4/29/05, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> Nicolas, does the change you have already made for MODPYTHON-9
> also address this slightly different variation on the problem?
> 
> Original report was based on same name module in parent and child
> subdirectories, not sibling directories which share a common prefix
> to the subdirectory name.
> 
> Graham
> 
> Huzaifa Tapal wrote ..
> > For my fix, I patched this issue by passing the import_module function
> > the path with "/" in the end.  That way it distinguishes from
> > /home/user/dir1 and /home/user/dir123
> >
> > hozi
> >
> > Graham Dumpleton wrote:
> >
> > > See:
> > >
> > >   http://issues.apache.org/jira/browse/MODPYTHON-9
> > >   http://issues.apache.org/jira/browse/MODPYTHON-10
> > >   http://issues.apache.org/jira/browse/MODPYTHON-11
> > >
> > > There are various known issues with using same name module in different
> > > directories.
> > >
> > > The first one has been addressed for next version of mod_python.
> > >
> > > Graham
> > >
> > > On 29/04/2005, at 8:22 AM, Huzaifa Tapal wrote:
> > >
> > >> I think there is a bug in apache.import_module.  I am using
> > >> apache.import_module passing in the path where I want the module
> > >> imported from.  I am seeing a very odd result as to sometimes, the
> > >> module that is loaded is not the right one.  Instead it loads a
> > >> module that is of the same name but in a different directory.  Here
> > >> is what is happening:
> > >>
> > >> I have two modules of same name in 2 different directories as follows;
> > >>
> > >> /home/user/dir1/moduleA
> > >> /home/user/dir123/moduleB
> > >>
> > >> Lets say I restart apache and load up moduleA.  At that point there
> > >> is an entry in sys.modules for moduleA.  Lets say then, I load up
> > >> moduleB, now the original entry for moduleA is overwritten by this
> > >> new entry.  Now when I go back to load moduleA, I get back moduleB
> > >> results. Here is why:
> > >>
> > >> In apache.import_module if I pass in the path to load moduleA from
> > >> '/home/user/dir1' and the last module was in '/home/user/dir123' then
> > >> the check in import_module to make sure both modules aren't the same
> > >> fails since it does a "file.startswith()" check on the path.  Since
> > >> the path moduleA is in the path to moduleB, it loads the wrong module.
> > >>
> > >> I see that somebody else had complained about this problem in
> > >> mod_python 1.3.1 but it still has not been patched.
> > >>
> > >> Any ideas?
> > >>
> > >> Hozi
> > >>
> > >>
> > >> _______________________________________________
> > >> Mod_python mailing list
> > >> Mod_python@modpython.org
> > >> http://mailman.modpython.org/mailman/listinfo/mod_python
> > >
> > >
> > >
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>

From grisha at modpython.org  Fri Apr 29 10:25:39 2005
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Fri Apr 29 10:25:54 2005
Subject: [mod_python] bug in apache.import_module
In-Reply-To: <c298f2d705042901333282aa30@mail.gmail.com>
References: <1114731882.7600@dscpl.user.openhosting.com>
	<c298f2d705042901333282aa30@mail.gmail.com>
Message-ID: <20050429102316.M22740@grisha.dyndns.org>


On Fri, 29 Apr 2005, Nicolas Lehuen wrote:

> It is so correct that the only way I see of fixing that is to
> integrate the workaround in the import_module function, that is to say
> to check whether each path component passed in the path list argument
> ends with a '/' (or '\'), and if not, add a '/' (or '\\'). This is
> done easily in the first line of the function :

I seem to remember the SLASH constant being removed and I was wondering 
why it might have been there... _this_ may have been the reason actually, 
because I vaguely remember this issue being already reported and fixed 
long long ago :-)

The point is - when we fix this, we better comment this in the code very 
well.

Grisha
From huzaifa at hostway.com  Fri Apr 29 13:35:49 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Fri Apr 29 13:35:57 2005
Subject: [mod_python] bug in apache.import_module
In-Reply-To: <c298f2d705042901333282aa30@mail.gmail.com>
References: <1114731882.7600@dscpl.user.openhosting.com>
	<c298f2d705042901333282aa30@mail.gmail.com>
Message-ID: <42727075.3010802@hostway.com>

Hello Nicolas,

Sorry for not clearing it up about my problem.  Actually, I have my own 
handler that I integrated into a web application framework we built 
in-house.  And yes both moduleA and moduleB are of the same name.  So 
really, the scenario is as follows:

/home/user/dir1/moduleA
/home/userdir123/moduleA

Since, this only happens in cases where there are two modules with the 
same name and the path to the first module happens to be in the path to 
the second module because of the similarities in the name of the two 
directories, I think it would be safe to add this to the documentation 
instead of slowing import_module.   It would also make sense to mention 
it in the comments for import_module as well.

Thanks for your help

Hozi



Nicolas Lehuen wrote:

>Sorry, reposting to the whole list :
>
>Hi,
>
>The change I've made for MODPYTHON-9 affects only the publisher
>module. It solves the problem encountered when you had two pages, one
>at /index.py, and the other at /foobar/index.py.
>
>Huzaifa, what I don't understand here is whether moduleA has the same
>name as moduleB, and whether you are using mod_python.publisher or
>not.
>
>If you use the publisher, your problem has been solved in the latest
>development version, and the fix will be in the next release.
>
>Anyway, if we put aside the fix specific to the publisher, the problem
>you describe is real, and the workaround you provide is correct.
>
>It is so correct that the only way I see of fixing that is to
>integrate the workaround in the import_module function, that is to say
>to check whether each path component passed in the path list argument
>ends with a '/' (or '\'), and if not, add a '/' (or '\\'). This is
>done easily in the first line of the function :
>
>if path:
>   path = map(lambda entry : (entry[-1]!='/' and entry+'/') or entry,path)
>
>However, there is no easy way of telling what directory separator
>should be used ; theoretically, os.sep gives us the correct directory
>separator, but even under Win32 Apache admins are advised to use "/"
>which is compatible (at the OS level). So, we might as well always use
>"/".
>
>What I fear is that adding all these checks to import_module will make
>it a little bit too slow, so what about adding a line or two in the
>documentation about the fact that all directories mentioned in the
>path argument should end with a '/' ?
>
>Regards,
>
>Nicolas
>
>On 4/29/05, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>  
>
>>Nicolas, does the change you have already made for MODPYTHON-9
>>also address this slightly different variation on the problem?
>>
>>Original report was based on same name module in parent and child
>>subdirectories, not sibling directories which share a common prefix
>>to the subdirectory name.
>>
>>Graham
>>
>>Huzaifa Tapal wrote ..
>>    
>>
>>>For my fix, I patched this issue by passing the import_module function
>>>the path with "/" in the end.  That way it distinguishes from
>>>/home/user/dir1 and /home/user/dir123
>>>
>>>hozi
>>>
>>>Graham Dumpleton wrote:
>>>
>>>      
>>>
>>>>See:
>>>>
>>>>  http://issues.apache.org/jira/browse/MODPYTHON-9
>>>>  http://issues.apache.org/jira/browse/MODPYTHON-10
>>>>  http://issues.apache.org/jira/browse/MODPYTHON-11
>>>>
>>>>There are various known issues with using same name module in different
>>>>directories.
>>>>
>>>>The first one has been addressed for next version of mod_python.
>>>>
>>>>Graham
>>>>
>>>>On 29/04/2005, at 8:22 AM, Huzaifa Tapal wrote:
>>>>
>>>>        
>>>>
>>>>>I think there is a bug in apache.import_module.  I am using
>>>>>apache.import_module passing in the path where I want the module
>>>>>imported from.  I am seeing a very odd result as to sometimes, the
>>>>>module that is loaded is not the right one.  Instead it loads a
>>>>>module that is of the same name but in a different directory.  Here
>>>>>is what is happening:
>>>>>
>>>>>I have two modules of same name in 2 different directories as follows;
>>>>>
>>>>>/home/user/dir1/moduleA
>>>>>/home/user/dir123/moduleB
>>>>>
>>>>>Lets say I restart apache and load up moduleA.  At that point there
>>>>>is an entry in sys.modules for moduleA.  Lets say then, I load up
>>>>>moduleB, now the original entry for moduleA is overwritten by this
>>>>>new entry.  Now when I go back to load moduleA, I get back moduleB
>>>>>results. Here is why:
>>>>>
>>>>>In apache.import_module if I pass in the path to load moduleA from
>>>>>'/home/user/dir1' and the last module was in '/home/user/dir123' then
>>>>>the check in import_module to make sure both modules aren't the same
>>>>>fails since it does a "file.startswith()" check on the path.  Since
>>>>>the path moduleA is in the path to moduleB, it loads the wrong module.
>>>>>
>>>>>I see that somebody else had complained about this problem in
>>>>>mod_python 1.3.1 but it still has not been patched.
>>>>>
>>>>>Any ideas?
>>>>>
>>>>>Hozi
>>>>>
>>>>>
>>>>>_______________________________________________
>>>>>Mod_python mailing list
>>>>>Mod_python@modpython.org
>>>>>http://mailman.modpython.org/mailman/listinfo/mod_python
>>>>>          
>>>>>
>>>>
>>>>        
>>>>
>>_______________________________________________
>>Mod_python mailing list
>>Mod_python@modpython.org
>>http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>>    
>>
>
>_______________________________________________
>Mod_python mailing list
>Mod_python@modpython.org
>http://mailman.modpython.org/mailman/listinfo/mod_python
>
>
>  
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050429/bc7c45ba/attachment.html
From huzaifa at hostway.com  Fri Apr 29 15:58:03 2005
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Fri Apr 29 15:58:13 2005
Subject: [mod_python] bug in apache.import_module
In-Reply-To: <c298f2d705042901333282aa30@mail.gmail.com>
References: <1114731882.7600@dscpl.user.openhosting.com>
	<c298f2d705042901333282aa30@mail.gmail.com>
Message-ID: <427291CB.7010308@hostway.com>

I wanted to ask for a piece of advise.  So the fix that I have 
mentioned, I moved that fix (the method I replaced with the map(lambda) 
solution you had with a minor fix) to another "SharedResources" module 
that I import in my framework's handler.  From within the handler and my 
app, I am call that method passing in a path argument that it *fixes* 
and returns back the results.  Here is what the new method looks like:

def fix_paths( path ):
    """ Convenience method for checking and
    adding '/' to the end of paths for compatibility
    with mod_python's import_module. """

    _lock.acquire()
    try:
        if path and type(path) == type([]):
            path = map(lambda entry : (entry!='' and entry[-1]!='/' and 
entry+'/') or entry,path)

        return path
    finally:
        _lock.release()

Should I have the thread-locking in place or can I get by without having 
it in place?  The reason I did add that was because the path value may 
get changed, in the process, I thought of making this method thread-safe.

Also Nicolas, if you notice I added another check in your lambda 
function to check if the entry is an empty string.  If that wasn't there 
then if an empty string path was passed in the list paths, the function 
would break.  Thought, i'd let you know if you were gonna add this 
functionality into the import_module method for apache.py

Thanks

Hozi

Nicolas Lehuen wrote:

>Sorry, reposting to the whole list :
>
>Hi,
>
>The change I've made for MODPYTHON-9 affects only the publisher
>module. It solves the problem encountered when you had two pages, one
>at /index.py, and the other at /foobar/index.py.
>
>Huzaifa, what I don't understand here is whether moduleA has the same
>name as moduleB, and whether you are using mod_python.publisher or
>not.
>
>If you use the publisher, your problem has been solved in the latest
>development version, and the fix will be in the next release.
>
>Anyway, if we put aside the fix specific to the publisher, the problem
>you describe is real, and the workaround you provide is correct.
>
>It is so correct that the only way I see of fixing that is to
>integrate the workaround in the import_module function, that is to say
>to check whether each path component passed in the path list argument
>ends with a '/' (or '\'), and if not, add a '/' (or '\\'). This is
>done easily in the first line of the function :
>
>if path:
>   path = map(lambda entry : (entry[-1]!='/' and entry+'/') or entry,path)
>
>However, there is no easy way of telling what directory separator
>should be used ; theoretically, os.sep gives us the correct directory
>separator, but even under Win32 Apache admins are advised to use "/"
>which is compatible (at the OS level). So, we might as well always use
>"/".
>
>What I fear is that adding all these checks to import_module will make
>it a little bit too slow, so what about adding a line or two in the
>documentation about the fact that all directories mentioned in the
>path argument should end with a '/' ?
>
>Regards,
>
>Nicolas
>
>On 4/29/05, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>  
>
>>Nicolas, does the change you have already made for MODPYTHON-9
>>also address this slightly different variation on the problem?
>>
>>Original report was based on same name module in parent and child
>>subdirectories, not sibling directories which share a common prefix
>>to the subdirectory name.
>>
>>Graham
>>
>>Huzaifa Tapal wrote ..
>>    
>>
>>>For my fix, I patched this issue by passing the import_module function
>>>the path with "/" in the end.  That way it distinguishes from
>>>/home/user/dir1 and /home/user/dir123
>>>
>>>hozi
>>>
>>>Graham Dumpleton wrote:
>>>
>>>      
>>>
>>>>See:
>>>>
>>>>  http://issues.apache.org/jira/browse/MODPYTHON-9
>>>>  http://issues.apache.org/jira/browse/MODPYTHON-10
>>>>  http://issues.apache.org/jira/browse/MODPYTHON-11
>>>>
>>>>There are various known issues with using same name module in different
>>>>directories.
>>>>
>>>>The first one has been addressed for next version of mod_python.
>>>>
>>>>Graham
>>>>
>>>>On 29/04/2005, at 8:22 AM, Huzaifa Tapal wrote:
>>>>
>>>>        
>>>>
>>>>>I think there is a bug in apache.import_module.  I am using
>>>>>apache.import_module passing in the path where I want the module
>>>>>imported from.  I am seeing a very odd result as to sometimes, the
>>>>>module that is loaded is not the right one.  Instead it loads a
>>>>>module that is of the same name but in a different directory.  Here
>>>>>is what is happening:
>>>>>
>>>>>I have two modules of same name in 2 different directories as follows;
>>>>>
>>>>>/home/user/dir1/moduleA
>>>>>/home/user/dir123/moduleB
>>>>>
>>>>>Lets say I restart apache and load up moduleA.  At that point there
>>>>>is an entry in sys.modules for moduleA.  Lets say then, I load up
>>>>>moduleB, now the original entry for moduleA is overwritten by this
>>>>>new entry.  Now when I go back to load moduleA, I get back moduleB
>>>>>results. Here is why:
>>>>>
>>>>>In apache.import_module if I pass in the path to load moduleA from
>>>>>'/home/user/dir1' and the last module was in '/home/user/dir123' then
>>>>>the check in import_module to make sure both modules aren't the same
>>>>>fails since it does a "file.startswith()" check on the path.  Since
>>>>>the path moduleA is in the path to moduleB, it loads the wrong module.
>>>>>
>>>>>I see that somebody else had complained about this problem in
>>>>>mod_python 1.3.1 but it still has not been patched.
>>>>>
>>>>>Any ideas?
>>>>>
>>>>>Hozi
>>>>>
>>>>>
>>>>>_______________________________________________
>>>>>Mod_python mailing list
>>>>>Mod_python@modpython.org
>>>>>http://mailman.modpython.org/mailman/listinfo/mod_python
>>>>>          
>>>>>
>>>>
>>>>        
>>>>
>>_______________________________________________
>>Mod_python mailing list
>>Mod_python@modpython.org
>>http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>>    
>>
>
>_______________________________________________
>Mod_python mailing list
>Mod_python@modpython.org
>http://mailman.modpython.org/mailman/listinfo/mod_python
>
>
>  
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050429/979e07ea/attachment.html
From grahamd at dscpl.com.au  Fri Apr 29 18:20:07 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Fri Apr 29 18:20:29 2005
Subject: [mod_python] bug in apache.import_module
In-Reply-To: <20050429102316.M22740@grisha.dyndns.org>
References: <1114731882.7600@dscpl.user.openhosting.com>
	<c298f2d705042901333282aa30@mail.gmail.com>
	<20050429102316.M22740@grisha.dyndns.org>
Message-ID: <b84beca2902174736210ba03e6f10240@dscpl.com.au>


On 30/04/2005, at 12:25 AM, Gregory (Grisha) Trubetskoy wrote:

>
> On Fri, 29 Apr 2005, Nicolas Lehuen wrote:
>
>> It is so correct that the only way I see of fixing that is to
>> integrate the workaround in the import_module function, that is to say
>> to check whether each path component passed in the path list argument
>> ends with a '/' (or '\'), and if not, add a '/' (or '\\'). This is
>> done easily in the first line of the function :
>
> I seem to remember the SLASH constant being removed and I was 
> wondering why it might have been there... _this_ may have been the 
> reason actually, because I vaguely remember this issue being already 
> reported and fixed long long ago :-)
>
> The point is - when we fix this, we better comment this in the code 
> very well.

The change in the SLASH code is only in subversion repository and it is
probably likely person is using tar ball release code and thus wouldn't
have code with SLASH change in it anyway. My recollection also is that 
the
SLASH change is in code not connected with this. Anyway, I'll have a
bit of time today to look at this properly.

Graham

From graeme.matthew at contrado.com.au  Fri Apr 29 20:01:34 2005
From: graeme.matthew at contrado.com.au (Graeme Matthew)
Date: Fri Apr 29 20:01:43 2005
Subject: [mod_python] Raw HTTP Request
Message-ID: <4272CADE.5030304@contrado.com.au>

g'day everyone

Can someone please assist or offer some pointers.

I am wanting to get the raw content i.e entire http request as a string 
in mod_python.

The reason being is I want to have a central front controller that can 
accept CGI, SOAP and XMLRPC calls. To handle this I need the request 
content as a string so that I can dispatch to CGI or to an XML handler.

I have done some investigation and I am thinking that the way to go 
would be:

Get Content Length

then do  a

http_string  = request.read(content_length)

Then I can dispatch it to the appropriate controller where for example 
if it is a cgi request then I can simply perform 
cgi.parse_qs(http_string) and if a SOAP request do 
xmlsoap.process(http_string)


If content_type == "html":
    controller.process(http_string)
elif content_type == "xml":
    controller.process(http_string)
else:
    pass
    #handle invalid request type

Any assistance is appreciated


Graeme Matthew
Director
Contrado Solutions PTY LTD
email: graeme.matthew@contrado.com.au
mobile: 0400-872-879

From grahamd at dscpl.com.au  Sat Apr 30 00:53:26 2005
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Apr 30 00:53:36 2005
Subject: [mod_python] Raw HTTP Request
In-Reply-To: <4272CADE.5030304@contrado.com.au>
References: <4272CADE.5030304@contrado.com.au>
Message-ID: <d4cbe955377e1c07c6a90494fd83cd98@dscpl.com.au>


On 30/04/2005, at 10:01 AM, Graeme Matthew wrote:
> If content_type == "html":
>    controller.process(http_string)
> elif content_type == "xml":
>    controller.process(http_string)
> else:
>    pass
>    #handle invalid request type
>
> Any assistance is appreciated

FWIW, you would be better off having each on a different URL and select
based on URL rather than trying to have some magic switch based on what
the incoming content type is. Remember that both SOAP and XML-RPC are
incoming content type of "text/xml", so how are you going to know when
it is one or the other if everything comes in through the one URL.

Also, when you say CGI, do you really mean any GET/POST where form
parameters are being processed? There are better ways in mod_python
of doing things than using CGI style handlers.

Graham

From nicolas.lehuen at gmail.com  Sat Apr 30 01:03:50 2005
From: nicolas.lehuen at gmail.com (Nicolas Lehuen)
Date: Sat Apr 30 01:03:53 2005
Subject: [mod_python] bug in apache.import_module
In-Reply-To: <427291CB.7010308@hostway.com>
References: <1114731882.7600@dscpl.user.openhosting.com>
	<c298f2d705042901333282aa30@mail.gmail.com>
	<427291CB.7010308@hostway.com>
Message-ID: <c298f2d7050429220333ec2b6b@mail.gmail.com>

Hi Huzaifa,

Well, that's really up to you, especially since I don't understand
where the _lock variable comes from.

If it's not possible to change the path list which is passed as a
parameter without acquiring the lock, then why not, but I'd put the
locking mechanism in the calling code rather than in this function.
Note that you are not modifying the path list in-place : you just
return a copy of the path list with some fixes in it. So there is no
need to lock anything here, except if you fear that the path list will
be changed during the iteration, but for that, you have to put a
locking mechanism somewhere else for any modification of the path
list. So my first advice is : keep all locking code in the same place
and you'll save time and mental health :).

My second advice is : don't be over-protective at the cost of
performance. Trust the users of your code. Provided that they have a
proper documentation, it's not necessary to lock anything, because
your users will know that bad things will happen if they change the
path list during iteration, so they'll do the right stuff accordingly.
Likewise, it's not necessary to check whether path is a list, or
whether some path entries are None or "". If your users want to give
silly data to your function, let them do it, and let Python throw
exceptions at them.

Regards,

Nicolas

On 4/29/05, Huzaifa Tapal <huzaifa@hostway.com> wrote:
>  I wanted to ask for a piece of advise.  So the fix that I have mentioned, I
> moved that fix (the method I replaced with the map(lambda) solution you had
> with a minor fix) to another "SharedResources" module that I import in my
> framework's handler.  From within the handler and my app, I am call that
> method passing in a path argument that it *fixes* and returns back the
> results.  Here is what the new method looks like:
>  
>  def fix_paths( path ):
>      """ Convenience method for checking and 
>      adding '/' to the end of paths for compatibility
>      with mod_python's import_module. """
>  
>      _lock.acquire()
>      try:
>          if path and type(path) == type([]):
>              path = map(lambda entry : (entry!='' and entry[-1]!='/' and
> entry+'/') or entry,path)
>  
>          return path
>      finally:
>          _lock.release()
>  
>  Should I have the thread-locking in place or can I get by without having it
> in place?  The reason I did add that was because the path value may get
> changed, in the process, I thought of making this method thread-safe.
>  
>  Also Nicolas, if you notice I added another check in your lambda function
> to check if the entry is an empty string.  If that wasn't there then if an
> empty string path was passed in the list paths, the function would break. 
> Thought, i'd let you know if you were gonna add this functionality into the
> import_module method for apache.py
>  
>  Thanks
>  
>  Hozi
> 
>  
>  Nicolas Lehuen wrote: 
>  Sorry, reposting to the whole list :
> 
> Hi,
> 
> The change I've made for MODPYTHON-9 affects only the publisher
> module. It solves the problem encountered when you had two pages, one
> at /index.py, and the other at /foobar/index.py.
> 
> Huzaifa, what I don't understand here is whether moduleA has the same
> name as moduleB, and whether you are using mod_python.publisher or
> not.
> 
> If you use the publisher, your problem has been solved in the latest
> development version, and the fix will be in the next release.
> 
> Anyway, if we put aside the fix specific to the publisher, the problem
> you describe is real, and the workaround you provide is correct.
> 
> It is so correct that the only way I see of fixing that is to
> integrate the workaround in the import_module function, that is to say
> to check whether each path component passed in the path list argument
> ends with a '/' (or '\'), and if not, add a '/' (or '\\'). This is
> done easily in the first line of the function :
> 
> if path:
>  path = map(lambda entry : (entry[-1]!='/' and entry+'/') or entry,path)
> 
> However, there is no easy way of telling what directory separator
> should be used ; theoretically, os.sep gives us the correct directory
> separator, but even under Win32 Apache admins are advised to use "/"
> which is compatible (at the OS level). So, we might as well always use
> "/".
> 
> What I fear is that adding all these checks to import_module will make
> it a little bit too slow, so what about adding a line or two in the
> documentation about the fact that all directories mentioned in the
> path argument should end with a '/' ?
> 
> Regards,
> 
> Nicolas
> 
> On 4/29/05, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>  
>  
>  Nicolas, does the change you have already made for MODPYTHON-9
> also address this slightly different variation on the problem?
> 
> Original report was based on same name module in parent and child
> subdirectories, not sibling directories which share a common prefix
> to the subdirectory name.
> 
> Graham
> 
> Huzaifa Tapal wrote ..
>  
>  
>  For my fix, I patched this issue by passing the import_module function
> the path with "/" in the end. That way it distinguishes from
> /home/user/dir1 and /home/user/dir123
> 
> hozi
> 
> Graham Dumpleton wrote:
> 
>  
>  
>  See:
> 
>  http://issues.apache.org/jira/browse/MODPYTHON-9
>  http://issues.apache.org/jira/browse/MODPYTHON-10
>  http://issues.apache.org/jira/browse/MODPYTHON-11
> 
> There are various known issues with using same name module in different
> directories.
> 
> The first one has been addressed for next version of mod_python.
> 
> Graham
> 
> On 29/04/2005, at 8:22 AM, Huzaifa Tapal wrote:
> 
>  
>  
>  I think there is a bug in apache.import_module. I am using
> apache.import_module passing in the path where I want the module
> imported from. I am seeing a very odd result as to sometimes, the
> module that is loaded is not the right one. Instead it loads a
> module that is of the same name but in a different directory. Here
> is what is happening:
> 
> I have two modules of same name in 2 different directories as follows;
> 
> /home/user/dir1/moduleA
> /home/user/dir123/moduleB
> 
> Lets say I restart apache and load up moduleA. At that point there
> is an entry in sys.modules for moduleA. Lets say then, I load up
> moduleB, now the original entry for moduleA is overwritten by this
> new entry. Now when I go back to load moduleA, I get back moduleB
> results. Here is why:
> 
> In apache.import_module if I pass in the path to load moduleA from
> '/home/user/dir1' and the last module was in '/home/user/dir123' then
> the check in import_module to make sure both modules aren't the same
> fails since it does a "file.startswith()" check on the path. Since
> the path moduleA is in the path to moduleB, it loads the wrong module.
> 
> I see that somebody else had complained about this problem in
> mod_python 1.3.1 but it still has not been patched.
> 
> Any ideas?
> 
> Hozi
> 
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>  
>  
>  
>  _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 
>  
>  _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 
> 
>  
>

From gustavo.cordova at q-voz.com  Sat Apr 30 09:55:46 2005
From: gustavo.cordova at q-voz.com (=?UTF-8?B?R3VzdGF2byBDw7NyZG92YSBBdmlsYQ==?=)
Date: Sat Apr 30 09:53:43 2005
Subject: [mod_python] Encoding Question
In-Reply-To: <8C53AAFA2050EE40BDCDB9455DA7D63401FAC77A@sw720ex020.visa.com>
References: <8C53AAFA2050EE40BDCDB9455DA7D63401FAC77A@sw720ex020.visa.com>
Message-ID: <42738E62.90000@q-voz.com>

Feghhi, Jalil wrote:

>1. I download a page in PSP using urllib and now want to convert and
>keep it as utf-8? What calls should I make to convert the encoding of
>the page to utf8?
>
Do you know the encoding of you received page?  In that case, something 
like:

 >>> u = urllib.urlopen(some_url)
 >>> document = u.read()
 >>> u.close()
 >>> unicode_document = unicode(document, "known-encoding")

>2. Is this a good approach? Can I keep any pages in any languages in
>this way and return them when requested in utf-8?
>
I wouldn't know, unless you told us *why* you're decoding.  As for "Can 
I keep...", of course you can, no need to ask for permission ;-)

Seriously though, if you're keeping an archive of downloaded pages for 
some reason, converting them to utf-8 before storage is a good idea, 
that way all your stored pages have a uniform encoding, no need to do 
the guesswork/conversions/etc every time you access them.

>By the way, I have set my default encoding in Python to utf8.
>
*Excellent*

>Thanks,
>
>-Jalil
>
You're welcome. :-)

-gca
-------------- next part --------------
A non-text attachment was scrubbed...
Name: gustavo.cordova.vcf
Type: text/x-vcard
Size: 196 bytes
Desc: not available
Url : http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050430/b001f25c/gustavo.cordova.vcf
From vegeta.z at gmail.com  Sat Apr 30 23:01:44 2005
From: vegeta.z at gmail.com (vegetax)
Date: Sat Apr 30 23:06:54 2005
Subject: [mod_python] any way to get the current handler's directory?
Message-ID: <d51gfb$j4$1@sea.gmane.org>

i need that info to parse the url from a handler.

sys.path[0] works if there is only one "myhandler" per server

Also works this way, but i dont like it:

<Directory "myweb/dir">
??SetHandler?mod_python
??PythonHandler?myhandler
??PythonOption?dirpath?"myweb/dir"
<Directory/>

