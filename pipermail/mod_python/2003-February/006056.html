<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] CGI handler and multithreading: Can i have multiple sys.stdout objects?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20CGI%20handler%20and%20multithreading%3A%20Can%20i%20have%20multiple%20sys.stdout%20objects%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006054.html">
   <LINK REL="Next"  HREF="006057.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] CGI handler and multithreading: Can i have multiple sys.stdout objects?</H1>
    <B>Mike Looijmans</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20CGI%20handler%20and%20multithreading%3A%20Can%20i%20have%20multiple%20sys.stdout%20objects%3F&In-Reply-To="
       TITLE="[mod_python] CGI handler and multithreading: Can i have multiple sys.stdout objects?">mike.looijmans at asml.com
       </A><BR>
    <I>Thu Feb 27 08:26:38 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="006054.html">[mod_python] mod_python on win32 solved
</A></li>
        <LI>Next message: <A HREF="006057.html">[mod_python] CGI handler and multithreading: Can i have multiple
 sys.stdout objects?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6056">[ date ]</a>
              <a href="thread.html#6056">[ thread ]</a>
              <a href="subject.html#6056">[ subject ]</a>
              <a href="author.html#6056">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<table border=0 width="100%"><tr><td>
<!--beginarticle-->
<PRE>mod_python has a nice &quot;cgihandler&quot;, that allows me to run out old CGI code in
mod_python 'mode'. However, I have some problems with that, that some of you
may know a solution to.

The cgihandler will lock until the request is complete. This is OK, but it
restrains the number of simultaneous Python requests to just 1. In practice,
this means that the system gets a lot slower with mod_python, because there
are a few requests that send a few megabytes of data to the client, and this
can take a few minutes. The performance hit is unacceptable.

I'm running Apache 2.0.44 in &quot;worker&quot; thread mode on a Solaris 2.6 system.

A workaround is to compile apache with the &quot;pre-fork&quot; system. This however
yields another problem. The child processes all fire up their own interpreter,
and the memory load is about 10MB for each child (in 'worker' mode, only one
interpreter for 20 childs!). This quickly eats up all resources on the
machine. It also virtually eliminates the possibility to &quot;recycle&quot; the
database connection and similar objects. The net effect is that this setup is
also slower than the plain CGI implementation which just starts (runs and
kills) an interpreter for each CGI request.

I tried removing the thread lock in the cgihandler. All CGI scripts I have
don't care about the directory they are in (they get all they need from the
MySQL DB), and all scripts they import are fully re-entrant (or MT safe)
themselves. This left only one single problem: The &quot;print&quot; command.

Python's print command is being used to send the data to the client. The
cgihandler replaces sys.stdout and redirects it to the Request object, which
is ok. But there is only one &quot;sys&quot; module shared by all threads, so all the
print commands from all threads end up in the same request. In practice, if a
&quot;long&quot; request is running, and a shorter request interferes, the short one
will kill sys.stdout and the long one will abort with an exception because
sys.stdout had suddenly died.

One workaround would be to create a cgihandler 'clone' that passes an &quot;output&quot;
object to each script (which defaults to sys.stdout for &quot;plain&quot; CGI mode), and
let the scripts all write() to that object. Drawback is that I will have to
replace all &quot;print&quot; statements in about 10k+ lines of code. Also, I want the
scripts to remain CGI compatible for a few more weeks because a few shadow
systems cannot be upgraded to mod_python yet.

Is there a way that I can let the threads each &quot;print&quot; to their own output,
for example by having a seperate &quot;sys&quot; module in each thread? (could I delete
the sys module and re-import it or something similar?)

--
Mike Looijmans


</PRE>
<!--endarticle-->
</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006054.html">[mod_python] mod_python on win32 solved
</A></li>
	<LI>Next message: <A HREF="006057.html">[mod_python] CGI handler and multithreading: Can i have multiple
 sys.stdout objects?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6056">[ date ]</a>
              <a href="thread.html#6056">[ thread ]</a>
              <a href="subject.html#6056">[ subject ]</a>
              <a href="author.html#6056">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
