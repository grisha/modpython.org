<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] in modpython ,how to restrict the upload file size?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20in%20modpython%20%2Chow%20to%20restrict%20the%20upload%20file%20size%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023148.html">
   <LINK REL="Next"  HREF="023151.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] in modpython ,how to restrict the upload file size?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Martijn Moeling</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20in%20modpython%20%2Chow%20to%20restrict%20the%20upload%20file%20size%3F&In-Reply-To="
       TITLE="[mod_python] in modpython ,how to restrict the upload file size?">martijn at xs4us.nu
       </A><BR>
    <I>Thu Feb  1 13:35:30 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023148.html">[mod_python] Install mod_python for Apache 1.3.37
</A></li>
        <LI>Next message: <A HREF="023151.html">[mod_python] in modpython ,how to restrict the upload file size?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23150">[ date ]</a>
              <a href="thread.html#23150">[ thread ]</a>
              <a href="subject.html#23150">[ subject ]</a>
              <a href="author.html#23150">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Please do a reply to all, so the others on the list can follow the
topic..

Eh you are right, the name is PIL not PIP

I have been messing with file (picture) uploads for a long time, first I
messed with xmlhttprequest, but browser security issues killed that
solution. Now I do a normal form within an Iframe submission.

Access to the upload is only possible when a Session exists in my case,
allowing authenticated users to really upload a file. So DOS attacks are
restricted to a limited group of users (Politicians, so they think a DOS
attack is something which has to do with MS-DOS)

Nevertheless, it is something to address.

I like to integrate an upload progress bar too.

I think we need to write an imput filter which looks for 'POST' requests
and checks the Content-length from headers_in, at the other hand I found
this:

8&lt;-----------------------------
I can understand you wanting to reject a request based on input
content length being larger than a certain amount, but not what
would be gained from modifying the content length.

As long as you aren't using mod_python.publisher, you could insert
into your handler before you use the FieldStorage class a check of
the req.headers_in[&quot;content-length&quot;] field to see if the combined total
of all form parameters in the POST containing the upload was
greater than some amount and reject it on that basis. Not sure if
the req.clength is the same thing as the &quot;content-length&quot; header or
not.

Without duplicating what FieldStorage does, can't see how you would
be able to reject it based on just the file upload part of a multipart
POST request being larger than a certain size.

Graham
8&lt;-----------------------------

    Mb=1025*1024
    if req.headers_in.has_key('content-length'):
        if int(req.headers_in[&quot;content-length&quot;])&gt;Mb and
req.method=='POST':
            req.write('Error Filesize exeeded 1MB')
            req.log_error('filesize to big:
'+str(req.headers_in['content-length']))
		form=util.FieldStorage(req,keep_blank_values=True)
            return apache.OK

This works, but the apache.OK terminates the upload with an error
message, Calling the form=Fieldstorage, make the upload finish and
properly send the error message to the browser.

I have just tested this and it works

Martijn


-----Oorspronkelijk bericht-----
Van: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">clodoaldo.pinto at gmail.com</A> [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">clodoaldo.pinto at gmail.com</A>] Namens
Clodoaldo
Verzonden: Wednesday, January 31, 2007 19:44
Aan: Martijn Moeling
Onderwerp: Re: [mod_python] in modpython ,how to restrict the upload
file size?

2007/1/31, Martijn Moeling &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">martijn at xs4us.nu</A>&gt;:
&gt;<i> The PythonFixupHandler might be interesting to look at
</I>&gt;<i> Or the filters, there should be something possible there too.
</I>&gt;<i> Write a handler for a filter and enable it like you do with DEFLATE,
</I>&gt;<i> maybe an input filter, look at the content size, and return with what
</I>&gt;<i> you want, by setting headers and use req.write to return the page like
</I>&gt;<i> you are not publisher.
</I>
I will have to do something like that if turns out to not exist a
simpler solution. :(

&gt;<i> Interestingly you do not tell how you handle the upload, that would be
</I>&gt;<i> Important to give you a more precise figure.
</I>
The upload script is 120 lines long so I would have to produce a
simpler one without the details not related to this issue just to not
submit the list readers to the tedious work of trying to understand
it.

&gt;<i> I am working on the same Issue right now, and I have found a different
</I>&gt;<i> (and more user friendly approach for uploding pictures.
</I>&gt;<i>
</I>&gt;<i> I take many kinds of pictures, (bmp,gif,jpeg,png and more)
</I>&gt;<i> I accept any size
</I>&gt;<i> Next I convert the picture to a JPEG image of a given size (width or
</I>&gt;<i> height and maintain the aspect ratio)
</I>&gt;<i> And store it in a MySQL database.
</I>&gt;<i>
</I>&gt;<i> In that way I have the pictures taken with multi zillion pixel stored
</I>&gt;<i> with an acceptable and predictable size (for easy of building
</I>pages....)
&gt;<i> and the are mostly less than 100k
</I>
I'm doing the same thing except I use PIL and postgres. But if I let
the user free to upload files of any size and only then resize the
picture I'm left with the door open to DoS and disk full crashes as
the site will be on the Internet. Don't you have any protection
against such problems? Are you developing to an Intranet? I have done
it with ASP to an intranet where I took no precautions.

Otherwise the upload is working great including some AJAX like effects.

&gt;<i> If you are interested I work out the steps to take (really easy with
</I>PIP
&gt;<i> Image object though), give me a signal and I make up something you can
</I>&gt;<i> use as an example
</I>
Regards,
-- 
Clodoaldo Pinto Neto

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023148.html">[mod_python] Install mod_python for Apache 1.3.37
</A></li>
	<LI>Next message: <A HREF="023151.html">[mod_python] in modpython ,how to restrict the upload file size?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23150">[ date ]</a>
              <a href="thread.html#23150">[ thread ]</a>
              <a href="subject.html#23150">[ subject ]</a>
              <a href="author.html#23150">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
