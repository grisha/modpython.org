<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] mod_python 3.3.1 memory leak?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%203.3.1%20memory%20leak%3F&In-Reply-To=88e286470707031604l3718e500obf74612cc91e46a8%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023981.html">
   <LINK REL="Next"  HREF="023983.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] mod_python 3.3.1 memory leak?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%203.3.1%20memory%20leak%3F&In-Reply-To=88e286470707031604l3718e500obf74612cc91e46a8%40mail.gmail.com"
       TITLE="[mod_python] mod_python 3.3.1 memory leak?">graham.dumpleton at gmail.com
       </A><BR>
    <I>Tue Jul  3 22:43:45 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023981.html">[mod_python] mod_python 3.3.1 memory leak?
</A></li>
        <LI>Next message: <A HREF="023983.html">[mod_python] mod_python 3.3.1 memory leak?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23982">[ date ]</a>
              <a href="thread.html#23982">[ thread ]</a>
              <a href="subject.html#23982">[ subject ]</a>
              <a href="author.html#23982">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/07/07, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>&gt; wrote:
&gt;<i> On 03/07/07, yubing &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">trueice at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; Anyhow, it's clear that ap_rflush is the root cause of this memory leak,
</I>&gt;<i> &gt; maybe we should find a new API for this (maybe we should also add a new
</I>&gt;<i> &gt; method to the request_object ).
</I>&gt;<i>
</I>&gt;<i> It is not just ap_rflush() but also ap_rwrite(), as it is also using
</I>&gt;<i> the request pool.
</I>&gt;<i>
</I>&gt;<i> To avoid the problem would mean creating a separate pool just for the
</I>&gt;<i> one operation and for the buckets to be allocated from that, with the
</I>&gt;<i> pool destroyed at the end of the call.
</I>&gt;<i>
</I>&gt;<i> Unfortunately it isn't perhaps quite as simple as that though. This is
</I>&gt;<i> because one can only use a separate pool if you know the buckets would
</I>&gt;<i> be used up and no longer required after the call. When doing a flush
</I>&gt;<i> this may be the case, but need to check. Definitely not the case if
</I>&gt;<i> not doing a flush though.
</I>
Okay, I'm confused now. The bucket functions aren't supposed to be
allocating memory out of the resource pool.

/**
 * Create a new bucket brigade.  The bucket brigade is originally empty.
 * @param p The pool to associate with the brigade.  Data is not allocated out
 *          of the pool, but a cleanup is registered.
 * @param list The bucket allocator to use
 * @return The empty bucket brigade
 */
APU_DECLARE(apr_bucket_brigade *) apr_brigade_create(apr_pool_t *p,
                                                     apr_bucket_alloc_t *list);

Ie., it takes buckets from a bucket list, to which buckets are
returned for reuse when the bucket brigade is no longer needed at the
completion of the operation.

The only reason the request pool is required is so that the bucket
brigade can be cleaned up automatically if the code forgets to
explicitly destroy it before the request is over.

So, looks like I have some more research to do to understand all this. :-(

Graham
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023981.html">[mod_python] mod_python 3.3.1 memory leak?
</A></li>
	<LI>Next message: <A HREF="023983.html">[mod_python] mod_python 3.3.1 memory leak?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23982">[ date ]</a>
              <a href="thread.html#23982">[ thread ]</a>
              <a href="subject.html#23982">[ subject ]</a>
              <a href="author.html#23982">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
