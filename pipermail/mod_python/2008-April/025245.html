<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: Problem with mod_proxy + inputfilter + headers_in
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20Problem%20with%20mod_proxy%20%2B%20inputfilter%20%2B%20headers_in&In-Reply-To=88e286470804281402r6c51f2ccxc5ac9ffb69c446d%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025244.html">
   <LINK REL="Next"  HREF="025247.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: Problem with mod_proxy + inputfilter + headers_in</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20Problem%20with%20mod_proxy%20%2B%20inputfilter%20%2B%20headers_in&In-Reply-To=88e286470804281402r6c51f2ccxc5ac9ffb69c446d%40mail.gmail.com"
       TITLE="[mod_python] Re: Problem with mod_proxy + inputfilter + headers_in">graham.dumpleton at gmail.com
       </A><BR>
    <I>Mon Apr 28 17:09:36 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025244.html">[mod_python] Re: Problem with mod_proxy + inputfilter + headers_in
</A></li>
        <LI>Next message: <A HREF="025247.html">[mod_python] Re: Problem with mod_proxy + inputfilter + headers_in
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25245">[ date ]</a>
              <a href="thread.html#25245">[ thread ]</a>
              <a href="subject.html#25245">[ subject ]</a>
              <a href="author.html#25245">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry, one mistake I did make, was that you need earlier handler than
PythonFixupHandler if you want to affect access, authentication,
authorisation phases. Point is though that you can't do it in a
mod_python input filter as they only get triggered when content is
being read and after headers have been processed. There are input
filters that can process headers, but mod_python doesn't provide
access to writing them.

Graham

2008/4/29 Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>&gt;:
&gt;<i> 2008/4/28 Emyr Thomas &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">emyr.thomas at gmail.com</A>&gt;:
</I>&gt;<i>
</I>&gt;<i> &gt; Graham, out of interest, has this always been the case with mod_python, or
</I>&gt;<i>  &gt;  was this behavious introduced in a particular release?
</I>&gt;<i>
</I>&gt;<i>  This is nothing to do with mod_python, it is how underlying Apache C
</I>&gt;<i>  APIs work. It has always been this way. If you have seen it behave any
</I>&gt;<i>  other way, it would have been by luck due to calling sequences and not
</I>&gt;<i>  guaranteed.
</I>&gt;<i>
</I>&gt;<i>  Suggest you dig through:
</I>&gt;<i>
</I>&gt;<i>   <A HREF="http://www.fmc-modeling.org/category/projects/apache/amp/Apache_Modeling_Project.html">http://www.fmc-modeling.org/category/projects/apache/amp/Apache_Modeling_Project.html</A>
</I>&gt;<i>
</I>&gt;<i>  to get a better understanding of how Apache works internally.
</I>&gt;<i>
</I>&gt;<i>  Graham
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  &gt;  &quot;Graham Dumpleton&quot;
</I>&gt;<i>  &gt;  &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>&gt; wrote in message
</I>&gt;<i>  &gt;  news:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">88e286470704191453o5b0b3c08u77b14064c1f58950 at mail.gmail.com...</A>
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; &gt; You can't use a mod_python input filter to modify incoming headers. If
</I>&gt;<i>  &gt;  &gt; the changes to the headers aren't intended to influence the behaviour
</I>&gt;<i>  &gt;  &gt; of what Apache does during access, authentication, authorisation and
</I>&gt;<i>  &gt;  &gt; type checking phases, use a PythonFixupHandler to update any headers
</I>&gt;<i>  &gt;  &gt; to then be used by the actual response handler.
</I>&gt;<i>  &gt;  &gt;
</I>&gt;<i>  &gt;  &gt; Note, provided you are using mod_python 3.3, you can actually use
</I>&gt;<i>  &gt;  &gt; mod_python to trigger the proxying as well. See:
</I>&gt;<i>  &gt;  &gt;
</I>&gt;<i>  &gt;  &gt; <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-141">http://issues.apache.org/jira/browse/MODPYTHON-141</A>
</I>&gt;<i>  &gt;  &gt;
</I>&gt;<i>  &gt;  &gt; Graham
</I>&gt;<i>  &gt;  &gt;
</I>&gt;<i>  &gt;  &gt; On 20/04/07, indyone ;o) &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">indyone at gmail.com</A>&gt;
</I>&gt;<i>  &gt;  &gt; wrote:
</I>&gt;<i>  &gt;  &gt;&gt; Hi list,
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt; I'm trying to get the headers_in from the client, and after
</I>&gt;<i>  &gt;  &gt;&gt; changing/adding
</I>&gt;<i>  &gt;  &gt;&gt; some headers i would like to pass them to the backend server.
</I>&gt;<i>  &gt;  &gt;&gt; I'm using Apache/2.0.55 (Win32) mod_python/3.1.3 Python/2.3.5
</I>&gt;<i>  &gt;  &gt;&gt; The problem is that the headers are sent to the backend unchanged when
</I>&gt;<i>  &gt;  &gt;&gt; using
</I>&gt;<i>  &gt;  &gt;&gt; this simple input filter:
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt; def inputfilter(filter):
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt;     filter.req.headers_in['X-MyHeader'] = 'Test'
</I>&gt;<i>  &gt;  &gt;&gt;     if filter.req.main is not None:
</I>&gt;<i>  &gt;  &gt;&gt;         filter.pass_on()
</I>&gt;<i>  &gt;  &gt;&gt;         return
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt;     filter.req.log_error('Start %s' % filter.req.uri)
</I>&gt;<i>  &gt;  &gt;&gt;     s = filter.read()
</I>&gt;<i>  &gt;  &gt;&gt;     while s:
</I>&gt;<i>  &gt;  &gt;&gt;         filter.write(s)
</I>&gt;<i>  &gt;  &gt;&gt;         s = filter.read()
</I>&gt;<i>  &gt;  &gt;&gt;     if s is None:
</I>&gt;<i>  &gt;  &gt;&gt;         filter.close()
</I>&gt;<i>  &gt;  &gt;&gt;         filter.req.log_error('End %s' % filter.req.uri)
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt;     filter.req.log_error('%s' % filter.req.headers_in)
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt; and Apache logs:
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt; [Thu Apr 19 18:17:28 2007] [error] [client 127.0.0.1] Start /, referer:
</I>&gt;<i>  &gt;  &gt;&gt; <A HREF="http://localhost/">http://localhost/</A>
</I>&gt;<i>  &gt;  &gt;&gt; [Thu Apr 19 18:17:28 2007] [error] [client 127.0.0.1] End /, referer:
</I>&gt;<i>  &gt;  &gt;&gt; <A HREF="http://localhost/">http://localhost/</A>
</I>&gt;<i>  &gt;  &gt;&gt; [Thu Apr 19 18:17:28 2007] [error] [client 127.0.0.1] {'X-MyHeader':
</I>&gt;<i>  &gt;  &gt;&gt; 'Test',
</I>&gt;<i>  &gt;  &gt;&gt; 'X-Forwarded-Server': 'luna', 'X-Forwarded-Host': 'localhost',
</I>&gt;<i>  &gt;  &gt;&gt; 'X-Forwarded-For': ' 127.0.0.1', 'Max-Forwards': '10', 'Cookie':
</I>&gt;<i>  &gt;  &gt;&gt; 'wstyle=;
</I>&gt;<i>  &gt;  &gt;&gt; __ac=&quot;YWRtaW46bWF0cml4&quot;;
</I>&gt;<i>  &gt;  &gt;&gt; tree-s=&quot;eJzT0MgpMOQKVneEAKcAN19bda4CI67EkgJjLj0AegYHmA&quot;',
</I>&gt;<i>  &gt;  &gt;&gt; 'Referer': ' <A HREF="http://localhost/',">http://localhost/',</A> 'Accept-Charset':
</I>&gt;<i>  &gt;  &gt;&gt; 'ISO-8859-7,utf-8;q=0.7,*;q=0.7', 'Accept-Encoding': 'gzip,deflate',
</I>&gt;<i>  &gt;  &gt;&gt; 'Accept-Language': 'el,en-us;q=0.7 ,en;q=0.3', 'Accept':
</I>&gt;<i>  &gt;  &gt;&gt; 'text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5',
</I>&gt;<i>  &gt;  &gt;&gt; 'User-Agent': 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:
</I>&gt;<i>  &gt;  &gt;&gt; 1.8.0.8)
</I>&gt;<i>  &gt;  &gt;&gt; Gecko/20061030 SeaMonkey/1.0.6', 'Host': 'localhost'}, referer:
</I>&gt;<i>  &gt;  &gt;&gt; <A HREF="http://localhost/">http://localhost/</A>
</I>&gt;<i>  &gt;  &gt;&gt; ...(multiple times)...
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt; Which is right i think... But my backend server gets this request:
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt; GET
</I>&gt;<i>  &gt;  &gt;&gt; /VirtualHostBase/http/localhost:80/Editorial/VirtualHostRoot/
</I>&gt;<i>  &gt;  &gt;&gt; HTTP/1.1
</I>&gt;<i>  &gt;  &gt;&gt; Host: localhost:8081
</I>&gt;<i>  &gt;  &gt;&gt; User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.8)
</I>&gt;<i>  &gt;  &gt;&gt; Gecko/20061030 SeaMonkey/1.0.6
</I>&gt;<i>  &gt;  &gt;&gt; Accept:
</I>&gt;<i>  &gt;  &gt;&gt; text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
</I>&gt;<i>  &gt;  &gt;&gt; Accept-Language: el,en-us;q=0.7,en;q=0.3
</I>&gt;<i>  &gt;  &gt;&gt; Accept-Encoding: gzip,deflate
</I>&gt;<i>  &gt;  &gt;&gt; Accept-Charset: ISO-8859-7,utf-8;q= 0.7,*;q=0.7
</I>&gt;<i>  &gt;  &gt;&gt; Referer: <A HREF="http://localhost/">http://localhost/</A>
</I>&gt;<i>  &gt;  &gt;&gt; Cookie: wstyle=; __ac=&quot;YWRtaW46bWF0cml4&quot;;
</I>&gt;<i>  &gt;  &gt;&gt; tree-s=&quot;eJzT0MgpMOQKVneEAKcAN19bda4CI67EkgJjLj0AegYHmA&quot;
</I>&gt;<i>  &gt;  &gt;&gt; Max-Forwards: 10
</I>&gt;<i>  &gt;  &gt;&gt; X-Forwarded-For: 127.0.0.1
</I>&gt;<i>  &gt;  &gt;&gt; X-Forwarded-Host: localhost
</I>&gt;<i>  &gt;  &gt;&gt; X-Forwarded-Server: luna
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt; Thank you in advance,
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt; Ioannis Stavrinos
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt; _______________________________________________
</I>&gt;<i>  &gt;  &gt;&gt; Mod_python mailing list
</I>&gt;<i>  &gt;  &gt;&gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i>  &gt;  &gt;&gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;  &gt;&gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;  _______________________________________________
</I>&gt;<i>  &gt;  Mod_python mailing list
</I>&gt;<i>  &gt;  <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i>  &gt;  <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>  &gt;
</I>&gt;<i>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025244.html">[mod_python] Re: Problem with mod_proxy + inputfilter + headers_in
</A></li>
	<LI>Next message: <A HREF="025247.html">[mod_python] Re: Problem with mod_proxy + inputfilter + headers_in
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25245">[ date ]</a>
              <a href="thread.html#25245">[ thread ]</a>
              <a href="subject.html#25245">[ subject ]</a>
              <a href="author.html#25245">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
