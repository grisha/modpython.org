<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Proxy + Tomcat filter problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Proxy%20%2B%20Tomcat%20filter%20problems&In-Reply-To=4834c71e0804170802o49911a26oc86a9a65dd483d50%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025208.html">
   <LINK REL="Next"  HREF="025209.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Proxy + Tomcat filter problems</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Proxy%20%2B%20Tomcat%20filter%20problems&In-Reply-To=4834c71e0804170802o49911a26oc86a9a65dd483d50%40mail.gmail.com"
       TITLE="[mod_python] Proxy + Tomcat filter problems">graham.dumpleton at gmail.com
       </A><BR>
    <I>Thu Apr 17 19:32:16 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025208.html">[mod_python] Proxy + Tomcat filter problems
</A></li>
        <LI>Next message: <A HREF="025209.html">[mod_python] Problems w/ mod python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25214">[ date ]</a>
              <a href="thread.html#25214">[ thread ]</a>
              <a href="subject.html#25214">[ subject ]</a>
              <a href="author.html#25214">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>To be honest, I didn't think that headers could be modified in a
mod_python output filter. This is because they are a resource type
output filter and as such I understood they are not the type of output
filter that gets called in the correct place to allow headers to be
called. The filter type which probably allows modifying of headers is
a protocol filter, but you can't create them with mod_python.

Thus, if you are seeing headers modified at all is probably by luck
and would be random. Since you said you were seeing changes, I had
assumed that maybe my understanding that one couldn't change response
headers in a mod_python output filter was wrong and thus why I
suggested what I did because if anything would work, that would.

My guess then is that you may be out of luck.

Graham

2008/4/18 Rados&#322;aw Rymaszewski &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">rrymaszewski at contentforces.pl</A>&gt;:
&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2008/4/17 Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>&gt;:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 2008/4/17 Rados&#322;aw Rymaszewski &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">rrymaszewski at contentforces.pl</A>&gt;:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Hello
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I was trying to find out solution for my problem but there were no
</I>&gt;<i> answers,
</I>&gt;<i> &gt; &gt; so I decided to write here.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; We are using mod_python filters for our system
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Infrastructure description:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; INTERNET &lt;---&gt; APACHE 2.8.3 with mod_python 3.3.1 + output filters &lt;--&gt;
</I>&gt;<i> &gt; &gt; Apache proxy module &lt;--&gt; TOMCAT 5.5.2x
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; our filters concat chunked content from tomcat and write to client whole
</I>&gt;<i> &gt; &gt; changed content. It's important for us to get whole response from tomcat
</I>&gt;<i> and
</I>&gt;<i> &gt; &gt; after it process.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; problem is when filter.read() reach last byte (filter.read() == None)
</I>&gt;<i> then
</I>&gt;<i> &gt; &gt; there is no possibility to overwrite request headers.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; There is no such problem during reading content and when we serve static
</I>&gt;<i> &gt; &gt; pages from apache www server.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; mod_python receive such headers
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 1 chunk
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; [Wed Apr 16 05:52:15 2008] [error] {'Via': '1.1 domain', 'Set-Cookie':
</I>&gt;<i> &gt; &gt; 'JSESSIONID=sessionXXX; Path=/path', 'Date': 'Fri, 18 Apr 2008 19:47:06
</I>&gt;<i> &gt; &gt; GMT', 'Cache-Control': 'no-store', 'Cache-Control': 'no-cache',
</I>&gt;<i> 'Expires':
</I>&gt;<i> &gt; &gt; 'Thu, 01 Jan 1970 00:00:00 GMT', 'Pragma': 'No-cache', 'Server':
</I>&gt;<i> &gt; &gt; 'Apache-Coyote'}
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 2 chunk
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; [Wed Apr 16 05:52:15 2008] [error] {'Content-Type': 'text/plain',
</I>&gt;<i> &gt; &gt; 'Transfer-Encoding': 'chunked', 'Connection': 'Keep-Alive',
</I>&gt;<i> 'Keep-Alive':
</I>&gt;<i> &gt; &gt; 'timeout=15, max=100', 'Via': '1.1 domain', 'Set-Cookie':
</I>&gt;<i> &gt; &gt; 'JSESSIONID=sessionXXX; Path=/path', 'Cache-Control': 'No-cache',
</I>&gt;<i> 'Expires':
</I>&gt;<i> &gt; &gt; '0', 'Pragma': 'No-cache'}
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 3 chunk
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;  [Wed Apr 16 05:52:15 2008] [error] {'Content-Type': 'text/plain',
</I>&gt;<i> &gt; &gt; 'Transfer-Encoding': 'chunked', 'Connection': 'Keep-Alive',
</I>&gt;<i> 'Keep-Alive':
</I>&gt;<i> &gt; &gt; 'timeout=15, max=100', 'Via': '1.1 domain', 'Set-Cookie':
</I>&gt;<i> &gt; &gt; 'JSESSIONID=sessionXXX; Path=/path', 'Cache-Control': 'No-cache',
</I>&gt;<i> 'Expires':
</I>&gt;<i> &gt; &gt; '0', 'Pragma': 'No-cache'}
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; when I finish process on first or second chunk I can modify headers
</I>&gt;<i> without
</I>&gt;<i> &gt; &gt; any problems. after third one there is no such possibility
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Do You know what could be wrong ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As soon as any filter following yours has caused any chunk of data to
</I>&gt;<i> &gt; be written back to client, it is too late to change headers. This is
</I>&gt;<i> &gt; because headers are sent before the data.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thus, headers can only be reliably changed upon reading first chunk
</I>&gt;<i> &gt; and before it is written to next filter. Only other choice is to
</I>&gt;<i> &gt; buffer the whole content in your filter, fixup any headers based on
</I>&gt;<i> &gt; that content and then write the whole content.
</I>&gt;<i>
</I>&gt;<i> thank You for your reply.
</I>&gt;<i>
</I>&gt;<i> Tomcat content is buffered as You see below.
</I>&gt;<i>
</I>&gt;<i> Could You explain in which place in code below headers are send to client  ?
</I>&gt;<i> I thought that in same time when script execute filter.write(), because
</I>&gt;<i> client always get header from last chunk
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>                  try:
</I>&gt;<i>                      buffer = filter.req.buffer
</I>&gt;<i>                  except AttributeError:
</I>&gt;<i>                      filter.req.buffer = Buffer()
</I>&gt;<i>                      buffer = filter.req.buffer
</I>&gt;<i>
</I>&gt;<i>                  s=filter.read()
</I>&gt;<i>                  while s:
</I>&gt;<i>                      buffer.append(s)
</I>&gt;<i>                      s=filter.read()
</I>&gt;<i>
</I>&gt;<i>                  if s is None:
</I>&gt;<i>                      filter.req.headers_out[
</I>&gt;<i> 'content-type'] = &quot;text/html; charset=UTF-8&quot;
</I>&gt;<i>                      filter.req.headers_out['content-length'] =
</I>&gt;<i> str(len(buffer.string))
</I>&gt;<i>                      filter.req.content_type = &quot;text/html; charset=UTF-8&quot;
</I>&gt;<i>                      filter.req.set_content_length(len(buffer.string))
</I>&gt;<i>                      data = buffer.string
</I>&gt;<i>                  else:
</I>&gt;<i>                      return
</I>&gt;<i>            filter.write(data)
</I>&gt;<i>            filter.close()
</I>&gt;<i>
</I>&gt;<i> br
</I>&gt;<i> --
</I>&gt;<i> Radoslaw Rymaszewski
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i>  Mod_python mailing list
</I>&gt;<i>  <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i>  <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025208.html">[mod_python] Proxy + Tomcat filter problems
</A></li>
	<LI>Next message: <A HREF="025209.html">[mod_python] Problems w/ mod python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25214">[ date ]</a>
              <a href="thread.html#25214">[ thread ]</a>
              <a href="subject.html#25214">[ subject ]</a>
              <a href="author.html#25214">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
