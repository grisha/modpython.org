<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Multiple Interpreters mod_python optimization
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Multiple%20Interpreters%20mod_python%20optimization&In-Reply-To=9b74ad98b461798da8f638bae44e1105%40skolesys.dk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026216.html">
   <LINK REL="Next"  HREF="026218.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Multiple Interpreters mod_python optimization</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Multiple%20Interpreters%20mod_python%20optimization&In-Reply-To=9b74ad98b461798da8f638bae44e1105%40skolesys.dk"
       TITLE="[mod_python] Multiple Interpreters mod_python optimization">graham.dumpleton at gmail.com
       </A><BR>
    <I>Fri May 15 06:11:38 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="026216.html">[mod_python] Multiple Interpreters mod_python optimization
</A></li>
        <LI>Next message: <A HREF="026218.html">[mod_python] Multiple Interpreters mod_python optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26217">[ date ]</a>
              <a href="thread.html#26217">[ thread ]</a>
              <a href="subject.html#26217">[ subject ]</a>
              <a href="author.html#26217">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>2009/5/15 zsi &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">zsi at skolesys.dk</A>&gt;:
&gt;<i> Hey *
</I>&gt;<i>
</I>&gt;<i> I am creating a SOAP service that is based on ZSI and mod_python. I have
</I>&gt;<i> the service running and it works, but it's not performing well, so I made
</I>&gt;<i> did some output to the syslog from inside the handler:
</I>&gt;<i>
</I>&gt;<i> reloadchecker.py:
</I>&gt;<i> ----------------
</I>&gt;<i> testvar=1
</I>&gt;<i> ----------------
</I>&gt;<i>
</I>&gt;<i> My handler:
</I>&gt;<i> ----------------
</I>&gt;<i> import capa0_9.soap.sessionservice as sessionservice
</I>&gt;<i> import capa0_9.soap.zsi_handler as zsi_handler
</I>&gt;<i> from mod_python import apache
</I>&gt;<i> import capa0_9.tools.log as log
</I>&gt;<i> import os,reloadchecker
</I>&gt;<i>
</I>&gt;<i> mod = __import__('encodings.utf_8', globals(), locals(), '*')
</I>&gt;<i> mod = __import__('encodings.utf_16_be', globals(), locals(), '*')
</I>&gt;<i>
</I>&gt;<i> def handler(req):
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;The PythonHandler entry-point. This function must be present in
</I>&gt;<i> order to have mod_apache dispatch a python operation.
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;zsi_handler.AsHandler(modules=(sessionservice,), request=req)
</I>&gt;<i> &#160; &#160; &#160; &#160;log.debug(&quot;REQUESTINFO: Interpreter Name = %s&quot; %
</I>&gt;<i> str(req.interpreter))
</I>&gt;<i> &#160; &#160; &#160; &#160;log.debug(&quot;REQUESTINFO: os.getpid() &#160; &#160; &#160;= %s&quot; % str(os.getpid()))
</I>&gt;<i> &#160; &#160; &#160; &#160;log.debug(&quot;REQUESTINFO: reloadchecker &#160; &#160;= %s&quot; %
</I>&gt;<i> str(reloadchecker.testvar))
</I>&gt;<i> &#160; &#160; &#160; &#160;reloadchecker.testvar += 1
</I>&gt;<i> &#160; &#160; &#160; &#160;return apache.OK
</I>&gt;<i> -----------------
</I>&gt;<i>
</I>&gt;<i> I log the interpreter name, which according to section 4.1 should make
</I>&gt;<i> mod_python boost performance by keeping the interpreter alive as long as
</I>&gt;<i> the apache server processes. And I log the pid of the interpreter. As it is
</I>&gt;<i> clear to see in the output below a new pid is spawned each time, it does
</I>&gt;<i> not reuse the interpreter and therefore, I guess, it has to reload
</I>&gt;<i> everything for each request. Note that i also list the apache2 processes
</I>&gt;<i> before and after I bombard the server with requests, it shows that the same
</I>&gt;<i> processes are running before and after. I also made a dummy module
</I>&gt;<i> &quot;reloadchecker&quot; that contains one variable &quot;testvar&quot;. If it is reloaded the
</I>&gt;<i> variable is initialized to 1, if it was already loaded it should be
</I>&gt;<i> increased by 1 for each request.
</I>&gt;<i>
</I>&gt;<i> Am I missing something,
</I>
Yes.

&gt;<i> shouldn't mod_python optimize performance by
</I>&gt;<i> reusing previously loaded modules from earlier requests?
</I>
Only if the request is actually handled by the same process. Since
Apache is a multiprocess web server, the requests could be handled by
any of the processes. You will obviously incur the load cost of the
interpreter and application for the first request against each
processor. Subsequent requests for a process should use the fact that
stuff is already loaded. You likely didn't do enough requests to have
touched all process and have a request actually go back to a process
which was already used.

Read:

  <A HREF="http://www.dscpl.com.au/wiki/ModPython/Articles/TheProcessInterpreterModel">http://www.dscpl.com.au/wiki/ModPython/Articles/TheProcessInterpreterModel</A>

Since you appear to be using prefork MPM, also read about the dangers
of prefork MPM in:

  <A HREF="http://blog.dscpl.com.au/2009/03/load-spikes-and-excessive-memory-usage.html">http://blog.dscpl.com.au/2009/03/load-spikes-and-excessive-memory-usage.html</A>

If you want better control over how many processes are used for your
application and particularly so you can limit number to small fixed
number and/or use threading as well, then look at mod_wsgi daemon mode
instead.

BTW, the process IDs in your 'ps' output don't even match what your
Python code is producing. Looks like you aren't even talking to the
same Apache instance. Alternatively you have got some really silly
Apache configuration setup, such a MaxRequestsPerchild set to 1. But
even in that case, you would have expected some of those initial
process to have been recycled.

So, try and validate your configuration and whether you might have
multiple Apache installations running. Look for 'httpd' processes as
well.

Graham

&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mikrov at capa-server</A>:/srv/capa/www/0.9$ sudo ps aux | grep apache2
</I>&gt;<i> mikrov &#160; &#160;7396 &#160;0.0 &#160;0.1 &#160; 3004 &#160; 764 pts/2 &#160; &#160;S+ &#160; 11:11 &#160; 0:00 grep
</I>&gt;<i> apache2
</I>&gt;<i> root &#160; &#160; 22343 &#160;0.0 &#160;1.0 &#160;13728 &#160;5336 ? &#160; &#160; &#160; &#160;Ss &#160; May14 &#160; 0:26
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22346 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22347 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22348 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22349 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22350 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22383 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22392 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22407 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22716 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:03
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 23356 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:03
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mikrov at capa-server</A>:/srv/capa/www/0.9/sessionservice$ sudo tail -f
</I>&gt;<i> /var/log/syslog | grep REQUESTINFO
</I>&gt;<i> May 15 11:52:03 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:03 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7953
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:03 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:03 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:03 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7954
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:03 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:04 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:04 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7955
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:04 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:05 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:05 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7959
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:05 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:06 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:06 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7960
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:06 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:07 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:07 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7961
</I>&gt;<i>
</I>&gt;<i> May 15 11:52:07 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:08 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:08 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7963
</I>&gt;<i> May 15 11:52:08 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:08 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:08 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7964
</I>&gt;<i> May 15 11:52:08 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:09 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:09 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7966
</I>&gt;<i> May 15 11:52:09 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:10 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:10 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7968
</I>&gt;<i> May 15 11:52:10 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:11 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:11 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7969
</I>&gt;<i> May 15 11:52:11 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:12 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:12 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7970
</I>&gt;<i> May 15 11:52:12 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:13 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:13 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7972
</I>&gt;<i> May 15 11:52:13 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:13 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:13 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7973
</I>&gt;<i> May 15 11:52:13 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:14 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:14 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7974
</I>&gt;<i> May 15 11:52:14 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:15 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:15 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7976
</I>&gt;<i> May 15 11:52:15 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i> May 15 11:52:16 capa-server capa: REQUESTINFO: Interpreter Name =
</I>&gt;<i> /srv/capa/www/0.9/sessionservice/
</I>&gt;<i> May 15 11:52:16 capa-server capa: REQUESTINFO: os.getpid() &#160; &#160; &#160;= 7977
</I>&gt;<i> May 15 11:52:16 capa-server capa: REQUESTINFO: reloadchecker &#160; &#160;= 1
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mikrov at capa-server</A>:/srv/capa/www/0.9$ sudo ps aux | grep apache2
</I>&gt;<i> mikrov &#160; &#160;7457 &#160;0.0 &#160;0.1 &#160; 3004 &#160; 764 pts/2 &#160; &#160;S+ &#160; 11:12 &#160; 0:00 grep
</I>&gt;<i> apache2
</I>&gt;<i> root &#160; &#160; 22343 &#160;0.0 &#160;1.0 &#160;13728 &#160;5336 ? &#160; &#160; &#160; &#160;Ss &#160; May14 &#160; 0:26
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22346 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22347 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22348 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22349 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22350 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22383 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22392 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22407 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:04
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 22716 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:03
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i> root &#160; &#160; 23356 &#160;0.0 &#160;0.6 &#160;13728 &#160;3136 ? &#160; &#160; &#160; &#160;S &#160; &#160;May14 &#160; 0:03
</I>&gt;<i> /usr/sbin/apache2 -k start
</I>&gt;<i>
</I>&gt;<i> Best regards
</I>&gt;<i> Jakob Simon-Gaarde
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026216.html">[mod_python] Multiple Interpreters mod_python optimization
</A></li>
	<LI>Next message: <A HREF="026218.html">[mod_python] Multiple Interpreters mod_python optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26217">[ date ]</a>
              <a href="thread.html#26217">[ thread ]</a>
              <a href="subject.html#26217">[ subject ]</a>
              <a href="author.html#26217">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
