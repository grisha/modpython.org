<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Serving files via mod_python
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Serving%20files%20via%20mod_python&In-Reply-To=20020520190531.GA20265%40vervet.localnet">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008920.html">
   <LINK REL="Next"  HREF="008924.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
<table border=0 width="100%"><tr><td valign="top">
   <H1>[mod_python] Serving files via mod_python</H1>
    <B>Ian Clelland</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Serving%20files%20via%20mod_python&In-Reply-To=20020520190531.GA20265%40vervet.localnet"
       TITLE="[mod_python] Serving files via mod_python">ian at veryfresh.com
       </A><BR>
    <I>Tue May 21 16:01:49 EST 2002</I>
    <P><UL>
        <LI>Previous message: <A HREF="008920.html">[mod_python] Serving files via mod_python
</A></li>
        <LI>Next message: <A HREF="008924.html">[mod_python] Serving files via mod_python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8923">[ date ]</a>
              <a href="thread.html#8923">[ thread ]</a>
              <a href="subject.html#8923">[ subject ]</a>
              <a href="author.html#8923">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, May 20, 2002 at 09:05:31PM +0200, Hugo van der Merwe wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I want to use mod_python to control what files can be downloaded by
</I>&gt;<i> whom, and to log such file transfers (with my own code). One possibility
</I>&gt;<i> is also to convert some files' contents on the fly.
</I>&gt;<i> 
</I>&gt;<i> I am currently using:
</I>&gt;<i> 
</I>&gt;<i> f = open(filename, &quot;r&quot;)
</I>&gt;<i> while 1:
</I>&gt;<i>   data = f.read(1048576)
</I>&gt;<i>   if data = &quot;&quot;: break
</I>&gt;<i>   req.write(data)
</I>&gt;<i> 
</I>&gt;<i> It seems to work fine. I just wonder if this is bad (performance wise, I
</I>&gt;<i> wonder what the best &quot;size&quot; would be, instead of 1M). These are
</I>&gt;<i> potentially *large* files I'm dealing with, things like cd images.
</I>
Transferring 1MB at a time is probably about as efficient as you can 
get; of course, you'd need to do some proper benchmarking to be sure. I 
believe that Apache defaults to Chunked transfer-encoding, so every 
time you call req.write(), the data goes out immediately, with about 10 
bytes of overhead (actually ln(n)/4+4 bytes).

Actually, most of your overhead will be in TCP and IP encoding, as each 
call to write() will probably result in about 600 IP packets being sent 
(and acknowledged), and there's not much you can do about that.

&gt;<i> At a
</I>&gt;<i> later date I guess I'll have to figure out how to do download resuming,
</I>&gt;<i> etc. I'm sure Apache does a better job of this, maybe I should rather
</I>&gt;<i> let Apache handle it,
</I>
Apache will only handle Range requests (which are what you need for 
download resuming) for static files. If you are using mod_python to 
serve the content, then you will have to handle the Range headers 
yourself.

&gt;<i> how can I do this while controlling it all from
</I>&gt;<i> modPython? I guess I could just define a PythonAuthenHandler, and let
</I>&gt;<i> Apache do the actual serving? Does the PythonAuthenHandler have full
</I>&gt;<i> access to just about everything a normal handler would? (URL, etc.)
</I>
That's a good way to do it, assuming that the files are already on the 
filesystem, and not being stored in a database or ripped in realtime. 
What you are looking for, though, is a PythonAuthzHandler 
(authorization handler). This is the handler which gets called *after* 
the user's name and password have been verified, (by a .htpasswd file 
or some other method,) and decides whether that user is allowed to 
download that file.

&gt;<i> 
</I>&gt;<i> If there was some way to give Apache a file handle or something like
</I>&gt;<i> that, from which it should serve the data...
</I>
You don't even need to do that; all you have to do is install the 
PythonAuthzHandler, and let Apache handle serving the actual content. 
The AuthzHandler will act like a 'filter' on an otherwise normal 
request/response.

Hope that helps,

Ian
&lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">ian at veryfresh.com</A>&gt;

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008920.html">[mod_python] Serving files via mod_python
</A></li>
	<LI>Next message: <A HREF="008924.html">[mod_python] Serving files via mod_python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8923">[ date ]</a>
              <a href="thread.html#8923">[ thread ]</a>
              <a href="subject.html#8923">[ subject ]</a>
              <a href="author.html#8923">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
