<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Exceptions in the mod_python handler?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Exceptions%20in%20the%20mod_python%20handler%3F&In-Reply-To=b11ea23c0801062050g2f0dfe70kccd7156feb0b48fc%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024639.html">
   <LINK REL="Next"  HREF="024640.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Exceptions in the mod_python handler?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Exceptions%20in%20the%20mod_python%20handler%3F&In-Reply-To=b11ea23c0801062050g2f0dfe70kccd7156feb0b48fc%40mail.gmail.com"
       TITLE="[mod_python] Exceptions in the mod_python handler?">graham.dumpleton at gmail.com
       </A><BR>
    <I>Wed Jan  9 19:27:11 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="024639.html">[mod_python] Exceptions in the mod_python handler?
</A></li>
        <LI>Next message: <A HREF="024640.html">Fwd: [mod_python] Exceptions in the mod_python handler?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24651">[ date ]</a>
              <a href="thread.html#24651">[ thread ]</a>
              <a href="subject.html#24651">[ subject ]</a>
              <a href="author.html#24651">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/01/2008, Webb Sprague &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">webb.sprague at gmail.com</A>&gt; wrote:
&gt;<i> Hi all,
</I>&gt;<i>
</I>&gt;<i> I have a mod_python handler, called &quot;lc.py&quot;, which has a bunch of
</I>&gt;<i> functions -- mapped to pages --  called things &quot;index&quot;,
</I>&gt;<i> &quot;process_request&quot;, etc.  Before defining those functions, I connect to
</I>&gt;<i> the database with psycopg2 and pass that connection handle to each
</I>&gt;<i> function/ page.
</I>&gt;<i>
</I>&gt;<i> &lt;Directory /var/www/localhost/htdocs/lcfit&gt;
</I>&gt;<i>     SetHandler mod_python
</I>&gt;<i>     PythonHandler mod_python.publisher
</I>&gt;<i>     PythonDebug On
</I>&gt;<i> &lt;/Directory&gt;
</I>&gt;<i>
</I>&gt;<i> # This is lc.py in the lcfit directory
</I>&gt;<i> dbcon = pyscopg2.connect(&quot;blah&quot;)
</I>&gt;<i> def index(req, dbcon=dbcon):
</I>&gt;<i>       curs = dbcon.cursor()
</I>&gt;<i>       # etc
</I>&gt;<i>
</I>&gt;<i> This works fine usually.  However,  when the connection fails I don't
</I>&gt;<i> know how to get apache to send some text to the user saying &quot;call the
</I>&gt;<i> admin and tell him to restart postgres.&quot;  At the moment I get a nice
</I>&gt;<i> stack trace that I know how to read, but I would like to catch the
</I>&gt;<i> exception, print something less intimidating, and quit processing the
</I>&gt;<i> handler. If I can somehow mark it so that apache knows to reload lc.py
</I>&gt;<i> and attempt to reconnect the database the next time (hopefully after
</I>&gt;<i> postgres is restarted), that would be especially great (touching the
</I>&gt;<i> file?).
</I>&gt;<i>
</I>&gt;<i> Is this a bad design?
</I>
Yes it is bad design.

At least do something like:

  dbcon = None
  def getdbcon():
    if not dbcon:
        dbcon = pyscopg2.connect(&quot;blah&quot;)
    return dbcon

  def index(req, dbcon=dbcon):
       curs = getdbcon().cursor()

That way the exception is raised from within your handler.

Note that this code is not thread safe, so you should make it so if
using worker MPM with Apache. This would require at the minimum locks
around the check to see if the dbcon has already been created or not.

You may also have to deal with issues of module reloading as well, so
make sure you read documentation for import_module() in:

  <A HREF="http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html">http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html</A>

Especially look for section on __mp_clone__() hook function.

If you aren't using mod_python 3.3.1 then upgrade.

Depending on the database being used, it is easier and not much less
efficient to simply create the database connection for very request
that requires it. That will save you a lot of trouble.

Graham
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024639.html">[mod_python] Exceptions in the mod_python handler?
</A></li>
	<LI>Next message: <A HREF="024640.html">Fwd: [mod_python] Exceptions in the mod_python handler?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24651">[ date ]</a>
              <a href="thread.html#24651">[ thread ]</a>
              <a href="subject.html#24651">[ subject ]</a>
              <a href="author.html#24651">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
