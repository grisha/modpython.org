<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: mod_python.util.StorageField.read_to_boundary has
	problems in 3.1 and 3.2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20mod_python.util.StorageField.read_to_boundary%20has%0A%09problems%20in%203.1%20and%203.2&In-Reply-To=c298f2d70511061320p60109613u%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019469.html">
   <LINK REL="Next"  HREF="019471.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: mod_python.util.StorageField.read_to_boundary has
	problems in 3.1 and 3.2</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Alexis Marrero</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20mod_python.util.StorageField.read_to_boundary%20has%0A%09problems%20in%203.1%20and%203.2&In-Reply-To=c298f2d70511061320p60109613u%40mail.gmail.com"
       TITLE="[mod_python] Re: mod_python.util.StorageField.read_to_boundary has
	problems in 3.1 and 3.2">amarrero at mitre.org
       </A><BR>
    <I>Sun Nov  6 16:54:45 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="019469.html">Developer FAQ (was Re: [mod_python]
	mod_python.util.StorageField.read_to_boundary
	has	problems in 3.1 and 3.2)
</A></li>
        <LI>Next message: <A HREF="019471.html">[mod_python] [SPAM] Is mod_python 3.1 good in commercial
	blogging/CMS programming?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19470">[ date ]</a>
              <a href="thread.html#19470">[ thread ]</a>
              <a href="subject.html#19470">[ subject ]</a>
              <a href="author.html#19470">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Nicolas,

Not that I'm the one to give permission whether to integrate things  
or not, but just to let you know I don't even have svn installed so I  
won't do it. At least not for a while...

BTW, if there are some cherrypy developers in this mailing list, the  
CherryPy function that handles file uploads DOES also has the same  
issue.

I'm not subscribe to CherryPy dev group thus the cross posting.

 From <A HREF="http://svn.cherrypy.org/trunk/cherrypy/_cpcgifs.py">http://svn.cherrypy.org/trunk/cherrypy/_cpcgifs.py</A>

     24      def read_lines_to_outerboundary(self):
     25          &quot;&quot;&quot;Internal: read lines until outerboundary.&quot;&quot;&quot;
     26          next = &quot;--&quot; + self.outerboundary
     27          last = next + &quot;--&quot;
     28          delim = &quot;&quot;
     29          last_line_lfend = True
     30          while 1:
     31              line = self.fp.readline(1&lt;&lt;16)
     32              if not line:
     33                  self.done = -1
     34                  break
     35              if line[:2] == &quot;--&quot; and last_line_lfend:
     36                  strippedline = line.strip()
     37                  if strippedline == next:
     38                      break
     39                  if strippedline == last:
     40                      self.done = 1
     41                      break
     42              odelim = delim
     43              if line[-2:] == &quot;\r\n&quot;:
     44                  delim = &quot;\r\n&quot;
     45                  line = line[:-2]
     46                  last_line_lfend = True
     47              elif line[-1] == &quot;\n&quot;:
     48                  delim = &quot;\n&quot;
     49                  line = line[:-1]
     50                  last_line_lfend = True
     51              else:
     52                  delim = &quot;&quot;
     53                  last_line_lfend = False
     54              self.__write(odelim + line)

/amn

On Nov 6, 2005, at 4:20 PM, Nicolas Lehuen wrote:

&gt;<i> OK, it looks like Alexis' fix solves the problem with ugh.pdf  
</I>&gt;<i> without breaking the other unit tests. So I think we can safely  
</I>&gt;<i> integrate his patch. Shall I do it ?
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Nicolas
</I>&gt;<i>
</I>&gt;<i> 2005/11/6, Nicolas Lehuen &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">nicolas.lehuen at gmail.com</A>&gt;:
</I>&gt;<i> Hi guys,
</I>&gt;<i>
</I>&gt;<i> In the pure &quot;if it ain't tested, it ain't fixed&quot; fashion, I've  
</I>&gt;<i> added a unit test for file upload to the test suite. It uploads a  
</I>&gt;<i> randomly generated 1 MB file to the server, and check that the MD5  
</I>&gt;<i> digest returned by the server is correct. I could not reproduce  
</I>&gt;<i> Alexis' bug report this way, however. But I then I added a test  
</I>&gt;<i> with the UNIX-HATERS handbook file ugh.pdf, and bang, here comes  
</I>&gt;<i> the bug.
</I>&gt;<i>
</I>&gt;<i> I've checked in both unit tests into subversion, so that you can  
</I>&gt;<i> play with them. I'm now going to test Alexis' fix.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Nicolas
</I>&gt;<i>
</I>&gt;<i> 2005/11/6, Alexis Marrero &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">amarrero at mitre.org</A>&gt;:
</I>&gt;<i> I don't have a function that creates the files but the I can point
</I>&gt;<i> you to a file that has the problem, ironically is &quot;Unix Haters
</I>&gt;<i> Handbook&quot; :) Well, at least is not the Python HH....
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://research.microsoft.com/~daniel/uhh-download.html">http://research.microsoft.com/~daniel/uhh-download.html</A>
</I>&gt;<i>
</I>&gt;<i> It's MD5 is 9e8c42be55aac825e7a34d448044d0fe. I don't know what it
</I>&gt;<i> ends up been after upload with read_to_boundary().
</I>&gt;<i>
</I>&gt;<i> When you use the function to copy the file you will see that the
</I>&gt;<i> digest will be e45979254297b0ece9c182a789d7966e.
</I>&gt;<i>
</I>&gt;<i> I have other 5 files out of 78546 files that I'm testing it against
</I>&gt;<i> that have the same issues, coincidentally there are all PDF files.
</I>&gt;<i> Here is the script that I was testing it with.
</I>&gt;<i>
</I>&gt;<i> def read_to_boundary(self, req, boundary, file):
</I>&gt;<i>      ''' read from the request object line by line with a maximum  
</I>&gt;<i> size,
</I>&gt;<i>          until the new line starts with boundary
</I>&gt;<i>      '''
</I>&gt;<i>      previous_delimiter = ''
</I>&gt;<i>      while 1:
</I>&gt;<i>          line = req.readline(1&lt;&lt;16)
</I>&gt;<i>          if line.startswith(boundary):
</I>&gt;<i>              break
</I>&gt;<i>
</I>&gt;<i>          if line.endswith('\r\n'):
</I>&gt;<i>              file.write(previous_delimiter + line[:-2])
</I>&gt;<i>              previous_delimiter = '\r\n'
</I>&gt;<i>
</I>&gt;<i>          elif line.endswith('\r') or line.endswith('\n'):
</I>&gt;<i>              file.write(previous_delimiter + line[:-1])
</I>&gt;<i>              previous_delimiter = line[-1:]
</I>&gt;<i>
</I>&gt;<i>          else:
</I>&gt;<i>              file.write(previous_delimiter + line)
</I>&gt;<i>              previous_delimiter = ''
</I>&gt;<i>
</I>&gt;<i> #f = file('Perl Bookshelf [4th Ed]/mre/final/ch06.pdf.new', 'a+')
</I>&gt;<i> #f = file('Pages User Guide.app/Contents/Resources/Italian.lproj/
</I>&gt;<i> Pages Manuale Utente.pdf', 'a+')
</I>&gt;<i> f = file('ugh.pdf.new', 'a+')
</I>&gt;<i> f.write('\r\n--myboundary--\r\n')
</I>&gt;<i> f.seek(0)
</I>&gt;<i> o = file('test.bin', 'wb')
</I>&gt;<i> read_to_boundary(None, f, '--myboundary', o)
</I>&gt;<i> o.close()
</I>&gt;<i>
</I>&gt;<i> /amn
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Nov 6, 2005, at 11:58 AM, Jim Gallacher wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Alexis,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I wanted to add that I'm testing your code.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Alexis Marrero wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Let me know any comments on it and if you test it and fails please
</I>&gt;<i> &gt;&gt; also let me know. I don't have subversion account neither I don't
</I>&gt;<i> &gt;&gt; know how to use it thus this email.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; You don't need an account to use subversion anonymously. Just
</I>&gt;<i> &gt; install subversion and grab a mod_python working copy.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; $ svn co <A HREF="http://svn.apache.org/repos/asf/httpd/mod_python/trunk">http://svn.apache.org/repos/asf/httpd/mod_python/trunk</A>  
</I>&gt;<i> trunk
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This will checkout a working copy into a new directory called
</I>&gt;<i> &gt; &quot;trunk&quot; on  your machine. All of the following commands assume you
</I>&gt;<i> &gt; are working in trunk/.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Make your changes in your working copy, and then create a diff with:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; $ svn diff lib/python/mod_python/util.py &gt; your-patch.diff
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The other commands which you'll find immediately useful are:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; svn update    - update your working copy from the repository
</I>&gt;<i> &gt; svn status    - shows status of changes in your working copy
</I>&gt;<i> &gt; svn -u status    - shows status of your copy against the repository
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've found &quot;Version Control with Subverion&quot; is an excellent
</I>&gt;<i> &gt; resource and is available online.
</I>&gt;<i> &gt; <A HREF="http://svnbook.red-bean.com/en/1.1/index.html">http://svnbook.red-bean.com/en/1.1/index.html</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Jim
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20051106/0623c096/attachment.html">http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20051106/0623c096/attachment.html</A>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019469.html">Developer FAQ (was Re: [mod_python]
	mod_python.util.StorageField.read_to_boundary
	has	problems in 3.1 and 3.2)
</A></li>
	<LI>Next message: <A HREF="019471.html">[mod_python] [SPAM] Is mod_python 3.1 good in commercial
	blogging/CMS programming?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19470">[ date ]</a>
              <a href="thread.html#19470">[ thread ]</a>
              <a href="subject.html#19470">[ subject ]</a>
              <a href="author.html#19470">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
