<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Apache2, mod_python and nss_ldap: Coredump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Apache2%2C%20mod_python%20and%20nss_ldap%3A%20Coredump&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019491.html">
   <LINK REL="Next"  HREF="019505.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Apache2, mod_python and nss_ldap: Coredump</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Johan Str&#246;m</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Apache2%2C%20mod_python%20and%20nss_ldap%3A%20Coredump&In-Reply-To="
       TITLE="[mod_python] Apache2, mod_python and nss_ldap: Coredump">johan at stromnet.org
       </A><BR>
    <I>Wed Nov  9 07:46:37 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="019491.html">[mod_python] mod_python module path
</A></li>
        <LI>Next message: <A HREF="019505.html">[mod_python] Re: Apache2, mod_python and nss_ldap: Coredump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19497">[ date ]</a>
              <a href="thread.html#19497">[ thread ]</a>
              <a href="subject.html#19497">[ subject ]</a>
              <a href="author.html#19497">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

I got a new FreeBSD 6 box. Rebuilt kernel and world 2 hours ago  
(against RELENG_6), so it should be pretty new.

Im trying to have apache 2.0.55, mod_python 3.1.4 and nss_ldap 239,  
all the latest from ports.
The problem I have is this: If i have LoadModule python_module       
libexec/apache2/mod_python.so in my httpd.conf, and at the same time  
have either
&quot;group: files ldap&quot; and/or &quot;passwd: files ldap&quot; in my nsswitch.conf,  
i get Segfaults. Example:

<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">root at elfi2</A>:~$ apachectl configtest
Syntax OK
Segmentation fault (core dumped)
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">root at elfi2</A>:~$

However, apache itself is running fine, even using mod_python.
If i remove either the LoadModule or both the ldap-entrys in  
nsswitch, the segfaults dissappear. I've compiled httpd with debug  
symbols, and this is what I found with gdb (httpd -t is same as  
apachectl configtest):

<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">root at elfi2</A>:~$ gdb httpd
GNU gdb 6.1.1 [FreeBSD]
Copyright 2004 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and  
you are
welcome to change it and/or distribute copies of it under certain  
conditions.
Type &quot;show copying&quot; to see the conditions.
There is absolutely no warranty for GDB.  Type &quot;show warranty&quot; for  
details.
This GDB was configured as &quot;i386-marcel-freebsd&quot;...
(gdb) run -t
Starting program: /usr/local/sbin/httpd -t
warning: Unable to get location for thread creation breakpoint:  
generic error
[New LWP 100104]
[New Thread 0x80ab000 (LWP 100104)]
Warning: DocumentRoot [/usr/local/nagios/share] does not exist
Syntax OK

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x80ab000 (LWP 100104)]
0x00000000 in ?? ()
(gdb) where
#0  0x00000000 in ?? ()
#1  0x28be6744 in ?? () from /usr/local/lib/nss_ldap.so.1
#2  0x28bf2200 in ?? () from /usr/local/lib/nss_ldap.so.1
#3  0x280ba3d8 in ?? () from /libexec/ld-elf.so.1
#4  0xbfbfe618 in ?? ()
#5  0x280a0b26 in _rtld_error () from /libexec/ld-elf.so.1
#6  0x28bef998 in _fini () from /usr/local/lib/nss_ldap.so.1
#7  0x280b9018 in tls_dtv_generation () from /libexec/ld-elf.so.1
#8  0x280ba3d8 in ?? () from /libexec/ld-elf.so.1
#9  0xbfbfe628 in ?? ()
#10 0x280a1076 in elf_hash () from /libexec/ld-elf.so.1
#11 0x280a3958 in dlclose () from /libexec/ld-elf.so.1
#12 0x284de64c in _nsdbtaddsrc () from /lib/libc.so.6
#13 0x284de20f in endhostent () from /lib/libc.so.6
#14 0x284de6cc in _nsdbtaddsrc () from /lib/libc.so.6
#15 0x284fd35f in __cxa_finalize () from /lib/libc.so.6
#16 0x284fcf9a in exit () from /lib/libc.so.6
#17 0x0806f0ee in destroy_and_exit_process (process=0x80b6098,  
process_exit_value=0) at main.c:216
#18 0x0806faa6 in main (argc=2, argv=0xbfbfe838) at main.c:565
(gdb)

So, seems the segfault appears when apache calls exit(), explains why  
it seems to work good otherwise...
Googling gave me some similar problem (bug 65220), however that bug  
seemd to affect other programs, so far I've only encountered this  
problem with apache.
Currently I've compiled apache with the following:

portinstall apache-2.0.55 -M &quot;WITH_DBM=bdb WITH_BERKELEYDB=db4  
WITH_LDAP=1 WITH_MPM=prefork WITH_THREADS=yes  
WITH_THREADS_MODULES=yes WITH_DEBUG=1&quot;

The threads stuff was added after some suspect gdb'ing around a  
pthread function (can't remember exact name now.. something  
pthread_cancel.. the symptoms where the same, segfault just before  
exit).
mod_python is installed without any special options, there isnt realy  
any (ie no option to turn of threads).

I've also tried compiling python without threads, then apache without  
threads, then modpython.. same problem.

Does anyone have any clue about whats going on here?
Don't realy know where the problem lies, so I've sent this here , to  
apache-user and to freebsd-stable (<A HREF="http://lists.freebsd.org/pipermail/">http://lists.freebsd.org/pipermail/</A> 
freebsd-stable/2005-November/019476.html).

Thanks!
Johan


---------------------------------------------------------------------
The official User-To-User support forum of the Apache HTTP Server  
Project.
See &lt;URL:<A HREF="http://httpd.apache.org/userslist.html">http://httpd.apache.org/userslist.html</A>&gt; for more info.
To unsubscribe, e-mail: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">users-unsubscribe at httpd.apache.org</A>
   &quot;   from the digest: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">users-digest-unsubscribe at httpd.apache.org</A>
For additional commands, e-mail: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">users-help at httpd.apache.org</A>

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019491.html">[mod_python] mod_python module path
</A></li>
	<LI>Next message: <A HREF="019505.html">[mod_python] Re: Apache2, mod_python and nss_ldap: Coredump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19497">[ date ]</a>
              <a href="thread.html#19497">[ thread ]</a>
              <a href="subject.html#19497">[ subject ]</a>
              <a href="author.html#19497">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
