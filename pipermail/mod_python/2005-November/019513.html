<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] handlers and globals
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20handlers%20and%20globals&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019512.html">
   <LINK REL="Next"  HREF="019518.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] handlers and globals</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20handlers%20and%20globals&In-Reply-To="
       TITLE="[mod_python] handlers and globals">grahamd at dscpl.com.au
       </A><BR>
    <I>Thu Nov 10 22:58:10 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="019512.html">[mod_python] Cookie problems with mobile phones
</A></li>
        <LI>Next message: <A HREF="019518.html">[mod_python] handlers and globals
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19513">[ date ]</a>
              <a href="thread.html#19513">[ thread ]</a>
              <a href="subject.html#19513">[ subject ]</a>
              <a href="author.html#19513">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Use this:

     # but this doesn't...
     #rc = profile.run( 'processPsp()', 'ProfilerTest.psp.prof' )
     #return rc
     
     pobject = profile.Profile()
     presult = pobject.runctx('processPsp()',globals(),locals())
     presult.dump_stats(&quot;/tmp/ProfilerTest.psp.prof&quot;)

The default run() method uses globals from __main__ module and
thus why it can't find symbol.

Also need to specify absolute path for where stats are being saved
as no gaurantee as to what current working directory is when run
in the context of mod_python.

To print out stats do the following, although a single call doesn't
give you enough data for meaningful time values unless there is
something I missed.

/tmp [504]$ python
Python 2.3 (#1, Sep 13 2003, 00:49:11) 
[GCC 3.3 20030304 (Apple Computer, Inc. build 1495)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt;<i> import pstats
</I>&gt;&gt;&gt;<i> stats = pstats.Stats(&quot;/tmp/ProfilerTest.psp.prof&quot;)
</I>&gt;&gt;&gt;<i> stats.print_stats()
</I>Fri Nov 11 14:14:46 2005    /tmp/stats.dat

         19 function calls in 0.000 CPU seconds

   Random listing order was used

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py:123(cache_get)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py:60(__init__)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/posixpath.py:74(split)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py:91(__init__)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/posixpath.py:47(isabs)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/posixpath.py:197(isfile)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/posixpath.py:144(getmtime)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py:139(cache_store)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py:403(store)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/posixpath.py:56(join)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/stat.py:29(S_IFMT)
        1    0.000    0.000    0.000    0.000 /Users/grahamd/Sites/profiler/ProfilerTest.psp:1(?)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py:186(run)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/stat.py:54(S_ISREG)
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py:408(get)
        1    0.000    0.000    0.000    0.000 /Users/grahamd/Sites/profiler/profiler-handler.py:11(processPsp)
        0    0.000             0.000          profile:0(profiler)
        1    0.000    0.000    0.000    0.000 profile:0(processPsp())
        1    0.000    0.000    0.000    0.000 /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py:159(load_from_file)
        1    0.000    0.000    0.000    0.000 &lt;string&gt;:1(?)


&lt;pstats.Stats instance at 0x41d78&gt;


Graham


Neil Gower wrote ..
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I'm having some trouble trying to run my PSP pages through the standard
</I>&gt;<i> Python profiler.  The problem appears to be that the python globals don't
</I>&gt;<i> behave as the profiler expects when it is run through mod_python.
</I>&gt;<i> 
</I>&gt;<i> The test handler (below) works okay with the profiler when invoked from
</I>&gt;<i> a 
</I>&gt;<i> regular command line Python interpreter, but it raises a &quot;NameError: name
</I>&gt;<i> 'processPsp' is not defined&quot; exception when run through mod_python.  I'm
</I>&gt;<i> taking that to mean that the profiler can't find the processPsp() method
</I>&gt;<i> to 
</I>&gt;<i> invoke.
</I>&gt;<i> 
</I>&gt;<i> Can anyone offer any suggestions?  I'm stumped at this point.
</I>&gt;<i> 
</I>&gt;<i> Thanks!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Neil.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Details of my setup:
</I>&gt;<i> =============================================================================
</I>&gt;<i> Mod_python error: &quot;PythonHandler profiler-handler&quot;
</I>&gt;<i> 
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i> 
</I>&gt;<i>    File &quot;/usr/lib/python2.3/site-packages/mod_python/apache.py&quot;, line 299,
</I>&gt;<i> in 
</I>&gt;<i> HandlerDispatch
</I>&gt;<i>      result = object(req)
</I>&gt;<i> 
</I>&gt;<i>    File &quot;/var/profiler-test/profiler-handler.py&quot;, line 36, in handler
</I>&gt;<i>      rc = profile.run( 'processPsp()', 'ProfilerTest.psp.prof' )
</I>&gt;<i> 
</I>&gt;<i>    File &quot;/usr/lib/python2.3/profile.py&quot;, line 71, in run
</I>&gt;<i>      prof = prof.run(statement)
</I>&gt;<i> 
</I>&gt;<i>    File &quot;/usr/lib/python2.3/profile.py&quot;, line 403, in run
</I>&gt;<i>      return self.runctx(cmd, dict, dict)
</I>&gt;<i> 
</I>&gt;<i>    File &quot;/usr/lib/python2.3/profile.py&quot;, line 409, in runctx
</I>&gt;<i>      exec cmd in globals, locals
</I>&gt;<i> 
</I>&gt;<i>    File &quot;&quot;, line 1, in ?
</I>&gt;<i> 
</I>&gt;<i> NameError: name 'processPsp' is not defined
</I>&gt;<i> =============================================================================
</I>&gt;<i> Apache:
</I>&gt;<i> 
</I>&gt;<i> &lt;Directory &quot;/var/profiler-test&quot;&gt;
</I>&gt;<i>      Options Indexes MultiViews
</I>&gt;<i>      AllowOverride None
</I>&gt;<i>      Order allow,deny
</I>&gt;<i>      Allow from all
</I>&gt;<i> 
</I>&gt;<i>      AddHandler mod_python .psp
</I>&gt;<i>      PythonHandler profiler-handler
</I>&gt;<i>      PythonDebug On
</I>&gt;<i> &lt;/Directory&gt;
</I>&gt;<i> 
</I>&gt;<i> =============================================================================
</I>&gt;<i> /var/profiler-test/ProfilerTest.psp:
</I>&gt;<i> 
</I>&gt;<i> &lt;p&gt;This is a test!
</I>&gt;<i> 
</I>&gt;<i> &lt;%
</I>&gt;<i> req.write( &quot;&lt;p&gt;So is this!&quot; )
</I>&gt;<i> %&gt;
</I>&gt;<i> 
</I>&gt;<i> =============================================================================
</I>&gt;<i> /var/profiler-test/profiler-handler.py:
</I>&gt;<i> 
</I>&gt;<i> # we have to wrap these imports in a try block to be able to run the
</I>&gt;<i> # code outside of mod_python, where they will fail.
</I>&gt;<i> try:
</I>&gt;<i>      from mod_python import apache, psp
</I>&gt;<i> except:
</I>&gt;<i>      pass
</I>&gt;<i> 
</I>&gt;<i> import profile
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> def processPsp():
</I>&gt;<i>      &quot;&quot;&quot;
</I>&gt;<i>      A plain old method that uses global variables for the PSP
</I>&gt;<i>      parameters, which makes it easy to use with the profiler.
</I>&gt;<i>      &quot;&quot;&quot;
</I>&gt;<i>      theRequest.content_type = &quot;text/html&quot;
</I>&gt;<i>      template = psp.PSP( theRequest, theTemplateFile )
</I>&gt;<i>      template.run()
</I>&gt;<i>      return apache.OK
</I>&gt;<i> # end processPsp()
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> def handler( req ):
</I>&gt;<i>      &quot;&quot;&quot;
</I>&gt;<i>      The mod_python hook for handling a page request.
</I>&gt;<i>      &quot;&quot;&quot;
</I>&gt;<i>      global theRequest
</I>&gt;<i>      global theTemplateFile
</I>&gt;<i>      theRequest = req
</I>&gt;<i>      theTemplateFile = 'ProfilerTest.psp'
</I>&gt;<i> 
</I>&gt;<i>      # This works...
</I>&gt;<i>      #rc = processPsp()
</I>&gt;<i> 
</I>&gt;<i>      # but this doesn't...
</I>&gt;<i>      rc = profile.run( 'processPsp()', 'ProfilerTest.psp.prof' )
</I>&gt;<i> 
</I>&gt;<i>      return rc
</I>&gt;<i> # end handler()
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> if __name__ == '__main__':
</I>&gt;<i>      try:
</I>&gt;<i>          handler( None )
</I>&gt;<i>      except AttributeError, e:
</I>&gt;<i>          # if we actually make it into processPsp(), the null request
</I>&gt;<i>          # object will cause an AttributeError.
</I>&gt;<i>          print &quot;A not unexpected error: %s&quot; % str(e)
</I>&gt;<i> # end main.
</I>&gt;<i> =============================================================================
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019512.html">[mod_python] Cookie problems with mobile phones
</A></li>
	<LI>Next message: <A HREF="019518.html">[mod_python] handlers and globals
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19513">[ date ]</a>
              <a href="thread.html#19513">[ thread ]</a>
              <a href="subject.html#19513">[ subject ]</a>
              <a href="author.html#19513">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
