<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] [Vampire] Module partially loaded?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20%5BVampire%5D%20Module%20partially%20loaded%3F&In-Reply-To=c298f2d705070103293bdfe5dd%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018574.html">
   <LINK REL="Next"  HREF="018572.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] [Vampire] Module partially loaded?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20%5BVampire%5D%20Module%20partially%20loaded%3F&In-Reply-To=c298f2d705070103293bdfe5dd%40mail.gmail.com"
       TITLE="[mod_python] [Vampire] Module partially loaded?">grahamd at dscpl.com.au
       </A><BR>
    <I>Fri Jul  1 06:51:05 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="018574.html">[mod_python] Re: [Vampire] Module partially loaded?
</A></li>
        <LI>Next message: <A HREF="018572.html">[mod_python] Re: [Vampire] Module partially loaded?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18573">[ date ]</a>
              <a href="thread.html#18573">[ thread ]</a>
              <a href="subject.html#18573">[ subject ]</a>
              <a href="author.html#18573">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>If things were working properly, that strictly shouldn't be required,
but I do note that I possibly do the wrong thing in the that I update
the mtime in the cache before reimporting the module. This would be
bad if the import fails as it wouldn't try to keep reloading the module
and would instead use the working one loaded into the cache only. But
then, this could also be good as although it would error on one request,
after that it would use the good one still in the cache until the one
on disk was fixed and modification time updated. I may well have done
it intentionally that way, can't remember. :-)

Either way, this issue shouldn't result in a partly loaded broken
module, although I have some other ideas as to why it might be 
occurring?

Graham

On 01/07/2005, at 8:29 PM, Nicolas Lehuen wrote:

&gt;<i> Maybe you can force reload by touching the module's modified timestamp 
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Nicolas
</I>&gt;<i>
</I>&gt;<i> 2005/7/1, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 01/07/2005, at 7:52 AM, Stephane Bortzmeyer wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have a Python module which defines several functions and also
</I>&gt;&gt;&gt;<i> includes a bit a code is executed when the module is imported:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> do_something()
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> def function1():
</I>&gt;&gt;&gt;<i>    ...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If do_something() fails (it connects to a database and the database
</I>&gt;&gt;&gt;<i> server may be down), the rest of the module is not executed, 
</I>&gt;&gt;&gt;<i> function1
</I>&gt;&gt;&gt;<i> is not defined but the module stays loaded: further requests just get
</I>&gt;&gt;&gt;<i> a message that there is no function1 defined.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Restarting Apache is the only solution to get rid of the partly 
</I>&gt;&gt;&gt;<i> loaded
</I>&gt;&gt;&gt;<i> module.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It seems a bug to me: if the module cannot be fully loaded because 
</I>&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;<i> initialization code fails, the module should not be loaded at all, so
</I>&gt;&gt;&gt;<i> that further attempts have a chance to succeed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'll do some checking, but modules are imported using:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          # Perform the actual import of the module.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          try:
</I>&gt;&gt;<i>            execfile(file,module.__dict__)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          except:
</I>&gt;&gt;<i>            # Importation of module has failed for some
</I>&gt;&gt;<i>            # reason. If this is the very first import of
</I>&gt;&gt;<i>            # the module, need to discard the cache entry
</I>&gt;&gt;<i>            # entirely else a subsequent attempt to load
</I>&gt;&gt;<i>            # the module will wrongly think it was
</I>&gt;&gt;<i>            # successfully loaded already.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>            if cache.module is None:
</I>&gt;&gt;<i>              del self._cache[label]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>            raise
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thus, an exception on import is explicitly detected but only
</I>&gt;&gt;<i> for the purpose of ensuring that if this is the first time
</I>&gt;&gt;<i> that the module is being imported that the cache is cleared
</I>&gt;&gt;<i> of the partially constructed entry. If this isn't done then on
</I>&gt;&gt;<i> next import attempt it may think it has been loaded and
</I>&gt;&gt;<i> module reference will be None.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In either case, the error is propagated and the failed module
</I>&gt;&gt;<i> should be thrown away.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is the module the error occurs in being explicitly loaded
</I>&gt;&gt;<i> using vampire.importModule() or using the &quot;import&quot; statement
</I>&gt;&gt;<i> and relying on the import hook to call vampire.importModule()
</I>&gt;&gt;<i> for you? Also, does it happen on the first loading of the
</I>&gt;&gt;<i> module or has the module been changed and is it on a reload?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Graham
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018574.html">[mod_python] Re: [Vampire] Module partially loaded?
</A></li>
	<LI>Next message: <A HREF="018572.html">[mod_python] Re: [Vampire] Module partially loaded?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18573">[ date ]</a>
              <a href="thread.html#18573">[ thread ]</a>
              <a href="subject.html#18573">[ subject ]</a>
              <a href="author.html#18573">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
