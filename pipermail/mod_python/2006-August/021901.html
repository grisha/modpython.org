<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: PyThreadState_Swap(NULL)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20PyThreadState_Swap%28NULL%29&In-Reply-To=44E7D53F.1080603%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021900.html">
   <LINK REL="Next"  HREF="021902.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: PyThreadState_Swap(NULL)</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20PyThreadState_Swap%28NULL%29&In-Reply-To=44E7D53F.1080603%40gmail.com"
       TITLE="[mod_python] Re: PyThreadState_Swap(NULL)">grahamd at dscpl.com.au
       </A><BR>
    <I>Sun Aug 20 01:43:30 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021900.html">[mod_python] Re: PyThreadState_Swap(NULL)
</A></li>
        <LI>Next message: <A HREF="021902.html">[mod_python] Re: PyThreadState_Swap(NULL)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21901">[ date ]</a>
              <a href="thread.html#21901">[ thread ]</a>
              <a href="subject.html#21901">[ subject ]</a>
              <a href="author.html#21901">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 20/08/2006, at 1:21 PM, Bryan wrote:

&gt;<i> Graham Dumpleton wrote:
</I>&gt;&gt;&gt;<i> For a start, which version of mod_python are you using? There  
</I>&gt;&gt;&gt;<i> were some
</I>&gt;&gt;&gt;<i> important changes in mod_python 3.2.8 to allow third party  
</I>&gt;&gt;&gt;<i> modules for
</I>&gt;&gt;&gt;<i> Python to work properly where those third party modules used the  
</I>&gt;&gt;&gt;<i> simple
</I>&gt;&gt;&gt;<i> GIL API for thread management.
</I>&gt;&gt;<i> Whoops, that should be mod_python 3.2.10. Not 3.2.8.
</I>&gt;&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> hi graham,
</I>&gt;<i>
</I>&gt;<i> we are using mod_python 3.2.10.  you are right that we are doing  
</I>&gt;<i> something similar to mod_python in that we fully embed python to  
</I>&gt;<i> process requests using our protocol.  the difference is that our  
</I>&gt;<i> main protocol and message dispatcher has nothing to do with apache  
</I>&gt;<i> and can plug into our own proprietary server as well as 3rd party  
</I>&gt;<i> servers. our mod_xxx module is really just an adapter to let our  
</I>&gt;<i> dispatcher plug into apache.  and our python adapter is a plug into  
</I>&gt;<i> our dispatcher along with other language adapters.  this is a  
</I>&gt;<i> snippet of our code and shows you where the failure is.  the  
</I>&gt;<i> failure occurs in the start function and g_py_main_interpreter  
</I>&gt;<i> returned by PyThreadState_Swap(NULL) is NULL.  i wouldn't mind  
</I>&gt;<i> grabbing your latest code from svn and looking at your new API,  
</I>&gt;<i> except that i'm not sure using experimental code at this phase of  
</I>&gt;<i> development process would be wise.  also, if i read what you wrote  
</I>&gt;<i> correctly, i would need to tie our code to use the mod_python  
</I>&gt;<i> framework and i'm not willing to do that since our python adapter  
</I>&gt;<i> has no knowledge of apache.  unless i'm wrong, i believe the only  
</I>&gt;<i> real solution at this point is to use two apache processes. one  
</I>&gt;<i> that includes mod_python which we use for cgi gui apps, and the  
</I>&gt;<i> other with our dispatcher so there would be no conflicts.  this  
</I>&gt;<i> wouldn't be an optimal solution, but it's doable.
</I>
I'd have to look over your code and try and get my head around all this
stuff again, but I really think you will be fighting an uphill battle  
to get
something going which doesn't try and work in co-operation with
mod_python some how.

One of the first problems is that mod_python is the one to create the
first interpreter and this first interpreter is special. If a Python  
module
has a C code component and it isn't written in just the right way so as
to work with interpreters other than the first, then it will have  
problems.
Usually this manifests as Python code running in a restricted  
environment
and not able to access various stuff, but other things could also  
happen,
including lock ups and crashes.

The other problem you will have is that Apache on Win32 and also
worker MPM on UNIX is multithreaded and even more work is required
to get that to work properly. I don't see anything in your code that
suggests that it takes multithreading and multiple interpreters into
consideration.

In the short term, using a separate Apache instance as you suggest
will probably be your only quick solution. In the long term, I still  
think
using the proposed API for mod_python is the only way it is going to
work.

You shouldn't have a problem with this if your code is sufficiently  
layered.
That is, the real part of the code which does the work should be written
just like a normal Python extension module which could be loaded into
any command line Python. You would then have two other distinct bits of
code for embedding. Both of these merely setup the interpreter  
environment
and then import your normal Python module and execute it. One of these
bits of code would be for embedding in a standalone application and
the other variant one that works in conjunction with mod_python to allow
embedding when Apache is used and mod_python is also used. If
necessary you can have a variant of Apache module which works when
mod_python is not present.

As I said, if your code is correctly layered and componentised, this  
should
not result in all your code being dependent on mod_python.

Oh, one final possibility that may be possible, especially if your code
were properly layered and your core code is loadable as a Python
module, is simply to import that code Python module from a module
imported in mod_python using PythonImport and trigger it from that.
If necessary, the Apache handlers your have written in mod_xxx could
be written as mod_python handlers instead. Since you don't really
say what mod_xxx does though, I can't really comment on whether
this would be practical.

Graham
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021900.html">[mod_python] Re: PyThreadState_Swap(NULL)
</A></li>
	<LI>Next message: <A HREF="021902.html">[mod_python] Re: PyThreadState_Swap(NULL)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21901">[ date ]</a>
              <a href="thread.html#21901">[ thread ]</a>
              <a href="subject.html#21901">[ subject ]</a>
              <a href="author.html#21901">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
