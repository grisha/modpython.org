<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Setting req-&gt;user for mod_dav_svn (SOLVED)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Setting%20req-%3Euser%20for%20mod_dav_svn%20%28SOLVED%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021705.html">
   <LINK REL="Next"  HREF="021707.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Setting req-&gt;user for mod_dav_svn (SOLVED)</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Deron Meranda</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Setting%20req-%3Euser%20for%20mod_dav_svn%20%28SOLVED%29&In-Reply-To="
       TITLE="[mod_python] Setting req-&gt;user for mod_dav_svn (SOLVED)">deron.meranda at gmail.com
       </A><BR>
    <I>Tue Aug  1 15:15:15 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021705.html">[mod_python] Setting req-&gt;user for mod_dav_svn
</A></li>
        <LI>Next message: <A HREF="021707.html">[mod_python] Upload progress indicator shows after upload?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21706">[ date ]</a>
              <a href="thread.html#21706">[ thread ]</a>
              <a href="subject.html#21706">[ subject ]</a>
              <a href="author.html#21706">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I finally got it working!  (Thanks Graham and Jim)

I apparently had a logic error in my complex access handler.  After
simplifying things to the bare minimum I can now use mod_python to set
the subversion user.

For those who are potentially interested, here's a simple illustrative
example of how to use mod_python along with subversion, whereby the
python handler *simulates* a BASIC auth (username and password), but
without using any of the built-in Apache Auth*, Satisfy*, Limit*, or
Requires* directives.

# In Apache config
&lt;Location /svn&gt;
  DAV svn
  SVNPath /path/to/svn/repo
  PythonAccessHandler myauth::setuser
&lt;/Location&gt;

# File myauth.py
def decode_basic_auth(req):
    try:
        autype, auparm = req.headers_in['Authorization'].split()
        if autype.upper() != 'BASIC':
            return None
        import base64
        auparm = base64.decodestring( auparm )
        auuser, aupass = auparm.split( ':', 1 )
        return auuser, aupass
    except:
        return None

def setuser(req):
    basicauth = decode_basic_auth(req)
    if req.method in ('GET','PROPFIND','OPTIONS','REPORT','HEAD'):
        pass  # Allow anonymous read-only access
    else:
        # A non-read-only method requires authentication
        okay = False
        if basicauth:
            ba_user, ba_pass = basicauth
            if ba_user == ba_pass:  # Replace with real pw validate later
                req.user = ba_user   # Set the username as appears in
subversion logs
                okay = True
        if not okay:
            # Force UA to send authentication
            req.err_headers_out['WWW-Authenticate'] = 'BASIC realm=&quot;Subversion&quot;'
            raise apache.SERVER_RETURN, apache.HTTP_UNAUTHORIZED
    return apache.OK

In actuality setting the req.user seems to work as long as you do it
in any phase all the way through the PythonFixupHandler.

For the curious, a typical subversion commit of changes to a single
file results in a flurry of HTTP requests with different methods, such
as follows.  Obviously if you do this for real you'll want to keep
your authentication phase quick.  You do not need to set req.user for
the read-only methods (if you allow anonymous read-only access), but
it is important that for any of the other methods you always set
req.user to the SAME string (otherwise you'll get a 501 error from
mod_dav_svn complaining it can't do multi-user commits).

  OPTIONS
  MKACTIVITY
  PROPFIND
  PROPFIND
  CHECKOUT
  PROPPATCH
  PROPFIND
  CHECKOUT
  PUT
  GET
  MERGE
  MERGE
  DELETE
  PROPFIND
  PROPFIND
  REPORT
  GET
  ... lots more GETS ...

-- 
Deron Meranda
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021705.html">[mod_python] Setting req-&gt;user for mod_dav_svn
</A></li>
	<LI>Next message: <A HREF="021707.html">[mod_python] Upload progress indicator shows after upload?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21706">[ date ]</a>
              <a href="thread.html#21706">[ thread ]</a>
              <a href="subject.html#21706">[ subject ]</a>
              <a href="author.html#21706">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
