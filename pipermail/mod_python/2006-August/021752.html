<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] req.sendfile() problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20req.sendfile%28%29%20problem&In-Reply-To=44D378FD.1070102%40jgassociates.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021744.html">
   <LINK REL="Next"  HREF="021743.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] req.sendfile() problem</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20req.sendfile%28%29%20problem&In-Reply-To=44D378FD.1070102%40jgassociates.ca"
       TITLE="[mod_python] req.sendfile() problem">grahamd at dscpl.com.au
       </A><BR>
    <I>Fri Aug  4 22:51:01 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021744.html">[mod_python] req.sendfile() problem
</A></li>
        <LI>Next message: <A HREF="021743.html">[mod_python] Talk on what is coming in mod_python 3.3.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21752">[ date ]</a>
              <a href="thread.html#21752">[ thread ]</a>
              <a href="subject.html#21752">[ subject ]</a>
              <a href="author.html#21752">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 05/08/2006, at 2:42 AM, Jim Gallacher wrote:

&gt;<i> Thomas J. Schirripa wrote:
</I>&gt;&gt;<i> def handler(req):
</I>&gt;&gt;<i> 	fields = util.FieldStorage(req)
</I>&gt;&gt;<i>         #Note: the filename is an absolute path, so I am going to  
</I>&gt;&gt;<i> split that up into directory and filename for clarity
</I>&gt;&gt;<i> 	filename = os.path.basename(fields[&quot;filename&quot;])
</I>&gt;&gt;<i> 	path = os.path.dirname(fields[&quot;filename&quot;])
</I>&gt;&gt;<i> 	req.headers_out[&quot;Content-Disposition&quot;] = &quot;attachment; filename=% 
</I>&gt;&gt;<i> s&quot; % filename
</I>&gt;&gt;<i> 	req.content_type = &quot;text/plain&quot;
</I>&gt;&gt;<i> 	req.sendfile(&quot;%s/%s&quot; % (directory, filename))
</I>&gt;&gt;<i> 	return apache.OK
</I>&gt;<i>
</I>&gt;<i> Also, it goes without saying that the filename provided
</I>&gt;<i> by in the request should not be trusted. Do some checking to ensure it
</I>&gt;<i> is valid value.
</I>
What Jim has pointed out can't be overemphasised enough. The way your  
script
is written I could potentially steal you /etc/passwd file and much more.

What you should at least do is something like the following:

ALLOWED_PREFIX = '/some/path/to/fetchable/files'

def handler(req):
     ...

     fullpath = os.path.normpath(fields['filename'])
     if not fullpath.startswith(ALLOWED_PREFIX):
         return apache.HTTP_BAD_REQUEST

The os.path.normpath() eliminates any '.' and '..' directory  
references. You then
check to ensure the path then actually begins with the path prefix  
for where your
files actually live.

Better still, do not use an absolute path, instead only ever send  
back a relative
path. You should still use os.path.normpath() to eliminate '.' and  
'..' references.
Then, you add the relative path to a path prefix which is only  
defined within
your script. In other words, you never send the path prefix back to  
the client.

Graham
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021744.html">[mod_python] req.sendfile() problem
</A></li>
	<LI>Next message: <A HREF="021743.html">[mod_python] Talk on what is coming in mod_python 3.3.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21752">[ date ]</a>
              <a href="thread.html#21752">[ thread ]</a>
              <a href="subject.html#21752">[ subject ]</a>
              <a href="author.html#21752">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
