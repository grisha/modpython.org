<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Using threading.local with Worker MPM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Using%20threading.local%20with%20Worker%20MPM&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021884.html">
   <LINK REL="Next"  HREF="021855.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Using threading.local with Worker MPM</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Gavin Panella</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Using%20threading.local%20with%20Worker%20MPM&In-Reply-To="
       TITLE="[mod_python] Using threading.local with Worker MPM">gavin at premolo.com
       </A><BR>
    <I>Wed Aug 16 16:19:31 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021884.html">[mod_python] server shutdown [was] i beg...
</A></li>
        <LI>Next message: <A HREF="021855.html">[mod_python] Using threading.local with Worker MPM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21854">[ date ]</a>
              <a href="thread.html#21854">[ thread ]</a>
              <a href="subject.html#21854">[ subject ]</a>
              <a href="author.html#21854">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I was using a PythonInitHandler to set up various objects for the rest of my 
request. I set up a shared 'space' object which is based on threading.local 
because this code needs to run in several different scenarios, not just under 
mod_python, or even in a web context. However, any object I put into 
the 'space' in the PythonInitHandler was disappearing by the time the main 
PythonHandler started.

I traced it down to the fact that threading.local was presenting a different 
__dict__ to the PythonInitHandler from the PythonHandler. However, they're 
both running in the same thread, one after the other. Somewhere between the 
PythonInitHandler and the rest of the code, the threading.local object 
decides to switch the __dict__. It doesn't clear the __dict__, it is a 
different instance (the id changes).

Does anyone know of a reason when the this might happen? Does mod_python do 
something under the bonnet to confuse threading.local? I have a workaround 
(do everything in the PythonHandler), but I'd still like to know the root 
cause.

It took hours to track down this behaviour, and today I've also been having 
lots of fun with PythonAuthzHandler (which I eventually abandoned) so it's 
been a very frustrating and non-productive kind of day :-) Please, someone 
help me!

I'm running Python 2.4.3, Apache 2.0.58, and mod_python 3.1.4 on Gentoo.

Thanks!

Gavin Panella.


-- 
Premolo S&#224;rl
Web: <A HREF="http://www.premolo.com/">http://www.premolo.com/</A> ; Tel: +352 26687161 ; GSM: +352 091739359
42 rue du Kiem, L-1857 Luxembourg, Grand-Duch&#233; du Luxembourg

</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021884.html">[mod_python] server shutdown [was] i beg...
</A></li>
	<LI>Next message: <A HREF="021855.html">[mod_python] Using threading.local with Worker MPM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21854">[ date ]</a>
              <a href="thread.html#21854">[ thread ]</a>
              <a href="subject.html#21854">[ subject ]</a>
              <a href="author.html#21854">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
