<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] server shutdown [was] i beg...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20server%20shutdown%20%5Bwas%5D%20i%20beg...&In-Reply-To=DB03AC04-3385-4AB2-A199-0EAD40203137%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021871.html">
   <LINK REL="Next"  HREF="021879.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] server shutdown [was] i beg...</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>David Fraser</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20server%20shutdown%20%5Bwas%5D%20i%20beg...&In-Reply-To=DB03AC04-3385-4AB2-A199-0EAD40203137%40dscpl.com.au"
       TITLE="[mod_python] server shutdown [was] i beg...">davidf at sjsoft.com
       </A><BR>
    <I>Fri Aug 18 10:52:17 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021871.html">[mod_python] server shutdown [was] i beg...
</A></li>
        <LI>Next message: <A HREF="021879.html">[mod_python] server shutdown [was] i beg...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21878">[ date ]</a>
              <a href="thread.html#21878">[ thread ]</a>
              <a href="subject.html#21878">[ subject ]</a>
              <a href="author.html#21878">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Graham Dumpleton wrote:
&gt;<i>
</I>&gt;<i> On 18/08/2006, at 7:48 PM, Richard Lewis wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On Tuesday 15 August 2006 23:31, Graham Dumpleton wrote:
</I>&gt;&gt;&gt;<i> Richard Lewis wrote ..
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Do you mean that there will be no opportunity to have code run at 
</I>&gt;&gt;&gt;&gt;<i> server
</I>&gt;&gt;&gt;&gt;<i> shutdown?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Correct. Reason being that it doesn't actually work most of the time
</I>&gt;&gt;&gt;<i> anyway.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Because of how Apache is implemented, there is no reliable/safe way of
</I>&gt;&gt;&gt;<i> implementing this feature. If one can't do it properly, it seems 
</I>&gt;&gt;&gt;<i> better not
</I>&gt;&gt;&gt;<i> to attempt it at all.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Goodness! So, in my mod_python applications I often acquire database 
</I>&gt;&gt;<i> handles
</I>&gt;&gt;<i> and store them in objects outside of the handler() function so that they
</I>&gt;&gt;<i> persist between requests. (This is to avoid the expense of acquiring 
</I>&gt;&gt;<i> a new
</I>&gt;&gt;<i> handle for every request).
</I>&gt;<i>
</I>&gt;<i> And you can still do that.
</I>&gt;<i>
</I>&gt;&gt;<i> I then use a cleanup() function to release those
</I>&gt;&gt;<i> database handles.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The implication of this is that I will no longer be able to release the
</I>&gt;&gt;<i> handles at server shutdown, yes?
</I>&gt;<i>
</I>&gt;<i> I think you miss what I have been saying. That it doesn't work now. If 
</I>&gt;<i> you
</I>&gt;<i> were to put calls to apache.log_error() in your cleanup handler and 
</I>&gt;<i> shutdown
</I>&gt;<i> Apache when it is handling a decent amount of traffic, you will probably
</I>&gt;<i> find your cleanup functions aren't actually being called, or if they 
</I>&gt;<i> do, they
</I>&gt;<i> might not exit and will hang at some point. What you are more likely 
</I>&gt;<i> to see
</I>&gt;<i> in the Apache log is a series of SIGTERM signals being sent and then a
</I>&gt;<i> SIGKILL signal which is forcibly killing off the process.
</I>&gt;<i>
</I>&gt;&gt;<i> Can anyone suggest an alternative method of
</I>&gt;&gt;<i> doing this? Are there any Python tricks where you can execute code 
</I>&gt;&gt;<i> when the
</I>&gt;&gt;<i> interpreter itself is about to stop?
</I>&gt;<i>
</I>&gt;<i> Python does have means of calling code on application shutdown, but
</I>&gt;<i> because of how Apache uses signals to shutdown processes and how
</I>&gt;<i> the Apache main loop works, with the main loop being managed
</I>&gt;<i> by Apache and not Python they can't be used either.
</I>&gt;<i>
</I>&gt;&gt;<i> Or could I have a Python script running
</I>&gt;&gt;<i> in another process which &quot;looks in&quot; to the mod_python process and
</I>&gt;&gt;<i> periodically cleanly releases database handles?
</I>&gt;<i>
</I>&gt;<i> No.
</I>&gt;<i>
</I>&gt;<i> In the greater scheme of things it shouldn't ultimately matter. This 
</I>&gt;<i> is because
</I>&gt;<i> your database server is going to notice that the connections to it 
</I>&gt;<i> have been
</I>&gt;<i> dropped and will cleanup the resources on its side anyway. It has to 
</I>&gt;<i> do this
</I>&gt;<i> as there is nothing to say that Apache or any client process connecting
</I>&gt;<i> to it will not simply crash without cleanly disconnecting. In other 
</I>&gt;<i> words, you
</I>&gt;<i> will not get resource leaks. That things didn't get cleanup in the 
</I>&gt;<i> Apache child
</I>&gt;<i> process doesn't matter as it has been killed anyway, with all its 
</I>&gt;<i> memory being
</I>&gt;<i> released back to operating system. 
</I>So you are saying:
1) There is a mechanism for cleaning up code
2) This mechanism is not reliable
3) Since databases have to assume clients are not reliable, they clean 
up for them anyway
4) Therefore we should not even try to clean up

I'm with you on points 1, 2, and 3, but I think point 4 is taking it a 
bit too far...
Surely there must be *some* value in trying to clean up behind yourself, 
sometimes?

David
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021871.html">[mod_python] server shutdown [was] i beg...
</A></li>
	<LI>Next message: <A HREF="021879.html">[mod_python] server shutdown [was] i beg...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21878">[ date ]</a>
              <a href="thread.html#21878">[ thread ]</a>
              <a href="subject.html#21878">[ subject ]</a>
              <a href="author.html#21878">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
