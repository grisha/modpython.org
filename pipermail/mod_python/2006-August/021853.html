<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] i beg the developers to make mod_python can beimport
	in python command line.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20i%20beg%20the%20developers%20to%20make%20mod_python%20can%20beimport%0A%09in%20python%20command%20line.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021849.html">
   <LINK REL="Next"  HREF="021868.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] i beg the developers to make mod_python can beimport
	in python command line.</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20i%20beg%20the%20developers%20to%20make%20mod_python%20can%20beimport%0A%09in%20python%20command%20line.&In-Reply-To="
       TITLE="[mod_python] i beg the developers to make mod_python can beimport
	in python command line.">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Aug 15 18:31:40 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021849.html">[mod_python] i beg the developers to make mod_python can be
	importin python command line.
</A></li>
        <LI>Next message: <A HREF="021868.html">[mod_python] server shutdown [was] i beg...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21853">[ date ]</a>
              <a href="thread.html#21853">[ thread ]</a>
              <a href="subject.html#21853">[ subject ]</a>
              <a href="author.html#21853">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Richard Lewis wrote ..
&gt;<i> On Tuesday 15 August 2006 11:01, you wrote:
</I>&gt;<i> &gt; On 15/08/2006, at 6:53 PM, Richard Lewis wrote:
</I>&gt;<i> &gt; &gt; class server:
</I>&gt;<i> &gt; &gt;     def __init__(self):
</I>&gt;<i> &gt; &gt;         self.cleanup_func = None
</I>&gt;<i> &gt; &gt;         self.server_hostname = &quot;&quot;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;     def register_cleanup(self, req, func):
</I>&gt;<i> &gt; &gt;         self.cleanup_func = func
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Be aware that req.server.register_cleanup() doesn't really work
</I>&gt;<i> &gt; properly and
</I>&gt;<i> &gt; is going to be disabled in mod_python 3.3 such that it doesn't do
</I>&gt;<i> &gt; anything.
</I>&gt;<i> &gt; A stub will still be there so your code at least still runs, but no
</I>&gt;<i> &gt; special actions
</I>&gt;<i> &gt; will performed on server shutdown.
</I>&gt;<i> &gt;
</I>&gt;<i> Do you mean that there will be no opportunity to have code run at server
</I>&gt;<i> shutdown?
</I>
Correct. Reason being that it doesn't actually work most of the time anyway.

The basic problem is that those server cleanups are being run from inside of a
signal handler. If there is any active request occurring which is being handled
by mod_python at the time that shutdown occurs, or if the code has created
separate Python threads which are running at the time, then the cleanup code
actually deadlocks as the Python code which was already running is holding the
interpreter lock and the cleanup code can't acquire it.

The end result is that the whole child process hangs and the parent process
noticing this, keeps trying to send more SIGTERM's and after that still does
not work, it sends a SIGKILL and simply kills the process. In the worst cases
the child processes don't even hang, they simply crash, because Python code
is in no way signal safe anyway.

Thus, although you might see it working okay if your server is lightly loaded,
and you are lucky, if it handles any amount of traffic, this features tends not
to work at all and simply causes problems/delays on trying to do timely
restarts of Apache.

Because of how Apache is implemented, there is no reliable/safe way of
implementing this feature. If one can't do it properly, it seems better not
to attempt it at all.

Graham
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021849.html">[mod_python] i beg the developers to make mod_python can be
	importin python command line.
</A></li>
	<LI>Next message: <A HREF="021868.html">[mod_python] server shutdown [was] i beg...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21853">[ date ]</a>
              <a href="thread.html#21853">[ thread ]</a>
              <a href="subject.html#21853">[ subject ]</a>
              <a href="author.html#21853">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
