<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] server shutdown [was] i beg...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20server%20shutdown%20%5Bwas%5D%20i%20beg...&In-Reply-To=200608181048.54038.richardlewis%40fastmail.co.uk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021868.html">
   <LINK REL="Next"  HREF="021871.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] server shutdown [was] i beg...</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20server%20shutdown%20%5Bwas%5D%20i%20beg...&In-Reply-To=200608181048.54038.richardlewis%40fastmail.co.uk"
       TITLE="[mod_python] server shutdown [was] i beg...">grahamd at dscpl.com.au
       </A><BR>
    <I>Fri Aug 18 06:08:19 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021868.html">[mod_python] server shutdown [was] i beg...
</A></li>
        <LI>Next message: <A HREF="021871.html">[mod_python] server shutdown [was] i beg...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21869">[ date ]</a>
              <a href="thread.html#21869">[ thread ]</a>
              <a href="subject.html#21869">[ subject ]</a>
              <a href="author.html#21869">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 18/08/2006, at 7:48 PM, Richard Lewis wrote:

&gt;<i> On Tuesday 15 August 2006 23:31, Graham Dumpleton wrote:
</I>&gt;&gt;<i> Richard Lewis wrote ..
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Do you mean that there will be no opportunity to have code run at  
</I>&gt;&gt;&gt;<i> server
</I>&gt;&gt;&gt;<i> shutdown?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Correct. Reason being that it doesn't actually work most of the time
</I>&gt;&gt;<i> anyway.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Because of how Apache is implemented, there is no reliable/safe  
</I>&gt;&gt;<i> way of
</I>&gt;&gt;<i> implementing this feature. If one can't do it properly, it seems  
</I>&gt;&gt;<i> better not
</I>&gt;&gt;<i> to attempt it at all.
</I>&gt;&gt;<i>
</I>&gt;<i> Goodness! So, in my mod_python applications I often acquire  
</I>&gt;<i> database handles
</I>&gt;<i> and store them in objects outside of the handler() function so that  
</I>&gt;<i> they
</I>&gt;<i> persist between requests. (This is to avoid the expense of  
</I>&gt;<i> acquiring a new
</I>&gt;<i> handle for every request).
</I>
And you can still do that.

&gt;<i> I then use a cleanup() function to release those
</I>&gt;<i> database handles.
</I>&gt;<i>
</I>&gt;<i> The implication of this is that I will no longer be able to release  
</I>&gt;<i> the
</I>&gt;<i> handles at server shutdown, yes?
</I>
I think you miss what I have been saying. That it doesn't work now.  
If you
were to put calls to apache.log_error() in your cleanup handler and  
shutdown
Apache when it is handling a decent amount of traffic, you will probably
find your cleanup functions aren't actually being called, or if they  
do, they
might not exit and will hang at some point. What you are more likely  
to see
in the Apache log is a series of SIGTERM signals being sent and then a
SIGKILL signal which is forcibly killing off the process.

&gt;<i> Can anyone suggest an alternative method of
</I>&gt;<i> doing this? Are there any Python tricks where you can execute code  
</I>&gt;<i> when the
</I>&gt;<i> interpreter itself is about to stop?
</I>
Python does have means of calling code on application shutdown, but
because of how Apache uses signals to shutdown processes and how
the Apache main loop works, with the main loop being managed
by Apache and not Python they can't be used either.

&gt;<i> Or could I have a Python script running
</I>&gt;<i> in another process which &quot;looks in&quot; to the mod_python process and
</I>&gt;<i> periodically cleanly releases database handles?
</I>
No.

In the greater scheme of things it shouldn't ultimately matter. This  
is because
your database server is going to notice that the connections to it  
have been
dropped and will cleanup the resources on its side anyway. It has to  
do this
as there is nothing to say that Apache or any client process connecting
to it will not simply crash without cleanly disconnecting. In other  
words, you
will not get resource leaks. That things didn't get cleanup in the  
Apache child
process doesn't matter as it has been killed anyway, with all its  
memory being
released back to operating system.

Graham



</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021868.html">[mod_python] server shutdown [was] i beg...
</A></li>
	<LI>Next message: <A HREF="021871.html">[mod_python] server shutdown [was] i beg...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21869">[ date ]</a>
              <a href="thread.html#21869">[ thread ]</a>
              <a href="subject.html#21869">[ subject ]</a>
              <a href="author.html#21869">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
