<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] req.sendfile() problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20req.sendfile%28%29%20problem&In-Reply-To=10890432.379101154708106680.JavaMail.tomcat%40aurora">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021742.html">
   <LINK REL="Next"  HREF="021752.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] req.sendfile() problem</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jim Gallacher</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20req.sendfile%28%29%20problem&In-Reply-To=10890432.379101154708106680.JavaMail.tomcat%40aurora"
       TITLE="[mod_python] req.sendfile() problem">jpg at jgassociates.ca
       </A><BR>
    <I>Fri Aug  4 12:42:37 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021742.html">[mod_python] req.sendfile() problem
</A></li>
        <LI>Next message: <A HREF="021752.html">[mod_python] req.sendfile() problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21744">[ date ]</a>
              <a href="thread.html#21744">[ thread ]</a>
              <a href="subject.html#21744">[ subject ]</a>
              <a href="author.html#21744">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thomas J. Schirripa wrote:
&gt;<i> Before stating my problem, let me say that I am running apache version 2.0.52, mod_python 3.2.8, python 2.3, all on Redhat Enterprise Linux WS release 4.
</I>&gt;<i> 
</I>&gt;<i> Basically I have a webpage where the client uploads a file and some scripts/programs run on the server and produce output files. Some of this output is spit out onto another webpage, but I want to give the client the option to download the output files. Since I am using multiple webpages, I had to figure out a way to transfer data from one page to another. The only sensible solution that I could figure out was to use psp to feed variables from my handlers into hidden form inputs in my template. From the output html page, the client can click a submit button next to the output filename that says &quot;download&quot;. The hidden form inputs have the information as to where the file is located on the server, and the action on the form refers to my sendFile handler. That handler looks like this:
</I>&gt;<i> 
</I>&gt;<i> def handler(req):
</I>&gt;<i> 	fields = util.FieldStorage(req)
</I>&gt;<i>         #Note: the filename is an absolute path, so I am going to split that up into directory and filename for clarity
</I>&gt;<i> 	filename = os.path.basename(fields[&quot;filename&quot;])
</I>&gt;<i> 	path = os.path.dirname(fields[&quot;filename&quot;])
</I>&gt;<i> 	req.headers_out[&quot;Content-Disposition&quot;] = &quot;attachment; filename=%s&quot; % filename
</I>&gt;<i> 	req.content_type = &quot;text/plain&quot;
</I>&gt;<i> 	req.sendfile(&quot;%s/%s&quot; % (directory, filename))
</I>&gt;<i> 	return apache.OK
</I>&gt;<i> 
</I>&gt;<i> I am not sure if I am using req.header_out or req.content-type correctly or how critical those lines are (I found it in another post), but my problem is that I am getting a file to download with the proper filename, BUT the file has a mod_python error message in it that reads:
</I>&gt;<i> 
</I>&gt;<i> IOError: Could not stat file for reading
</I>&gt;<i> 
</I>&gt;<i> and the error points to the line with req.sendfile(). Can anyone tell me what's going on and how to correct this?
</I>
An exception is being raised and mod_python is dumping the traceback in
the response. You should wrap req.sendfile() in a try/except block, and
if and exception is raised send a proper error message to the browser.

sendfile() needs to stat the file so it can set the content length
header. You are getting the IOError because the file does not exist or
there is a permission problem. Make sure you are using absolute paths
for sendfile(). Also, it goes without saying that the filename provided
by in the request should not be trusted. Do some checking to ensure it
is valid value.

Jim
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021742.html">[mod_python] req.sendfile() problem
</A></li>
	<LI>Next message: <A HREF="021752.html">[mod_python] req.sendfile() problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21744">[ date ]</a>
              <a href="thread.html#21744">[ thread ]</a>
              <a href="subject.html#21744">[ subject ]</a>
              <a href="author.html#21744">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
