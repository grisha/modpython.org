<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: PyThreadState_Swap(NULL)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20PyThreadState_Swap%28NULL%29&In-Reply-To=807BD4D4-1217-4BF0-847C-59FFFC6DFB47%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021901.html">
   <LINK REL="Next"  HREF="021903.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: PyThreadState_Swap(NULL)</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20PyThreadState_Swap%28NULL%29&In-Reply-To=807BD4D4-1217-4BF0-847C-59FFFC6DFB47%40dscpl.com.au"
       TITLE="[mod_python] Re: PyThreadState_Swap(NULL)">grahamd at dscpl.com.au
       </A><BR>
    <I>Sun Aug 20 04:08:25 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021901.html">[mod_python] Re: PyThreadState_Swap(NULL)
</A></li>
        <LI>Next message: <A HREF="021903.html">[mod_python] Re: PyThreadState_Swap(NULL)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21902">[ date ]</a>
              <a href="thread.html#21902">[ thread ]</a>
              <a href="subject.html#21902">[ subject ]</a>
              <a href="author.html#21902">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 20/08/2006, at 3:43 PM, Graham Dumpleton wrote:

&gt;<i> I'd have to look over your code and try and get my head around all  
</I>&gt;<i> this
</I>&gt;<i> stuff again, but I really think you will be fighting an uphill  
</I>&gt;<i> battle to get
</I>&gt;<i> something going which doesn't try and work in co-operation with
</I>&gt;<i> mod_python some how.
</I>&gt;<i>
</I>&gt;<i> One of the first problems is that mod_python is the one to create the
</I>&gt;<i> first interpreter and this first interpreter is special. If a  
</I>&gt;<i> Python module
</I>&gt;<i> has a C code component and it isn't written in just the right way  
</I>&gt;<i> so as
</I>&gt;<i> to work with interpreters other than the first, then it will have  
</I>&gt;<i> problems.
</I>&gt;<i> Usually this manifests as Python code running in a restricted  
</I>&gt;<i> environment
</I>&gt;<i> and not able to access various stuff, but other things could also  
</I>&gt;<i> happen,
</I>&gt;<i> including lock ups and crashes.
</I>&gt;<i>
</I>&gt;<i> The other problem you will have is that Apache on Win32 and also
</I>&gt;<i> worker MPM on UNIX is multithreaded and even more work is required
</I>&gt;<i> to get that to work properly. I don't see anything in your code that
</I>&gt;<i> suggests that it takes multithreading and multiple interpreters into
</I>&gt;<i> consideration.
</I>&gt;<i>
</I>&gt;<i> In the short term, using a separate Apache instance as you suggest
</I>&gt;<i> will probably be your only quick solution. In the long term, I  
</I>&gt;<i> still think
</I>&gt;<i> using the proposed API for mod_python is the only way it is going to
</I>&gt;<i> work.
</I>
Have been busy and have added minimal set of functions to mod_python
and exporting them for use in other modules. This code is now checked
into subversion trunk for 3.3.

As an example, here is how it could be used:

         PyObject *m = NULL;
         PyObject *o = NULL;
         PyObject *d = NULL;

         optfn_mp_acquire_interpreter(&quot;main_interpreter&quot;);

         request_obj = optfn_mp_get_request_object(r);

         m = PyImport_ImportModule(&quot;mod_python.testhandler&quot;);
         if (m) {
             d = PyModule_GetDict(m);
             o = PyDict_GetItemString(d, &quot;handler&quot;);

             if (o) {
                 PyObject *a = NULL;
                 PyObject *r = NULL;

                 a = Py_BuildValue(&quot;(O)&quot;, request_obj);
                 r = PyEval_CallObject(o, a);
                 Py_DECREF(a);
                 if (r == NULL)
                     return HTTP_INTERNAL_SERVER_ERROR;

                 if (!PyInt_Check(r))
                     return HTTP_INTERNAL_SERVER_ERROR;

                 result = PyInt_AsLong(r);

                 Py_DECREF(r);
             }
             else {
                 ap_rputs(&quot;ERROR 2&quot;, r);
             }
         }
         else {
             ap_rputs(&quot;ERROR 1&quot;, r);
         }

         Py_XDECREF(request_obj);

         optfn_mp_release_interpreter();

Some proper logging could be performed for error cases, but general idea
here was to call mod_python.testhandler.handler from a response handler
registered from a C module distinct from mod_python.

The full code for this including Makefile's is attached to:

   <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-165">http://issues.apache.org/jira/browse/MODPYTHON-165</A>

You will need to modify the appropriate Makefile to specify where the  
Python
includes are though. By rights it should be a bit smarter and get  
includes and
defines etc by running Python to find them out. Will work out what  
needs to
be done to make the correct later.

In respect of your code, if it is layered properly and core module is  
distinct
and loadable from Python command line, all you need to do is import like
above and then call appropriate entry point.

Graham
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021901.html">[mod_python] Re: PyThreadState_Swap(NULL)
</A></li>
	<LI>Next message: <A HREF="021903.html">[mod_python] Re: PyThreadState_Swap(NULL)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21902">[ date ]</a>
              <a href="thread.html#21902">[ thread ]</a>
              <a href="subject.html#21902">[ subject ]</a>
              <a href="author.html#21902">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
