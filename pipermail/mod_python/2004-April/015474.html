<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Bug in Windows installation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Bug%20in%20Windows%20installation&In-Reply-To=001001c42aed%2463ded460%2402fea8c0%40eldiener">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015467.html">
   <LINK REL="Next"  HREF="015480.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Bug in Windows installation</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>David Fraser</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Bug%20in%20Windows%20installation&In-Reply-To=001001c42aed%2463ded460%2402fea8c0%40eldiener"
       TITLE="[mod_python] Bug in Windows installation">davidf at sjsoft.com
       </A><BR>
    <I>Mon Apr 26 09:45:21 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="015467.html">[mod_python] Bug in Windows installation
</A></li>
        <LI>Next message: <A HREF="015480.html">[mod_python] Bug in Windows installation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15474">[ date ]</a>
              <a href="thread.html#15474">[ thread ]</a>
              <a href="subject.html#15474">[ subject ]</a>
              <a href="author.html#15474">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

Thanks for posting this, I created the Windows installer script and one 
of my colleagues noticed this too, so we prepared a modified version.
I have attached the modified win32_postinstall.py script ; and I have a 
rebuilt installer at 
<A HREF="http://davidf.sjsoft.com/files/mod_python-3.1.3-1.win32-py2.3.exe">http://davidf.sjsoft.com/files/mod_python-3.1.3-1.win32-py2.3.exe</A>
This also contains a fix for the attachment filetype problem.
Please test and let me know if this fixes your problem

David

PS Grisha, is there time now to start getting this stuff into CVS, as it 
would be better management-wise? :-)

Eddie Diener wrote:

&gt;<i> Mod_python's postinstall script assumes that the Apache key in the 
</I>&gt;<i> Windows registry is in HKLM. However if one installs Apache Web Server 
</I>&gt;<i> on Windows and chooses to install for the current user in order to 
</I>&gt;<i> start Apache manually from the Console Window, the entry is under 
</I>&gt;<i> HKCU. Because of this an exception is thrown in the script when 
</I>&gt;<i> attempting to open HKLM/Apache Group/Apache and the postinstall script 
</I>&gt;<i> never finishes.
</I>&gt;<i>
</I>&gt;<i> Here is the exception trace:
</I>&gt;<i>
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i> File &quot;H:\UTILIT~1\Python23\Scripts\win32_postinstall.py&quot;, line 86, in ?
</I>&gt;<i> apachediroptions = getApacheDirOptions()
</I>&gt;<i> File &quot;H:\UTILIT~1\Python23\Scripts\win32_postinstall.py&quot;, line 45, in
</I>&gt;<i> getApacheDirOptions
</I>&gt;<i> apachekey = regkey(win32con.HKEY_LOCAL_MACHINE, 
</I>&gt;<i> &quot;Software&quot;).childkey(&quot;Apache
</I>&gt;<i> Group&quot;).childkey(&quot;Apache&quot;)
</I>&gt;<i> File &quot;H:\UTILIT~1\Python23\Scripts\win32_postinstall.py&quot;, line 34, in
</I>&gt;<i> childkey
</I>&gt;<i> return regkey(self.key, subkeyname)
</I>&gt;<i> File &quot;H:\UTILIT~1\Python23\Scripts\win32_postinstall.py&quot;, line 32, in
</I>&gt;<i> __init__
</I>&gt;<i> self.key = win32api.RegOpenKey(parent, subkeyname)
</I>&gt;<i> pywintypes.error: (2, 'RegOpenKeyEx', 'The system cannot find the file
</I>&gt;<i> specified.')
</I>&gt;<i> Exception exceptions.AttributeError: &quot;regkey instance has no attribute
</I>&gt;<i> 'key'&quot; in &lt;bound method regkey.__del__ of &lt;__main__.regkey instance at
</I>&gt;<i> 0x011C8468&gt;&gt; ignored
</I>&gt;<i> *** run_installscript: internal error 0xFFFFFFFF ***
</I>&gt;<i> A workaround is to temporarily duplicate the Apache registry keys from 
</I>&gt;<i> HKCU to HKLM and add the ServerRoot key value, poinitng it to the root 
</I>&gt;<i> directory where Apache is installed. The installing mod_python works OK.
</I>&gt;<i>
</I>&gt;<i>------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Mod_python mailing list
</I>&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>  
</I>&gt;<i>
</I>
-------------- next part --------------
 # Copyright 2004 Apache Software Foundation
 #
 #  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 #  you may not use this file except in compliance with the License.
 #  You may obtain a copy of the License at
 #
 #      <A HREF="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</A>
 #
 #  Unless required by applicable law or agreed to in writing, software
 #  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 #  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 #  See the License for the specific language governing permissions and
 #  limitations under the License.
 #
 # Originally developed by Gregory Trubetskoy.
 #
 # $Id: win32_postinstall.py,v 1.5 2004/02/16 19:47:27 grisha Exp $
 #
 # this script runs at the end of windows install


import sys, os, shutil
import distutils.sysconfig

def getApacheDirOptions():
    &quot;&quot;&quot;find potential apache directories in the registry...&quot;&quot;&quot;
    try:
        import win32api, win32con
        class nullregkey:
            &quot;&quot;&quot;a registry key that doesn't exist...&quot;&quot;&quot;
            def childkey(self, subkeyname):
                return nullregkey()
            def subkeynames(self):
                return []
            def getvalue(self, valuename):
                raise AttributeError(&quot;Cannot access registry value %r: key does not exist&quot; % (valuename))
        class regkey:
            &quot;&quot;&quot;simple wrapper for registry functions that closes keys nicely...&quot;&quot;&quot;
            def __init__(self, parent, subkeyname):
               self.key = win32api.RegOpenKey(parent, subkeyname)
            def childkey(self, subkeyname):
               try:
                   return regkey(self.key, subkeyname)
               except win32api.error:
                   return nullregkey()
            def subkeynames(self):
               numsubkeys = win32api.RegQueryInfoKey(self.key)[0]
               return [win32api.RegEnumKey(self.key, index) for index in range(numsubkeys)]
            def getvalue(self, valuename):
               try:
                   return win32api.RegQueryValueEx(self.key, valuename)
               except win32api.error:
                   raise AttributeError(&quot;Cannot access registry value %r&quot; % (valuename))
            def __del__(self):
               if hasattr(self, &quot;key&quot;):
                   win32api.RegCloseKey(self.key)
    except ImportError:
        return {}
    versions = {}
    hklm_key = regkey(win32con.HKEY_LOCAL_MACHINE, &quot;Software&quot;).childkey(&quot;Apache Group&quot;).childkey(&quot;Apache&quot;)
    hkcu_key = regkey(win32con.HKEY_CURRENT_USER, &quot;Software&quot;).childkey(&quot;Apache Group&quot;).childkey(&quot;Apache&quot;)
    for apachekey in (hklm_key, hkcu_key):
        for versionname in apachekey.subkeynames():
            try:
                serverroot = apachekey.childkey(versionname).getvalue(&quot;ServerRoot&quot;)
            except AttributeError:
                continue
            versions[versionname] = serverroot[0]
    return versions

def askForApacheDir(apachediroptions):
    # try to ask for Apache directory
    if len(apachediroptions) &gt; 0:
        # get the most recent version...
        versionnames = apachediroptions.keys()
        versionnames.sort()
        initialdir = apachediroptions[versionnames[-1]]
    else:
        initialdir=&quot;C:/Program Files/Apache Group/Apache2&quot;
    # TODO: let the user select the name from a list, or click browse to choose...
    try:
        from tkFileDialog import askdirectory
        from Tkinter import Tk
        root = Tk()
        root.withdraw()
        path = askdirectory(title=&quot;Where is Apache installed?&quot;,
                            initialdir=initialdir,
                            mustexist=1, master=root)
        root.quit()
        root.destroy()
        return path
    except ImportError:
        try:
            from win32com.shell import shell
            pidl, displayname, imagelist = shell.SHBrowseForFolder(0, None, &quot;Where is Apache installed?&quot;)
            path = shell.SHGetPathFromIDList(pidl)
            return path
        except ImportError:
            return &quot;&quot;

# if we're called during removal, just exit
if len(sys.argv) == 0 or (len(sys.argv) &gt; 1 and sys.argv[1] != &quot;-remove&quot;):

    mp = os.path.join(distutils.sysconfig.get_python_lib(), &quot;mod_python_so.pyd&quot;)

    apachediroptions = getApacheDirOptions()

    apachedir = askForApacheDir(apachediroptions)

    if apachedir:

        # put mod_python.so there
        shutil.copy2(mp, os.path.join(apachedir, &quot;modules&quot;, &quot;mod_python.so&quot;))
        os.remove(mp)

        print &quot;&quot;&quot;Important Note for Windows users, PLEASE READ!!!

        1. This script does not attempt to modify Apache configuration,
           you must do it manually:

           Edit %s,
           find where other LoadModule lines are and add this:
                LoadModule python_module modules/mod_python.so

        2. Now test your installation using the instructions at this link:
           <A HREF="http://www.modpython.org/live/current/doc-html/inst-testing.html">http://www.modpython.org/live/current/doc-html/inst-testing.html</A>

        &quot;&quot;&quot; % os.path.join(apachedir, &quot;conf&quot;, &quot;httpd.conf&quot;)

    else:

        print &quot;&quot;&quot;Important Note for Windows users, PLEASE READ!!!

        1. It appears that you do not have Tkinter installed,
           which is required for a part of this installation.
           Therefore you must manually take
           &quot;%s&quot;
           and copy it to your Apache modules directory.

        2. This script does not attempt to modify Apache configuration,
           you must do it manually:

           Edit %s,
           find where other LoadModule lines and add this:
                LoadModule python_module modules/mod_python.so

        3. Now test your installation using the instructions at this link:
           <A HREF="http://www.modpython.org/live/current/doc-html/inst-testing.html">http://www.modpython.org/live/current/doc-html/inst-testing.html</A>

        &quot;&quot;&quot; % (mp, os.path.join(apachedir, &quot;conf&quot;, &quot;httpd.conf&quot;))
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015467.html">[mod_python] Bug in Windows installation
</A></li>
	<LI>Next message: <A HREF="015480.html">[mod_python] Bug in Windows installation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15474">[ date ]</a>
              <a href="thread.html#15474">[ thread ]</a>
              <a href="subject.html#15474">[ subject ]</a>
              <a href="author.html#15474">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
