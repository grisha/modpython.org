<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] How to cache memcache client connection/thread-safe
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20How%20to%20cache%20memcache%20client%20connection/thread-safe&In-Reply-To=92B584AC96EB6B4494D6EBA673E23DB60107E5D5%40sydney1.adsfac.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026316.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] How to cache memcache client connection/thread-safe</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20How%20to%20cache%20memcache%20client%20connection/thread-safe&In-Reply-To=92B584AC96EB6B4494D6EBA673E23DB60107E5D5%40sydney1.adsfac.net"
       TITLE="[mod_python] How to cache memcache client connection/thread-safe">graham.dumpleton at gmail.com
       </A><BR>
    <I>Mon Aug 31 03:23:38 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="026316.html">[mod_python] How to cache memcache client connection/thread-safe
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26317">[ date ]</a>
              <a href="thread.html#26317">[ thread ]</a>
              <a href="subject.html#26317">[ subject ]</a>
              <a href="author.html#26317">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>2009/8/31 Denzel Zhang &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">denzel.zhang at facilitatedigital.com</A>&gt;:
&gt;<i> Hi there,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am currently working on a project to work out an Ads delivery web page
</I>&gt;<i> which needs to get the cache data from backend Memcached Server. The web
</I>&gt;<i> server is Apache + mod_python, the performance I tested after I put
</I>&gt;<i> memcached client lib (_pylibmc) inside the page was not quiet good, the main
</I>&gt;<i> problem I think is that every time network sockets create/destroy will be
</I>&gt;<i> very costly, so I changed the way of data retrieving like following:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> from mod_python import apache, util
</I>&gt;<i>
</I>&gt;<i> import _pylibmc as memcache
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> global mc = None
</I>&gt;<i>
</I>&gt;<i> global bConnectionOpen = False
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def handler(req):
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; global mc, bConnectionOpen
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if bConnectionOpen == False:
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mc = memcache.client([&quot;127.0.0.1:11211&quot;])
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bConnectionOpen = True
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ClientID = mc.get(&quot;ClientID&quot;)
</I>&gt;<i>
</I>&gt;<i> &#8230;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The performance got much better (700 requests/sec, was just no more than 300
</I>&gt;<i> requests/sec) after I changed to above but I still worry about the data
</I>&gt;<i> thread safe issue. Can I say that all data would be safe under the threads
</I>&gt;<i> of mod_python as its thread-safe? And is there a proper way to cache or
</I>&gt;<i> share the sock connection between multiple mod_python interpreters?
</I>
If handle returned by memcache.client() is not thread safe, then this
will fail in a multithread MPM such as worker MPM on UNIX and winnt
MPM on Windows.

If a single handle is multithread safe, then you are better off
initialising the connection at global scope in module as current way
you initialise it isn't thread safe.

In other words, move initialise from inside handler to outside of handler.

Graham

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026316.html">[mod_python] How to cache memcache client connection/thread-safe
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26317">[ date ]</a>
              <a href="thread.html#26317">[ thread ]</a>
              <a href="subject.html#26317">[ subject ]</a>
              <a href="author.html#26317">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
