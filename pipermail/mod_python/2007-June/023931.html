<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] mod_python + mod_authz_host w/o mod_auth_digest
	causes ~1Mb leak per apache graceful restart
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20%2B%20mod_authz_host%20w/o%20mod_auth_digest%0A%09causes%20%7E1Mb%20leak%20per%20apache%20graceful%20restart&In-Reply-To=4682E887.3010205%40metaweb.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023930.html">
   <LINK REL="Next"  HREF="023932.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] mod_python + mod_authz_host w/o mod_auth_digest
	causes ~1Mb leak per apache graceful restart</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20%2B%20mod_authz_host%20w/o%20mod_auth_digest%0A%09causes%20%7E1Mb%20leak%20per%20apache%20graceful%20restart&In-Reply-To=4682E887.3010205%40metaweb.com"
       TITLE="[mod_python] mod_python + mod_authz_host w/o mod_auth_digest
	causes ~1Mb leak per apache graceful restart">graham.dumpleton at gmail.com
       </A><BR>
    <I>Wed Jun 27 19:15:22 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023930.html">[mod_python] mod_python + mod_authz_host w/o mod_auth_digest
	causes ~1Mb leak per apache graceful restart
</A></li>
        <LI>Next message: <A HREF="023932.html">[mod_python] mod_python + mod_authz_host w/o mod_auth_digest
	causes ~1Mb leak per apache graceful restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23931">[ date ]</a>
              <a href="thread.html#23931">[ thread ]</a>
              <a href="subject.html#23931">[ subject ]</a>
              <a href="author.html#23931">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Is the version of mod_python you are using one you compiled yourself,
or one from Ubuntu packages?

Is the version of Python you are using one you compiled yourself, or
one from Ubuntu packages?

What is the size of mod_python.so? Does it use a shared Python library
or static? Use 'ldd' on mod_python.so to see dependencies.

Graham

On 28/06/07, Aseem Mohanty &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">aseem at metaweb.com</A>&gt; wrote:
&gt;<i> Yes, hence the exotic phraseology. Results for the various combinations are below:
</I>&gt;<i>
</I>&gt;<i> 1. mod_python only, no mod_auth* modules:                   leaks
</I>&gt;<i> 2. mod_auth_digest only, no other mod_auth*, no mod_python: does not leak
</I>&gt;<i> 3. mod_authz_host only, no other mod_auth*, no mod_python:  does not leak
</I>&gt;<i> 4. mod_python + mod_authz_host, no mod_auth_digest:         leaks
</I>&gt;<i> 5. mod_python + mod_auth_digest, no mod_authz_host:         leaks &lt; (1) or (4)
</I>&gt;<i> 6. mod_python + mod_auth_digest + mod_authz_host:           does not leak
</I>&gt;<i>
</I>&gt;<i> NOTE: 'does not leak' implies ~50-100K leakage per graceful restart
</I>&gt;<i>        (5) leaks ~500-600K per graceful restart
</I>&gt;<i>        zero load on server
</I>&gt;<i>
</I>&gt;<i> As far as I can tell there is definitely some sinister interaction going on
</I>&gt;<i> between these three modules. Unfortunately not being conversant with apache
</I>&gt;<i> module development, I cannot really say what.
</I>&gt;<i>
</I>&gt;<i> Thanks.
</I>&gt;<i> AM
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Jim Gallacher wrote:
</I>&gt;<i> &gt; Aseem Mohanty wrote:
</I>&gt;<i> &gt;&gt; This may sound quite exotic
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Why yes, it does? Interaction between these modules resulting in a
</I>&gt;<i> &gt; memory leak sure sounds weird. Did you try it with *only* mod_python
</I>&gt;<i> &gt; loaded? (ie, without mod_authz_host)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Jim
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; but here it is:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; In a vanilla apache2.2.x configuration if I only load mod_authz_host
</I>&gt;<i> &gt;&gt; and none of
</I>&gt;<i> &gt;&gt; the other mod_auth* modules, every graceful restart causes ~1Mb leak
</I>&gt;<i> &gt;&gt; in the
</I>&gt;<i> &gt;&gt; parent process. This is with mod_python loaded. Without mod_python the
</I>&gt;<i> &gt;&gt; memory profile remains unchanged.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Steps to reproduce:
</I>&gt;<i> &gt;&gt; Gentoo:
</I>&gt;<i> &gt;&gt; 1. In /etc/apache2/httpd.conf comment out all &quot;LoadModule auth*&quot;
</I>&gt;<i> &gt;&gt; directives except
</I>&gt;<i> &gt;&gt; LoadModule authz_host_module modules/mod_authz_host.so
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Ubuntu Feisty (repos):
</I>&gt;<i> &gt;&gt; 1. In /etc/apache2/mods-enabled rename auth*.load files except
</I>&gt;<i> &gt;&gt; authz_host.load
</I>&gt;<i> &gt;&gt; to auth*.load.not
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Ubuntu Feisty (httpd built from source):
</I>&gt;<i> &gt;&gt; 1. In conf/httpd.conf comment out all &quot;LoadModule auth*&quot; directives
</I>&gt;<i> &gt;&gt; except
</I>&gt;<i> &gt;&gt; LoadModule authz_host_module modules/mod_authz_host.so
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; 2. Start apache
</I>&gt;<i> &gt;&gt; 3. Track apache parent process: top -d1 -p $(pgrep -o apache/httpd)
</I>&gt;<i> &gt;&gt; 4. Hit apache instances with graceful restarts:
</I>&gt;<i> &gt;&gt; for i in $(seq 150); do echo $i; kill -USR1 $(pgrep -o apache/httpd);
</I>&gt;<i> &gt;&gt; sleep 2; done
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; In this case the parent will leak ~1Mb per restart. If however in each
</I>&gt;<i> &gt;&gt; of the
</I>&gt;<i> &gt;&gt; configurations mod_auth_digest.so is also loaded the leak is only
</I>&gt;<i> &gt;&gt; about 150-200K
</I>&gt;<i> &gt;&gt; or so per graceful restart. This is on a server with 0 load. In my
</I>&gt;<i> &gt;&gt; case it
</I>&gt;<i> &gt;&gt; caused apache instances that were restarted every 55 minutes to grow
</I>&gt;<i> &gt;&gt; up to 300Mb
</I>&gt;<i> &gt;&gt; in a week.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Tested on:
</I>&gt;<i> &gt;&gt; 1. Ubuntu Feisty (built from source httpd-2.2.4, mod_python-3.3.1):
</I>&gt;<i> &gt;&gt; ./configure --prefix=/opt --enable-modules=all
</I>&gt;<i> &gt;&gt; --enable-mods-shared=all --enable-so --with-included-apr
</I>&gt;<i> &gt;&gt; Server version: Apache/2.2.4 (Unix)
</I>&gt;<i> &gt;&gt; Server built:   Jun 27 2007 09:34:16
</I>&gt;<i> &gt;&gt; Server's Module Magic Number: 20051115:4
</I>&gt;<i> &gt;&gt; Server loaded:  APR 1.2.8, APR-Util 1.2.8
</I>&gt;<i> &gt;&gt; Compiled using: APR 1.2.8, APR-Util 1.2.8
</I>&gt;<i> &gt;&gt; Architecture:   32-bit
</I>&gt;<i> &gt;&gt; Server MPM:     Prefork
</I>&gt;<i> &gt;&gt;   threaded:     no
</I>&gt;<i> &gt;&gt;     forked:     yes (variable process count)
</I>&gt;<i> &gt;&gt; Server compiled with....
</I>&gt;<i> &gt;&gt;  -D APACHE_MPM_DIR=&quot;server/mpm/prefork&quot;
</I>&gt;<i> &gt;&gt;  -D APR_HAS_SENDFILE
</I>&gt;<i> &gt;&gt;  -D APR_HAS_MMAP
</I>&gt;<i> &gt;&gt;  -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)
</I>&gt;<i> &gt;&gt;  -D APR_USE_SYSVSEM_SERIALIZE
</I>&gt;<i> &gt;&gt;  -D APR_USE_PTHREAD_SERIALIZE
</I>&gt;<i> &gt;&gt;  -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT
</I>&gt;<i> &gt;&gt;  -D APR_HAS_OTHER_CHILD
</I>&gt;<i> &gt;&gt;  -D AP_HAVE_RELIABLE_PIPED_LOGS
</I>&gt;<i> &gt;&gt;  -D DYNAMIC_MODULE_LIMIT=128
</I>&gt;<i> &gt;&gt;  -D HTTPD_ROOT=&quot;/opt/share/apache2&quot;
</I>&gt;<i> &gt;&gt;  -D SUEXEC_BIN=&quot;/opt/share/apache2/bin/suexec&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_PIDLOG=&quot;logs/httpd.pid&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_SCOREBOARD=&quot;logs/apache_runtime_status&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_LOCKFILE=&quot;logs/accept.lock&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_ERRORLOG=&quot;logs/error_log&quot;
</I>&gt;<i> &gt;&gt;  -D AP_TYPES_CONFIG_FILE=&quot;conf/mime.types&quot;
</I>&gt;<i> &gt;&gt;  -D SERVER_CONFIG_FILE=&quot;conf/httpd.conf&quot;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; 2. gentoo (64 bit dual proc AMD):
</I>&gt;<i> &gt;&gt; Linux host1 2.6.16-gentoo-r9 #7 SMP Fri Mar 16 17:35:26 UTC 2007
</I>&gt;<i> &gt;&gt; x86_64 AMD
</I>&gt;<i> &gt;&gt; Opteron(tm) Processor 248 AuthenticAMD GNU/Linux
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Server version: Apache/2.2.4 (Unix)
</I>&gt;<i> &gt;&gt; Server built:   Jun 26 2007 19:29:33
</I>&gt;<i> &gt;&gt; Server's Module Magic Number: 20051115:4
</I>&gt;<i> &gt;&gt; Server loaded:  APR 1.2.8, APR-Util 1.2.8
</I>&gt;<i> &gt;&gt; Compiled using: APR 1.2.8, APR-Util 1.2.8
</I>&gt;<i> &gt;&gt; Architecture:   64-bit
</I>&gt;<i> &gt;&gt; Server MPM:     Prefork
</I>&gt;<i> &gt;&gt;   threaded:     no
</I>&gt;<i> &gt;&gt;     forked:     yes (variable process count)
</I>&gt;<i> &gt;&gt; Server compiled with....
</I>&gt;<i> &gt;&gt;  -D APACHE_MPM_DIR=&quot;server/mpm/prefork&quot;
</I>&gt;<i> &gt;&gt;  -D APR_HAS_SENDFILE
</I>&gt;<i> &gt;&gt;  -D APR_HAS_MMAP
</I>&gt;<i> &gt;&gt;  -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)
</I>&gt;<i> &gt;&gt;  -D APR_USE_SYSVSEM_SERIALIZE
</I>&gt;<i> &gt;&gt;  -D APR_USE_PTHREAD_SERIALIZE
</I>&gt;<i> &gt;&gt;  -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT
</I>&gt;<i> &gt;&gt;  -D APR_HAS_OTHER_CHILD
</I>&gt;<i> &gt;&gt;  -D AP_HAVE_RELIABLE_PIPED_LOGS
</I>&gt;<i> &gt;&gt;  -D DYNAMIC_MODULE_LIMIT=128
</I>&gt;<i> &gt;&gt;  -D HTTPD_ROOT=&quot;/usr&quot;
</I>&gt;<i> &gt;&gt;  -D SUEXEC_BIN=&quot;/usr/sbin/suexec&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_PIDLOG=&quot;/var/run/httpd.pid&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_SCOREBOARD=&quot;logs/apache_runtime_status&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_LOCKFILE=&quot;/var/run/accept.lock&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_ERRORLOG=&quot;logs/error_log&quot;
</I>&gt;<i> &gt;&gt;  -D AP_TYPES_CONFIG_FILE=&quot;/etc/apache2/mime.types&quot;
</I>&gt;<i> &gt;&gt;  -D SERVER_CONFIG_FILE=&quot;/etc/apache2/httpd.conf&quot;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; 3. Ubuntu Feisty (32 bit Intel core duo - ubuntu repos):
</I>&gt;<i> &gt;&gt; Linux host2 2.6.20-16-generic #2 SMP Thu Jun 7 20:19:32 UTC 2007 i686
</I>&gt;<i> &gt;&gt; GNU/Linux
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Server version: Apache/2.2.3
</I>&gt;<i> &gt;&gt; Server built:   Jan 15 2007 18:14:50
</I>&gt;<i> &gt;&gt; Server's Module Magic Number: 20051115:3
</I>&gt;<i> &gt;&gt; Server loaded:  APR 1.2.7, APR-Util 1.2.7
</I>&gt;<i> &gt;&gt; Compiled using: APR 1.2.7, APR-Util 1.2.7
</I>&gt;<i> &gt;&gt; Architecture:   32-bit
</I>&gt;<i> &gt;&gt; Server MPM:     Prefork
</I>&gt;<i> &gt;&gt;   threaded:     no
</I>&gt;<i> &gt;&gt;     forked:     yes (variable process count)
</I>&gt;<i> &gt;&gt; Server compiled with....
</I>&gt;<i> &gt;&gt;  -D APACHE_MPM_DIR=&quot;server/mpm/prefork&quot;
</I>&gt;<i> &gt;&gt;  -D APR_HAS_SENDFILE
</I>&gt;<i> &gt;&gt;  -D APR_HAS_MMAP
</I>&gt;<i> &gt;&gt;  -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)
</I>&gt;<i> &gt;&gt;  -D APR_USE_SYSVSEM_SERIALIZE
</I>&gt;<i> &gt;&gt;  -D APR_USE_PTHREAD_SERIALIZE
</I>&gt;<i> &gt;&gt;  -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT
</I>&gt;<i> &gt;&gt;  -D APR_HAS_OTHER_CHILD
</I>&gt;<i> &gt;&gt;  -D AP_HAVE_RELIABLE_PIPED_LOGS
</I>&gt;<i> &gt;&gt;  -D DYNAMIC_MODULE_LIMIT=128
</I>&gt;<i> &gt;&gt;  -D HTTPD_ROOT=&quot;&quot;
</I>&gt;<i> &gt;&gt;  -D SUEXEC_BIN=&quot;/usr/lib/apache2/suexec&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_PIDLOG=&quot;/var/run/apache2.pid&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_SCOREBOARD=&quot;logs/apache_runtime_status&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_LOCKFILE=&quot;/var/run/apache2/accept.lock&quot;
</I>&gt;<i> &gt;&gt;  -D DEFAULT_ERRORLOG=&quot;logs/error_log&quot;
</I>&gt;<i> &gt;&gt;  -D AP_TYPES_CONFIG_FILE=&quot;/etc/apache2/mime.types&quot;
</I>&gt;<i> &gt;&gt;  -D SERVER_CONFIG_FILE=&quot;/etc/apache2/apache2.conf&quot;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Bug or just an unexpected apache configuration?? I actually filed a
</I>&gt;<i> &gt;&gt; bug against apache core
</I>&gt;<i> &gt;&gt; (<A HREF="http://issues.apache.org/bugzilla/show_bug.cgi?id=42749">http://issues.apache.org/bugzilla/show_bug.cgi?id=42749</A>) initially
</I>&gt;<i> &gt;&gt; not realizing that it could be a combination of factors that was
</I>&gt;<i> &gt;&gt; causing it and not just soe module not being loaded.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Thanks.
</I>&gt;<i> &gt;&gt; AM
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Mod_python mailing list
</I>&gt;<i> &gt;&gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I></PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023930.html">[mod_python] mod_python + mod_authz_host w/o mod_auth_digest
	causes ~1Mb leak per apache graceful restart
</A></li>
	<LI>Next message: <A HREF="023932.html">[mod_python] mod_python + mod_authz_host w/o mod_auth_digest
	causes ~1Mb leak per apache graceful restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23931">[ date ]</a>
              <a href="thread.html#23931">[ thread ]</a>
              <a href="subject.html#23931">[ subject ]</a>
              <a href="author.html#23931">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
