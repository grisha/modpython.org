<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Checking a PSP-generated response before starting to
	send it..?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Checking%20a%20PSP-generated%20response%20before%20starting%20to%0A%09send%20it..%3F&In-Reply-To=88e286470706282331t6a2f8e0ajd4e54e0a6999271d%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023940.html">
   <LINK REL="Next"  HREF="023926.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Checking a PSP-generated response before starting to
	send it..?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Aaron Robinson</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Checking%20a%20PSP-generated%20response%20before%20starting%20to%0A%09send%20it..%3F&In-Reply-To=88e286470706282331t6a2f8e0ajd4e54e0a6999271d%40mail.gmail.com"
       TITLE="[mod_python] Checking a PSP-generated response before starting to
	send it..?">aaron.robinson at mojoworld.com
       </A><BR>
    <I>Fri Jun 29 04:17:36 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023940.html">[mod_python] Checking a PSP-generated response before starting to
	send it..?
</A></li>
        <LI>Next message: <A HREF="023926.html">[mod_python] mod_python + mod_authz_host w/o mod_auth_digest causes
 ~1Mb leak per apache graceful restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23941">[ date ]</a>
              <a href="thread.html#23941">[ thread ]</a>
              <a href="subject.html#23941">[ subject ]</a>
              <a href="author.html#23941">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Graham,

Thanks for your responses - I did find some interesting emails based on the
search terms you mentioned; many of them elaborating on hacks I'd pondered
on but dismissed as being too &quot;hacky&quot; - as I'm not familiar with mod_python
I didn't want to settle for a hack when there was a better way, but it was
taking me a while to come to the realization that there wasn't one..

The hack I'm toying with at the moment seems very simple and with only one
limitation, being that you can't directly reference &quot;req&quot; in the PSP code,
although I believe you can use &quot;psp.req&quot; to get the desired effect if
needed..
Here it is:


	class WriteThingy(StringIO.StringIO):
		def write(self, string, flush=1):
	      	StringIO.StringIO.write(self, string)

	vars['req'] = WriteThingy()
	template.run(vars)
	html = vars['req'].getvalue()


The only problem I have with this is that it's written after scrutinizing
the internals of the .run() method, and based on knowledge of exactly which
order things happen in, which could change with future versions.

Please let me know if you can see any holes in this..

Thanks for putting in the feature request - I think it's a completely worthy
feature, and if implemented, I think there would be more room for further
enhancements in future...


&lt;WARNING: Going off on a tangent ahead..&gt;


Here's another little something that I'm wondering whether is possible or
not in PSP... Below is a sample of my own little scripting language - works
the same way as PSP but it's all written the long way rather than evaluating
python code. It's got a few advantages over PSP from what I can tell, but
I'm willing to throw this one away to get the increased speed of PSP -
anyway, here goes:


	&lt;div&gt;
		^if iFromUID == iUID^
			&lt;b&gt;You&lt;/b&gt;
		^else^
			&lt;b&gt;^escape(sFromAlias)^&lt;/b&gt;
		^endif^
		^*TRIM*^:
	&lt;/div&gt;



Now the result ends up on the screen as either &quot;You :&quot; or &quot;Bob :&quot; (or
whatever sFromAlias was)..  It's actually supposed to be &quot;You:&quot; or &quot;Bob:&quot;
(ie: without the space) but because html renderers turn strings of
whitespace into a single space, I added the *TRIM* directive, which
basically just removes whitespace to the left and right of where it's placed
to achieve this while still retaining readable code..

Any way you know of to achieve this with PSP?
What made me think of it is that it'd be simple to add if the PSP class
manipulated the result as a string rather then writing it out directly..

Thanks for your help,
Aaron.



-----Original Message-----
From: Graham Dumpleton [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>] 
Sent: Friday, 29 June 2007 6:31 p.m.
To: Aaron Robinson
Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
Subject: Re: [mod_python] Checking a PSP-generated response before starting
to send it..?

Hmmm, those search terms may not have helped much. Try:

  <A HREF="http://www.modpython.org/pipermail/mod_python/2005-May/018230.html">http://www.modpython.org/pipermail/mod_python/2005-May/018230.html</A>

instead.

Have also logged an issued for adding proper way of doing this since
it does come up occasionally.

  <A HREF="https://issues.apache.org/jira/browse/MODPYTHON-236">https://issues.apache.org/jira/browse/MODPYTHON-236</A>

Graham

On 29/06/07, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>&gt; wrote:
&gt;<i> On 29/06/07, Aaron Robinson &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">aaron.robinson at mojoworld.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; For lack of any feedback on this, I've come up with 1/2 a solution
</I>&gt;<i> &gt; (possibly), but would still very much appreciate *any* input..
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've written a output filter which read()'s all the input it gets, then
</I>&gt;<i> &gt; stores it in an attribute it creates on filter.req (and write()'s
</I>nothing),
&gt;<i> &gt; then when it reads None (end of stream) it can compare the total page to
</I>the
&gt;<i> &gt; last sent page and either write() the whole page (unmodified) or change
</I>the
&gt;<i> &gt; 'Last-Modified' date to the previous date + change the response code to
</I>a
&gt;<i> &gt; 304...  problem is that I don't know if it's possible for an output
</I>filter
&gt;<i> &gt; to change the response code..
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Any ideas on how to make an output filter change the response code, or
</I>&gt;<i> &gt; whether there are any holes in this plan - or preferably if there's a
</I>way to
&gt;<i> &gt; avoid this completely?
</I>&gt;<i>
</I>&gt;<i> Can't be done.
</I>&gt;<i>
</I>&gt;<i> I'm a bit busy to respond in detail on this at the moment, but do a
</I>&gt;<i> search through the mailing list archives using the search box on
</I>&gt;<i> www.modpython.org for 'publisher PSP'. This should pick up messages
</I>&gt;<i> which talk about using PSP from publisher, thus giving you more
</I>&gt;<i> control. There has also been past discussions on how to make PSP
</I>&gt;<i> output to a string so one can process output like you want. Look for
</I>&gt;<i> 'PSP request wrapper'.
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> &gt; Thanks,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Aaron.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  ________________________________
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; From: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python-bounces at modpython.org</A>
</I>&gt;<i> &gt; [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python-bounces at modpython.org</A>] On Behalf Of
</I>&gt;<i> &gt; Aaron Robinson
</I>&gt;<i> &gt;  Sent: Wednesday, 27 June 2007 11:28 p.m.
</I>&gt;<i> &gt;  To: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;<i> &gt;  Subject: [mod_python] Checking a PSP-generated response before starting
</I>to
&gt;<i> &gt; send it..?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hi all,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm running Apache 2.2.4 on Win32 with mod_python 3.3.1 and Python
</I>2.5.1.
&gt;<i> &gt;
</I>&gt;<i> &gt; I'm completely new to Apache (and hence mod_python), but am reasonably
</I>&gt;<i> &gt; proficient with python itself.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm working on a web service where all content is generated on the fly,
</I>and
&gt;<i> &gt; am wanting to use PSP to facilitate this.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Making as much use as possible of &quot;304: Not Modified&quot; is extremely
</I>important
&gt;<i> &gt; to this project to reduce bandwidth, which is difficult as I have to
</I>&gt;<i> &gt; generate the content before I know whether it's different (&quot;been
</I>modified&quot;)
&gt;<i> &gt; from the last time I sent it or not..
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I previously used a mechanism (not using Apache) where I would generate
</I>the
&gt;<i> &gt; response, then take a hash of it and if it matched the hash of the last
</I>&gt;<i> &gt; response I sent, I would instead send a &quot;304: Not Modified&quot;.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My problem is that when using PSP.run(), the response has already been
</I>sent
&gt;<i> &gt; by the time it's finished being generated, so I have no opportunity to
</I>step
&gt;<i> &gt; in and examine the response to see if sending a 304 is possible.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm needing an across-the-board mechanism for dealing with this - I
</I>thought
&gt;<i> &gt; of serializing the &quot;vars&quot; dictionary before passing it in and taking a
</I>hash
&gt;<i> &gt; of that for comparison, but this is hardly full-proof, as it would
</I>&gt;<i> &gt; (incorrectly) lead to responding with a 304 even with different
</I>&quot;session&quot;
&gt;<i> &gt; information, or, in the slightly odd case that the PSP file made use of
</I>&gt;<i> &gt; random.random(), etc.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Just a thought: Is there a more general mechanism that can detect
</I>identical
&gt;<i> &gt; content to a previous response on the way out and replace it with a 304?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks in advance,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Aaron.
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mod_python mailing list
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023940.html">[mod_python] Checking a PSP-generated response before starting to
	send it..?
</A></li>
	<LI>Next message: <A HREF="023926.html">[mod_python] mod_python + mod_authz_host w/o mod_auth_digest causes
 ~1Mb leak per apache graceful restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23941">[ date ]</a>
              <a href="thread.html#23941">[ thread ]</a>
              <a href="subject.html#23941">[ subject ]</a>
              <a href="author.html#23941">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
