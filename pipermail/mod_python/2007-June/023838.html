<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] having modpython make a data base connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20having%20modpython%20make%20a%20data%20base%20connection&In-Reply-To=20070613030141.GE8187%40asu.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023837.html">
   <LINK REL="Next"  HREF="023836.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] having modpython make a data base connection</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20having%20modpython%20make%20a%20data%20base%20connection&In-Reply-To=20070613030141.GE8187%40asu.edu"
       TITLE="[mod_python] having modpython make a data base connection">graham.dumpleton at gmail.com
       </A><BR>
    <I>Wed Jun 13 03:31:07 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023837.html">[mod_python] having modpython make a data base connection
</A></li>
        <LI>Next message: <A HREF="023836.html">[mod_python] having modpython make a data base connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23838">[ date ]</a>
              <a href="thread.html#23838">[ thread ]</a>
              <a href="subject.html#23838">[ subject ]</a>
              <a href="author.html#23838">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/06/07, David Bear &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">David.Bear at asu.edu</A>&gt; wrote:
&gt;<i> On Wed, Jun 13, 2007 at 11:58:06AM +1000, Graham Dumpleton wrote:
</I>&gt;<i> &gt; For starters, if you haven't read:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  <A HREF="http://www.dscpl.com.au/wiki/ModPython/Articles/TheProcessInterpreterModel">http://www.dscpl.com.au/wiki/ModPython/Articles/TheProcessInterpreterModel</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; do so.
</I>&gt;<i>
</I>&gt;<i> If I structure the program to exist in a single file, make my db
</I>&gt;<i> connections from there, does this imply that I could have 'multiple'
</I>&gt;<i> connections made to the data base?
</I>&gt;<i>
</I>&gt;<i> I am using the worker mode of apache on linux. This means that I do
</I>&gt;<i> have multiple child apaches and threads in each. So, I'm not sure if I
</I>&gt;<i> have 5 children and 2 thread per child that would imply 10 connections
</I>&gt;<i> to the data base?
</I>
Depends.

The handler module is only loaded once for each process (ignoring
reloads at this point), and all the threads in each process execute
against the same loaded module. If the database client supports one
connection and then multiple sessions across that one connection, then
you can create and/or cache the database connection object at global
scope within the handler module. In that case, there would only be one
connection per process.

BTW, 2 threads per child in worker is very low, normally it would be
25 by default. Also, I strongly discourage creating database
connections as a side effect of importing the handler module as a
failure to connect can then leave the web application unusable as
nothing is going to re-trigger the module import to allow the
connection code to rerun. Thus, even though it delays the creation of
the connection, I would only do it the first time a handler requires
the connection. This does mean that connection creation and caching
has to be thread protected to stop more than one being created at the
same time.

Now, if instead you create the connection for every request as I am
sure some will promote as the simplest approach and for some database
also more than adequate, then every request can result in a separate
connection thus meaning as many as number of process times number of
threads. Noting that Apache may create more than 2 child processes
when under heavy load.

&gt;<i> &gt; Second, be very careful about putting database connection objects in
</I>&gt;<i> &gt; modules which are candidates for reloading. For stuff about how to
</I>&gt;<i> &gt; deal with this if you want to do that, read documentation for
</I>&gt;<i> &gt; import_module() in:
</I>&gt;<i>
</I>&gt;<i> I don't know why a module would be reloaded. I'm still thinking in
</I>&gt;<i> terms of the cgi model where the script runs, connection made to db,
</I>&gt;<i> data is updated, connection closed, script dies, done.
</I>&gt;<i>
</I>&gt;<i> Under what conditions would a module be reloaded?
</I>
For a handler module which is located in the document tree (not on
sys.path), it will be automatically reloaded when its code file, or
the code file of any related module also in the document tree or found
on the mod_python module importers path has changed. Same applied to
publisher modules.

The issue with reloading is that the module is reimported into a new
module instance and the old data thrown away. If however the old data
isn't able to clean itself up properly through destructors, ie. close
database connections, you will get resource leakage. The documentation
I pointed you to shows how you can supply hooks to copy data across
from old module to new module when a reload occurs, thus allowing
already open database connection object to be reused.

If you don't want to deal with the possibilities of module reloading,
then turn it off using the directive:

  PythonAutoReload Off

Do this though and you will need to restart Apache when you make any
code changes to modules even if they are in the document tree (not on
sys.path).

&gt;<i> And if I use the
</I>&gt;<i> handler mode (no publisher or psp) and the data base connection is
</I>&gt;<i> made in the handler function, does that imply the connection is made
</I>&gt;<i> when apache is started (and the script is run for the first time) and
</I>&gt;<i> lives untill apache dies?
</I>
Depends on whether you are then caching the database connection object
at global scope in module as I mentioned before. Again note that such
caching has to be thread protected to stop multiple requests trying to
do it at the same time in the same process.

Graham

&gt;<i> &gt;  <A HREF="http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html">http://www.modpython.org/live/current/doc-html/pyapi-apmeth.html</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'll let others argue the merits of database connection pooling versus
</I>&gt;<i> &gt; a connection per request as not an area I have direct experience with.
</I>&gt;<i>
</I>&gt;<i> As they say, I'm against premature optimization -- I don't know enough
</I>&gt;<i> to care at this point. I just want to run in 'safest way', that means
</I>&gt;<i> the most predictable.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Graham
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 13/06/07, David Bear &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">David.Bear at asu.edu</A>&gt; wrote:
</I>&gt;<i> &gt; &gt;I don't want to start a flame ware here, but I'm starting to develop
</I>&gt;<i> &gt; &gt;and application that will connect to a postgresql server.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;I realize there are probably a dozen things I should know about
</I>&gt;<i> &gt; &gt;modpython before I begin.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;I will be use the standard python handler. I won't be using publisher
</I>&gt;<i> &gt; &gt;or psp (at least I think).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;I am afraid of issues like having modpython make a db connection
</I>&gt;<i> &gt; &gt;object that is not shared properly --. The more terrifying question is
</I>&gt;<i> &gt; &gt;what should be be asking.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;I wonder if someone has develop a top ten rules of thumb when using
</I>&gt;<i> &gt; &gt;modpython with sql data base connections?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;--
</I>&gt;<i> &gt; &gt;David Bear
</I>&gt;<i> &gt; &gt;phone:  602-496-0424
</I>&gt;<i> &gt; &gt;fax:    602-496-0955
</I>&gt;<i> &gt; &gt;College of Public Programs/ASU
</I>&gt;<i> &gt; &gt;University Center Rm 622
</I>&gt;<i> &gt; &gt;411 N Central
</I>&gt;<i> &gt; &gt;Phoenix, AZ 85007-0685
</I>&gt;<i> &gt; &gt; &quot;Beware the IP portfolio, everyone will be suspect of trespassing&quot;
</I>&gt;<i> &gt; &gt;_______________________________________________
</I>&gt;<i> &gt; &gt;Mod_python mailing list
</I>&gt;<i> &gt; &gt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt; &gt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> David Bear
</I>&gt;<i> phone:  602-496-0424
</I>&gt;<i> fax:    602-496-0955
</I>&gt;<i> College of Public Programs/ASU
</I>&gt;<i> University Center Rm 622
</I>&gt;<i> 411 N Central
</I>&gt;<i> Phoenix, AZ 85007-0685
</I>&gt;<i>  &quot;Beware the IP portfolio, everyone will be suspect of trespassing&quot;
</I>&gt;<i>
</I></PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023837.html">[mod_python] having modpython make a data base connection
</A></li>
	<LI>Next message: <A HREF="023836.html">[mod_python] having modpython make a data base connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23838">[ date ]</a>
              <a href="thread.html#23838">[ thread ]</a>
              <a href="subject.html#23838">[ subject ]</a>
              <a href="author.html#23838">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
