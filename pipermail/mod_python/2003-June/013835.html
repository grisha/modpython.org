<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Apache, Threading and Multi-Processing Modules
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Apache%2C%20Threading%20and%20Multi-Processing%20Modules&In-Reply-To=200306111152.32398.jgardner%40jonathangardner.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013833.html">
   <LINK REL="Next"  HREF="013834.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Apache, Threading and Multi-Processing Modules</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>kevin douglas</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Apache%2C%20Threading%20and%20Multi-Processing%20Modules&In-Reply-To=200306111152.32398.jgardner%40jonathangardner.net"
       TITLE="[mod_python] Apache, Threading and Multi-Processing Modules">fitnah55 at hotmail.com
       </A><BR>
    <I>Wed Jun 11 15:40:16 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="013833.html">[mod_python] Apache, Threading and Multi-Processing Modules
</A></li>
        <LI>Next message: <A HREF="013834.html">[mod_python] Apache, Threading and Multi-Processing Modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13835">[ date ]</a>
              <a href="thread.html#13835">[ thread ]</a>
              <a href="subject.html#13835">[ subject ]</a>
              <a href="author.html#13835">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
as far as i understand, apache2 was supposed to fix and/or make possible
the memory pooling issue... i don't think MMDBMS w/ an effective apache
interface is a reality yet, but that's certainly going to be the
intent..

for connection pooling and other stuff you obviously have to design and
write proper multiplexing code to allocate your resources effectively,
but as far as windows goes i wouldn't have a clue and wouldn't want to

I do believe that there is one main interpreter in mod_python and each
thread has sub-interpreters.. Although with the new worker model it
might
be one main interpreter per child and one sub-interpreter per thread..
regardless you can munge it to work all in one interpreter or a couple
other ways with the config options which should allow memory pooling to
some extent

mysql just got $15M in financing though so I don't think a MMDBMS module
from them is going to be free, if it even ever becomes available

python mapping objects are pretty easy to cache though, as long as you
don't
have to manage consistency across disparate processes

just my two cents :p




-----Original Message-----
From: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python-bounces at modpython.org</A>
[mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python-bounces at modpython.org</A>] On Behalf Of Jonathan Gardner
Sent: Wednesday, June 11, 2003 2:53 PM
To: Paul Robinson; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
Subject: Re: [mod_python] Apache, Threading and Multi-Processing Modules


-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On Wednesday 11 June 2003 09:45, Paul Robinson wrote:
&gt;<i> Apache has a number of modes of operation when it comes to threading 
</I>&gt;<i> and forking, I would like to understand how these things interact with
</I>
&gt;<i> Python subinterpreters 
</I>&gt;<i> [<A HREF="http://www.modpython.org/live/current/doc-html/pyapi-interps.html]">http://www.modpython.org/live/current/doc-html/pyapi-interps.html]</A> 
</I>&gt;<i> and issues such as the Python global interpreter lock (GIL) 
</I>&gt;<i> [<A HREF="http://www.python.org/doc/current/api/threads.html].">http://www.python.org/doc/current/api/threads.html].</A>
</I>&gt;<i>
</I>
First off, think of each child process as an entirely seperate process.
There 
is *no* *way* that any process can communicate with each other except
through 
shared memory or pipes. I am no expert on the inner workings of
mod_python, 
but reading the documentation it sounds like each process is entirely 
independent of each other. Each process can have a number of 
&quot;subinterpreters&quot; based on the configuration, but these subinterpreters
are 
isolated from one another as well.

As far as GIL is concerned, you really shouldn't be concerned about that
at 
all. That is there just to ensure that no thread is caught with its
pants 
down. Or, in more technical terms, that the state of the python
interpreter 
and associated data is always consistent when there is no lock.

&gt;<i> For example, on a Windows platform where there is a single 
</I>&gt;<i> multi-threaded Apache process (mpm_wint
</I>&gt;<i> [<A HREF="http://httpd.apache.org/docs-2.0/mod/mpm_winnt.html]">http://httpd.apache.org/docs-2.0/mod/mpm_winnt.html]</A>) is it correct 
</I>&gt;<i> to say that mod_python would not be able to take advantage of a 
</I>&gt;<i> multi-processor machine due to the GIL?
</I>&gt;<i>
</I>
I don't know the details of how Windows machines handle threads, but I
do know 
that threads are like &quot;lightweight&quot; processes. They can and will be run
on 
seperate processors on a normal OS.

Whether or not each thread can communicate with each other -- the
impression I 
get from the documentation is that this is not so. It sounds like each
thread 
will have their own main interpreter, and a number of sub-interpreters 
depending on the configuration. This means that there is no way to 
communicate among threads via Python, as the Python main interpreters
are 
seperate.

&gt;<i> In another, given Apache running in the prefork MPM
</I>&gt;<i> [<A HREF="http://httpd.apache.org/docs-2.0/mod/prefork.html]-">http://httpd.apache.org/docs-2.0/mod/prefork.html]-</A> is it a) possible
</I>
&gt;<i> or b) useful to have a global, per-Apache-process persitant data 
</I>&gt;<i> strucuture sharing a pool of (threadsafe) database connections. I 
</I>&gt;<i> would say not useful since that process will only ever be running a 
</I>&gt;<i> single mod_python request at a time - hence more than one item in the 
</I>&gt;<i> pool would be useless. Given the &quot;worker MPM&quot; 
</I>&gt;<i> [<A HREF="http://httpd.apache.org/docs-2.0/mod/worker.html]">http://httpd.apache.org/docs-2.0/mod/worker.html]</A> however it may be 
</I>&gt;<i> useful but it's not clear to me if it would be possible.
</I>&gt;<i>
</I>
I don't think this is possible.

&gt;<i> Taking the specific example of database connections (let me note I 
</I>&gt;<i> have read and believe I understand FAQ 3.3) is it ever useful or 
</I>&gt;<i> possible to share a pool of database connectors, rather than a single 
</I>&gt;<i> connector in the global namespace. I assume that code such as that in 
</I>&gt;<i> FAQ 3.3 would require additional locking mechanisms in order to 
</I>&gt;<i> function correctly in a multi-threaded Apache environment?
</I>&gt;<i>
</I>
Within a single apache thread and process, yes, you can share database 
connections. If your handler decides to thread while processing a
request, 
then it can share with the same database connections in that apache
thread.

However, I don't think what you really want (independent processes or
threads 
sharing connections) is possible.

&gt;<i> I bet there must be some code in existing projects that does stuff 
</I>&gt;<i> like this. Any pointers?
</I>&gt;<i>
</I>
Sorry, I looked into this on my own, both with mod_perl and mod_python,
and 
there is nothing out there that I could see.

The best solution is to keep the connection alive, and reuse it for new 
incoming requests. If the database doesn't like having so many open and 
inactive connections, you can just hangup at the end of the request, and

connect at the beginning of the request. Some databases have more
overhead 
than others.

Remember I said that the only way to talk between processes is via
shared 
memory or pipes. Shared memory isn't supported well (if at all) in
python. 
Pipes are something you already are familiar with -- TCP sockets are
pipes 
between two processes that can be located on different servers.

So another solution that I have thought of but have no reason to
implement is 
a database connection pool server. In this scenario, you would get a 
connection to the database server by connecting to the connection pool 
server. After the initial connection, the connection server just relays
your 
commands word for word to the database. When you disconnect, it puts the

connection back into the pool.

This isn't too far different from a session server, or other kinds of 
meta-servers. The main stink I have with these is that servers are a
pain in 
the butt to write right, and they are always a nightmare to manage. And
you 
always have to have a plan for scaleability, or it will eventually bite
you.

&gt;<i> Maybe I'm confusing myself at the moment - maybe some other people as 
</I>&gt;<i> well ;-)
</I>&gt;<i>
</I>
I found your message to be extremely precise in its wording, with plenty
of 
useful references. That was both helpful and refreshing.

- -- 
Jonathan Gardner &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jgardner at jonathangardner.net</A>&gt;
(was <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jgardn at alumni.washington.edu</A>)
Live Free, Use Linux!
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.1 (GNU/Linux)

iD8DBQE+53pvWgwF3QvpWNwRAr5nAKDNvpjSXZ4+0GSWQWh11V2EdbhvjACgyAmP
kvdSO3JZYSfwDGo1XI3JOvY=
=IQH6
-----END PGP SIGNATURE-----

_______________________________________________
Mod_python mailing list
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013833.html">[mod_python] Apache, Threading and Multi-Processing Modules
</A></li>
	<LI>Next message: <A HREF="013834.html">[mod_python] Apache, Threading and Multi-Processing Modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13835">[ date ]</a>
              <a href="thread.html#13835">[ thread ]</a>
              <a href="subject.html#13835">[ subject ]</a>
              <a href="author.html#13835">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
