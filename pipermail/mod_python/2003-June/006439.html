<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Apache, Threading and Multi-Processing Modules
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Apache%2C%20Threading%20and%20Multi-Processing%20Modules&In-Reply-To=3EE75C9D.2000900%40groupbc.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006432.html">
   <LINK REL="Next"  HREF="006441.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Apache, Threading and Multi-Processing Modules</H1>
    <B>Jonathan Gardner</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Apache%2C%20Threading%20and%20Multi-Processing%20Modules&In-Reply-To=3EE75C9D.2000900%40groupbc.com"
       TITLE="[mod_python] Apache, Threading and Multi-Processing Modules">jgardner at jonathangardner.net
       </A><BR>
    <I>Wed Jun 11 11:52:31 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="006432.html">[mod_python] Apache, Threading and Multi-Processing Modules
</A></li>
        <LI>Next message: <A HREF="006441.html">[mod_python] Apache, Threading and Multi-Processing Modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6439">[ date ]</a>
              <a href="thread.html#6439">[ thread ]</a>
              <a href="subject.html#6439">[ subject ]</a>
              <a href="author.html#6439">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<table border=0 width="100%"><tr><td>
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On Wednesday 11 June 2003 09:45, Paul Robinson wrote:
&gt;<i> Apache has a number of modes of operation when it comes to threading and
</I>&gt;<i> forking, I would like to understand how these things interact with
</I>&gt;<i> Python subinterpreters
</I>&gt;<i> [<A HREF="http://www.modpython.org/live/current/doc-html/pyapi-interps.html]">http://www.modpython.org/live/current/doc-html/pyapi-interps.html]</A> and
</I>&gt;<i> issues such as the Python global interpreter lock (GIL)
</I>&gt;<i> [<A HREF="http://www.python.org/doc/current/api/threads.html].">http://www.python.org/doc/current/api/threads.html].</A>
</I>&gt;<i>
</I>
First off, think of each child process as an entirely seperate process. There 
is *no* *way* that any process can communicate with each other except through 
shared memory or pipes. I am no expert on the inner workings of mod_python, 
but reading the documentation it sounds like each process is entirely 
independent of each other. Each process can have a number of 
&quot;subinterpreters&quot; based on the configuration, but these subinterpreters are 
isolated from one another as well.

As far as GIL is concerned, you really shouldn't be concerned about that at 
all. That is there just to ensure that no thread is caught with its pants 
down. Or, in more technical terms, that the state of the python interpreter 
and associated data is always consistent when there is no lock.

&gt;<i> For example, on a Windows platform where there is a single
</I>&gt;<i> multi-threaded Apache process (mpm_wint
</I>&gt;<i> [<A HREF="http://httpd.apache.org/docs-2.0/mod/mpm_winnt.html]">http://httpd.apache.org/docs-2.0/mod/mpm_winnt.html]</A>) is it correct to
</I>&gt;<i> say that mod_python would not be able to take advantage of a
</I>&gt;<i> multi-processor machine due to the GIL?
</I>&gt;<i>
</I>
I don't know the details of how Windows machines handle threads, but I do know 
that threads are like &quot;lightweight&quot; processes. They can and will be run on 
seperate processors on a normal OS.

Whether or not each thread can communicate with each other -- the impression I 
get from the documentation is that this is not so. It sounds like each thread 
will have their own main interpreter, and a number of sub-interpreters 
depending on the configuration. This means that there is no way to 
communicate among threads via Python, as the Python main interpreters are 
seperate.

&gt;<i> In another, given Apache running in the prefork MPM
</I>&gt;<i> [<A HREF="http://httpd.apache.org/docs-2.0/mod/prefork.html]-">http://httpd.apache.org/docs-2.0/mod/prefork.html]-</A> is it a) possible
</I>&gt;<i> or b) useful to have a global, per-Apache-process persitant data
</I>&gt;<i> strucuture sharing a pool of (threadsafe) database connections. I would
</I>&gt;<i> say not useful since that process will only ever be running a single
</I>&gt;<i> mod_python request at a time - hence more than one item in the pool
</I>&gt;<i> would be useless. Given the &quot;worker MPM&quot;
</I>&gt;<i> [<A HREF="http://httpd.apache.org/docs-2.0/mod/worker.html]">http://httpd.apache.org/docs-2.0/mod/worker.html]</A> however it may be
</I>&gt;<i> useful but it's not clear to me if it would be possible.
</I>&gt;<i>
</I>
I don't think this is possible.

&gt;<i> Taking the specific example of database connections (let me note I have
</I>&gt;<i> read and believe I understand FAQ 3.3) is it ever useful or possible to
</I>&gt;<i> share a pool of database connectors, rather than a single connector in
</I>&gt;<i> the global namespace. I assume that code such as that in FAQ 3.3 would
</I>&gt;<i> require additional locking mechanisms in order to function correctly in
</I>&gt;<i> a multi-threaded Apache environment?
</I>&gt;<i>
</I>
Within a single apache thread and process, yes, you can share database 
connections. If your handler decides to thread while processing a request, 
then it can share with the same database connections in that apache thread.

However, I don't think what you really want (independent processes or threads 
sharing connections) is possible.

&gt;<i> I bet there must be some code in existing projects that does stuff like
</I>&gt;<i> this. Any pointers?
</I>&gt;<i>
</I>
Sorry, I looked into this on my own, both with mod_perl and mod_python, and 
there is nothing out there that I could see.

The best solution is to keep the connection alive, and reuse it for new 
incoming requests. If the database doesn't like having so many open and 
inactive connections, you can just hangup at the end of the request, and 
connect at the beginning of the request. Some databases have more overhead 
than others.

Remember I said that the only way to talk between processes is via shared 
memory or pipes. Shared memory isn't supported well (if at all) in python. 
Pipes are something you already are familiar with -- TCP sockets are pipes 
between two processes that can be located on different servers.

So another solution that I have thought of but have no reason to implement is 
a database connection pool server. In this scenario, you would get a 
connection to the database server by connecting to the connection pool 
server. After the initial connection, the connection server just relays your 
commands word for word to the database. When you disconnect, it puts the 
connection back into the pool.

This isn't too far different from a session server, or other kinds of 
meta-servers. The main stink I have with these is that servers are a pain in 
the butt to write right, and they are always a nightmare to manage. And you 
always have to have a plan for scaleability, or it will eventually bite you.

&gt;<i> Maybe I'm confusing myself at the moment - maybe some other people as
</I>&gt;<i> well ;-)
</I>&gt;<i>
</I>
I found your message to be extremely precise in its wording, with plenty of 
useful references. That was both helpful and refreshing.

- -- 
Jonathan Gardner &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jgardner at jonathangardner.net</A>&gt;
(was <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jgardn at alumni.washington.edu</A>)
Live Free, Use Linux!
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.1 (GNU/Linux)

iD8DBQE+53pvWgwF3QvpWNwRAr5nAKDNvpjSXZ4+0GSWQWh11V2EdbhvjACgyAmP
kvdSO3JZYSfwDGo1XI3JOvY=
=IQH6
-----END PGP SIGNATURE-----

</PRE>
<!--endarticle-->
</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006432.html">[mod_python] Apache, Threading and Multi-Processing Modules
</A></li>
	<LI>Next message: <A HREF="006441.html">[mod_python] Apache, Threading and Multi-Processing Modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6439">[ date ]</a>
              <a href="thread.html#6439">[ thread ]</a>
              <a href="subject.html#6439">[ subject ]</a>
              <a href="author.html#6439">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
