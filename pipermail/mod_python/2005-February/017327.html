<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Custom handler thread safety
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Custom%20handler%20thread%20safety&In-Reply-To=1107469841.28292%40dscpl.user.openhosting.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017326.html">
   <LINK REL="Next"  HREF="017329.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Custom handler thread safety</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Huzaifa Tapal</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Custom%20handler%20thread%20safety&In-Reply-To=1107469841.28292%40dscpl.user.openhosting.com"
       TITLE="[mod_python] Custom handler thread safety">huzaifa at hostway.com
       </A><BR>
    <I>Thu Feb  3 18:34:38 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017326.html">[mod_python] Custom handler thread safety
</A></li>
        <LI>Next message: <A HREF="017329.html">[mod_python] Custom handler thread safety
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17327">[ date ]</a>
              <a href="thread.html#17327">[ thread ]</a>
              <a href="subject.html#17327">[ subject ]</a>
              <a href="author.html#17327">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Graham, your response helped a lot.  I wanted to ask another question
related to my original post.  If I am taking advantage of the shared memory
that using multithreaded MPM and storing objects such as db connections and
parsed page templates, do you see a threat with not locking the thread when
making use of those shared resources.

To be more clear, if I have resource object A in the shared memory and
without any kind of thread locking in place, Thread 1 is using lets say the
database connection object, at the same time Thread 2 needs the same
connection object, would that cause any type of a Race Condition?

Do you think it's a good idea to wrap usage of those shared object such as
when I am retrieving it from the cache with the lock.acquire() call on the
thread?

You are of great help, thanks a lot.

Hozi

-----Original Message-----
From: Graham Dumpleton [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>] 
Sent: Thursday, February 03, 2005 4:31 PM
To: Huzaifa Tapal
Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
Subject: Re: [mod_python] Custom handler thread safety

There are bugs in mod_python if using threaded MPM. See:

  <A HREF="http://www.dscpl.com.au/projects/vampire/PATCHES">http://www.dscpl.com.au/projects/vampire/PATCHES</A>

This may in part contribute to your problems.

Original discussion about it is in mailing list archive. See:

  <A HREF="http://www.modpython.org/pipermail/mod_python/2004-October/016634.html">http://www.modpython.org/pipermail/mod_python/2004-October/016634.html</A>

There are emails about the second part of the bug as well, but can't
spot them right now.

There are also various gotchas when using autoreloading that may also
be affecting you.

Look at the patches as a starting point and then we can perhaps go
step by step through some of your issues and how you are implementing
your code.

Graham

Huzaifa Tapal wrote ..
&gt;<i> Hello All,
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I wrote a custom mod_python handler that kind of mimicks the cgihandler
</I>&gt;<i> but
</I>&gt;<i> really is an extension to a web framework we have in house.  Just to be
</I>&gt;<i> safe, I implemented thread locking into the handler before any request
</I>&gt;<i> is
</I>&gt;<i> processed.  The application is running on a debian box running Apache 2
</I>&gt;<i> multithreaded with mod_python 3.13.  We are gaining huge performance
</I>&gt;<i> increases by caching our template objects and db connection objects.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> The problem I am running into is that if I run through the application,
</I>&gt;<i> each
</I>&gt;<i> request takes on average 300 ms to process.  However, when we benchmark
</I>&gt;<i> with
</I>&gt;<i> 20 concurrent users, the average goes up to around 2200 ms.  I am very
</I>&gt;<i> sure
</I>&gt;<i> that this is due to a thread locking shared objects in memory which
</I>results
&gt;<i> in another thread waiting for the lock to be released.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> If I take the thread locking mechanism out then we run into problems with
</I>&gt;<i> there being too many connections being made to the MySQL db if the cached
</I>&gt;<i> connection is being used and then the db starts dropping connections.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Any help would be much appreciated.  Even if there are any other good
</I>&gt;<i> handlers out there other than cgihandler and publisher.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Hozi
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017326.html">[mod_python] Custom handler thread safety
</A></li>
	<LI>Next message: <A HREF="017329.html">[mod_python] Custom handler thread safety
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17327">[ date ]</a>
              <a href="thread.html#17327">[ thread ]</a>
              <a href="subject.html#17327">[ subject ]</a>
              <a href="author.html#17327">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
