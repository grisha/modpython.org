<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] MySQLSession available!!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20MySQLSession%20available%21%21&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022697.html">
   <LINK REL="Next"  HREF="022699.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] MySQLSession available!!</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20MySQLSession%20available%21%21&In-Reply-To="
       TITLE="[mod_python] MySQLSession available!!">grahamd at dscpl.com.au
       </A><BR>
    <I>Mon Nov 27 16:03:55 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="022697.html">[mod_python] Re: Session Hell...
</A></li>
        <LI>Next message: <A HREF="022699.html">[mod_python] Long URIs and Path Info
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22698">[ date ]</a>
              <a href="thread.html#22698">[ thread ]</a>
              <a href="subject.html#22698">[ subject ]</a>
              <a href="author.html#22698">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Database backed session classes have been discussed before on the mailing
list with examples posted. Use the search box on the mod_python web site to
search for the past posts. For example:

  <A HREF="http://www.modpython.org/pipermail/mod_python/2006-June/021433.html">http://www.modpython.org/pipermail/mod_python/2006-June/021433.html</A>

There is no need for you to embed your session class within the mod_python
Session.py code file. Keep it separate. Database backed session classes are
unlikely to be included in mod_python as that then imposes a dependency on
a third party package which isn't something we really want to have to have
because of maintenance/support issues.

Graham

Martijn Moeling wrote ..
&gt;<i> Well after investigating &quot;sessions.py&quot; a bit more I have come up with a
</I>&gt;<i> working MySQLSession object added to &quot;sessions.py&quot;
</I>&gt;<i> 
</I>&gt;<i> See code (only the changed parts) below....
</I>&gt;<i> 
</I>&gt;<i> The nasty thing is that it will be overwritten by any mod_python
</I>&gt;<i> updates, or if it is interesting enough (hopefully) it gets into the
</I>&gt;<i> next major mod_python release.
</I>&gt;<i> 
</I>&gt;<i> By checking for the req.cursor, there is no need for importing MySQLdb
</I>&gt;<i> into session.py
</I>&gt;<i> 
</I>&gt;<i> See code (only the changed parts) below....
</I>&gt;<i> 
</I>&gt;<i> 8&lt;---------------------------------------------------------------------
</I>&gt;<i> ########################################################################
</I>&gt;<i> ###
</I>&gt;<i> ## MySQLSession
</I>&gt;<i> ## M. Moeling, <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">martijn at xs4us.nu</A>
</I>&gt;<i> ##
</I>&gt;<i> ## In order to use MySQLSession:
</I>&gt;<i> ## in your handler.py:        
</I>&gt;<i> ## import MySQLdb
</I>&gt;<i> ##
</I>&gt;<i> ##  Somewhere before the session stuff use:
</I>&gt;<i> ##
</I>&gt;<i> ##  req.db =
</I>&gt;<i> MySQLdb.connect(host=Chost,user=Cuser,passwd=Cpasswd,db=Cdb)
</I>&gt;<i> ##  req.cursor = req.db.cursor()
</I>&gt;<i> ## 
</I>&gt;<i> ##  When req.cursor is existing, Session.py will default to MySQLSession
</I>&gt;<i> ##  Can be overruled with pythonoptions in apache config
</I>&gt;<i> ##
</I>&gt;<i> ## To create table in MySQL use the following:
</I>&gt;<i> ## CREATE TABLE `Session` (
</I>&gt;<i> ##  `sid` varchar(50) NOT NULL,
</I>&gt;<i> ##  `store` text NOT NULL,
</I>&gt;<i> ##  PRIMARY KEY  (`sid`)
</I>&gt;<i> ## ) TYPE=MyISAM;
</I>&gt;<i>         
</I>&gt;<i> def mysql_cleanup(req):
</I>&gt;<i>     req.cursor.execute(&quot;Select * from Session&quot;)
</I>&gt;<i>     AllSessions = req.cursor.fetchall()
</I>&gt;<i>     for records in AllSessions:
</I>&gt;<i>         session = cPicle.loads(record[1])
</I>&gt;<i>         if (time.time() - session[&quot;_accessed&quot;]) &gt; session[&quot;_timeout&quot;]:
</I>&gt;<i>             req.cursor.execute(&quot;DELETE FROM Session where
</I>&gt;<i> sid='&quot;+session[0]+&quot;'&quot;)        
</I>&gt;<i> 
</I>&gt;<i>         
</I>&gt;<i> class MySQLSession(BaseSession):
</I>&gt;<i> 
</I>&gt;<i>     def __init__(self, req, sid=0, secret=None, timeout=0, lock=1):
</I>&gt;<i> 
</I>&gt;<i>         BaseSession.__init__(self, req, sid=sid, secret=secret,
</I>&gt;<i>                              timeout=timeout, lock=lock)
</I>&gt;<i> 
</I>&gt;<i>     def do_cleanup(self):
</I>&gt;<i>         self._req.register_cleanup(MySQL_cleanup, self._req)
</I>&gt;<i>         self._req.log_error(&quot;MySQLSession: registered session cleanup.&quot;,
</I>&gt;<i>                             apache.APLOG_NOTICE)
</I>&gt;<i> 
</I>&gt;<i>     def do_load(self):
</I>&gt;<i>         self._req.cursor.execute(&quot;Select store from Session where
</I>&gt;<i> sid='&quot;+self._sid+&quot;'&quot;)
</I>&gt;<i>         store=self._req.cursor.fetchone()
</I>&gt;<i>         if self._req.cursor.rowcount==1:
</I>&gt;<i>             return cPickle.loads(store[0])
</I>&gt;<i>         return None
</I>&gt;<i> 
</I>&gt;<i>     def do_save(self, dict):
</I>&gt;<i>         self._req.cursor.execute(&quot;Select store from Session where
</I>&gt;<i> sid='&quot;+self._sid+&quot;'&quot;)
</I>&gt;<i>         store=self._req.cursor.fetchone()
</I>&gt;<i>         if self._req.cursor.rowcount==1:
</I>&gt;<i>             Query=&quot;Update Session set store=\&quot;&quot;+cPickle.dumps(dict)+&quot;\&quot;
</I>&gt;<i> where sid='&quot;+self._sid+&quot;'&quot;
</I>&gt;<i>         else:
</I>&gt;<i>             Query=&quot;Insert into Session (sid,store) values
</I>&gt;<i> (\&quot;&quot;+self._sid+&quot;\&quot;,\&quot;&quot;+cPickle.dumps(dict)+&quot;\&quot;)&quot;           
</I>&gt;<i>          self._req.cursor.execute(Query)
</I>&gt;<i>         
</I>&gt;<i>     def do_delete(self):
</I>&gt;<i>         try:
</I>&gt;<i>             self._req.cursor.execute(&quot;DELETE FROM Session where
</I>&gt;<i> sid='&quot;+self._sid+&quot;'&quot;)
</I>&gt;<i>         except:
</I>&gt;<i>             pass
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ########################################################################
</I>&gt;<i> ###
</I>&gt;<i> ## Session
</I>&gt;<i> 
</I>&gt;<i> ## Changes made for MySQLSession
</I>&gt;<i> ## the application should set req.cursor as an MySQLdb cursor object
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> def Session(req, sid=0, secret=None, timeout=0, lock=1):
</I>&gt;<i> 
</I>&gt;<i>     opts = req.get_options()
</I>&gt;<i>     if opts.has_key('session'):
</I>&gt;<i>         # Check the apache config for the type of session
</I>&gt;<i>         sess_type = opts['session']
</I>&gt;<i>     else:
</I>&gt;<i>         ## MySQLSession is default when req.cursor exists
</I>&gt;<i>         if req.cursor:
</I>&gt;<i>             sess_type = 'MySQLSession'
</I>&gt;<i>         else:
</I>&gt;<i>         ## END of MySQLSession modification
</I>&gt;<i>             # no session class in config so get the default for the
</I>&gt;<i> platform
</I>&gt;<i>             threaded = _apache.mpm_query(apache.AP_MPMQ_IS_THREADED)
</I>&gt;<i>             forked = _apache.mpm_query(apache.AP_MPMQ_IS_FORKED)
</I>&gt;<i>             daemons =  _apache.mpm_query(apache.AP_MPMQ_MAX_DAEMONS)
</I>&gt;<i>             if (threaded and ((not forked) or (daemons == 1))):
</I>&gt;<i>                 sess_type = 'MemorySession'
</I>&gt;<i>             else:
</I>&gt;<i>                 sess_type = 'DbmSession'
</I>&gt;<i> 
</I>&gt;<i>     if sess_type == 'FileSession':
</I>&gt;<i>         sess =  FileSession
</I>&gt;<i>     elif sess_type == 'DbmSession':
</I>&gt;<i>         sess = DbmSession
</I>&gt;<i>     elif sess_type == 'MemorySession':
</I>&gt;<i>         sess = MemorySession
</I>&gt;<i>     ## Added for MySQLSession
</I>&gt;<i>     elif sess_type == 'MySQLSession':
</I>&gt;<i>         sess = MySQLSession
</I>&gt;<i>     else:
</I>&gt;<i>         # TODO Add capability to load a user defined class
</I>&gt;<i>         # For now, just raise an exception.
</I>&gt;<i>         raise Exception, 'Unknown session type %s' % sess_type
</I>&gt;<i> 
</I>&gt;<i>     return sess(req, sid=sid, secret=secret,
</I>&gt;<i>                          timeout=timeout, lock=lock)
</I>&gt;<i> 8&lt;---------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> -----Oorspronkelijk bericht-----
</I>&gt;<i> Van: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python-bounces at modpython.org</A>
</I>&gt;<i> [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python-bounces at modpython.org</A>] Namens Martijn Moeling
</I>&gt;<i> Verzonden: Monday, November 27, 2006 12:08 PM
</I>&gt;<i> Aan: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;<i> Onderwerp: [mod_python] Session Storage : memory, file, dbm....Mysql?
</I>&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I am building an application framework (yes!) with very specific needs.
</I>&gt;<i> One of the main problems I run into is session management, I'll explain:
</I>&gt;<i> 
</I>&gt;<i> My application (Running on Fedora) Is prepared for multiple front-end
</I>&gt;<i> servers communicating on an Internal backbone to a database server.
</I>&gt;<i> Think of it as some sort of web based Citrix able to run on all browsers
</I>&gt;<i> without the need of client-side software installation. Fully
</I>&gt;<i> programmable in python (even the front-end) and if the time gets there
</I>&gt;<i> even Visual. So build a browser based application within an application
</I>&gt;<i> with central storage and management. Mod Python is used to implement a
</I>&gt;<i> part of an OS if you wish to call it that way.
</I>&gt;<i> 
</I>&gt;<i> The front ends will be Apache servers with mod_python connected to the
</I>&gt;<i> Internet using round-robin DNS (Multiple ip addresses for one Host), In
</I>&gt;<i> theory a PC will do a DNS lookup and get the address of one of the
</I>&gt;<i> front-end, this PC will keep this address until the TTL makes it expire
</I>&gt;<i> in the DNS caches along the way, there is no problem since each session
</I>&gt;<i> will be served by the same front end.
</I>&gt;<i> 
</I>&gt;<i> But I need to find a way to get the session information into the MySQL
</I>&gt;<i> database in the backend server to enable central monitoring and inter
</I>&gt;<i> user communications etc. (think of a Messenger online userlist as an
</I>&gt;<i> example)
</I>&gt;<i> 
</I>&gt;<i> I can of course write stuff to maintain this sort of data in the MySQL
</I>&gt;<i> database but what if the session ends other than a user logging out
</I>&gt;<i> nicely (broken connection, browser close etc.)
</I>&gt;<i> 
</I>&gt;<i> It would be nice to have a MySQLsession object, an extra parameter could
</I>&gt;<i> be added like a MySQLdb cursor object, or am I wrong and are sessions
</I>&gt;<i> maintained by Apache (since modpython does not seem to keep track of
</I>&gt;<i> Session closing), or is there any way to &quot;list&quot; active sessions from
</I>&gt;<i> within modpython, so I can let the backend server send an http request
</I>&gt;<i> to the front-end and doing something like:
</I>&gt;<i> <A HREF="http://frontend1/getsessionlist">http://frontend1/getsessionlist</A> which returns a comma separated list of
</I>&gt;<i> active session id's, so the stale session records in the database can be
</I>&gt;<i> removed.
</I>&gt;<i> 
</I>&gt;<i> I have been researching Session.py
</I>&gt;<i> Where I interestingly found:
</I>&gt;<i> (from def dbm_cleanup(data):)
</I>&gt;<i> 
</I>&gt;<i> If (time.time() - dict[_accessed]) &gt; dict[&quot;_timeout]:
</I>&gt;<i> 	old.append(key)
</I>&gt;<i> ..
</I>&gt;<i> ..
</I>&gt;<i> ..
</I>&gt;<i> For key in old:
</I>&gt;<i> 	Del db[key]
</I>&gt;<i> 
</I>&gt;<i> If I understand this right, this means that this is done to see if the
</I>&gt;<i> session is ended right? So It I alter Session.py I could make my own
</I>&gt;<i> MySQL Session right?
</I>&gt;<i> 
</I>&gt;<i> Would there be anyone else Interested in a MySQLSession object and what
</I>&gt;<i> do I need to take into account when modifying it?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Please feel free to comment on any of this,
</I>&gt;<i> 
</I>&gt;<i> Martijn Moeling
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022697.html">[mod_python] Re: Session Hell...
</A></li>
	<LI>Next message: <A HREF="022699.html">[mod_python] Long URIs and Path Info
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22698">[ date ]</a>
              <a href="thread.html#22698">[ thread ]</a>
              <a href="subject.html#22698">[ subject ]</a>
              <a href="author.html#22698">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
