<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] mod_python, the ITK MPM and sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%2C%20the%20ITK%20MPM%20and%20sessions&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022535.html">
   <LINK REL="Next"  HREF="022538.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] mod_python, the ITK MPM and sessions</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%2C%20the%20ITK%20MPM%20and%20sessions&In-Reply-To="
       TITLE="[mod_python] mod_python, the ITK MPM and sessions">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Nov  7 18:23:07 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="022535.html">[mod_python] Re: installing xp problems
</A></li>
        <LI>Next message: <A HREF="022538.html">[mod_python] mod_python, the ITK MPM and sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22537">[ date ]</a>
              <a href="thread.html#22537">[ thread ]</a>
              <a href="subject.html#22537">[ subject ]</a>
              <a href="author.html#22537">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>That is not the Python global interpreter lock. It is a mutex lock created
using Apache for the purposes of mediating access to session stuff. Thus,
you probably need to look into the lock mechanism of Apache and try
and understand it. The issue may be the initial permissions used when
mod_python initialises/acquires the locks. Specifically look around the
call to apr_global_mutex_create() in init_mutexes() in src/mod_python.c
source code.

Graham

Sam Morris wrote ..
&gt;<i> I'm experimenting with the ITK MPM for Apache, available
</I>&gt;<i> from &lt;<A HREF="http://home.samfundet.no/~sesse/mpm-itk/">http://home.samfundet.no/~sesse/mpm-itk/</A>&gt;. It is based on the
</I>&gt;<i> Prefork MPM; after a request is parsed, the process handling the
</I>&gt;<i> request changes user id to one specified in the config for the virtual
</I>&gt;<i> host.
</I>&gt;<i> 
</I>&gt;<i> I'm having trouble getting mod_python's session support to work. When
</I>&gt;<i> trying to create a new instance of Session, I get this message: 
</I>&gt;<i> 
</I>&gt;<i>  [warn] (13)Permission denied: Failed to acquire global mutex
</I>&gt;<i>  lock at index 6&quot;
</I>&gt;<i> 
</I>&gt;<i> Strace says the following system call fails:
</I>&gt;<i> 
</I>&gt;<i>  semop(4227100, 0xb7ca6a30, 1)           = -1 EACCES (Permission denied)
</I>&gt;<i> 
</I>&gt;<i> and ipcs(1) says:
</I>&gt;<i> 
</I>&gt;<i>  ------ Semaphore Arrays --------
</I>&gt;<i>  0x00000000 4227100    www-data  600        1         
</I>&gt;<i> 
</I>&gt;<i> I assume this is because the child process (running as user test1) needs
</I>&gt;<i> access to the semaphore (for the Global Interpreter Lock?) living inside
</I>&gt;<i> a
</I>&gt;<i> process that is running as www-data. If this is the case, I guess there's
</I>&gt;<i> no way past this problem short of redesigning (mod_)python and/or
</I>&gt;<i> apache/ITK? :)
</I>&gt;<i> 
</I>&gt;<i> Here's the full traceback:
</I>&gt;<i> 
</I>&gt;<i> Mod_python error: &quot;PythonHandler pytest&quot;
</I>&gt;<i> 
</I>&gt;<i>  Traceback (most recent call last):
</I>&gt;<i>   File &quot;/usr/lib/python2.4/site-packages/mod_python/apache.py&quot;, line 299,
</I>&gt;<i>     in HandlerDispatch
</I>&gt;<i>     result = object(req)
</I>&gt;<i>   File &quot;/home/sam/pytest/pytest.py&quot;, line 8, in handler
</I>&gt;<i>     s = Session.Session (req)
</I>&gt;<i>   File &quot;/usr/lib/python2.4/site-packages/mod_python/Session.py&quot;, line 735,
</I>&gt;<i>     in Session
</I>&gt;<i>     timeout=timeout, lock=lock)
</I>&gt;<i>   File &quot;/usr/lib/python2.4/site-packages/mod_python/Session.py&quot;, line 337,
</I>&gt;<i>     in __init__
</I>&gt;<i>     timeout=timeout, lock=lock)
</I>&gt;<i>   File &quot;/usr/lib/python2.4/site-packages/mod_python/Session.py&quot;, line 165,
</I>&gt;<i>     in __init__
</I>&gt;<i>     self.lock()
</I>&gt;<i>   File &quot;/usr/lib/python2.4/site-packages/mod_python/Session.py&quot;, line 255,
</I>&gt;<i>     in lock
</I>&gt;<i>     _apache._global_lock(self._req.server, self._sid)
</I>&gt;<i>  ValueError: Failed to acquire global mutex lock
</I>&gt;<i> 
</I>&gt;<i> And my apache configuration:
</I>&gt;<i> 
</I>&gt;<i>  &lt;VirtualHost *&gt;
</I>&gt;<i>     DocumentRoot /var/www/
</I>&gt;<i>     AssignUserId test1 test1
</I>&gt;<i>     ServerName test1
</I>&gt;<i> 
</I>&gt;<i>     ErrorLog /var/log/apache2/error.log
</I>&gt;<i>     LogLevel warn
</I>&gt;<i>     CustomLog /var/log/apache2/access.log combined
</I>&gt;<i> 
</I>&gt;<i>     SetHandler mod_python
</I>&gt;<i>     PythonPath &quot;['/home/sam/pytest'] + sys.path&quot;
</I>&gt;<i>     PythonHandler pytest
</I>&gt;<i>     PythonOption session_directory /tmp
</I>&gt;<i>     PythonOption mutex_directory /tmp
</I>&gt;<i>     PythonDebug on
</I>&gt;<i>  &lt;/VirtualHost&gt;
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Sam Morris
</I>&gt;<i> <A HREF="http://robots.org.uk/">http://robots.org.uk/</A>
</I>&gt;<i> 
</I>&gt;<i> PGP key id 1024D/5EA01078
</I>&gt;<i> 3412 EA18 1277 354B 991B  C869 B219 7FDB 5EA0 1078
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022535.html">[mod_python] Re: installing xp problems
</A></li>
	<LI>Next message: <A HREF="022538.html">[mod_python] mod_python, the ITK MPM and sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22537">[ date ]</a>
              <a href="thread.html#22537">[ thread ]</a>
              <a href="subject.html#22537">[ subject ]</a>
              <a href="author.html#22537">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
