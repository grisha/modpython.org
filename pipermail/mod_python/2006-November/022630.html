<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Approach to mod_python &quot;secure&quot; code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Approach%20to%20mod_python%20%22secure%22%20code&In-Reply-To=455D90A0.2000003%40paranoici.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022629.html">
   <LINK REL="Next"  HREF="022631.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Approach to mod_python &quot;secure&quot; code</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Deron Meranda</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Approach%20to%20mod_python%20%22secure%22%20code&In-Reply-To=455D90A0.2000003%40paranoici.org"
       TITLE="[mod_python] Approach to mod_python &quot;secure&quot; code">deron.meranda at gmail.com
       </A><BR>
    <I>Fri Nov 17 11:57:18 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="022629.html">[mod_python] Approach to mod_python &quot;secure&quot; code
</A></li>
        <LI>Next message: <A HREF="022631.html">[mod_python] Approach to mod_python &quot;secure&quot; code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22630">[ date ]</a>
              <a href="thread.html#22630">[ thread ]</a>
              <a href="subject.html#22630">[ subject ]</a>
              <a href="author.html#22630">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/17/06, fizban &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">fizban at paranoici.org</A>&gt; wrote:
&gt;<i> 1* take req.uri, str() it (just in case?) and split('/') it.
</I>&gt;<i> [stuff = str(req.uri).split('/')
</I>
There's no need to str() it.  It's already a string.  It will also have been
url decoded.

However req.uri is not UTF-8 decoded, in case you deal with
Unicode URLs.  If you care about that you should probably do

   try:
       uri = req.uri().decode('utf8')
   except UnicodeDecodeError:
       raise apache.SERVER_RETURN, apache.HTTP_BAD_REQUEST

Doing a split('/') is fine, assuming of course you are not overriding
the default Apache configuration of the AllowEncodedSlashes directive:
<A HREF="http://httpd.apache.org/docs/2.2/mod/core.html#allowencodedslashes">http://httpd.apache.org/docs/2.2/mod/core.html#allowencodedslashes</A>

&gt;<i> 2* take stuff[1], see if isalpha(), if so see if stuff[1] is in a tuple
</I>&gt;<i> (contains all the valid &quot;sections&quot;). if it is, we assume stuff[1] is
</I>&gt;<i> safe to deal with. if not, we return a custom 404.
</I>
Watch out for empty parts.  For example if the url contains /////

The isalpha() test is fine.  If you've unicode decoded it just be
aware that isalpha() will also allow non-latin letters too.

&gt;<i> 3* if stuff[1] is valid, and it is in a tuple containing a list of
</I>&gt;<i> special sections with a matching function, we run that function
</I>&gt;<i> [eval(&quot;%s(%s)&quot; % (section, &quot;req&quot;))].
</I>
This should be secure, if you are definitely checking the string
against a known acceptible list of them.

But it's bad Python form!  eval should only be used as a last
resort (unless you don't care about form/style).  It's almost
never necessary.  This is a bad habit encouraged by PHP that
you will want to unlearn quickly.

The simplest way to do this without eval is to change your
list into a dictionary.  Assuming you have something like

   allowed_sections = ['one', 'two', 'three']

change it to

   def one(req): ...
   def two(req): ...
   def three(req): ...
   section_mapping = { 'one': one,  'two': two,  'three': three }

and then rather than eval call them as

   try:
       section_mapping[section]( req )
   except KeyError:
       raise apache.SERVER_RETURN, apache.HTTP_NOT_FOUND

Another common way is to put all your functions inside a class
and use getattr and such.  You might want to get the O'Reilly
book &quot;Python Cookbook&quot; to learn more techniques of Python
programming.

&gt;<i> some of these functions take other
</I>&gt;<i> arguments, like a (pre validated with similar approach) stuff[2], or
</I>&gt;<i> req.args (same here). otherwise we run some other routine, by parsing
</I>&gt;<i> and req.writing a template.
</I>&gt;<i> [stuff[2] or req.args are this time matched against regular expressions,
</I>&gt;<i> to see if they fit the arguments taken by the section functions]
</I>
It is very common to use regular expressions to parse URIs.  Many
python web frameworks do this, and no reason you shouldn't
as well.  Particularly in Python the named epxression ?P&lt;..&gt; syntax is
quite useful to keep your regex code readable,

   m = re.match( r'/one/(?P&lt;size&gt;\d+)', url)
   size = m.group('size')


&gt;<i> Do you guys think it's a decent approach in terms of &quot;security&quot;? Would
</I>&gt;<i> you take any other validation steps? As I said I'm really new to python
</I>&gt;<i> and mod_python, so since the website has some huge userbase, I'm really
</I>&gt;<i> worried about security..
</I>
Lets just say that what you've shown us shouldn't be insecure,
but we can't say it's secure either.  There's so much that's not
even talked about.  For example the whole user authentication,
SSL, use of database queries, embedded/hardcoded passwords
(which are a definte no-no, especially if you have PythonDebug
turned on).

&gt;<i> We are not using (for various reasons) sql db,
</I>&gt;<i> only templates and local xml basically, so sql inj. is not an issue.
</I>
Okay, but you still might want to worry about other kinds
of injection.  Such as pathname injection, javascript
injection, etc.

What if the URL contains the characters &quot;&lt;![CDATA[&quot;
for example.  That could really mess up some XML processors.

Just be cautious of where the data came from and how you
use it and you should be fine.


&gt;<i> Since the site re-design will force us to change all the URI, I have
</I>&gt;<i> setup some other function to see if str(req.uri) matches moved or
</I>&gt;<i> deleted pages, if so we return 410 or 301 messages. 404 give the
</I>&gt;<i> impression of a messed up site. Is str(req.uri) safe enough to be passed
</I>&gt;<i> as argument to the notfound() or moved() functions I've made?
</I>
Sending a 301 is a very good thing when you move URLs around.
For instance the googlebot indexer when seeing a 301 will be
more likely to trust the new URLs, carrying forward all your earned
rankings, etc.  Also 301's are used by some browsers' bookmark
systems, so that bookmarks are automatically updated.

As for 404s, don't worry about any &quot;impression&quot;.  Use the correct
code for the correct situation.  The only case where I might deviate
from this is to send 302 rather than the recommended 307, since
many old browsers (IE) don't understand 307.

Also you may want to use the symbolic names, such as
apache.HTTP_NOT_FOUND, provided by the modpython.apache
module rather than numbers, as it makes your code more readable.

Good luck.
-- 
Deron Meranda
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022629.html">[mod_python] Approach to mod_python &quot;secure&quot; code
</A></li>
	<LI>Next message: <A HREF="022631.html">[mod_python] Approach to mod_python &quot;secure&quot; code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22630">[ date ]</a>
              <a href="thread.html#22630">[ thread ]</a>
              <a href="subject.html#22630">[ subject ]</a>
              <a href="author.html#22630">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
