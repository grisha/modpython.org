<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] mod_python, the ITK MPM and sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%2C%20the%20ITK%20MPM%20and%20sessions&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022537.html">
   <LINK REL="Next"  HREF="022539.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] mod_python, the ITK MPM and sessions</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%2C%20the%20ITK%20MPM%20and%20sessions&In-Reply-To="
       TITLE="[mod_python] mod_python, the ITK MPM and sessions">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Nov  7 18:46:44 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="022537.html">[mod_python] mod_python, the ITK MPM and sessions
</A></li>
        <LI>Next message: <A HREF="022539.html">[mod_python] Re: mod_python, the ITK MPM and sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22538">[ date ]</a>
              <a href="thread.html#22538">[ thread ]</a>
              <a href="subject.html#22538">[ subject ]</a>
              <a href="author.html#22538">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Graham Dumpleton wrote ..
&gt;<i> That is not the Python global interpreter lock. It is a mutex lock created
</I>&gt;<i> using Apache for the purposes of mediating access to session stuff. Thus,
</I>&gt;<i> you probably need to look into the lock mechanism of Apache and try
</I>&gt;<i> and understand it. The issue may be the initial permissions used when
</I>&gt;<i> mod_python initialises/acquires the locks. Specifically look around the
</I>&gt;<i> call to apr_global_mutex_create() in init_mutexes() in src/mod_python.c
</I>&gt;<i> source code.
</I>
Looking at:

  <A HREF="http://apr.apache.org/docs/apr/apr__global__mutex_8h-source.html">http://apr.apache.org/docs/apr/apr__global__mutex_8h-source.html</A>

you might consider changing mod_python code such that instead of
passing APR_LOCK_DEFAULT to the call of apr_global_mutex_create() in
src/mod_python.c, change it some some other specific locking
mechanism rather than relying on APR to choose one for you.

In other words, try in turn:

 APR_LOCK_FCNTL
 APR_LOCK_FLOCK
 APR_LOCK_SYSVSEM
 APR_LOCK_POSIXSEM
 APR_LOCK_PROC_PTHREAD

and see if you can find one which will work across processes which are
running as different users.

Because you are specifying the mechanism, it may not be portable, but
may allow you to get it to work for your platform at least.

Please do tell us what the results are.

Graham

&gt;<i> Sam Morris wrote ..
</I>&gt;<i> &gt; I'm experimenting with the ITK MPM for Apache, available
</I>&gt;<i> &gt; from &lt;<A HREF="http://home.samfundet.no/~sesse/mpm-itk/">http://home.samfundet.no/~sesse/mpm-itk/</A>&gt;. It is based on the
</I>&gt;<i> &gt; Prefork MPM; after a request is parsed, the process handling the
</I>&gt;<i> &gt; request changes user id to one specified in the config for the virtual
</I>&gt;<i> &gt; host.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'm having trouble getting mod_python's session support to work. When
</I>&gt;<i> &gt; trying to create a new instance of Session, I get this message: 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;  [warn] (13)Permission denied: Failed to acquire global mutex
</I>&gt;<i> &gt;  lock at index 6&quot;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Strace says the following system call fails:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;  semop(4227100, 0xb7ca6a30, 1)           = -1 EACCES (Permission denied)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; and ipcs(1) says:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;  ------ Semaphore Arrays --------
</I>&gt;<i> &gt;  0x00000000 4227100    www-data  600        1         
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I assume this is because the child process (running as user test1) needs
</I>&gt;<i> &gt; access to the semaphore (for the Global Interpreter Lock?) living inside
</I>&gt;<i> &gt; a
</I>&gt;<i> &gt; process that is running as www-data. If this is the case, I guess there's
</I>&gt;<i> &gt; no way past this problem short of redesigning (mod_)python and/or
</I>&gt;<i> &gt; apache/ITK? :)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Here's the full traceback:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Mod_python error: &quot;PythonHandler pytest&quot;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;  Traceback (most recent call last):
</I>&gt;<i> &gt;   File &quot;/usr/lib/python2.4/site-packages/mod_python/apache.py&quot;, line
</I>&gt;<i> 299,
</I>&gt;<i> &gt;     in HandlerDispatch
</I>&gt;<i> &gt;     result = object(req)
</I>&gt;<i> &gt;   File &quot;/home/sam/pytest/pytest.py&quot;, line 8, in handler
</I>&gt;<i> &gt;     s = Session.Session (req)
</I>&gt;<i> &gt;   File &quot;/usr/lib/python2.4/site-packages/mod_python/Session.py&quot;, line
</I>&gt;<i> 735,
</I>&gt;<i> &gt;     in Session
</I>&gt;<i> &gt;     timeout=timeout, lock=lock)
</I>&gt;<i> &gt;   File &quot;/usr/lib/python2.4/site-packages/mod_python/Session.py&quot;, line
</I>&gt;<i> 337,
</I>&gt;<i> &gt;     in __init__
</I>&gt;<i> &gt;     timeout=timeout, lock=lock)
</I>&gt;<i> &gt;   File &quot;/usr/lib/python2.4/site-packages/mod_python/Session.py&quot;, line
</I>&gt;<i> 165,
</I>&gt;<i> &gt;     in __init__
</I>&gt;<i> &gt;     self.lock()
</I>&gt;<i> &gt;   File &quot;/usr/lib/python2.4/site-packages/mod_python/Session.py&quot;, line
</I>&gt;<i> 255,
</I>&gt;<i> &gt;     in lock
</I>&gt;<i> &gt;     _apache._global_lock(self._req.server, self._sid)
</I>&gt;<i> &gt;  ValueError: Failed to acquire global mutex lock
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; And my apache configuration:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;  &lt;VirtualHost *&gt;
</I>&gt;<i> &gt;     DocumentRoot /var/www/
</I>&gt;<i> &gt;     AssignUserId test1 test1
</I>&gt;<i> &gt;     ServerName test1
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;     ErrorLog /var/log/apache2/error.log
</I>&gt;<i> &gt;     LogLevel warn
</I>&gt;<i> &gt;     CustomLog /var/log/apache2/access.log combined
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;     SetHandler mod_python
</I>&gt;<i> &gt;     PythonPath &quot;['/home/sam/pytest'] + sys.path&quot;
</I>&gt;<i> &gt;     PythonHandler pytest
</I>&gt;<i> &gt;     PythonOption session_directory /tmp
</I>&gt;<i> &gt;     PythonOption mutex_directory /tmp
</I>&gt;<i> &gt;     PythonDebug on
</I>&gt;<i> &gt;  &lt;/VirtualHost&gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; -- 
</I>&gt;<i> &gt; Sam Morris
</I>&gt;<i> &gt; <A HREF="http://robots.org.uk/">http://robots.org.uk/</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; PGP key id 1024D/5EA01078
</I>&gt;<i> &gt; 3412 EA18 1277 354B 991B  C869 B219 7FDB 5EA0 1078
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mod_python mailing list
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022537.html">[mod_python] mod_python, the ITK MPM and sessions
</A></li>
	<LI>Next message: <A HREF="022539.html">[mod_python] Re: mod_python, the ITK MPM and sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22538">[ date ]</a>
              <a href="thread.html#22538">[ thread ]</a>
              <a href="subject.html#22538">[ subject ]</a>
              <a href="author.html#22538">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
