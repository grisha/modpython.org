<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Very odd behavior using mysqldb
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Very%20odd%20behavior%20using%20mysqldb&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022078.html">
   <LINK REL="Next"  HREF="022080.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Very odd behavior using mysqldb</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Eric Brunson</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Very%20odd%20behavior%20using%20mysqldb&In-Reply-To="
       TITLE="[mod_python] Very odd behavior using mysqldb">brunson at brunson.com
       </A><BR>
    <I>Fri Sep 15 14:41:36 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="022078.html">[mod_python] Re: Mod_python Digest, Vol 42, Issue 4
</A></li>
        <LI>Next message: <A HREF="022080.html">[mod_python] Very odd behavior using mysqldb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22079">[ date ]</a>
              <a href="thread.html#22079">[ thread ]</a>
              <a href="subject.html#22079">[ subject ]</a>
              <a href="author.html#22079">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've been working on a project using mod_python to access a mysql 
database using the MySQLdb API.  I know mod_python is still considered 
beta under Apache 2, so I thought I'd bring an issue to the attention of 
the list.

I was seeing some very bizarre results when generating dynamic content 
from the database, which I first attributed to PSP caching, but then 
investigated further when I switched to using the publisher handler.  It 
may be the way I've set up my modules and database connections, but I 
haven't convinced myself that I really understand the problem and until 
I do, I'm not going to be happy about it.  I have found a workaround 
that I can live with, but I don't really like it that much because it 
requires constantly connecting to and disconnection from the database.

The problem was simply getting old, wrong results interleaved with new, 
correct results after updating the database.  Simply put, I'm displaying 
data from a table.  My index.py imports a module for generating HTML 
which, in turn, includes a module for doing database access.  The odd 
thing about how I set up the database access, and I think it's pertinent 
to the problem, was that I automatically connect to the database when I 
import the database module.  Like this:

----- database.py -----
import MySQLdb
from mod_python import apache

def Connect():
    return MySQLdb.connect( '<A HREF="mysql://me:pass@localhost/mydatabase'">mysql://me:pass@localhost/mydatabase'</A> )

dbc = Connect()

def someExampleAccessFunction():
    global dbc
    curs = dbc.cursor()
    curs.execute( &quot;select count(0) from sometable&quot; )
    result = curs.fetchall()[0][0]
    curs.close()
    apache.log_error( &quot;result was %s&quot; % result )
    return result

----- end database.py -----

Let's disregard whether that's good programming practice or not, the 
fact is, I could query that value several times by doing a page reload, 
then delete a record from the database and commit the change, then 
subsequent page loads would interleave old results with new results, 
seemingly cyclically.

The key to my confusion is that the error logs for apache would show a 
message for every page reload, and the result from the query would agree 
with whatever data was displayed on the page, correct or incorrect.  
Meanwhile a direct query to the database from the command line would 
always return the correct result from the database.

My best guess so far is that multiple threads in apache get multiple 
copies of mod_python, each with it's own copy of the imported database 
module in memory and each module maintaining a different database 
connection that is somehow caching results.  I've never seen this 
behavior in any application until I tried this under mod_python.  I was 
able to force the correct results to always be returned by getting rid 
of the module variable, dbc, and moving the mysqldb.connect() call to 
inside each function call, opening the database connection, executing my 
sql, then closing the database connection.  This is less than optimal, 
since I may make several database queries during each page load, so 
later today I'll try making the database connection in the index.py, 
then passing the connection handle to each of the calls that need it.  
Also a little less than optimal, but tolerable.

Does anyone have any insight into this behavior?  It's more of an 
academic question at this point, but I wonder if it may lead to an 
improvement if we were able to identify the problem and implement a 
transparent fix.  Also, feel free to let me know if I'm completely 
offbase with my theory of what's going on under the hood.

Thanks,
e.


</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022078.html">[mod_python] Re: Mod_python Digest, Vol 42, Issue 4
</A></li>
	<LI>Next message: <A HREF="022080.html">[mod_python] Very odd behavior using mysqldb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22079">[ date ]</a>
              <a href="thread.html#22079">[ thread ]</a>
              <a href="subject.html#22079">[ subject ]</a>
              <a href="author.html#22079">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
