<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] callable __auth__ (with detailed example code)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20callable%20__auth__%20%28with%20detailed%20example%20code%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020411.html">
   <LINK REL="Next"  HREF="020413.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] callable __auth__ (with detailed example code)</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20callable%20__auth__%20%28with%20detailed%20example%20code%29&In-Reply-To="
       TITLE="[mod_python] callable __auth__ (with detailed example code)">grahamd at dscpl.com.au
       </A><BR>
    <I>Thu Feb 23 17:04:14 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020411.html">[mod_python] invalid command pythonhandler
</A></li>
        <LI>Next message: <A HREF="020413.html">[mod_python] Re: more callable__auth__
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20412">[ date ]</a>
              <a href="thread.html#20412">[ thread ]</a>
              <a href="subject.html#20412">[ subject ]</a>
              <a href="author.html#20412">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I actually get a 500 error if I set up __auth__ function the way you
have written it. This is because of error as described in:

  <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-43">http://issues.apache.org/jira/browse/MODPYTHON-43</A>

Specifically, the __auth__ function is executed in the context of
the globals from mod_python.publisher and not the same file as
the __auth__ function is in. This means the __auth__ function when
executed can't access the validate_user() function.

Do you actually have everything in the one file like this?

Other than that, the __auth__ function is being executed for me.

Can you post the snippet of the Apache configuration where you
set PythonHandler etc for this directory?

Further comments below. 

Robert Thomas Davis wrote ..
&gt;<i> Hey all (mostly graham though)
</I>&gt;<i> 
</I>&gt;<i> Here is exactly what I am trying to do...
</I>&gt;<i> 
</I>&gt;<i> from mod_python import apache
</I>&gt;<i> from mod_python import psp
</I>&gt;<i> from mod_python.Session import Session
</I>&gt;<i> import sys, time
</I>&gt;<i> from sql_defines import *
</I>&gt;<i> from connection_defines import USER, PASS
</I>&gt;<i> 
</I>&gt;<i> # db connection
</I>&gt;<i> db_conn = apache.import_module('db_conn', log=1)
</I>&gt;<i> db = db_conn.connection('Cursor')
</I>&gt;<i> device = apache.import_module('device', log=1)
</I>
Anything not preceeded by an underscore will be accessible by
a URL if using publisher. Thus, users could accessed internals
of &quot;db&quot;.

&gt;<i> def validate_user(req, user, passwd):
</I>&gt;<i> 
</I>&gt;<i>         if passwd == PASS:
</I>&gt;<i>                 # user has successfully authenticated
</I>&gt;<i>                 sess = Session(req)
</I>&gt;<i> 
</I>&gt;<i>                 if sess.has_key('max_inactive'):
</I>&gt;<i>                         # this is an existing session
</I>&gt;<i> 
</I>&gt;<i>                         # check length of inactivity
</I>&gt;<i>                         elapsed = time.time() -
</I>&gt;<i> sess['last']
</I>&gt;<i> 
</I>&gt;<i>                         # reset timer for next request
</I>&gt;<i>                         sess['last'] = time.time()
</I>&gt;<i>                         sess.save()
</I>
The Session class already maintains a last accessed time. Call
sess.last_accessed() to get it.

Note though that Session class doesn't autosave. So even if you don't
update other data in the session, you will still need to save the
session if you want last accessed time to be saved and for automatic
session timeouts to work.

&gt;<i>                         # compare elapsed to maximum
</I>&gt;<i> allowed
</I>&gt;<i>                         if elapsed &gt;
</I>&gt;<i> sess['max_inactive']:
</I>&gt;<i>                                 sess.delete()
</I>&gt;<i> 
</I>&gt;<i>                                 # force user to
</I>&gt;<i> reauthenticate
</I>&gt;<i>                                 return 0
</I>&gt;<i>                         else:
</I>&gt;<i>                                 #...still within time
</I>&gt;<i> limit
</I>&gt;<i> 
</I>&gt;<i>                                 # allow user to
</I>&gt;<i> continue
</I>&gt;<i>                                 return 1
</I>&gt;<i>                 else:
</I>&gt;<i>                         # new session
</I>&gt;<i> 
</I>&gt;<i>                         # set maximum inactivity
</I>&gt;<i> allowed
</I>&gt;<i>                         sess['max_inactive'] = 500
</I>&gt;<i> 
</I>&gt;<i>                         # initialize timer
</I>&gt;<i>                         sess['last'] = time.time()
</I>&gt;<i> 
</I>&gt;<i>                         sess.save()
</I>&gt;<i> 
</I>&gt;<i>                         # allow user to continue
</I>&gt;<i>                         return 1
</I>&gt;<i>         else:
</I>&gt;<i>                 # force user to reauthenticate
</I>&gt;<i>                 return 0
</I>
Again, no leading underscore so validate_user() is directly accessible
to use.

Also, Session class has session timeout mechanism.

&gt;<i> def handle_page_build(req, obj, **kwargs):
</I>&gt;<i> 
</I>&gt;<i>         try:
</I>&gt;<i>                 __create_tables()
</I>&gt;<i>                 page = obj(req, **kwargs)
</I>&gt;<i>         except:
</I>&gt;<i>                 error_page = error.error_page(req,
</I>&gt;<i> sys.exc_info())
</I>&gt;<i>                 return error_page.build()
</I>&gt;<i>         else:
</I>&gt;<i>                 return page.build()
</I>
The validate_user() function is also accessible.

&gt;<i> def index(req):
</I>&gt;<i> 
</I>&gt;<i>         return main(req)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> def main(req):
</I>&gt;<i> 
</I>&gt;<i>         return handle_page_build(req, home.home_page)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> def devices(req):
</I>&gt;<i>         __auth_realm__ = &quot;Devices!&quot;
</I>&gt;<i>         def __auth__(req, user, passwd):
</I>&gt;<i>                 return validate_user(req, user,
</I>&gt;<i> passwd)
</I>&gt;<i>         return handle_page_build(req,
</I>&gt;<i> device.devices_page)
</I>
Graham
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020411.html">[mod_python] invalid command pythonhandler
</A></li>
	<LI>Next message: <A HREF="020413.html">[mod_python] Re: more callable__auth__
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20412">[ date ]</a>
              <a href="thread.html#20412">[ thread ]</a>
              <a href="subject.html#20412">[ subject ]</a>
              <a href="author.html#20412">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
