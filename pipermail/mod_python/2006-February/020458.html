<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] How to make a handler for static files?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20How%20to%20make%20a%20handler%20for%20static%20files%3F&In-Reply-To=76F6F3ED-2A4C-4F1E-AE53-993CFB1744B8%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020457.html">
   <LINK REL="Next"  HREF="020462.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] How to make a handler for static files?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20How%20to%20make%20a%20handler%20for%20static%20files%3F&In-Reply-To=76F6F3ED-2A4C-4F1E-AE53-993CFB1744B8%40dscpl.com.au"
       TITLE="[mod_python] How to make a handler for static files?">grahamd at dscpl.com.au
       </A><BR>
    <I>Mon Feb 27 06:29:56 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020457.html">[mod_python] How to make a handler for static files?
</A></li>
        <LI>Next message: <A HREF="020462.html">[mod_python] How to make a handler for static files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20458">[ date ]</a>
              <a href="thread.html#20458">[ thread ]</a>
              <a href="subject.html#20458">[ subject ]</a>
              <a href="author.html#20458">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Having a little play, got this to sort of work:

RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^subdir/([^/]*\.txt?|[^\./]*)[:;,\.]*$ /testing/rewrite/$1 
[L,NS]

Still have to work out how I can get the leading part of the path from 
the
right hand side automatically inserted based on context, rather than 
doing
it manually.

The basic idea though is that if the file doesn't exist, the rewrite 
rule
will convert a request for the nonexistant &quot;.txt&quot; file in the &quot;subdir&quot; 
to
the parent directory, which in this case happens to be 
&quot;/testing/rewrite&quot;.

Anyone who understands mod_rewrite able to improve on this for me?

Graham

On 27/02/2006, at 8:44 PM, Graham Dumpleton wrote:

&gt;<i> If your intent is only to serve up static files, you might be better 
</I>&gt;<i> off using
</I>&gt;<i> Apache rewrite rules rather than using mod_python.
</I>&gt;<i>
</I>&gt;<i> I've not got my head around rewrite rules yet, but maybe someone else
</I>&gt;<i> here understand them better and can suggest something to try.
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> On 27/02/2006, at 8:58 PM, Scott Chapman wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Scott Chapman wrote:
</I>&gt;&gt;&gt;<i> Hi all!
</I>&gt;&gt;&gt;<i> I want to make a funky handler for static files.  It should return 
</I>&gt;&gt;&gt;<i> the requested static file if it's in the directory requested.  If 
</I>&gt;&gt;&gt;<i> it's not there, it should move up a directory and try there.
</I>&gt;&gt;<i> Well,
</I>&gt;&gt;<i> Here's what I came up with in the code and it works great.  It 
</I>&gt;&gt;<i> doesn't handle logging issues but it's step #1.  It looks first in 
</I>&gt;&gt;<i> the site specific directory then in the shared directory.  I had the 
</I>&gt;&gt;<i> spec &quot;backwards&quot; above.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> '''This little handler receives requests for files that would 
</I>&gt;&gt;&gt;<i> normally be sent statically.
</I>&gt;&gt;&gt;<i> If the file requested is in /images, and the sites internal name is 
</I>&gt;&gt;&gt;<i> &quot;mischko&quot; then it will look in:
</I>&gt;&gt;&gt;<i> /images/mischko for the file.  If it's not there, it will look in 
</I>&gt;&gt;&gt;<i> /images for it.
</I>&gt;&gt;&gt;<i> This allows a site to have custom versions of things and if it 
</I>&gt;&gt;&gt;<i> doesn't, use the shared versions.
</I>&gt;&gt;&gt;<i> It also allows the site to have a template that is happily ignorant 
</I>&gt;&gt;&gt;<i> of the situation.'''
</I>&gt;&gt;&gt;<i> from mod_python import apache
</I>&gt;&gt;&gt;<i> import os
</I>&gt;&gt;&gt;<i> import psycopg2
</I>&gt;&gt;&gt;<i> def parse_uri(uri):
</I>&gt;&gt;&gt;<i>     uri_list = uri.split('/')
</I>&gt;&gt;&gt;<i>     uri_list.insert(0,'')
</I>&gt;&gt;&gt;<i>     uri_list=uri_list[-3:]
</I>&gt;&gt;&gt;<i>     return uri_list
</I>&gt;&gt;&gt;<i> def _getInternalName(alias):
</I>&gt;&gt;&gt;<i>         _conn = psycopg2.connect(&quot;user=foo dbname=bar host=127.0.0.1 
</I>&gt;&gt;&gt;<i> password=barfoo&quot;)
</I>&gt;&gt;&gt;<i>         _cursor = _conn.cursor()
</I>&gt;&gt;&gt;<i>         query = &quot;SELECT hostname FROM host_aliases WHERE 
</I>&gt;&gt;&gt;<i> external_name = %s&quot;
</I>&gt;&gt;&gt;<i>         parms = [alias]
</I>&gt;&gt;&gt;<i>         _cursor.execute(query, parms)
</I>&gt;&gt;&gt;<i>         rval = _cursor.fetchone()
</I>&gt;&gt;&gt;<i>         if rval:
</I>&gt;&gt;&gt;<i>             rval = rval[0]
</I>&gt;&gt;&gt;<i>         _conn.rollback()
</I>&gt;&gt;&gt;<i>         _conn.close()
</I>&gt;&gt;&gt;<i>         return (rval)
</I>&gt;&gt;&gt;<i> def handler(req):
</I>&gt;&gt;&gt;<i>     def _log(message):
</I>&gt;&gt;&gt;<i>         req.log_error(message)
</I>&gt;&gt;&gt;<i>     debug = True
</I>&gt;&gt;&gt;<i>     (subsite, moduleName, methodName)= parse_uri(req.uri)
</I>&gt;&gt;&gt;<i>     internalName = _getInternalName(req.hostname)
</I>&gt;&gt;&gt;<i>     if subsite:
</I>&gt;&gt;&gt;<i>         internalName = _getInternalName(subsite)
</I>&gt;&gt;&gt;<i>     if not internalName:
</I>&gt;&gt;&gt;<i>         if debug: _log('static_handler - illegal host name')
</I>&gt;&gt;&gt;<i>         raise apache.SERVER_RETURN, apache.HTTP_NOT_FOUND
</I>&gt;&gt;&gt;<i>     orig_path = req.filename
</I>&gt;&gt;&gt;<i>     (path, filename) = os.path.split(req.filename)
</I>&gt;&gt;&gt;<i>     new_path = os.path.normpath(path + '/' + internalName + '/' + 
</I>&gt;&gt;&gt;<i> filename)
</I>&gt;&gt;&gt;<i>     if os.path.exists(new_path):
</I>&gt;&gt;&gt;<i>         use_path = new_path
</I>&gt;&gt;&gt;<i>     elif os.path.exists(orig_path):
</I>&gt;&gt;&gt;<i>         use_path = orig_path
</I>&gt;&gt;&gt;<i>     else:
</I>&gt;&gt;&gt;<i>         raise apache.SERVER_RETURN, apache.HTTP_NOT_FOUND
</I>&gt;&gt;&gt;<i>     if debug: _log('static_handler - used path: %s' % use_path)
</I>&gt;&gt;&gt;<i>     req.sendfile(use_path)
</I>&gt;&gt;&gt;<i>     return apache.OK
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -- 
</I>&gt;&gt;<i> q: Why do so many people take an instant dislike to MySQL and PHP?
</I>&gt;&gt;<i> a: It saves time.
</I>&gt;&gt;<i> ps: Use PostgreSQL and Python instead.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020457.html">[mod_python] How to make a handler for static files?
</A></li>
	<LI>Next message: <A HREF="020462.html">[mod_python] How to make a handler for static files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20458">[ date ]</a>
              <a href="thread.html#20458">[ thread ]</a>
              <a href="subject.html#20458">[ subject ]</a>
              <a href="author.html#20458">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
