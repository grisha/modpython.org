<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Problem with PSP and unicode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problem%20with%20PSP%20and%20unicode&In-Reply-To=4817b6fc0602160910u262a4c7el61041f5a662780e5%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020305.html">
   <LINK REL="Next"  HREF="020311.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Problem with PSP and unicode</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Dan Eloff</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problem%20with%20PSP%20and%20unicode&In-Reply-To=4817b6fc0602160910u262a4c7el61041f5a662780e5%40mail.gmail.com"
       TITLE="[mod_python] Problem with PSP and unicode">dan.eloff at gmail.com
       </A><BR>
    <I>Thu Feb 16 12:16:04 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020305.html">[mod_python] Problem with PSP and unicode
</A></li>
        <LI>Next message: <A HREF="020311.html">[mod_python] Problem with PSP and unicode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20307">[ date ]</a>
              <a href="thread.html#20307">[ thread ]</a>
              <a href="subject.html#20307">[ subject ]</a>
              <a href="author.html#20307">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Nicolas, as usual you're right on the money. I meant to post this
yesterday, but I always forget to check the To: field when I reply and it
always ends up going somewhere other than the list (to Gustavo this time,
sorry about that Gustavo.)

Because of the somewhat unusual way in which I use psp, I'm making my own
implementation right now. I treat psp as templates, and I nest them, and
this unfortuantly writes the templates from the innermost to the outermost,
not what I want. I've been getting around this by replacing req.write with a
buffered function (only when running a psp template) and then setting it
back when I'm done. This combined with the unciode issues, and some issues
with the way indentation is handled has persuaded me it's time to do things
myself so I can make sure it works for me.

The way I'm handling the issues with encoding is by simply adding two
optional arguments (input and output encoding) to the constructor that both
default to utf-8 (I thought about auto detecting the input encoding, but I'd
rather not force that, you can always do an auto detect and pass that as the
input encoding anyway.)

With the same input and outut encoding, there isn't any conversions done to
the static content, because I encode static content directly into the output
encoding. I've also done things in such a way that regular strings can be
encoded as utf-8 without any conversion as well. For now I do this by
assuming the string is ascii and therefore valid utf-8. I'm 90% sure that's
fine, because passing a string in any other encoding is just looking for
trouble, there's no way I can guess what it's encoded as so I could fix it
or raise an error, this puts the responsibility for encoding regular strings
on the developer, where it should be. But for any other object I convert to
unicode and then encode it with the output encoding. This ensures
__unicode__ is called preferentially over __str__.

My trouble currently is how to implement the encoding and decoding, the only
part I have working is converting the unicode objects to the output encoding
(by using PyString_AsEncodedObject). I'd like to do the conversion using
python's encoding/decoding abilites and without creating redundant extra
copies (like those created by copying a char buffer into a python string and
then converting.)

I'd love to hear what you think about this, I will send you my code when
it's finished and you can pull it apart and reuse the bits you like.

-Dan

On 2/16/06, Dan Eloff &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">dan.eloff at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Gustavo, here's an example. Suppose some code enforces a maximum length on
</I>&gt;<i> a string. If it's counting on a default encoding of 1 byte per char, and
</I>&gt;<i> does something like len(s) &lt;= 15. For ascii or iso-8859-1 this would work.
</I>&gt;<i> Or the code might use indices or slices (and a lot of code does!) If
</I>&gt;<i> suddenly you have utf-8 encoded chinese, your string is going to triple in
</I>&gt;<i> length, and those functions will have unpredictable behaviour. You could
</I>&gt;<i> think of any number of scenarios, even in the python library. I just
</I>&gt;<i> wouldn't feel confortable about changing the default encoding, you never
</I>&gt;<i> know where it will come back to haunt you. What's so hard about using
</I>&gt;<i> unicode strings in your program and then encoding when you send output
</I>&gt;<i> somewhere?
</I>&gt;<i>
</I>&gt;<i> Of course, like we've noticed in this thread, there is third party code
</I>&gt;<i> that just isn't unicode safe like psp in mod_python that will break if you
</I>&gt;<i> don't mess with the default encoding. It all boils down to seeing what will
</I>&gt;<i> work best in your situation. For myself I would rather do it the right way
</I>&gt;<i> up front in the hopes of saving hassles down the road.
</I>&gt;<i>
</I>&gt;<i> -Dan
</I>&gt;<i>
</I>&gt;<i> On 2/16/06, Gustavo C&#243;rdova Avila &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">gustavo.cordova at q-voz.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Dan Eloff wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Gustavo
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &quot;So, if you can configure your default encoding&quot;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; That would be a bad idea. You don't want to force the interpreter to
</I>&gt;<i> &gt; &gt; use a different encoding, it could cause you all manner of grief with
</I>&gt;<i> &gt; &gt; code that wasn't written for that, and if it's third party code you
</I>&gt;<i> &gt; &gt; can't do much about anything that does break.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hi Dan, thanks for replying.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Do you have any examples of the above?  I haven't had any troubles
</I>&gt;<i> &gt; whatsoever using a default encoding, even when the script source is
</I>&gt;<i> &gt; different from the default encoding (I always use the &quot;-*- coding: xxx
</I>&gt;<i> &gt; -*-&quot; bit at the top of the source file), so while I don't doubt at all
</I>&gt;<i> &gt; what you're saying, having a practical case where fiddling with the
</I>&gt;<i> &gt; default encoding breaks things is good.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Good morning, y'all.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -gus
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20060216/ffef88cf/attachment.html">http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20060216/ffef88cf/attachment.html</A>
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020305.html">[mod_python] Problem with PSP and unicode
</A></li>
	<LI>Next message: <A HREF="020311.html">[mod_python] Problem with PSP and unicode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20307">[ date ]</a>
              <a href="thread.html#20307">[ thread ]</a>
              <a href="subject.html#20307">[ subject ]</a>
              <a href="author.html#20307">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
