<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Problem with mod_python 3.1.4 and PHP 4.3.4
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problem%20with%20mod_python%203.1.4%20and%20PHP%204.3.4&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020189.html">
   <LINK REL="Next"  HREF="020196.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Problem with mod_python 3.1.4 and PHP 4.3.4</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Ville Silventoinen</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problem%20with%20mod_python%203.1.4%20and%20PHP%204.3.4&In-Reply-To="
       TITLE="[mod_python] Problem with mod_python 3.1.4 and PHP 4.3.4">vsi at ebi.ac.uk
       </A><BR>
    <I>Fri Feb  3 11:06:10 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020189.html">[mod_python] How to create package structure?
</A></li>
        <LI>Next message: <A HREF="020196.html">[mod_python] mod_ssl variables are not passed to mod_python auth
	handler
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20192">[ date ]</a>
              <a href="thread.html#20192">[ thread ]</a>
              <a href="subject.html#20192">[ subject ]</a>
              <a href="author.html#20192">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have quite a strange problem with mod_python 3.1.4. I'm using Python 2.4.1 subprocess module to execute simple command, something like:

def handler(req):
     req.content_type = &quot;text/plain&quot;

     ofh = tempfile.TemporaryFile()
     efh = tempfile.TemporaryFile()
     finish = time() + 30

     p = subprocess.Popen(&quot;ps -fu w3nobody&quot;,
                          bufsize=1,
                          stdout=ofh,
                          stderr=efh,
                          shell=True,
                          close_fds=True)

     while p.poll() == None and time() &lt; finish:
         sleep(0.1)

     result = p.poll()
     if result == None:
         req.write(&quot;Command did not finish in 30 seconds!&quot;)
     else:
         # write output, close filehandles ...
     return apache.OK


Normally this works fine. But our web server runs also a Wiki, which uses 
libphp4.so. As soon as someone uses the Wiki, the above mod_python module 
doesn't work, i.e., the command never finishes in 30 seconds. If I 
increase the timeout to 20 minutes, the HTTP request terminates after a 
while with &quot;The document contains no data&quot;. I also tried without 
subprocess (as in Python Cookbook chapter 9.12, which uses popen2, fcntl 
and select), same problem.

I've overcome the problem by not using the subprocess.Popen.poll() method. 
If I use subprocess.Popen.wait(), it works every time, with or without PHP.
This doesn't allow me to use a timeout with commands, however, which 
sometimes can get stuck.

I've &quot;googled&quot; couple of days. I found this bug in Python related to 
threading and subprocess module:

<A HREF="http://mail.python.org/pipermail/python-bugs-list/2006-January/031663.html">http://mail.python.org/pipermail/python-bugs-list/2006-January/031663.html</A>

I also found the problem with MySQL, mod_python and PHP:

<A HREF="http://www.modpython.org/FAQ/faqw.py?req=edit&amp;file=faq02.013.htp">http://www.modpython.org/FAQ/faqw.py?req=edit&amp;file=faq02.013.htp</A>

But I don't see how this could affect subprocess module and I don't use 
MySQL with Python. I also couldn't find any references to conflicting 
libraries between mod_python, Apache, Python or libphp4.so. I've fixed a 
problem earlier related to expat, so the Apache is using the same version 
as Python (I couldn't tell if PHP uses expat).

Our PHP is version 4.3.4, Apache is 2.0.54 running on Linux 2.4.21-27.0.1.ELsmp (CentOS release 3.4).

Any advice would be most welcome! mod_python has otherwise been working great!

Best regards,
Ville


</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020189.html">[mod_python] How to create package structure?
</A></li>
	<LI>Next message: <A HREF="020196.html">[mod_python] mod_ssl variables are not passed to mod_python auth
	handler
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20192">[ date ]</a>
              <a href="thread.html#20192">[ thread ]</a>
              <a href="subject.html#20192">[ subject ]</a>
              <a href="author.html#20192">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
