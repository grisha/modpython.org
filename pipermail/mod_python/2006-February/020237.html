<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: forks, daemons and other beasts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20forks%2C%20daemons%20and%20other%20beasts&In-Reply-To=5f56302b0602111641w746457e6j31abb54da3cec7b0%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020235.html">
   <LINK REL="Next"  HREF="020239.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: forks, daemons and other beasts</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20forks%2C%20daemons%20and%20other%20beasts&In-Reply-To=5f56302b0602111641w746457e6j31abb54da3cec7b0%40mail.gmail.com"
       TITLE="[mod_python] Re: forks, daemons and other beasts">grahamd at dscpl.com.au
       </A><BR>
    <I>Sat Feb 11 20:08:20 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020235.html">[mod_python] Re: forks, daemons and other beasts
</A></li>
        <LI>Next message: <A HREF="020239.html">[mod_python] Re: forks, daemons and other beasts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20237">[ date ]</a>
              <a href="thread.html#20237">[ thread ]</a>
              <a href="subject.html#20237">[ subject ]</a>
              <a href="author.html#20237">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 12/02/2006, at 11:41 AM, Daniel Nogradi wrote:

&gt;&gt;&gt;&gt;&gt;<i> Have you simply considered using a separate thread to do the
</I>&gt;&gt;&gt;&gt;&gt;<i> unpacking?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Hmmmmm, what do you mean exactly? When I do an os.fork the whole
</I>&gt;&gt;&gt;&gt;<i> apache forks, you mean that I should start a brand new thread,  
</I>&gt;&gt;&gt;&gt;<i> outside
</I>&gt;&gt;&gt;&gt;<i> of apache?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Using threads you wouldn't need to do an os.fork(). Simply create a
</I>&gt;&gt;&gt;<i> new thread
</I>&gt;&gt;&gt;<i> using the Python &quot;threading&quot; module inside the Apache process to  
</I>&gt;&gt;&gt;<i> do the
</I>&gt;&gt;&gt;<i> unpacking. You probably just need to detach the thread so it  
</I>&gt;&gt;&gt;<i> finishes
</I>&gt;&gt;&gt;<i> up properly
</I>&gt;&gt;&gt;<i> and doesn't need another thread to wait on it to finish.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Sorry, can't give an example right now as trying to rebuild OS on  
</I>&gt;&gt;&gt;<i> one
</I>&gt;&gt;&gt;<i> of my
</I>&gt;&gt;&gt;<i> machines.
</I>&gt;<i>
</I>&gt;<i> The documentation for thread says that
</I>&gt;<i>
</I>&gt;<i> When the main thread exits, it is system defined whether the other
</I>&gt;<i> threads survive. On SGI IRIX using the native thread implementation,
</I>&gt;<i> they survive. On most other systems, they are killed without executing
</I>&gt;<i> try ... finally clauses or executing object destructors.
</I>&gt;<i>
</I>&gt;<i> I tested this and indeed whatever is called with
</I>&gt;<i> thread.start_new_thread it will die if execution reaches the end of
</I>&gt;<i> the original program.
</I>
I would suggest not using the &quot;thread&quot; module. Use the higher level  
&quot;threading&quot;
module. The detaching I spoke of, is to ensure you call setDaemon()  
on the
thread object before you call start() on the thread.

What happens on Apache shutdown will be an issue. Not because of what
you quote above, but because Apache uses signals to kill off child  
processes
with it sending SIGKILL if it doesn't shutdown promptly after a  
series of
SIGTERM signals.

Because the main thread isn't the Python interpreter, what you state  
above
doesn't even come into play as the main Python thread will not be  
exited to
trigger the situation.

What will happen is that if a zip file is half unpacked and Apache  
decides it
has waited too long, it will simply kill the process with SIGKILL.  
Your code thus
has to be able to cope with possibility that unpacking of zipfile may  
not be
finished in extreme case. This could be handled by doing it into a  
temporary
directive and only moving to final directory in one atomic move at  
the end.
At least then you don't end up with partial results.

If the unpacking was still done in a separate processes which is  
triggered by
XML-RPC, the unpacking could at least be done serialised on order of
receipt. If that process crashes half way through, it could realise  
that it
had died and when starting up, start again consuming pending zip files.
With Apache that would be hard to do, as you have multiple child  
processes
so who would be responsible for clearing out the pending queue on a  
restart.

Graham
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020235.html">[mod_python] Re: forks, daemons and other beasts
</A></li>
	<LI>Next message: <A HREF="020239.html">[mod_python] Re: forks, daemons and other beasts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20237">[ date ]</a>
              <a href="thread.html#20237">[ thread ]</a>
              <a href="subject.html#20237">[ subject ]</a>
              <a href="author.html#20237">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
