<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Problem with PSP and unicode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problem%20with%20PSP%20and%20unicode&In-Reply-To=4817b6fc0602160916x4c7d888g546f43c02d731bdd%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020311.html">
   <LINK REL="Next"  HREF="020313.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Problem with PSP and unicode</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Nicolas Lehuen</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problem%20with%20PSP%20and%20unicode&In-Reply-To=4817b6fc0602160916x4c7d888g546f43c02d731bdd%40mail.gmail.com"
       TITLE="[mod_python] Problem with PSP and unicode">nicolas at lehuen.com
       </A><BR>
    <I>Thu Feb 16 14:46:48 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020311.html">[mod_python] Problem with PSP and unicode
</A></li>
        <LI>Next message: <A HREF="020313.html">[mod_python] Problem with PSP and unicode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20312">[ date ]</a>
              <a href="thread.html#20312">[ thread ]</a>
              <a href="subject.html#20312">[ subject ]</a>
              <a href="author.html#20312">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>2006/2/16, Dan Eloff &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">dan.eloff at gmail.com</A>&gt;:
&gt;<i> With the same input and outut encoding, there isn't any conversions done to
</I>&gt;<i> the static content, because I encode static content directly into the output
</I>&gt;<i> encoding. I've also done things in such a way that regular strings can be
</I>&gt;<i> encoded as utf-8 without any conversion as well. For now I do this by
</I>&gt;<i> assuming the string is ascii and therefore valid utf-8. I'm 90% sure that's
</I>&gt;<i> fine, because passing a string in any other encoding is just looking for
</I>&gt;<i> trouble, there's no way I can guess what it's encoded as so I could fix it
</I>&gt;<i> or raise an error, this puts the responsibility for encoding regular strings
</I>&gt;<i> on the developer, where it should be. But for any other object I convert to
</I>&gt;<i> unicode and then encode it with the output encoding. This ensures
</I>&gt;<i> __unicode__ is called preferentially over __str__.
</I>&gt;<i>
</I>&gt;<i> My trouble currently is how to implement the encoding and decoding, the only
</I>&gt;<i> part I have working is converting the unicode objects to the output encoding
</I>&gt;<i> (by using PyString_AsEncodedObject). I'd like to do the conversion using
</I>&gt;<i> python's encoding/decoding abilites and without creating redundant extra
</I>&gt;<i> copies (like those created by copying a char buffer into a python string and
</I>&gt;<i> then converting.)
</I>&gt;<i>
</I>&gt;<i> I'd love to hear what you think about this, I will send you my code when
</I>&gt;<i> it's finished and you can pull it apart and reuse the bits you like.
</I>&gt;<i>
</I>&gt;<i> -Dan
</I>
If you are using the C API, I don't think there are more efficient
ways than using PyString_AsEncodedObject and try not to think about
the various extra objects that are created in the process...

In-place unicode to string conversion is quite difficult to achieve,
because in the general case you may end up with more bytes than
unicode characters. The Java NIO library doesn't encode nor decode
in-place, and given the efforts they made to remove data copy, I think
it's pretty safe to say that's it's not easily feasable.

I really think you should first worry about having the input and
output coding right, then profile your code to see where the
performance problems are. Most likely, you'll find that they are in
mod_python rather than in the psp module ;).

To me, the fact that PSP is implemented in C is a perfect case of
premature optimisation. It's a quite complicated piece of C code,
parts of it being generated by flex. As a result, it's difficult to
maintain and solving the Unicode issues in this context could be quite
difficult. And it's not like it's proven that writing this module in
pure C is really useful as far as global performance are concerned.

If it were up to me, I would reimplement it in pure Python, and I
don't think the performance loss would be so big. Granted, compilation
would be a little slower, but once the PSP is compiled, performance
should be exactly the same - and implementing a compiler cache is
extremely easy. Plus, the code being more easy to maintain, we could
easily optimize it. Call it &quot;doing it the PyPy way&quot; if you like ;).

Regards,
Nicolas

</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020311.html">[mod_python] Problem with PSP and unicode
</A></li>
	<LI>Next message: <A HREF="020313.html">[mod_python] Problem with PSP and unicode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20312">[ date ]</a>
              <a href="thread.html#20312">[ thread ]</a>
              <a href="subject.html#20312">[ subject ]</a>
              <a href="author.html#20312">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
