<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Strange bug in req.sendfile
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Strange%20bug%20in%20req.sendfile&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016790.html">
   <LINK REL="Next"  HREF="016791.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Strange bug in req.sendfile</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>David Fraser</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Strange%20bug%20in%20req.sendfile&In-Reply-To="
       TITLE="[mod_python] Strange bug in req.sendfile">davidf at sjsoft.com
       </A><BR>
    <I>Thu Nov 11 05:51:51 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="016790.html">[mod_python]  Hello all,
	Questions about Mod Python sessions on Linux
</A></li>
        <LI>Next message: <A HREF="016791.html">[mod_python] Converting code from standard CGI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16787">[ date ]</a>
              <a href="thread.html#16787">[ thread ]</a>
              <a href="subject.html#16787">[ subject ]</a>
              <a href="author.html#16787">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm having a wierd bug on Windows XP with sendfile.
I'm trying to send an image and the image gets corrupted. Sending the 
bytes directly through write works fine.
I've simplified my handler down to bare-bones level and the bug still 
happens.
Even leaving out content_type and send_http_header doesn't fix it...
I've tried to reproduce this problem on Linux and Windows 2000 to no 
avail ... not sure if it is the platform or a bug on this particular 
machine, but it sure is odd.
The file that is sent has exactly the same length but certain bytes are 
changed in it. They seem to be at fairly regular offsets, so it may be a 
bug in Apache's sendfile routine. The mod_python req.sendfile method 
looks fairly simple so I doubt its that.
In at least one case (animals2_corrupted1.jpg), it was exact 8k chunks 
of files being replaced with zeroes, but it didn't seem to be consistent.
In another case, (animals2_corrupted2.jpg), 4 bytes at n*0x1000+0x10 
where replaced with 0x90008112, for various n, and one 8k block was 
replaced by 0s and sent in place of the next 8k block.
I have tested with Firefox and wget to confirm that the problem is not 
browser-related. I couldn't find any significant difference in the 
headers between the host that worked and the one that didn't (both using 
Transfer-Encoding: chunked).
Using latest Apache 2.0.52 and mod_python 3.1.3 (with some minor mods 
but all python, none to the sendfile method.)

Here's the handler:

def handler(req):
    &quot;&quot;&quot;return a page that will be sent to the user&quot;&quot;&quot;
    req.content_type = &quot;image/jpeg&quot;
    req.send_http_header()
    jpegfile = os.path.join(os.path.dirname(__file__), 'animals2.jpg')
    req.sendfile(jpegfile)
    # req.write(open(jpegfile, 'rb').read())
    return apache.OK

The original file, animals2.jpg and some munged versions of it, 
animals2_corrupted{1,2,3,4}.jpg are available here:
<A HREF="http://davidf.sjsoft.com/files/sendfile_corruption/">http://davidf.sjsoft.com/files/sendfile_corruption/</A>
There are also hex dumps and diffs between the hex dumps in case they're 
useful

Any ideas appreciated

David
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016790.html">[mod_python]  Hello all,
	Questions about Mod Python sessions on Linux
</A></li>
	<LI>Next message: <A HREF="016791.html">[mod_python] Converting code from standard CGI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16787">[ date ]</a>
              <a href="thread.html#16787">[ thread ]</a>
              <a href="subject.html#16787">[ subject ]</a>
              <a href="author.html#16787">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
