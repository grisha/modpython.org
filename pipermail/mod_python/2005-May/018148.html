<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] problem w/ authen handler
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20problem%20w/%20authen%20handler&In-Reply-To=5.2.1.1.0.20050520132822.038616a8%40mail.comune.grosseto.it">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018154.html">
   <LINK REL="Next"  HREF="018141.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] problem w/ authen handler</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20problem%20w/%20authen%20handler&In-Reply-To=5.2.1.1.0.20050520132822.038616a8%40mail.comune.grosseto.it"
       TITLE="[mod_python] problem w/ authen handler">grahamd at dscpl.com.au
       </A><BR>
    <I>Sat May 21 05:53:15 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="018154.html">[mod_python] problem w/ authen handler
</A></li>
        <LI>Next message: <A HREF="018141.html">[mod_python] Installig mod_python on Win XP.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18148">[ date ]</a>
              <a href="thread.html#18148">[ thread ]</a>
              <a href="subject.html#18148">[ subject ]</a>
              <a href="author.html#18148">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Some questions for you about this.

How does this information fit into the larger scheme of what you are
trying to do? Are you trying to separate this out into a separate
handler phase so that you don't have to duplicate that code in every
mod_python content handler? Are mod_python content handlers being used
exclusively to deliver up content, or are you just using mod_python
as a way of processing the SSL stuff and content handler phases would
be handled by non mod_python handlers such as PHP, CGI or static
page delivery?

The reason I am prying is that in Vampire, it notionally splits the
content handler phase into two parts. There is still the execution of
a handler to deliver up the content, but there is also a new phase
introduced of loginhandler. By default this implements a basic user
authentication scheme in the style of mod_python.publisher across
traditional content handlers. The default loginhandler can though be
replaced with your own which implements some other mechanism such as
one which uses sessions and forms based login screens. Because this
loginhandler is executed notionally within the Apache content handler
phase, it will have access to the SSL environment that you have
found is only added if req.add_common_vars() is called from the
content handler itself and not earlier phases.

Thus, with the appropriate configuration information to enable it,
you could with Vampire have:

from mod_python import apache
import vampire

def loginhandler(req):
     req.add_common_vars()
     req.subprocess_env['insideAuthH']='valueSetFromAuthH'
     req.user='pippo'
     #return apache.HTTP_UNAUTHORIZED
     # Call through to original default loginhandler.
     return vampire.loginhandler(req)

def handler(req):
     #req.add_common_vars()
     req.subprocess_env['pytest']='itWorksFromPublisher'
     req.content_type = &quot;text/plain&quot;
     req.write(&quot;Environment Variables\n----------------------\n\n&quot;)
     for item in req.subprocess_env.items():
         req.write(&quot;%s: %s\n&quot; % item)
     req.write(&quot;\n\n&quot;)
     return apache.OK

For an example of using the Vampire loginhandler for implementing a
session based login mechanism see code in:

   <A HREF="http://svn.dscpl.com.au/vampire/trunk/examples/session/">http://svn.dscpl.com.au/vampire/trunk/examples/session/</A>

The &quot;login.py&quot; file contains both the loginhandler and the code which
implements the login form.

To see the actual code in action, go to:

   <A HREF="http://www.dscpl.com.au/projects/vampire/examples/session">http://www.dscpl.com.au/projects/vampire/examples/session</A>

The username and password are in the &quot;login.py&quot; code.

The nice thing about the Vampire loginhandler is that this sort of code
is extracted out into one place and can encompass requests against  
static
pages or mod_python based content handlers for that directory. Each  
actual
content handler doesn't need to worry about dealing with the details of
having to create the session. If a handler needs access to the session
object, it just needs to access &quot;req.session&quot; object put there by the
loginhandler.

Now, whether this would at all be useful would be dependent on what you  
are
using the SSL information for. Even if it isn't strictly part of a login
mechanism, it could still be done in the login handler, you just need  
to call
through to the original default login handler as shown in code above if
not actually wanting to override it.

Hope this is of interest.

BTW, if you don't know what Vampire is, it is some customisations on top
of mod_python which to me make it easier to use. It isn't really a  
framework
in any sense as it doesn't strictly dictate you do things in a certain  
way.
In some ways it gives you more options, although it does tend to promote
a more resource based view of handler selection as opposed to a handler
per directory.

Web site is at:

   <A HREF="http://www.dspcl.com.au/projects/vampire">http://www.dspcl.com.au/projects/vampire</A>

Graham

On 21/05/2005, at 12:04 AM, Bud P. Bruegger wrote:

&gt;<i> Hi Graham,
</I>&gt;<i>
</I>&gt;<i> many thanks for your input!  This got me a round further.  I tried  
</I>&gt;<i> both the access and the fixup handlers (it needs to be before  
</I>&gt;<i> mod-rewrite does its things) and they are invoked (as opposed to the  
</I>&gt;<i> authen and authenz handlers).
</I>&gt;<i>
</I>&gt;<i> My remaining problem is that I don't see SSL_CLIENT_S_DN in the  
</I>&gt;<i> handler (after  req.add_common_vars() and dumping the keys of  
</I>&gt;<i> req.subprocess_env).  (I can see them w/o problems in the standard  
</I>&gt;<i> handler.)  I have tried to play with the order of directives, but it  
</I>&gt;<i> didn't seem to make a difference.  (see the apache conf snipplet below  
</I>&gt;<i> for details)
</I>&gt;<i>
</I>&gt;<i> Any idea how to access SSL_CLIENT_S_DN in the access or fixup handler?
</I>&gt;<i>
</I>&gt;<i> many thanks!
</I>&gt;<i>
</I>&gt;<i> -b
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         &lt;Directory /var/www/sc&gt;
</I>&gt;<i>             SSLRequireSSL
</I>&gt;<i>             #SSLOptions +StdEnvVars +ExportCertData +FakeBasicAuth  
</I>&gt;<i> +StrictRequire
</I>&gt;<i>             SSLOptions +StdEnvVars +ExportCertData +StrictRequire
</I>&gt;<i>             SetHandler mod_python
</I>&gt;<i>             PythonHandler test
</I>&gt;<i>             PythonFixupHandler test
</I>&gt;<i>             PythonDebug On
</I>&gt;<i>         &lt;/Directory&gt;
</I>&gt;<i>
</I>&gt;<i> At 08.52 20/05/2005 +1000, Graham Dumpleton wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 20/05/2005, at 12:27 AM, Bud P. Bruegger wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm a beginner and hope someone can straighten me out.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am trying to write a simple handler that clicks in after mod-ssl  
</I>&gt;&gt;&gt;<i> has requested a certificate from the client.  Depending on the type  
</I>&gt;&gt;&gt;<i> of client token (European eID cards), I'd like the handler to look  
</I>&gt;&gt;&gt;<i> at the client's subject DN derive (by string manipulation or by  
</I>&gt;&gt;&gt;<i> lookup) a nationally unique ID for the card holder.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Sounds simple enough--but I can't get it to work.  I tried both, the  
</I>&gt;&gt;&gt;<i> authen and the authz handlers.  But neither from mod-ssl's  
</I>&gt;&gt;&gt;<i> +fakeBasicAuth nor from the handlers req.user = 'xxx' do I get a  
</I>&gt;&gt;&gt;<i> REMOTE_USER env variable set.  Also the test evironment variable  
</I>&gt;&gt;&gt;<i> that I try to set in the authen/authz handler doesn't have effect.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Normally the authenhandler will only be called if the Apache  
</I>&gt;&gt;<i> configuration has
</I>&gt;&gt;<i> something like:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   AuthType Basic
</I>&gt;&gt;<i>   AuthName &quot;Restricted Files&quot;
</I>&gt;&gt;<i>   AuthUserFile /Users/grahamd/Sites/auth/pwdb
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ie., it is triggered of the presence of these special Auth options.  
</I>&gt;&gt;<i> Similarly,
</I>&gt;&gt;<i> the authzhandler only get called if other appropriate options for it  
</I>&gt;&gt;<i> are
</I>&gt;&gt;<i> defined. Your SSL stuff doesn't seem to fit under that model and so  
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> handlers may simply not be getting called.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Does this possibly mean that the authen/authz handlers are not  
</I>&gt;&gt;&gt;<i> called at all in my configuration?  Should I use a different handler  
</I>&gt;&gt;&gt;<i> and which?  Or did I simply mess up something else?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Try adding a req.log_error() call in the handlers to see if they get  
</I>&gt;&gt;<i> called or not.
</I>&gt;&gt;<i> Message will be in the Apache error log file.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does your code work if you move what you have in the authenhandler  
</I>&gt;&gt;<i> into the start
</I>&gt;&gt;<i> of your actual handler function? Ie., does the concept at least work?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As a fudge, you could always stick it in the accesshandler, which  
</I>&gt;&gt;<i> from memory is
</I>&gt;&gt;<i> always called if defined.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------------------------------------------------------------------- 
</I>&gt;<i> --------------------------
</I>&gt;<i> Ing. Bud P. Bruegger, Ph.D.                 +39-0564-488577 (voice),   
</I>&gt;<i> -21139 (fax)
</I>&gt;<i> Servizio Elaborazione Dati                    e-mail:   
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">bud at comune.grosseto.it</A>
</I>&gt;<i> Comune di Grosseto                             
</I>&gt;<i> <A HREF="http://www.comune.grosseto.it/cie/">http://www.comune.grosseto.it/cie/</A>
</I>&gt;<i> Via Ginori, 43                                       
</I>&gt;<i> <A HREF="http://OpenPortalGuard.sf.net">http://OpenPortalGuard.sf.net</A>
</I>&gt;<i> 58100 Grosseto (Tuscany, Italy)           jabber:  <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">bud at amessage.info</A>
</I>&gt;<i>
</I>&gt;<i> Free Software in Public Administration:  not just a good idea, but a  
</I>&gt;<i> necessity
</I>&gt;<i>
</I>&gt;<i> Perfection is attained, not when there is nothing more to be added,  
</I>&gt;<i> but when there is nothing more to be taken away -- Antoine de  
</I>&gt;<i> Saint-Exupery
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018154.html">[mod_python] problem w/ authen handler
</A></li>
	<LI>Next message: <A HREF="018141.html">[mod_python] Installig mod_python on Win XP.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18148">[ date ]</a>
              <a href="thread.html#18148">[ thread ]</a>
              <a href="subject.html#18148">[ subject ]</a>
              <a href="author.html#18148">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
