<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Capturing PSP output
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Capturing%20PSP%20output&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018229.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Capturing PSP output</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Capturing%20PSP%20output&In-Reply-To="
       TITLE="[mod_python] Capturing PSP output">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue May 31 21:19:49 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="018229.html">[mod_python] How to call a webpage on the same server?
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18230">[ date ]</a>
              <a href="thread.html#18230">[ thread ]</a>
              <a href="subject.html#18230">[ subject ]</a>
              <a href="author.html#18230">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Only just got the chance to revisit this. Here is an alternate bit of
code which avoids having to munge PSP code. This only works for
where PSP code is stored in a file. It bypasses any caching mechanism
present in the PSP class, but you could add your own if need be. It
also replaces the request object entirely with a dummy object purely
for the purposes of collecting output.

from mod_python import apache
from mod_python import _psp
  
import os
import StringIO

def _psp_to_str(filename,vars={}):
  directory,file = os.path.split(filename)

  code = _psp.parse(file,directory+'/')

  class _MPStringIO(StringIO.StringIO):
    def write(self,string,flush=1):
      StringIO.StringIO.write(self,string)

  vars[&quot;req&quot;] = _MPStringIO()

  exec code in vars

  return vars[&quot;req&quot;].getvalue()

def handler(req):
  directory = os.path.dirname(__file__)
  filename = os.path.join(directory,&quot;_sample.psp&quot;)
  content = _psp_to_str(filename)

  req.content_type = &quot;text/html&quot;
  req.send_http_header()
  req.write(content)

  return apache.OK



Graham Dumpleton wrote ..
&gt;<i> 
</I>&gt;<i> On 31/05/2005, at 2:19 AM, Joshua Ginsberg wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Hello --
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm trying to do something a little unorthodox... I didn't know if 
</I>&gt;<i> &gt; anybody had tried it before... Within a PSP page, I want to run 
</I>&gt;<i> &gt; another PSP page and capture the output to a string.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; To do a little testing, I wrote the following PSP page:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt;%
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; def sAppend(self, thestring):
</I>&gt;<i> &gt;     if '__s__' not in dir(self):
</I>&gt;<i> &gt;         self.__s__ = ''
</I>&gt;<i> &gt;     self.__s__ += str(thestring)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; oldReqWrite = req.write
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; req.write = sAppend
</I>&gt;<i> 
</I>&gt;<i> This is a bit confusing. Your method accepts a &quot;self&quot; parameter as if 
</I>&gt;<i> it is a
</I>&gt;<i> method of a class when it isn't. Just because you replace an existing 
</I>&gt;<i> instance
</I>&gt;<i> method will not turn your one into one.
</I>&gt;<i> 
</I>&gt;<i> The result is that the string to be output is being passed as self and
</I>&gt;<i> string
</I>&gt;<i> doesn't have a &quot;__s__&quot; member.
</I>&gt;<i> 
</I>&gt;<i> There are other problems with using &quot;__s__&quot; as well but rather than go
</I>&gt;<i> into it,
</I>&gt;<i> you should just look at:
</I>&gt;<i> 
</I>&gt;<i>    <A HREF="http://www.modpython.org/pipermail/mod_python/2005-May/018134.html">http://www.modpython.org/pipermail/mod_python/2005-May/018134.html</A>
</I>&gt;<i> 
</I>&gt;<i> That code could probably still be cleaned up a bit perhaps as certain 
</I>&gt;<i> things
</I>&gt;<i> don't need to be done, also not sure why other things are being done 
</I>&gt;<i> either.
</I>&gt;<i> If I get a chance later I'll see if I can come up with a more 
</I>&gt;<i> streamlined
</I>&gt;<i> version.
</I>&gt;<i> 
</I>&gt;<i> BTW, did you want to actually reference the original &quot;req&quot; object for 
</I>&gt;<i> any
</I>&gt;<i> data. The example referenced obviously doesn't allow this as it 
</I>&gt;<i> completely
</I>&gt;<i> replaces the &quot;req&quot; object with a StringIO object.
</I>&gt;<i> 
</I>&gt;<i> Graham
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018229.html">[mod_python] How to call a webpage on the same server?
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18230">[ date ]</a>
              <a href="thread.html#18230">[ thread ]</a>
              <a href="subject.html#18230">[ subject ]</a>
              <a href="author.html#18230">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
