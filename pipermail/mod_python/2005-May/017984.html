<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] bug in apache.import_module
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20bug%20in%20apache.import_module&In-Reply-To=c298f2d7050429220333ec2b6b%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017983.html">
   <LINK REL="Next"  HREF="017985.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] bug in apache.import_module</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Huzaifa Tapal</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20bug%20in%20apache.import_module&In-Reply-To=c298f2d7050429220333ec2b6b%40mail.gmail.com"
       TITLE="[mod_python] bug in apache.import_module">huzaifa at hostway.com
       </A><BR>
    <I>Mon May  2 22:19:54 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017983.html">[mod_python] How to initialize a variable using PythonImport and
	access it from a Handler?
</A></li>
        <LI>Next message: <A HREF="017985.html">[mod_python] bug in apache.import_module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17984">[ date ]</a>
              <a href="thread.html#17984">[ thread ]</a>
              <a href="subject.html#17984">[ subject ]</a>
              <a href="author.html#17984">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Nicolas,

What I am really worried about is that in a multi-threaded environment, 
accessing a modular level method, multiple threads might be accessing 
the same method at the same time and overwriting the other threads path 
list as a result. 

As per your question, I create a _lock object on top of the module.  
Pretty much this method was created in a &quot;SharedResources&quot; module as a 
modular level method.  My framework then imports the method and uses it 
within to fix the paths.

What do you think?

Hozi

Nicolas Lehuen wrote:

&gt;<i>Hi Huzaifa,
</I>&gt;<i>
</I>&gt;<i>Well, that's really up to you, especially since I don't understand
</I>&gt;<i>where the _lock variable comes from.
</I>&gt;<i>
</I>&gt;<i>If it's not possible to change the path list which is passed as a
</I>&gt;<i>parameter without acquiring the lock, then why not, but I'd put the
</I>&gt;<i>locking mechanism in the calling code rather than in this function.
</I>&gt;<i>Note that you are not modifying the path list in-place : you just
</I>&gt;<i>return a copy of the path list with some fixes in it. So there is no
</I>&gt;<i>need to lock anything here, except if you fear that the path list will
</I>&gt;<i>be changed during the iteration, but for that, you have to put a
</I>&gt;<i>locking mechanism somewhere else for any modification of the path
</I>&gt;<i>list. So my first advice is : keep all locking code in the same place
</I>&gt;<i>and you'll save time and mental health :).
</I>&gt;<i>
</I>&gt;<i>My second advice is : don't be over-protective at the cost of
</I>&gt;<i>performance. Trust the users of your code. Provided that they have a
</I>&gt;<i>proper documentation, it's not necessary to lock anything, because
</I>&gt;<i>your users will know that bad things will happen if they change the
</I>&gt;<i>path list during iteration, so they'll do the right stuff accordingly.
</I>&gt;<i>Likewise, it's not necessary to check whether path is a list, or
</I>&gt;<i>whether some path entries are None or &quot;&quot;. If your users want to give
</I>&gt;<i>silly data to your function, let them do it, and let Python throw
</I>&gt;<i>exceptions at them.
</I>&gt;<i>
</I>&gt;<i>Regards,
</I>&gt;<i>
</I>&gt;<i>Nicolas
</I>&gt;<i>
</I>&gt;<i>On 4/29/05, Huzaifa Tapal &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">huzaifa at hostway.com</A>&gt; wrote:
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i> I wanted to ask for a piece of advise.  So the fix that I have mentioned, I
</I>&gt;&gt;<i>moved that fix (the method I replaced with the map(lambda) solution you had
</I>&gt;&gt;<i>with a minor fix) to another &quot;SharedResources&quot; module that I import in my
</I>&gt;&gt;<i>framework's handler.  From within the handler and my app, I am call that
</I>&gt;&gt;<i>method passing in a path argument that it *fixes* and returns back the
</I>&gt;&gt;<i>results.  Here is what the new method looks like:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> def fix_paths( path ):
</I>&gt;&gt;<i>     &quot;&quot;&quot; Convenience method for checking and 
</I>&gt;&gt;<i>     adding '/' to the end of paths for compatibility
</I>&gt;&gt;<i>     with mod_python's import_module. &quot;&quot;&quot;
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>     _lock.acquire()
</I>&gt;&gt;<i>     try:
</I>&gt;&gt;<i>         if path and type(path) == type([]):
</I>&gt;&gt;<i>             path = map(lambda entry : (entry!='' and entry[-1]!='/' and
</I>&gt;&gt;<i>entry+'/') or entry,path)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>         return path
</I>&gt;&gt;<i>     finally:
</I>&gt;&gt;<i>         _lock.release()
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Should I have the thread-locking in place or can I get by without having it
</I>&gt;&gt;<i>in place?  The reason I did add that was because the path value may get
</I>&gt;&gt;<i>changed, in the process, I thought of making this method thread-safe.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Also Nicolas, if you notice I added another check in your lambda function
</I>&gt;&gt;<i>to check if the entry is an empty string.  If that wasn't there then if an
</I>&gt;&gt;<i>empty string path was passed in the list paths, the function would break. 
</I>&gt;&gt;<i>Thought, i'd let you know if you were gonna add this functionality into the
</I>&gt;&gt;<i>import_module method for apache.py
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Hozi
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Nicolas Lehuen wrote: 
</I>&gt;&gt;<i> Sorry, reposting to the whole list :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>The change I've made for MODPYTHON-9 affects only the publisher
</I>&gt;&gt;<i>module. It solves the problem encountered when you had two pages, one
</I>&gt;&gt;<i>at /index.py, and the other at /foobar/index.py.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Huzaifa, what I don't understand here is whether moduleA has the same
</I>&gt;&gt;<i>name as moduleB, and whether you are using mod_python.publisher or
</I>&gt;&gt;<i>not.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>If you use the publisher, your problem has been solved in the latest
</I>&gt;&gt;<i>development version, and the fix will be in the next release.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Anyway, if we put aside the fix specific to the publisher, the problem
</I>&gt;&gt;<i>you describe is real, and the workaround you provide is correct.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>It is so correct that the only way I see of fixing that is to
</I>&gt;&gt;<i>integrate the workaround in the import_module function, that is to say
</I>&gt;&gt;<i>to check whether each path component passed in the path list argument
</I>&gt;&gt;<i>ends with a '/' (or '\'), and if not, add a '/' (or '\\'). This is
</I>&gt;&gt;<i>done easily in the first line of the function :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>if path:
</I>&gt;&gt;<i> path = map(lambda entry : (entry[-1]!='/' and entry+'/') or entry,path)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>However, there is no easy way of telling what directory separator
</I>&gt;&gt;<i>should be used ; theoretically, os.sep gives us the correct directory
</I>&gt;&gt;<i>separator, but even under Win32 Apache admins are advised to use &quot;/&quot;
</I>&gt;&gt;<i>which is compatible (at the OS level). So, we might as well always use
</I>&gt;&gt;<i>&quot;/&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>What I fear is that adding all these checks to import_module will make
</I>&gt;&gt;<i>it a little bit too slow, so what about adding a line or two in the
</I>&gt;&gt;<i>documentation about the fact that all directories mentioned in the
</I>&gt;&gt;<i>path argument should end with a '/' ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Regards,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Nicolas
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>On 4/29/05, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Nicolas, does the change you have already made for MODPYTHON-9
</I>&gt;&gt;<i>also address this slightly different variation on the problem?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Original report was based on same name module in parent and child
</I>&gt;&gt;<i>subdirectories, not sibling directories which share a common prefix
</I>&gt;&gt;<i>to the subdirectory name.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Graham
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Huzaifa Tapal wrote ..
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> For my fix, I patched this issue by passing the import_module function
</I>&gt;&gt;<i>the path with &quot;/&quot; in the end. That way it distinguishes from
</I>&gt;&gt;<i>/home/user/dir1 and /home/user/dir123
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>hozi
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Graham Dumpleton wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> See:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-9">http://issues.apache.org/jira/browse/MODPYTHON-9</A>
</I>&gt;&gt;<i> <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-10">http://issues.apache.org/jira/browse/MODPYTHON-10</A>
</I>&gt;&gt;<i> <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-11">http://issues.apache.org/jira/browse/MODPYTHON-11</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>There are various known issues with using same name module in different
</I>&gt;&gt;<i>directories.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>The first one has been addressed for next version of mod_python.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Graham
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>On 29/04/2005, at 8:22 AM, Huzaifa Tapal wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I think there is a bug in apache.import_module. I am using
</I>&gt;&gt;<i>apache.import_module passing in the path where I want the module
</I>&gt;&gt;<i>imported from. I am seeing a very odd result as to sometimes, the
</I>&gt;&gt;<i>module that is loaded is not the right one. Instead it loads a
</I>&gt;&gt;<i>module that is of the same name but in a different directory. Here
</I>&gt;&gt;<i>is what is happening:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I have two modules of same name in 2 different directories as follows;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>/home/user/dir1/moduleA
</I>&gt;&gt;<i>/home/user/dir123/moduleB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Lets say I restart apache and load up moduleA. At that point there
</I>&gt;&gt;<i>is an entry in sys.modules for moduleA. Lets say then, I load up
</I>&gt;&gt;<i>moduleB, now the original entry for moduleA is overwritten by this
</I>&gt;&gt;<i>new entry. Now when I go back to load moduleA, I get back moduleB
</I>&gt;&gt;<i>results. Here is why:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>In apache.import_module if I pass in the path to load moduleA from
</I>&gt;&gt;<i>'/home/user/dir1' and the last module was in '/home/user/dir123' then
</I>&gt;&gt;<i>the check in import_module to make sure both modules aren't the same
</I>&gt;&gt;<i>fails since it does a &quot;file.startswith()&quot; check on the path. Since
</I>&gt;&gt;<i>the path moduleA is in the path to moduleB, it loads the wrong module.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I see that somebody else had complained about this problem in
</I>&gt;&gt;<i>mod_python 1.3.1 but it still has not been patched.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Any ideas?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Hozi
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>_______________________________________________
</I>&gt;&gt;<i>Mod_python mailing list
</I>&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i>Mod_python mailing list
</I>&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i>Mod_python mailing list
</I>&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050502/0485cc08/attachment-0001.html">http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050502/0485cc08/attachment-0001.html</A>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017983.html">[mod_python] How to initialize a variable using PythonImport and
	access it from a Handler?
</A></li>
	<LI>Next message: <A HREF="017985.html">[mod_python] bug in apache.import_module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17984">[ date ]</a>
              <a href="thread.html#17984">[ thread ]</a>
              <a href="subject.html#17984">[ subject ]</a>
              <a href="author.html#17984">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
