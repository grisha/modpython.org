<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] cgi handler bug? 
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20cgi%20handler%20bug%3F%20&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009607.html">
   <LINK REL="Next"  HREF="009614.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
<table border=0 width="100%"><tr><td valign="top">
   <H1>[mod_python] cgi handler bug? </H1>
    <B>Gregory Bond</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20cgi%20handler%20bug%3F%20&In-Reply-To="
       TITLE="[mod_python] cgi handler bug? ">gnb at itga.com.au
       </A><BR>
    <I>Mon Dec 23 11:24:46 EST 2002</I>
    <P><UL>
        <LI>Previous message: <A HREF="009607.html">[mod_python] mod_python cgihandler bug? 
</A></li>
        <LI>Next message: <A HREF="009614.html">[mod_python] http 1.1 persistent connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9610">[ date ]</a>
              <a href="thread.html#9610">[ thread ]</a>
              <a href="subject.html#9610">[ subject ]</a>
              <a href="author.html#9610">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I wrote: 

&gt;<i> But the HTML
</I>&gt;<i> generated by the CGI is sent twice, so my page displays double. 
</I>
Found it.

In mod_python.apache.py, in the CGIStdout::write() routine, the
self.headers_sent variable is never being set, so the first chunk of stuff from
the CGI program (in my case, all but the last newline) is being handled and
sent twice.

The following patch fixes both CGIhandler problems, and my CGIs now happily 
operate under mod_python:

diff -u ~gnb/mod_python-3.0.1/lib/python/mod_python/apache.py /usr/local/lib/python2.2/site-packages/mod_python/apache.py
--- /home/users/gnb/mod_python-3.0.1/lib/python/mod_python/apache.py    Fri Nov  8 11:15:11 2002
+++ /usr/local/lib/python2.2/site-packages/mod_python/apache.py Mon Dec 23 11:18:56 2002
@@ -723,6 +723,7 @@
                     else:
                         self.req.headers_out.add(h, v)
 
+               self.headers_sent = 1
                 # write the body if any at this point
                 self.req.write(ss[1])
         else:
@@ -761,7 +762,7 @@
     osenv = os.environ
 
     # restore env
-    for k in osenv:
+    for k in osenv.keys():
         del osenv[k]
     for k in sav_env:
         osenv[k] = env[k]




</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009607.html">[mod_python] mod_python cgihandler bug? 
</A></li>
	<LI>Next message: <A HREF="009614.html">[mod_python] http 1.1 persistent connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9610">[ date ]</a>
              <a href="thread.html#9610">[ thread ]</a>
              <a href="subject.html#9610">[ subject ]</a>
              <a href="author.html#9610">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
