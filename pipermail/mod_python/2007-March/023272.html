<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] When using PSP is request object persistent?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20When%20using%20PSP%20is%20request%20object%20persistent%3F&In-Reply-To=20070311110534.23375.qmail%40web86015.mail.ird.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023271.html">
   <LINK REL="Next"  HREF="023275.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] When using PSP is request object persistent?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20When%20using%20PSP%20is%20request%20object%20persistent%3F&In-Reply-To=20070311110534.23375.qmail%40web86015.mail.ird.yahoo.com"
       TITLE="[mod_python] When using PSP is request object persistent?">graham.dumpleton at gmail.com
       </A><BR>
    <I>Sun Mar 11 06:10:13 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023271.html">[mod_python] When using PSP is request object persistent?
</A></li>
        <LI>Next message: <A HREF="023275.html">[mod_python] Install Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23272">[ date ]</a>
              <a href="thread.html#23272">[ thread ]</a>
              <a href="subject.html#23272">[ subject ]</a>
              <a href="author.html#23272">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In your case, if you don't want PSP code messing with your session
object, simply don't save it as req.session. Instead call it
req.mysession. This will work as long as there is no attempt to access
'session' variable in a PSP page. If there is then PSP will attempt to
create its own session object and you will get a deadlock as your code
has already created one and has a lock on it.

Graham

On 11/03/07, PETER BARKER &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">newbarker at btinternet.com</A>&gt; wrote:
&gt;<i> Graham,
</I>&gt;<i>
</I>&gt;<i> I appreciate the reply. My method fits in the corner case you mention. The
</I>&gt;<i> stripped down example is from a project where a protected area of the
</I>&gt;<i> website is entered. The previous presence of the session means they're
</I>&gt;<i> already logged in, and the absence means they are required to login. This
</I>&gt;<i> logic is based upon the description of the is_new() method at
</I>&gt;<i> <A HREF="http://www.modpython.org/live/current/doc-html/pyapi-sess-classes.html">http://www.modpython.org/live/current/doc-html/pyapi-sess-classes.html</A>
</I>&gt;<i> where it suggests you could use:
</I>&gt;<i>
</I>&gt;<i> sess = Session(req)
</I>&gt;<i> if sess.is_new():
</I>&gt;<i>     # redirect to login
</I>&gt;<i>     util.redirect(req, '<A HREF="http://www.mysite.com/login'">http://www.mysite.com/login'</A>)
</I>&gt;<i>
</I>&gt;<i> Of course, I'm doing something slightly different and composing a page from
</I>&gt;<i> PSP templates. It's a shame this templating method which doesn't logically
</I>&gt;<i> have anything to do with sessions (when viewed purely from a templating
</I>&gt;<i> perspective) disables the ability to use is_new() in this way.
</I>&gt;<i>
</I>&gt;<i> I was going to store additional session information in a relational database
</I>&gt;<i> anyway, so for me I guess the fix is to check for existence of corresponding
</I>&gt;<i> record in the database as I'm definitely in control of that persistence! I'm
</I>&gt;<i> going to have to store the last access time in the database too so I can
</I>&gt;<i> implement the timing out of a session.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Pete
</I>&gt;<i>
</I>&gt;<i> Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>&gt; wrote:
</I>&gt;<i> On 11/03/07, PETER BARKER wrote:
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; See below for the stripped-down code to my problem/query. Note that I do
</I>&gt;<i> not
</I>&gt;<i> &gt; save the session anywhere.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; With the two PSP template lines commented, the session is always new
</I>&gt;<i> &gt; (because I'm not saving it). When the templating code is uncommented, the
</I>&gt;<i> &gt; session is remembered across requests. Why is this?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; APACHE CONFIG:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; SetHandler mod_python
</I>&gt;<i> &gt; PythonDebug On
</I>&gt;<i> &gt; PythonHandler mod_python.publisher
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; INDEX.HTML:
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; THETEST.PY:
</I>&gt;<i> &gt; from mod_python import Session, psp
</I>&gt;<i> &gt; import os
</I>&gt;<i> &gt; def entry(req):
</I>&gt;<i> &gt; req.session = Session.Session(req)
</I>&gt;<i> &gt; if req.session.is_new():
</I>&gt;<i> &gt; returnedDoc = &quot;Newly created session: &quot; + req.session.id()
</I>&gt;<i> &gt; else:
</I>&gt;<i> &gt; returnedDoc = 'Existing session:' + req.session.id()
</I>&gt;<i> &gt; #pathname = os.path.join(os.path.dirname(req.filename),'index.html')
</I>&gt;<i> &gt; #psp.PSP(req,filename=pathname).run()
</I>&gt;<i> &gt; req.content_type = 'text/html'
</I>&gt;<i> &gt; return returnedDoc
</I>&gt;<i>
</I>&gt;<i> Do you use the session object in the PSP page? If you do, then what
</I>&gt;<i> you are seeing is consistent with how PSP has perhaps always worked.
</I>&gt;<i>
</I>&gt;<i> As the code stands, if a session object is created, whether it be
</I>&gt;<i> prior to PSP being invoked or as a result of a reference to the
</I>&gt;<i> session object in a PSP page, the PSP code is always saving the
</I>&gt;<i> session object to ensure that the last accessed time is updated.
</I>&gt;<i>
</I>&gt;<i> If the session object wasn't actually referenced from within the PSP
</I>&gt;<i> page this raises an interesting corner case which wasn't perhaps
</I>&gt;<i> thought of when PSP was changed to use a session object present as
</I>&gt;<i> req.session. The issue is if req.session exists but the session object
</I>&gt;<i> is not used in the PSP page, should the PSP code be saving the session
</I>&gt;<i> to have the last accessed time updated.
</I>&gt;<i>
</I>&gt;<i> Thus, the code in PSP code should perhaps instead of saying:
</I>&gt;<i>
</I>&gt;<i> # the mere instantiation of a session changes it
</I>&gt;<i> # (access time), so it *always* has to be saved
</I>&gt;<i> if hasattr(req, 'session'):
</I>&gt;<i> req.session.save()
</I>&gt;<i>
</I>&gt;<i> perhaps say:
</I>&gt;<i>
</I>&gt;<i> # the mere instantiation of a session changes it
</I>&gt;<i> # (access time), so it *always* has to be saved
</I>&gt;<i> if &quot;session&quot; in code.co_names and hasattr(req, 'session'):
</I>&gt;<i> req.session.save()
</I>&gt;<i>
</I>&gt;<i> In summary, it is a feature of PSP that if a session object is used in
</I>&gt;<i> a PSP page that the session is always saved automatically. The
</I>&gt;<i> question is whether it should be saving it when the session was
</I>&gt;<i> created before PSP was invoked and the session isn't used in the PSP
</I>&gt;<i> page. Problem is that changing the behaviour may be too late now that
</I>&gt;<i> it is working this way.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023271.html">[mod_python] When using PSP is request object persistent?
</A></li>
	<LI>Next message: <A HREF="023275.html">[mod_python] Install Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23272">[ date ]</a>
              <a href="thread.html#23272">[ thread ]</a>
              <a href="subject.html#23272">[ subject ]</a>
              <a href="author.html#23272">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
