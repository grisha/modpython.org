<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Apache/mod_python process sizes. Help wanted.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Apache/mod_python%20process%20sizes.%20Help%20wanted.&In-Reply-To=99C69BF9-B599-4BBD-9018-174FC9884492%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023228.html">
   <LINK REL="Next"  HREF="023231.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Apache/mod_python process sizes. Help wanted.</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Greg Fawcett</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Apache/mod_python%20process%20sizes.%20Help%20wanted.&In-Reply-To=99C69BF9-B599-4BBD-9018-174FC9884492%40dscpl.com.au"
       TITLE="[mod_python] Apache/mod_python process sizes. Help wanted.">greg at vig.co.nz
       </A><BR>
    <I>Fri Mar  2 23:31:58 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023228.html">[mod_python] Apache/mod_python process sizes. Help wanted.
</A></li>
        <LI>Next message: <A HREF="023231.html">[mod_python] Apache/mod_python process sizes. Help wanted.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23229">[ date ]</a>
              <a href="thread.html#23229">[ thread ]</a>
              <a href="subject.html#23229">[ subject ]</a>
              <a href="author.html#23229">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Graham -

First, thanks for your frequent and insightful contributions to this list.

1. Ubuntu Linux 6.06 LTS

2. ls -las /usr/lib/apache2/modules/mod_python.so
        84 -rw-r--r-- 1 root root 80072 2006-03-20 21:29
/usr/lib/apache2/modules/mod_python.so

3. ls -las /usr/lib/libpython2.4.so.1.0
        1052 -rw-r--r-- 1 root root 1070260 2006-10-06 21:35
/usr/lib/libpython2.4.so.1.0

4. ldd /usr/lib/apache2/modules/mod_python.so
        linux-gate.so.1 =&gt;  (0xffffe000)
        libpython2.4.so.1.0 =&gt; /usr/lib/libpython2.4.so.1.0 (0xb7e1b000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb7e08000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb7e05000)
        libutil.so.1 =&gt; /lib/tls/i686/cmov/libutil.so.1 (0xb7e02000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb7de0000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb7cb1000)
        /lib/ld-linux.so.2 (0x80000000)

5. Remove all references to mod_python in sites-available/*
        sudo a2dismod mod_python
        sudo /etc/init.d/apache2 force-reload
        top -U www-data

                top - 17:25:30 up 100 days,  3:01,  1 user,  load average:
0.00, 0.00, 0.00
                Tasks:  76 total,   2 running,  74 sleeping,   0 stopped,
0 zombie
                Cpu(s):  0.0% us,  0.3% sy,  0.0% ni, 99.7% id,  0.0% wa,
0.0% hi,  0.0% si
                Mem:    255824k total,   222824k used,    33000k free,
84288k buffers
                Swap:  1951800k total,     4320k used,  1947480k free,
52072k cached

                  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+
COMMAND
                 8138 www-data  18   0 19628 3236  868 S  0.0  1.3
0:00.00apache2
                 8139 www-data  19   0 19628 3236  868 S  0.0  1.3
0:00.00apache2
                 8140 www-data  19   0 19628 3236  868 S  0.0  1.3
0:00.00apache2
                 8141 www-data  19   0 19628 3236  868 S  0.0  1.3
0:00.00apache2
                 8142 www-data  19   0 19628 3236  868 S  0.0  1.3
0:00.00apache2

6. Add mod_python references again...
        sudo a2enmod mod_python
        sudo /etc/init.d/apache2 force-reload
        top -U www-data

                top - 17:29:05 up 100 days,  3:04,  1 user,  load average:
0.00, 0.00, 0.00
                Tasks:  76 total,   2 running,  74 sleeping,   0 stopped,
0 zombie
                Cpu(s):  0.0% us,  0.0% sy,  0.0% ni, 100.0% id,  0.0% wa,
0.0% hi,  0.0% si
                Mem:    255824k total,   224292k used,    31532k free,
84408k buffers
                Swap:  1951800k total,     4320k used,  1947480k free,
52224k cached

                  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+
COMMAND
                 8223 www-data  20   0 21580 4136  980 S  0.0  1.6
0:00.00apache2
                 8224 www-data  20   0 21580 4136  980 S  0.0  1.6
0:00.00apache2
                 8225 www-data  22   0 21580 4136  980 S  0.0  1.6
0:00.01apache2
                 8226 www-data  21   0 21580 4136  980 S  0.0  1.6
0:00.00apache2
                 8227 www-data  21   0 21580 4136  980 S  0.0  1.6
0:00.00apache2

Hope that makes more sense to you than it does to me. Let me know if there
is anything else I should have done.

Cheers!
Greg Fawcett.

On 03/03/07, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> This email is to enlist the help of mod_python users out there to
</I>&gt;<i> hopefully
</I>&gt;<i> disprove a possible misconception that exists and which is often used
</I>&gt;<i> to malign mod_python and label it a bad solution to the problem of
</I>&gt;<i> hosting
</I>&gt;<i> web applications. If intrigued, keep reading, especially as the
</I>&gt;<i> results may
</I>&gt;<i> end up showing that you might be able to improve the memory use profile
</I>&gt;<i> of your own Apache installation.
</I>&gt;<i>
</I>&gt;<i> The actual claim which would be nice to disprove is that mod_python
</I>&gt;<i> consumes huge amounts of memory.
</I>&gt;<i>
</I>&gt;<i> The first part of this issue I want to look at and get data on is how
</I>&gt;<i> much
</I>&gt;<i> memory is used by an Apache child process immediately after Apache is
</I>&gt;<i> started and before any actual request or additional Python modules are
</I>&gt;<i> imported.
</I>&gt;<i>
</I>&gt;<i> What I am trying to determine is by how much is the process size caused
</I>&gt;<i> not by mod_python, but by the fact that standard Python installations
</I>&gt;<i> tend
</I>&gt;<i> not to be built with the '-enable-shared' option. To be more
</I>&gt;<i> specific, that the
</I>&gt;<i> Python library is static rather than being a shared library.
</I>&gt;<i>
</I>&gt;<i> The reason this can be an issue is that when creating the mod_python.so
</I>&gt;<i> module which is loaded into Apache, if the Python library is static
</I>&gt;<i> rather
</I>&gt;<i> than shared, then libtool will actually incorporate the contents of
</I>&gt;<i> the Python
</I>&gt;<i> static library into mod_python.so itself. This alone will cause the
</I>&gt;<i> size of the
</I>&gt;<i> mod_python.so file to be much larger.
</I>&gt;<i>
</I>&gt;<i> The next factor is in what way particular operating systems will
</I>&gt;<i> treat the
</I>&gt;<i> memory consumed by the mod_python.so file when loaded into memory
</I>&gt;<i> as shared data
</I>&gt;<i>
</I>&gt;<i> The best scenario would be that the memory would be shared between all
</I>&gt;<i> Apache child processes. Thus, even if mod_python.so is bigger than it
</I>&gt;<i> needs to be due to there only being a static Python library, at least
</I>&gt;<i> there is
</I>&gt;<i> only one copy in memory.
</I>&gt;<i>
</I>&gt;<i> The worst case and one which apparently can happen on some platforms,
</I>&gt;<i> is that because the objects in the Python static library are not
</I>&gt;<i> relocatable
</I>&gt;<i> objects, when mapped into memory, the required address translations
</I>&gt;<i> will result in a copy on write of the memory used by the Python library
</I>&gt;<i> object files in memory. This will result in the Python library parts
</I>&gt;<i> of the
</I>&gt;<i> mod_python.so file not being able to be shared across all Apache child
</I>&gt;<i> processes and thus Apache as a whole could consume huge amounts as
</I>&gt;<i> each Apache child process would effectively have its own copy in memory
</I>&gt;<i> of the Python library.
</I>&gt;<i>
</I>&gt;<i> What I am therefore after is a selection of data for various
</I>&gt;<i> platforms and
</I>&gt;<i> the different ways that Python can be built, showing size of
</I>&gt;<i> mod_python.so,
</I>&gt;<i> whether Python library is static or shared, how much memory Apache child
</I>&gt;<i> processes take when mod_python not loaded and then how much when
</I>&gt;<i> it is loaded.
</I>&gt;<i>
</I>&gt;<i> Note that I am not interested in this for Win32 or MacOS systems, but
</I>&gt;<i> the
</I>&gt;<i> Linux/BSD/Solaris/HPUX platforms.
</I>&gt;<i>
</I>&gt;<i> Thus:
</I>&gt;<i>
</I>&gt;<i> 1. Operating System
</I>&gt;<i>
</I>&gt;<i> For example:
</I>&gt;<i>
</I>&gt;<i>    Mac OS X 10.4 (PowerPC)
</I>&gt;<i>
</I>&gt;<i> 2. Size of mod_python.so.
</I>&gt;<i>
</I>&gt;<i> For example:
</I>&gt;<i>
</I>&gt;<i> $ ls -las mod_python.so
</I>&gt;<i> 744 -rwxr-xr-x   1 grahamd  admin  378280 Dec 10 17:24 mod_python.so
</I>&gt;<i>
</I>&gt;<i> 3. Size of Python library. This should exist in the 'lib/pythonX.Y/
</I>&gt;<i> config'
</I>&gt;<i> directory of your Python installation. Ie., at same directory level
</I>&gt;<i> as your
</I>&gt;<i> 'site-packages' directory. It would be called 'libpythonX.Y.a',
</I>&gt;<i> 'libpythonX.Y.so'
</I>&gt;<i> or 'libpythonX.Y.sl'.
</I>&gt;<i>
</I>&gt;<i> MacOS is a bit different as it uses what it calls frameworks, ie., a
</I>&gt;<i> fancy shared
</I>&gt;<i> library, and they are named differently, but as an example:
</I>&gt;<i>
</I>&gt;<i> $ ls -las Python
</I>&gt;<i> 2144 -rwxr-xr-x   1 root  wheel  1097268 Sep 13 12:12 Python
</I>&gt;<i>
</I>&gt;<i> On UNIX platforms, use 'ls -las libpython*'.
</I>&gt;<i>
</I>&gt;<i> 4. Confirm whether mod_python.so uses Python library as static
</I>&gt;<i> library or
</I>&gt;<i> shared library. On UNIX systems you can use the 'ldd' command on
</I>&gt;<i> mod_python.so to determine this.
</I>&gt;<i>
</I>&gt;<i> MacOS is a bit different again here and uses 'otool' command instead and
</I>&gt;<i> output looks a fair bit different, but as example:
</I>&gt;<i>
</I>&gt;<i>         $ otool -L mod_python.so mod_python.so:
</I>&gt;<i>          /usr/lib/libSystem.B.dylib (compatibility version 1.0.0,
</I>&gt;<i> current version 88.1.6)
</I>&gt;<i>          /System/Library/Frameworks/Python.framework/Versions/2.3/
</I>&gt;<i> Python (compatibility version 2.3.0, current version 2.3.5)
</I>&gt;<i>          /System/Library/Frameworks/CoreServices.framework/Versions/A/
</I>&gt;<i> CoreServices (compatibility version 1.0.0, current version 18.0.0)
</I>&gt;<i>          /System/Library/Frameworks/Foundation.framework/Versions/C/
</I>&gt;<i> Foundation (compatibility version 300.0.0, current version 567.27.0)
</I>&gt;<i>          /usr/lib/libmx.A.dylib (compatibility version 1.0.0, current
</I>&gt;<i> version 92.0.0)
</I>&gt;<i>
</I>&gt;<i> 5. Work out how much memory Apache uses when mod_python is not being
</I>&gt;<i> loaded. One can use 'top' for this. Hopefully others may suggest
</I>&gt;<i> better ways.
</I>&gt;<i>
</I>&gt;<i> For example:
</I>&gt;<i>
</I>&gt;<i>    PID COMMAND      %CPU   TIME   #TH #PRTS #MREGS RPRVT  RSHRD
</I>&gt;<i> RSIZE  VSIZE
</I>&gt;<i>    277 httpd        0.0%  0:00.00   1     8    26    72K  1.88M
</I>&gt;<i> 496K  29.3M
</I>&gt;<i>    276 httpd        0.0%  0:00.00   1     8    26    76K  1.88M
</I>&gt;<i> 500K  29.3M
</I>&gt;<i>    275 httpd        0.0%  0:00.00   1     8    26    76K  1.88M
</I>&gt;<i> 500K  29.3M
</I>&gt;<i>    274 httpd        0.0%  0:00.00   1     8    26    76K  1.88M
</I>&gt;<i> 500K  29.3M
</I>&gt;<i>    273 httpd        0.0%  0:00.00   1     8    26    72K  1.88M
</I>&gt;<i> 500K  29.3M
</I>&gt;<i>    272 httpd        0.0%  0:00.01   1    11    27    76K  1.89M
</I>&gt;<i> 1.07M  29.3M
</I>&gt;<i>
</I>&gt;<i> 6. Work out how much memory Apache uses when mod_python is loaded
</I>&gt;<i> but before any requests have occurred. Ensure that no PythonImport
</I>&gt;<i> directives have been used.
</I>&gt;<i>
</I>&gt;<i> For example:
</I>&gt;<i>
</I>&gt;<i>           PID COMMAND      %CPU   TIME   #TH #PRTS #MREGS RPRVT  RSHRD
</I>&gt;<i> RSIZE  VSIZE
</I>&gt;<i>    291 httpd        0.0%  0:00.00   1     8    36   120K  2.77M
</I>&gt;<i> 700K  30.3M
</I>&gt;<i>    290 httpd        0.0%  0:00.00   1     8    36   124K  2.77M
</I>&gt;<i> 704K  30.3M
</I>&gt;<i>    289 httpd        0.0%  0:00.00   1     8    36   124K  2.77M
</I>&gt;<i> 704K  30.3M
</I>&gt;<i>    288 httpd        0.0%  0:00.00   1     8    36   124K  2.77M
</I>&gt;<i> 704K  30.3M
</I>&gt;<i>    287 httpd        0.0%  0:00.00   1     8    36   120K  2.77M
</I>&gt;<i> 704K  30.3M
</I>&gt;<i>    286 httpd        0.0%  0:00.07   1    11    36    40K  2.77M
</I>&gt;<i> 1.81M  30.3M
</I>&gt;<i>
</I>&gt;<i> Thus on MacOS where shared library for Python is used, process specific
</I>&gt;<i> memory use does go up, but no but that much. One sees a bigger jump
</I>&gt;<i> in shared memory use because of shared Python library.
</I>&gt;<i>
</I>&gt;<i> If eager, use a hello world mod_python example and trigger one request
</I>&gt;<i> against it and see how size changes.
</I>&gt;<i>
</I>&gt;<i> 7. If you are also loading lots of other Apache modules, such as
</I>&gt;<i> mod_perl,
</I>&gt;<i> module for PHP etc, list any significant ones so we might understand
</I>&gt;<i> what
</I>&gt;<i> else may be using memory. Ideally, do the tests with as little
</I>&gt;<i> modules loaded
</I>&gt;<i> as possible.
</I>&gt;<i>
</I>&gt;<i> So, what do other people get?
</I>&gt;<i>
</I>&gt;<i> Is that fact that Python installations often only provide a static
</I>&gt;<i> Python
</I>&gt;<i> library the culprit?
</I>&gt;<i>
</I>&gt;<i> Is there a better way of analysing memory use than this?
</I>&gt;<i>
</I>&gt;<i> It would be great if someone has the time and resources to actually
</I>&gt;<i> build
</I>&gt;<i> up two Python versions, one with static and shared libraries, then build
</I>&gt;<i> mod_python.so and compare for each. Being on the same platform
</I>&gt;<i> may help in comparing them. I can't really do this on MacOS and don't
</I>&gt;<i> have access to other platforms to test.
</I>&gt;<i>
</I>&gt;<i> Thanks in advance.
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20070303/5fbe4d54/attachment-0001.html">http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20070303/5fbe4d54/attachment-0001.html</A>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023228.html">[mod_python] Apache/mod_python process sizes. Help wanted.
</A></li>
	<LI>Next message: <A HREF="023231.html">[mod_python] Apache/mod_python process sizes. Help wanted.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23229">[ date ]</a>
              <a href="thread.html#23229">[ thread ]</a>
              <a href="subject.html#23229">[ subject ]</a>
              <a href="author.html#23229">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
