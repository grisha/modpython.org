From dpopowich at comcast.net  Fri Oct  1 11:14:41 2004
From: dpopowich at comcast.net (Daniel Popowich)
Date: Fri Oct  1 10:16:49 2004
Subject: [mod_python] using callable classes instead of plain functions in
	handlers
In-Reply-To: <20040929122830.GA5220@barbucha.martin.net>
References: <20040926082843.GB4578@barbucha.martin.net>
	<redirect-14059593@vse.cz>
	<20040929122830.GA5220@barbucha.martin.net>
Message-ID: <16733.26193.580977.656766@fenway.local.>


Martin Slouf writes:
> first of all, thanks for the answer.
> ...
> 1. im bound to use PSP -- graphics and gui features are done by
> another guy, we just cooperate on form fields, i think that it is no
> problem with mod_python.servlet (i agree, that code generated HTML
> definitely has its advances, but i cant use it now.)

<soapbox>
I Understand, but disagree.  If you take the point of view that a
designer of an interface is just that, a designer, not a coder, then
you do not have to work in PSP-like systems.  If you were writing a
Tkinter app, what would you do if you wanted the services of a graphic
designer to create a usable interface?  Design != Code.
</soapbox>

> to use PSP properly i would just call return the psp page from the
> 'write_content' method, right?

Depends on your PSP.  If your psp files are partial pages or page
fragments and you want to use HTMLPage to generate the page proper,
then yes, you can make calls to PSP from within write_content.  BTW,
I would make your calls to run() like this:

    def write_content(self):
	template = psp.PSP(self.req, filename='template.html')
	template.run({'servlet':self})


then you can reference servlet inside your psp files and get all the
goodies from form processing (and even make method calls on your
servlet).  I think you want to avoid making any references to "form"
or "session" inside your psp code if using it from mpservlets --
haven't done any testing, but there might be a collision of effort,
since both systems encapsulate those objects -- instead, reference
servlet.form and servlet.session.

If your psp files are complete pages, then you don't want to use
HTMLPage, but rather subclass Servlet directly.  Something like:

    class PSPServlet(Servlet):
	def respond(self):
	   if not Servlet.respond(self):
	      template = psp.PSP(self.req, filename='template.html')
	      template.run({'servlet':self})
	      return True
       
> now, finally, the question for you:
> 
> with mod_python.servlet it seems like just one class is involved in
> request processing and im probably unable to "call" another class in
> case of an error, am i right? or can i just instantiate a new class
> (new servlet) to handle the request in 'write_content' method,
> initialize it somehow (how?) and proccess it 'write_content' method?

Don't forget that you're working with pure python inside servlets; you
can instantiate any class (except other servlets) or call any method
or function you want to assist in processing a request.  If it's in
your PYTHONPATH, you can access it.

Also, if you truly want to pass control on to another servlet you can
always call internal_redirect() and the subrequest can get access to
the parent request.

Lastly, don't overlook the power of subclassing and python's ability
to manage methods as first-class objects.  I posted this not too long
ago for someone asking about managing authentication with mpservlets:

Originally posted 9/3/2004:

> Let's assume you have a servlet for your site that all servlets
> inherit from:
> 
>   class MySitePage(HTMLPage):
>      ...
> 
> and let's also assume that certain pages (not all) need
> authentication, then I would create another servlet:
> 
>   class MySiteAuthPage(MySitePage):
>     ...
> 
> Notice how it subclasses MySitePage.  In MySiteAuthPage.prep() I
> check the session for proper authentication and set a boolean, say,
> authenticated.  Then I override write_html() in MySiteAuthPage:
> 
>     def write_html(self):
>         if not self.authenticated:
>             save, self.write_content = self.write_content, self.genloginform
>             MySitePage.write_html(self)
>             self.write_content = save
>         else:
>             MySitePage.write_html(self)
> 
> where genloginform() makes calls to self.writeln() writing the login
> form to the browser.  What this does is, if not authenticated,
> momentarily replaces the write_content method of the servlet with the
> login form, otherwise, if authenticated, just writes out the page.
> 
> Then all my pages for my app either subclass MySitePage or
> MySiteAuthPage depending on whether or not the page needs
> authentication.  No calls to internal_redirect are necessary!

Good luck,

Daniel Popowich
-----------------------------------------------
http://home.comcast.net/~d.popowich/mpservlets/

From nick at dd.revealed.net  Fri Oct  1 10:28:37 2004
From: nick at dd.revealed.net (Nick)
Date: Fri Oct  1 10:28:51 2004
Subject: [mod_python] using callable classes instead of plain functions
	in	handlers
In-Reply-To: <16733.26193.580977.656766@fenway.local.>
References: <20040926082843.GB4578@barbucha.martin.net>	<redirect-14059593@vse.cz>	<20040929122830.GA5220@barbucha.martin.net>
	<16733.26193.580977.656766@fenway.local.>
Message-ID: <415D6995.70103@dd.revealed.net>

Daniel Popowich wrote:
> Martin Slouf writes:
>>first of all, thanks for the answer.
>>...
>>1. im bound to use PSP -- graphics and gui features are done by
>>another guy, we just cooperate on form fields, i think that it is no
>>problem with mod_python.servlet (i agree, that code generated HTML
>>definitely has its advances, but i cant use it now.)
> 
> <soapbox>
> I Understand, but disagree.  If you take the point of view that a
> designer of an interface is just that, a designer, not a coder, then
> you do not have to work in PSP-like systems.  If you were writing a
> Tkinter app, what would you do if you wanted the services of a graphic
> designer to create a usable interface?  Design != Code.
> </soapbox>

You may also want to consider a system that provides more separation of the 
HTML/interface and the Python code.  There are many, but allow me to take 
another opportunity to plug PSE, which I think does this very well.  A big 
bonus to your GUI developer is that you can provide custom tags so that 
he/she never has to see a lick of Python in the template.

http://nick.borko.org/pse

Nick
From terry.macdonald at dsl.pipex.com  Sat Oct  2 00:11:55 2004
From: terry.macdonald at dsl.pipex.com (Terry MacDonald)
Date: Fri Oct  1 18:11:59 2004
Subject: [mod_python] using callable classes instead of plain functions
	in handlers
In-Reply-To: <16733.26193.580977.656766@fenway.local.>
References: <20040926082843.GB4578@barbucha.martin.net>
	<redirect-14059593@vse.cz> <20040929122830.GA5220@barbucha.martin.net>
	<16733.26193.580977.656766@fenway.local.>
Message-ID: <1096668715.17356.21.camel@bigmac.taumu.com>

> > Notice how it subclasses MySitePage.  In MySiteAuthPage.prep() I
> > check the session for proper authentication and set a boolean, say,
> > authenticated.  Then I override write_html() in MySiteAuthPage:
> > 
> >     def write_html(self):
> >         if not self.authenticated:
> >             save, self.write_content = self.write_content, self.genloginform
> >             MySitePage.write_html(self)
> >             self.write_content = save
> >         else:
> >             MySitePage.write_html(self)
> > 
> > where genloginform() makes calls to self.writeln() writing the login
> > form to the browser.  What this does is, if not authenticated,
> > momentarily replaces the write_content method of the servlet with the
> > login form, otherwise, if authenticated, just writes out the page.
> > 
> > Then all my pages for my app either subclass MySitePage or
> > MySiteAuthPage depending on whether or not the page needs
> > authentication.  No calls to internal_redirect are necessary!

Daniel,

I'm in the process of working with mod_servlet after working with
mod_publisher for a while.  I like it but I'm still working out for
myself the discernable benefits it has over publisher. Anyhow...

...I tried recreating the above page login/authentication, however, it
only worked when I overrode write_body_parts instead of write_html.
Overriding write_html produced nothing.  The browser page just stayed on
the page it was on before selecting the protected linked page.  I'm
still trying to understand why...any pointers?

Currently I use HTMLPage to form my page. But I use precompiled Cheetah
templates for the body of each page. e.g. my index page looks like
this...
from SitePage import SitePage
from let_index import let_index
                                                                                                                   class index(SitePage):

    def write_content(self):
        let_index.req = self.req
        self.write(let_index())

As an aside as I am using cheetah this way I take it I will have lots of
small files like this if I have lots of pages, whereas in publisher I
could have one index module holding many different page rendering
functions. Is this the way it has to be with the class/servlet based
approach?

Keep up the good work!

cheers
-- 
Terry
Registered Linux User # 311806



From mozbugbox at yahoo.com.au  Sat Oct  2 10:19:06 2004
From: mozbugbox at yahoo.com.au (JustFillBug)
Date: Sat Oct  2 05:19:16 2004
Subject: [mod_python] Re: HTTP digest auth
References: <20040930173508.A26123@libero.sunshine.ale>
Message-ID: <slrnclssnc.rhi.mozbugbox@mozbugbox.somehost.org>

On 2004-09-30, Alessandro de Manzano <ale@unixmania.net> wrote:
>
> Now I'ld try to implement also (or only, better) HTTP digest auth. for
> more security (yes, I know it's not perfect either, a SSL/TLS layer
> would probably be much better but for now I can't use it ;( )
>
> I'm reading RFC 2617 but to not reinvent the wheel ;), anyone knows
> some mod_python-based implementation, examples, etc. ?
> Is not clear to me how this new auth method relates to mod_python's
> Request object (as you may have guessed, I'm quite new to mod_python ;)
> )
>

http://www.modpython.org/pipermail/mod_python/2004-April/015452.html


From exogen at gmail.com  Sat Oct  2 15:19:57 2004
From: exogen at gmail.com (Brian Beck)
Date: Sat Oct  2 14:19:59 2004
Subject: [mod_python] ServerName, UseCanonicalName, and mod_python
Message-ID: <bfda1ca50410021119619eb96@mail.gmail.com>

Hello!

I'm trying to determine how mod_python determines what server name its
handlers are being applied to?  Here's an example...

In Apache, ServerName is exogen.cwru.edu:80, and UseCanonicalName is Off.

What this combination means is that anyone can access the address
http://exogen.cwru.edu, and people inside the cwru.edu domain can
access http://exogen and NOT have Apache 'redirect' them to
http://exogen.cwru.edu.

If UseCanonicalName were On, it would effectively replace any request
for just 'exogen' with 'exogen.cwru.edu'.

Here's where mod_python comes in.

I have the following directive set up, which in short, enable the
mod_python handler for any files in the /python subdirectory of my
webserver ('Apache' is NOT Apache's install path, but what most people
name 'htdocs'):

<Directory "F:/Apache/python">
    AllowOverride FileInfo
    SetHandler mod_python
    PythonHandler mod_python.publisher
</Directory>

As expected, any request for a Python script when accessing it through
http://exogen.cwru.edu/python/ actually parses the requested script
using mod_python.

However, even with UseCanonicalName set to Off, a request for scripts
in  http://exogen/python/ (the same directory, but with a differently
supplied ServerName) return the contents of the script rather than
handing it over to mod_python.

Any help would be greatly appreciated -- I really do not want to set
UseCanonicalName to On but still want scripts to be handled using
mod_python.  Do I have to use virtual hosts or something to accomplish
this?

-- 
Brian Beck
Adventurer of the First Order
From jafo at tummy.com  Sat Oct  2 15:08:04 2004
From: jafo at tummy.com (Sean Reifschneider)
Date: Sat Oct  2 16:08:18 2004
Subject: [mod_python] Any thoughts on the import problems?
Message-ID: <20041002200803.GT17925@tummy.com>

I just wanted to follow up on my previous message:

   http://www.modpython.org/pipermail/mod_python/2004-September/016289.html

Any thoughts on what that problem is or how to approach it in
mod_python?  I've looked at the mod_python code a bit, but really don't
understand enough of it to be able to gain any traction.

Sean
-- 
 Sean's Rule of Mailing-List Support: Whenever someone says "There is no
 problem with our mail server", it's a problem with their mail server.
Sean Reifschneider, Member of Technical Staff <jafo@tummy.com>
tummy.com, ltd. - Linux Consulting since 1995.  Qmail, Python, SysAdmin
From Almad at include.cz  Sun Oct  3 01:40:33 2004
From: Almad at include.cz (Lukas Linhart)
Date: Sat Oct  2 18:40:14 2004
Subject: [mod_python] Session always create new session ID
Message-ID: <200410030040.42345.Almad@include.cz>

Greetings, 

I'm trying to use session management with mod_python.publisher. I'm testing 
following code: 

def index(req, sessID):
 req.content_type = "text/html"
 if not sessID:
  req.write("New session")
  relace = Session.Session(req)
 else:
  req.write("Restoring session "+sessID")
  relace = Session.Session(req, sessID)
 req.write("<a href=\"testing.py?sessID="+relace.id()+"\">Reload</a>")


Well, here is no problem with creating session or printing it's ID on 
"Reload". However, on each request Session.Session(req, sessID) generate a 
new ID. 

What I'm doing wrong / where problem should lie? 

Regards, 
-- 

Lukas "Almad" Linhart

[:: http://www.Include.cz/ ::]
[:: Including Your wishes ::]
[:: Almad@Include.cz ::]

-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 190 bytes
Desc: not available
Url : http://modpython.org/pipermail/mod_python/attachments/20041003/347000a9/attachment.bin
From sanders at apache.org  Sat Oct  2 17:31:50 2004
From: sanders at apache.org (Scott Sanders)
Date: Sat Oct  2 19:32:00 2004
Subject: [mod_python] Session always create new session ID
In-Reply-To: <200410030040.42345.Almad@include.cz>
References: <200410030040.42345.Almad@include.cz>
Message-ID: <3BF21CE0-14CB-11D9-8C02-000A95D2D288@apache.org>

You need to do a session.save() before the request is finished.

Scott

On Oct 2, 2004, at 3:40 PM, Lukas Linhart wrote:

> Greetings,
>
> I'm trying to use session management with mod_python.publisher. I'm 
> testing
> following code:
>
> def index(req, sessID):
>  req.content_type = "text/html"
>  if not sessID:
>   req.write("New session")
>   relace = Session.Session(req)
>  else:
>   req.write("Restoring session "+sessID")
>   relace = Session.Session(req, sessID)
>  req.write("<a href=\"testing.py?sessID="+relace.id()+"\">Reload</a>")
>
>
> Well, here is no problem with creating session or printing it's ID on
> "Reload". However, on each request Session.Session(req, sessID) 
> generate a
> new ID.
>
> What I'm doing wrong / where problem should lie?
>
> Regards,
> -- 
>
> Lukas "Almad" Linhart
>
> [:: http://www.Include.cz/ ::]
> [:: Including Your wishes ::]
> [:: Almad@Include.cz ::]
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From grahamd at dscpl.com.au  Sun Oct  3 10:55:58 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Oct  2 19:56:03 2004
Subject: [mod_python] Any thoughts on the import problems?
In-Reply-To: <20041002200803.GT17925@tummy.com>
References: <20041002200803.GT17925@tummy.com>
Message-ID: <9B5FD3EE-14CE-11D9-8437-000393DCF16E@dscpl.com.au>


On 03/10/2004, at 6:08 AM, Sean Reifschneider wrote:

> I just wanted to follow up on my previous message:
>
>     
> http://www.modpython.org/pipermail/mod_python/2004-September/ 
> 016289.html
>
> Any thoughts on what that problem is or how to approach it in
> mod_python?  I've looked at the mod_python code a bit, but really don't
> understand enough of it to be able to gain any traction.

Looking at your previous post, can't see why you are expecting not to  
get the
error:

    Mod_python error: "PythonHandler foo::handler"

    Traceback (most recent call last):

      File "/usr/lib/python2.3/site-packages/mod_python/apache.py", line
    299, in HandlerDispatch
        result = object(req)

      File "/home/httpd/modpythonpublishertest/py/foo.py", line 5, in
    handler
        module.function(req)

      File "/home/httpd/modpythonpublishertest/py/package/module.py",  
line
    4, in function
        mod_python.util.FieldStorage(request)

    AttributeError: 'module' object has no attribute 'util'

I am sure others would have pointed out the obvious that module.py  
isn't self
contained as far as importing what it requires. Ie., in:

       import mod_python

       def function(request):
          mod_python.util.FieldStorage(request)

you should have:

   import mod_python.util

and not just:

   import mod_python

I am perhaps missing the point of what you are trying to demonstrate,  
but you
shouldn't rely on mod_python module to have automatically imported util  
as a
sub module or for some other module to have already loaded it as then  
you get
order dependencies.

That said, I have had strange problems with mod_python.publisher  
before, where
even though I had all the correct imports, it would come up with a  
similar error
for it, but only in the case where the handler had been modified and  
thus
mod_python had decided to reload it.

Note that the situtation was where I was using my own handler which so  
happened
to have:

   import mod_python.publisher

This was so I could use the authorisation mechanisms in that module  
explicitly in
my own handler.

It was a very strange situation that I could never work out and which  
may have been
complicated by the fact that mod_python.publisher was specified as a  
handler using
SetHandler in a different part of the directory hierarchy.

Because I had no control over the Apache web server and could not  
simply stop and
start it when I sometimes got this, I would add something like the  
following evil
lines into the start of the handler file which was the problem.

   import sys
   try: del sys.modules["mod_python.publisher"]
   except: pass

This would precede the import of mod_python.publisher and thus when the  
import was
reached, the fact that it had been explicitly removed out of  
sys.modules would
caused it to be reimported correctly.

Yes, I realise that deleting modules out of sys.modules isn't the most  
sensible
thing to do, but sometimes I find it quite useful. What I use is a  
special set of
functions callable by mod_python.publisher which give me things back  
like the
current sys.path and list of modules loaded under sys.modules. I then  
have a purge
method which I can use to add in code to delete any modules I want to  
delete
straight out of sys.modules. This might be used where you import a  
module but at
run time it has errors. Because "import" was used, your normal course  
of action
is normally to restart Apache, something which in the environment I am  
in I could
not do. Thus, instead of a restart of Apache, I delete the offending  
modules out
of sys.modules and then touch the handler module which uses the import  
so it gets
reloaded and import is rerun.

Okay, it is a hack, but if you are careful, can be a lifesaver. :-)

--
Graham Dumpleton (grahamd@dscpl.com.au)

From xslom03 at vse.cz  Sun Oct  3 09:55:05 2004
From: xslom03 at vse.cz (Martin Slouf)
Date: Sun Oct  3 02:55:36 2004
Subject: [mod_python] Session always create new session ID
In-Reply-To: <redirect-14148273@vse.cz>
References: <redirect-14148273@vse.cz>
Message-ID: <20041003065505.GA2619@barbucha.martin.net>

Hi,

look at the code listening bellow, you have to call session.save() (handler
request) manually at end of each request.  maybe using another handler
(mod_python.servlet -- http://home.comcast.net/~d.popowich/mpservlets/) is more
convenient.

Also, session id is stored as a cookie (pysid) on client side, so maybe no need
to print it each time into each link element.

But there is something else id like to know -- is there a way how can i rename
the default name ('pysid') of a session -- ie. if im using 2 sites on my server
which both use session, there will be a problem.

reagrds, martin.

(mo?n? m??u i ?esky? :)

- - - - 

#! /usr/bin/env python
# -*- ISO-8859-2 -*-

# Time-stamp: < session_test.py (15:20 25.9.2004) >

from mod_python import apache
from mod_python import Session

def index(req):
    s = Session.Session(req, timeout = 1)
    if (s.is_new()):
        s["count"] = 0
        s["tmp"] = "message"
        s["list"] = ["1", "b", "2", "d"]
        s["square"] = Square(5)
    s["count"] += 1
    req.write(s.id() + "\n")
    req.write(str(s) + "\n")
    req.write(str(s["square"].a) + "\n")
    s.save()

def invalidate(req):
    s = Session.Session(req)
    s.invalidate()
    req.write("invalidate")

class Square:
    def __init__(self, a = 0):
        self.a = 0
    def __str__(self):
        return "Square: a = %d" % (self.a,)
    def __repr__(self):
        return str(self)

- - - -

# .htacces

AddHandler mod_python .py
PythonHandler mod_python.publisher
PythonDebug On
PythonAutoReload On

- - - -

On Sun, Oct 03, 2004 at 01:00:31AM +0200, Lukas Linhart wrote:
> Greetings, 
> 
> I'm trying to use session management with mod_python.publisher. I'm testing 
> following code: 
> 
> def index(req, sessID):
>  req.content_type = "text/html"
>  if not sessID:
>   req.write("New session")
>   relace = Session.Session(req)
>  else:
>   req.write("Restoring session "+sessID")
>   relace = Session.Session(req, sessID)
>  req.write("<a href=\"testing.py?sessID="+relace.id()+"\">Reload</a>")
> 
> 
> Well, here is no problem with creating session or printing it's ID on 
> "Reload". However, on each request Session.Session(req, sessID) generate a 
> new ID. 
> 
> What I'm doing wrong / where problem should lie? 
> 
> Regards, 



> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From xlinl01 at vse.cz  Sun Oct  3 12:24:28 2004
From: xlinl01 at vse.cz (Lukas Almad Linhart)
Date: Sun Oct  3 05:23:45 2004
Subject: [mod_python] Session always create new session ID
In-Reply-To: <20041003065505.GA2619@barbucha.martin.net>
References: <redirect-14148273@vse.cz>
	<20041003065505.GA2619@barbucha.martin.net>
Message-ID: <200410031124.33674.xlinl01@vse.cz>

Zdravim, 

s mod_pythonem pomerne silne zacinam a je to prechod z klasickeho pythonu a 
pomerne dlouhe dobe skriptovani v php, takze docela zmena. Kazdopadne se 
nebranim pouziti jinych handleru, ale psp ani spyce (byt se mi spyce libi) 
nechci pouzivat, zvlast proto, ze ani moc netouzim po vkladani python kodu 
primo do zdrojaku. 

Je nejaky problem s volanim session.save (pomalost etc.)? Vzhledem k tomu, ze 
si budu psat stejne vlastni template system, tak mi to nijak extra nevadi, 
asi min, nez pouzit nejakou implementaci, ktera bude nejak horsi 
(implementuje zbytecne kraviny, ne tak stabilni apod.). 

> Also, session id is stored as a cookie (pysid) on client side, so maybe no
> need to print it each time into each link element.

A co lide co maji vyple cookies? ;)

> But there is something else id like to know -- is there a way how can i
> rename the default name ('pysid') of a session -- ie. if im using 2 sites
> on my server which both use session, there will be a problem.

Koukal jsem do zdrojaku mod_pythonu a tam je prefix nastavitelny v Session.py, 
takze by to asi slo hacknout a predelat tak, aby to jelo generovalo nejaky 
prefix nebo tak neco. 
A nebo, pouzit DbmSession, na coz se asi stejne chystam :-]

Kazdopadne dik za rady (spoluzaku ;)), 

-- 

Lukas "Almad" Linhart

[:: http://www.Include.cz/ ::]
[:: Including Your wishes ::]
[:: Almad@Include.cz ::]

E-mail Martin Slouf ze dne Sun 3. of October 2004 08:55:
> Hi,
>
> look at the code listening bellow, you have to call session.save() (handler
> request) manually at end of each request.  maybe using another handler
> (mod_python.servlet -- http://home.comcast.net/~d.popowich/mpservlets/) is
> more convenient.
>
> Also, session id is stored as a cookie (pysid) on client side, so maybe no
> need to print it each time into each link element.
>
> But there is something else id like to know -- is there a way how can i
> rename the default name ('pysid') of a session -- ie. if im using 2 sites
> on my server which both use session, there will be a problem.
>
> reagrds, martin.
>
> (mo?n? m??u i ?esky? :)
>
> - - - -
>
> #! /usr/bin/env python
> # -*- ISO-8859-2 -*-
>
> # Time-stamp: < session_test.py (15:20 25.9.2004) >
>
> from mod_python import apache
> from mod_python import Session
>
> def index(req):
>     s = Session.Session(req, timeout = 1)
>     if (s.is_new()):
>         s["count"] = 0
>         s["tmp"] = "message"
>         s["list"] = ["1", "b", "2", "d"]
>         s["square"] = Square(5)
>     s["count"] += 1
>     req.write(s.id() + "\n")
>     req.write(str(s) + "\n")
>     req.write(str(s["square"].a) + "\n")
>     s.save()
>
> def invalidate(req):
>     s = Session.Session(req)
>     s.invalidate()
>     req.write("invalidate")
>
> class Square:
>     def __init__(self, a = 0):
>         self.a = 0
>     def __str__(self):
>         return "Square: a = %d" % (self.a,)
>     def __repr__(self):
>         return str(self)
>
> - - - -
>
> # .htacces
>
> AddHandler mod_python .py
> PythonHandler mod_python.publisher
> PythonDebug On
> PythonAutoReload On
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 190 bytes
Desc: not available
Url : http://modpython.org/pipermail/mod_python/attachments/20041003/b30b35bd/attachment.bin
From Almad at include.cz  Sun Oct  3 15:55:29 2004
From: Almad at include.cz (Lukas Linhart)
Date: Sun Oct  3 08:54:52 2004
Subject: [mod_python] Session always create new session ID
In-Reply-To: <200410031124.33674.xlinl01@vse.cz>
References: <redirect-14148273@vse.cz>
	<20041003065505.GA2619@barbucha.martin.net>
	<200410031124.33674.xlinl01@vse.cz>
Message-ID: <200410031455.36968.Almad@include.cz>

Oh, sorry for the post, it was meant only for author and I forgot that reply 
goes into mailing list :/

Sorry again. 

E-mail Lukas Almad Linhart ze dne Sun 3. of October 2004 11:24:
> Zdravim,
(...)
> Kazdopadne dik za rady (spoluzaku ;)),

-- 

Lukas "Almad" Linhart

[:: http://www.Include.cz/ ::]
[:: Including Your wishes ::]
[:: Almad@Include.cz ::]
[:: PGP/GNUPg key: http://download.almad.net/pubkey.asc ::]
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 190 bytes
Desc: not available
Url : http://modpython.org/pipermail/mod_python/attachments/20041003/8333eafb/attachment.bin
From itodd at itodd.org  Sun Oct  3 19:26:47 2004
From: itodd at itodd.org (Todd Boland)
Date: Sun Oct  3 18:26:57 2004
Subject: [mod_python] authenhandler woes
Message-ID: <50527CC4-158B-11D9-8241-000A95CCEA34@itodd.org>

I've created a mod_python authenhandler which sets some session data. 
It works perfectly for the initial request. Unfortunately, all 
subsequent requests hang on the line I marked with a > character. 
Anyone have any ideas?

The behavior  I'm experiencing is as if the handler was waiting for a 
lock to be released on the session dbm file. I'm using mod_python 3.1.3 
with Python 2.3.4

from mod_python import apache, util
from mod_python.Session import Session

def authenhandler(req):
         password = req.get_basic_auth_pw()
         username = req.user

 >        req.session = Session(req, secret="********")

         if req.session.is_new() == True:
                 from RPM.database import connection
                 cursor = connection.cursor()

                 try:
                         cursor.execute("SELECT accounts.id AS 
account_id, users.id AS user_id, people.id AS person_id, 
organizations.id AS organization_id, users.username AS username, 
CONCAT(people.first_name, ' ', people.last_name) AS person_name, 
organizations.name AS organization_name, people.email_address AS 
email_address FROM accounts, users, people, organizations WHERE 
users.person_id = people.id AND people.organization_id = 
organizations.id AND accounts.organization_id = organizations.id AND 
users.username = %s AND users.password = PASSWORD(%s)" % 
(connection.escape(username), connection.escape(password)))

                         req.session.update(cursor.fetchone())
                         cursor.execute("UPDATE users SET last_login = 
NOW() WHERE id = %d" % req.session["user_id"])
                         cursor.close()
                         req.session.save()

                 except(KeyError, AttributeError):
                         req.log_error("Invalid password for %s" % 
req.user,
                                 apache.APLOG_NOTICE )
                         return apache.HTTP_UNAUTHORIZED

         return apache.OK

From itodd at itodd.org  Sun Oct  3 20:35:30 2004
From: itodd at itodd.org (Todd Boland)
Date: Sun Oct  3 19:35:44 2004
Subject: [mod_python] authenhandler woes
In-Reply-To: <50527CC4-158B-11D9-8241-000A95CCEA34@itodd.org>
References: <50527CC4-158B-11D9-8241-000A95CCEA34@itodd.org>
Message-ID: <E99D0651-1594-11D9-8241-000A95CCEA34@itodd.org>

A bit of googling reveals this post by Grisha who recommended passing 
lock=0 when instantiating the session:

http://www.modpython.org/pipermail/mod_python/2004-April/015374.html

This fixes my problem but I am unaware of the implications of turning 
session locking off. Can anyone explain them?

Todd

On Oct 3, 2004, at 6:26 PM, Todd Boland wrote:

> I've created a mod_python authenhandler which sets some session data. 
> It works perfectly for the initial request. Unfortunately, all 
> subsequent requests hang on the line I marked with a > character. 
> Anyone have any ideas?
>
> The behavior  I'm experiencing is as if the handler was waiting for a 
> lock to be released on the session dbm file. I'm using mod_python 
> 3.1.3 with Python 2.3.4
>
> from mod_python import apache, util
> from mod_python.Session import Session
>
> def authenhandler(req):
>         password = req.get_basic_auth_pw()
>         username = req.user
>
> >        req.session = Session(req, secret="********")
>
>         if req.session.is_new() == True:
>                 from RPM.database import connection
>                 cursor = connection.cursor()
>
>                 try:
>                         cursor.execute("SELECT accounts.id AS 
> account_id, users.id AS user_id, people.id AS person_id, 
> organizations.id AS organization_id, users.username AS username, 
> CONCAT(people.first_name, ' ', people.last_name) AS person_name, 
> organizations.name AS organization_name, people.email_address AS 
> email_address FROM accounts, users, people, organizations WHERE 
> users.person_id = people.id AND people.organization_id = 
> organizations.id AND accounts.organization_id = organizations.id AND 
> users.username = %s AND users.password = PASSWORD(%s)" % 
> (connection.escape(username), connection.escape(password)))
>
>                         req.session.update(cursor.fetchone())
>                         cursor.execute("UPDATE users SET last_login = 
> NOW() WHERE id = %d" % req.session["user_id"])
>                         cursor.close()
>                         req.session.save()
>
>                 except(KeyError, AttributeError):
>                         req.log_error("Invalid password for %s" % 
> req.user,
>                                 apache.APLOG_NOTICE )
>                         return apache.HTTP_UNAUTHORIZED
>
>         return apache.OK
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>

From dpopowich at comcast.net  Sun Oct  3 22:25:37 2004
From: dpopowich at comcast.net (Daniel Popowich)
Date: Sun Oct  3 21:26:25 2004
Subject: [mod_python] using callable classes instead of plain functions
	in handlers
In-Reply-To: <1096668715.17356.21.camel@bigmac.taumu.com>
References: <20040926082843.GB4578@barbucha.martin.net>
	<redirect-14059593@vse.cz>
	<20040929122830.GA5220@barbucha.martin.net>
	<16733.26193.580977.656766@fenway.local.>
	<1096668715.17356.21.camel@bigmac.taumu.com>
Message-ID: <16736.42641.456409.74671@h00a0cc25a952.ne.client2.attbi.com>


> I'm in the process of working with mod_servlet after working with
> mod_publisher for a while.  I like it but I'm still working out for
> myself the discernable benefits it has over publisher. Anyhow...
> 
> ...I tried recreating the above page login/authentication, however, it
> only worked when I overrode write_body_parts instead of write_html.
> Overriding write_html produced nothing.  The browser page just stayed on
> the page it was on before selecting the protected linked page.  I'm
> still trying to understand why...any pointers?

My fault.  Bad cut&paste.  The write_html method should have ended
with:

    return True

Otherwise, by not returning anything it implicitly returns None, which
evaluates to false.  Bad.  Why?  You need to understand the respond
method which calls write_html.  Go here for an explanation:
http://lnx1.blue-fox.com/~dpopowich/mpstutorial/lifecycle and the
tutorial immediately following.

Also, to better explain "Authentication By Subclassing" than I have on
this list, I have put together a live demo, a picture being worth a
thousand words and all that.  Goto:

    http://lnx1.blue-fox.com/~dpopowich/mpstutorial/sitenoauth

> Currently I use HTMLPage to form my page. But I use precompiled Cheetah
> templates for the body of each page. e.g. my index page looks like
> this...
> As an aside as I am using cheetah this way I take it I will have lots of
> small files like this if I have lots of pages, whereas in publisher I
> could have one index module holding many different page rendering
> functions. Is this the way it has to be with the class/servlet based
> approach?

I just built a very comprehensive content management system with
mpservlets that does what you want.  ONE servlet manages the whole
site.  It does this via PATH_INFO.  If you're not familiar with it you
should find out about it because it can be a very powerful tool.
Briefly...

If you have a URI, /some/dir/target, and a request comes in for
/some/dir/target/x/y/z then /some/dir/target will get the request with
PATH_INFO set to x/y/z.  Think of it as extraneous path information
that was passed along with the request.  Many systems use this to
create "clean" urls.

Now, if you have a servlet, /some/dir/myservlet, and a request comes
in for /some/dir/myservlet/this/file, then myservlet will have an
instance variable, path_info, set to ['this', 'file'].  (Aside: if a
request has no PATH_INFO then the path_info instance variable is set
to an empty list.)  Using this mechanism you can manage a site with a
few servlets using path_info as a lookup into a database or a
filesystem.


Cheers!

Daniel Popowich
-----------------------------------------------
http://home.comcast.net/~d.popowich/mpservlets/

From dg at sponsera.com  Mon Oct  4 01:32:22 2004
From: dg at sponsera.com (David Geller)
Date: Mon Oct  4 00:31:39 2004
Subject: [mod_python] wierd python path problem
Message-ID: <4160D256.50108@sponsera.com>

Hi All -

A very strange problem appeared today.

[ Config: RHat 9, Python2.2.3, mod_python 3.0.4 ]

I've been running our application on a server for *months*, and it has 
been running fine.

All of a sudden, it stopped working. I finally found the problem: the 
sys.path was wrong!

Background:

Installed on the machine was an original version of python under 
/usr/lib/python2.2.

Months ago, when I installed our app, I had built from source a more 
up-to-date version of python under /usr/local/lib/python2.2, along with 
a mod_python built against this new python. All of my custom packages 
were put under this /usr/local version, and everything has been working 
like a champ.

Until just recently. After several apache restarts, when I traced the 
path internally, I found the mod_python trying to find things in the 
original "/usr/lib/python2.2", *not* the /usr/local version. When I 
renamed the /usr/lib/python2.2 version to something else (and restarted 
apache), mod_python started again looking at the /usr/local version, and 
now everything is working again.

Questions:

1. How does mod_python (or Python, for that matter) get the "initial", 
compiled-in version of the path to search? If there is no PYTHONPATH 
variable, etc., will it *always* first looked at "/usr/lib" *first*, no 
matter what? *Then* try /usr/local/lib if not one there? I had always 
thought that the defaults where internalized from which  target 
directory Python was compiled to. (i.e., if I was going to install in 
/usr/local, via "configure", the default would be /usr/local/lib/pythonXX).

2. Why/How/What would cause the behavior to change like this so 
suddenly? I have looked at all the obvious things (like somone 
installing a new python 2. under /user/lib, or other config changes), 
but nothing seems obvious.

Thanks for your help!

David Geller
From brian.bird at securetrading.com  Mon Oct  4 10:21:04 2004
From: brian.bird at securetrading.com (Brian Bird)
Date: Mon Oct  4 04:21:08 2004
Subject: [mod_python] authenhandler woes
In-Reply-To: <E99D0651-1594-11D9-8241-000A95CCEA34@itodd.org>
Message-ID: <020801c4a9eb$174f53e0$190b030a@Menai.local>

Not sure what will happen if you turn off locking. However, I experienced
similar hangs when I first started using Session. It seemed to happen
whenever a single request tried to instantiate two new Session objects, the
second instantiation would usually (if not always) hang the script. No idea
why, but I re-wrote my code to only create one Session and it was fine.

Brian

-----Original Message-----
From: mod_python-bounces@modpython.org
[mailto:mod_python-bounces@modpython.org] On Behalf Of Todd Boland
Sent: 04 October 2004 00:36
To: mod_python user mailing list
Subject: Re: [mod_python] authenhandler woes


A bit of googling reveals this post by Grisha who recommended passing 
lock=0 when instantiating the session:

http://www.modpython.org/pipermail/mod_python/2004-April/015374.html

This fixes my problem but I am unaware of the implications of turning 
session locking off. Can anyone explain them?

Todd

On Oct 3, 2004, at 6:26 PM, Todd Boland wrote:

> I've created a mod_python authenhandler which sets some session data.
> It works perfectly for the initial request. Unfortunately, all 
> subsequent requests hang on the line I marked with a > character. 
> Anyone have any ideas?
>
> The behavior  I'm experiencing is as if the handler was waiting for a
> lock to be released on the session dbm file. I'm using mod_python 
> 3.1.3 with Python 2.3.4
>
> from mod_python import apache, util
> from mod_python.Session import Session
>
> def authenhandler(req):
>         password = req.get_basic_auth_pw()
>         username = req.user
>
> >        req.session = Session(req, secret="********")
>
>         if req.session.is_new() == True:
>                 from RPM.database import connection
>                 cursor = connection.cursor()
>
>                 try:
>                         cursor.execute("SELECT accounts.id AS
> account_id, users.id AS user_id, people.id AS person_id, 
> organizations.id AS organization_id, users.username AS username, 
> CONCAT(people.first_name, ' ', people.last_name) AS person_name, 
> organizations.name AS organization_name, people.email_address AS 
> email_address FROM accounts, users, people, organizations WHERE 
> users.person_id = people.id AND people.organization_id = 
> organizations.id AND accounts.organization_id = organizations.id AND 
> users.username = %s AND users.password = PASSWORD(%s)" % 
> (connection.escape(username), connection.escape(password)))
>
>                         req.session.update(cursor.fetchone())
>                         cursor.execute("UPDATE users SET last_login =
> NOW() WHERE id = %d" % req.session["user_id"])
>                         cursor.close()
>                         req.session.save()
>
>                 except(KeyError, AttributeError):
>                         req.log_error("Invalid password for %s" %
> req.user,
>                                 apache.APLOG_NOTICE )
>                         return apache.HTTP_UNAUTHORIZED
>
>         return apache.OK
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org 
> http://mailman.modpython.org/mailman/listinfo/mod_python
>

_______________________________________________
Mod_python mailing list
Mod_python@modpython.org
http://mailman.modpython.org/mailman/listinfo/mod_python

From terry.macdonald at dsl.pipex.com  Mon Oct  4 12:28:49 2004
From: terry.macdonald at dsl.pipex.com (Terry MacDonald)
Date: Mon Oct  4 06:28:53 2004
Subject: [mod_python] using callable classes instead of plain functions
	in handlers
In-Reply-To: <16736.42641.456409.74671@h00a0cc25a952.ne.client2.attbi.com>
References: <20040926082843.GB4578@barbucha.martin.net>
	<redirect-14059593@vse.cz> <20040929122830.GA5220@barbucha.martin.net>
	<16733.26193.580977.656766@fenway.local.>
	<1096668715.17356.21.camel@bigmac.taumu.com>
	<16736.42641.456409.74671@h00a0cc25a952.ne.client2.attbi.com>
Message-ID: <1096885729.17356.49.camel@bigmac.taumu.com>

> I just built a very comprehensive content management system with
> mpservlets that does what you want.  ONE servlet manages the whole
> site.  It does this via PATH_INFO.  If you're not familiar with it you
> should find out about it because it can be a very powerful tool.
> Briefly...
> 
> If you have a URI, /some/dir/target, and a request comes in for
> /some/dir/target/x/y/z then /some/dir/target will get the request with
> PATH_INFO set to x/y/z.  Think of it as extraneous path information
> that was passed along with the request.  Many systems use this to
> create "clean" urls.
> 
> Now, if you have a servlet, /some/dir/myservlet, and a request comes
> in for /some/dir/myservlet/this/file, then myservlet will have an
> instance variable, path_info, set to ['this', 'file'].  (Aside: if a
> request has no PATH_INFO then the path_info instance variable is set
> to an empty list.)  Using this mechanism you can manage a site with a
> few servlets using path_info as a lookup into a database or a
> filesystem.

Thanks for the reply, Dan. I commend you in your support efforts.

If you use servlets the way you have described what do you see as the
the differences and/or benefits servlets has over the publisher handler,
which effectively does the same thing?

cheers
-- 
Terry
Registered Linux User # 311806


From grahamd at dscpl.com.au  Mon Oct  4 23:05:00 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Mon Oct  4 08:05:05 2004
Subject: [mod_python] Setting PythonOption to an empty string.
Message-ID: <9DA766AE-15FD-11D9-BA2F-000393DCF16E@dscpl.com.au>

I might be missing something, but I want to be able to set a 
PythonOption variable
to be an empty string. Alternatively, is there a way in the .htaccess 
file to unset
a PythonOption variable which has been inherited from a parent 
directory?

When I try and set the variable to an empty string. Ie.,

   PythonOption Name ""

I get an Apache error:

> Internal Server Error
>
> The server encountered an internal error or misconfiguration and was 
> unable to complete your request.
>
> Please contact the server administrator,  you@example.com and inform 
> them of the time the error occurred, and anything you might have done 
> that may have caused the error.
>
> More information about this error may be available in the server error 
> log.
> Apache/2.0.51 (Unix) mod_python/3.1.3 Python/2.3 Server at localhost 
> Port 8080

This is a little bit annoying. :-(

--
Graham Dumpleton (grahamd@dscpl.com.au)

From dpopowich at comcast.net  Mon Oct  4 10:34:16 2004
From: dpopowich at comcast.net (Daniel Popowich)
Date: Mon Oct  4 09:36:35 2004
Subject: [mod_python] using callable classes instead of plain functions
	in handlers
In-Reply-To: <1096885729.17356.49.camel@bigmac.taumu.com>
References: <20040926082843.GB4578@barbucha.martin.net>
	<redirect-14059593@vse.cz>
	<20040929122830.GA5220@barbucha.martin.net>
	<16733.26193.580977.656766@fenway.local.>
	<1096668715.17356.21.camel@bigmac.taumu.com>
	<16736.42641.456409.74671@h00a0cc25a952.ne.client2.attbi.com>
	<1096885729.17356.49.camel@bigmac.taumu.com>
Message-ID: <16737.20824.489309.705732@fenway.local.>


> > I just built a very comprehensive content management system with
> > mpservlets that does what you want.  ONE servlet manages the whole
> > site.  It does this via PATH_INFO.  If you're not familiar with it you
> > should find out about it because it can be a very powerful tool.
> > Briefly...
> > 
> > If you have a URI, /some/dir/target, and a request comes in for
> > /some/dir/target/x/y/z then /some/dir/target will get the request with
> > PATH_INFO set to x/y/z.  Think of it as extraneous path information
> > that was passed along with the request.  Many systems use this to
> > create "clean" urls.
> > 
> > Now, if you have a servlet, /some/dir/myservlet, and a request comes
> > in for /some/dir/myservlet/this/file, then myservlet will have an
> > instance variable, path_info, set to ['this', 'file'].  (Aside: if a
> > request has no PATH_INFO then the path_info instance variable is set
> > to an empty list.)  Using this mechanism you can manage a site with a
> > few servlets using path_info as a lookup into a database or a
> > filesystem.
> 
> Thanks for the reply, Dan. I commend you in your support efforts.
> 
> If you use servlets the way you have described what do you see as the
> the differences and/or benefits servlets has over the publisher handler,
> which effectively does the same thing?

The difference, in a nutshell: object-oriented programming vs.
functional programming.

I prefer OO programming: by loading Servlet and HTMLPage with common
functionality (automatic form processing, session management, HTML
generation) that's less code I have to write per handler.  By
enforcing a lifecycle to requests (see
http://lnx1.blue-fox.com/~dpopowich/mpstutorial/lifecycle) my code is
now better organized, easier to read and easier to maintain.

And just recently someone was asking about integrating PSP with
servlets.  I suggested subclassing Servlet directly to create a
PSPServlet class.  Now they can have all the goodies in Servlet
automatically.  BTW, as an aside: while I was developing mpservlets I
had only one class, HTMLPage, but realized that was an error in
design because there was a lot of functionality that was generic and
not specific to serving requests for HTML.  I took all the non-HTML
code and put it in a superclass, what is now Servlet (thus the
module's name).  This is an example of the power of OO programming
(if you get the object model correct!!!) because now someone can use
Servlet directly without the bother of HTML generation.

Sure, you can do all that with functions, too, by building up a
library of functionality in a common module, but then the discussion
becomes functional vs. oo programming.  IMHO, that's a religious war
not suited for this list.  :-)

Cheers,

Daniel Popowich
-----------------------------------------------
http://home.comcast.net/~d.popowich/mpservlets/


From pynode at centrum.cz  Mon Oct  4 16:06:34 2004
From: pynode at centrum.cz (MJR)
Date: Mon Oct  4 10:06:43 2004
Subject: [mod_python] Udate python modules without restarting Apache
Message-ID: <NOEPJMBJNKKPJLAEACANKEHACLAA.pynode@centrum.cz>

Hi,

I'm running mp servlets on Apache server I don't have control over, i.e. I
cannot restart it when I change my .py modules imported by my .mps scripts.

I'm just wondering whether there is any hack for this. How people deal with
it in a production environment.

Thanks,
Mike


From berry.groenendijk at gmail.com  Tue Oct  5 00:03:41 2004
From: berry.groenendijk at gmail.com (berry groenendijk)
Date: Mon Oct  4 17:04:07 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <NOEPJMBJNKKPJLAEACANKEHACLAA.pynode@centrum.cz>
References: <NOEPJMBJNKKPJLAEACANKEHACLAA.pynode@centrum.cz>
Message-ID: <680bcd9504100414037857fc73@mail.gmail.com>

Hi Mike,

I was about to ask the same question! I am building a website using
servlets. But, I still haven't found a hosting provider that supports
mod_python 3.1.3. Can you recommend a hosting provider? Is it
reasonably priced? I also do prefer a hosting provider in Europe, for
example Germany or The Netherlands. Do you know a good hosting
provider in Europe that does support mod_python 3.1.3?

Indeed when I change .py modules in my developement environment, I
need to restart Apache to get the changes to work. So, I was also
wondering how to update .py modules on a server at a hosting provider
that does not allow you to restart the Apache server proces.

Thanks,
Berry


On Mon, 4 Oct 2004 15:06:34 +0100, MJR <pynode@centrum.cz> wrote:
> Hi,
> 
> I'm running mp servlets on Apache server I don't have control over, i.e. I
> cannot restart it when I change my .py modules imported by my .mps scripts.
> 
> I'm just wondering whether there is any hack for this. How people deal with
> it in a production environment.
> 
> Thanks,
> Mike
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From python at dan-olsen.net  Mon Oct  4 16:10:59 2004
From: python at dan-olsen.net (Dan R. Olsen III)
Date: Mon Oct  4 17:31:17 2004
Subject: [mod_python] Installation error
Message-ID: <4161BC63.90203@dan-olsen.net>

After I install mod_python 2.7.10 I get the following error when I try 
to restart Apache:

"Cannot load /web/libexec/mod_python.so into server: 
/web/libexec/mod_python.so: undefined symbol: sem_wait"

Any ideas on how to fix this?

I am using Apache 1.3.31 on Fedora Core 2.
From grahamd at dscpl.com.au  Mon Oct  4 18:22:35 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Mon Oct  4 19:23:07 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <680bcd9504100414037857fc73@mail.gmail.com>
Message-ID: <1096932152.65844@dscpl.com.au>

On Oct 04 23:03, berry groenendijk <berry.groenendijk@gmail.com> wrote:
>
> Subject: Re: [mod_python] Udate python modules without restarting Apache
>
> Indeed when I change .py modules in my developement environment, I
> need to restart Apache to get the changes to work. So, I was also
> wondering how to update .py modules on a server at a hosting provider
> that does not allow you to restart the Apache server proces.
> 
> On Mon, 4 Oct 2004 15:06:34 +0100, MJR <pynode@centrum.cz> wrote:
> > Hi,
> > 
> > I'm running mp servlets on Apache server I don't have control over, i.e. I
> > cannot restart it when I change my .py modules imported by my .mps scripts.
> > 
> > I'm just wondering whether there is any hack for this. How people deal with
> > it in a production environment.

I made a few comments on this at the bottom of a recent message, but I'll
try and cover the choices and some of the issues. One of these days I'll
write a proper little discussion piece about module reloading issues and
put it on my web site. There is a lot to it which isn't obvious nor documented
anywhere. ;-)

The basic problem is that when you use the "import" statement in Python to
bring a module into code executing under Python, if you later what to change
and reinstall that module, about the only thing you can do is to restart Apache.
In an environment where you don't have control over Apache to do that, that
becomes a problem.

The first and quickest thing you can do is a mega hack and may not be a
good thing to do in a production environment, but if you are desperate it
can be a life saver.

What you can do here is to explicitly delete the modules out of sys.modules
and touch all handler code files which import the modules so that they will
get reloaded by mod_python the next time they are accessed. You will need
to ensure that PythonAutoReload is On.

To do this, create a separate directory somewhere which is setup for using
mod_python.publisher. Ie.,

  SetHandler python-program
  PythonHandler mod_python.publisher

In that directory create a file "purge.py" which deletes all the modules
you need to delete. Ie., contains something like:

  def doit():
    try: del sys.modules["HTMLTemplate"]
    except: pass

    try: del sys.modules["vampire"]
    except: pass

    for key in sys.modules.keys():
      if string.find(key,"vampire.") == 0:
        del sys.modules[key]

  modules = sys.modules.keys()
  modules.sort()

  return modules

Then access the page "purge/doit". Note that if Apache is running in prefork
mode, you will have to keep reloading the page until you think you have
managed to invoked the code in all separate forked Apache processes.
Not sure about threaded servers or where separate interpreters are used.

As I said it is a mega hack, but if you are desperate... Be warned that It is
entirely feasible that it may cause everything to stuff up completely. Thus,
if you are talking high volume production site where the pages are being
accessed constantly and you are not the only one with mod_python hosted
code then don't do it. If it is a production web server where your mod_python
code is the only such code and hardly anyone uses it anyway, can be used
with caution.

Note that I would only suggest this be done for code modules which are
specifically intended to be imported as part of your mod_python application.
Ie., don't do it for modules which are used by other mod_python applications.
That way you limit damage to your own stuff and you only have yourself
to blame for the problems. :-)

Moving towards a proper solution, simply don't use "import" at all for your
common code modules in your mod_python application. To achieve this,
you can use mod_python.apache.import_module() method. Thus, instead
of using:

  from mymodules import mymodules

use:

  from mod_python import apache
  module1 = apache.import_module("mymodules.module1")

There are a few issues with the import_module() method though that you
have to be mindful of and you may still have to poke at things a bit to get
it to work.

The first is that even though "mymodules.module1" will now be reloaded,
it will only be done so if this loading of the module is down from inside a
method defined within the content handler and called as part of request
handling.

That is, if you stick this at global scope in your content handler code file,
it will only be called once when the content handler code file is imported.
If you still want it at global scope, you would also need to touch the content
handler code file so that its modification time is updated. That way the
content handler will be reloaded and the module reloaded as well.

Note that the import_module() method will though only reload a module
when the modification time is newer than what it was before. This means
that if you restored an old copy of a module such that its modification time
was actually older, it will not reload. You will need to touch the file to make
its modification time newer.

The next issue is that this is probably useless if "module1" uses "import" to
bring in "modules2" from your "mymodules" directory. That is, any change
to "modules2" will not be reloaded. Thus, any imports amongst your own
modules should also use "import_module()". To find "module2" in this case,
I am not sure if "module1" would need to load it as "mymodules.module2"
or just "module2". I would suggest that "mymodules.module2" would be
preferred and may actually be necessary.

Now if "module2" was imported at global scope in "module1", you end up
with the same problem that even if it is modified it will not be reloaded.
You basically end up with a whole chaining problem and if you do this you
end up still having to touch higher up files in the chain to update the
modification times so that they are reloaded.

So, although extra poking is required in the way of touching some files to
update modification times, you can at least trick mod_python into reloading
things without restarting Apache.

Now, some of the above is based on theory only, so if I am wrong, people
please correct me.

BTW, if you want to see my attempt at an alternate module loading system
which tries to deal with the chaining issue. I have developed a package
for mod_python called Vampire. When used properly, you can change
"module2" and without having to touch the timestamp on any files,
"module1" and any content handlers which use "module1" or "module2"
would be automatically reloaded the next time they are accessed.
Obviously there will be a performance hit with the extra checking, but
if you want maximum flexibility in the way of making changes...

Version 1.0 of Vampire, lacking any documentation on the module loading
system, can be found at:

  http://www.dscpl.com.au/projects/vampire

I have the code for Vampire 1.1 ready, which adds more nice features, but
am still fiddling with the slightly better documentation and examples. I have
not tried integrating it with mpservlets yet, but 1.1 does show at a high level
how it can be used in conjunction with psp. Note that it doesn't try and address
some of the chaining issues of making changes in psp code itself though.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From gdamjan at mail.net.mk  Tue Oct  5 03:11:53 2004
From: gdamjan at mail.net.mk (Damjan)
Date: Mon Oct  4 20:11:57 2004
Subject: [mod_python] Compiling mod_python on Linux/apache with LFS
Message-ID: <20041005001153.GA20615@legolas.on.net.mk>

I've recenlty been compiling mod_python on Slackware Linux against an
Apache2 (2.0.52) compiled with large file support (LFS).

Apache2 was compiled with these flags:
CPPFLAGS="-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64"

unfortunately mod_python's build system doesn't honor this environment
variable, so I had to hack it directly in src/Makefile, 
after ./configure finished.

If anyone had a problem when apache would segfault for any request
(even for static files) after mod_python was installed whis is most
probably the reason.


-- 
damjan | ??????
This is my jabber ID --> damjan@bagra.net.mk <-- not my mail address!!!
From elim at elinkage.net  Mon Oct  4 21:08:15 2004
From: elim at elinkage.net (Elim Qiu)
Date: Mon Oct  4 22:08:08 2004
Subject: [mod_python] How to setup generic python handler 
References: <20041005001153.GA20615@legolas.on.net.mk>
Message-ID: <001001c4aa80$2d131e60$0102a8c0@joy>

My apache related installation is summarized as
 
Apache/2.0.51 (Win32) mod_ssl/2.0.51 OpenSSL/0.9.7d mod_python/3.1.3 Python/2.3.4 PHP/4.3.9 

and I get mptest.py print out 'Hello World' ok. But I don't have any instruction telling me how to move
forward to complete the mod_python setup. Obviously in apache's configuration file
httpd.conf, I have to replace the lines
        AddHandler mod_python .py
        PythonHandler mptest
        PythonDebug On
With some really useful ones. But what are they? Thanks for any helps.

  ----- Original Message ----- 
  From: Damjan 
  To: mod_python@modpython.org 
  Sent: Monday, October 04, 2004 6:11 PM
  Subject: [mod_python] Compiling mod_python on Linux/apache with LFS


  I've recenlty been compiling mod_python on Slackware Linux against an
  Apache2 (2.0.52) compiled with large file support (LFS).

  Apache2 was compiled with these flags:
  CPPFLAGS="-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64"

  unfortunately mod_python's build system doesn't honor this environment
  variable, so I had to hack it directly in src/Makefile, 
  after ./configure finished.

  If anyone had a problem when apache would segfault for any request
  (even for static files) after mod_python was installed whis is most
  probably the reason.


  -- 
  damjan | ??????
  This is my jabber ID --> damjan@bagra.net.mk <-- not my mail address!!!
  _______________________________________________
  Mod_python mailing list
  Mod_python@modpython.org
  http://mailman.modpython.org/mailman/listinfo/mod_python
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://modpython.org/pipermail/mod_python/attachments/20041004/db122eb3/attachment.html
From Administrator at leebrown.org  Tue Oct  5 01:05:37 2004
From: Administrator at leebrown.org (Lee E. Brown)
Date: Tue Oct  5 00:05:58 2004
Subject: [mod_python] How to setup generic python handler 
References: <20041005001153.GA20615@legolas.on.net.mk>
	<001001c4aa80$2d131e60$0102a8c0@joy>
Message-ID: <000b01c4aa90$9252f7e0$0200a8c0@UberBox>

Mod Python come with three "prepackaged" handlers that you can use to get 
started: the Publisher handler, the PSP handler, and the CGI handler.  Go to 
the Mod Python web site and download the PDF file of the Mod Python 
documentation; you'll find examples of how to use all three.

----- Original Message ----- 
From: Elim Qiu
To: mod_python@modpython.org
Sent: Monday, October 04, 2004 10:08 PM
Subject: [mod_python] How to setup generic python handler


My apache related installation is summarized as

Apache/2.0.51 (Win32) mod_ssl/2.0.51 OpenSSL/0.9.7d mod_python/3.1.3 
Python/2.3.4 PHP/4.3.9

and I get mptest.py print out 'Hello World' ok. But I don't have any 
instruction telling me how to move
forward to complete the mod_python setup. Obviously in apache's 
configuration file
httpd.conf, I have to replace the lines
        AddHandler mod_python .py
        PythonHandler mptest
        PythonDebug On
With some really useful ones. But what are they? Thanks for any helps.


From davidf at sjsoft.com  Tue Oct  5 08:39:27 2004
From: davidf at sjsoft.com (David Fraser)
Date: Tue Oct  5 01:39:32 2004
Subject: [mod_python] Installation error
In-Reply-To: <4161BC63.90203@dan-olsen.net>
References: <4161BC63.90203@dan-olsen.net>
Message-ID: <4162338F.6080507@sjsoft.com>

Dan R. Olsen III wrote:

> After I install mod_python 2.7.10 I get the following error when I try 
> to restart Apache:
>
> "Cannot load /web/libexec/mod_python.so into server: 
> /web/libexec/mod_python.so: undefined symbol: sem_wait"
>
> Any ideas on how to fix this?
>
> I am using Apache 1.3.31 on Fedora Core 2. 

Not sure what the problem is, but some more information would be helpful:

Fedora Core 2 uses Apache 2.x by default, so where did you get Apache 
1.3.31 and mod_python 2.7.10? Are they from rpms, if so from which ones? 
Or another binary source? Or did you compile them yourself?

David
From sorr at rightnow.com  Tue Oct  5 13:08:28 2004
From: sorr at rightnow.com (Orr, Steve)
Date: Tue Oct  5 14:08:33 2004
Subject: [mod_python] Processing Apache Logs
Message-ID: <D30BE1A2F9109A43BA989E2F51684056062CA3B2@pobox.corp.rightnow.com>

The ONLamp "Introducing mod_python" article mentions the possibility of
doing custom Apache logging with mod_python and inserting log data
directly to a database. Are there any examples of this or has anyone on
this list done such a thing? Any guidance or suggestions?

I'm looking at building a data warehouse from the Apache log output. The
web apps on the load balanced web servers to be monitored do not use any
Python code. Are there 3rd party (non-Pythonic perhaps) log parser apps
I should look at instead of cutting my own mod_python code? 


AtDhVaAnNkCsE,
D. B. Dweeb

From python at dan-olsen.net  Tue Oct  5 13:15:06 2004
From: python at dan-olsen.net (Dan R. Olsen III)
Date: Tue Oct  5 14:22:53 2004
Subject: [mod_python] Installation error
In-Reply-To: <4162338F.6080507@sjsoft.com>
References: <4161BC63.90203@dan-olsen.net> <4162338F.6080507@sjsoft.com>
Message-ID: <4162E4AA.6060906@dan-olsen.net>

My boss likes to install the web server to it's own folder and prefers 
Apache 1.3.31. I compiled Apache and mod_python myself.

Dan

David Fraser wrote:

> Dan R. Olsen III wrote:
>
>> After I install mod_python 2.7.10 I get the following error when I 
>> try to restart Apache:
>>
>> "Cannot load /web/libexec/mod_python.so into server: 
>> /web/libexec/mod_python.so: undefined symbol: sem_wait"
>>
>> Any ideas on how to fix this?
>>
>> I am using Apache 1.3.31 on Fedora Core 2. 
>
>
> Not sure what the problem is, but some more information would be helpful:
>
> Fedora Core 2 uses Apache 2.x by default, so where did you get Apache 
> 1.3.31 and mod_python 2.7.10? Are they from rpms, if so from which 
> ones? Or another binary source? Or did you compile them yourself?
>
> David

From thomas.ryan at earthlink.net  Tue Oct  5 16:33:45 2004
From: thomas.ryan at earthlink.net (Thomas Ryan)
Date: Tue Oct  5 18:31:04 2004
Subject: [mod_python] ImportError: No module named mptest
Message-ID: <001601c4ab2b$607a0790$6501a8c0@TRyan>

I had the same configuration Apache <-> mod_python problem as a number of
folks out here.
I had to dig longer than was reasonable to deduce the simple answer. Maybe I
didn't look in the right places.

So, with respect to some earlier posts, yes, Patrick the manual is helpful -
I'll try to be more helpful -
>
> Patrick Percot ppercot at free.fr
> Fri Jun 25 18:45:48 EDT 2004
>   I will answer all your questions by the famous RTFM :)
>
>   And the f... manual is here :
>
>         http://modpython.org/live/current/doc-html/tut-what-it-do.html
>
>
> [....deleted..]
> Mod_python error: "PythonHandler mptest"
>
> Traceback (most recent call last):
>
>   File "/usr/lib/python2.3/site-packages/mod_python/apache.py", line 181,
in Dispatch
>     module = import_module(module_name, _req)
>
>   File "/usr/lib/python2.3/site-packages/mod_python/apache.py", line 332,
in import_module
>     f, p, d = imp.find_module(parts[i], path)
>
>
> ImportError: No module named mptest
>

Unfortunately, the mod_python manual doesn't bother to mention the need to
also extend PYTHONPATH.
This is probably obvious to Python experts.

For those of you who someday google this, and who have RTFM, but are still
stuck with the "mptest module not found" import errors, try adding something
like the  following to the <Directory> entry in your Apache config file:
<Directory>
   ....
    AddHandler mod_python .py
    PythonPath "['C:/Program Files/Apache Group/Apache2/htdocs']+sys.path"
    PythonHandler mptest
    PythonDebug ON
</Directory>

And stick the sample mptest.py in the htdocs directory referred to above.

FWIW This is a Windows 2000 installation - Apache 2.0.5, mod_python 3.1.3
For this configuration, Apache generated errors in the system event log
complaining about too many <Directory> entries.
The manual glossed over this little tidbit too, but there's a simple fix:
add the mod_python stuff after the first <Directory> tag; don't make new
ones.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://modpython.org/pipermail/mod_python/attachments/20041005/31ad1bb5/attachment.html
From grahamd at dscpl.com.au  Tue Oct  5 17:34:00 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct  5 18:34:03 2004
Subject: [mod_python] Setting PythonOption to an empty string.
In-Reply-To: <41627736.5000802@rawkin.net>
Message-ID: <1097015635.67218@dscpl.com.au>

On Oct 05 06:28, Rich McDonough <rich.mcdonough@rawkin.net> wrote:
>
> Subject: Re: [mod_python] Setting PythonOption to an empty string.
>
> For the sub-directory you will need a directive that states:
> 
> SetHandler None
> 
> Graham Dumpleton wrote:
> > I might be missing something, but I want to be able to set a 
> > PythonOption variable
> > to be an empty string. Alternatively, is there a way in the .htaccess 
> > file to unset
> > a PythonOption variable which has been inherited from a parent directory?
> > 
> > When I try and set the variable to an empty string. Ie.,
> > 
> >   PythonOption Name ""

In my haste last night, I managed to reply only to the responder and not the
whole list, so here we go again, but with more detail this time. In short,
the above response isn't what I am asking about. I am not wanting to disable
mod_python in the subdirectory, only wipe out the value of the PythonOption
option setting. Hmmm, now I see why it didn't go to the list, the sender
didn't send it there, but only to me. Anyway, hope this email explains it
better.

Consider the following .htaccess file and content handler.

# .htaccess

  AddHandler python-program .py
  PythonHandler vartest
  PythonDebug On
  PythonOption NAME VALUE1

# vartest.py

  from mod_python import apache

  def handler(req):
    req.content_type = "text/plain"
    req.send_http_header()
    req.write("FILENAME = "+req.filename+"\n")
    req.write("PATH_INFO = "+req.path_info+"\n")
    req.write("NAME = "+req.get_options().get("NAME","UNDEFINED")+"\n")
    return apache.OK

When I request a .py file in that specific directory, I get:

  FILENAME = /Users/grahamd/Sites/modpython/dummy.py
  PATH_INFO = 
  NAME = VALUE1

Now create a subdirectory with another .htaccess file.

# subdir/.htaccess

  PythonOption NAME VALUE2

When I request a .py file out of the subdirectory, I get:

  FILENAME = /Users/grahamd/Sites/modpython/subdir/dummy.py
  PATH_INFO = 
  NAME = VALUE2

In other words, the AddHandler/PythonHandler from the parent directory
still dictate that mod_python be used, but the PythonOption setting from
the subdirectory overrides that from the parent when the path being accessed
falls within the subdirectory.

Now, if the setting of NAME in the subdirectory .htaccess is commented out
and the subdirectory request done again, I get:

  FILENAME = /Users/grahamd/Sites/modpython/subdir/dummy.py
  PATH_INFO = 
  NAME = VALUE1

Thus you can see that the setting of NAME in the parent directory is inherited
by a subdirectory if it isn't overridden.

The problem now is that once a parent sets a value using PythonOption, the
only thing one can do in a subdirectory is to override it with some other non
empty value. This is because the following results in a internal server error.

  PythonOption NAME ""

I have tried other variations on this, but can't find any that allow me to set the
value to an empty string. I can't see any evidence that one can totally unset a
value either. If there is no valid non empty value that you can use for a value
to effectively say its value should be ignored, you are stuffed. Luckily in my
case it was reasonable to say that if the value was set to "." that the code relying
on it default back to standard behaviour.

Note that even if "vartest.py" was outside of the document tree and the subdir
used AddHandler/PythonHandler again, it doesn't start a new context for options
and NAME is still inherited from the parent.

Even if this did work, it isn't want I wanted as it has other implications such as
the path of both the parent and subdirectory being put in "sys.path". In some
cases it is problematic enough that the document directory is put in "sys.path" at
all, but you can't get around this though when the content handler is in the actual
document tree. Luckily, if the module is somewhere else outside the document
tree and on your normal Python path, you can at least say:

  PythonPath 'sys.path'

This has the affect of leaving sys.path how it was before that directory was
encountered, which is much safer to my mind, but then you need a module loader
where you can say exactly which directory you want a module pulled from as
"import" ain't going to and possibly not "import_module()" either.

Enough rambling.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From grahamd at dscpl.com.au  Tue Oct  5 17:47:56 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct  5 18:47:59 2004
Subject: [mod_python] ImportError: No module named mptest
In-Reply-To: <001601c4ab2b$607a0790$6501a8c0@TRyan>
Message-ID: <1097016473.68593@dscpl.com.au>

On Oct 05 15:33, "Thomas Ryan" <thomas.ryan@earthlink.net> wrote:
> Unfortunately, the mod_python manual doesn't bother to mention the need to
> also extend PYTHONPATH.
> This is probably obvious to Python experts.
> 
> For those of you who someday google this, and who have RTFM, but are still
> stuck with the "mptest module not found" import errors, try adding something
> like the  following to the <Directory> entry in your Apache config file:
> <Directory>
>    ....
>     AddHandler mod_python .py
>     PythonPath "['C:/Program Files/Apache Group/Apache2/htdocs']+sys.path"
>     PythonHandler mptest
>     PythonDebug ON
> </Directory>
> 
> And stick the sample mptest.py in the htdocs directory referred to above.
> 
> FWIW This is a Windows 2000 installation - Apache 2.0.5, mod_python 3.1.3
> For this configuration, Apache generated errors in the system event log
> complaining about too many <Directory> entries.
> The manual glossed over this little tidbit too, but there's a simple fix:
> add the mod_python stuff after the first <Directory> tag; don't make new
> ones.

If the mptest.py file is placed in the directory that mod_python is enabled for,
it should not be necessary to extend the Python path.

If your cut and paste is accurate, the issue may be that your <Directory>
specification doesn't actually mention a directory. The example in the documentation
has:

  <Directory /some/directory/htdocs/test>
        AddHandler mod_python .py
        PythonHandler mptest
        PythonDebug On
    </Directory>

See how a directory is listed inside <Directory> opening.

Change your definition to (or whatever is appropriate for path defintions on Win32):

  <Directory C:/Program Files/Apache Group/Apache2/htdocs>
     ....
     AddHandler mod_python .py
     PythonHandler mptest
     PythonDebug ON
 </Directory>

Alternatively, don't do it in the httpd.conf file, instead create a .htaccess file
in the htdocs directory containing.

     AddHandler mod_python .py
     PythonHandler mptest
     PythonDebug ON
 
--
Graham Dumpleton (grahamd@dscpl.com.au)
From grisha at modpython.org  Tue Oct  5 23:57:33 2004
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Tue Oct  5 22:57:42 2004
Subject: [mod_python] Setting PythonOption to an empty string.
In-Reply-To: <1097015635.67218@dscpl.com.au>
References: <1097015635.67218@dscpl.com.au>
Message-ID: <20041005225455.H53463@onyx.ispol.com>



On Tue, 5 Oct 2004, Graham Dumpleton wrote:

> The problem now is that once a parent sets a value using PythonOption, the
> only thing one can do in a subdirectory is to override it with some other non
> empty value. This is because the following results in a internal server error.
>
>  PythonOption NAME ""
>

This looks like a bug to me and I added it to the (growing) TODO list.

The only thing I can think of as a workaround is to use some special 
non-blank value which your code would treat as a no-value.

Thanks for reporting this,

Grisha
From johannes at erdfelt.com  Tue Oct  5 22:49:58 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Wed Oct  6 00:50:03 2004
Subject: [mod_python] Setting PythonOption to an empty string.
In-Reply-To: <20041005225455.H53463@onyx.ispol.com>
References: <1097015635.67218@dscpl.com.au>
	<20041005225455.H53463@onyx.ispol.com>
Message-ID: <20041006044958.GY14882@sventech.com>

On Tue, Oct 05, 2004, Gregory (Grisha) Trubetskoy <grisha@modpython.org> wrote:
> 
> On Tue, 5 Oct 2004, Graham Dumpleton wrote:
> 
> >The problem now is that once a parent sets a value using PythonOption, the
> >only thing one can do in a subdirectory is to override it with some other 
> >non
> >empty value. This is because the following results in a internal server 
> >error.
> >
> > PythonOption NAME ""
> 
> This looks like a bug to me and I added it to the (growing) TODO list.
> 
> The only thing I can think of as a workaround is to use some special 
> non-blank value which your code would treat as a no-value.

Is the TODO list in CVS? I don't see anything.

JE

From JSmuts at clover.co.za  Wed Oct  6 09:55:03 2004
From: JSmuts at clover.co.za (Jaco Smuts)
Date: Wed Oct  6 02:55:04 2004
Subject: [mod_python] Processing Apache Logs
In-Reply-To: <D30BE1A2F9109A43BA989E2F51684056062CA3B2@pobox.corp.rightnow.com>
Message-ID: <OF9E796787.4692608D-ON42256F25.0025E90E-42256F25.0025FFC5@clover.co.za>

Have you  looked at mod_sql ?

jaco





"Orr, Steve" <sorr@rightnow.com> 
Sent by: mod_python-bounces@modpython.org
10/05/2004 08:08 PM

To
"mod_python user mailing list" <mod_python@modpython.org>
cc

Subject
[mod_python] Processing Apache Logs






The ONLamp "Introducing mod_python" article mentions the possibility of
doing custom Apache logging with mod_python and inserting log data
directly to a database. Are there any examples of this or has anyone on
this list done such a thing? Any guidance or suggestions?

I'm looking at building a data warehouse from the Apache log output. The
web apps on the load balanced web servers to be monitored do not use any
Python code. Are there 3rd party (non-Pythonic perhaps) log parser apps
I should look at instead of cutting my own mod_python code? 


AtDhVaAnNkCsE,
D. B. Dweeb

_______________________________________________
Mod_python mailing list
Mod_python@modpython.org
http://mailman.modpython.org/mailman/listinfo/mod_python

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://modpython.org/pipermail/mod_python/attachments/20041006/ef8c2cb2/attachment-0001.html
From sorr at rightnow.com  Wed Oct  6 09:27:43 2004
From: sorr at rightnow.com (Orr, Steve)
Date: Wed Oct  6 10:27:47 2004
Subject: [mod_python] Processing Apache Logs
Message-ID: <D30BE1A2F9109A43BA989E2F51684056062CA3B3@pobox.corp.rightnow.com>

Yes, we're actually using it in a limited way. It's pretty good but our
data warehouse needs to be in Oracle. Currently we use mod_sql to
capture the data into MySQL then copy subsets of data to Oracle. 
 
I was looking at mod_python's access to the Apache internals and it
looks like the various attributes (members) of the request, connection,
and server objects would contain everything needed to capture the Apache
log data (and more?) so I'm thinking the PythonLogHandler could be used
to get this data and put it into a database as mentioned in the ONLamp
Python DevCenter article,
(http://www.onlamp.com/pub/a/python/2003/10/02/mod_python.html). 
 
Quote:

	"Mod_python provides the ability to register for any phase and
write the processing function in Python. This is a very powerful
feature, because it opens the door for many innovative and exciting ways
to use Apache. For example, you can write Python code to do
authentication processing or custom logging (perhaps sending logs to a
database while maintaining real-time statistics)."

This is all new to me and I need an example to get started with the
PythonLogHandler. So... it would be nice to have a quick and dirty
example to backup the claim in the article.  :-)
 
 
With admiration for the mod_python project,
D. B. Dweeb, AKA Steve Orr
 
 

	-----Original Message-----
	From: Jaco Smuts [mailto:JSmuts@clover.co.za] 
	Sent: Wednesday, October 06, 2004 12:55 AM
	To: Orr, Steve
	Cc: mod_python user mailing list;
mod_python-bounces@modpython.org
	Subject: Re: [mod_python] Processing Apache Logs
	
	

	Have you  looked at mod_sql ? 
	
	jaco 
	
	
	
	
	
"Orr, Steve" <sorr@rightnow.com> 
Sent by: mod_python-bounces@modpython.org 

10/05/2004 08:08 PM 

To
"mod_python user mailing list" <mod_python@modpython.org> 
cc
Subject
[mod_python] Processing Apache Logs

	




	The ONLamp "Introducing mod_python" article mentions the
possibility of
	doing custom Apache logging with mod_python and inserting log
data
	directly to a database. Are there any examples of this or has
anyone on
	this list done such a thing? Any guidance or suggestions?
	
	I'm looking at building a data warehouse from the Apache log
output. The
	web apps on the load balanced web servers to be monitored do not
use any
	Python code. Are there 3rd party (non-Pythonic perhaps) log
parser apps
	I should look at instead of cutting my own mod_python code? 
	
	
	AtDhVaAnNkCsE,
	D. B. Dweeb
	
	_______________________________________________
	Mod_python mailing list
	Mod_python@modpython.org
	http://mailman.modpython.org/mailman/listinfo/mod_python
	
	

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://modpython.org/pipermail/mod_python/attachments/20041006/c7bf32e2/attachment.html
From tandrews at grok.co.za  Wed Oct  6 20:53:19 2004
From: tandrews at grok.co.za (Thomas Andrews)
Date: Wed Oct  6 13:53:28 2004
Subject: [mod_python] Forcing a confirmation page after authentication
Message-ID: <20041006175319.GJ17285@gaspode.nextlink.co.za>

I'm sorry if this is a totally obvious one - I'm new to Apache & mod_python.

How do I make a page come up *every* time a visitor has been
authenticated, irrespective of what page they request ? I want to force
them to confirm some data just after they have authenticated. After that
I want them to browse the existing html pages unhindered.

I'm already using PythonAuthenHandler so that I can do the
authentication myself and that's working, but I just don't know how to
feed into my next page from there because that handler doesn't expect me
to print anything out to the browser - it just wants to see a
return-code (as I understand it.)

There are these other handlers:

            * PythonPostReadRequestHandler
            * PythonTransHandler
            * PythonHeaderParserHandler
            * PythonAccessHandler
            * PythonTypeHandler
            * PythonFixupHandler
            * PythonHandler
            * PythonInitHandler
            * PythonLogHandler
            * PythonCleanupHandler

 ... but none of them seem to do what I need. (or did I miss something?)

Thanks for the help,
Thomas
From grisha at modpython.org  Wed Oct  6 16:10:48 2004
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Wed Oct  6 15:10:53 2004
Subject: [mod_python] Setting PythonOption to an empty string.
In-Reply-To: <20041006044958.GY14882@sventech.com>
References: <1097015635.67218@dscpl.com.au>
	<20041005225455.H53463@onyx.ispol.com>
	<20041006044958.GY14882@sventech.com>
Message-ID: <20041006151010.M66193@onyx.ispol.com>


No, it's in my INBOX :-)

On Tue, 5 Oct 2004, Johannes Erdfelt wrote:

> Is the TODO list in CVS? I don't see anything.
From itodd at itodd.org  Wed Oct  6 16:16:25 2004
From: itodd at itodd.org (Todd Boland)
Date: Wed Oct  6 15:17:04 2004
Subject: [mod_python] Forcing a confirmation page after authentication
In-Reply-To: <20041006175319.GJ17285@gaspode.nextlink.co.za>
References: <20041006175319.GJ17285@gaspode.nextlink.co.za>
Message-ID: <376098AE-17CC-11D9-8241-000A95CCEA34@itodd.org>

What I would recommend is an internal redirect after authentication. 
Only redirect if they have not seen the message. in the handler that 
displays the message which you internally redirected to, you could set 
a cookie to indicate they've seen the message and add the link "<a 
href=%s>continue</a>" % req.prev.unparsed_uri so they don't have to 
re-navigate to the page they originally requested.

I hope I helped more than I confused you.

Todd



On Oct 6, 2004, at 1:53 PM, Thomas Andrews wrote:

> I'm sorry if this is a totally obvious one - I'm new to Apache & 
> mod_python.
>
> How do I make a page come up *every* time a visitor has been
> authenticated, irrespective of what page they request ? I want to force
> them to confirm some data just after they have authenticated. After 
> that
> I want them to browse the existing html pages unhindered.
>
> I'm already using PythonAuthenHandler so that I can do the
> authentication myself and that's working, but I just don't know how to
> feed into my next page from there because that handler doesn't expect 
> me
> to print anything out to the browser - it just wants to see a
> return-code (as I understand it.)
>
> There are these other handlers:
>
>             * PythonPostReadRequestHandler
>             * PythonTransHandler
>             * PythonHeaderParserHandler
>             * PythonAccessHandler
>             * PythonTypeHandler
>             * PythonFixupHandler
>             * PythonHandler
>             * PythonInitHandler
>             * PythonLogHandler
>             * PythonCleanupHandler
>
>  ... but none of them seem to do what I need. (or did I miss 
> something?)
>
> Thanks for the help,
> Thomas
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>

From itodd at itodd.org  Wed Oct  6 16:27:00 2004
From: itodd at itodd.org (Todd Boland)
Date: Wed Oct  6 15:27:07 2004
Subject: [mod_python] Forcing a confirmation page after authentication
In-Reply-To: <376098AE-17CC-11D9-8241-000A95CCEA34@itodd.org>
References: <20041006175319.GJ17285@gaspode.nextlink.co.za>
	<376098AE-17CC-11D9-8241-000A95CCEA34@itodd.org>
Message-ID: <B1A23998-17CD-11D9-8241-000A95CCEA34@itodd.org>

I forgot to mention that internal_redirect is a method of the req 
object.

On Oct 6, 2004, at 3:16 PM, Todd Boland wrote:

> What I would recommend is an internal redirect after authentication. 
> Only redirect if they have not seen the message. in the handler that 
> displays the message which you internally redirected to, you could set 
> a cookie to indicate they've seen the message and add the link "<a 
> href=%s>continue</a>" % req.prev.unparsed_uri so they don't have to 
> re-navigate to the page they originally requested.
>
> I hope I helped more than I confused you.
>
> Todd
>
>
>
> On Oct 6, 2004, at 1:53 PM, Thomas Andrews wrote:
>
>> I'm sorry if this is a totally obvious one - I'm new to Apache & 
>> mod_python.
>>
>> How do I make a page come up *every* time a visitor has been
>> authenticated, irrespective of what page they request ? I want to 
>> force
>> them to confirm some data just after they have authenticated. After 
>> that
>> I want them to browse the existing html pages unhindered.
>>
>> I'm already using PythonAuthenHandler so that I can do the
>> authentication myself and that's working, but I just don't know how to
>> feed into my next page from there because that handler doesn't expect 
>> me
>> to print anything out to the browser - it just wants to see a
>> return-code (as I understand it.)
>>
>> There are these other handlers:
>>
>>             * PythonPostReadRequestHandler
>>             * PythonTransHandler
>>             * PythonHeaderParserHandler
>>             * PythonAccessHandler
>>             * PythonTypeHandler
>>             * PythonFixupHandler
>>             * PythonHandler
>>             * PythonInitHandler
>>             * PythonLogHandler
>>             * PythonCleanupHandler
>>
>>  ... but none of them seem to do what I need. (or did I miss 
>> something?)
>>
>> Thanks for the help,
>> Thomas
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>

From sorr at rightnow.com  Wed Oct  6 18:18:33 2004
From: sorr at rightnow.com (Orr, Steve)
Date: Wed Oct  6 19:18:38 2004
Subject: [mod_python] Processing Apache Logs
Message-ID: <D30BE1A2F9109A43BA989E2F51684056062CA3BA@pobox.corp.rightnow.com>

OK, I got some custom logging to a database working and I can pretty
much capture anything generated by "normal" Apache logging except... I
don't see any equivalent to the Apache directive like LogFormat "%T %D"
where %T and %D are the respective times to serve the HTTP requests in
seconds and microseconds.
 
Is there any reason the PythonLogHandler doesn't pick this up from the
Apache logging phase? Am I stuck because there's "no way to get there
from here?"
 
Please advise and TIA! TIA! TIA! ...
D. B. Dweeb
 
 

	-----Original Message-----
	From: mod_python-bounces@modpython.org
[mailto:mod_python-bounces@modpython.org] On Behalf Of Orr, Steve
	Sent: Wednesday, October 06, 2004 8:28 AM
	To: Jaco Smuts
	Cc: mod_python user mailing list
	Subject: RE: [mod_python] Processing Apache Logs
	
	
	Yes, we're actually using it in a limited way. It's pretty good
but our data warehouse needs to be in Oracle. Currently we use mod_sql
to capture the data into MySQL then copy subsets of data to Oracle. 
	 
	I was looking at mod_python's access to the Apache internals and
it looks like the various attributes (members) of the request,
connection, and server objects would contain everything needed to
capture the Apache log data (and more?) so I'm thinking the
PythonLogHandler could be used to get this data and put it into a
database as mentioned in the ONLamp Python DevCenter article,
(http://www.onlamp.com/pub/a/python/2003/10/02/mod_python.html). 
	 
	Quote:

		"Mod_python provides the ability to register for any
phase and write the processing function in Python. This is a very
powerful feature, because it opens the door for many innovative and
exciting ways to use Apache. For example, you can write Python code to
do authentication processing or custom logging (perhaps sending logs to
a database while maintaining real-time statistics)."

	This is all new to me and I need an example to get started with
the PythonLogHandler. So... it would be nice to have a quick and dirty
example to backup the claim in the article.  :-)
	 
	 
	With admiration for the mod_python project,
	D. B. Dweeb, AKA Steve Orr
	 
	 

		-----Original Message-----
		From: Jaco Smuts [mailto:JSmuts@clover.co.za] 
		Sent: Wednesday, October 06, 2004 12:55 AM
		To: Orr, Steve
		Cc: mod_python user mailing list;
mod_python-bounces@modpython.org
		Subject: Re: [mod_python] Processing Apache Logs
		
		

		Have you  looked at mod_sql ? 
		
		jaco 
		
		
		
		
		
"Orr, Steve" <sorr@rightnow.com> 
Sent by: mod_python-bounces@modpython.org 

10/05/2004 08:08 PM 

To
"mod_python user mailing list" <mod_python@modpython.org> 
cc
Subject
[mod_python] Processing Apache Logs	

		




		The ONLamp "Introducing mod_python" article mentions the
possibility of
		doing custom Apache logging with mod_python and
inserting log data
		directly to a database. Are there any examples of this
or has anyone on
		this list done such a thing? Any guidance or
suggestions?
		
		I'm looking at building a data warehouse from the Apache
log output. The
		web apps on the load balanced web servers to be
monitored do not use any
		Python code. Are there 3rd party (non-Pythonic perhaps)
log parser apps
		I should look at instead of cutting my own mod_python
code? 
		
		
		AtDhVaAnNkCsE,
		D. B. Dweeb
		
		_______________________________________________
		Mod_python mailing list
		Mod_python@modpython.org
		http://mailman.modpython.org/mailman/listinfo/mod_python
		
		

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://modpython.org/pipermail/mod_python/attachments/20041006/763a3e22/attachment.html
From grahamd at dscpl.com.au  Thu Oct  7 00:04:01 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct  7 01:04:03 2004
Subject: [mod_python] 3.X equivalent of 2.X req.get_dirs()
Message-ID: <1097125440.87889@dscpl.com.au>

Todays hard question. :-)

Is there an equivalent in mod_python 3.X to the req.get_dirs() method
that appears in mod_python 2.X? Ie., in 2.X it would for example return:

{'PythonHandler': '/usr/local/etc/httpd/htdocs/projects/vampire/',
 'PythonDebug': '/usr/local/etc/httpd/htdocs/projects/vampire/'}

That is, the directory in the hierarchy where the Apache directives such
as PythonHandler were defined.

Previously I asked about a way to more or less determine exactly this.
That is, the directory in the hierarchy where PythonHandler was defined
for the currently active content handler.

When I asked that time, the only solution proposed was to use sys.path
by looking at the first entry in it. It actually had to be a bit smarter
than that, as sys.path could be modified by other things and so one
had to look for the directory in sys.path which was the longest match
for the start of req.filename.

The problem with using sys.path for what I was doing is that if PythonPath
is set explicitly as a directive, the directory in the document hierarchy may
not end up being put in sys.path.

The req.get_dirs() method turns out instead to be exactly what I wanted
in the first place, but it dissappeared in 3.X. Is there some way of getting
the same information in 3.X?

Other possibilities for doing what I want are to require that the directive
PythonInterpPerDirective be specified in the same spot as the directive
for PythonHandler. In 3.X you can then at least use req.interpreter, which
for this option will then be set to the directory where PythonHandler was
set.

Under 2.X there is no req.interpreter or equivalent that I could find,
although one can still use req.get_dirs() in that case to see where it
was that either PythonHandler or PythonInterPerDirective was set.

The only issue for what I want is that if someone uses PythonInterpreter
to override the interpreter name, it will no longer be the directory where
the PythonHandler was set.

Anyone else got any thoughts on an equivalent to req.get_dirs() in 3.X?
I haven't dug into the 3.X code base enough to see how this stores it,
but it doesn't look as simple any more and certainly doesn't seem to be
able to be queried.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From grahamd at dscpl.com.au  Thu Oct  7 00:26:08 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct  7 01:26:10 2004
Subject: [mod_python] 3.X equivalent of 2.X req.get_dirs()
In-Reply-To: <1097125440.87889@dscpl.com.au>
Message-ID: <1097126764.90466@dscpl.com.au>

On Oct 06 23:04, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>
> Subject: [mod_python] 3.X equivalent of 2.X req.get_dirs()
>
> Todays hard question. :-)
> 
> Is there an equivalent in mod_python 3.X to the req.get_dirs() method
> that appears in mod_python 2.X? Ie., in 2.X it would for example return:
> 
> {'PythonHandler': '/usr/local/etc/httpd/htdocs/projects/vampire/',
>  'PythonDebug': '/usr/local/etc/httpd/htdocs/projects/vampire/'}
> 
> That is, the directory in the hierarchy where the Apache directives such
> as PythonHandler were defined.
> 
> Previously I asked about a way to more or less determine exactly this.
> That is, the directory in the hierarchy where PythonHandler was defined
> for the currently active content handler.

Ahhh, not five minutes after I send this email, having sat on the email
for most of the day, I found what I wanted. One can use req.hlist to get
the name of the directory where the handler is defined. It doesn't seem to
be documented as a user type feature, but returns something like:

  {'handler:'vampire','directory':'/Users/grahamd/Sites/vampire/','silent':1}

It is the value for "directory" that I want.

How about a future version of mod_python formalising a sanctioned way
of users getting access to information about handlers and the directory
level they were defined at?

No to see if this really solves my problem. :-)

--
Graham Dumpleton (grahamd@dscpl.com.au)
From tandrews at grok.co.za  Thu Oct  7 12:55:13 2004
From: tandrews at grok.co.za (Thomas Andrews)
Date: Thu Oct  7 05:55:26 2004
Subject: [mod_python] Redirection from within a handler
Message-ID: <53650.196.15.149.114.1097142913.squirrel@mail.grok.co.za>

Again sorry if this is a totally dumb question.

How does one force a redirect from a handler like
PythonHeaderParserHandler ? I have (working) lines like this:
    req.headers_out.add('Location','http://www.cnn.com')
but that just adds to the header. I can't find a method similar to the
"add" suitable to my needs.

I want to do it from inside a handler because it's a conditional thing -
ie not always redirected, so I can't use httpd.conf

Many thanks,
Thomas

From davidf at sjsoft.com  Thu Oct  7 13:27:44 2004
From: davidf at sjsoft.com (David Fraser)
Date: Thu Oct  7 06:27:54 2004
Subject: [mod_python] TODO (was: Setting PythonOption to an empty string)
In-Reply-To: <20041006151010.M66193@onyx.ispol.com>
References: <1097015635.67218@dscpl.com.au>	<20041005225455.H53463@onyx.ispol.com>	<20041006044958.GY14882@sventech.com>
	<20041006151010.M66193@onyx.ispol.com>
Message-ID: <41651A20.1000202@sjsoft.com>

Hi Grisha

I wonder whether it would help alot to put the TODO file in CVS.
That way you wouldn't be stuck with all the tasks yourself, others could 
do them and submit patches for you to review.
What do you think?

David

Gregory (Grisha) Trubetskoy wrote:

>
> No, it's in my INBOX :-)
>
> On Tue, 5 Oct 2004, Johannes Erdfelt wrote:
>
>> Is the TODO list in CVS? I don't see anything.
>

From davidf at sjsoft.com  Thu Oct  7 13:29:09 2004
From: davidf at sjsoft.com (David Fraser)
Date: Thu Oct  7 06:29:15 2004
Subject: [mod_python] Forcing a confirmation page after authentication
In-Reply-To: <376098AE-17CC-11D9-8241-000A95CCEA34@itodd.org>
References: <20041006175319.GJ17285@gaspode.nextlink.co.za>
	<376098AE-17CC-11D9-8241-000A95CCEA34@itodd.org>
Message-ID: <41651A75.9020008@sjsoft.com>

I would recommend trying a cookies-based authentication (e.g. 
mod_python's builtin session support) rather, as HTTP authentication is 
done once per request and so its difficult to establish when the login 
occurs...

David

Todd Boland wrote:

> What I would recommend is an internal redirect after authentication. 
> Only redirect if they have not seen the message. in the handler that 
> displays the message which you internally redirected to, you could set 
> a cookie to indicate they've seen the message and add the link "<a 
> href=%s>continue</a>" % req.prev.unparsed_uri so they don't have to 
> re-navigate to the page they originally requested.
>
> I hope I helped more than I confused you.
>
> Todd
>
>
>
> On Oct 6, 2004, at 1:53 PM, Thomas Andrews wrote:
>
>> I'm sorry if this is a totally obvious one - I'm new to Apache & 
>> mod_python.
>>
>> How do I make a page come up *every* time a visitor has been
>> authenticated, irrespective of what page they request ? I want to force
>> them to confirm some data just after they have authenticated. After that
>> I want them to browse the existing html pages unhindered.
>>
>> I'm already using PythonAuthenHandler so that I can do the
>> authentication myself and that's working, but I just don't know how to
>> feed into my next page from there because that handler doesn't expect me
>> to print anything out to the browser - it just wants to see a
>> return-code (as I understand it.)
>>
>> There are these other handlers:
>>
>> * PythonPostReadRequestHandler
>> * PythonTransHandler
>> * PythonHeaderParserHandler
>> * PythonAccessHandler
>> * PythonTypeHandler
>> * PythonFixupHandler
>> * PythonHandler
>> * PythonInitHandler
>> * PythonLogHandler
>> * PythonCleanupHandler
>>
>> ... but none of them seem to do what I need. (or did I miss something?)
>>
>> Thanks for the help,
>> Thomas 
>

From berry.groenendijk at gmail.com  Fri Oct  8 00:09:05 2004
From: berry.groenendijk at gmail.com (berry groenendijk)
Date: Thu Oct  7 17:10:03 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <20041005163019.GA1774@barbucha.martin.net>
References: <NOEPJMBJNKKPJLAEACANKEHACLAA.pynode@centrum.cz>
	<redirect-14163588@vse.cz> <20041005163019.GA1774@barbucha.martin.net>
Message-ID: <680bcd95041007140951ce3d62@mail.gmail.com>

There is indeed very little information on the Internet about the
apache.import_module funtion. I did find this Wiki page:
http://modpython.coedit.net/ReloadingModules

I now import all my Python modules using apache.import_module, except
for all the Standard Library imports. All indirectly imported modules
are also imported with apache.import_module. In my .htaccess file I
have set PythonAutoReload On.

But, when I make a change in a module, save it and refresh my browser,
the module is NOT reloaded. Why? Has anyone succefully used
apache.import_module?

Thanks,
Berry.


On Tue, 5 Oct 2004 18:30:19 +0200, Martin Slouf <xslom03@vse.cz> wrote:
> On Mon, Oct 04, 2004 at 11:12:42PM +0200, berry groenendijk wrote:
> > Hi Mike,
> >
> > I was about to ask the same question! I am building a website using
> > servlets. But, I still haven't found a hosting provider that supports
> > mod_python 3.1.3. Can you recommend a hosting provider? Is it
> > reasonably priced? I also do prefer a hosting provider in Europe, for
> > example Germany or The Netherlands. Do you know a good hosting
> > provider in Europe that does support mod_python 3.1.3?
> >
> > Indeed when I change .py modules in my developement environment, I
> > need to restart Apache to get the changes to work. So, I was also
> > wondering how to update .py modules on a server at a hosting provider
> > that does not allow you to restart the Apache server proces.
> >
> > Thanks,
> > Berry
> >
> 
> ad hosting:
> 
> well, there is a server in CZE --> www.eolymp.cz (it@eolymp.cz) which provides
> 3.1.3 mod_python, python 2.3.3, apache 2.0.50 and MySQL.  im its admin (_only_
> an admin), but im not sure, whether the company will accept someone from
> abroad. its a strange company, but pricing migth be reasonable -- there is
> nothing like 'official webhosting pricing', but you may want to contact Roman
> AppeltHauer at it@eolymp.cz.
> 
> ad modules:
> 
> i use the touch command (fits in most cases) and in sometimes server restart,
> but true, im not able to really reload all the modules without server restart.
> 
> m.
> 
> 
> 
> 
> >
> > On Mon, 4 Oct 2004 15:06:34 +0100, MJR <pynode@centrum.cz> wrote:
> > > Hi,
> > >
> > > I'm running mp servlets on Apache server I don't have control over, i.e. I
> > > cannot restart it when I change my .py modules imported by my .mps scripts.
> > >
> > > I'm just wondering whether there is any hack for this. How people deal with
> > > it in a production environment.
> > >
> > > Thanks,
> > > Mike
> > >
> > > _______________________________________________
> > > Mod_python mailing list
> > > Mod_python@modpython.org
> > > http://mailman.modpython.org/mailman/listinfo/mod_python
> > >
> > _______________________________________________
> 
> 
> > Mod_python mailing list
> > Mod_python@modpython.org
> > http://mailman.modpython.org/mailman/listinfo/mod_python
>
From sorr at rightnow.com  Thu Oct  7 16:19:41 2004
From: sorr at rightnow.com (Orr, Steve)
Date: Thu Oct  7 17:19:45 2004
Subject: [mod_python] Processing Apache Logs
Message-ID: <D30BE1A2F9109A43BA989E2F5168405603FA44AD@pobox.corp.rightnow.com>

WELL???
 
Are there no answers to this question? 
 
 

	-----Original Message-----
	From: mod_python-bounces@modpython.org
[mailto:mod_python-bounces@modpython.org] On Behalf Of Orr, Steve
	Sent: Wednesday, October 06, 2004 5:19 PM
	To: mod_python user mailing list
	Subject: RE: [mod_python] Processing Apache Logs
	
	
	OK, I got some custom logging to a database working and I can
pretty much capture anything generated by "normal" Apache logging
except... I don't see any equivalent to the Apache directive like
LogFormat "%T %D" where %T and %D are the respective times to serve the
HTTP requests in seconds and microseconds.
	 
	Is there any reason the PythonLogHandler doesn't pick this up
from the Apache logging phase? Am I stuck because there's "no way to get
there from here?"
	 
	Please advise and TIA! TIA! TIA! ...
	D. B. Dweeb
	 
	 

		-----Original Message-----
		From: mod_python-bounces@modpython.org
[mailto:mod_python-bounces@modpython.org] On Behalf Of Orr, Steve
		Sent: Wednesday, October 06, 2004 8:28 AM
		To: Jaco Smuts
		Cc: mod_python user mailing list
		Subject: RE: [mod_python] Processing Apache Logs
		
		
		Yes, we're actually using it in a limited way. It's
pretty good but our data warehouse needs to be in Oracle. Currently we
use mod_sql to capture the data into MySQL then copy subsets of data to
Oracle. 
		 
		I was looking at mod_python's access to the Apache
internals and it looks like the various attributes (members) of the
request, connection, and server objects would contain everything needed
to capture the Apache log data (and more?) so I'm thinking the
PythonLogHandler could be used to get this data and put it into a
database as mentioned in the ONLamp Python DevCenter article,
(http://www.onlamp.com/pub/a/python/2003/10/02/mod_python.html). 
		 
		Quote:

			"Mod_python provides the ability to register for
any phase and write the processing function in Python. This is a very
powerful feature, because it opens the door for many innovative and
exciting ways to use Apache. For example, you can write Python code to
do authentication processing or custom logging (perhaps sending logs to
a database while maintaining real-time statistics)."

		This is all new to me and I need an example to get
started with the PythonLogHandler. So... it would be nice to have a
quick and dirty example to backup the claim in the article.  :-)
		 
		 
		With admiration for the mod_python project,
		D. B. Dweeb, AKA Steve Orr
		 
		 

			-----Original Message-----
			From: Jaco Smuts [mailto:JSmuts@clover.co.za] 
			Sent: Wednesday, October 06, 2004 12:55 AM
			To: Orr, Steve
			Cc: mod_python user mailing list;
mod_python-bounces@modpython.org
			Subject: Re: [mod_python] Processing Apache Logs
			
			

			Have you  looked at mod_sql ? 
			
			jaco 
			
			
			
			
			
"Orr, Steve" <sorr@rightnow.com> 
Sent by: mod_python-bounces@modpython.org 

10/05/2004 08:08 PM 

To
"mod_python user mailing list" <mod_python@modpython.org> 
cc
Subject
[mod_python] Processing Apache Logs	

		




			The ONLamp "Introducing mod_python" article
mentions the possibility of
			doing custom Apache logging with mod_python and
inserting log data
			directly to a database. Are there any examples
of this or has anyone on
			this list done such a thing? Any guidance or
suggestions?
			
			I'm looking at building a data warehouse from
the Apache log output. The
			web apps on the load balanced web servers to be
monitored do not use any
			Python code. Are there 3rd party (non-Pythonic
perhaps) log parser apps
			I should look at instead of cutting my own
mod_python code? 
			
			
			AtDhVaAnNkCsE,
			D. B. Dweeb
			
			_______________________________________________
			Mod_python mailing list
			Mod_python@modpython.org
	
http://mailman.modpython.org/mailman/listinfo/mod_python
			
			

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://modpython.org/pipermail/mod_python/attachments/20041007/afde435f/attachment.html
From grahamd at dscpl.com.au  Fri Oct  8 08:30:11 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct  7 17:31:02 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <680bcd95041007140951ce3d62@mail.gmail.com>
Message-ID: <11A043F1-18A8-11D9-90EF-000393BB31F6@dscpl.com.au>


On Friday, October 8, 2004, at 07:09  AM, berry groenendijk wrote:

> There is indeed very little information on the Internet about the
> apache.import_module funtion. I did find this Wiki page:
> http://modpython.coedit.net/ReloadingModules
>
> I now import all my Python modules using apache.import_module, except
> for all the Standard Library imports. All indirectly imported modules
> are also imported with apache.import_module. In my .htaccess file I
> have set PythonAutoReload On.
>
> But, when I make a change in a module, save it and refresh my browser,
> the module is NOT reloaded. Why? Has anyone succefully used
> apache.import_module?

Is the module you change one that is directly listed in a PythonHandler
directive, or if using mod_python.publisher, is it a module which is
being directly loaded by mod_python.publisher?

If it isn't and it is one of your common modules which is imported by
one falling into the above class of modules, then you still may at
least need to touch all the top level modules which use it. This is
because import_module() will not reload a top level module if what is
changed is actually in a module it imports.

Ie., if a.py imports b.py using import_module() and b.py is changed, but
then access is to a.py for the web page, neither a.py nor b.py will be
imported. You need to touch a.py first as well. If I understand things
correctly, it should then import a.py again, which in turn, since b.py
was modified should see import_module() import it as well.

What content handler system are you using, publisher, psp, home grown?
Can you describe how the modules/files relate and what is being changed?

--
Graham Dumpleton (grahamd@dscpl.com.au)

From berry.groenendijk at gmail.com  Fri Oct  8 00:50:54 2004
From: berry.groenendijk at gmail.com (berry groenendijk)
Date: Thu Oct  7 17:50:56 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <11A043F1-18A8-11D9-90EF-000393BB31F6@dscpl.com.au>
References: <680bcd95041007140951ce3d62@mail.gmail.com>
	<11A043F1-18A8-11D9-90EF-000393BB31F6@dscpl.com.au>
Message-ID: <680bcd9504100714507dfc01be@mail.gmail.com>

My handler is servlet.py. The excellent module build by Daniel
Popowich. I do not place this servlet.py in the mod_python
installation directory, but I have the servlet.py in the root of my
website. In a .htaccess file I have the following entries:

PythonAutoReload On
SetHandler mod_python
PythonHandler servlet
PythonDebug on

I think the problem is in the servlet.py. Because, as soon as I touch
this file I get this error:

ValueError: index is not a subclass of Servlet (in E:/Program
Files/Apache Group/Apache2/htdocs/MySite/index.mps)

Before I touched servlet.py the index file loaded perfectly.
Apparently apache tried reloading the servlet file effectively
creating a new Servlet object in memory. Other pages that have already
created in memory and that are subclasses from Servlet have now
apparently lost their 'parent'.

Any suggestions how to solve this?

Thanks,
Berry

On Fri, 8 Oct 2004 07:30:11 +1000, Graham Dumpleton
<grahamd@dscpl.com.au> wrote:
> 
> On Friday, October 8, 2004, at 07:09  AM, berry groenendijk wrote:
> 
> > There is indeed very little information on the Internet about the
> > apache.import_module funtion. I did find this Wiki page:
> > http://modpython.coedit.net/ReloadingModules
> >
> > I now import all my Python modules using apache.import_module, except
> > for all the Standard Library imports. All indirectly imported modules
> > are also imported with apache.import_module. In my .htaccess file I
> > have set PythonAutoReload On.
> >
> > But, when I make a change in a module, save it and refresh my browser,
> > the module is NOT reloaded. Why? Has anyone succefully used
> > apache.import_module?
> 
> Is the module you change one that is directly listed in a PythonHandler
> directive, or if using mod_python.publisher, is it a module which is
> being directly loaded by mod_python.publisher?
> 
> If it isn't and it is one of your common modules which is imported by
> one falling into the above class of modules, then you still may at
> least need to touch all the top level modules which use it. This is
> because import_module() will not reload a top level module if what is
> changed is actually in a module it imports.
> 
> Ie., if a.py imports b.py using import_module() and b.py is changed, but
> then access is to a.py for the web page, neither a.py nor b.py will be
> imported. You need to touch a.py first as well. If I understand things
> correctly, it should then import a.py again, which in turn, since b.py
> was modified should see import_module() import it as well.
> 
> What content handler system are you using, publisher, psp, home grown?
> Can you describe how the modules/files relate and what is being changed?
> 
> 
> 
> --
> Graham Dumpleton (grahamd@dscpl.com.au)
> 
>
From grahamd at dscpl.com.au  Thu Oct  7 18:10:49 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct  7 19:11:37 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <680bcd9504100714507dfc01be@mail.gmail.com>
Message-ID: <1097190646.28288@dscpl.com.au>

On Oct 07 23:50, berry groenendijk <berry.groenendijk@gmail.com> wrote:
>
> Subject: Re: [mod_python] Udate python modules without restarting Apache
>
> My handler is servlet.py. The excellent module build by Daniel
> Popowich. I do not place this servlet.py in the mod_python
> installation directory, but I have the servlet.py in the root of my
> website. In a .htaccess file I have the following entries:
> 
> PythonAutoReload On
> SetHandler mod_python
> PythonHandler servlet
> PythonDebug on
> 
> I think the problem is in the servlet.py. Because, as soon as I touch
> this file I get this error:
> 
> ValueError: index is not a subclass of Servlet (in E:/Program
> Files/Apache Group/Apache2/htdocs/MySite/index.mps)
> 
> Before I touched servlet.py the index file loaded perfectly.
> Apparently apache tried reloading the servlet file effectively
> creating a new Servlet object in memory. Other pages that have already
> created in memory and that are subclasses from Servlet have now
> apparently lost their 'parent'.
> 
> Any suggestions how to solve this?

Hmmm, I haven't tried MPS as yet, looks like it might be time to do so
in order to understand it a bit better.

One of the issues with reloading that isn't obvious is that it doesn't
actually clean out the namespace of the existing loaded module before
loading it again. In effect it lays the reloading module back over the top
of the old one. You can thus still have strange things happen if you keep
state in global variables or remove methods.

The easiest to explain is the removal of a method from a module which
is imported by mod_python.publisher. Even though the method is removed
from the code file, when it reloads the code module it doesn't actually
delete the existing method, so it still exists and can still be accessed by
a request.

Anyway, I'll get down MPS and have a bit of a play.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From grahamd at dscpl.com.au  Thu Oct  7 19:50:21 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct  7 20:50:48 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <1097190646.28288@dscpl.com.au>
Message-ID: <1097196617.38987@dscpl.com.au>

On Oct 07 17:10, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>
> Subject: Re: [mod_python] Udate python modules without restarting Apache
>
> On Oct 07 23:50, berry groenendijk <berry.groenendijk@gmail.com> wrote:
> >
> > Subject: Re: [mod_python] Udate python modules without restarting Apache
> >
> > I think the problem is in the servlet.py. Because, as soon as I touch
> > this file I get this error:
> > 
> > ValueError: index is not a subclass of Servlet (in E:/Program
> > Files/Apache Group/Apache2/htdocs/MySite/index.mps)
> > 
> > Before I touched servlet.py the index file loaded perfectly.
> > Apparently apache tried reloading the servlet file effectively
> > creating a new Servlet object in memory. Other pages that have already
> > created in memory and that are subclasses from Servlet have now
> > apparently lost their 'parent'.
> > 
> > Any suggestions how to solve this?
> 
> Hmmm, I haven't tried MPS as yet, looks like it might be time to do so
> in order to understand it a bit better.
> 
> One of the issues with reloading that isn't obvious is that it doesn't
> actually clean out the namespace of the existing loaded module before
> loading it again. In effect it lays the reloading module back over the top
> of the old one. You can thus still have strange things happen if you keep
> state in global variables or remove methods.
> 
> The easiest to explain is the removal of a method from a module which
> is imported by mod_python.publisher. Even though the method is removed
> from the code file, when it reloads the code module it doesn't actually
> delete the existing method, so it still exists and can still be accessed by
> a request.

Okay, have read your email properly now and have had a little play. What
I didn't note was that you had put mod_python.servlet into your directory
and touched it. A bit more of an explaination follows, but simple answer
is that you shouldn't need to touch servlet.py anyway as that isn't going to
help in the reloading of your code. I would also recommend that servlet.py
be installed properly somewhere else and not be in your document tree.
Preferably put it somewhere where its modification time will not be changed
inadvertantly while it is being used.

Anyway, what I think is happening is that in the most low level servlet class
in your common code modules, you have an ordinary import of something
from mpservlets. To use the demo tutorial that comes with mpservlets as an
example, it has _TutorialBase.py which after accomodating that you had
servlet.py in the same directory, has:

  from servlet import HTMLPage

Now in index.mps of the tutorial, if one has modified it to use import_module()
you would have:

  #from _TutorialBase import *

  from mod_python import apache
  _TutorialBase = apache.import_module("_TutorialBase")
  TutorialBase = _TutorialBase.TutorialBase

If Apache is freshly started, all will work okay. The problem now is that if servlet.py
is touched, mod_python will reimport servlet.py the next time a request comes in.

Now, the mpservlet system has its own module import and caching system for .mps
files. In mod_python doing the reimport of servlet.py it will actually throw out the
mpservlet cache contents so when handler() is called it will need to reload index.mps
which in turn obtains _TutorialBase from the standard mod_python cache.

The problem here is that _TutorialBase used a normal "import" to get HTMLPage and
it still holds a reference to the copy that was imported before "servlet.py" got reimported
by mod_python. When the handler() method in servlet.py goes to check to see if the
servlet loaded from index.mps derives from Servlet it doesn't match. This is because
that in _TutorialBase is still using the Servlet base class from the older servlet module
obtained using "import".

In other words, there are two copies of the servlet module in memory. The handler()
method is checking against itself (ie., new copy), where as _TutorialBase is still using
the old one.

Thus, for case where using mpservlet, simply don't touch the servlet.py. If you had
changed _TutorialBase, touch index.mps as well and both will be reloaded.

Although I suggest installing servlet.py somewhere else properly, you could possibly
also use import_module() to load in "servlet.py" as well. Ie.,

  # from servlet import HTMLPage

  from mod_python import apache
  servlet = apache.import_module("servlet")
  HTMLPage = servlet.HTMLPage

BTW, mpservlet doesn't use "imp" module to do module importing of .mps files but
instead uses execfile(). By using execfile() it effectively throws away the prior module before
reimporting it. This means you don't get issues with deleted methods still showing etc.
It also means though that you can't use global variables cleverly to preserve state
across module reloads. You would have to put such magic state in a separate modules
loaded by import_module() or "import" instead. Managing such state is still tricky though.

Hope this helps.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From poeml at suse.de  Fri Oct  8 12:54:52 2004
From: poeml at suse.de (Peter Poeml)
Date: Fri Oct  8 05:54:58 2004
Subject: [mod_python] Compiling mod_python on Linux/apache with LFS
In-Reply-To: <20041005001153.GA20615@legolas.on.net.mk>
References: <20041005001153.GA20615@legolas.on.net.mk>
Message-ID: <20041008095452.GA1249@suse.de>

On Tue, Oct 05, 2004 at 02:11:53AM +0200, Damjan wrote:
> I've recenlty been compiling mod_python on Slackware Linux against an
> Apache2 (2.0.52) compiled with large file support (LFS).
> 
> Apache2 was compiled with these flags:
> CPPFLAGS="-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64"
> 
> unfortunately mod_python's build system doesn't honor this environment
> variable, so I had to hack it directly in src/Makefile, 
> after ./configure finished.
> 
> If anyone had a problem when apache would segfault for any request
> (even for static files) after mod_python was installed whis is most
> probably the reason.


./configure --with-apxs=`which %{apxs}` --libdir=%{_libdir}
make OPT="$(%{apxs} -q CFLAGS)"

works fine here -- mod_python picks up the right flags.

Peter

-- 
Thought is limitation. Free your mind.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
Url : http://modpython.org/pipermail/mod_python/attachments/20041008/dfdb047a/attachment.bin
From dpopowich at comcast.net  Fri Oct  8 11:23:49 2004
From: dpopowich at comcast.net (Daniel Popowich)
Date: Fri Oct  8 10:26:09 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <1097196617.38987@dscpl.com.au>
References: <1097190646.28288@dscpl.com.au>
	<1097196617.38987@dscpl.com.au>
Message-ID: <16742.41717.581031.231622@fenway.local.>


Graham Dumpleton writes:

> Now, the mpservlet system has its own module import and caching
> system for .mps files. In mod_python doing the reimport of
> servlet.py it will actually throw out the mpservlet cache contents
> so when handler() is called it will need to reload index.mps which
> in turn obtains _TutorialBase from the standard mod_python cache.
> 
> The problem here is that _TutorialBase used a normal "import" to get
> HTMLPage and it still holds a reference to the copy that was
> imported before "servlet.py" got reimported by mod_python. When the
> handler() method in servlet.py goes to check to see if the servlet
> loaded from index.mps derives from Servlet it doesn't match. This is
> because that in _TutorialBase is still using the Servlet base class
> from the older servlet module obtained using "import".
> 
> In other words, there are two copies of the servlet module in
> memory. The handler() method is checking against itself (ie., new
> copy), where as _TutorialBase is still using the old one.

Excellent description by Graham of what's going on.  You will see
this problem whenever the chain of "imports" is like this:

  mod_python =>
      import servlet =>
          execfile('someservlet.mps') =>
              [import indirectmodule.py =>]+
	          import servlet.py

It's the indirect importing of servlet.py that creates the subclassing
error.  My suggestions:

  0. The easiest way, of course, is "apachectl graceful", but that
     doesn't help you if you don't have privs on your hosting service.

  1. Avoid touching servlet.py.  You can avoid accidental reloading of
     servlet.py by mod_python by setting PythonAutoReload to "off"
     (which is recommended in a production environment).  If you do
     mean to modify servlet.py, consider subclassing Servlet or
     HTMLPage and placing this code in another module.  I would
     recommend subclassing anyway for two reasons: 1) it's the OO way
     to add/replace functionality; 2) as I provide updates you will
     have an easier time merging your modifications.

  2. Use apache.import_module() or some such that will reload modules
     automagically.

BTW, during development my favorite way to avoid these importing
issues is to set MaxRequestsPerChild to 1 in my apache configuration
(prefork MPM).  Apache will then start a new python interpreter per
request.  Performance can be sometimes doggish, but that's OK during
development.  I crank it up to 1000 during beta testing.

> BTW, mpservlet doesn't use "imp" module to do module importing of
> .mps files but instead uses execfile(). By using execfile() it
> effectively throws away the prior module before reimporting it.

The main reason I used execfile is because I wanted to build a cache
of servlet classes keyed on the full filename.  This means I avoid
problems of /somedir/index.mps and /somedir/subdir/index.mps
colliding.  Also, there are so many gnarly issues with using the
import system, I believe I've avoided many a head-ache (e.g., dealing
with pythonpath; wanting to import files that end in .mps).

Cheers!

Daniel Popowich
-----------------------------------------------
http://home.comcast.net/~d.popowich/mpservlets/

From bray at sent.com  Fri Oct  8 12:33:00 2004
From: bray at sent.com (Brian Ray)
Date: Fri Oct  8 12:33:12 2004
Subject: [mod_python] moving file handle
Message-ID: <B801CD16-1947-11D9-870F-000A95BF3560@sent.com>

This may be too simple or OT for this list, but I need some help.

I am using a custom handler and util.FieldStorage to get a file from a 
POST:

	form  = util.FieldStorage(req)

	# key datafile sent from html name
	file = form['datafile']

	# filehand is a file instance
	filehand = file['file']
	
type of filehand:

<open file '<fdopen>', mode 'w+b' at 0x1221920>

How do I save this instance file data to somewhere on disk without 
writing the file to a string? I simply want to move the file to a disk 
file where I can later access. I saw in an earlier post from David 
Fraser:

         contents = field.value
         # or you can do the read yourself:
         field.file.seek(0)
         contents = field.file.read()
         # reset the position so others can read it
         field.file.seek(0)

I understand this and it works. However, would I not get better 
performance by simply moving the temp file created from the util 
instance.

My concern is performance with larger files.

TIA, Brian

From grahamd at dscpl.com.au  Sat Oct  9 13:26:23 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Fri Oct  8 22:26:29 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <16742.41717.581031.231622@fenway.local.>
References: <1097190646.28288@dscpl.com.au> <1097196617.38987@dscpl.com.au>
	<16742.41717.581031.231622@fenway.local.>
Message-ID: <9CCD3198-199A-11D9-AAF9-000393DCF16E@dscpl.com.au>


On 09/10/2004, at 12:23 AM, Daniel Popowich wrote:

>> BTW, mpservlet doesn't use "imp" module to do module importing of
>> .mps files but instead uses execfile(). By using execfile() it
>> effectively throws away the prior module before reimporting it.
>
> The main reason I used execfile is because I wanted to build a cache
> of servlet classes keyed on the full filename.  This means I avoid
> problems of /somedir/index.mps and /somedir/subdir/index.mps
> colliding.  Also, there are so many gnarly issues with using the
> import system, I believe I've avoided many a head-ache (e.g., dealing
> with pythonpath; wanting to import files that end in .mps).

The ability to distinguish between index.py in two different directories
is possible with "imp" module functions. The trick is that when you  
finally
call imp.load_module, rather than passing the name of the module as the
first argument, you pass it some encoded name which incorporates the  
full
pathname to the module code file. In doing this you have to ensure  
though
to get rid of any magic characters that might cause problems. I have  
also
a long long time ago had issues with the length of the name used, thus
a scheme to shorten it is possibly a good idea as well.

But then, I think you perhaps know this, as I recollect mpservlets not
using execfile() in an older version, or was that some other package for
mod_python I am thinking of.

FWIW, to see how Vampire mangles the names so as to still be able to use
the "imp" module, check out:

    
http://www.dscpl.com.au/projects/vampire/examples-01/python- 
modules.html

The "label" field is the name which the module appears as in  
sys.modules.
Those starting with "_vampire_" are the mangled names which Vampire uses
in its module importing and caching system and which are getting passed
as first argument to imp.load_module. It is a strange combination of md5
hashing and base64 encoding of the full pathname.

BTW, with the latest version of Vampire, I show how you can integrate  
use
of mpservlets package. Unfortunately my public web site isn't Apache 2.0
so can't host a working example. You can see the source code though at
for the mpservlets demo at:

    
http://www.dscpl.com.au/projects/vampire/source/examples-06/servlet- 
demo.py

When using Vampire, your code is in ".py" file and not ".mps" and you  
don't
have to access it as ".mps" either. If you want extensions, you can set  
it
up to use ".html" or ".mps". If you want no extension to be used, you  
can do
that also. Thus a bit more flexible.

Anyway, I will be making a announcement about latest version of Vampire
shortly.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From grahamd at dscpl.com.au  Sat Oct  9 18:32:01 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Oct  9 03:32:08 2004
Subject: [mod_python] ANN: Vampire 1.1 is now available.
Message-ID: <4FA44CE1-19C5-11D9-AAF9-000393DCF16E@dscpl.com.au>

Vampire 1.1 is now available from:

   http://www.dscpl.com.au/projects/vampire

To quote some of the description from the web site:

   Vampire can be seen as an extension of the "AddHandler" and 
"SetHandler"
   directives which are normally used to dictate which content handler is
   used to service a request. Rather than such a decision being made by 
Apache,
   it is brought into the scope of Python code executing under 
mod_python.
   Doing this results in a greater ability to control exactly which 
content
   handler is used to generate the content returned in response to a 
request.

   ...

   An important philosophy underlying Vampire, is that URLs should not 
expose
   the means by which a web site is implemented. If a resource is 
presented as
   HTML markup and an extension is going to be used, then the URL for 
that
   resource should use a ".html" extension regardless of what 
implementation
   mechanism is used to generate the page. If the mechanism used to 
generate
   the content is changed, the URL should be able to remain as it was.

   A further philosphy underlying Vampire is that the content handler 
which
   is to be used should primarily be determined based on the name of the 
resource
   being requested and not the extension on the request. As such, 
individual
   resources should each have their own content handler stored in a file 
specific
   to the resource. Only where a resource can be represented in multiple 
formats,
   would the file associated with that resource contain more than one 
content
   handler, one for each data format that the resource is available in.

Note that Vampire is not a framework. That is, it doesn't dictate any 
specific
mechanism for generating page content, its primary intent is to make 
the use
of basic content handlers a bit more flexible.

This does not preclude the use of content generation mechanisms such as 
psp
or mpservlets, both can still be used within the context of Vampire. In 
doing
so, one can break from having to use implementation specific extensions 
such
as ".psp" and ".mps" and instead use extensions more relevant to the 
type of
content returned, eg., ".html". Alternatively, the REST style idea of 
using
no extension at all can also be adopted.

The major features which are implemented by Vampire are as follows:

     * A content handler selection mechanism which allows unique content 
handlers
       to be associated with individual resources. Default content 
handlers may
       also be defined which will be triggered for specific types of 
resources
       when no dedicated content handler exists for a resource.

     * A module importing and caching system which can track parent/child
       relationships between modules and will automatically reimport a 
parent
       module when the child module has changed, thus avoiding the need 
to restart
       Apache.

     * Automatic unmarshalling and passing of form data to a content 
handler
       method when a content handler defines extra arguments in addition 
to
       that of the request object.

     * A user authentication mechanism for individual content handlers,
       implemented in the same style as that provided by the 
mod_python.publisher
       module.

     * An application configuration mechanism incorporating a dynamic 
search
       capability for finding an appropriate configuration file within a 
parent
       directory without the need to hard code relative paths into code.

     * A handler for servicing XML-RPC requests and mapping them into 
code
       associated with your application, thus making it possible to also 
write
       external scripts which can interact with your application and 
turn it
       into a web service.

     * A template loading and caching system for the third party web 
templating
       engine called HTMLTemplate.

The package contains a few examples, including some which demonstrate 
basic
use of the HTMLTemplate, psp and mpservlets systems for generation of 
HTML.
There are also some examples showing use of ReportLab and Tiny RML2PDF 
for
generation of PDF documents on the fly.

At the moment, a good tutorial and more exhaustive documentation is 
lacking, but
the web site describes the basic functionality. Additional 
documentation will
follow as time and demand permits.

If there are any questions, post them here on the mod_python mailing 
list.

Enjoy, even if it is only of academic interest. :-)

--
Graham Dumpleton (grahamd@dscpl.com.au)

From nicolas at lehuen.com  Sat Oct  9 11:10:32 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Sat Oct  9 04:31:14 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <9CCD3198-199A-11D9-AAF9-000393DCF16E@dscpl.com.au>
Message-ID: <20041009081038.1F587C6B8@postfix3-2.free.fr>

Hi Graham, what are the pros and cons of using the imp module versus an
execfile call or an exec call ?

Using Apache 2.0.52 on win32, with a multithreaded MPM, I have noticed a few
problem with mod_python.publisher which reloads the same module many times
when many threads try to load it concurrently. It seems that either
mod_python.publisher or the imp module does not properly handle this
situation. The result is that I have many instances of the same module in
memory, so I got many connection pools instead of only one and so on. That's
why I decided to fix this and other problems (the famous 'only one index.py
in your application') by reimplementing my own variant of the publisher.

My variant uses its own module cache to load pages, based on my recipe here
:

http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/302997

The recipe shows a ModuleCache which inherits from FileCache, which in turns
uses fstat to check whether a file is changed and reload it if necessary.
The cache my publisher uses is similar but uses req.finfo to save an fstat
call. This is not rocket science, but the Cache class carefully locks
whatever needs to be locked to ensure a proper behaviour in a multithreaded
context. 

Anyway, here is what I do when I want to "load" a module :

(here, opened is an opened file object, and Module is a placeholder object,
see code)

        try:
            module = Module(name)
            exec opened in module.__dict__
            return module
        finally:
            opened.close()

Do you think this is acceptable ? Are there any drawbacks to this method ?

Regards,

Nicolas

> -----Message d'origine-----
> De : mod_python-bounces@modpython.org 
> [mailto:mod_python-bounces@modpython.org] De la part de 
> Graham Dumpleton
> Envoy? : samedi 9 octobre 2004 04:26
> ? : Daniel Popowich
> Cc : mod_python@modpython.org
> Objet : Re: [mod_python] Udate python modules without 
> restarting Apache
> 
> 
> On 09/10/2004, at 12:23 AM, Daniel Popowich wrote:
> 
> >> BTW, mpservlet doesn't use "imp" module to do module importing of 
> >> .mps files but instead uses execfile(). By using execfile() it 
> >> effectively throws away the prior module before reimporting it.
> >
> > The main reason I used execfile is because I wanted to 
> build a cache 
> > of servlet classes keyed on the full filename.  This means I avoid 
> > problems of /somedir/index.mps and /somedir/subdir/index.mps 
> > colliding.  Also, there are so many gnarly issues with using the 
> > import system, I believe I've avoided many a head-ache 
> (e.g., dealing 
> > with pythonpath; wanting to import files that end in .mps).
> 
> The ability to distinguish between index.py in two different 
> directories is possible with "imp" module functions. The 
> trick is that when you finally call imp.load_module, rather 
> than passing the name of the module as the first argument, 
> you pass it some encoded name which incorporates the full 
> pathname to the module code file. In doing this you have to 
> ensure though to get rid of any magic characters that might 
> cause problems. I have also a long long time ago had issues 
> with the length of the name used, thus a scheme to shorten it 
> is possibly a good idea as well.
> 
> But then, I think you perhaps know this, as I recollect 
> mpservlets not using execfile() in an older version, or was 
> that some other package for mod_python I am thinking of.
> 
> FWIW, to see how Vampire mangles the names so as to still be 
> able to use the "imp" module, check out:
> 
>     
> http://www.dscpl.com.au/projects/vampire/examples-01/python-
> modules.html
> 
> The "label" field is the name which the module appears as in 
> sys.modules.
> Those starting with "_vampire_" are the mangled names which 
> Vampire uses in its module importing and caching system and 
> which are getting passed as first argument to 
> imp.load_module. It is a strange combination of md5 hashing 
> and base64 encoding of the full pathname.
> 
> BTW, with the latest version of Vampire, I show how you can 
> integrate use of mpservlets package. Unfortunately my public 
> web site isn't Apache 2.0 so can't host a working example. 
> You can see the source code though at for the mpservlets demo at:
> 
>     
> http://www.dscpl.com.au/projects/vampire/source/examples-06/servlet-
> demo.py
> 
> When using Vampire, your code is in ".py" file and not ".mps" 
> and you don't have to access it as ".mps" either. If you want 
> extensions, you can set it up to use ".html" or ".mps". If 
> you want no extension to be used, you can do that also. Thus 
> a bit more flexible.
> 
> Anyway, I will be making a announcement about latest version 
> of Vampire shortly.
> 
> --
> Graham Dumpleton (grahamd@dscpl.com.au)
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 


From grahamd at dscpl.com.au  Sat Oct  9 19:42:40 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Oct  9 04:42:50 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <20041009081038.1F587C6B8@postfix3-2.free.fr>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
Message-ID: <2DECFCA3-19CF-11D9-AAF9-000393DCF16E@dscpl.com.au>


On 09/10/2004, at 6:10 PM, Nicolas Lehuen wrote:

> Hi Graham, what are the pros and cons of using the imp module versus an
> execfile call or an exec call ?
>
> Using Apache 2.0.52 on win32, with a multithreaded MPM, I have noticed 
> a few
> problem with mod_python.publisher which reloads the same module many 
> times
> when many threads try to load it concurrently. It seems that either
> mod_python.publisher or the imp module does not properly handle this
> situation. The result is that I have many instances of the same module 
> in
> memory, so I got many connection pools instead of only one and so on. 
> That's
> why I decided to fix this and other problems (the famous 'only one 
> index.py
> in your application') by reimplementing my own variant of the 
> publisher.

You have asked me about the one thing that I can't yet comment on. That 
is, how
threading affects all this. Reason is that I don't have access to a 
copy of
Apache which runs with threads to try things out. Not sure if I can 
build
Apache on Mac OS X to use threading or not.

To look at the whole threading issue was one of the next things to do 
on my
list. I need to go back through previous posts on the mailing list to 
see what
has been said before, see what the documentation says and also troll 
through
the source code.

The threading stuff worries me enough to say that only "prefork" should 
be
used with the Vampire package I make available. There is currently 
nothing
in the code to protect against multithread access to critical bits, so 
bound to
fail at some point.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From mogmios at mlug.missouri.edu  Sat Oct  9 03:37:17 2004
From: mogmios at mlug.missouri.edu (Michael)
Date: Sat Oct  9 05:38:55 2004
Subject: [mod_python] authentication?
Message-ID: <4167B14D.1060409@mlug.missouri.edu>

With mod_python can new means of authenticating websites be introduced? 
ie instead of requiring a username/password combo it could pass special 
encrypted keys back and forth without needing to prompt the user 
(assuming the client also understands the new auth scheme)? I'm not 
really familiar with how flexible http and Apache are in this regard. 
I'm wanting to use XML-RPC for the communications but I don't want to 
encode the authentication as XML-RPC - I'd rather authentication happen 
on it's own level akin to how normal http authentication would.

--
Michael <mogmios@mlug.missouri.edu>
http://kavlon.org

From grahamd at dscpl.com.au  Sun Oct 10 14:55:03 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Oct  9 23:55:26 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <2DECFCA3-19CF-11D9-AAF9-000393DCF16E@dscpl.com.au>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
	<2DECFCA3-19CF-11D9-AAF9-000393DCF16E@dscpl.com.au>
Message-ID: <2A69584B-1A70-11D9-AAF9-000393DCF16E@dscpl.com.au>

Apologies in advance, this is a long and complicated email. ;-)

On 09/10/2004, at 6:42 PM, Graham Dumpleton wrote:

>
> On 09/10/2004, at 6:10 PM, Nicolas Lehuen wrote:
>
>> Hi Graham, what are the pros and cons of using the imp module versus 
>> an
>> execfile call or an exec call ?
>>
>> Using Apache 2.0.52 on win32, with a multithreaded MPM, I have 
>> noticed a few
>> problem with mod_python.publisher which reloads the same module many 
>> times
>> when many threads try to load it concurrently. It seems that either
>> mod_python.publisher or the imp module does not properly handle this
>> situation. The result is that I have many instances of the same 
>> module in
>> memory, so I got many connection pools instead of only one and so on. 
>> That's
>> why I decided to fix this and other problems (the famous 'only one 
>> index.py
>> in your application') by reimplementing my own variant of the 
>> publisher.
>
> You have asked me about the one thing that I can't yet comment on. 
> That is, how
> threading affects all this.

I have done the bit of research on the threading stuff I needed to do. 
The
main thing I wasn't sure on before was the relationship between 
interpreters
and threads in threaded MPM and whether or not multiple threads 
pertaining to
distinct requests could be operating in the same interpreter at the 
same time.

Now from what I have seen by way of past comments in mailing list 
archive is that
there can be multiple request threads running within one interpreter. 
It concerns
me that I couldn't fine a good bit of official documentation on web 
site which
explains this relationship, as I would have thought it would have been 
a quite
important bit of information. Is there some and I simply missed it?

Anyway, back to your observation about mod_python.publisher reloading 
the same
module many times, I believe I can explain that one. I'll try and put 
down my
thoughts on some other stuff as well, but perhaps not all in this email
as I'll try and focus more on problems/issues with imp and 
load_module() method.

Please, if anyone sees that I say something wrong here, correct it. 
This is
all mainly based on reading and theory and not actual first hand 
experience
of the particular problem being mentioned.

Quoting "imp" module documentation, the first important bit of 
information to
be aware of is:

   On platforms with threads, a thread executing an import holds an 
internal
   lock until the import is complete. This lock blocks other threads 
from doing
   an import until the original import completes, which in turn prevents 
other
   threads from seeing incomplete module objects constructed by the 
original
   thread while in the process of completing its import (and the 
imports, if
   any, triggered by that).

Thus, once you get inside an import, including using 
"imp.load_module()", you
are guaranteed that no other import will be able to be commenced by 
another
thread. This doesn't stop the same threading doing further imports 
which are
nested within the initial import though.

Now, going by past comments on the mailing list, it seems therefore 
people
believe that initialising globals in an imported module, as the module 
is being
imported is safe. I'm not sure that this is correct, and a great deal of
care would still need to be taken in initialising global data. 
Basically, this
is because "apache.import_module()" isn't strictly safe in a threaded 
environment,
plus there are other issues as well.

To illustrate the problems, consider the following handler code, which 
follows
what some have suggested on the mailing list is the approach to use to 
ensure
that your content handler is thread safe.

   lock = Lock()

   myglobal1 = None
   myglobal2 = None
   myglobal3 = None


   ... arbitrary code to initialise globals


   def handler(req):
       lock.acquire()

       ... use and manipulate my global data

       lock.unlock()


Now, what the import lock first ensures is that you cannot have two 
brand new
instances of a module being imported at the same time. It also ensures 
that
if the module already exists, that you cannot have two module reloads 
occurring
at the same time.

Since variable assignments and executable code at global scope only get 
executed
at the time of import, all the import lock is doing is ensuring that 
you can't
have that code being executed within two threads at the same time.

My understanding is that the import lock can not ensure that a separate 
thread
which is already executing code within the module can't access the 
global data
in the case where a module reload is occurring. I think this as I can't 
see how
this could be implemented in a practical way. It would somehow 
necessitate a
lock on every module which would be acquired when any code in that 
module is
executing, so as to prevent a reload of the module at the same time.

What this means is that if a HTTP request came in which caused 
handler() above
to be executed, and while that request was being handled, the 
modification time
of the file was first changed and then a new HTTP request came in 
before the
first had even finished, you have the potential for problems with the 
above code
as it is written.

Before I get to why, one needs to understand what happens when a module 
reload
occurs. Specifically, when a module reload occurs, the existing data 
within
the module is not thrown away. That is, where a brand new import 
occurs, one
starts out with an empty module, when a module reload occurs, you start 
out with
the existing module. Thus, when a module reload occurs and global 
assignments
are performed, it is overlaid on or replaces what was there before.

To illustrate this, create a content handler which is triggered using 
SetHandler
and which contains the following code. Note this ignores threading 
issues
for now.

   from mod_python import apache

   _temp = globals().keys()
   _temp.sort()

   apache.log_error("globals 
"+str(_temp),apache.APLOG_NOERRNO|apache.APLOG_ERR)

   if globals().has_key("_count"):
     _count = _count + 1
     apache.log_error("reload 
"+str(_count),apache.APLOG_NOERRNO|apache.APLOG_ERR)
   else:
     apache.log_error("import",apache.APLOG_NOERRNO|apache.APLOG_ERR)
     _count = 0

   _value = 0

   apache.log_error("value 
"+str(_value),apache.APLOG_NOERRNO|apache.APLOG_ERR)

   _value = _value + 1

   def handler(req):
     req.content_type = "text/plain"
     req.send_http_header()
     req.write("Hello World!")
     return apache.OK

The first time this is accessed you should see in the Apache log file 
the following.

[Sun Oct 10 11:36:14 2004] [notice] mod_python: (Re)importing module 
'mptest'
[Sun Oct 10 11:36:14 2004] [error] globals ['__builtins__', '__doc__', 
'__file__', '__name__', 'apache']
[Sun Oct 10 11:36:14 2004] [error] import
[Sun Oct 10 11:36:14 2004] [error] value 0

That is, code detected that it was a first time import and has logged 
"import".
Now touch the code file and access it again and when you hit the same 
child
Apache process, you should see the following.

[Sun Oct 10 11:36:22 2004] [notice] mod_python: (Re)importing module 
'mptest'
[Sun Oct 10 11:36:22 2004] [error] globals ['__builtins__', '__doc__', 
'__file__', '__mtime__', '__name__', '_count', '_temp', '_value', 
'apache', 'handler']
[Sun Oct 10 11:36:22 2004] [error] reload 1
[Sun Oct 10 11:36:22 2004] [error] value 0

Touch it once more, and you should see the following.

[Sun Oct 10 11:36:33 2004] [notice] mod_python: (Re)importing module 
'mptest'
[Sun Oct 10 11:36:33 2004] [error] globals ['__builtins__', '__doc__', 
'__file__', '__mtime__', '__name__', '_count', '_temp', '_value', 
'apache', 'handler']
[Sun Oct 10 11:36:33 2004] [error] reload 2
[Sun Oct 10 11:36:33 2004] [error] value 0

Note how that on the second access, there already exists in the set of 
globals,
the "_count" variable and the "handler" function. This shows how a 
reload will
overlay what is already there. The check against the presence of 
"_count" can be
used to determine that the global scope code which is being executed is 
in fact
because of a reload and not an initial import. We use that check here 
such that
on a reload, we only increment the value of the existing variable and 
not set
it again to 0.

If you don't have this check, as is the case with "_value", when a 
reload occurs,
the value gets reset to whatever its starting value was. Thus, even 
though "_value"
was incremented, it gets set back to 0 upon the next reload.

Now think about the consequences of this for the original example. 
First off, the
lock variable will get reassigned on a reload of the module. In my 
understanding
of Python, what this means is that if the handler() were executing in a 
separate
thread and it had acquired the lock, but not yet released it and the 
reload
occurred in a new thread, the global lock is going to get replaced with 
a new one.
When the handler executing in the original thread goes to release the 
lock, it will
call unlock on a different lock.

The next problem is that the intent of the lock is to protect access to 
the global
variables. The handler correctly acquires the lock in order to make use 
of the
global variables, but the code executed by the subsequent reload does 
not. Thus,
not only does it replace the lock and the global variables, the 
modification of
the global variables is not done inside of the context of a lock.

This means that the handler which is trying to use the global 
variables, may find
they have suddenly been changed when it was expecting to have exclusive 
access.

In the context of threading and module reloading, the code presented to 
me would
thus appear to be quite dangerous. If a module is written like this, 
one would
definitely want to head the advice of disabling automatic module 
reloading in
a production system if my understanding of reloading is correct.

What one could do though to make the code more robust, is explicitly 
check when
a reload is occurring, and not set or change any global variables. If 
it was
still necessary somehow to modify the global variables, the code 
executing at
module scope when the module is being reloaded, could itself acquire 
the lock so
that there is no conflict on access.

Thus, code would be something like the following.

   if not globals().has_key("lock"):
     # This is a brand new import and we are inside the scope of the
     # import lock, so this should all be safe to execute.

     lock = Lock()

     myglobal1 = None
     myglobal2 = None
     myglobal3 = None


     ... arbitrary code to initialise globals

   lock.acquire()

   ... extra code to fiddle the globals

   lock.unlock()

   def handler(req):
       lock.acquire()

       ... use and manipulate my global data

       lock.unlock()

Unfortunately where not done yet, as there are still a few more dangers 
lurking
here, and I haven't even started on the problems with 
apache.import_module() yet.

The next thing to be careful of is something like the following.

   def modify1(req):
     lock.acquire()
     ...
     lock.unlock()
     return value

   def modify2(req,value):
     lock.acquire()
     ...
     lock.unlock()

   def handler(req):
     value = modify1(req)
     modify2(req,value)
     ...

Maybe I am being a bit paranoid on this one, but what happens if the 
operation of
modify1() and modify2() is tightly linked such that modify2() expects 
modify1()
to return data in a certain way. Imagine now that a module reload 
occurred between
the call to modify1() and modify2() and the code for both functions got 
changed
and the protocol as to what format modify2() expected to see something 
as got
changed. When the handler now executes modify2() it is the newer 
function and
it finds data set up in a different way than expected because it was 
the old
modify1() that was previously called to get the value it is operating 
on.

The point I am trying to make is that perhaps locking shouldn't pertain 
just
to the global data and that executable code should in some way be 
protected as well.
It needs more exploration, but perhaps the module should read something 
like the
following (untested).

   if not globals().has_key("datalock"):
     # This is a brand new import and we are inside the scope of the
     # import lock, so this should all be safe to execute.

     datalock = Lock()
     codelock = Lock()

     myglobal1 = None
     myglobal2 = None
     myglobal3 = None

     ... arbitrary code to initialise globals

   codelock.acquire()
   datalock.acquire()

   ... extra code to fiddle the globals

   def modify1(req):
     datalock.acquire()
     ...
     datalock.unlock()
     return value

   def modify2(req,value):
     datalock.acquire()
     ...
     datalock.unlock()

   def _handler(req):
     value = modify1(req)
     modify2(req,value)
     ...

   def handler(req):
     # code for this method should never be changed
     try:
       codelock.acquire()
       result = _handler(req)
     finally:
       codelock.unlock()
     return result

   datalock.unlock()
   codelock.unlock()

What is trying to be done here is using a lock to ensure that any code 
itself is
not replaced while the handler is being executed. The reason for two 
level handler
arrangement, is that the lock actually needs to be acquired outside of 
the real
handler method being called. If it is done inside, it is too late, as 
Python
has already grabbed the existing code for handler and if it gets 
replaced prior to
the lock being acquired, everything may have changed.

Am I being too paranoid? I don't understand enough about how code gets 
replaced when
a module reload is occurring.

One final thing to cover before moving on to looking at 
apache.import_module().

Ignore now that we had done all this thread stuff to make things work a 
bit better
within a threaded environment, as the next bit pertains even to prefork 
system.

Remember how "_value" in our original example was replaced with 0 again 
when the
module was reloaded. Imagine now that that was a quite complicated 
Python class
instance or even a Python class instance which wrapped up C code for 
something like
a database connection pool.

With the way the code was, the existing instance of the class would get 
thrown
away when a reload occurs. If that class was never designed to be 
discarded which
may well be the case in a database pooling scheme, or if the class had 
a __del__
method and there were reference cycles that couldn't be broken by the 
garbage
collector. The original class instance would hang around. This may 
simply result
in ever growing memory use, or a continual growing in the number of 
socket
connections to a back end database, as older instances of the database 
pooling
interface never got cleaned up.

To see how this latter issue is relevant to the original problem you 
saw, we now
need to look at apache.import_module(). The problem with the module 
importing and
caching system in the mod_python.apache module is that it doesn't do 
any thread
locking at all. That is, many threads can at the same time be 
consulting the module
cache, checking modification times, using imp.find_module() and then 
calling the
imp.load_module() method.

Think about the case where a module hasn't previously been loaded and a 
huge number
of requests suddenly come in which require it be loaded. Because there 
is no thread
locking on access to the cache, many threads may at the same time 
decide that a
module needs to be loaded. All of these threads will continue through 
to call the
imp.load_module() method.

It has already been explained that there is locking on module 
importation, so it
isn't possible to import a brand new module from two places at the same 
time.
This doesn't stop however all those extra threads from still calling 
imp.find_module()
once the initial thread has already imported it.

Why is this bad, well to quote the Python documentation for the 
imp.load_module().

   This function does more than importing the module: if the module was 
already
   imported, it is equivalent to a reload()!

Thus, all those extra calls into imp.load_module() from the other 
threads that had
decided at the same time to load the module in, get turned into module 
reloads.

Link this with what was described about the case of a database pooling 
instance being
replaced on module reload and you might see what is happening. It isn't 
that multiple
instances of the module corresponding to the handler are loaded into 
memory at the
same time, but the one module is reloaded many times in quick 
succession. In each case
the database pooling instance would get thrown away, but if it wasn't 
implemented so as
to be able to clean up itself when destroyed, if it even is destroyed, 
it will just
hang around and accumulate memory and potentially hold open connections 
to the
database as well.

Okay, I think am done for now. This doesn't contrast imp vs execfile 
etc, but I'll
get to that in another mail.

Hope this has helped.

If anyone who understands this better than I detects falsehoods here, 
please please
correct them and explain what actually happens.

Can some please confirm that multiple threads corresponding to 
different HTTP request
can be operating with one interpreter at the same time? Certain bits of 
the above
analysis are assuming that is the case.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From grahamd at dscpl.com.au  Sun Oct 10 19:50:15 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Oct 10 04:50:30 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <20041009081038.1F587C6B8@postfix3-2.free.fr>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
Message-ID: <67CC741B-1A99-11D9-AAF9-000393DCF16E@dscpl.com.au>


On 09/10/2004, at 6:10 PM, Nicolas Lehuen wrote:

> Hi Graham, what are the pros and cons of using the imp module versus an
> execfile call or an exec call ?

Hmmm, I'll try and have a go at this question now. Note that I haven't 
ever
used execfile()/exec myself so what I talk about here is only based on 
some
quick observations. Also, as far as I can tell, the end result of 
execfile()
and exec is the same, so I'll compare just imp.load_module() and 
execfile().

When using combination of imp.find_module() and imp.load_module(), main 
thing
is that it is a true module. Ie., result of calling type() on the 
result will
actually be <type 'module'>.

Taking a simple module which contains:

   variable = 0
   def function(): pass

If this module is imported using imp.load_module(), result is same as 
"import"
and running dir() on the module yields the following.

   ['__builtins__', '__doc__', '__file__', '__name__', 'function', 
'variable']

If one uses execfile() however, the result is simply a dictionary, ie., 
type()
yields <type 'dict'>. The results of calling keys() on that dictionary 
yields
the following.

   ['__builtins__', 'variable', 'function']

In terms of executing code within the context of the two, there 
probably isn't
going to be much difference. The only issue would be if the code being 
loaded
had expected it to be executing within the environment of a true 
module. Ie.,
that it expected __file__ and __name__ to actually exist.

I know that I occasionally write code which uses __file__ to work out 
the
directory that the code file is in, because in the same directory I 
might
place some data file that the module reads in when required as part of 
some
function the module provides.

This isn't a big detail, as a module importing system that used 
execfile() could
fake up the entries for __file__ and __name__ by loading them into the 
dictionary
prior to calling execfile().

Next issue with using execfile() is that the input has to be the 
original Python
code as text, albeit stored in a file. When using imp.find_module() and
imp.load_module() together, it can take advantage of a precompiled 
Python code
file, ie., ".pyc" file. I'll ignore C compiled modules, but if you are 
mad enough
you could use those as well.

Ultimately, this is probably no big deal in as much as you are caching 
the module
in memory for use anyway and it would only be an issue on a subsequent 
restart of
Apache the first time the code needs to be loaded.

Moving on to deletion of the loaded code in each case if you really 
needed to do
that. When using execfile(), the only place it will be saved away is in 
your cache.
Thus, delete it from the cache and once any code executing within the 
context of
it or otherwise holding a reference to it goes away, the code will also 
vanish.

When using "imp" methods, deleting it from your own cache isn't going 
to be enough
as it will also be referenced from sys.modules. Whether or not deleting 
stuff from
sys.modules is a good idea I don't know. I have done it in emergencies 
as I don't
have an ability to readily get Apache restarted in one place where I am 
doing
stuff.

An issue with deleting stuff from sys.modules is what happens in a 
multithreaded
environment if another thread is importing a module at the same time 
and is thus
updating sys.modules. It may well be the case that the safest thing to 
do is to
use the Python 2.3+ methods imp.acquire_lock()/imp.release_lock() on 
the assumption
that that lock is acquired when a module is being imported and thus 
when sys.modules
is being updated. Because it is only deletion of a single key, it may 
also not
really be needed either.

Now as far as initial loading of a module goes, the only other thing is 
that
in both cases, any module caching system should ensure that if it is to 
work
properly in a multithreaded environment that it thread locks its cache 
data
structures while working out whether a module is present and up to date 
and
when importing modules.

If this isn't done, you end up with problems like I described in prior 
email where
for example multiple threads may determine at the same time that a 
module has to
be freshly loaded. If this happens and the "imp" functions are being 
used, the
initial import will happen okay, but all the others end up in a reload 
being done.

If execfile() is being used, if you start out with a clean slate each 
time, you
end up with every thread getting a separate instance of the loaded 
module, but
all except the last one to store its copy back in the cache, will be 
deleted when
the HTTP request for each completes.

The actual differences between using "imp" functions and execfile() 
probably come
about when it comes to module reloading when the code changes. As I 
described in
prior email, the "imp" functions effectively reload the new code into 
the same
module instance it had already created.

That code is reloaded into the same module can both be beneficial and 
detrimental
if you are not careful.

A benefit is that you can store data which you wish to be preserved 
across reloads
in global variables. To get this to work, the variable can't be 
declared at global
scope when the module first loads, instead, it should only be created 
from a method
later on. The other alternative as explain in prior mail was to have 
code executing
at global scope check for prior existence of the global variable and 
not reinitialise
it if it already existed.

The not so good things I see about module reloading, and which I also 
explained in
prior email, is what to do if a module reload occurs while some other 
thread is
executing code in the module at the same time and accessing any global 
data. One
has to be very careful about how you perform your thread locking to 
ensure that
data doesn't get modified at the same time in bad ways.

As far as I know, there is possibly no real alternative to having 
modules reload
into the same namespace when using "imp" functions. Deletion of the 
module first from
sys.modules will work, but not sure how wise that is.

As it happens, when using execfile() you actually have a choice as to 
whether a
reload is done into the same namespace or not. This is controlled by 
the dictionary
supplied as second argument to execfile().

The choices are to pass in an empty dictionary and start from scratch 
each time,
or pass in the existing dictionary and have it be overlaid with new 
stuff just like
with the "imp" functions. Obviously, if starting from scratch each 
time, you would
delete the old dictionary from the cache first and then load in the 
module into the
new dictionary. In you want to keep what you had, don't delete it from 
the cache
and just reload over it.

Obviously, if you reload over it, you end up with all the same issues 
as described
from the "imp" methods.

There is other thing worth mentioning here in relation to reloading 
over the top of the
existing module in both cases. This is that if the new code module has 
removed a method
or some global bit of data. That method or data will still persist 
after the reload
even though it is no longer in the code file. This is because nothing 
in the namespace
is deleted.

That this can happen can be problematic. Consider the 
mod_python.publisher case which
currently uses apache.import_module(). If a method is deleted from the 
original code
file because you no longer want it to be visible, even after the 
reload, the old
version will still be there and still callable. Your only option to 
really get rid
of it is to restart Apache.

Now I am glad you asked this question as it has really made me think 
about how I use
the "imp" functions. At the sacrifice of potentially having precompiled 
code around,
I may actually change from using "imp" to execfile(). I would do this 
to enable more
flexibility by allowing control over what happens to existing data on 
reloads.

First off, to preserve some compatibility, I would have execfile() when 
reloading
a module after a change pass in the existing dictionary of data. Thus, 
new stuff is
overlaid on top of the old.

This however would be the default behaviour only. One could have 
special variables
defined within the module which dictate what is actually to occur on a 
reload. The
options I see which could be provided are:

1. Default behaviour being that of the "imp" methods where new is 
overlaid on top.

2. Start as new option where the existing module is totally discarded 
first and new
module goes into a fresh dictionary.

3. Same as option 2, except that module could define a list of global 
variables which
should be copied from the old module into the dictionary for the new 
before the reload
occurs.

When I first started on my module importing system, what I really 
wanted was option 3,
but I couldn't work out how to do it given "imp" reloaded on top and 
didn't really give
you a way of doing it any other way.

The reason I like option 3 is that it solves the problem with deleted 
methods not really
being deleted and thus perhaps causing problems because they may still 
be accessible.
Also, by requiring that the list of variables that should be preserved 
across the
reload be listed, it makes it clearer in the code what is preserved 
state information.

Now hopefully you have followed me through to the end on this. After 
having gone through
this, as suggested above, my preferred approach may actually now be as 
follows.

1. Use execfile().

2. On an import, setup __file__ and __name__ so it sort of looks like a 
real module in
cases where code expects to see those values set.

3. Default behaviour on reloading is to work like "imp" modules and 
reload on top of
existing module by passing dictionary for it as second argument to 
execfile().

4. Have ability through special variables defined in imported module to 
control what
actually happens on a reload. Namely, allow the three options above, 
for default
behaviour, start over as new and start over as new but preserve limited 
set of state
variables including thread locks.

Okay, looks like I have a TODO list for myself now. Not only do I have 
to address the
threading issues in Vampire as I knew I had to, but change the module 
importing system
to use execfile() and implement some control mechanisms over the reload 
behaviour.
Ahhh, more coding to do. In the meantime, my documentation for this 
project and
another project I work on just get delayed more and more. :-(

As usual, if some one thinks I speak with forked tongue and have 
misinterpreted how
something works, please respond and describe what really happens. Any 
other ideas
are also most welcome. Thanks.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From johna at johnaherne.co.uk  Sun Oct 10 11:35:35 2004
From: johna at johnaherne.co.uk (John Aherne)
Date: Sun Oct 10 05:39:47 2004
Subject: [mod_python] servlets and cookies
Message-ID: <41690267.2030603@johnaherne.co.uk>

I am new to all this.

I have installed and run modpython on windows2kserver with python2.3.

I have run the examples and they all work fine. I used the publisher 
interface which was straightforward.

I then looked at PSP and that was fine.

Then I found mpsservlets and that looked much better. I really liked the 
way it went about things. So I started to play around with that.

The examples are fine. They have useful code samples to copy and 
incorporate.

However, I am having a problem using cookies. Whatever I do I can't seem 
to get them to work.
So I looked at the sessions example. I took some of the code from the 
servlet example and of course that worked fine. I could pick up the 
session id whereas with cookies I could not get to see my stored cookie.

The feeling I get is that my add_cookie method is not working, since 
with the session I can get at my session id.

But the add_cookie method is so simple what could I be doing wrong.

I have 3 servlets. index, login, database display.

I start with index. If not logged in as correct user, using 
self.forms.getfirst, I redirect to login using self.external_redirect.

Login posts back to index which checks the username with 
self.forms.getfirst. If correct username logged in I then set a cookie 
and self.external_redirect to database display.

Database display reads the cookie. If present it will display the data. 
It never seems to find the cookie.

The code in index to add cookie is:

check = Cookie('user', 'myname')
add_cookie(self.req, check)

The code to read the cookie is:-

checkout = get_cookies(self.req, Cookie('user', 'myname')
if checkout.has_key('user'):
etc...

I am assuming that the self.external_redirect is the correct thing to do 
to force the client to resend so the cookie is sent back. Session id 
seems happy with this method.( one caveat, the first time it moans about 
'pysid' since I writeln out the session id to check it is the right one- 
but I am ignoring that for now while I concentrate on the cookies problem).

If anyone can spot the obvious flaw in my methodology above I would be 
grateful for any help as to what I have done wrong. It must be something 
pretty dumb since the add_cookie method doesn't offer much scope for 
doing anything wrong.

Thanks for any help.

John Aherne




From grahamd at dscpl.com.au  Sun Oct 10 21:13:30 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Oct 10 06:13:34 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <2A69584B-1A70-11D9-AAF9-000393DCF16E@dscpl.com.au>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
	<2DECFCA3-19CF-11D9-AAF9-000393DCF16E@dscpl.com.au>
	<2A69584B-1A70-11D9-AAF9-000393DCF16E@dscpl.com.au>
Message-ID: <08B2AA71-1AA5-11D9-AAF9-000393DCF16E@dscpl.com.au>


On 10/10/2004, at 1:55 PM, Graham Dumpleton wrote:

> The point I am trying to make is that perhaps locking shouldn't 
> pertain just
> to the global data and that executable code should in some way be 
> protected as well.
> It needs more exploration, but perhaps the module should read 
> something like the
> following (untested).
>
>   if not globals().has_key("datalock"):
>     # This is a brand new import and we are inside the scope of the
>     # import lock, so this should all be safe to execute.
>
>     datalock = Lock()
>     codelock = Lock()
>
>     myglobal1 = None
>     myglobal2 = None
>     myglobal3 = None
>
>     ... arbitrary code to initialise globals
>
>   codelock.acquire()
>   datalock.acquire()
>
>   ... extra code to fiddle the globals
>
>   def modify1(req):
>     datalock.acquire()
>     ...
>     datalock.unlock()
>     return value
>
>   def modify2(req,value):
>     datalock.acquire()
>     ...
>     datalock.unlock()
>
>   def _handler(req):
>     value = modify1(req)
>     modify2(req,value)
>     ...
>
>   def handler(req):
>     # code for this method should never be changed
>     try:
>       codelock.acquire()
>       result = _handler(req)
>     finally:
>       codelock.unlock()
>     return result
>
>   datalock.unlock()
>   codelock.unlock()
>
> What is trying to be done here is using a lock to ensure that any code 
> itself is
> not replaced while the handler is being executed. The reason for two 
> level handler
> arrangement, is that the lock actually needs to be acquired outside of 
> the real
> handler method being called. If it is done inside, it is too late, as 
> Python
> has already grabbed the existing code for handler and if it gets 
> replaced prior to
> the lock being acquired, everything may have changed.
>
> Am I being too paranoid? I don't understand enough about how code gets 
> replaced when
> a module reload is occurring.

Hmmm, maybe gone slightly too far here. The code lock effectively 
serialises access
to the handler, which screws up the whole idea of having threads in the 
first place.

I really like this idea of using execfile() as described in other email 
and copying
across state variables of interest into a new module, as avoids the 
need for the
code lock anyway as new code constructed in new module.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From nicolas at lehuen.com  Sun Oct 10 15:12:50 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Sun Oct 10 08:12:56 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <08B2AA71-1AA5-11D9-AAF9-000393DCF16E@dscpl.com.au>
Message-ID: <20041010121252.23C35C347@postfix3-2.free.fr>

Hi Graham,

First thank you for your thorough anaylisis of the imp module behaviour in a
multi-threaded environment. This reinforce my feeling that NOT using this
module is way better for my publisher since I can precisely understand what
it does without depending on any arcane locking mechanisms. With my
publisher, I know precisely what the locking policy is. Have a look at the
Cache recipe :

http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/302997

The trick I used to reduce cache contention is to have a two levels locking
scheme. The first level is a lock for the whole cache, used to make sure
that not two entries are created for the same key (here the key is the file
name of the module). The second level is an entry-specific lock which is
used to make sure that a module cannot be initialized by more than one
thread. This two level locking enable multiple threads to handle different
modules concurrently : the possibly lengthy module initialisation process is
done within a module-specific lock, so other thread can initialize other
modules concurrently.

So what happens when a page is accessed by my publisher ?

1) the publisher determines what file is targeted by the http request, just
by using req.filename
2) the publisher get the module keyed by the filename from the module cache
3) the publisher calls a special callable object in the module
(http_handler) or find one by applying acquisition semantics.

At this high level, no locking is required. If the module needs to be
reloaded, the threads which have already reached the step 3 will keep on
using the stale module. Once they are over, the stale module will be
dereferenced and eventually garbage collected (with all objects it
contains). Meanwhile, new threads arriving at step 2 will get the new
module. All is well that ends well.

Now if we study what's happening at step 2 when a module is already up to
date, then we see that we first acquire a lock on the module cache during a
very brief amount of time (just to get the entry for the filename), then a
lock on the module itself for another brief amount of time (just to check
that the module is indeed up to date). Thereafter, all thread are on their
own to do whatever they need in parallel.

So we have indeed a very small contention point where all requests are
serialized, then another small contention point where all requests targeted
at the same module are serialized, then no more contention until the request
is over. That is to say, all the hard work (database requests, file
processing, template rendering etc.) is indeed done in multiple concurrent
threads.

I don't see how this can be done in a better way. In any case, you certainly
should NOT acquire a lock and do all the request processing within this
lock, like you wrote below... This effectively kills any multi-threaded
attempt.

The best part with having properly managed modules is that you can
instantiate long-living objects that are shared between multiple threads in
the modules. The best example is a thread-safe DB connection pool. In fact,
my publisher automatically looks if the module targeted by a request has
special callable objects named 'prepare', 'commit', 'rollback' and
'release'. In those methods, a developper can write some code to manage DB
connections. The net result is that in most of my application, I only have
to write req.cursor to have a safe pooled cursor to the database I use. I
don't have to worry anymore about opening / closing DB connections !

In fact, I extended this behaviour : when a page module is loaded, the
publisher looks for a 'global.pyapp' file which contains a Python module
shared by all modules found in the same directory. This 'global.pyapp' file
is an application-wide module which usually defines global objects such as
the aformentioned DB connection pool, plus the same special methods
'prepare', 'commit', 'rollback', 'release' that are called before the ones
from the targeted module. This is equivalent to the 'global.asa' files found
in Microsoft's ASP.

I plan on releasing my code on the web, but I'm missing the time to build a
proper web site for now...

Anyway, thanks for this interesting discussion :)

Regards,

Nicolas

 

> -----Message d'origine-----
> De : mod_python-bounces@modpython.org 
> [mailto:mod_python-bounces@modpython.org] De la part de 
> Graham Dumpleton
> Envoy? : dimanche 10 octobre 2004 12:14
> ? : mod_python user mailing list
> Objet : Re: [mod_python] Udate python modules without 
> restarting Apache
> 
> 
> On 10/10/2004, at 1:55 PM, Graham Dumpleton wrote:
> 
> > The point I am trying to make is that perhaps locking shouldn't 
> > pertain just to the global data and that executable code should in 
> > some way be protected as well.
> > It needs more exploration, but perhaps the module should read 
> > something like the following (untested).
> >
> >   if not globals().has_key("datalock"):
> >     # This is a brand new import and we are inside the scope of the
> >     # import lock, so this should all be safe to execute.
> >
> >     datalock = Lock()
> >     codelock = Lock()
> >
> >     myglobal1 = None
> >     myglobal2 = None
> >     myglobal3 = None
> >
> >     ... arbitrary code to initialise globals
> >
> >   codelock.acquire()
> >   datalock.acquire()
> >
> >   ... extra code to fiddle the globals
> >
> >   def modify1(req):
> >     datalock.acquire()
> >     ...
> >     datalock.unlock()
> >     return value
> >
> >   def modify2(req,value):
> >     datalock.acquire()
> >     ...
> >     datalock.unlock()
> >
> >   def _handler(req):
> >     value = modify1(req)
> >     modify2(req,value)
> >     ...
> >
> >   def handler(req):
> >     # code for this method should never be changed
> >     try:
> >       codelock.acquire()
> >       result = _handler(req)
> >     finally:
> >       codelock.unlock()
> >     return result
> >
> >   datalock.unlock()
> >   codelock.unlock()
> >
> > What is trying to be done here is using a lock to ensure 
> that any code 
> > itself is not replaced while the handler is being executed. 
> The reason 
> > for two level handler arrangement, is that the lock 
> actually needs to 
> > be acquired outside of the real handler method being 
> called. If it is 
> > done inside, it is too late, as Python has already grabbed the 
> > existing code for handler and if it gets replaced prior to the lock 
> > being acquired, everything may have changed.
> >
> > Am I being too paranoid? I don't understand enough about 
> how code gets 
> > replaced when a module reload is occurring.
> 
> Hmmm, maybe gone slightly too far here. The code lock 
> effectively serialises access to the handler, which screws up 
> the whole idea of having threads in the first place.
> 
> I really like this idea of using execfile() as described in 
> other email and copying across state variables of interest 
> into a new module, as avoids the need for the code lock 
> anyway as new code constructed in new module.
> 
> --
> Graham Dumpleton (grahamd@dscpl.com.au)
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 


From nicolas at lehuen.com  Sun Oct 10 15:34:52 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Sun Oct 10 08:34:57 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <20041010121252.23C35C347@postfix3-2.free.fr>
Message-ID: <20041010123454.79B67C9C0@postfix3-2.free.fr>

Note that there is a huge caveat to all this, however : currently,
mod_python does not properly handle the loading of handlers modules in a
thread-safe way. This means that if your web site is under a steady load,
requiring many thread to process requests all the time, then when you're
restarting your Apache server, you'll see many messages from mod_python in
the error log stating that the handler is (re)loaded (this can happen even
with all handlers, even with mod_python.publisher).

I don't know precisely yet what is the impact of this bug, but it does at
least means than at initialization time, you may have many module caches in
memory whereas you'd wanted to have only one. Thus, at least during
initialisation, you don't benefit from data sharing. The least I can say is
that I find this disheartening.

When writing application server code (and I did write quite a bunch in a
former life), threading should be your first issue, not an after thought.
But I guess this is a cultural problem coming for the Linux forking MPM
heritage ; maybe people aren't used to use threads on Linux. Well, I guess
I'm not the only Win32 or MacOS/X guy out there that would like a better
support for threads in mod_python... I could have a look and try to fix this
bug, but I still have no news from the previous patch I've submitted...

Regards,

Nicolas

> -----Message d'origine-----
> De : mod_python-bounces@modpython.org 
> [mailto:mod_python-bounces@modpython.org] De la part de Nicolas Lehuen
> Envoy? : dimanche 10 octobre 2004 14:13
> ? : 'Graham Dumpleton'; 'mod_python user mailing list'
> Objet : RE: [mod_python] Udate python modules without 
> restarting Apache
> 
> Hi Graham,
> 
> First thank you for your thorough anaylisis of the imp module 
> behaviour in a multi-threaded environment. This reinforce my 
> feeling that NOT using this module is way better for my 
> publisher since I can precisely understand what it does 
> without depending on any arcane locking mechanisms. With my 
> publisher, I know precisely what the locking policy is. Have 
> a look at the Cache recipe :
> 
> http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/302997
> 
> The trick I used to reduce cache contention is to have a two 
> levels locking scheme. The first level is a lock for the 
> whole cache, used to make sure that not two entries are 
> created for the same key (here the key is the file name of 
> the module). The second level is an entry-specific lock which 
> is used to make sure that a module cannot be initialized by 
> more than one thread. This two level locking enable multiple 
> threads to handle different modules concurrently : the 
> possibly lengthy module initialisation process is done within 
> a module-specific lock, so other thread can initialize other 
> modules concurrently.
> 
> So what happens when a page is accessed by my publisher ?
> 
> 1) the publisher determines what file is targeted by the http 
> request, just by using req.filename
> 2) the publisher get the module keyed by the filename from 
> the module cache
> 3) the publisher calls a special callable object in the module
> (http_handler) or find one by applying acquisition semantics.
> 
> At this high level, no locking is required. If the module 
> needs to be reloaded, the threads which have already reached 
> the step 3 will keep on using the stale module. Once they are 
> over, the stale module will be dereferenced and eventually 
> garbage collected (with all objects it contains). Meanwhile, 
> new threads arriving at step 2 will get the new module. All 
> is well that ends well.
> 
> Now if we study what's happening at step 2 when a module is 
> already up to date, then we see that we first acquire a lock 
> on the module cache during a very brief amount of time (just 
> to get the entry for the filename), then a lock on the module 
> itself for another brief amount of time (just to check that 
> the module is indeed up to date). Thereafter, all thread are 
> on their own to do whatever they need in parallel.
> 
> So we have indeed a very small contention point where all 
> requests are serialized, then another small contention point 
> where all requests targeted at the same module are 
> serialized, then no more contention until the request is 
> over. That is to say, all the hard work (database requests, 
> file processing, template rendering etc.) is indeed done in 
> multiple concurrent threads.
> 
> I don't see how this can be done in a better way. In any 
> case, you certainly should NOT acquire a lock and do all the 
> request processing within this lock, like you wrote below... 
> This effectively kills any multi-threaded attempt.
> 
> The best part with having properly managed modules is that 
> you can instantiate long-living objects that are shared 
> between multiple threads in the modules. The best example is 
> a thread-safe DB connection pool. In fact, my publisher 
> automatically looks if the module targeted by a request has 
> special callable objects named 'prepare', 'commit', 
> 'rollback' and 'release'. In those methods, a developper can 
> write some code to manage DB connections. The net result is 
> that in most of my application, I only have to write 
> req.cursor to have a safe pooled cursor to the database I 
> use. I don't have to worry anymore about opening / closing DB 
> connections !
> 
> In fact, I extended this behaviour : when a page module is 
> loaded, the publisher looks for a 'global.pyapp' file which 
> contains a Python module shared by all modules found in the 
> same directory. This 'global.pyapp' file is an 
> application-wide module which usually defines global objects 
> such as the aformentioned DB connection pool, plus the same 
> special methods 'prepare', 'commit', 'rollback', 'release' 
> that are called before the ones from the targeted module. 
> This is equivalent to the 'global.asa' files found in Microsoft's ASP.
> 
> I plan on releasing my code on the web, but I'm missing the 
> time to build a proper web site for now...
> 
> Anyway, thanks for this interesting discussion :)
> 
> Regards,
> 
> Nicolas
> 
>  
> 
> > -----Message d'origine-----
> > De : mod_python-bounces@modpython.org 
> > [mailto:mod_python-bounces@modpython.org] De la part de Graham 
> > Dumpleton Envoy? : dimanche 10 octobre 2004 12:14 ? : 
> mod_python user 
> > mailing list Objet : Re: [mod_python] Udate python modules without 
> > restarting Apache
> > 
> > 
> > On 10/10/2004, at 1:55 PM, Graham Dumpleton wrote:
> > 
> > > The point I am trying to make is that perhaps locking shouldn't 
> > > pertain just to the global data and that executable code 
> should in 
> > > some way be protected as well.
> > > It needs more exploration, but perhaps the module should read 
> > > something like the following (untested).
> > >
> > >   if not globals().has_key("datalock"):
> > >     # This is a brand new import and we are inside the 
> scope of the
> > >     # import lock, so this should all be safe to execute.
> > >
> > >     datalock = Lock()
> > >     codelock = Lock()
> > >
> > >     myglobal1 = None
> > >     myglobal2 = None
> > >     myglobal3 = None
> > >
> > >     ... arbitrary code to initialise globals
> > >
> > >   codelock.acquire()
> > >   datalock.acquire()
> > >
> > >   ... extra code to fiddle the globals
> > >
> > >   def modify1(req):
> > >     datalock.acquire()
> > >     ...
> > >     datalock.unlock()
> > >     return value
> > >
> > >   def modify2(req,value):
> > >     datalock.acquire()
> > >     ...
> > >     datalock.unlock()
> > >
> > >   def _handler(req):
> > >     value = modify1(req)
> > >     modify2(req,value)
> > >     ...
> > >
> > >   def handler(req):
> > >     # code for this method should never be changed
> > >     try:
> > >       codelock.acquire()
> > >       result = _handler(req)
> > >     finally:
> > >       codelock.unlock()
> > >     return result
> > >
> > >   datalock.unlock()
> > >   codelock.unlock()
> > >
> > > What is trying to be done here is using a lock to ensure 
> > that any code 
> > > itself is not replaced while the handler is being executed. 
> > The reason 
> > > for two level handler arrangement, is that the lock 
> > actually needs to 
> > > be acquired outside of the real handler method being 
> > called. If it is 
> > > done inside, it is too late, as Python has already grabbed the 
> > > existing code for handler and if it gets replaced prior 
> to the lock 
> > > being acquired, everything may have changed.
> > >
> > > Am I being too paranoid? I don't understand enough about 
> > how code gets 
> > > replaced when a module reload is occurring.
> > 
> > Hmmm, maybe gone slightly too far here. The code lock 
> > effectively serialises access to the handler, which screws up 
> > the whole idea of having threads in the first place.
> > 
> > I really like this idea of using execfile() as described in 
> > other email and copying across state variables of interest 
> > into a new module, as avoids the need for the code lock 
> > anyway as new code constructed in new module.
> > 
> > --
> > Graham Dumpleton (grahamd@dscpl.com.au)
> > 
> > _______________________________________________
> > Mod_python mailing list
> > Mod_python@modpython.org
> > http://mailman.modpython.org/mailman/listinfo/mod_python
> > 
> 
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 


From alexis.boutillier at arteris.net  Mon Oct 11 12:29:25 2004
From: alexis.boutillier at arteris.net (Alexis Boutillier)
Date: Mon Oct 11 05:29:29 2004
Subject: [mod_python] segFault or "invalid literal for float" when doing a
	SELECT
Message-ID: <1097486965.2101.55.camel@cesar.arteris.net>

I try to use mod_pytohn with MySQLdb and have this problem when trying
to do a select : there is my code :

def handler(req):
	db =
MySQLdb.connect(mysqlHost,mysqlUser,mysqlPasswd,mysqlDb,compress=1,cursorclass=MySQLdb.cursors.DictCursor)
	cur=db.cursor()
	t = cur.execute("SELECT TestDriverId,Title FROM TestDrivers")
	res = cur.fetchall()
	req.write(str(res))

And i got this reponse. therefore, sometimes, i got the correct answer.

I also try to do a "SELECT * FROM TestDrivers" but this hand in a
segfault of the child.

Mod_python error: "PythonHandler form"

Traceback (most recent call last):

  File "/soft/Python/lib/python2.3/site-packages/mod_python/apache.py", line 299, in HandlerDispatch

  File "/usr/local/apache2/python/form.py", line 34, in handler
    t = cur.execute("SELECT * FROM TestDrivers")

  File "/var/tmp/MySQL-python-buildroot/usr//lib/python/MySQLdb/cursors.py", line 95, in execute

  File "/var/tmp/MySQL-python-buildroot/usr//lib/python/MySQLdb/cursors.py", line 114, in _execute

  File "/var/tmp/MySQL-python-buildroot/usr//lib/python/MySQLdb/connections.py", line 33, in defaulterrorhandler

ValueError: invalid literal for float(): test1
-- 
Boutillier Alexis
Methodology engineer

Arteris SA
The Network-on-Chip Company TM
www.arteris.net

6 par Ariane Immeuble Mercure
78284 Guyancourt Cedex
France
Office: (+33) 1 61 37 38 71
Fac:    (+33) 1 61 37 38 41
Alexis.Boutillier@arteris.net

From erik at vontaene.de  Mon Oct 11 14:07:28 2004
From: erik at vontaene.de (Erik Andresen)
Date: Mon Oct 11 07:07:32 2004
Subject: [mod_python] mod_python mptest does not interpret
Message-ID: <32804.213.39.134.88.1097492848.squirrel@213.39.134.88>

Hello,

I'm new here and the last 2 hours I was trying to get mod_python working
on my apache 1.3 (debian sarge).

Following your documentation I'm loading mod_python and have this is my
config:
<Directory /usr/local/httpd/htdocs/python>
        AddHandler mod_python .py
        PythonHandler mptest
        PythonDebug On
</Directory>

The directory /usr/local/httpd/htdocs/python really is correct,
/usr/local/httpd/htdocs/ is my DocumentRoot.

But now when trying to access http://defiant.homedns.org/python/mptest.py
I just get the plain text file.

I have
application/x-python-code                       pyc pyo
text/x-python                                   py
in my mime.types. One page suggest to delete the entry text/x-python tried
that, but that doesn't change anything.
I also tried adding
'AddType application/x-program-py .py' to the apache config - some
webpages were showing this tip - however some other pages are telling me
_not_ to do this.

However ths python module does not - apache is starting with
Apache/1.3.31 (Debian GNU/Linux) PHP/4.3.9-1 mod_python/2.7.10
Python/2.2.3+ configured -- resuming normal operations

any ideas would be nice,

Erik Andresen


From bray at sent.com  Mon Oct 11 08:50:13 2004
From: bray at sent.com (bray@sent.com)
Date: Mon Oct 11 08:50:16 2004
Subject: [mod_python] mod_python mptest does not interpret
In-Reply-To: <32804.213.39.134.88.1097492848.squirrel@213.39.134.88>
References: <32804.213.39.134.88.1097492848.squirrel@213.39.134.88>
Message-ID: <1097499013.3039.206202159@webmail.messagingengine.com>


On Mon, 11 Oct 2004 13:07:28 +0200 (CEST), "Erik Andresen"
<erik@vontaene.de> said:
> Hello,
> 
> I'm new here and the last 2 hours I was trying to get mod_python working
> on my apache 1.3 (debian sarge).
> 
> Following your documentation I'm loading mod_python and have this is my
> config:
> <Directory /usr/local/httpd/htdocs/python>
>         AddHandler mod_python .py
>         PythonHandler mptest
>         PythonDebug On
> </Directory>
> 

maybe try:

      SetHandler python-program

instead of AddHandler.


-- 
  
  bray@sent.com

From grisha at modpython.org  Mon Oct 11 11:30:56 2004
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Mon Oct 11 10:31:08 2004
Subject: [mod_python] segFault or "invalid literal for float" when doing
	a SELECT
In-Reply-To: <1097486965.2101.55.camel@cesar.arteris.net>
References: <1097486965.2101.55.camel@cesar.arteris.net>
Message-ID: <20041011103022.B31262@onyx.ispol.com>


This sounds like a MySQLdb rather than a mod_python problem.

Grisha

On Mon, 11 Oct 2004, Alexis Boutillier wrote:

> I try to use mod_pytohn with MySQLdb and have this problem when trying
> to do a select : there is my code :
>
> def handler(req):
> 	db =
> MySQLdb.connect(mysqlHost,mysqlUser,mysqlPasswd,mysqlDb,compress=1,cursorclass=MySQLdb.cursors.DictCursor)
> 	cur=db.cursor()
> 	t = cur.execute("SELECT TestDriverId,Title FROM TestDrivers")
> 	res = cur.fetchall()
> 	req.write(str(res))
>
> And i got this reponse. therefore, sometimes, i got the correct answer.
>
> I also try to do a "SELECT * FROM TestDrivers" but this hand in a
> segfault of the child.
>
> Mod_python error: "PythonHandler form"
>
> Traceback (most recent call last):
>
>  File "/soft/Python/lib/python2.3/site-packages/mod_python/apache.py", line 299, in HandlerDispatch
>
>  File "/usr/local/apache2/python/form.py", line 34, in handler
>    t = cur.execute("SELECT * FROM TestDrivers")
>
>  File "/var/tmp/MySQL-python-buildroot/usr//lib/python/MySQLdb/cursors.py", line 95, in execute
>
>  File "/var/tmp/MySQL-python-buildroot/usr//lib/python/MySQLdb/cursors.py", line 114, in _execute
>
>  File "/var/tmp/MySQL-python-buildroot/usr//lib/python/MySQLdb/connections.py", line 33, in defaulterrorhandler
>
> ValueError: invalid literal for float(): test1
> --
> Boutillier Alexis
> Methodology engineer
>
> Arteris SA
> The Network-on-Chip Company TM
> www.arteris.net
>
> 6 par Ariane Immeuble Mercure
> 78284 Guyancourt Cedex
> France
> Office: (+33) 1 61 37 38 71
> Fac:    (+33) 1 61 37 38 41
> Alexis.Boutillier@arteris.net
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From gnb at itga.com.au  Tue Oct 12 10:19:19 2004
From: gnb at itga.com.au (Gregory Bond)
Date: Mon Oct 11 19:19:40 2004
Subject: [mod_python] segFault or "invalid literal for float" when doing
	a	SELECT
In-Reply-To: <1097486965.2101.55.camel@cesar.arteris.net>
References: <1097486965.2101.55.camel@cesar.arteris.net>
Message-ID: <416B14F7.5080908@itga.com.au>

Alexis Boutillier wrote:

>I try to use mod_pytohn with MySQLdb and have this problem when trying
>to do a select : there is my code :
>   
>
http://www.modpython.org/FAQ/faqw.py?req=show&file=faq02.013.htp
From johannes at erdfelt.com  Tue Oct 12 18:37:08 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Tue Oct 12 20:37:14 2004
Subject: [mod_python] does add_handler even work?
Message-ID: <20041013003708.GS32367@sventech.com>

I'm trying to develop a mod_python application, but I'm having problems
using Apache 2.0.51 and mod_python 3.1.3.

I'm trying to use the add_handler() method from the request object to
add a request handler after I've determined the URL is one I want to
handle. Unfortunately, it doesn't seem to work. I always get a 404
error.

Some example code I've written:

from mod_python import apache

def authenhandler(req):
  req.add_handler("PythonHandler", "aptest")
  return apache.OK

def handler(req):
  req.content_type = 'text/plain'
  req.write("foobar\nbaz\n")
  return apache.OK

Then in my Apache configuration, I have:

PythonPath "sys.path+['/tmp/python']
PythonAuthenHandler aptest
PythonHandler aptest

I've tried using the Init, Trans and Fixup handlers too, with no
success.

If I add a SetHandler, then everything works, but then other modules
like PHP and mod_autoindex stop working.

Has anyone been able to use add_handler successfully?

Unrelated to the actual problem I'm having with add_handler(), the
reason I want to do this is because AddHandler isn't sufficient (I want
to handle multiple types of filename extensions and no extension).

JE

From grahamd at dscpl.com.au  Tue Oct 12 21:26:06 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 12 22:26:16 2004
Subject: [mod_python] does add_handler even work?
In-Reply-To: <20041013003708.GS32367@sventech.com>
Message-ID: <1097634363.25785@dscpl.com.au>

On Oct 12 17:37, Johannes Erdfelt <johannes@erdfelt.com> wrote:
>
> Subject: [mod_python] does add_handler even work?
>
> Unrelated to the actual problem I'm having with add_handler(), the
> reason I want to do this is because AddHandler isn't sufficient (I want
> to handle multiple types of filename extensions and no extension).

If you want to be able to handle multiple extension types, or no extension
at all, all for the same base resource, or not as case may be, then go and
have a look at Vampire.

What Vampire does is bring the decision of mapping extensions to handlers
into the scope of Python code rather than relying on AddHandler/SetHandler
exclusively. Bringing the decision into the Python code allows a bit more
flexibility in what you can do and thus you can do exactly what you are
wanting with Vampire.

Vampire can be found at:

  http://www.dscpl.com.au/projects/vampire

Be warned that Vampire should only be used in "prefork" Apache at the
moment. I know exactly what needs to be done to make it work in threaded
MPMs, but interest in the package ,and thus motivation for me to do that,
has been minimal. If a threaded MPS is what you use and you want to use
Vampire, let me know and I'll up the priority of making the changes. ;-)

--
Graham Dumpleton (grahamd@dscpl.com.au)
From johannes at erdfelt.com  Tue Oct 12 20:31:26 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Tue Oct 12 22:31:36 2004
Subject: [mod_python] does add_handler even work?
In-Reply-To: <1097634363.25785@dscpl.com.au>
References: <20041013003708.GS32367@sventech.com>
	<1097634363.25785@dscpl.com.au>
Message-ID: <20041013023126.GT32367@sventech.com>

On Tue, Oct 12, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> On Oct 12 17:37, Johannes Erdfelt <johannes@erdfelt.com> wrote:
> >
> > Subject: [mod_python] does add_handler even work?
> >
> > Unrelated to the actual problem I'm having with add_handler(), the
> > reason I want to do this is because AddHandler isn't sufficient (I want
> > to handle multiple types of filename extensions and no extension).
> 
> If you want to be able to handle multiple extension types, or no extension
> at all, all for the same base resource, or not as case may be, then go and
> have a look at Vampire.
> 
> What Vampire does is bring the decision of mapping extensions to handlers
> into the scope of Python code rather than relying on AddHandler/SetHandler
> exclusively. Bringing the decision into the Python code allows a bit more
> flexibility in what you can do and thus you can do exactly what you are
> wanting with Vampire.
> 
> Vampire can be found at:
> 
>   http://www.dscpl.com.au/projects/vampire
> 
> Be warned that Vampire should only be used in "prefork" Apache at the
> moment. I know exactly what needs to be done to make it work in threaded
> MPMs, but interest in the package ,and thus motivation for me to do that,
> has been minimal. If a threaded MPS is what you use and you want to use
> Vampire, let me know and I'll up the priority of making the changes. ;-)

I looked at Vampire at one point and it too seems to have the same
problem with PHP and autoindex as I've been running into.

Or am I mistaken?

JE

From grahamd at dscpl.com.au  Tue Oct 12 22:34:35 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 12 23:34:38 2004
Subject: [mod_python] does add_handler even work?
In-Reply-To: <20041013023126.GT32367@sventech.com>
Message-ID: <1097638472.34425@dscpl.com.au>

On Oct 12 19:31, Johannes Erdfelt <johannes@erdfelt.com> wrote:
>
> Subject: Re: [mod_python] does add_handler even work?
>
> On Tue, Oct 12, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> > On Oct 12 17:37, Johannes Erdfelt <johannes@erdfelt.com> wrote:
> > 
> > Vampire can be found at:
> > 
> >   http://www.dscpl.com.au/projects/vampire
> 
> I looked at Vampire at one point and it too seems to have the same
> problem with PHP and autoindex as I've been running into.
> 
> Or am I mistaken?

Try adding the following after the SetHandler for mod_python.

  <Files *.php>
  SetHandler None
  </Files>

For example, in my .htaccess file I have put:

  SetHandler python-program
  PythonHandler vampire

  <Files *.php>
  SetHandler None
  </Files>

Just for .php files, it should undo the SetHandler directive used above that point.
 his appears to now allow me to dump PHP files in the same directory as that
managed by mod_python using a SetHandler directive.

In respect of mod_autoindex, is the problem you have that with Apache 1.3, a
reference against the directory would still honour setting of DirectoryIndex and
thus redirect to index.html as an example, but with Apache 2.0 it doesn't?

I found this problem with Apache 2.0 as well, although I note that in Apache 1.3
it only worked for the top level directory managed by mod_python. If there were
subdirectories under that, it wouldn't work for them anyway.

In Vampire 1.1 I specifically have a setting, eg:

  PythonOption VampireDirectoryIndex index.html

to get around this problem. That is, I handle the redirection with Vampire when a
directory access occurs. With Apache 1.3, I use a HTTP redirect, but with Apache 2.0
I use an internal redirect.

I have an actual note about this issue on updated web page I put up for Vampire 1.1.

Hope this helps.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From grahamd at dscpl.com.au  Tue Oct 12 23:50:45 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Oct 13 00:50:51 2004
Subject: [mod_python] does add_handler even work?
In-Reply-To: <1097638472.34425@dscpl.com.au>
Message-ID: <1097643041.43290@dscpl.com.au>

On Oct 12 21:34, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>
> In respect of mod_autoindex, is the problem you have that with Apache 1.3, a
> reference against the directory would still honour setting of DirectoryIndex and
> thus redirect to index.html as an example, but with Apache 2.0 it doesn't?
> 
> I found this problem with Apache 2.0 as well, although I note that in Apache 1.3
> it only worked for the top level directory managed by mod_python. If there were
> subdirectories under that, it wouldn't work for them anyway.
> 
> In Vampire 1.1 I specifically have a setting, eg:
> 
>   PythonOption VampireDirectoryIndex index.html
> 
> to get around this problem. That is, I handle the redirection with Vampire when a
> directory access occurs. With Apache 1.3, I use a HTTP redirect, but with Apache 2.0
> I use an internal redirect.
> 
> I have an actual note about this issue on updated web page I put up for Vampire 1.1.

Hmmm, checking some things, I actually find my VampireDirectoryIndex isn't
working on Apache 1.3 after all, and normal directory index stuff is going into
subdirectories okay. At least on one web site this is the case, I originally tested
it on another, so Apache config may have something to do with it.

I am reasonably confident though that DirectoryIndex wasn't working on Apache 2.0
in the same way which was why I came up with VampireDirectoryIndex in the first
place. I'll have to revisit and test all this again under a few web servers and try
and make better sense of it.

But then, all this stuff is related to mod_dir and not mod_autoindex. I'm confused,
so best to just ignore me. :-)

--
Graham Dumpleton (grahamd@dscpl.com.au)
From sanders at apache.org  Tue Oct 12 23:11:07 2004
From: sanders at apache.org (Scott Sanders)
Date: Wed Oct 13 01:18:21 2004
Subject: [mod_python] does add_handler even work?
In-Reply-To: <20041013003708.GS32367@sventech.com>
References: <20041013003708.GS32367@sventech.com>
Message-ID: <4A21E616-1CD6-11D9-89A5-000A95D2D288@apache.org>

>
> If I add a SetHandler, then everything works, but then other modules
> like PHP and mod_autoindex stop working.
>
You either need to add the optional type after the SetHandler, or with 
your AddHandler, your handler needs to return apache.DECLINED on 
requests that you do not want to handle.

Hope this helps.

Scott

From johannes at erdfelt.com  Wed Oct 13 00:15:53 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Wed Oct 13 02:15:56 2004
Subject: [mod_python] does add_handler even work?
In-Reply-To: <4A21E616-1CD6-11D9-89A5-000A95D2D288@apache.org>
References: <20041013003708.GS32367@sventech.com>
	<4A21E616-1CD6-11D9-89A5-000A95D2D288@apache.org>
Message-ID: <20041013061553.GK14882@sventech.com>

On Tue, Oct 12, 2004, Scott Sanders <sanders@apache.org> wrote:
> >
> >If I add a SetHandler, then everything works, but then other modules
> >like PHP and mod_autoindex stop working.
>
> You either need to add the optional type after the SetHandler

I don't see an option type for SetHandler. Atleast the docs don't list
it:

http://httpd.apache.org/docs-2.0/mod/core.html#sethandler

> or with 
> your AddHandler, your handler needs to return apache.DECLINED on 
> requests that you do not want to handle.

The problem is that AddHandler catches too few requests, not that it
catches too many requests.

I was really hoping for a way I could look at all requests and decline
the ones I don't want, while still letting other modules (like PHP and
autoindex) to work normally.

JE

From grahamd at dscpl.com.au  Wed Oct 13 01:25:06 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Oct 13 02:25:11 2004
Subject: [mod_python] does add_handler even work?
In-Reply-To: <4A21E616-1CD6-11D9-89A5-000A95D2D288@apache.org>
Message-ID: <1097648702.55681@dscpl.com.au>

On Oct 12 22:11, Scott Sanders <sanders@apache.org> wrote:
>
> Subject: Re: [mod_python] does add_handler even work?
>
> >
> > If I add a SetHandler, then everything works, but then other modules
> > like PHP and mod_autoindex stop working.
> >
> You either need to add the optional type after the SetHandler, or with 
> your AddHandler, your handler needs to return apache.DECLINED on 
> requests that you do not want to handle.

According to Apache documentation, you can't supply anything after the
SetHandler directive. If you do add something, you will get an internal
server error deriving from a misconfiguration of your configuration file.

The point of using SetHandler is to have every request under that directory
go through mod_python. This includes those with and without extensions.
Thus, it doesn't make sense to have an extension on SetHandler.

If you wanted to only process certain extensions, you would have used
AddHandler in the first place, which is what it is for. The problem is that the
AddHandler directive can't be used to intercept requests which don't have
any extension at all, thus why one ends up having to use SetHandler
if you want to catch those cases where there is no specific extension.

Having a content handler return apache.DECLINED doesn't help in the case
of PHP, because even though the request is passed back to Apache by
mod_python, the SetHandler directive seems to cause Apache not to
pass the file through the PHP module for processing. All it does when the
value apache.DECLINED is returned is return the raw PHP file, unprocessed.

This is why the solution seems to be to explicitly disable the SetHandler
altogether when the request is for a .php file. Ie.,

  SetHandler python-program
  PythonHandler vampire

  <Files *.php>
  SetHandler None
  </Files>

What happens when this is done, is that for a .php file, Apache doesn't even
bother handing off to mod_python and sends it direct to the PHP module.
Thus, returning apache.DECLINED isn't relevant anyway, as never gets to
that point.

Hopefully this more detailed explaination than my previous email is useful.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From grahamd at dscpl.com.au  Wed Oct 13 21:42:10 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Oct 13 22:42:31 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <67CC741B-1A99-11D9-AAF9-000393DCF16E@dscpl.com.au>
Message-ID: <1097721726.4879@dscpl.com.au>

On Oct 10 18:50, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>
> When using combination of imp.find_module() and imp.load_module(), main 
> thing  is that it is a true module. Ie., result of calling type() on the 
> result will actually be <type 'module'>.
> 
> Taking a simple module which contains:
> 
>    variable = 0
>    def function(): pass
> 
> If this module is imported using imp.load_module(), result is same as 
> "import" and running dir() on the module yields the following.
> 
>    ['__builtins__', '__doc__', '__file__', '__name__', 'function', 
> 'variable']
> 
> If one uses execfile() however, the result is simply a dictionary, ie., 
> type() yields <type 'dict'>. The results of calling keys() on that
> dictionary yields the following.
> 
>    ['__builtins__', 'variable', 'function']
> 
> In terms of executing code within the context of the two, there 
> probably isn't going to be much difference. The only issue would
> be if the code being loaded had expected it to be executing
> within the environment of a true module. Ie., that it expected
> __file__ and __name__ to actually exist.

FWIW, if using execfile() I have since found that it is probably better
to use:

  import imp
  module = imp.new_module("z")
  module.__file__ = "z.py"
  execfile("z.py",module.__dict__)

That way, executing type() on the module gives <type 'module'> and thus
things one expects to work on modules will. The imp.new_module() method
does not result in the module being listed in sys.modules.  

--
Graham Dumpleton (grahamd@dscpl.com.au)
From fumanchu at amor.org  Wed Oct 13 23:02:54 2004
From: fumanchu at amor.org (Robert Brewer)
Date: Thu Oct 14 01:03:39 2004
Subject: [mod_python] bug in apache.build_cgi_env
Message-ID: <3A81C87DC164034AA4E2DDFE11D258E3022F81@exchange.hqamor.amorhq.net>

Hi,

I'm running mod_python (3.1.3-win32) and trying to write a WSGI wrapper
for it. I figured I'd call apache.build_cgi_env to get an environ dict,
but I get the following error message:

  File "C:\Python23\lib\site-packages\mod_python\apache.py", line 541,
in build_cgi_env
    if len(req.path_info) > 0:

TypeError: len() of unsized object


I've already worked around it, but the function in question is:

def build_cgi_env(req):
    """
    Utility function that returns a dictionary of
    CGI environment variables as described in
    http://hoohoo.ncsa.uiuc.edu/cgi/env.html
    """

    req.add_common_vars()
    env = req.subprocess_env.copy()
    
    if len(req.path_info) > 0:
        env["SCRIPT_NAME"] = req.uri[:-len(req.path_info)]
    else:
        env["SCRIPT_NAME"] = req.uri

    env["GATEWAY_INTERFACE"] = "Python-CGI/1.1"

    # you may want to comment this out for better security
    if req.headers_in.has_key("authorization"):
        env["HTTP_AUTHORIZATION"] = req.headers_in["authorization"]

    return env


With a little printlining, it seems my req.path_info is None, and
therefore has no length. Could we just write the following instead? It
fixed the problem for me.

    if req.path_info:
        env["SCRIPT_NAME"] = req.uri[:-len(req.path_info)]
    else:
        env["SCRIPT_NAME"] = req.uri


Thanks for your time,


Robert Brewer
MIS
Amor Ministries
fumanchu@amor.org

From nicolas at lehuen.com  Thu Oct 14 12:32:05 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Thu Oct 14 05:32:24 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <1097721726.4879@dscpl.com.au>
Message-ID: <200410140932.i9E9WLSW000815@modpython.org>

 

> -----Message d'origine-----
> De : Graham Dumpleton [mailto:grahamd@dscpl.com.au] 
> Envoy? : jeudi 14 octobre 2004 04:42
> ? : Nicolas Lehuen
> Cc : mod_python@modpython.org
> Objet : Re: [mod_python] Udate python modules without 
> restarting Apache
> 
> On Oct 10 18:50, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> >
> > When using combination of imp.find_module() and imp.load_module(), 
> > main thing  is that it is a true module. Ie., result of 
> calling type() 
> > on the result will actually be <type 'module'>.
> > 
> > Taking a simple module which contains:
> > 
> >    variable = 0
> >    def function(): pass
> > 
> > If this module is imported using imp.load_module(), result 
> is same as 
> > "import" and running dir() on the module yields the following.
> > 
> >    ['__builtins__', '__doc__', '__file__', '__name__', 'function', 
> > 'variable']
> > 
> > If one uses execfile() however, the result is simply a dictionary, 
> > ie.,
> > type() yields <type 'dict'>. The results of calling keys() on that 
> > dictionary yields the following.
> > 
> >    ['__builtins__', 'variable', 'function']
> > 
> > In terms of executing code within the context of the two, there 
> > probably isn't going to be much difference. The only issue 
> would be if 
> > the code being loaded had expected it to be executing within the 
> > environment of a true module. Ie., that it expected __file__ and 
> > __name__ to actually exist.
> 
> FWIW, if using execfile() I have since found that it is 
> probably better to use:
> 
>   import imp
>   module = imp.new_module("z")
>   module.__file__ = "z.py"
>   execfile("z.py",module.__dict__)
> 
> That way, executing type() on the module gives <type 
> 'module'> and thus things one expects to work on modules 
> will. The imp.new_module() method does not result in the 
> module being listed in sys.modules.  
> 
> --
> Graham Dumpleton (grahamd@dscpl.com.au)
> 

Ok, thanks for the tip, Graham.

I thought about using new.module(), but there was no information about it
tinkering with sys.modules (though it seemed that it did not). I didn't see
imp.new_module().

Having a look at new.module, it seems that new.module == types.ModuleType ==
type(sys). So a call to new.module is basically an instanciation of the
module class. imp.new_module() is natively implemented :

static PyObject *
imp_new_module(PyObject *self, PyObject *args)
{
	char *name;
	if (!PyArg_ParseTuple(args, "s:new_module", &name))
		return NULL;
	return PyModule_New(name);
}

So I guess those two function do exactly the same thing. I'll modify my
ModuleCache to use imp.new_module instead of a fake Module object.

Regards,

Nicolas


From grahamd at dscpl.com.au  Thu Oct 14 22:10:05 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct 14 07:10:15 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <200410140932.i9E9WMja052337@dscpl.com.au>
References: <200410140932.i9E9WMja052337@dscpl.com.au>
Message-ID: <9A47AFDC-1DD1-11D9-AEE8-000393DCF16E@dscpl.com.au>


On 14/10/2004, at 7:32 PM, Nicolas Lehuen wrote:
>> FWIW, if using execfile() I have since found that it is
>> probably better to use:
>>
>>   import imp
>>   module = imp.new_module("z")
>>   module.__file__ = "z.py"
>>   execfile("z.py",module.__dict__)
>>
>> That way, executing type() on the module gives <type
>> 'module'> and thus things one expects to work on modules
>> will. The imp.new_module() method does not result in the
>> module being listed in sys.modules.
>
> Ok, thanks for the tip, Graham.
>
> ...
>
> So I guess those two function do exactly the same thing. I'll modify my
> ModuleCache to use imp.new_module instead of a fake Module object.

Another thing I have done is to implement the cloning mechanism for 
data that I
mentioned in my prior emails. Ie.,

         module = imp.new_module(label)
         module.__file__ = file
         if hasattr(cache.module,"__clone__") and \
             callable(cache.module.__clone__):
           cache.module.__clone__(module)
         execfile(file,module.__dict__)
         cache.module = module

Thus, although the newly loaded module is constructed into a fresh 
module, there is
the option of copying over selected data from the existing module. This 
is done by
calling a __clone__() method if present in the existing module to 
populate the fresh
module before loading the code in. Because it is a function, any 
necessary code
could be put in it, including code which acquires any locks while 
copying the data.

For example, a content handler might contain:

   from threading import Lock

   # This method prior to execfile() being run, but only
   # when the module had previously been loaded.

   def __clone__(module):
     _lock.acquire()
     module._lock = _lock
     module._data = _data
     _data["reloads"] = _data["reloads"] + 1
     _lock.release()

   # This global scope code executed when execfile() run.
   # Check that data doesn't already exist, as don't want
   # to overwrite it if it does. This will be the case
   # when it is copied from existing module.

   if not globals().has_key("_lock"):
     _lock = Lock()
     _data = { "reloads" : 0 }

   # Data which should always be reset on fresh import
   # would still follow here.

   _cache = {}

Using execfile() on a fresh module and using __clone__() in this way 
solves some of the
problems I mentioned in my prior emails.

First, because a fresh module is used, you don't get problems with code 
being modified
while another thread may be executing in the context of the existing 
module that would
have otherwise been overwritten.

You can selectively copy over only the data which should be present in 
the context of
the code being reconstructed. Ie., you could throw away certain types 
of cached data.
If the modified code had removed functions, they will not show in the 
newly loaded
module.

The use of a method rather than an export list of data to copy across, 
means that locks
can be acquired while data is being copied to prevent another thread 
accessing it at
the same time.

The intent with copying locks and data is that it is shared between old 
and new modules
at least for the period that any existing thread may be executing in 
the context of the
old module. Because the old module will no longer be referenced from 
the cache, once
the thread executing in the context of the old module finishes, the old 
module will
disappear and data will be exclusive to the new module.

This does mean though that any data should really be dictionaries or 
class instances Ie.,
things that can be shared properly and a change through either 
reference is reflected in
the other. Eg.

   >>> a={"a":1}
   >>> b=a
   >>> a
   {'a': 1}
   >>> b
   {'a': 1}
   >>> b["c"]=2
   >>> a
   {'a': 1, 'c': 2}
   >>> b
   {'a': 1, 'c': 2}

This isn't going to work if the data were simple integers or strings, 
as once a copy is
made, a change from one module, by way of assignment, isn't going to be 
reflected in the
other.

You could also feasibly implement fixup code in a new module which 
would be executed upon
the reload to convert data in an old form to a new form, but the danger 
of that is that you
don't know whether a reload may occur for one fixup, before you later 
change the module
again and where the subsequent fixup expects data in the intermediate 
format. If the
format of data is going to change drastically, you should really stop 
Apache, load in
your new code and restart. Otherwise, you would have to use a variable 
which tracks what
version the data format is in and for fixup code be able to cope with 
various older
versions of data when converting to a new format.

Anyway, interesting stuff to play with.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From nicolas at lehuen.com  Thu Oct 14 15:51:15 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Thu Oct 14 08:51:35 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <9A47AFDC-1DD1-11D9-AEE8-000393DCF16E@dscpl.com.au>
Message-ID: <200410141251.i9ECpXSW018182@modpython.org>

This __clone__() method is a very neat idea indeed ! For the moment I prefer
not to keep any data between reloads (what needs to be kept is in the
database), but there may be occurrences where such a mechanisms would be
handy.

Right now I'm trying to use imp.new_module but I get curious results...
Apparently some classes that are imported from other modules are redefined
even though they should not. The net result is that some isinstance() tests
fail where they should not (reminds me of ClassLoader problems in Java). I
tried to build a simple test case exhibiting the problem, but it does not.
What's for sure, is that when I do :

exec source in module.__dict__

If module is a fake module object (a place holder class Module(object):
pass), all my code is OK. If it is a real module, I get weird behaviours.
I'm still investigating on the subject.

Regards,

Nicolas

> -----Message d'origine-----
> De : Graham Dumpleton [mailto:grahamd@dscpl.com.au] 
> Envoy? : jeudi 14 octobre 2004 13:10
> ? : Nicolas Lehuen
> Cc : mod_python@modpython.org
> Objet : Re: [mod_python] Udate python modules without 
> restarting Apache
> 
> 
> On 14/10/2004, at 7:32 PM, Nicolas Lehuen wrote:
> >> FWIW, if using execfile() I have since found that it is probably 
> >> better to use:
> >>
> >>   import imp
> >>   module = imp.new_module("z")
> >>   module.__file__ = "z.py"
> >>   execfile("z.py",module.__dict__)
> >>
> >> That way, executing type() on the module gives <type 'module'> and 
> >> thus things one expects to work on modules will. The 
> imp.new_module() 
> >> method does not result in the module being listed in sys.modules.
> >
> > Ok, thanks for the tip, Graham.
> >
> > ...
> >
> > So I guess those two function do exactly the same thing. 
> I'll modify 
> > my ModuleCache to use imp.new_module instead of a fake 
> Module object.
> 
> Another thing I have done is to implement the cloning 
> mechanism for data that I mentioned in my prior emails. Ie.,
> 
>          module = imp.new_module(label)
>          module.__file__ = file
>          if hasattr(cache.module,"__clone__") and \
>              callable(cache.module.__clone__):
>            cache.module.__clone__(module)
>          execfile(file,module.__dict__)
>          cache.module = module
> 
> Thus, although the newly loaded module is constructed into a 
> fresh module, there is the option of copying over selected 
> data from the existing module. This is done by calling a 
> __clone__() method if present in the existing module to 
> populate the fresh module before loading the code in. Because 
> it is a function, any necessary code could be put in it, 
> including code which acquires any locks while copying the data.
> 
> For example, a content handler might contain:
> 
>    from threading import Lock
> 
>    # This method prior to execfile() being run, but only
>    # when the module had previously been loaded.
> 
>    def __clone__(module):
>      _lock.acquire()
>      module._lock = _lock
>      module._data = _data
>      _data["reloads"] = _data["reloads"] + 1
>      _lock.release()
> 
>    # This global scope code executed when execfile() run.
>    # Check that data doesn't already exist, as don't want
>    # to overwrite it if it does. This will be the case
>    # when it is copied from existing module.
> 
>    if not globals().has_key("_lock"):
>      _lock = Lock()
>      _data = { "reloads" : 0 }
> 
>    # Data which should always be reset on fresh import
>    # would still follow here.
> 
>    _cache = {}
> 
> Using execfile() on a fresh module and using __clone__() in 
> this way solves some of the problems I mentioned in my prior emails.
> 
> First, because a fresh module is used, you don't get problems 
> with code being modified while another thread may be 
> executing in the context of the existing module that would 
> have otherwise been overwritten.
> 
> You can selectively copy over only the data which should be 
> present in the context of the code being reconstructed. Ie., 
> you could throw away certain types of cached data.
> If the modified code had removed functions, they will not 
> show in the newly loaded module.
> 
> The use of a method rather than an export list of data to 
> copy across, means that locks can be acquired while data is 
> being copied to prevent another thread accessing it at the same time.
> 
> The intent with copying locks and data is that it is shared 
> between old and new modules at least for the period that any 
> existing thread may be executing in the context of the old 
> module. Because the old module will no longer be referenced 
> from the cache, once the thread executing in the context of 
> the old module finishes, the old module will disappear and 
> data will be exclusive to the new module.
> 
> This does mean though that any data should really be 
> dictionaries or class instances Ie., things that can be 
> shared properly and a change through either reference is 
> reflected in the other. Eg.
> 
>    >>> a={"a":1}
>    >>> b=a
>    >>> a
>    {'a': 1}
>    >>> b
>    {'a': 1}
>    >>> b["c"]=2
>    >>> a
>    {'a': 1, 'c': 2}
>    >>> b
>    {'a': 1, 'c': 2}
> 
> This isn't going to work if the data were simple integers or 
> strings, as once a copy is made, a change from one module, by 
> way of assignment, isn't going to be reflected in the other.
> 
> You could also feasibly implement fixup code in a new module 
> which would be executed upon the reload to convert data in an 
> old form to a new form, but the danger of that is that you 
> don't know whether a reload may occur for one fixup, before 
> you later change the module again and where the subsequent 
> fixup expects data in the intermediate format. If the format 
> of data is going to change drastically, you should really 
> stop Apache, load in your new code and restart. Otherwise, 
> you would have to use a variable which tracks what version 
> the data format is in and for fixup code be able to cope with 
> various older versions of data when converting to a new format.
> 
> Anyway, interesting stuff to play with.
> 
> --
> Graham Dumpleton (grahamd@dscpl.com.au)
> 
> 


From grahamd at dscpl.com.au  Thu Oct 14 17:21:52 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct 14 18:22:01 2004
Subject: [mod_python] Udate python modules without restarting Apache
In-Reply-To: <200410141251.i9ECpYkh076299@dscpl.com.au>
Message-ID: <1097792508.48105@dscpl.com.au>

On Oct 14 14:51, "Nicolas Lehuen" <nicolas@lehuen.com> wrote:
>
> Subject: RE: [mod_python] Udate python modules without restarting Apache
>
> This __clone__() method is a very neat idea indeed ! For the moment I prefer
> not to keep any data between reloads (what needs to be kept is in the
> database), but there may be occurrences where such a mechanisms would be
> handy.

The actual data may be in the database, but if one is using a database
connection pooling object, one has to keep that somewhere. That is one
candidate for types of objects that you may want to preserve across a
reload and not simply throw away.

> Right now I'm trying to use imp.new_module but I get curious results...
> Apparently some classes that are imported from other modules are redefined
> even though they should not. The net result is that some isinstance() tests
> fail where they should not (reminds me of ClassLoader problems in Java). I
> tried to build a simple test case exhibiting the problem, but it does not.
> What's for sure, is that when I do :
> 
> exec source in module.__dict__
> 
> If module is a fake module object (a place holder class Module(object):
> pass), all my code is OK. If it is a real module, I get weird behaviours.
> I'm still investigating on the subject.

Reloading of modules can always be a problem when one is comparing the
type of objects as you have to be careful that something hasn't stashed away
a copy of an older class object for type comparison, or conversly is using a
newer version of the class object to check the type of an object created from
the older instance.

This was one of the issues that originally came up in prior email, specifically
the Servlet class from mpservlets. In that case it was because a module was
being imported using "import" in one place and "apache.import_module()"
in another. As such there were two actual instances of the Servlet class and
comparing the type of an instance based on one against the other class type
was going to fail.

The problem can still arise even when one consistently uses a module
import and caching mechanism, as such mechanisms typically only look at
the highest level import and not any sub imports that may have been done
by the object. Thus, you can have stale copies of modules still in memory
until the appropriate parent module is also reloaded, flushing out the stale
sub module.

BTW, the __clone__() method could also be conceivably used to copy across
classes as opposed to instances of classes. You might therefore have something
like:

  def __clone__(module):
    module.Interface = Interface

  if not globals().has_key("Interface"):
    class Interface:
      def method(self,object):  pass

  class Implementation(Interface):
    def method(self,object):
      if isinstance(object,Interface):
        ...

That is, have a simple class definition which defines the interface, much like
interface objects in Java. Have the actual implementation derive from that.
In code create instances of the Implementation, but when doing isinstance()
checks, compare it to the Interface base class.

Thus, the Interface class definition is always the same actual class type object
because it is preserved across reloads. Although the derived class may be
called Implementation in every version of the module, it is actually a different
class type object in memory. To compare types of Implementation objects is
not going to work if instances are based on different versions, but if your
check is for them being a derived instance of Interface, you woud be okay.

Although for a robust system that can easily be updated if necessary without
restarting Apache you could go to this extent, I frankly doubt many, if any at
all would bother to do so.

I will be interested to here what is causing your problem in case there is
something I have missed about how this stuff operates.


--
Graham Dumpleton (grahamd@dscpl.com.au)
From robey at flaminglunchbox.net  Fri Oct 15 05:41:37 2004
From: robey at flaminglunchbox.net (Robey Holderith)
Date: Fri Oct 15 04:41:32 2004
Subject: [mod_python] FreeBSD 5.2, mod_python 3.1.3,
	apache 2.0.52 .. File access problems
Message-ID: <416F8D41.5080505@flaminglunchbox.net>

There are some posts with similar problems, but I have yet to see a 
solution that works for me.

 From the python interpreter I can do the following:

 >>> f = file('/dev/null','w')
 >>> f.write('stuff')
 >>> f.close()

No errors, all is well.

If I do the same in a python function called by mod_python I get the 
following error:
IOError: [Errno 9] Bad file descriptor

This seems to be related to the tempdir problem reported on FreeBSD 
machines.  If I do the following in the python interpreter:

 >>> import tempfile
 >>> tempfile.gettempdir()

'/tmp' is returned as a valid temp directory.  mod_python gives me:

IOError: [Errno 2] No usable temporary directory found in ['/tmp', 
'/var/tmp', '/usr/tmp', '/']

I did a little bit of digging into this problem and found that in 
tempfile._get_default_tempdir()

_os.fdopen(fp, 'w') is throwing [Errno 22] Invalid argument

Why would something low-level like this cause problems in the mod_python 
environment but not in standard use?

thanks in advance-

Robey Holderith
From thomas at pixtur.de  Fri Oct 15 16:21:55 2004
From: thomas at pixtur.de (Tom)
Date: Fri Oct 15 09:16:05 2004
Subject: [mod_python] Can't get post vars using Publisher Handler
In-Reply-To: <41317352.9060409@joreybump.com>
References: <412F55BA.2020703@rcsreg.com> <41317352.9060409@joreybump.com>
Message-ID: <416FCEF3.90401@pixtur.de>

Thanks for this tip!

This example should definately be added to the tutorial section of the 
mod_python-docu, because:

1. Parsing form-variables is the first thing a newby to mod_python wants 
to do

2. No information about req.form() available under:
http://www.modpython.org/live/current/doc-html/genindex.html
http://www.modpython.org/live/current/doc-html/pyapi-mprequest-meth.html
http://www.modpython.org/live/current/doc-html/pyapi-mprequest-mem.html

I spent the last few hours wondering about req.read() (which returned no 
string, even if req.headers_in["content-length"] showed a length 
different from zero.

        len = int(req.headers_in["content-length"])
        req.write("%s" % len);               # printed something about 40
        req.write("%s" % req.read());  #printed nothing


        req.write("%s" % req.form.keys());   # worked fine


    pixtur
    python newby


>
>   <form name="test" action="somefunction" method="POST">
>     <input type="hidden" name="foo" value="1">
>     <input type="hidden" name="bar" value="milkyway">
>     <input type="submit" name="submit" value="Try me!">
>   </form>
>
> the variables will be available in the function like this:
>
>   def somefunction(req):
>       x = req.form['foo']
>       y = req.form['bar']
>       result = """<html>
>   <head>
>   <title>foobar</title>
>   </head>
>   <body>
>   <p>I would like %s %s. </p>
>   </body>
>   </html>
>       """ % (x, y)
>       return result
>
> Note that the values of multiple form elements of the same name will 
> be returned as a list, so process accordingly.



From robey at flaminglunchbox.net  Fri Oct 15 10:34:46 2004
From: robey at flaminglunchbox.net (Robey Holderith)
Date: Fri Oct 15 09:37:50 2004
Subject: [mod_python] Can't get post vars using Publisher Handler
In-Reply-To: <416FCEF3.90401@pixtur.de>
References: <412F55BA.2020703@rcsreg.com> <41317352.9060409@joreybump.com>
	<416FCEF3.90401@pixtur.de>
Message-ID: <416FD1F6.7010803@flaminglunchbox.net>

Tom wrote:

> Thanks for this tip!
>
> This example should definately be added to the tutorial section of the 
> mod_python-docu, because:
>
> 1. Parsing form-variables is the first thing a newby to mod_python 
> wants to do
>
> 2. No information about req.form() available under:
> http://www.modpython.org/live/current/doc-html/genindex.html
> http://www.modpython.org/live/current/doc-html/pyapi-mprequest-meth.html
> http://www.modpython.org/live/current/doc-html/pyapi-mprequest-mem.html
>
> I spent the last few hours wondering about req.read() (which returned 
> no string, even if req.headers_in["content-length"] showed a length 
> different from zero.
>
>        len = int(req.headers_in["content-length"])
>        req.write("%s" % len);               # printed something about 40
>        req.write("%s" % req.read());  #printed nothing
>
>
>        req.write("%s" % req.form.keys());   # worked fine
>
>
>    pixtur
>    python newby
>
>
>>
>>   <form name="test" action="somefunction" method="POST">
>>     <input type="hidden" name="foo" value="1">
>>     <input type="hidden" name="bar" value="milkyway">
>>     <input type="submit" name="submit" value="Try me!">
>>   </form>
>>
>> the variables will be available in the function like this:
>>
>>   def somefunction(req):
>>       x = req.form['foo']
>>       y = req.form['bar']
>>       result = """<html>
>>   <head>
>>   <title>foobar</title>
>>   </head>
>>   <body>
>>   <p>I would like %s %s. </p>
>>   </body>
>>   </html>
>>       """ % (x, y)
>>       return result
>>
>> Note that the values of multiple form elements of the same name will 
>> be returned as a list, so process accordingly.
>
>
>
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python


From ppercot at free.fr  Fri Oct 15 17:40:08 2004
From: ppercot at free.fr (Patrick Percot)
Date: Fri Oct 15 10:40:15 2004
Subject: [mod_python] Re: confirm c7d431f030eb8555d06f30cbd1cdd6291934ad5f
In-Reply-To: <mailman.1216.1097851167.3093.mod_python@modpython.org>
References: <mailman.1216.1097851167.3093.mod_python@modpython.org>
Message-ID: <20041015.164008.58792813.ppercot@free.fr>

On Fri, 15 Oct 2004 10:39:27 -0400, mod_python-request@modpython.org wrote

> Mailing list removal confirmation notice for mailing list Mod_python
> 
> We have received a request for the removal of your email address,
> "ppercot@free.fr" from the mod_python@modpython.org mailing list.  To
> confirm that you want to be removed from this mailing list, simply
> reply to this message, keeping the Subject: header intact.  Or visit
> this web page:
> 
>     http://mailman.modpython.org/mailman/confirm/mod_python/c7d431f030eb8555d06f30cbd1cdd6291934ad5f
> 
> 
> Or include the following line -- and only the following line -- in a
> message to mod_python-request@modpython.org:
> 
>     confirm c7d431f030eb8555d06f30cbd1cdd6291934ad5f
> 
> Note that simply sending a `reply' to this message should work from
> most mail readers, since that usually leaves the Subject: line in the
> right form (additional "Re:" text in the Subject: is okay).
> 
> If you do not wish to be removed from this list, please simply
> disregard this message.  If you think you are being maliciously
> removed from the list, or have any other questions, send them to
> mod_python-owner@modpython.org.
> 

?+
PP
-- 
Groupe Morbihannais d'Utilisateurs de Logiciels Libres http://www.tuxbihan.org
GPG fingerprint = 1A4F E154 3D2C A20E E4CA  A543 7951 C5C2 E44A A0B5

Patrick Percot.

From grahamd at dscpl.com.au  Sun Oct 17 00:04:32 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Oct 16 09:04:43 2004
Subject: [mod_python] Bug in mod_python.c causing multiple/redundant
	interpreter creation.
In-Reply-To: <20041009081038.1F587C6B8@postfix3-2.free.fr>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
Message-ID: <EBE0766E-1F73-11D9-9AA7-000393DCF16E@dscpl.com.au>


On 09/10/2004, at 6:10 PM, Nicolas Lehuen wrote:

> Hi Graham, what are the pros and cons of using the imp module versus an
> execfile call or an exec call ?
>
> Using Apache 2.0.52 on win32, with a multithreaded MPM, I have noticed  
> a few
> problem with mod_python.publisher which reloads the same module many  
> times
> when many threads try to load it concurrently. It seems that either
> mod_python.publisher or the imp module does not properly handle this
> situation. The result is that I have many instances of the same module  
> in
> memory, so I got many connection pools instead of only one and so on.  
> That's
> why I decided to fix this and other problems (the famous 'only one  
> index.py
> in your application') by reimplementing my own variant of the  
> publisher.

Found it.

 From what I can tell, there is actually a bug in mod_python.c which is
causing the problem you describe as "reloads the same module many times
when many threads try to load it concurrently".

I am going to describe it quickly as it is getting late for me and I  
need
some sleep. Have attached a patch for people to evaluate and try. Note  
that
the patch also includes a Mac OS X specific fix. That fix is harmless in
itself so just leave it in. The important changes are where APR mutex is
created and then locked/unlocked.

The basic problem revolves around the Python dictionary used to hold the
set of interpreters. The code in mod_python.c is trying to use the  
Python
GIL to provide exclusive access to that dictionary and any subsequent
creation of an interpreter.

The only catch is that in creating a new interpreter, the Python core  
is,
in someway I don't understand, swapping thread states at some point  
which
is allowing other threads to acquire the GIL. This is allowing other  
threads
to check the set of interpreters for the same interpreter that is  
currently
being constructed and since it isn't there yet, then also goes onto  
create
it as well.

The result is you get many threads in the same process creating the same
named interpreter and loading the top level handler defined by the  
directive
PythonHandler (or other earlier handler). Thus you see all the logged
messages about (re)importing the handler, as each thread has managed to
get to the point of doing it.

What should have happened is that if the lock was truly exclusive, the
subsequent threads would have waited until the first had actually  
finished
creating the interpreter in the first place.

The patch for the problem is below. What I do is create an APR mutex and
lock that around the outside of the acquisition of the GIL, the GIL  
still
being required.

In all the debugging I have in place in my code, I still note something
else not quite right in respect of the mod_python.apache module being
reloaded more than once by a thread. I'll dig further into that  
tomorrow.



*** mod_python.c.dist	Fri Sep 24 15:11:32 2004
--- mod_python.c	Sat Oct 16 22:36:30 2004
***************
*** 31,36 ****
--- 31,38 ----
    * (In a Python dictionary) */
   static PyObject * interpreters = NULL;

+ static apr_thread_mutex_t* interpreters_lock = 0;
+
   apr_pool_t *child_init_pool = NULL;

   /**
***************
*** 124,129 ****
--- 126,133 ----
           name = MAIN_INTERPRETER;

   #ifdef WITH_THREAD
+     apr_thread_mutex_lock(interpreters_lock);
+
       PyEval_AcquireLock();
   #endif

***************
*** 149,154 ****
--- 153,160 ----

   #ifdef WITH_THREAD
       PyEval_ReleaseLock();
+
+     apr_thread_mutex_unlock(interpreters_lock);
   #endif

       if (! idata) {
***************
*** 469,474 ****
--- 475,483 ----
       const char *userdata_key = "python_init";
       apr_status_t rc;

+     /* fudge for Mac OS X with Apache 1.3 where Py_IsInitialized()  
broke */
+     static int initialized = 0;
+
       apr_pool_userdata_get(&data, userdata_key, s->process->pool);
       if (!data) {
           apr_pool_userdata_set((const void *)1, userdata_key,
***************
*** 490,502 ****
       }

       /* initialize global Python interpreter if necessary */
!     if (! Py_IsInitialized())
       {

           /* initialze the interpreter */
           Py_Initialize();

   #ifdef WITH_THREAD
           /* create and acquire the interpreter lock */
           PyEval_InitThreads();
   #endif
--- 499,514 ----
       }

       /* initialize global Python interpreter if necessary */
!     if (initialized == 0 || ! Py_IsInitialized())
       {
+         initialized = 1;

           /* initialze the interpreter */
           Py_Initialize();

   #ifdef WITH_THREAD
+          
apr_thread_mutex_create(&interpreters_lock,APR_THREAD_MUTEX_UNNESTED,p);
+
           /* create and acquire the interpreter lock */
           PyEval_InitThreads();
   #endif





--
Graham Dumpleton (grahamd@dscpl.com.au)

From grahamd at dscpl.com.au  Sun Oct 17 00:14:36 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Oct 16 09:14:47 2004
Subject: [mod_python] Re: Bug in mod_python.c causing multiple/redundant
	interpreter creation.
In-Reply-To: <EBE0766E-1F73-11D9-9AA7-000393DCF16E@dscpl.com.au>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
	<EBE0766E-1F73-11D9-9AA7-000393DCF16E@dscpl.com.au>
Message-ID: <53B40358-1F75-11D9-9AA7-000393DCF16E@dscpl.com.au>


On 16/10/2004, at 11:04 PM, Graham Dumpleton wrote:

>
> On 09/10/2004, at 6:10 PM, Nicolas Lehuen wrote:
>
>> Hi Graham, what are the pros and cons of using the imp module versus 
>> an
>> execfile call or an exec call ?
>>
>> Using Apache 2.0.52 on win32, with a multithreaded MPM, I have 
>> noticed a few
>> problem with mod_python.publisher which reloads the same module many 
>> times
>> when many threads try to load it concurrently. It seems that either
>> mod_python.publisher or the imp module does not properly handle this
>> situation. The result is that I have many instances of the same 
>> module in
>> memory, so I got many connection pools instead of only one and so on. 
>> That's
>> why I decided to fix this and other problems (the famous 'only one 
>> index.py
>> in your application') by reimplementing my own variant of the 
>> publisher.
>
> Found it.
>
> From what I can tell, there is actually a bug in mod_python.c which is
> causing the problem you describe as "reloads the same module many times
> when many threads try to load it concurrently".
>
> I am going to describe it quickly as it is getting late for me and I 
> need
> some sleep. Have attached a patch for people to evaluate and try. Note 
> that
> the patch also includes a Mac OS X specific fix. That fix is harmless 
> in
> itself so just leave it in. The important changes are where APR mutex 
> is
> created and then locked/unlocked.
>
> The basic problem revolves around the Python dictionary used to hold 
> the
> set of interpreters. The code in mod_python.c is trying to use the 
> Python
> GIL to provide exclusive access to that dictionary and any subsequent
> creation of an interpreter.
>
> The only catch is that in creating a new interpreter, the Python core 
> is,
> in someway I don't understand, swapping thread states at some point 
> which
> is allowing other threads to acquire the GIL. This is allowing other 
> threads
> to check the set of interpreters for the same interpreter that is 
> currently
> being constructed and since it isn't there yet, then also goes onto 
> create
> it as well.

Actually, the GIL could get taken away for a few reasons. First, once 
you
start executing actual Python code, it can get taken away. Also, if the
Python code calls back out to C code and does a potentially blocking
operation, it will voluntarily give up the GIL so something else can 
run.
Since the Python apache.import_module() function is going to be called
to load your content handler, and that has to do file i/o, would be a 
very
good candidate for the GIL being given up and thus letting the other 
threads
in to be able to check to see if the interpreter needs creating.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From grisha at modpython.org  Sat Oct 16 10:30:00 2004
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Sat Oct 16 09:30:13 2004
Subject: [mod_python] Bug in mod_python.c causing multiple/redundant
	interpreter creation.
In-Reply-To: <EBE0766E-1F73-11D9-9AA7-000393DCF16E@dscpl.com.au>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
	<EBE0766E-1F73-11D9-9AA7-000393DCF16E@dscpl.com.au>
Message-ID: <20041016092933.Y47684@onyx.ispol.com>


Thanks for this. Does this compile/run with threads disabled as well?

Grisha

On Sat, 16 Oct 2004, Graham Dumpleton wrote:

>
> On 09/10/2004, at 6:10 PM, Nicolas Lehuen wrote:
>
>> Hi Graham, what are the pros and cons of using the imp module versus an
>> execfile call or an exec call ?
>> 
>> Using Apache 2.0.52 on win32, with a multithreaded MPM, I have noticed a 
>> few
>> problem with mod_python.publisher which reloads the same module many times
>> when many threads try to load it concurrently. It seems that either
>> mod_python.publisher or the imp module does not properly handle this
>> situation. The result is that I have many instances of the same module in
>> memory, so I got many connection pools instead of only one and so on. 
>> That's
>> why I decided to fix this and other problems (the famous 'only one 
>> index.py
>> in your application') by reimplementing my own variant of the publisher.
>
> Found it.
>
> From what I can tell, there is actually a bug in mod_python.c which is
> causing the problem you describe as "reloads the same module many times
> when many threads try to load it concurrently".
>
> I am going to describe it quickly as it is getting late for me and I need
> some sleep. Have attached a patch for people to evaluate and try. Note that
> the patch also includes a Mac OS X specific fix. That fix is harmless in
> itself so just leave it in. The important changes are where APR mutex is
> created and then locked/unlocked.
>
> The basic problem revolves around the Python dictionary used to hold the
> set of interpreters. The code in mod_python.c is trying to use the Python
> GIL to provide exclusive access to that dictionary and any subsequent
> creation of an interpreter.
>
> The only catch is that in creating a new interpreter, the Python core is,
> in someway I don't understand, swapping thread states at some point which
> is allowing other threads to acquire the GIL. This is allowing other threads
> to check the set of interpreters for the same interpreter that is currently
> being constructed and since it isn't there yet, then also goes onto create
> it as well.
>
> The result is you get many threads in the same process creating the same
> named interpreter and loading the top level handler defined by the directive
> PythonHandler (or other earlier handler). Thus you see all the logged
> messages about (re)importing the handler, as each thread has managed to
> get to the point of doing it.
>
> What should have happened is that if the lock was truly exclusive, the
> subsequent threads would have waited until the first had actually finished
> creating the interpreter in the first place.
>
> The patch for the problem is below. What I do is create an APR mutex and
> lock that around the outside of the acquisition of the GIL, the GIL still
> being required.
>
> In all the debugging I have in place in my code, I still note something
> else not quite right in respect of the mod_python.apache module being
> reloaded more than once by a thread. I'll dig further into that tomorrow.
>
>
>
> *** mod_python.c.dist	Fri Sep 24 15:11:32 2004
> --- mod_python.c	Sat Oct 16 22:36:30 2004
> ***************
> *** 31,36 ****
> --- 31,38 ----
>   * (In a Python dictionary) */
>  static PyObject * interpreters = NULL;
>
> + static apr_thread_mutex_t* interpreters_lock = 0;
> +
>  apr_pool_t *child_init_pool = NULL;
>
>  /**
> ***************
> *** 124,129 ****
> --- 126,133 ----
>          name = MAIN_INTERPRETER;
>
>  #ifdef WITH_THREAD
> +     apr_thread_mutex_lock(interpreters_lock);
> +
>      PyEval_AcquireLock();
>  #endif
>
> ***************
> *** 149,154 ****
> --- 153,160 ----
>
>  #ifdef WITH_THREAD
>      PyEval_ReleaseLock();
> +
> +     apr_thread_mutex_unlock(interpreters_lock);
>  #endif
>
>      if (! idata) {
> ***************
> *** 469,474 ****
> --- 475,483 ----
>      const char *userdata_key = "python_init";
>      apr_status_t rc;
>
> +     /* fudge for Mac OS X with Apache 1.3 where Py_IsInitialized() broke */
> +     static int initialized = 0;
> +
>      apr_pool_userdata_get(&data, userdata_key, s->process->pool);
>      if (!data) {
>          apr_pool_userdata_set((const void *)1, userdata_key,
> ***************
> *** 490,502 ****
>      }
>
>      /* initialize global Python interpreter if necessary */
> !     if (! Py_IsInitialized())
>      {
>
>          /* initialze the interpreter */
>          Py_Initialize();
>
>  #ifdef WITH_THREAD
>          /* create and acquire the interpreter lock */
>          PyEval_InitThreads();
>  #endif
> --- 499,514 ----
>      }
>
>      /* initialize global Python interpreter if necessary */
> !     if (initialized == 0 || ! Py_IsInitialized())
>      {
> +         initialized = 1;
>
>          /* initialze the interpreter */
>          Py_Initialize();
>
>  #ifdef WITH_THREAD
> + 
> apr_thread_mutex_create(&interpreters_lock,APR_THREAD_MUTEX_UNNESTED,p);
> +
>          /* create and acquire the interpreter lock */
>          PyEval_InitThreads();
>  #endif
>
>
>
>
>
> --
> Graham Dumpleton (grahamd@dscpl.com.au)
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From grisha at modpython.org  Sat Oct 16 10:31:53 2004
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Sat Oct 16 09:32:04 2004
Subject: [mod_python] Re: Bug in mod_python.c causing multiple/redundant
	interpreter creation.
In-Reply-To: <53B40358-1F75-11D9-9AA7-000393DCF16E@dscpl.com.au>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
	<EBE0766E-1F73-11D9-9AA7-000393DCF16E@dscpl.com.au>
	<53B40358-1F75-11D9-9AA7-000393DCF16E@dscpl.com.au>
Message-ID: <20041016093010.T47684@onyx.ispol.com>



On Sat, 16 Oct 2004, Graham Dumpleton wrote:

> Since the Python apache.import_module() function is going to be called
> to load your content handler, and that has to do file i/o, would be a very
> good candidate for the GIL being given up and thus letting the other threads
> in to be able to check to see if the interpreter needs creating.

I'm pretty sure Python already does release the GIL where necessary (such 
as IO during import), so there is no need to do that from within 
mod_python.

Grisha
From nicolas at lehuen.com  Sat Oct 16 16:41:00 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Sat Oct 16 09:41:09 2004
Subject: [mod_python] RE: Bug in mod_python.c causing multiple/redundant
	interpreter creation.
In-Reply-To: <EBE0766E-1F73-11D9-9AA7-000393DCF16E@dscpl.com.au>
Message-ID: <20041016134100.B00CB173554@postfix3-1.free.fr>

Thanks Graham, that's great news that you managed to find the issue. I'll
see if I can make a build for Win32 with your patch and tell you if it works
for me.

Regards,

Nicolas 

> -----Message d'origine-----
> De : Graham Dumpleton [mailto:grahamd@dscpl.com.au] 
> Envoy? : samedi 16 octobre 2004 15:05
> ? : Nicolas Lehuen
> Cc : 'Daniel Popowich'; mod_python@modpython.org
> Objet : Bug in mod_python.c causing multiple/redundant 
> interpreter creation.
> 
> 
> On 09/10/2004, at 6:10 PM, Nicolas Lehuen wrote:
> 
> > Hi Graham, what are the pros and cons of using the imp 
> module versus 
> > an execfile call or an exec call ?
> >
> > Using Apache 2.0.52 on win32, with a multithreaded MPM, I 
> have noticed 
> > a few problem with mod_python.publisher which reloads the 
> same module 
> > many times when many threads try to load it concurrently. It seems 
> > that either mod_python.publisher or the imp module does not 
> properly 
> > handle this situation. The result is that I have many 
> instances of the 
> > same module in memory, so I got many connection pools 
> instead of only 
> > one and so on.
> > That's
> > why I decided to fix this and other problems (the famous 'only one 
> > index.py in your application') by reimplementing my own 
> variant of the 
> > publisher.
> 
> Found it.
> 
>  From what I can tell, there is actually a bug in 
> mod_python.c which is
> causing the problem you describe as "reloads the same module 
> many times
> when many threads try to load it concurrently".
> 
> I am going to describe it quickly as it is getting late for me and I  
> need
> some sleep. Have attached a patch for people to evaluate and 
> try. Note  
> that
> the patch also includes a Mac OS X specific fix. That fix is 
> harmless in
> itself so just leave it in. The important changes are where 
> APR mutex is
> created and then locked/unlocked.
> 
> The basic problem revolves around the Python dictionary used 
> to hold the
> set of interpreters. The code in mod_python.c is trying to use the  
> Python
> GIL to provide exclusive access to that dictionary and any subsequent
> creation of an interpreter.
> 
> The only catch is that in creating a new interpreter, the 
> Python core  
> is,
> in someway I don't understand, swapping thread states at some point  
> which
> is allowing other threads to acquire the GIL. This is allowing other  
> threads
> to check the set of interpreters for the same interpreter that is  
> currently
> being constructed and since it isn't there yet, then also goes onto  
> create
> it as well.
> 
> The result is you get many threads in the same process 
> creating the same
> named interpreter and loading the top level handler defined by the  
> directive
> PythonHandler (or other earlier handler). Thus you see all the logged
> messages about (re)importing the handler, as each thread has 
> managed to
> get to the point of doing it.
> 
> What should have happened is that if the lock was truly exclusive, the
> subsequent threads would have waited until the first had actually  
> finished
> creating the interpreter in the first place.
> 
> The patch for the problem is below. What I do is create an 
> APR mutex and
> lock that around the outside of the acquisition of the GIL, the GIL  
> still
> being required.
> 
> In all the debugging I have in place in my code, I still note 
> something
> else not quite right in respect of the mod_python.apache module being
> reloaded more than once by a thread. I'll dig further into that  
> tomorrow.
> 
> 
> 
> *** mod_python.c.dist	Fri Sep 24 15:11:32 2004
> --- mod_python.c	Sat Oct 16 22:36:30 2004
> ***************
> *** 31,36 ****
> --- 31,38 ----
>     * (In a Python dictionary) */
>    static PyObject * interpreters = NULL;
> 
> + static apr_thread_mutex_t* interpreters_lock = 0;
> +
>    apr_pool_t *child_init_pool = NULL;
> 
>    /**
> ***************
> *** 124,129 ****
> --- 126,133 ----
>            name = MAIN_INTERPRETER;
> 
>    #ifdef WITH_THREAD
> +     apr_thread_mutex_lock(interpreters_lock);
> +
>        PyEval_AcquireLock();
>    #endif
> 
> ***************
> *** 149,154 ****
> --- 153,160 ----
> 
>    #ifdef WITH_THREAD
>        PyEval_ReleaseLock();
> +
> +     apr_thread_mutex_unlock(interpreters_lock);
>    #endif
> 
>        if (! idata) {
> ***************
> *** 469,474 ****
> --- 475,483 ----
>        const char *userdata_key = "python_init";
>        apr_status_t rc;
> 
> +     /* fudge for Mac OS X with Apache 1.3 where Py_IsInitialized()  
> broke */
> +     static int initialized = 0;
> +
>        apr_pool_userdata_get(&data, userdata_key, s->process->pool);
>        if (!data) {
>            apr_pool_userdata_set((const void *)1, userdata_key,
> ***************
> *** 490,502 ****
>        }
> 
>        /* initialize global Python interpreter if necessary */
> !     if (! Py_IsInitialized())
>        {
> 
>            /* initialze the interpreter */
>            Py_Initialize();
> 
>    #ifdef WITH_THREAD
>            /* create and acquire the interpreter lock */
>            PyEval_InitThreads();
>    #endif
> --- 499,514 ----
>        }
> 
>        /* initialize global Python interpreter if necessary */
> !     if (initialized == 0 || ! Py_IsInitialized())
>        {
> +         initialized = 1;
> 
>            /* initialze the interpreter */
>            Py_Initialize();
> 
>    #ifdef WITH_THREAD
> +          
> apr_thread_mutex_create(&interpreters_lock,APR_THREAD_MUTEX_UN
> NESTED,p);
> +
>            /* create and acquire the interpreter lock */
>            PyEval_InitThreads();
>    #endif
> 
> 
> 
> 
> 
> --
> Graham Dumpleton (grahamd@dscpl.com.au)
> 
> 


From nicolas at lehuen.com  Sat Oct 16 17:46:31 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Sat Oct 16 10:46:42 2004
Subject: [mod_python] RE: Bug in mod_python.c causing
	multiple/redundantinterpreter creation.
In-Reply-To: <20041016134100.B00CB173554@postfix3-1.free.fr>
Message-ID: <20041016144632.2D597173559@postfix3-1.free.fr>

Graham, I recompiled mod_python with your fixes, but unfortunately I still
have the problem. Let me explain you how I get it.

I have a pretty simple debug page published by mod_python.publisher. I use
ApacheBenchmark to have 50 concurrent connections to my Apache server just
after the Apache server is started, as follows :

c:\apache\bin\ab.exe -c 50 -n 1000 http://localhost/python/index.py

What I get in the error log is joined to this message (see error.1.log).

If I don't have concurrent connections, mod_python behaves as expected (see
error.2.log) :

c:\apache\bin\ab.exe -c 1 -n 1000 http://localhost/python/index.py

Note the exception in error.1.log : mod_python.publisher is reloaded many
times. I think that your patch may solve a problem with mod_python creating
multiple interpreters with the same name, but there is stil a problem in the
mod_python.apache module, since it reloads the same publisher many times.

Indeed, having a look at apache.py, I didn't see any locking done to prevent
the same module from being reloaded multiple times concurrently. What we
need is to put a lock in the import_module method, so that two threads
cannot check the freshness of the publisher simultaneously. This can be done
in a rather brutal way by calling imp.acquire_lock() at the beginning of
import_module, put a try/finally block around the code of the function and
call imp.release_lock() in the finally block : 

def import_module(module_name, autoreload=1, log=0, path=None):
    """
    Get the module to handle the request. If
    autoreload is on, then the module will be reloaded
    if it has changed since the last import.
    """

    imp.acquire_lock()
    try:
	# previous code of apache.import_module
    finally:
        imp.release_lock()

I tested this, and it works as expected. BTW, maybe it wouldn't work without
your patch, Graham, since I could suddenly see two interpreters with their
own copy of the mod_python.apache module. But the two fixes are required for
it to work properly.

Why did I wrote "in a rather brutal way" above ? Because this locking scheme
is indeed brutal. It is a global lock, so each and every thread who want to
get its handler must acquire it for a brief amount of time. The problem is
that if a handler module is reloaded, it locks each and every other thread
during its reloading, even if they should not be handled by the same module.
A smarter way to lock would be to use a two-levels locking scheme, as I
described in my caching recipe in the Python Cookbook. I can implement it
there if it's ok for everybody.

Regards,
Nicolas

> -----Message d'origine-----
> De : mod_python-bounces@modpython.org 
> [mailto:mod_python-bounces@modpython.org] De la part de Nicolas Lehuen
> Envoy? : samedi 16 octobre 2004 15:41
> ? : 'Graham Dumpleton'
> Cc : mod_python@modpython.org
> Objet : [mod_python] RE: Bug in mod_python.c causing 
> multiple/redundantinterpreter creation.
> 
> Thanks Graham, that's great news that you managed to find the 
> issue. I'll see if I can make a build for Win32 with your 
> patch and tell you if it works for me.
> 
> Regards,
> 
> Nicolas 
> 
> > -----Message d'origine-----
> > De : Graham Dumpleton [mailto:grahamd@dscpl.com.au] Envoy? 
> : samedi 16 
> > octobre 2004 15:05 ? : Nicolas Lehuen Cc : 'Daniel Popowich'; 
> > mod_python@modpython.org Objet : Bug in mod_python.c causing 
> > multiple/redundant interpreter creation.
> > 
> > 
> > On 09/10/2004, at 6:10 PM, Nicolas Lehuen wrote:
> > 
> > > Hi Graham, what are the pros and cons of using the imp 
> > module versus 
> > > an execfile call or an exec call ?
> > >
> > > Using Apache 2.0.52 on win32, with a multithreaded MPM, I 
> > have noticed 
> > > a few problem with mod_python.publisher which reloads the 
> > same module 
> > > many times when many threads try to load it concurrently. 
> It seems 
> > > that either mod_python.publisher or the imp module does not 
> > properly 
> > > handle this situation. The result is that I have many 
> > instances of the 
> > > same module in memory, so I got many connection pools 
> > instead of only 
> > > one and so on.
> > > That's
> > > why I decided to fix this and other problems (the famous 
> 'only one 
> > > index.py in your application') by reimplementing my own 
> > variant of the 
> > > publisher.
> > 
> > Found it.
> > 
> >  From what I can tell, there is actually a bug in 
> > mod_python.c which is
> > causing the problem you describe as "reloads the same module 
> > many times
> > when many threads try to load it concurrently".
> > 
> > I am going to describe it quickly as it is getting late for 
> me and I  
> > need
> > some sleep. Have attached a patch for people to evaluate and 
> > try. Note  
> > that
> > the patch also includes a Mac OS X specific fix. That fix is 
> > harmless in
> > itself so just leave it in. The important changes are where 
> > APR mutex is
> > created and then locked/unlocked.
> > 
> > The basic problem revolves around the Python dictionary used 
> > to hold the
> > set of interpreters. The code in mod_python.c is trying to use the  
> > Python
> > GIL to provide exclusive access to that dictionary and any 
> subsequent
> > creation of an interpreter.
> > 
> > The only catch is that in creating a new interpreter, the 
> > Python core  
> > is,
> > in someway I don't understand, swapping thread states at 
> some point  
> > which
> > is allowing other threads to acquire the GIL. This is 
> allowing other  
> > threads
> > to check the set of interpreters for the same interpreter that is  
> > currently
> > being constructed and since it isn't there yet, then also 
> goes onto  
> > create
> > it as well.
> > 
> > The result is you get many threads in the same process 
> > creating the same
> > named interpreter and loading the top level handler defined by the  
> > directive
> > PythonHandler (or other earlier handler). Thus you see all 
> the logged
> > messages about (re)importing the handler, as each thread has 
> > managed to
> > get to the point of doing it.
> > 
> > What should have happened is that if the lock was truly 
> exclusive, the
> > subsequent threads would have waited until the first had actually  
> > finished
> > creating the interpreter in the first place.
> > 
> > The patch for the problem is below. What I do is create an 
> > APR mutex and
> > lock that around the outside of the acquisition of the GIL, 
> the GIL  
> > still
> > being required.
> > 
> > In all the debugging I have in place in my code, I still note 
> > something
> > else not quite right in respect of the mod_python.apache 
> module being
> > reloaded more than once by a thread. I'll dig further into that  
> > tomorrow.
> > 
> > 
> > 
> > *** mod_python.c.dist	Fri Sep 24 15:11:32 2004
> > --- mod_python.c	Sat Oct 16 22:36:30 2004
> > ***************
> > *** 31,36 ****
> > --- 31,38 ----
> >     * (In a Python dictionary) */
> >    static PyObject * interpreters = NULL;
> > 
> > + static apr_thread_mutex_t* interpreters_lock = 0;
> > +
> >    apr_pool_t *child_init_pool = NULL;
> > 
> >    /**
> > ***************
> > *** 124,129 ****
> > --- 126,133 ----
> >            name = MAIN_INTERPRETER;
> > 
> >    #ifdef WITH_THREAD
> > +     apr_thread_mutex_lock(interpreters_lock);
> > +
> >        PyEval_AcquireLock();
> >    #endif
> > 
> > ***************
> > *** 149,154 ****
> > --- 153,160 ----
> > 
> >    #ifdef WITH_THREAD
> >        PyEval_ReleaseLock();
> > +
> > +     apr_thread_mutex_unlock(interpreters_lock);
> >    #endif
> > 
> >        if (! idata) {
> > ***************
> > *** 469,474 ****
> > --- 475,483 ----
> >        const char *userdata_key = "python_init";
> >        apr_status_t rc;
> > 
> > +     /* fudge for Mac OS X with Apache 1.3 where 
> Py_IsInitialized()  
> > broke */
> > +     static int initialized = 0;
> > +
> >        apr_pool_userdata_get(&data, userdata_key, s->process->pool);
> >        if (!data) {
> >            apr_pool_userdata_set((const void *)1, userdata_key,
> > ***************
> > *** 490,502 ****
> >        }
> > 
> >        /* initialize global Python interpreter if necessary */
> > !     if (! Py_IsInitialized())
> >        {
> > 
> >            /* initialze the interpreter */
> >            Py_Initialize();
> > 
> >    #ifdef WITH_THREAD
> >            /* create and acquire the interpreter lock */
> >            PyEval_InitThreads();
> >    #endif
> > --- 499,514 ----
> >        }
> > 
> >        /* initialize global Python interpreter if necessary */
> > !     if (initialized == 0 || ! Py_IsInitialized())
> >        {
> > +         initialized = 1;
> > 
> >            /* initialze the interpreter */
> >            Py_Initialize();
> > 
> >    #ifdef WITH_THREAD
> > +          
> > apr_thread_mutex_create(&interpreters_lock,APR_THREAD_MUTEX_UN
> > NESTED,p);
> > +
> >            /* create and acquire the interpreter lock */
> >            PyEval_InitThreads();
> >    #endif
> > 
> > 
> > 
> > 
> > 
> > --
> > Graham Dumpleton (grahamd@dscpl.com.au)
> > 
> > 
> 
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: error.2.log
Type: application/octet-stream
Size: 986 bytes
Desc: not available
Url : http://modpython.org/pipermail/mod_python/attachments/20041016/6f0a27b6/error.2-0001.obj
-------------- next part --------------
A non-text attachment was scrubbed...
Name: error.1.log
Type: application/octet-stream
Size: 13154 bytes
Desc: not available
Url : http://modpython.org/pipermail/mod_python/attachments/20041016/6f0a27b6/error.1-0001.obj
From nicolas at lehuen.com  Sat Oct 16 17:56:40 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Sat Oct 16 10:56:43 2004
Subject: [mod_python] RE: Bug in mod_python.c causing
	multiple/redundantinterpreter creation.
Message-ID: <20041016145640.B3F161734F4@postfix3-1.free.fr>

Just as a note, I did try to use my fix to apache.py without your fix to
mod_python.c, and I do get multiple reloadings of the publisher handler due
to the creation of multiple Python interpreter. So the two fixes are both
required. Thanks again Graham !

BTW, Grisha, I now have two patches to apply to mod_python to make it usable
in my production environment :

1) My patch to requestobject.c to make it garbage-collection friendly
2) Graham's patch to mod_python.c and my patch to apache.py to make it
multi-thread safe.

I have built a private subversion repository to track the official
mod_python CVS on the one side, and those patches I can't work without on
the other side. Would it be possible to integrate those patches in the CVS
instead ? Please, pretty please ?

Regards,
Nicolas 

> -----Message d'origine-----
> De : Nicolas Lehuen [mailto:nicolas@lehuen.com] 
> Envoy? : samedi 16 octobre 2004 16:47
> ? : 'Nicolas Lehuen'; 'Graham Dumpleton'
> Cc : 'mod_python@modpython.org'
> Objet : RE: [mod_python] RE: Bug in mod_python.c causing 
> multiple/redundantinterpreter creation.
> 
> Graham, I recompiled mod_python with your fixes, but 
> unfortunately I still have the problem. Let me explain you 
> how I get it.
> 
> I have a pretty simple debug page published by 
> mod_python.publisher. I use ApacheBenchmark to have 50 
> concurrent connections to my Apache server just after the 
> Apache server is started, as follows :
> 
> c:\apache\bin\ab.exe -c 50 -n 1000 http://localhost/python/index.py
> 
> What I get in the error log is joined to this message (see 
> error.1.log).
> 
> If I don't have concurrent connections, mod_python behaves as 
> expected (see error.2.log) :
> 
> c:\apache\bin\ab.exe -c 1 -n 1000 http://localhost/python/index.py
> 
> Note the exception in error.1.log : mod_python.publisher is 
> reloaded many times. I think that your patch may solve a 
> problem with mod_python creating multiple interpreters with 
> the same name, but there is stil a problem in the 
> mod_python.apache module, since it reloads the same publisher 
> many times.
> 
> Indeed, having a look at apache.py, I didn't see any locking 
> done to prevent the same module from being reloaded multiple 
> times concurrently. What we need is to put a lock in the 
> import_module method, so that two threads cannot check the 
> freshness of the publisher simultaneously. This can be done 
> in a rather brutal way by calling imp.acquire_lock() at the 
> beginning of import_module, put a try/finally block around 
> the code of the function and call imp.release_lock() in the 
> finally block : 
> 
> def import_module(module_name, autoreload=1, log=0, path=None):
>     """
>     Get the module to handle the request. If
>     autoreload is on, then the module will be reloaded
>     if it has changed since the last import.
>     """
> 
>     imp.acquire_lock()
>     try:
> 	# previous code of apache.import_module
>     finally:
>         imp.release_lock()
> 
> I tested this, and it works as expected. BTW, maybe it 
> wouldn't work without your patch, Graham, since I could 
> suddenly see two interpreters with their own copy of the 
> mod_python.apache module. But the two fixes are required for 
> it to work properly.
> 
> Why did I wrote "in a rather brutal way" above ? Because this 
> locking scheme is indeed brutal. It is a global lock, so each 
> and every thread who want to get its handler must acquire it 
> for a brief amount of time. The problem is that if a handler 
> module is reloaded, it locks each and every other thread 
> during its reloading, even if they should not be handled by 
> the same module. A smarter way to lock would be to use a 
> two-levels locking scheme, as I described in my caching 
> recipe in the Python Cookbook. I can implement it there if 
> it's ok for everybody.
> 
> Regards,
> Nicolas
> 
> > -----Message d'origine-----
> > De : mod_python-bounces@modpython.org 
> > [mailto:mod_python-bounces@modpython.org] De la part de 
> Nicolas Lehuen 
> > Envoy? : samedi 16 octobre 2004 15:41 ? : 'Graham Dumpleton'
> > Cc : mod_python@modpython.org
> > Objet : [mod_python] RE: Bug in mod_python.c causing 
> > multiple/redundantinterpreter creation.
> > 
> > Thanks Graham, that's great news that you managed to find 
> the issue. 
> > I'll see if I can make a build for Win32 with your patch 
> and tell you 
> > if it works for me.
> > 
> > Regards,
> > 
> > Nicolas
> > 
> > > -----Message d'origine-----
> > > De : Graham Dumpleton [mailto:grahamd@dscpl.com.au] Envoy?
> > : samedi 16
> > > octobre 2004 15:05 ? : Nicolas Lehuen Cc : 'Daniel Popowich'; 
> > > mod_python@modpython.org Objet : Bug in mod_python.c causing 
> > > multiple/redundant interpreter creation.
> > > 
> > > 
> > > On 09/10/2004, at 6:10 PM, Nicolas Lehuen wrote:
> > > 
> > > > Hi Graham, what are the pros and cons of using the imp
> > > module versus
> > > > an execfile call or an exec call ?
> > > >
> > > > Using Apache 2.0.52 on win32, with a multithreaded MPM, I
> > > have noticed
> > > > a few problem with mod_python.publisher which reloads the
> > > same module
> > > > many times when many threads try to load it concurrently. 
> > It seems
> > > > that either mod_python.publisher or the imp module does not
> > > properly
> > > > handle this situation. The result is that I have many
> > > instances of the
> > > > same module in memory, so I got many connection pools
> > > instead of only
> > > > one and so on.
> > > > That's
> > > > why I decided to fix this and other problems (the famous
> > 'only one
> > > > index.py in your application') by reimplementing my own
> > > variant of the
> > > > publisher.
> > > 
> > > Found it.
> > > 
> > >  From what I can tell, there is actually a bug in 
> mod_python.c which 
> > > is causing the problem you describe as "reloads the same 
> module many 
> > > times when many threads try to load it concurrently".
> > > 
> > > I am going to describe it quickly as it is getting late for
> > me and I
> > > need
> > > some sleep. Have attached a patch for people to evaluate and try. 
> > > Note that the patch also includes a Mac OS X specific 
> fix. That fix 
> > > is harmless in itself so just leave it in. The important 
> changes are 
> > > where APR mutex is created and then locked/unlocked.
> > > 
> > > The basic problem revolves around the Python dictionary 
> used to hold 
> > > the set of interpreters. The code in mod_python.c is 
> trying to use 
> > > the Python GIL to provide exclusive access to that dictionary and 
> > > any
> > subsequent
> > > creation of an interpreter.
> > > 
> > > The only catch is that in creating a new interpreter, the Python 
> > > core is, in someway I don't understand, swapping thread states at
> > some point
> > > which
> > > is allowing other threads to acquire the GIL. This is
> > allowing other
> > > threads
> > > to check the set of interpreters for the same interpreter that is 
> > > currently being constructed and since it isn't there yet, 
> then also
> > goes onto
> > > create
> > > it as well.
> > > 
> > > The result is you get many threads in the same process 
> creating the 
> > > same named interpreter and loading the top level handler 
> defined by 
> > > the directive PythonHandler (or other earlier handler). 
> Thus you see 
> > > all
> > the logged
> > > messages about (re)importing the handler, as each thread 
> has managed 
> > > to get to the point of doing it.
> > > 
> > > What should have happened is that if the lock was truly
> > exclusive, the
> > > subsequent threads would have waited until the first had actually 
> > > finished creating the interpreter in the first place.
> > > 
> > > The patch for the problem is below. What I do is create 
> an APR mutex 
> > > and lock that around the outside of the acquisition of the GIL,
> > the GIL
> > > still
> > > being required.
> > > 
> > > In all the debugging I have in place in my code, I still note 
> > > something else not quite right in respect of the mod_python.apache
> > module being
> > > reloaded more than once by a thread. I'll dig further into that 
> > > tomorrow.
> > > 
> > > 
> > > 
> > > *** mod_python.c.dist	Fri Sep 24 15:11:32 2004
> > > --- mod_python.c	Sat Oct 16 22:36:30 2004
> > > ***************
> > > *** 31,36 ****
> > > --- 31,38 ----
> > >     * (In a Python dictionary) */
> > >    static PyObject * interpreters = NULL;
> > > 
> > > + static apr_thread_mutex_t* interpreters_lock = 0;
> > > +
> > >    apr_pool_t *child_init_pool = NULL;
> > > 
> > >    /**
> > > ***************
> > > *** 124,129 ****
> > > --- 126,133 ----
> > >            name = MAIN_INTERPRETER;
> > > 
> > >    #ifdef WITH_THREAD
> > > +     apr_thread_mutex_lock(interpreters_lock);
> > > +
> > >        PyEval_AcquireLock();
> > >    #endif
> > > 
> > > ***************
> > > *** 149,154 ****
> > > --- 153,160 ----
> > > 
> > >    #ifdef WITH_THREAD
> > >        PyEval_ReleaseLock();
> > > +
> > > +     apr_thread_mutex_unlock(interpreters_lock);
> > >    #endif
> > > 
> > >        if (! idata) {
> > > ***************
> > > *** 469,474 ****
> > > --- 475,483 ----
> > >        const char *userdata_key = "python_init";
> > >        apr_status_t rc;
> > > 
> > > +     /* fudge for Mac OS X with Apache 1.3 where
> > Py_IsInitialized()
> > > broke */
> > > +     static int initialized = 0;
> > > +
> > >        apr_pool_userdata_get(&data, userdata_key, 
> s->process->pool);
> > >        if (!data) {
> > >            apr_pool_userdata_set((const void *)1, userdata_key,
> > > ***************
> > > *** 490,502 ****
> > >        }
> > > 
> > >        /* initialize global Python interpreter if necessary */
> > > !     if (! Py_IsInitialized())
> > >        {
> > > 
> > >            /* initialze the interpreter */
> > >            Py_Initialize();
> > > 
> > >    #ifdef WITH_THREAD
> > >            /* create and acquire the interpreter lock */
> > >            PyEval_InitThreads();
> > >    #endif
> > > --- 499,514 ----
> > >        }
> > > 
> > >        /* initialize global Python interpreter if necessary */
> > > !     if (initialized == 0 || ! Py_IsInitialized())
> > >        {
> > > +         initialized = 1;
> > > 
> > >            /* initialze the interpreter */
> > >            Py_Initialize();
> > > 
> > >    #ifdef WITH_THREAD
> > > +          
> > > apr_thread_mutex_create(&interpreters_lock,APR_THREAD_MUTEX_UN
> > > NESTED,p);
> > > +
> > >            /* create and acquire the interpreter lock */
> > >            PyEval_InitThreads();
> > >    #endif
> > > 
> > > 
> > > 
> > > 
> > > 
> > > --
> > > Graham Dumpleton (grahamd@dscpl.com.au)
> > > 
> > > 
> > 
> > 
> > _______________________________________________
> > Mod_python mailing list
> > Mod_python@modpython.org
> > http://mailman.modpython.org/mailman/listinfo/mod_python
> > 


From grahamd at dscpl.com.au  Sun Oct 17 10:01:17 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Oct 16 19:01:27 2004
Subject: [mod_python] Re: Bug in mod_python.c causing multiple/redundant
	interpreter creation.
In-Reply-To: <20041016093010.T47684@onyx.ispol.com>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
	<EBE0766E-1F73-11D9-9AA7-000393DCF16E@dscpl.com.au>
	<53B40358-1F75-11D9-9AA7-000393DCF16E@dscpl.com.au>
	<20041016093010.T47684@onyx.ispol.com>
Message-ID: <4948EFD1-1FC7-11D9-9AA7-000393DCF16E@dscpl.com.au>


On 16/10/2004, at 11:31 PM, Gregory (Grisha) Trubetskoy wrote:

>
>
> On Sat, 16 Oct 2004, Graham Dumpleton wrote:
>
>> Since the Python apache.import_module() function is going to be called
>> to load your content handler, and that has to do file i/o, would be a 
>> very
>> good candidate for the GIL being given up and thus letting the other 
>> threads
>> in to be able to check to see if the interpreter needs creating.
>
> I'm pretty sure Python already does release the GIL where necessary 
> (such as IO during import), so there is no need to do that from within 
> mod_python.

I realise that Python already releases the GIL. I mentioned it as the 
reason why
it possibly gets released and the other threads are getting in, not 
that we have
to do it. :-)

Anyway, import_module() is actually irrelevant in this case, as it 
isn't going
to get called when the interpreter is being first created, but later. 
All the same,
there will still be other stuff which can result in the GIL being 
released. This
might be file i/o or it might be that Python will release it every so 
often when
executing Python code in case there are other threads also running in 
Python code
that want to do something.



--
Graham Dumpleton (grahamd@dscpl.com.au)

From grahamd at dscpl.com.au  Sun Oct 17 10:07:08 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Oct 16 19:07:17 2004
Subject: [mod_python] Bug in mod_python.c causing multiple/redundant
	interpreter creation.
In-Reply-To: <20041016092933.Y47684@onyx.ispol.com>
References: <20041009081038.1F587C6B8@postfix3-2.free.fr>
	<EBE0766E-1F73-11D9-9AA7-000393DCF16E@dscpl.com.au>
	<20041016092933.Y47684@onyx.ispol.com>
Message-ID: <1A903461-1FC8-11D9-9AA7-000393DCF16E@dscpl.com.au>


On 16/10/2004, at 11:30 PM, Gregory (Grisha) Trubetskoy wrote:

>
> Thanks for this. Does this compile/run with threads disabled as well?

Except for the static variable definition, the code was kept inside the:

   #ifdef WITH_THREAD

checks. If for some reason APR doesn't define its mutex type when no
threads, then that definition should also be inside a #ifdef check.

I haven't actually tried compiling it without threads though.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From grahamd at dscpl.com.au  Sun Oct 17 10:32:00 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sat Oct 16 19:32:08 2004
Subject: [mod_python] RE: Bug in mod_python.c causing
	multiple/redundantinterpreter creation.
In-Reply-To: <20041016144632.2D597173559@postfix3-1.free.fr>
References: <20041016144632.2D597173559@postfix3-1.free.fr>
Message-ID: <93CD6910-1FCB-11D9-9AA7-000393DCF16E@dscpl.com.au>

I knew there was an issue with apache.py as well, with there being no 
locking,
but didn't mention it in my email with the fix as I wanted to check 
that that
was the source of the other problem I was seeing and make sure I came 
up with
a proper fix.

I was also thinking to suggest using 
imp.acquire_lock()/imp.release_lock(), but
you need to have a fallback for when version of Python older than 2.3 
as those
functions were only introduced in that version.

I'll come up with proper code later, but I was going to suggest 
something like:

if not globals().has_key("_import_lock"):
   try:
     from threading import Lock
   except:
     class Lock:
       def acquire(self): pass
       def release(self): pass

   _import_lock = Lock()

def import_module(module_name, autoreload=1, log=0, path=None):
     """
     Get the module to handle the request. If
     autoreload is on, then the module will be reloaded
     if it has changed since the last import.
     """

     _import_lock.acquire()
     try:
	# previous code of apache.import_module
     finally:
         _import_lock.release()

This mess is needed to cater for when threading isn't compiled in to 
Python,
use of an older version of Python that didn't have the imp lock 
functions
and also to avoid risk that apache module might get touched and reloaded
and thus lock being overwritten.

With the way that the apache module caching uses sys.modules as its 
cache
and doesn't keep a separate data structure, I am not sure that a two 
level
locking mechanism would be a good idea. The lock for a two level scheme
would at the moment need to be stored in the module itself, as is 
__mtime__
at present.

Frankly, I reckon the whole thing should be redone using execfile() and 
a
purpose built search routine in place of imp.find_module(). All you 
loose
is the ability to use .pyc/.pyo files. If implemented correctly, you 
would
also loose the restriction in mod_python.publisher about having two 
copies
of the index.py file in different places, but that would actually be a 
gain.

You could optionally, have the support for the __clone__ type method I 
was
talking about before. Ie., in my module reloading mechanism, I load 
into a
fresh module, but a rewrite of the apache scheme, would need to preserve
the behaviour of reloading into the existing one otherwise existing code
might break. The presence of a __clone__ method could turn that off and
instead a new module used in a replacement for the apache scheme.

If one is reimplementing it to this extent, then you could introduce a 
two
level locking mechanism.

On 17/10/2004, at 12:46 AM, Nicolas Lehuen wrote:

> Indeed, having a look at apache.py, I didn't see any locking done to 
> prevent
> the same module from being reloaded multiple times concurrently. What 
> we
> need is to put a lock in the import_module method, so that two threads
> cannot check the freshness of the publisher simultaneously. This can 
> be done
> in a rather brutal way by calling imp.acquire_lock() at the beginning 
> of
> import_module, put a try/finally block around the code of the function 
> and
> call imp.release_lock() in the finally block :
>
> def import_module(module_name, autoreload=1, log=0, path=None):
>     """
>     Get the module to handle the request. If
>     autoreload is on, then the module will be reloaded
>     if it has changed since the last import.
>     """
>
>     imp.acquire_lock()
>     try:
> 	# previous code of apache.import_module
>     finally:
>         imp.release_lock()
>
> I tested this, and it works as expected. BTW, maybe it wouldn't work 
> without
> your patch, Graham, since I could suddenly see two interpreters with 
> their
> own copy of the mod_python.apache module. But the two fixes are 
> required for
> it to work properly.
>
> Why did I wrote "in a rather brutal way" above ? Because this locking 
> scheme
> is indeed brutal. It is a global lock, so each and every thread who 
> want to
> get its handler must acquire it for a brief amount of time. The 
> problem is
> that if a handler module is reloaded, it locks each and every other 
> thread
> during its reloading, even if they should not be handled by the same 
> module.
> A smarter way to lock would be to use a two-levels locking scheme, as I
> described in my caching recipe in the Python Cookbook. I can implement 
> it
> there if it's ok for everybody.



--
Graham Dumpleton (grahamd@dscpl.com.au)

From grahamd at dscpl.com.au  Sun Oct 17 16:54:08 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Oct 17 01:54:16 2004
Subject: [mod_python] RE: Bug in mod_python.c causing
	multiple/redundantinterpreter creation.
In-Reply-To: <93CD6910-1FCB-11D9-9AA7-000393DCF16E@dscpl.com.au>
References: <20041016144632.2D597173559@postfix3-1.free.fr>
	<93CD6910-1FCB-11D9-9AA7-000393DCF16E@dscpl.com.au>
Message-ID: <F5E5C843-2000-11D9-9AA7-000393DCF16E@dscpl.com.au>


On 17/10/2004, at 9:32 AM, Graham Dumpleton wrote:

> I knew there was an issue with apache.py as well, with there being no 
> locking,
> but didn't mention it in my email with the fix as I wanted to check 
> that that
> was the source of the other problem I was seeing and make sure I came 
> up with
> a proper fix.

Turns out I had made the fix to the import_module() method as the first 
thing I
did, looks like I forgot. This is actually the way I uncovered that 
there was still
a further problem and thus the bug with creation of multiple 
interpreters. I spent
a good few hours tracking the problem done and then coming up with a 
fix. Drove me
nuts for a while as I knew exactly what I had to do to fix it but the 
result would
just hang. Finally realised the locking had to be done outside of the 
GIL locking
and not inside. Putting it inside later resulted in deadlock.

Anyway, the fix to apache.py I am running with at the moment is:

try:
   from threading import Lock
except:
   class Lock:
     def acquire(self): pass
     def release(self): pass

_lock = Lock()

...

def import_module(module_name, autoreload=1, log=0, path=None):
   _lock.acquire()
   try:
     return _unsafe_import_module(module_name, \
         autoreload=autoreload,log=log,path=path)
   finally:
     _lock.release()

def _unsafe_import_module(module_name, autoreload=1, log=0, path=None):
     """
     Get the module to handle the request. If
     autoreload is on, then the module will be reloaded
     if it has changed since the last import.
     """

     ...

Ie., create the lock in a way that will work if no threading or using 
Python 2.2
and then rename existing import_module() and wrap that in safe locking 
version.

Have done away with the funny check against reloading as doesn't seem 
necessary
because of the way apache.py is initially loaded. Theoretically it 
could get
screwed if someone did an import_module() call for "mod_python.apache" 
but that
is unlikely.

This obviously is to be used in conjunction with the mod_python.c fix 
already
posted.

I also worked out what the other strange thing that was happening and 
which had
me worried. Namely, even though I had fixed it so that only one 
interpreter
was being created per process, was still seeing the apache.py module 
get loaded
more than once. Turned out to be that there were still two interpreters 
being
created. These were the one for the machine host and then later on the 
one
for the "main_interpreter". If PythonInterpreter was set to 
"main_interpreter"
then only saw apache.py being loaded once as one would expect.

I am happy now that everything is working okay with these two changes 
and I
believe I can safely release another version of Vampire which works 
properly
in multithreaded environment. I will just need to include details of 
these bugs
so people are aware of them and can fix them if they want to.

Next question is whether or not if I write a reimplemented 
import_module() method
which fixes the mod_python.publisher single module name instance 
problem and which
can optionally reload into a fresh module to avoid problems with code 
being changed
from underneath a separate executing thread, whether anyone is 
interested. I may
have to provide actual examples of the latter problem, as not sure 
people may
have been convinced of my previous description of the problem.

The other option I am investigating is how to integrate 
mod_python.publisher style
functionality into the structure of Vampire. This would avoid 
suggesting that
import_module() be rewritten as have already solved the problems in the 
Vampire
module loading mechanism. The only thing is that I am not too keen on 
some aspects
of how mod_python.publisher works so have to come up with a mechanism 
for doing it
which sits right with my personal view on things. :-)

--
Graham Dumpleton (grahamd@dscpl.com.au)

From grahamd at dscpl.com.au  Sun Oct 17 22:17:15 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Sun Oct 17 07:17:24 2004
Subject: [mod_python] RE: Bug in mod_python.c causing
	multiple/redundantinterpreter creation.
In-Reply-To: <F5E5C843-2000-11D9-9AA7-000393DCF16E@dscpl.com.au>
Message-ID: <1991DA99-202E-11D9-81AC-000393BB31F6@dscpl.com.au>


On Sunday, October 17, 2004, at 03:54  PM, Graham Dumpleton wrote:

>
> On 17/10/2004, at 9:32 AM, Graham Dumpleton wrote:
>
>> I knew there was an issue with apache.py as well, with there being no 
>> locking,
>> but didn't mention it in my email with the fix as I wanted to check 
>> that that
>> was the source of the other problem I was seeing and make sure I came 
>> up with
>> a proper fix.
>
> Turns out I had made the fix to the import_module() method as the 
> first thing I
> did, looks like I forgot. This is actually the way I uncovered that 
> there was still
> a further problem and thus the bug with creation of multiple 
> interpreters. I spent
> a good few hours tracking the problem done and then coming up with a 
> fix. Drove me
> nuts for a while as I knew exactly what I had to do to fix it but the 
> result would
> just hang. Finally realised the locking had to be done outside of the 
> GIL locking
> and not inside. Putting it inside later resulted in deadlock.
>
> Anyway, the fix to apache.py I am running with at the moment is:
>
> try:
>   from threading import Lock
> except:
>   class Lock:
>     def acquire(self): pass
>     def release(self): pass
>
> _lock = Lock()

Whoops. That should be RLock and not Lock. Lock is not reentrant so if 
a module which
was being imported called back into import_module(), it would deadlock 
on itself. Thus
should use RLock instead. Ie.,

try:
   from threading import RLock
except:
   class RLock:
     def acquire(self): pass
     def release(self): pass

_lock = RLock()

The two level locking scheme is still going to be better, as an import 
that takes
a long time to execute is going to block out new requests for that 
time. The
import_module() method really needs to be rewritten completely to 
address this
properly. :-(

--
Graham Dumpleton (grahamd@dscpl.com.au)

From ppercot at free.fr  Sun Oct 17 15:20:02 2004
From: ppercot at free.fr (Patrick Percot)
Date: Sun Oct 17 08:20:08 2004
Subject: [mod_python] Re: confirm 02dba1729eedeae7394a7f3a99534b26315a22be
In-Reply-To: <mailman.1252.1098015169.3093.mod_python@modpython.org>
References: <mailman.1252.1098015169.3093.mod_python@modpython.org>
Message-ID: <20041017.142002.104037737.ppercot@free.fr>

On Sun, 17 Oct 2004 08:12:49 -0400, mod_python-request@modpython.org wrote

> Mailing list removal confirmation notice for mailing list Mod_python
> 
> We have received a request for the removal of your email address,
> "ppercot@free.fr" from the mod_python@modpython.org mailing list.  To
> confirm that you want to be removed from this mailing list, simply
> reply to this message, keeping the Subject: header intact.  Or visit
> this web page:
> 
>     http://mailman.modpython.org/mailman/confirm/mod_python/02dba1729eedeae7394a7f3a99534b26315a22be
> 
> 
> Or include the following line -- and only the following line -- in a
> message to mod_python-request@modpython.org:
> 
>     confirm 02dba1729eedeae7394a7f3a99534b26315a22be
> 
> Note that simply sending a `reply' to this message should work from
> most mail readers, since that usually leaves the Subject: line in the
> right form (additional "Re:" text in the Subject: is okay).
> 
> If you do not wish to be removed from this list, please simply
> disregard this message.  If you think you are being maliciously
> removed from the list, or have any other questions, send them to
> mod_python-owner@modpython.org.
> 

?+
PP
-- 
Groupe Morbihannais d'Utilisateurs de Logiciels Libres http://www.tuxbihan.org
GPG fingerprint = 1A4F E154 3D2C A20E E4CA  A543 7951 C5C2 E44A A0B5

Patrick Percot.

From nicolas at lehuen.com  Sun Oct 17 16:45:16 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Sun Oct 17 09:45:21 2004
Subject: [mod_python] RE: Bug in mod_python.c causing
	multiple/redundantinterpreter creation.
In-Reply-To: <93CD6910-1FCB-11D9-9AA7-000393DCF16E@dscpl.com.au>
Message-ID: <20041017134518.9E7991DFD8F@postfix4-1.free.fr>

 

> -----Message d'origine-----
> De : Graham Dumpleton [mailto:grahamd@dscpl.com.au] 
> Envoy? : dimanche 17 octobre 2004 01:32
> ? : Nicolas Lehuen
> Cc : mod_python@modpython.org
> Objet : Re: [mod_python] RE: Bug in mod_python.c causing 
> multiple/redundantinterpreter creation.
> 
> I knew there was an issue with apache.py as well, with there 
> being no locking, but didn't mention it in my email with the 
> fix as I wanted to check that that was the source of the 
> other problem I was seeing and make sure I came up with a proper fix.
> 
> I was also thinking to suggest using
> imp.acquire_lock()/imp.release_lock(), but you need to have a 
> fallback for when version of Python older than 2.3 as those 
> functions were only introduced in that version.

I know this is *bad* but I really think people should move forward and
upgrade to 2.3. Heck, it's not as if 2.3 was brand new ! It always makes me
cringe when people do their best to support versions as old as Python 1.5.
Why is it so difficult to upgrade ?

> I'll come up with proper code later, but I was going to 
> suggest something like:
> 
> if not globals().has_key("_import_lock"):
>    try:
>      from threading import Lock
>    except:
>      class Lock:
>        def acquire(self): pass
>        def release(self): pass
> 
>    _import_lock = Lock()
> 
> def import_module(module_name, autoreload=1, log=0, path=None):
>      """
>      Get the module to handle the request. If
>      autoreload is on, then the module will be reloaded
>      if it has changed since the last import.
>      """
> 
>      _import_lock.acquire()
>      try:
> 	# previous code of apache.import_module
>      finally:
>          _import_lock.release()
> 
> This mess is needed to cater for when threading isn't 
> compiled in to Python, use of an older version of Python that 
> didn't have the imp lock functions and also to avoid risk 
> that apache module might get touched and reloaded and thus 
> lock being overwritten.

You should use a RLock (reentrant), not a Lock, in case you use
import_module to import a module which in turn uses import_module.
 
> With the way that the apache module caching uses sys.modules 
> as its cache and doesn't keep a separate data structure, I am 
> not sure that a two level locking mechanism would be a good 
> idea. The lock for a two level scheme would at the moment 
> need to be stored in the module itself, as is __mtime__ at present.
>
> Frankly, I reckon the whole thing should be redone using 
> execfile() and a purpose built search routine in place of 
> imp.find_module(). All you loose is the ability to use 
> .pyc/.pyo files. If implemented correctly, you would also 
> loose the restriction in mod_python.publisher about having 
> two copies of the index.py file in different places, but that 
> would actually be a gain.

Well to me .pyc/.pyo files for published modules are a nuisance, since I had
to add an access rule to prevent them from being readable through HTTP (it
would be quite awful to have some of those modules containing passwords on
the net).

As for the restriction about index.py in mod_python.publisher, I really
don't understand why it's still there. It's pretty easy to remove it, it's
just a name mangling issue ! I rewrote my own publisher just because of this
limitations (then I began to add other features). Now that I understand
better how mod_python works, I see how it can be fixed.

I think the core of the problem is that import_module was designed to be
usable for two distincts purposes : loading pages for the publisher and
loading "normal" modules. Loading "normal" modules should be left to Python,
possibly with somes tasks like reloading implemented in import hooks.
Loading pages for the publisher should be pushed into the publisher, and
should have its own module cache, no need to mess with sys.modules (I don't
consider it good practice for a page to "import" another page).

Regards,

Nicolas

> You could optionally, have the support for the __clone__ type 
> method I was talking about before. Ie., in my module 
> reloading mechanism, I load into a fresh module, but a 
> rewrite of the apache scheme, would need to preserve the 
> behaviour of reloading into the existing one otherwise 
> existing code might break. The presence of a __clone__ method 
> could turn that off and instead a new module used in a 
> replacement for the apache scheme.
> 
> If one is reimplementing it to this extent, then you could 
> introduce a two level locking mechanism.
> 
> On 17/10/2004, at 12:46 AM, Nicolas Lehuen wrote:
> 
> > Indeed, having a look at apache.py, I didn't see any 
> locking done to 
> > prevent the same module from being reloaded multiple times 
> > concurrently. What we need is to put a lock in the import_module 
> > method, so that two threads cannot check the freshness of the 
> > publisher simultaneously. This can be done in a rather 
> brutal way by 
> > calling imp.acquire_lock() at the beginning of import_module, put a 
> > try/finally block around the code of the function and call 
> > imp.release_lock() in the finally block :
> >
> > def import_module(module_name, autoreload=1, log=0, path=None):
> >     """
> >     Get the module to handle the request. If
> >     autoreload is on, then the module will be reloaded
> >     if it has changed since the last import.
> >     """
> >
> >     imp.acquire_lock()
> >     try:
> > 	# previous code of apache.import_module
> >     finally:
> >         imp.release_lock()
> >
> > I tested this, and it works as expected. BTW, maybe it 
> wouldn't work 
> > without your patch, Graham, since I could suddenly see two 
> > interpreters with their own copy of the mod_python.apache 
> module. But 
> > the two fixes are required for it to work properly.
> >
> > Why did I wrote "in a rather brutal way" above ? Because 
> this locking 
> > scheme is indeed brutal. It is a global lock, so each and 
> every thread 
> > who want to get its handler must acquire it for a brief amount of 
> > time. The problem is that if a handler module is reloaded, it locks 
> > each and every other thread during its reloading, even if 
> they should 
> > not be handled by the same module.
> > A smarter way to lock would be to use a two-levels locking 
> scheme, as 
> > I described in my caching recipe in the Python Cookbook. I can 
> > implement it there if it's ok for everybody.
> 
> 
> 
> --
> Graham Dumpleton (grahamd@dscpl.com.au)
> 
> 


From grisha at modpython.org  Sun Oct 17 20:51:11 2004
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Sun Oct 17 20:51:24 2004
Subject: [mod_python] bug in apache.build_cgi_env
In-Reply-To: <3A81C87DC164034AA4E2DDFE11D258E3022F81@exchange.hqamor.amorhq.net>
References: <3A81C87DC164034AA4E2DDFE11D258E3022F81@exchange.hqamor.amorhq.net>
Message-ID: <20041017204855.Q79689@onyx.ispol.com>


This gives you an idea of how much that function is being used :-)

My guess is that in some prior versions of Python length on None used to 
be 0.

I'll add this to the list of things to be fixed, thanks!

Grisha


On Wed, 13 Oct 2004, Robert Brewer wrote:

> Hi,
>
> I'm running mod_python (3.1.3-win32) and trying to write a WSGI wrapper
> for it. I figured I'd call apache.build_cgi_env to get an environ dict,
> but I get the following error message:
>
>  File "C:\Python23\lib\site-packages\mod_python\apache.py", line 541,
> in build_cgi_env
>    if len(req.path_info) > 0:
>
> TypeError: len() of unsized object
>
>
> I've already worked around it, but the function in question is:
>
> def build_cgi_env(req):
>    """
>    Utility function that returns a dictionary of
>    CGI environment variables as described in
>    http://hoohoo.ncsa.uiuc.edu/cgi/env.html
>    """
>
>    req.add_common_vars()
>    env = req.subprocess_env.copy()
>
>    if len(req.path_info) > 0:
>        env["SCRIPT_NAME"] = req.uri[:-len(req.path_info)]
>    else:
>        env["SCRIPT_NAME"] = req.uri
>
>    env["GATEWAY_INTERFACE"] = "Python-CGI/1.1"
>
>    # you may want to comment this out for better security
>    if req.headers_in.has_key("authorization"):
>        env["HTTP_AUTHORIZATION"] = req.headers_in["authorization"]
>
>    return env
>
>
> With a little printlining, it seems my req.path_info is None, and
> therefore has no length. Could we just write the following instead? It
> fixed the problem for me.
>
>    if req.path_info:
>        env["SCRIPT_NAME"] = req.uri[:-len(req.path_info)]
>    else:
>        env["SCRIPT_NAME"] = req.uri
>
>
> Thanks for your time,
>
>
> Robert Brewer
> MIS
> Amor Ministries
> fumanchu@amor.org
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From mike_mp at zzzcomputing.com  Mon Oct 18 16:52:14 2004
From: mike_mp at zzzcomputing.com (mike bayer)
Date: Tue Oct 19 15:04:56 2004
Subject: [mod_python] ANNOUNCE: Myghty 0.94 Released
Message-ID: <25704.66.192.34.8.1098132734.squirrel@66.192.34.8>

Myghty 0.94 Released

Myghty is an all-new Python Server Page (PSP) templating system designed
for large-scale, high availablity websites and applications.  Written and
optimized from the ground up to complement mod_python, as well as
standalone, CGI and application embedded environments, its conceptual
design and syntax is derived from HTML::Mason, the default web application
platform for the mod_perl world.  It is designed with both the migrating
Mason user and the original Python user in mind, supporting the full
featureset of Mason, including components, methods, inheritance,
autohandlers, dhandlers, caching, friendly exception handling, etc. as well
as enhancements including full Python whitespace support, component-
specific autoflush, cache and whitespace trim flags, thread-global code
sections, and a streamlined design taking full advantage of Python's unique
architectural features.  Compares favorably to other Python templating
solutions such as Cheetah and Spyce.

The component cache API is released as of version 0.94 and includes in-
memory and dbm-file based cache implementations, with support for new
implementations configurable at runtime.  The caching API allows fine-
grained caching control for component output as well as user defined data
structures, synchronized and shared among multiple threads, processes, or
both.

Myghty has gained a small userbase in just its first two months which is
growing at a fast pace, receiving favorable reviews for its ease of use,
smooth operation, and great flexibility.

Myghty is released under the GNU Lesser General Public License (LGPL).
Documentation, examples and download links can be found at:

http://www.myghty.org

Michael Bayer

mike_mp@zzzcomputing.com


<P><A HREF="http://www.myghty.org">Myghty 0.94</A> - A high performance
Python Server Page templating system derived from HTML::Mason. (18-Oct-04)


From johannes at erdfelt.com  Tue Oct 19 16:56:50 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Tue Oct 19 16:56:57 2004
Subject: [mod_python] [patch] vampire 1.1 remove unknown query variables
Message-ID: <20041019205650.GD15993@sventech.com>

I've been using vampire the last couple of days and I like it, but it
has some problems some code I originally wrote didn't have.

This patch fixes a problem where unknown query variables (form
variables) could cause an internal server error.

Generally, this shouldn't happen and on a well designed site, it's the
users error for causing this to occur, but it causes some undue alarm
when looking at the logs, so I wrote up this patch to remove unknown
query variables before applying it to the called handler.

It also prints out an error message if variables are required by the
handler, but aren't given by the client (it doesn't have a default)

It applies to vampire 1.1

JE

diff -ur vampire-1.1-20041009.orig/packages/vampire/apache.py vampire-1.1-20041009/packages/vampire/apache.py
--- vampire-1.1-20041009.orig/packages/vampire/apache.py	2004-10-08 18:31:50.000000000 -0700
+++ vampire-1.1-20041009/packages/vampire/apache.py	2004-10-19 13:55:48.000000000 -0700
@@ -171,4 +171,40 @@
 
   # Execute the content handler.
 
-  return apply(function,(req,),args)
+  # Match up the arguments given by the client to the expected arguments
+  # from the method. We only remove non expected names and don't check for
+  # expected because the argument may have a default if not set. We use
+  # exceptions to catch the case where an argument does not have a default.
+  fc = function.func_code
+  expected = fc.co_varnames[0:fc.co_argcount]
+ 
+  # Silently remove any unexpected arguments if we need to
+  if not fc.co_flags & 0x000C:  # CO_VARARGS | CO_VARKEYWORDS
+    for name in args.keys():
+      if name not in expected:
+        del args[name]
+
+  try:
+    return apply(function,(req,),args)
+  except TypeError, vars:
+    missing = []
+
+    # Don't worry about the arguments with defaults
+    argcount = fc.co_argcount
+    if function.func_defaults:
+      argcount = argcount - len(function.func_defaults)
+    # Skip the first argument, which is the req
+    for name in fc.co_varnames[1:argcount]:
+      if name not in args:
+        missing.append(name)
+
+    if not len(missing):
+      raise
+
+    # We definately had some missing variables, let's let the user know
+    req.content_type = "text/plain"
+    req.status = apache.HTTP_INTERNAL_SERVER_ERROR
+    req.send_http_header()
+    req.write("Call is missing these variables: %s\n" % ", ".join(missing))
+
+    return apache.OK
From johannes at erdfelt.com  Tue Oct 19 17:11:25 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Tue Oct 19 17:11:26 2004
Subject: [mod_python] vampire form validation
Message-ID: <20041019211125.GE15993@sventech.com>

As a follow up to my previous patch to make query variable a bit easier
to use in vampire, I have a further reaching suggestion I wanted to
offer up.

In some of my applications, I have some fairly complicated forms that are
in general are a pain to validate that the client sent the correct
variables. When I say validation, I mean at a minimum, requiring the
client send certain variables, and are of the correct base type (integer,
string, etc)

I've written a validator for another project that I'm porting over to
vampire right now. Would there be any interest for a feature like this?

The idea would be that you would specify a new module variable, similar
to the __auth__ variable, called __form_vars__. It would describe the
variables, which are required, what type they should be and possibly a
default value.

The list is built using objects, allowing for extensibility, and is
passed to the application as a class object with the members
automatically created from the name of the variable.

Something like this (I'm in the middle of porting and making some
changes to existing code, so this is a rough draft):

from vampire import form

__form_vars__ = [
  form.integer("userid", required = 0),
  form.submit("submit", [
    form.string("name", required = 1),	# 1 could be the default
    form.string("address"),
    form.string("city"),
    form.string("state"),
    form.string("country", default = "US"),
  ]),
]

The handler would then expect a variable called 'form', which could be
used like this:

  req.write("you requested we create a user with this address:\n")
  req.write("  %s\n" % form.name)
  req.write("  %s\n" % form.address)
  req.write("  %s, %s\n" % (form.city, form.state))
  req.write("  %s\n" % form.state)

Perhaps a form object could be created for HTML radio buttons, allowing
finer grained control over what variables are required:

__form_vars__ = [
  form.radiobutton("choice", {
    "modify": [
      form.string("userid"),
    ],
    "create": [
      form.string("name"),
      form.string("address"),
      ...
    ],
  }),
]

  if form.choice == "modify":
    # modify user
  else:
    # we know this has to be "create" because of the form validation
    # create user

JE

From grahamd at dscpl.com.au  Tue Oct 19 17:12:56 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 19 17:13:00 2004
Subject: [mod_python] Re: [patch] vampire 1.1 remove unknown query variables
In-Reply-To: <20041019205650.GD15993@sventech.com>
References: <20041019205650.GD15993@sventech.com>
Message-ID: <A5BFF970-2213-11D9-9A8E-000393DCF16E@dscpl.com.au>

Thanks, this is good timing.

I was looking at that specific code yesterday so as to start changing 
it to
bring it inline with what mod_python 3.X does in publisher. 
Specifically,
to allow kwargs as last argument of handler to gobble up those which 
aren't
specifically defined as arguments.

Anyway, I have to run out the door right now so no time to even finish 
this
email properly. :-)

Thanks again.

On 20/10/2004, at 6:56 AM, Johannes Erdfelt wrote:

> I've been using vampire the last couple of days and I like it, but it
> has some problems some code I originally wrote didn't have.
>
> This patch fixes a problem where unknown query variables (form
> variables) could cause an internal server error.
>
> Generally, this shouldn't happen and on a well designed site, it's the
> users error for causing this to occur, but it causes some undue alarm
> when looking at the logs, so I wrote up this patch to remove unknown
> query variables before applying it to the called handler.
>
> It also prints out an error message if variables are required by the
> handler, but aren't given by the client (it doesn't have a default)
>
> It applies to vampire 1.1
>
> JE
>
> diff -ur vampire-1.1-20041009.orig/packages/vampire/apache.py 
> vampire-1.1-20041009/packages/vampire/apache.py
> --- vampire-1.1-20041009.orig/packages/vampire/apache.py	2004-10-08 
> 18:31:50.000000000 -0700
> +++ vampire-1.1-20041009/packages/vampire/apache.py	2004-10-19 
> 13:55:48.000000000 -0700
> @@ -171,4 +171,40 @@
>
>    # Execute the content handler.
>
> -  return apply(function,(req,),args)
> +  # Match up the arguments given by the client to the expected 
> arguments
> +  # from the method. We only remove non expected names and don't 
> check for
> +  # expected because the argument may have a default if not set. We 
> use
> +  # exceptions to catch the case where an argument does not have a 
> default.
> +  fc = function.func_code
> +  expected = fc.co_varnames[0:fc.co_argcount]
> +
> +  # Silently remove any unexpected arguments if we need to
> +  if not fc.co_flags & 0x000C:  # CO_VARARGS | CO_VARKEYWORDS
> +    for name in args.keys():
> +      if name not in expected:
> +        del args[name]
> +
> +  try:
> +    return apply(function,(req,),args)
> +  except TypeError, vars:
> +    missing = []
> +
> +    # Don't worry about the arguments with defaults
> +    argcount = fc.co_argcount
> +    if function.func_defaults:
> +      argcount = argcount - len(function.func_defaults)
> +    # Skip the first argument, which is the req
> +    for name in fc.co_varnames[1:argcount]:
> +      if name not in args:
> +        missing.append(name)
> +
> +    if not len(missing):
> +      raise
> +
> +    # We definately had some missing variables, let's let the user 
> know
> +    req.content_type = "text/plain"
> +    req.status = apache.HTTP_INTERNAL_SERVER_ERROR
> +    req.send_http_header()
> +    req.write("Call is missing these variables: %s\n" % ", 
> ".join(missing))
> +
> +    return apache.OK

From grahamd at dscpl.com.au  Tue Oct 19 18:22:46 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 19 18:22:49 2004
Subject: [mod_python] Re: [patch] vampire 1.1 remove unknown query variables
In-Reply-To: <20041019205650.GD15993@sventech.com>
Message-ID: <1098224562.27590@dscpl.com.au>

On Oct 19 13:56, Johannes Erdfelt <johannes@erdfelt.com> wrote:
>
> Subject: [patch] vampire 1.1 remove unknown query variables
>
> +    # We definately had some missing variables, let's let the user know
> +    req.content_type = "text/plain"
> +    req.status = apache.HTTP_INTERNAL_SERVER_ERROR
> +    req.send_http_header()
> +    req.write("Call is missing these variables: %s\n" % ", ".join(missing))
> +
> +    return apache.OK

I am a bit wary of directly generating an error response from this point in
the code.

What may be better is to raise a Python RuntimeWarning exception with the
description of the problem. This will cause mod_python to still return an
internal server error, but one where the details would only be visible when
PythonDebug option is set to On. The error would also be logged into the
log file automatically.

Anyway, still have to come to grips with the whole patch and what it does.
Now that I am at work, will have a bit of time to consume what it does. I have
a couple of other questions to throw into the mix as well. The form validation
mechanism also looks interesting and I will need to digest that as well.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From grahamd at dscpl.com.au  Tue Oct 19 18:31:02 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 19 18:31:04 2004
Subject: [mod_python] "File" class object in form fields.
Message-ID: <1098225062.28374@dscpl.com.au>

In mod_python 2.X, there is code in publisher which says:

       # if it is a file, make File()
       if field.filename:
           val = File(field)
       else:
           val = field.value

class File:
    """ Like a file, but also has headers and filename
    """

    def __init__(self, field):

        # steal all the file-like methods
        for m in field.file.__methods__:
            self.__dict__[m] = getattr(field.file, m)

        self.headers = field.headers
        self.filename = field.filename

In mod_python 3.X, it is:

    # add form data to args
    for field in fs.list:
        if field.filename:
            val = field
        else:
            val = field.value
        args.setdefault(field.name, []).append(val)

The difference being that in mod_python 2.X, it would wrap what it saw as
a file input field into an instance of a special File object.

In Vampire I originally wrote code having only access to mod_python 2.X
and so similarly wrapped fields into a File object if needed. Now seeing that
mod_python 3.X doesn't do it, should I also now not be doing it if it is seen
to be better not do it.

For those who have actually done input forms with file uploading (I haven't)
what does the difference really mean in practice? Which is the better way?

At this stage I am inclined to do it like mod_python 3.X, especially how that
was how I had done this stuff in another system before I even ever looked at
mod_python.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From grahamd at dscpl.com.au  Tue Oct 19 18:46:03 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 19 18:46:06 2004
Subject: [mod_python] vampire form validation
In-Reply-To: <20041019211125.GE15993@sventech.com>
Message-ID: <1098225959.29801@dscpl.com.au>

On Oct 19 14:11, Johannes Erdfelt <johannes@erdfelt.com> wrote:
>
> Subject: [mod_python] vampire form validation
>
> The list is built using objects, allowing for extensibility, and is
> passed to the application as a class object with the members
> automatically created from the name of the variable.
> 
> Something like this (I'm in the middle of porting and making some
> changes to existing code, so this is a rough draft):
> 
> from vampire import form
> 
> __form_vars__ = [
>   form.integer("userid", required = 0),
>   form.submit("submit", [
>     form.string("name", required = 1),	# 1 could be the default
>     form.string("address"),
>     form.string("city"),
>     form.string("state"),
>     form.string("country", default = "US"),
>   ]),
> ]

Would the fact that methods are named based on type be limiting? In
order to be more generic, might you have a single method to register
fields and use type objects instead.

  form.define("address",types.StringType)
  form.define("count",types.IntType)

I guess it still means that internally you have to enumerate out some
methods which do the conversions for the differing types, but if one
had a registration mechanism of some form, it might open up the
possibility where you could define your own custom type objects and
register special decoders for that type to have input automatically
converted into an instance of a special class object you have written
rather than just basic types and lists.

> The handler would then expect a variable called 'form', which could be
> used like this:
> 
>   req.write("you requested we create a user with this address:\n")
>   req.write("  %s\n" % form.name)
>   req.write("  %s\n" % form.address)
>   req.write("  %s, %s\n" % (form.city, form.state))
>   req.write("  %s\n" % form.state)

In mod_python.publisher the util.FieldStorage instance is stuffed into
the req object as req.form. It might be better to do something similar
and stuff it in the req object rather than introduce another special name
that then can't be used as a form field name.

I certainly think something to assist in form validation would be a good
thing and I am sure it is something a few people have probably tackled
before. Thus will be interested to here how other people have approached
it as well. Amongst all the different variants, we can come up with a
nice general approach that suits a lot of needs.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From johannes at erdfelt.com  Tue Oct 19 19:50:02 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Tue Oct 19 19:50:05 2004
Subject: [mod_python] Re: [patch] vampire 1.1 remove unknown query variables
In-Reply-To: <1098224562.27590@dscpl.com.au>
References: <20041019205650.GD15993@sventech.com>
	<1098224562.27590@dscpl.com.au>
Message-ID: <20041019235002.GF15993@sventech.com>

On Tue, Oct 19, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> On Oct 19 13:56, Johannes Erdfelt <johannes@erdfelt.com> wrote:
> >
> > Subject: [patch] vampire 1.1 remove unknown query variables
> >
> > +    # We definately had some missing variables, let's let the user know
> > +    req.content_type = "text/plain"
> > +    req.status = apache.HTTP_INTERNAL_SERVER_ERROR
> > +    req.send_http_header()
> > +    req.write("Call is missing these variables: %s\n" % ", ".join(missing))
> > +
> > +    return apache.OK
> 
> I am a bit wary of directly generating an error response from this point in
> the code.
> 
> What may be better is to raise a Python RuntimeWarning exception with the
> description of the problem. This will cause mod_python to still return an
> internal server error, but one where the details would only be visible when
> PythonDebug option is set to On. The error would also be logged into the
> log file automatically.

That's a good point. Some people may not want this level of information
to be returned to the user.

On the other hand, I hate Internal Server Error messages (and shame on
me for returning that as the error too :). They are kind of misleading
in this case because the error isn't internal to the server, but in the
request from the client.

To some extent, the error code that is returned is a problem since it
causes alarms with my log analysis scripts, but I'm more concerned with
the message that is returned.

> Anyway, still have to come to grips with the whole patch and what it does.
> Now that I am at work, will have a bit of time to consume what it does. I have
> a couple of other questions to throw into the mix as well. The form validation
> mechanism also looks interesting and I will need to digest that as well.

Ok, let me know if you have any questions.

JE

From grahamd at dscpl.com.au  Tue Oct 19 19:51:43 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 19 19:51:46 2004
Subject: [mod_python] Approaches to handling input forms.
Message-ID: <1098229902.36767@dscpl.com.au>

A question on what people perceive as being best practice as far as dealing
with forms when using mod_python.

Imagine there is a form for logging into a site and its url is at "login". I've
ignored extensions in this discussion as different mechanisms may or may
not make it easy to use them.

Is there a tendency to have the form when submitted, post back using
the same url, ie., ACTION field in form is not set, or to a different url.

If the first approach is used, any type of content handler for the resource
must be able to deal with with both no form data or required form data.
If no form data, put up the form, else if form data process the posted form
appropriately.

Upon processing the form, if login was successful, it might redirect to
another resource, or if the login form was actually part of a larger page, it
may then enable display of what other information was on the page.

In this approach you tend to end up with a lot of things jumbled up into
one content handler and it could perceivably get a bit messy.

If the form and the processor of the form are at different urls, there is a
better separation of functionality of presenting the form and its processing.
Being different urls though, you might have to be a bit trickier as far as
using redirects to get back to where you want when login is sucessful
especially if it is a generic login processor.

How do people handle this in the different mechanisms that are available?
Is there a general concensus that one approach is much superior to the other?
Are there any specific things that could be put into a content handler system
that can make this aspect of processing forms easier?


--
Graham Dumpleton (grahamd@dscpl.com.au)
From johannes at erdfelt.com  Tue Oct 19 19:53:36 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Tue Oct 19 19:53:38 2004
Subject: [mod_python] vampire form validation
In-Reply-To: <1098225959.29801@dscpl.com.au>
References: <20041019211125.GE15993@sventech.com>
	<1098225959.29801@dscpl.com.au>
Message-ID: <20041019235336.GG15993@sventech.com>

On Tue, Oct 19, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> On Oct 19 14:11, Johannes Erdfelt <johannes@erdfelt.com> wrote:
> >
> > Subject: [mod_python] vampire form validation
> >
> > The list is built using objects, allowing for extensibility, and is
> > passed to the application as a class object with the members
> > automatically created from the name of the variable.
> > 
> > Something like this (I'm in the middle of porting and making some
> > changes to existing code, so this is a rough draft):
> > 
> > from vampire import form
> > 
> > __form_vars__ = [
> >   form.integer("userid", required = 0),
> >   form.submit("submit", [
> >     form.string("name", required = 1),	# 1 could be the default
> >     form.string("address"),
> >     form.string("city"),
> >     form.string("state"),
> >     form.string("country", default = "US"),
> >   ]),
> > ]
> 
> Would the fact that methods are named based on type be limiting? In
> order to be more generic, might you have a single method to register
> fields and use type objects instead.
> 
>   form.define("address",types.StringType)
>   form.define("count",types.IntType)
> 
> I guess it still means that internally you have to enumerate out some
> methods which do the conversions for the differing types, but if one
> had a registration mechanism of some form, it might open up the
> possibility where you could define your own custom type objects and
> register special decoders for that type to have input automatically
> converted into an instance of a special class object you have written
> rather than just basic types and lists.

I figure this can all be done via classes. The implementation I've done
has a base class, and then all of the type clases derived. If one wanted
to make a phone number validator, they could extend the form.string class
to do some extra validation to ensure the type is a string and it's a
well formed phone number.

Although I don't know how useful that will be. All of the cases I've
thought of have complex interdependencies that might not be easy to
implement (phone number formats vary from country to country so to
ensure it's valid, it would need to know the country, etc...)

Atleast it's possible to be done :)

> > The handler would then expect a variable called 'form', which could be
> > used like this:
> > 
> >   req.write("you requested we create a user with this address:\n")
> >   req.write("  %s\n" % form.name)
> >   req.write("  %s\n" % form.address)
> >   req.write("  %s, %s\n" % (form.city, form.state))
> >   req.write("  %s\n" % form.state)
> 
> In mod_python.publisher the util.FieldStorage instance is stuffed into
> the req object as req.form. It might be better to do something similar
> and stuff it in the req object rather than introduce another special name
> that then can't be used as a form field name.

That's a good point. It's not necessary and should probably be left in
the req object like it currently is.

> I certainly think something to assist in form validation would be a good
> thing and I am sure it is something a few people have probably tackled
> before. Thus will be interested to here how other people have approached
> it as well. Amongst all the different variants, we can come up with a
> nice general approach that suits a lot of needs.

Yes, that was what I was hoping for while I ported and modified my
implementation.

When I get mine done, I'll post a patch for comments.

JE

From grahamd at dscpl.com.au  Tue Oct 19 20:05:44 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 19 20:05:48 2004
Subject: [mod_python] Re: [patch] vampire 1.1 remove unknown query variables
In-Reply-To: <20041019235002.GF15993@sventech.com>
Message-ID: <1098230739.38457@dscpl.com.au>

On Oct 19 16:50, Johannes Erdfelt <johannes@erdfelt.com> wrote:
>
> Subject: Re: [patch] vampire 1.1 remove unknown query variables
>
> On Tue, Oct 19, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> > On Oct 19 13:56, Johannes Erdfelt <johannes@erdfelt.com> wrote:
> > >
> > > Subject: [patch] vampire 1.1 remove unknown query variables
> > >
> > > +    # We definately had some missing variables, let's let the user know
> > > +    req.content_type = "text/plain"
> > > +    req.status = apache.HTTP_INTERNAL_SERVER_ERROR
> > > +    req.send_http_header()
> > > +    req.write("Call is missing these variables: %s\n" % ", ".join(missing))
> > > +
> > > +    return apache.OK
> > 
> > I am a bit wary of directly generating an error response from this point in
> > the code.
> > 
> > What may be better is to raise a Python RuntimeWarning exception with the
> > description of the problem. This will cause mod_python to still return an
> > internal server error, but one where the details would only be visible when
> > PythonDebug option is set to On. The error would also be logged into the
> > log file automatically.
> 
> That's a good point. Some people may not want this level of information
> to be returned to the user.
> 
> On the other hand, I hate Internal Server Error messages (and shame on
> me for returning that as the error too :). They are kind of misleading
> in this case because the error isn't internal to the server, but in the
> request from the client.
> 
> To some extent, the error code that is returned is a problem since it
> causes alarms with my log analysis scripts, but I'm more concerned with
> the message that is returned.

Well, it could still be done in Vampire as you propose, but simply have it
honour the PythonDebug setting. It may be more approriate to return a
HTTP_BAD_REQUEST if HTTP_INTERNAL_SERVER_ERROR is not appropriate
in this case.

Unfortunately the mod_python routine for generating internal server
error responses, with details as appropriate if PyhonDebug is on isn't a
generically usable routine that could be used to do it and I don't think
it allows an alternate status anyway. Vampire could provide such a
generic routine that might even also be usable in some way from a user
content handler when they want to return errors, but with a message
when PythonDebug is set.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From johannes at erdfelt.com  Tue Oct 19 20:17:38 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Tue Oct 19 20:17:40 2004
Subject: [mod_python] Re: [patch] vampire 1.1 remove unknown query variables
In-Reply-To: <1098230739.38457@dscpl.com.au>
References: <20041019235002.GF15993@sventech.com>
	<1098230739.38457@dscpl.com.au>
Message-ID: <20041020001738.GJ15993@sventech.com>

On Tue, Oct 19, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> On Oct 19 16:50, Johannes Erdfelt <johannes@erdfelt.com> wrote:
> > On Tue, Oct 19, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> > > I am a bit wary of directly generating an error response from this point in
> > > the code.
> > > 
> > > What may be better is to raise a Python RuntimeWarning exception with the
> > > description of the problem. This will cause mod_python to still return an
> > > internal server error, but one where the details would only be visible when
> > > PythonDebug option is set to On. The error would also be logged into the
> > > log file automatically.
> > 
> > That's a good point. Some people may not want this level of information
> > to be returned to the user.
> > 
> > On the other hand, I hate Internal Server Error messages (and shame on
> > me for returning that as the error too :). They are kind of misleading
> > in this case because the error isn't internal to the server, but in the
> > request from the client.
> > 
> > To some extent, the error code that is returned is a problem since it
> > causes alarms with my log analysis scripts, but I'm more concerned with
> > the message that is returned.
> 
> Well, it could still be done in Vampire as you propose, but simply have it
> honour the PythonDebug setting. It may be more approriate to return a
> HTTP_BAD_REQUEST if HTTP_INTERNAL_SERVER_ERROR is not appropriate
> in this case.

I looked at HTTP_BAD_REQUEST, but the HTTP specs seem to imply that it
should only be returned when there is a parsing error during the command
parsing phase. Like if the "GET" or "PUT" command is malformed.

I guess it's all a matter of preference.

> Unfortunately the mod_python routine for generating internal server
> error responses, with details as appropriate if PyhonDebug is on isn't a
> generically usable routine that could be used to do it and I don't think
> it allows an alternate status anyway. Vampire could provide such a
> generic routine that might even also be usable in some way from a user
> content handler when they want to return errors, but with a message
> when PythonDebug is set.

I've actually done something similar in my old vampire-like handler. It
would catch an exception and print an error message to the client.

I had implemented a UserError and InternalError handler. UserError would
always be sent back to the client. Generally it would be used for errors
the client won't generally generate, but might be useful. I used it for
the error message about query variables and in my original form
processing code if a radio button variable had an invalid value or
similar.

InternalError would either send the error to the client if PythonDebug
was enabled, or log it to the Apache error log and print a generic
message to the client. This was used for internal consistency errors
that are probably not useful to the client.

After reading your emails, I'm sure that some administrators probably
won't want errors like UserError being returned to the client.

JE

From bje at apnic.net  Tue Oct 19 20:21:09 2004
From: bje at apnic.net (Byron Ellacott)
Date: Tue Oct 19 20:20:13 2004
Subject: [mod_python] Approaches to handling input forms.
In-Reply-To: <1098229902.36767@dscpl.com.au>
References: <1098229902.36767@dscpl.com.au>
Message-ID: <4175AF75.2080404@apnic.net>

Graham Dumpleton wrote:
> Imagine there is a form for logging into a site and its url is at "login". I've
> ignored extensions in this discussion as different mechanisms may or may
> not make it easy to use them.
> Is there a tendency to have the form when submitted, post back using
> the same url, ie., ACTION field in form is not set, or to a different url.

Your wording is mildly confusing here - let me see if my morning-addled 
brain has managed to interpret this correctly.

Your server has returned to the user an HTML page with a form in it, at 
a url of "/login".  The user is now submitting a response to this form, 
and you're asking where people tend to have such things submitted?  I'll 
be going with the assumption that this is what you're asking.

> In this approach you tend to end up with a lot of things jumbled up into
> one content handler and it could perceivably get a bit messy.

I've taken the approach that producing content in response to a GET 
request is an entirely separate action to taking an action in response 
to a POST request.  This means I've got very clearly separated view code 
and action code; you can consider this an MVC approach, where a POST 
handler is controller logic, and a GET handler is view logic.

A POST action handler will do its work, and return status information 
and a GET location.  Currently, I just pretend at this point that the 
request was that GET originally, because that makes including the POST 
result information trivial, but I plan to use an external redirect using 
an HTTP/1.1 303 code, since this has all the behaviours I desire: Back 
works, reloads don't resubmit the POST, and the URL location bar 
reflects what the user is seeing.

For HTTP/1.0 clients, the 302 does more or less the same thing.  Some 
browsers are just too ancient to do the right thing no matter what you 
do, and I tend not to worry about them.  If it's a specific requirement 
that you need to support pre-1998 browsers, you probably want to keep 
the entire system as trivially simple as possible anyway.

(Bad enough that we still need to support Internet Explorer, which is 
stuck in the 90s as far as standards are concerned.)

> If the form and the processor of the form are at different urls, there is a
> better separation of functionality of presenting the form and its processing.
> Being different urls though, you might have to be a bit trickier as far as
> using redirects to get back to where you want when login is sucessful
> especially if it is a generic login processor.

They can be at the same URL just fine, if you're distinguishing between 
a POST and a GET.

-- 
bje
From grahamd at dscpl.com.au  Tue Oct 19 20:37:04 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 19 20:37:07 2004
Subject: [mod_python] Re: [patch] vampire 1.1 remove unknown query variables
In-Reply-To: <20041020001738.GJ15993@sventech.com>
Message-ID: <1098232617.41973@dscpl.com.au>

On Oct 19 17:17, Johannes Erdfelt <johannes@erdfelt.com> wrote:
>
> Subject: Re: [patch] vampire 1.1 remove unknown query variables
> > Well, it could still be done in Vampire as you propose, but simply have it
> > honour the PythonDebug setting. It may be more approriate to return a
> > HTTP_BAD_REQUEST if HTTP_INTERNAL_SERVER_ERROR is not appropriate
> > in this case.
> 
> I looked at HTTP_BAD_REQUEST, but the HTTP specs seem to imply that it
> should only be returned when there is a parsing error during the command
> parsing phase. Like if the "GET" or "PUT" command is malformed.

Hmmm, where I have:

  if type(function) != types.FunctionType:
    return apache.HTTP_BAD_REQUEST

in Vampire, I should perhaps then simply return DECLINED or the dreaded
HTTP_INTERNAL_SERVER_ERROR. Certainly using HTTP_HAD_REQUEST isn't
appropriate. :-(

BTW, the RFC says:

  10.4.1 400 Bad Request

  The request could not be understood by the server due to malformed
  syntax. The client SHOULD NOT repeat the request without  modifications.

Another document on w3c site says:

  Bad request 400

  The request had bad syntax or was inherently impossible to be satisfied.

Yet another site says:

  400 Bad Request

  Impossible request or syntax error

And another:

  400 Bad Request

  The request had bad syntax or was inherently impossible to satisfy.
  The client is discouraged from repeating the request without modifications.

Thus, peoples interpretations vary. I would say in this case using it would be
reasonable as it satisfies "The client SHOULD NOT repeat the request without
modifications". This is in the sense that it ain't going to work the next time
if it isn't.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From johannes at erdfelt.com  Tue Oct 19 20:49:59 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Tue Oct 19 20:50:01 2004
Subject: [mod_python] Approaches to handling input forms.
In-Reply-To: <1098229902.36767@dscpl.com.au>
References: <1098229902.36767@dscpl.com.au>
Message-ID: <20041020004959.GK15993@sventech.com>

On Tue, Oct 19, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> A question on what people perceive as being best practice as far as dealing
> with forms when using mod_python.
> 
> Imagine there is a form for logging into a site and its url is at "login". I've
> ignored extensions in this discussion as different mechanisms may or may
> not make it easy to use them.
> 
> Is there a tendency to have the form when submitted, post back using
> the same url, ie., ACTION field in form is not set, or to a different url.
> 
> If the first approach is used, any type of content handler for the resource
> must be able to deal with with both no form data or required form data.
> If no form data, put up the form, else if form data process the posted form
> appropriately.
> 
> Upon processing the form, if login was successful, it might redirect to
> another resource, or if the login form was actually part of a larger page, it
> may then enable display of what other information was on the page.
> 
> In this approach you tend to end up with a lot of things jumbled up into
> one content handler and it could perceivably get a bit messy.
> 
> If the form and the processor of the form are at different urls, there is a
> better separation of functionality of presenting the form and its processing.
> Being different urls though, you might have to be a bit trickier as far as
> using redirects to get back to where you want when login is sucessful
> especially if it is a generic login processor.
> 
> How do people handle this in the different mechanisms that are available?
> Is there a general concensus that one approach is much superior to the other?
> Are there any specific things that could be put into a content handler system
> that can make this aspect of processing forms easier?

To speak for myself, when I've implemented this, I've done it posting
back to the same script. This is because I almost always need to handle
errors and present the same form back to the user, possibly with an error
message describing the problem.

It's actually quite easy given the form validation code I've described
previously. The code looked something similar to this:

__form_vars__ = [
  form.string("email"),
  form.string("password"),
]

def handler_html(req):
  if not os.path.exists(req.filename):
    return apache.DECLINED
                                                                                
  template = vampire.loadTemplate(req.filename)

  if req.form.email is None and req.form.password is not None:
    if validate_password(req.form.email, req.form.password):
      req.status = apache.HTTP_MOVED_TEMPORARILY
      req.headers_out["Location"] = "/location/to/redirect/to"
      req.send_http_header()
                                                                                
      return apache.OK
    else:
      # Error validating user
      pass
  else:
    # Don't show error message
    template.error.omit()

  if req.form.email:
    template.email.atts['value'] = req.form.email

  req.content_type = "text/html"
  req.headers_out['Cache-Control'] = 'no-cache'
  req.headers_out['Expires'] = '-1'
  req.send_http_header()
  req.write(template.render())

  return apache.OK

The form validation code will stuff None into the value if the variable
wasn't passed at all.

You could also do something like this:

__form_vars__ = [
  form.submit("submit", [
    form.string("email", required = 1),
    form.string("password", required = 1),
  ],
]

and then:

  if req.form.submit is not None:

However, the submit value may not always be sent if the user just hits
return instead of clicking on a button.

JE

From list at joreybump.com  Tue Oct 19 21:58:07 2004
From: list at joreybump.com (Jorey Bump)
Date: Tue Oct 19 21:58:11 2004
Subject: [mod_python] Approaches to handling input forms.
In-Reply-To: <1098229902.36767@dscpl.com.au>
References: <1098229902.36767@dscpl.com.au>
Message-ID: <4175C62F.4040107@joreybump.com>

Graham Dumpleton wrote:

> If the form and the processor of the form are at different urls, there is a
> better separation of functionality of presenting the form and its processing.

I've found the opposite to be the case. That is, when the form submits 
to itself, I can keep everything within the same context, including 
conditional branching and error handling. I create a dispatch function 
that looks at the form variables and acts accordingly. I move on to 
another URL when there is no more processing to be done for that form 
(which will often span multiple pages).

Compared to earlier projects where I used different URLs, I'd have to 
say that this method has encouraged me to reuse code more efficiently. 
The separation of functionality occurs in the code, where it's most 
important. The URLs serve as logical containers that distinguish the 
various parts of the application.


From grahamd at dscpl.com.au  Tue Oct 19 22:34:53 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Tue Oct 19 22:44:57 2004
Subject: [mod_python] Approaches to handling input forms.
In-Reply-To: <4175C62F.4040107@joreybump.com>
Message-ID: <1098239689.57123@dscpl.com.au>

On Oct 19 21:58, Jorey Bump <list@joreybump.com> wrote:
>
> Subject: Re: [mod_python] Approaches to handling input forms.
>
> Graham Dumpleton wrote:
> 
> > If the form and the processor of the form are at different urls, there is a
> > better separation of functionality of presenting the form and its processing.
> 
> I've found the opposite to be the case. That is, when the form submits 
> to itself, I can keep everything within the same context, including 
> conditional branching and error handling. I create a dispatch function 
> that looks at the form variables and acts accordingly. I move on to 
> another URL when there is no more processing to be done for that form 
> (which will often span multiple pages).
> 
> Compared to earlier projects where I used different URLs, I'd have to 
> say that this method has encouraged me to reuse code more efficiently. 
> The separation of functionality occurs in the code, where it's most 
> important. The URLs serve as logical containers that distinguish the 
> various parts of the application.

The responses so far have been really good. One thing I am curious about
though is for those who use mod_python.publisher where form values can
optionally be passed as parameters to the method being called, do you
actually end up using that ability?

The way I see it is that if a form takes many parameters and like in the above
description the same URL might be used for a multistep form submission
where the form values can change at each step, using the ability of
mod_python.publisher to accept form values as parameters may just be
more trouble than it is worth.

This is because the same Python method has to be able to cope with a
changing set of actual parameters at each phase of form submission. To
me this suggests it is easier for the method simply to take only the req
object and access req.form directly, rather than method parameters.

What you perhaps end up with is using method parameters for quite simple
forms, but for more complicated ones fallback to using req.form instead.

Is this probably a fare enough thing to say?

--
Graham Dumpleton (grahamd@dscpl.com.au)
From list at joreybump.com  Wed Oct 20 00:54:13 2004
From: list at joreybump.com (Jorey Bump)
Date: Wed Oct 20 00:54:18 2004
Subject: [mod_python] Approaches to handling input forms.
In-Reply-To: <1098239689.57123@dscpl.com.au>
References: <1098239689.57123@dscpl.com.au>
Message-ID: <4175EF75.1060801@joreybump.com>

Graham Dumpleton wrote:

> What you perhaps end up with is using method parameters for quite simple
> forms, but for more complicated ones fallback to using req.form instead.
> 
> Is this probably a fare enough thing to say?

Yes, that's how I do it. To do otherwise would require setting defaults 
for all possible arguments, which can get ugly for long forms. It's also 
redundant, since the req.form dictionary is available.
From nicolas at lehuen.com  Wed Oct 20 03:11:38 2004
From: nicolas at lehuen.com (Nicolas Lehuen)
Date: Wed Oct 20 03:11:46 2004
Subject: [mod_python] vampire form validation
In-Reply-To: <1098225959.29801@dscpl.com.au>
Message-ID: <20041020071140.35871C0C8@postfix3-2.free.fr>

> -----Message d'origine-----
> De : mod_python-bounces@modpython.org 
> [mailto:mod_python-bounces@modpython.org] De la part de 
> Graham Dumpleton
> Envoy? : mercredi 20 octobre 2004 00:46
> ? : Johannes Erdfelt
> Cc : mod_python@modpython.org
> Objet : Re: [mod_python] vampire form validation
> 
...
> I certainly think something to assist in form validation 
> would be a good thing and I am sure it is something a few 
> people have probably tackled before. Thus will be interested 
> to here how other people have approached it as well. Amongst 
> all the different variants, we can come up with a nice 
> general approach that suits a lot of needs.
> 
> --
> Graham Dumpleton (grahamd@dscpl.com.au)

Like many, we have implemented a form handling module which we interfaced to
mod_python. The module contains a Form class, which contains a series of
fields. Fields are instances of subclass of the Field class, which differ
based on their visual behaviour. Form and Fields are a mix of view and
controller, views being mostly implemented using our own templating engine,
and the model is a pretty simple dict-based model.

Field classes are :

- Label (not really a field, it's a read-only field)
- Text (a simple text field)
- TextArea
- CheckBox
- CheckList (a series of checkboxes representing a subset of a list in the
model)
- Radio and Select (two different rendering of a choice between differents
items)
- Submit

Each field has a name, a label. It has a default controller behaviour, which
can be customized. For example, a Text field transform HTTP fields into
string in the model. If you want integers in the model, you just instanciate
the field like this :

Form((
	
Text('foobar',required=True,transform=IntegerTransform(),default_value=42),
	Submit('ok'),
))

Form loading, validation and processing are implemented in the Form class,
so if you want to customize them, you just subclass Form. The default
implementation of Form.validate() calls Field.validate() for each field of
the form, which ensures that each field is OK (e.g. for the Text field
above, it checks that the field is filled and can be transformed into an
integer).

Forms are always posted at the same URI they are obtained (i.e. the ACTION
attribute is automatically set to req.unparsed_uri). We use parameters from
the query string to pass information, on top of what is POSTed.

Here is a sample usage :

### index.py
from tcc.online.forms import *
from tcc.template import html_template

class MyForm(Form):
	def __init__(self):
		Form.__init__(self,(
			Text('last_name',required=True),
			Text('first_name'),
	
Radio('gender',((0,'Male'),(1,'Female')),required=True),
			CheckList('interests',self.load_interests),
			Text('children',transform=IntegerTransform()),
			Text('phone',transform=PhoneNumber()),
		))

	def load_interests(self,req,form):
		# anywhere a list of tuples is required (in CheckList, Radio
or Select)
		# it is possible to put a callable which returns a sequence
or iterator of tuples.
		# here we could dynamically load interests from a database,
based on parameters in the request
		return (
			('babysitting','Babysitting'),
			('sports','Sports'),
		)

	def load(self,req):
		# here we can load data from a database into the model
		# so that the form is pre-filled
		pass

	def validate(self,req):
		if Form.validate(self,req):
			# basic validation performed
			# we can make cross-field validation
			if req.fields['children']>0 and 'babysitting' not in
req.fields['interests']:
				req.errors['interests']='If you have
children, you must be interested in babysitting'
				return False
			return True
		else:
			return False

	def process(self,req):
		# here we can update the database etc.
		# the default behaviour is to render a table of the fields
		return Form.process(self,req)
	
	def render_page(self,req):
		# here we can customize how the form is rendered
		# Usually the template is in a file and cached in memory
		return html_template['''
			<html><head><title>Sample</title></head><body>
				<p>Hello, world !</p>
				${form.control}
			</body></html>
		'''](req=req,form=self)

handler = MyForm()
### end of index.py

As you can see, the form instance is a callable object, so that is can
directly be a mod_python.publisher handler. In its default behaviour, the
Form class handle all the tricky validation process, i.e. :

1) If the form is rendered "from scratch" (i.e. it has not been posted by
the user), the load() method is called to initialize it.
2) If the form is posted, the validate() method is called. If it returns
True, the form is validated and the process() method is called.
3) If the form is not posted or not validated, the form is rendered thanks
to the template it has been given (default templates are used if no
templates were given).

This framework has the advantage of being scalable, i.e. if you want to
write yourself the HTML code and use the Form class only for validation, you
can. If you want to control the way the controls are disposed within the
form, without handling the form itself, you can (just pass a template to the
form). On the other hand, you can do everything with the Form class and
never see any HTML code. Last, but not least, forms are embeddable within
templates, so you can have many forms in a single page.

This was a pretty quick description, there are many tricks when implementing
this. What we thought was going to be a 100 lines module ended as a 400
lines module. Form handling is a pretty involving matter ; I don't know if
you can really find a one-size-fits-all answer to the problem. Maybe it's
more an application-framework thing than a server-framework thing.

Regards,

Nicolas



From davidf at sjsoft.com  Wed Oct 20 03:14:42 2004
From: davidf at sjsoft.com (David Fraser)
Date: Wed Oct 20 03:14:48 2004
Subject: [mod_python] Approaches to handling input forms.
In-Reply-To: <1098229902.36767@dscpl.com.au>
References: <1098229902.36767@dscpl.com.au>
Message-ID: <41761062.2080606@sjsoft.com>

Graham Dumpleton wrote:

>A question on what people perceive as being best practice as far as dealing
>with forms when using mod_python.
>
>Imagine there is a form for logging into a site and its url is at "login". I've
>ignored extensions in this discussion as different mechanisms may or may
>not make it easy to use them.
>
>Is there a tendency to have the form when submitted, post back using
>the same url, ie., ACTION field in form is not set, or to a different url.
>  
>
I have a fairly large application and so what we do is have one central 
handler which dispatches the requests to other handlers.
Form handling is done in the central handler based on an action variable 
that is set.
What this enables is somebody to submit a form, have the central handler 
change variables in a database in response to that, and then have the 
form appear again with the modified information visible.
I think it depends on your requirements, but I've certainly found it 
useful to be able to post back to the same URL

David
From grahamd at dscpl.com.au  Wed Oct 20 03:54:40 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Wed Oct 20 03:54:43 2004
Subject: [mod_python] Re: [patch] vampire 1.1 remove unknown query variables
In-Reply-To: <20041019205650.GD15993@sventech.com>
Message-ID: <1098258873.96071@dscpl.com.au>

On Oct 19 13:56, Johannes Erdfelt <johannes@erdfelt.com> wrote:
>
> Subject: [patch] vampire 1.1 remove unknown query variables
>
> I've been using vampire the last couple of days and I like it, but it
> has some problems some code I originally wrote didn't have.
> 
> This patch fixes a problem where unknown query variables (form
> variables) could cause an internal server error.
> 
> Generally, this shouldn't happen and on a well designed site, it's the
> users error for causing this to occur, but it causes some undue alarm
> when looking at the logs, so I wrote up this patch to remove unknown
> query variables before applying it to the called handler.
> 
> It also prints out an error message if variables are required by the
> handler, but aren't given by the client (it doesn't have a default)
> 
> It applies to vampire 1.1
> 
> JE
> 
> diff -ur vampire-1.1-20041009.orig/packages/vampire/apache.py vampire-1.1-20041009/packages/
vampire/apache.py
> --- vampire-1.1-20041009.orig/packages/vampire/apache.py
	2004-10-08 18:31:50.000000000 -0700
> +++ vampire-1.1-20041009/packages/vampire/apache.py	2004-10-19 13:55:48.000000000 -0700
> @@ -171,4 +171,40 @@
>  
>    # Execute the content handler.
>  
> -  return apply(function,(req,),args)
> +  # Match up the arguments given by the client to the expected arguments
> +  # from the method. We only remove non expected names and don't check for
> +  # expected because the argument may have a default if not set. We use
> +  # exceptions to catch the case where an argument does not have a default.
> +  fc = function.func_code
> +  expected = fc.co_varnames[0:fc.co_argcount]
> + 
> +  # Silently remove any unexpected arguments if we need to
> +  if not fc.co_flags & 0x000C:  # CO_VARARGS | CO_VARKEYWORDS
> +    for name in args.keys():
> +      if name not in expected:
> +        del args[name]
> +
> +  try:
> +    return apply(function,(req,),args)
> +  except TypeError, vars:
> +    missing = []
> +
> +    # Don't worry about the arguments with defaults
> +    argcount = fc.co_argcount
> +    if function.func_defaults:
> +      argcount = argcount - len(function.func_defaults)
> +    # Skip the first argument, which is the req
> +    for name in fc.co_varnames[1:argcount]:
> +      if name not in args:
> +        missing.append(name)
> +
> +    if not len(missing):
> +      raise
> +
> +    # We definately had some missing variables, let's let the user know
> +    req.content_type = "text/plain"
> +    req.status = apache.HTTP_INTERNAL_SERVER_ERROR
> +    req.send_http_header()
> +    req.write("Call is missing these variables: %s\n" % ", ".join(missing))
> +
> +    return apache.OK

After looking at this and playing with it a bit, I am actually sort of inclined
to do the check even before the call of the handler even though it introduces
a little bit more overhead. Ie., something like:

@@ -168,6 +169,34 @@
       if len(args[arg]) == 1:
         args[arg] = args[arg][0]
 
+    fc = function.func_code
+
+    expected = fc.co_varnames[0:fc.co_argcount]
+
+    if not fc.co_flags & 0x08:
+      for name in args.keys():
+       if name not in expected:
+         del args[name]
+
+    # Following identifies missing form parameters
+    # and returns a HTTP_BAD_REQUEST instead of a
+    # HTTP_INTERNAL_SERVER error. This at least gives
+    # a bit of an indication it was because of the
+    # request and not a problem with the server.
+
+    missing = []
+
+    argcount = fc.co_argcount
+    if function.func_defaults:
+      argcount = argcount - len(function.func_defaults)
+
+    for name in fc.co_varnames[1:argcount]:
+      if name not in args:
+       missing.append(name)
+
+    if missing:
+      return apache.HTTP_BAD_REQUEST
+
   # Execute the content handler.
 
   return apply(function,(req,),args)

BTW, the code which drops out form parameters that weren't expected
should probably only look for CO_VARKEYWORDS and not CO_VARARGS
as well.

Doing it the above way does mean that all one gets back is HTTP_BAD_REQUEST,
but this might at least be better than HTTP_INTERNAL_SERVER_ERROR as
it indicates that it is a problem with the request rather than the server. But
then, if the HTML page with the bad form post was on the server, one might
say it is a server error anyway as the user didn't formulate the request, your
HTML page did and thus it is your fault and not the users. If this is the case,
no point having the check at all.

One other thought I had was that the above forms processing code in total
could be a fallback in some way. In other words, only done if the code file
containing the content handler didn't provide some form of form handler 
or validation routine.

Think about how mod_python already has the concept of different phases of
processing. At the moment the one just before the content handler being
executed is defined by PythonFixupHandler.

What could perhaps be done with Vampire is between the fixup handler
and the content handler introduce a new phase of processing for dealing
with forms. This would be realised by the same code file as contains the
content handler defining a formhandler() method.

This new method could be passed the req object as with other handlers and
its job would be to use whatever mechanism it wants to validate the form
data and then put it into an appropriate way for supplying as arguments
to the actual content handler. These arguments would be passed back to
Vampire for use within the req object.

Thus, where Vampire finally calls:

  return apply(function,(req,),args)

the "args" would be what the formhandler() had prepared and passed back
through req.

When the formhandler() doesn't like the data, can generate appropriate error
respones if required and for example give back a list of missing fields in a
page if desired.

Hmmm, maybe this is a silly idea. The only thing it gives you, is that if you
want to have form parameters passed as arguments to the content handler,
is a way of generating a better error response if any are missing in the form.
All the other things can still be done as an initial phase of the content handler
anyway.

Based on other emails, it seems that if you want a robust forms processing
system, you are better off just accepting a req object and then use some
sort of form validation suite. Thus, any support for automatically decoding
form parameters in the server-framework (as someone else called it), is
redundant really.

I guess that if you really wanted all the form parameters to appear as normal
variables within the scope of the content handler, rather than doing it as
function arguments, the forms validation code could be passed locals() and
it could stick them straight into the scope of the function. Ie.,

  def validator(req,locals):
    # ...

    locals["user"] = req.form["user']

  def handler(req):
    validator(req,locals())
    if user = "...":
      ...

Anyone do anything like this in their form validator, or is it simpler to still access
it out of the form?

Anyway, people are probably getting sick of my rambling by now. I think I will
just add the kwargs support I need to add for now and leave it be for a while.
There are so many ways of still doing this within the context of the content
handler that any special support isn't really required. Any use of form values
passed as actual arguments to a content handler seems only to be useful for
simple stuff anyway.

--
Graham Dumpleton (grahamd@dscpl.com.au)
From tomvandezande at gmail.com  Wed Oct 20 13:47:12 2004
From: tomvandezande at gmail.com (Tom van de Zande)
Date: Wed Oct 20 13:47:15 2004
Subject: [mod_python] can't get a simple hello world program to work
Message-ID: <5610c9c704102010474055668d@mail.gmail.com>

Hi guys,

For some reason I can't get a simple hello world program to work.
Apache offers mptest.py as download in stead of interpreting it.
I installed apache2 and the latest version of mod_python using apt
(Debian Sarge)

i'm testing following the description at:
http://www.modpython.org/live/current/doc-html/inst-testing.html

apache config:
<Directory /var/www/test>
    AddHandler mod_python .py
    PythonHandler mptest
    PythonDebug On
</Directory>

/var/www/test/mptest.py:
from mod_python import apache

def handler(req):
    req.write("Hello World!")
    return apache.OK

apache error.log says:
[Wed Oct 20 19:22:50 2004] [notice] Apache/2.0.52 (Debian GNU/Linux)
mod_python/3.1.3 Python/2.3.4 configured -- resuming normal operations
[Wed Oct 20 19:23:04 2004] [notice] mod_python: (Re)importing module 'mptest'

Thanks in advance.  Any help on this is highly appreciated.

Tom.
From crosseyedpenguin at cox.net  Wed Oct 20 18:13:26 2004
From: crosseyedpenguin at cox.net (Roger)
Date: Wed Oct 20 18:13:32 2004
Subject: [mod_python] Single Authentication for dual applications,
	Webware and Moin
Message-ID: <4176E306.1070309@cox.net>

Hi,

I have an application written using Webware/WebKit that makes heavy use 
of MoinMoin for supporting documentation. The Webware application 
currently uses a home-coded authentication mechanism making use of an 
SQL database. The MoinMoin application currently uses the standard 
MoinMoin authentication scheme resulting in dual login IDs and dual 
passwords for all users.

I am about to modify the MoinMoin authentication scheme to use the same 
SQL database for authentication, eliminating the dual login IDs, but not 
the dual logins.

It would be an advantage to have one login for both applications. Both 
applications are running under mod_python and on the same virtual 
server. Allmost all my coding experience is using Webware object 
structure andI have done little with mod_python other than install it. I 
see references to the objects with the same names (request, session) in 
the MoinMoin, Webware, and mod_python docs, but these appear to be 
unique to each application.

Does anyone have any suggestions for an approach yielding a single login 
for these two applications? I am thinking that I need to write a 
authentication mechanism for mod_python against the SQL database, and 
then write subordinate mechanisms for Webware and MoinMoin that verify a 
valid mod_python session exists. But I am confused as to how to go about 
passing user information between these applications. Is there a better 
approach than using a cookie understood by all three mechanisms?

Roger

From tomvandezande at gmail.com  Wed Oct 20 21:25:51 2004
From: tomvandezande at gmail.com (Tom van de Zande)
Date: Wed Oct 20 21:25:53 2004
Subject: [mod_python] Re: can't get a simple hello world program to work
In-Reply-To: <5610c9c704102010474055668d@mail.gmail.com>
References: <5610c9c704102010474055668d@mail.gmail.com>
Message-ID: <5610c9c704102018254af55530@mail.gmail.com>

I already figured it out, thanks anyway

greetings, tom.


On Wed, 20 Oct 2004 10:47:12 -0700, Tom van de Zande
<tomvandezande@gmail.com> wrote:
> Hi guys,
> 
> For some reason I can't get a simple hello world program to work.
> Apache offers mptest.py as download in stead of interpreting it.
> I installed apache2 and the latest version of mod_python using apt
> (Debian Sarge)
> 
> i'm testing following the description at:
> http://www.modpython.org/live/current/doc-html/inst-testing.html
> 
> apache config:
> <Directory /var/www/test>
>    AddHandler mod_python .py
>    PythonHandler mptest
>    PythonDebug On
> </Directory>
> 
> /var/www/test/mptest.py:
> from mod_python import apache
> 
> def handler(req):
>    req.write("Hello World!")
>    return apache.OK
> 
> apache error.log says:
> [Wed Oct 20 19:22:50 2004] [notice] Apache/2.0.52 (Debian GNU/Linux)
> mod_python/3.1.3 Python/2.3.4 configured -- resuming normal operations
> [Wed Oct 20 19:23:04 2004] [notice] mod_python: (Re)importing module 'mptest'
> 
> Thanks in advance.  Any help on this is highly appreciated.
> 
> Tom.
>
From gdamjan at mail.net.mk  Thu Oct 21 18:20:36 2004
From: gdamjan at mail.net.mk (Damjan)
Date: Thu Oct 21 18:20:40 2004
Subject: [mod_python] Approaches to handling input forms.
In-Reply-To: <1098229902.36767@dscpl.com.au>
References: <1098229902.36767@dscpl.com.au>
Message-ID: <20041021222036.GB17225@legolas.on.net.mk>

> A question on what people perceive as being best practice as far as dealing
> with forms when using mod_python.

How about this:
You have the FORM spec in an XML file with the [lets say] .pyfrm
extension. This extension is associated with a special mod_python
handler [mod_python.form].

The spec file, specifies form elements, required and optional enties,
valid value types, ranges etc. It would be a nice option if the form
can span several pages.. wizard-like. The spec file would also 
specify what happens at the end (call a python function or...?).

Then I'd be able to insert the form even in plain HTML using an iframe...
<iframe src='/newuser.pyfrm'>you need a new browser</iframe>


BTW.
does pytohn's PSP have a internal url include functionality? Like
apache's SSI "#include virtual"?
http://httpd.apache.org/docs-2.0/howto/ssi.html#basic


-- 
damjan | ??????
This is my jabber ID --> damjan@bagra.net.mk <-- not my mail address!!!
From grahamd at dscpl.com.au  Thu Oct 21 19:37:43 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct 21 19:37:50 2004
Subject: [mod_python] Approaches to handling input forms.
In-Reply-To: <20041021222036.GB17225@legolas.on.net.mk>
References: <1098229902.36767@dscpl.com.au>
	<20041021222036.GB17225@legolas.on.net.mk>
Message-ID: <3441AFF2-23BA-11D9-9A86-000393DCF16E@dscpl.com.au>


On 22/10/2004, at 8:20 AM, Damjan wrote:

>> A question on what people perceive as being best practice as far as  
>> dealing
>> with forms when using mod_python.
>
> How about this:
> You have the FORM spec in an XML file with the [lets say] .pyfrm
> extension. This extension is associated with a special mod_python
> handler [mod_python.form].

Personally, I'm not a fan of all these different magical extensions
people have come up with just to satisfy mod_python's way of working
out which handler to use. One of the main issues is that it exposes
within the URL the particular implementation mechanism being used.

Now, whether or not the form mechanism is driven by XML, by Python
data structures or programmatically, at its basic level it should be
usable as a library without any restriction that it will only work
within the confines of a particular framework. If you want to then
wrap it in an additional layer so that the above is possible, fine.

Anyway, there seems to have been ample prior work on forms validation
support for Python. Ie., see:

    
http://toulouse.amber.org/archives/2003/09/03/ 
python_form_and_validation_kits.html

Probably a good place to start for doing an evaluation of what is out
there. Some look specific to particular frameworks, but others aren't.

Oh, the FormEncode link isn't really any longer valid, see:

   http://formencode.org/

If there is a good library out there already for doing this, better
off just using that than starting from scratch.



--
Graham Dumpleton (grahamd@dscpl.com.au)

From robert at worksofmagic.com  Thu Oct 21 21:22:39 2004
From: robert at worksofmagic.com (Robert Geller)
Date: Thu Oct 21 21:22:40 2004
Subject: [mod_python] ImportError: No module named index
Message-ID: <002b01c4b7d5$9f799940$1e02a8c0@leet>

Hello all --
 
I have encountered a dilemma. I do not want to specifically use the .py
extension for my mod-python files, and for understandable reasons.
In httpd.conf, I put 
 

<Directory /usr/local/apache2/htdocs/python>
AddHandler python-program .n
PythonHandler index::index
PythonDebug On
</Directory>

I even specified "index.n" under PythonHandler, i.e. "PythonHandler
index.n::index". Note *.n is the extension I want to use at the moment,
for test purposes.
 
Well, when I make a file named "index.n" with the handler function
"index", with the following code:
 
from mod_python import apache
 
def index(req):
 
        req.content_type = "text/html"
        req.send_http_header()
        req.write("Welcome to Robert's page!")
 
        return apache.OK
 
It returns the following error:
 
Mod_python error: "PythonHandler index.n::index"



Traceback (most recent call last):



  File
"/usr/local/python/lib/python2.4/site-packages/mod_python/apache.py",
line 287, in HandlerDispatch

    log=debug)



  File
"/usr/local/python/lib/python2.4/site-packages/mod_python/apache.py",
line 454, in import_module

    f, p, d = imp.find_module(parts[i], path)



ImportError: No module named index
 
Oddly, when I make the handler file, or module, "index.py", it works!
But I don't *want* to make any related file have the
*.py extension, even if it's just the handler. I realize I can use
index.py for the handler and then *.n for the front-end files,
but that's not how I want to do things.
 
If anybody could please advise me on making actual *handlers* without
.py extensions, that would be great! 
 
Regards.
 
 
 

Robert Geller

robert@worksofmagic.com

 

 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20041021/850e69fb/attachment.html
From grahamd at dscpl.com.au  Thu Oct 21 21:26:36 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct 21 21:26:40 2004
Subject: [mod_python] ANN: Vampire 1.2 is now available.
Message-ID: <6A91C60D-23C9-11D9-9A86-000393DCF16E@dscpl.com.au>

It was only two weeks ago that the previous version of Vampire was
released, so will not go into detail of what it is again, follow
the link below if you didn't see the previous announcement.

That said, Vampire 1.2 is now available from:

   http://www.dscpl.com.au/projects/vampire

This update puts in all the required thread locking to ensure that
it will work properly when used from a multithreaded MPM under
Apache 2.0. Copies of patches to mod_python to fix multithreading
issues as discussed recently in the mailing list are also included.
Thanks to Nicolas Lehuen for his input on this and validating that
the patches did in fact work.

Finally, minor changes to automatic decoding of form parameters in
order to support a keyword argument list and dropping of unexpected
parameters. The form parameter decoding should now be equivalent
to that of mod_python.publisher in mod_python 3.1.3.

As far as recent discussions on embedding additional support for
form validation into Vampire, I decided that for now this is better
left to a dedicated form validation system carried out within the
context of the content handler and not something which is done prior
to the content handler even being called. To my mind this provides
the most flexibility at the moment. Thanks to Johannes Erdfelt and
others for the various bits of feedback on forms processing. Will
probably revisit this issue at another time in the future when I
have reviewed what other packages are out there.

This latest version of Vampire also includes an example for showing
how form values will get decoded. I just wish someone would answer
my question about file uploads and whether what currently happens
for them in mod_python.publisher is reasonable. Doesn't anyone use
file uploads with mod_python.publisher? See the result for input
form 2 in the example as to what currently happens. Ie., one gets
a Field object for a file upload.

The URL for the example which displays form values is:

   http://www.dscpl.com.au/projects/vampire/examples-01/form-values.html

Courtesy of the special source code viewer content handler, if you
are curious, you can see the source code for this example at:

    
http://www.dscpl.com.au/projects/vampire/source/examples-01/form- 
values.py
    
http://www.dscpl.com.au/projects/vampire/source/examples-01/form- 
values.html

Feedback welcome. Especially interested whether anyone feels that
there is value in providing a mechanism for supporting the current
mod_python.publisher way of doing things within the context of
Vampire. At the moment, I am not sure that how it does things is
necessarily a good way, as it looks to me like it actually restrains
you from doing certain things and also over simplifies other things
such that it may not result in as robust an application because
people will not fill in all the detail properly.

Enjoy.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From grahamd at dscpl.com.au  Thu Oct 21 21:42:50 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct 21 21:42:54 2004
Subject: [mod_python] ImportError: No module named index
In-Reply-To: <002b01c4b7d5$9f799940$1e02a8c0@leet>
References: <002b01c4b7d5$9f799940$1e02a8c0@leet>
Message-ID: <AEDDB1B1-23CB-11D9-9A86-000393DCF16E@dscpl.com.au>


On 22/10/2004, at 11:22 AM, Robert Geller wrote:
> It returns the following error:
> ?
> Mod_python error: "PythonHandler index.n::index"
>
> Traceback (most recent call last):
>
>   File 
> "/usr/local/python/lib/python2.4/site-packages/mod_python/apache.py", 
> line 287, in HandlerDispatch
>     log=debug)
>
>   File 
> "/usr/local/python/lib/python2.4/site-packages/mod_python/apache.py", 
> line 454, in import_module
>     f, p, d = imp.find_module(parts[i], path)
>
> ImportError: No module named index
> ?
> Oddly, when I make the handler file, or module, "index.py", it works! 
> But I don't *want* to make any related file have the
> *.py extension, even if it's just the handler. I realize I can use 
> index.py for the handler and then *.n for the front-end files,
> but that's not how I want to do things.
> ?
> If anybody could please advise me on making actual *handlers* without 
> .py extensions, that would be great!

Using mod_python by itself it cannot be done. This is because the
mod_python.apache.import_module() uses the Python "imp" module
and it will only allow importing of modules with a valid Python
module extension.

   >>> import imp
   >>> imp.get_suffixes()
   [('.so', 'rb', 3), ('module.so', 'rb', 3), ('.py', 'U', 1), ('.pyc', 
'rb', 2)]

The mod_python.servlet system uses an alternate extensions to .py,
namely .mps, but it only manages this by not using the Python "imp"
module and instead using exec/execfile() to implement its own module
loading system. When using exec/execfile() you can give it any
arbitrary filename and it will read its contents as Python code.

Now, if the reason you don't want to use the .py extension is purely
so that the means of implementation isn't reflected on the URL, then
have a look at Vampire (http://www.dscpl.com.au/projects/vampire).
This allows you to use more traditional file extensions appropriate
to the type of content being returned, but even though access to the
actual Python code file is blocked, the Python code is still stored
in a .py file. Vampire is though implemented in a way to avoid a
lot of the problems which arise with using a .py extension in the
first place.

As to what else you can do, you would have to explain better why
you don't want to use a .py extension for the Python code files.

--
Graham Dumpleton (grahamd@dscpl.com.au)

From johannes at erdfelt.com  Thu Oct 21 23:24:22 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Thu Oct 21 23:24:24 2004
Subject: [mod_python] ANN: Vampire 1.2 is now available.
In-Reply-To: <6A91C60D-23C9-11D9-9A86-000393DCF16E@dscpl.com.au>
References: <6A91C60D-23C9-11D9-9A86-000393DCF16E@dscpl.com.au>
Message-ID: <20041022032422.GE28037@sventech.com>

On Fri, Oct 22, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> This latest version of Vampire also includes an example for showing
> how form values will get decoded. I just wish someone would answer
> my question about file uploads and whether what currently happens
> for them in mod_python.publisher is reasonable. Doesn't anyone use
> file uploads with mod_python.publisher? See the result for input
> form 2 in the example as to what currently happens. Ie., one gets
> a Field object for a file upload.

I just ported over that piece of my code. Under mod_python 3.1.3,
vampire will cause a traceback with the current code.

The fix is to do the same thing the new publisher does which is not use
a seperate File class.

JE

From grahamd at dscpl.com.au  Thu Oct 21 23:56:32 2004
From: grahamd at dscpl.com.au (Graham Dumpleton)
Date: Thu Oct 21 23:56:38 2004
Subject: [mod_python] ANN: Vampire 1.2 is now available.
In-Reply-To: <20041022032422.GE28037@sventech.com>
References: <6A91C60D-23C9-11D9-9A86-000393DCF16E@dscpl.com.au>
	<20041022032422.GE28037@sventech.com>
Message-ID: <5C341B9E-23DE-11D9-9A86-000393DCF16E@dscpl.com.au>


On 22/10/2004, at 1:24 PM, Johannes Erdfelt wrote:

> On Fri, Oct 22, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
>> This latest version of Vampire also includes an example for showing
>> how form values will get decoded. I just wish someone would answer
>> my question about file uploads and whether what currently happens
>> for them in mod_python.publisher is reasonable. Doesn't anyone use
>> file uploads with mod_python.publisher? See the result for input
>> form 2 in the example as to what currently happens. Ie., one gets
>> a Field object for a file upload.
>
> I just ported over that piece of my code. Under mod_python 3.1.3,
> vampire will cause a traceback with the current code.
>
> The fix is to do the same thing the new publisher does which is not use
> a seperate File class.

Sorry, I'm a bit confused now, but then my original description may have
been the problem as to what I meant by current.

In Vampire 1.2, I essentially do what mod_python.publisher 3.1.3 does.
Or at least that is the intent, the actual code to produce the result
is done a bit differently.

Thus, in Vampire 1.1, I wrapped a file upload form value into a File
object as did mod_python.publisher 2.X. In Vampire 1.2 I leave the field
value for the file upload as is and thus it comes back as a Field object
as setup by util.FieldStorage.

If you had a form using file upload and were previously using Vampire 
1.1,
and moved to Vampire 1.2 you would most likely need to change your code
to bring it in line with Vampire 1.2/mod_python.publisher 3.1.3 way of
doing it.

Now, does your saying that you get an exception mean that whatever I did
in Vampire 1.2 isn't actually correct and isn't the same as what the
mod_python.publisher package does? Or are you simply finding that if it
was made to work with Vampire 1.1 previously that a change is possibly
required when moving to Vampire 1.2?

Maybe I should do some tests with mod_python.publisher to see that it is
actually producing what I thought it was by code inspection. I might 
well
have just goofed up. :-)

--
Graham Dumpleton (grahamd@dscpl.com.au)

From johannes at erdfelt.com  Fri Oct 22 14:57:33 2004
From: johannes at erdfelt.com (Johannes Erdfelt)
Date: Fri Oct 22 14:57:36 2004
Subject: [mod_python] ANN: Vampire 1.2 is now available.
In-Reply-To: <5C341B9E-23DE-11D9-9A86-000393DCF16E@dscpl.com.au>
References: <6A91C60D-23C9-11D9-9A86-000393DCF16E@dscpl.com.au>
	<20041022032422.GE28037@sventech.com>
	<5C341B9E-23DE-11D9-9A86-000393DCF16E@dscpl.com.au>
Message-ID: <20041022185733.GC3376@sventech.com>

On Fri, Oct 22, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> 
> On 22/10/2004, at 1:24 PM, Johannes Erdfelt wrote:
> 
> >On Fri, Oct 22, 2004, Graham Dumpleton <grahamd@dscpl.com.au> wrote:
> >>This latest version of Vampire also includes an example for showing
> >>how form values will get decoded. I just wish someone would answer
> >>my question about file uploads and whether what currently happens
> >>for them in mod_python.publisher is reasonable. Doesn't anyone use
> >>file uploads with mod_python.publisher? See the result for input
> >>form 2 in the example as to what currently happens. Ie., one gets
> >>a Field object for a file upload.
> >
> >I just ported over that piece of my code. Under mod_python 3.1.3,
> >vampire will cause a traceback with the current code.
> >
> >The fix is to do the same thing the new publisher does which is not use
> >a seperate File class.
> 
> Sorry, I'm a bit confused now, but then my original description may have
> been the problem as to what I meant by current.
> 
> In Vampire 1.2, I essentially do what mod_python.publisher 3.1.3 does.
> Or at least that is the intent, the actual code to produce the result
> is done a bit differently.
> 
> Thus, in Vampire 1.1, I wrapped a file upload form value into a File
> object as did mod_python.publisher 2.X. In Vampire 1.2 I leave the field
> value for the file upload as is and thus it comes back as a Field object
> as setup by util.FieldStorage.
> 
> If you had a form using file upload and were previously using Vampire 
> 1.1,
> and moved to Vampire 1.2 you would most likely need to change your code
> to bring it in line with Vampire 1.2/mod_python.publisher 3.1.3 way of
> doing it.
> 
> Now, does your saying that you get an exception mean that whatever I did
> in Vampire 1.2 isn't actually correct and isn't the same as what the
> mod_python.publisher package does? Or are you simply finding that if it
> was made to work with Vampire 1.1 previously that a change is possibly
> required when moving to Vampire 1.2?
> 
> Maybe I should do some tests with mod_python.publisher to see that it is
> actually producing what I thought it was by code inspection. I might 
> well
> have just goofed up. :-)

I haven't tried Vampire 1.2 yet. I didn't realize you had changed the
code for 1.2.

I was commenting with respect to 1.1.

JE

From nick at dd.revealed.net  Fri Oct 22 15:41:33 2004
From: nick at dd.revealed.net (Nick)
Date: Fri Oct 22 15:41:48 2004
Subject: [mod_python] looking for windows binary
Message-ID: <4179626D.60401@dd.revealed.net>

Anybody have or know where to get a mod_python 2.7.x compiled with python 2.3?

Thanks,
Nick
From nick at dd.revealed.net  Fri Oct 22 15:42:22 2004
From: nick at dd.revealed.net (Nick)
Date: Fri Oct 22 15:42:31 2004
Subject: [mod_python] Re: looking for windows binary
In-Reply-To: <4179626D.60401@dd.revealed.net>
References: <4179626D.60401@dd.revealed.net>
Message-ID: <4179629E.10306@dd.revealed.net>

For Windows Apache 1.3 that is.

Nick

Nick wrote:
> Anybody have or know where to get a mod_python 2.7.x compiled with 
> python 2.3?
> 
> Thanks,
> Nick
> 

From davidf at sjsoft.com  Fri Oct 22 17:30:43 2004
From: davidf at sjsoft.com (David Fraser)
Date: Fri Oct 22 17:30:52 2004
Subject: [mod_python] Re: looking for windows binary
In-Reply-To: <4179629E.10306@dd.revealed.net>
References: <4179626D.60401@dd.revealed.net> <4179629E.10306@dd.revealed.net>
Message-ID: <41797C03.4050402@sjsoft.com>

Nick wrote:

> For Windows Apache 1.3 that is.
>
> Nick
>
> Nick wrote:
>
>> Anybody have or know where to get a mod_python 2.7.x compiled with 
>> python 2.3?
>>
>> Thanks,
>> Nick
>>
Hi Nick

I think you'll have to compile it yourself as I don't know that anyone 
else does this.
If you can't get it to build out of the box you could compare how the 
3.1.3 setup program works ...
Ask questions here.

And of course, the obligatory question is, are you sure you can't move 
to Apache 2.0? :-)

David
From nick at dd.revealed.net  Fri Oct 22 17:35:25 2004
From: nick at dd.revealed.net (Nick)
Date: Fri Oct 22 17:35:34 2004
Subject: [mod_python] Re: looking for windows binary
In-Reply-To: <41797C03.4050402@sjsoft.com>
References: <4179626D.60401@dd.revealed.net> <4179629E.10306@dd.revealed.net>
	<41797C03.4050402@sjsoft.com>
Message-ID: <41797D1D.2050606@dd.revealed.net>

David Fraser wrote:
>> Nick wrote:
>>
>>> Anybody have or know where to get a mod_python 2.7.x compiled with 
>>> python 2.3?
>>>
> I think you'll have to compile it yourself as I don't know that anyone 
> else does this.
> If you can't get it to build out of the box you could compare how the 
> 3.1.3 setup program works ...
> Ask questions here.
> 
> And of course, the obligatory question is, are you sure you can't move 
> to Apache 2.0? :-)

Yeah I was hoping I wouldn't have to look for VC++, install it, then build 
the binary myself, but looks like I won't have a choice.  Apache 2.0 is not 
an option.

Nick
From grisha at ispol.com  Wed Oct 27 00:08:27 2004
From: grisha at ispol.com (Gregory (Grisha) Trubetskoy)
Date: Wed Oct 27 00:08:36 2004
Subject: [mod_python] test
Message-ID: <20041027000804.E28213@onyx.ispol.com>


this is the test of the list

please ignore

grisha
From sorin.chiorean at gmail.com  Wed Oct 27 04:00:07 2004
From: sorin.chiorean at gmail.com (Sorin Chiorean)
Date: Wed Oct 27 04:00:08 2004
Subject: [mod_python] New release
Message-ID: <7f4a502f04102701008372973@mail.gmail.com>

Hi all,

While looking into Vampire I noticed that the package provides a patch
to mod_python to fix some errors if used in multithreaded Apache. Will
these fixes be included in mod_python? Is it possible a new release in
the near future?

Thanks
-- 
soso
From l.trejtnar at open.ac.uk  Wed Oct 27 05:55:50 2004
From: l.trejtnar at open.ac.uk (Lukas Trejtnar)
Date: Wed Oct 27 05:56:07 2004
Subject: [mod_python] Authentification/Session Management
Message-ID: <417F70A6.2070500@open.ac.uk>

Hi,

I'm trying to implement a session management together with an 
authentification procedure.

I have a folder which contains PSP (my_pages). When a user accesses 
my_pages for the first time, an authentification dialogue box is 
invoked, a user is authentified and new session is created (with timeout 
300s). User happily browses my_pages.

Now, if s/he is inactive for more than 300s and starts browsing again, 
new session is created. It's fine, but I would like to force the 
authentification dialogue box to appear again before a session creation.

How can I do that? Here is my code:

Apache config:

<Directory "C:/Program Files/Apache Group/Apache2/htdocs/my_pages">
         AddHandler mod_python .py
     PythonHandler mod_python.publisher
     PythonAuthenHandler handlers
          PythonDebug On
          AuthType Basic
          AuthName "Restricted Area"
          require valid-user
         PythonOption ApplicationPath '/'
</Directory>

handlers.py file:

from mod_python import apache, Session

def authenhandler(req):

     req.session = Session.Session(req, timeout=300)

     passwd = req.get_basic_auth_pw()
     user = req.user

     if req.session.is_new():
         req.session['passwd'] = passwd
         req.session['user'] = user

     req.session.save()

     if  passwd == "spam" and user == "eggs":
         return apache.OK
     else:
         return apache.HTTP_UNAUTHORIZED


Thanks,
Lukas
From Moiz.Golawala at ge.com  Wed Oct 27 10:06:39 2004
From: Moiz.Golawala at ge.com (Golawala, Moiz M (GE Infrastructure))
Date: Wed Oct 27 10:06:50 2004
Subject: [mod_python] newbie question
Message-ID: <CE90A4CF2E5E9C4890AE5D9D8A5EFAE301460EC9@CINMLVEM10.e2k.ad.ge.com>

Hi All, 

I am very new to mod_python (I have developed application with python but am new to web development in general). I have read most of the documentation and I have a couple of questions. I am planning to use mod_python along with Cheetah to build an internal website for my company. So far I have include some basic handlers in apache and can view a hello world script on my browser. Now when I try to do something a little more complicated I am lost.

 I have a couple of text fields that I want the user to fill out and then hit the submit button. I can get that html page up but I don't understand the mechanism where once a user hits the submit button, how does he/she get to the next page on the site. 

In the documentation I don't see any multi page working examples. Can some one point me to some resource that has working mult-page html (PSP or Cheetah based) examples with the necessary Directory tags in the httpd.conf file so I can better understand what is going on. 

Any help is appreciated greatly. 

Thank you,
Moiz

From davidf at sjsoft.com  Wed Oct 27 10:15:50 2004
From: davidf at sjsoft.com (David Fraser)
Date: Wed Oct 27 10:15:59 2004
Subject: [mod_python] Re: Apache/mod_python SSLMutex
In-Reply-To: <151b074151c222.151c222151b074@columbus.rr.com>
References: <151b074151c222.151c222151b074@columbus.rr.com>
Message-ID: <417FAD96.1090701@sjsoft.com>

LeePatton@woh.rr.com wrote:

>I found your post on the mod_python mailing list about  trouble w/ apache not releasing the mutexes on restart:
>
>http://www.modpython.org/pipermail/mod_python/2004-May/015619.html
>
>I am having that exact same problem. You mentioned adding some code to your init script to get around it. I would greatly appreiciate it if you would post it or send it to me.
>
>Thanks for your time,
>  - Lee
>  
>
Hi Lee

Sorry, my code actually went to python-dev@httpd.apache.org for which I 
think there aren't easy public archives...
Anyway here is my patch:

--- httpd.rpmsave       2004-05-28 16:43:58.000000000 +0200
+++ httpd       2004-06-29 18:20:47.000000000 +0200
@@ -66,6 +66,15 @@
        echo -n $"Stopping $prog: "
        killproc $httpd
        RETVAL=$?
+       removeipcs=`ipcs -s -c | grep apache | cut -d ' ' -f 1`
+       numipcs=`echo $removeipcs | wc -w`
+       if [ $numipcs != 0 ]
+       then
+               echo
+               echo -n $"and removing $numipcs ipcs: "
+               echo $removeipcs | xargs -n 1 ipcrm -s
+               sleep 2
+       fi
        echo
        [ $RETVAL = 0 ] && rm -f ${lockfile} ${pidfile}
 }

Note: I've just done this on a machine which has Apache 2 and Apache 1.3 
running concurrently. In this situation it gets a bit more tricky 
because the ipcrm command inadvertently kills the Apache 1.3 process 
which has some ipcs open. So I have to restart it manually.

I still haven't managed to debug exactly why this happens...

David


From grisha at modpython.org  Wed Oct 27 11:28:18 2004
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Wed Oct 27 11:28:26 2004
Subject: [mod_python] Re: Apache/mod_python SSLMutex
In-Reply-To: <417FAD96.1090701@sjsoft.com>
References: <151b074151c222.151c222151b074@columbus.rr.com>
	<417FAD96.1090701@sjsoft.com>
Message-ID: <20041027112613.A37659@onyx.ispol.com>


Is this a patch to /etc/init.d/httpd? In which case it is a Fedora/RedHat 
patch and should probably be sumbitted to the httpd package maintainers.

Grisha


On Wed, 27 Oct 2004, David Fraser wrote:

> LeePatton@woh.rr.com wrote:
>
>> I found your post on the mod_python mailing list about  trouble w/ apache 
>> not releasing the mutexes on restart:
>> 
>> http://www.modpython.org/pipermail/mod_python/2004-May/015619.html
>> 
>> I am having that exact same problem. You mentioned adding some code to 
>> your init script to get around it. I would greatly appreiciate it if you 
>> would post it or send it to me.
>> 
>> Thanks for your time,
>>  - Lee
>> 
> Hi Lee
>
> Sorry, my code actually went to python-dev@httpd.apache.org for which I think 
> there aren't easy public archives...
> Anyway here is my patch:
>
> --- httpd.rpmsave       2004-05-28 16:43:58.000000000 +0200
> +++ httpd       2004-06-29 18:20:47.000000000 +0200
> @@ -66,6 +66,15 @@
>       echo -n $"Stopping $prog: "
>       killproc $httpd
>       RETVAL=$?
> +       removeipcs=`ipcs -s -c | grep apache | cut -d ' ' -f 1`
> +       numipcs=`echo $removeipcs | wc -w`
> +       if [ $numipcs != 0 ]
> +       then
> +               echo
> +               echo -n $"and removing $numipcs ipcs: "
> +               echo $removeipcs | xargs -n 1 ipcrm -s
> +               sleep 2
> +       fi
>       echo
>       [ $RETVAL = 0 ] && rm -f ${lockfile} ${pidfile}
> }
>
> Note: I've just done this on a machine which has Apache 2 and Apache 1.3 
> running concurrently. In this situation it gets a bit more tricky because the 
> ipcrm command inadvertently kills the Apache 1.3 process which has some ipcs 
> open. So I have to restart it manually.
>
> I still haven't managed to debug exactly why this happens...
>
> David
>
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From davidf at sjsoft.com  Wed Oct 27 11:53:53 2004
From: davidf at sjsoft.com (David Fraser)
Date: Wed Oct 27 11:53:59 2004
Subject: [mod_python] Re: Apache/mod_python SSLMutex
In-Reply-To: <20041027112613.A37659@onyx.ispol.com>
References: <151b074151c222.151c222151b074@columbus.rr.com>
	<417FAD96.1090701@sjsoft.com>
	<20041027112613.A37659@onyx.ispol.com>
Message-ID: <417FC491.9010002@sjsoft.com>



Gregory (Grisha) Trubetskoy wrote:

> Is this a patch to /etc/init.d/httpd? In which case it is a 
> Fedora/RedHat patch and should probably be sumbitted to the httpd 
> package maintainers.

Yes it is.
The trouble is, it can do nasty things that are unexpected, and it 
really is a workaround for a bug in either Apache or mod_python, so I 
think it would be better to fix the bug, I just don't know where it 
is... :-)

David

>
> On Wed, 27 Oct 2004, David Fraser wrote:
>
>> LeePatton@woh.rr.com wrote:
>>
>>> I found your post on the mod_python mailing list about  trouble w/ 
>>> apache not releasing the mutexes on restart:
>>>
>>> http://www.modpython.org/pipermail/mod_python/2004-May/015619.html
>>>
>>> I am having that exact same problem. You mentioned adding some code 
>>> to your init script to get around it. I would greatly appreiciate it 
>>> if you would post it or send it to me.
>>>
>>> Thanks for your time,
>>>  - Lee
>>>
>> Hi Lee
>>
>> Sorry, my code actually went to python-dev@httpd.apache.org for which 
>> I think there aren't easy public archives...
>> Anyway here is my patch:
>>
>> --- httpd.rpmsave       2004-05-28 16:43:58.000000000 +0200
>> +++ httpd       2004-06-29 18:20:47.000000000 +0200
>> @@ -66,6 +66,15 @@
>>       echo -n $"Stopping $prog: "
>>       killproc $httpd
>>       RETVAL=$?
>> +       removeipcs=`ipcs -s -c | grep apache | cut -d ' ' -f 1`
>> +       numipcs=`echo $removeipcs | wc -w`
>> +       if [ $numipcs != 0 ]
>> +       then
>> +               echo
>> +               echo -n $"and removing $numipcs ipcs: "
>> +               echo $removeipcs | xargs -n 1 ipcrm -s
>> +               sleep 2
>> +       fi
>>       echo
>>       [ $RETVAL = 0 ] && rm -f ${lockfile} ${pidfile}
>> }
>>
>> Note: I've just done this on a machine which has Apache 2 and Apache 
>> 1.3 running concurrently. In this situation it gets a bit more tricky 
>> because the ipcrm command inadvertently kills the Apache 1.3 process 
>> which has some ipcs open. So I have to restart it manually.
>>
>> I still haven't managed to debug exactly why this happens...
>>
>> David
>>
>>
>> _______________________________________________
>> Mod_python mailing list
>> Mod_python@modpython.org
>> http://mailman.modpython.org/mailman/listinfo/mod_python
>>
>

From Moiz.Golawala at ge.com  Wed Oct 27 13:05:55 2004
From: Moiz.Golawala at ge.com (Golawala, Moiz M (GE Infrastructure))
Date: Wed Oct 27 13:06:01 2004
Subject: [mod_python] newbie question
Message-ID: <CE90A4CF2E5E9C4890AE5D9D8A5EFAE30118979A@CINMLVEM10.e2k.ad.ge.com>

Hi All, 

I guess, I didn't really describe what my problem was so I will include some code snippets to explain what I am confused about. 

In my httpd.conf file:
<Directory /var/www/html/>
	PythonHandler main
	PythonDebug on
</Directory>

in my main.py file:

from cheetah.Template import Template
from mod_python import apache

def handler(req):
	t = Template(file,"/var/www/html/main.tmpl")
	textlen = len(str(t))
	req.set_content(t)
	req.set_content_length(textlen)
	apache.OK	

in my main.tmpl file:

<html>
<head></head>
<body>
	<form action="valid.py">
	<input type="text" size="20" name="input1">
	<input type="text" size="20" name="input2">
	<input type="submit" name="submit" value="submit">
	</form
</body>
</html>

My problem is that the browser renders the page that is defined in the main.tmpl file. But once I enter the text and click submit. I want the browser to display the page that is defined the template used in valid.py (as the form tag shows) but some how I get the main.py page back. The reason this is happening is that once I click the submit button, I get back to the server and the handler is invoked and main.py is called. I can never go to another page. 

I am sure I am doing something wrong. Please can someone help me out.. Or direct me to some place that show an example of how this mechanism works correctly.

Again, any help is appreciated. 
Thanks 
Moiz Golawala



-----Original Message-----
From: mod_python-bounces@modpython.org
[mailto:mod_python-bounces@modpython.org]On Behalf Of Golawala, Moiz M
(GE Infrastructure)
Sent: Wednesday, October 27, 2004 10:07 AM
To: mod_python@modpython.org
Subject: [mod_python] newbie question


Hi All, 

I am very new to mod_python (I have developed application with python but am new to web development in general). I have read most of the documentation and I have a couple of questions. I am planning to use mod_python along with Cheetah to build an internal website for my company. So far I have include some basic handlers in apache and can view a hello world script on my browser. Now when I try to do something a little more complicated I am lost.

 I have a couple of text fields that I want the user to fill out and then hit the submit button. I can get that html page up but I don't understand the mechanism where once a user hits the submit button, how does he/she get to the next page on the site. 

In the documentation I don't see any multi page working examples. Can some one point me to some resource that has working mult-page html (PSP or Cheetah based) examples with the necessary Directory tags in the httpd.conf file so I can better understand what is going on. 

Any help is appreciated greatly. 

Thank you,
Moiz

_______________________________________________
Mod_python mailing list
Mod_python@modpython.org
http://mailman.modpython.org/mailman/listinfo/mod_python

From fumanchu at amor.org  Wed Oct 27 13:06:15 2004
From: fumanchu at amor.org (Robert Brewer)
Date: Wed Oct 27 13:07:23 2004
Subject: [mod_python] newbie question
Message-ID: <3A81C87DC164034AA4E2DDFE11D258E32450B8@exchange.hqamor.amorhq.net>

Golawala, Moiz M wrote:
> I am very new to mod_python (I have developed application 
> with python but am new to web development in general). I have 
> read most of the documentation and I have a couple of 
> questions. I am planning to use mod_python along with Cheetah 
> to build an internal website for my company. So far I have 
> include some basic handlers in apache and can view a hello 
> world script on my browser. Now when I try to do something a 
> little more complicated I am lost.
> 
>  I have a couple of text fields that I want the user to fill 
> out and then hit the submit button. I can get that html page 
> up but I don't understand the mechanism where once a user 
> hits the submit button, how does he/she get to the next page 
> on the site. 
> 
> In the documentation I don't see any multi page working 
> examples. Can some one point me to some resource that has 
> working mult-page html (PSP or Cheetah based) examples with 
> the necessary Directory tags in the httpd.conf file so I can 
> better understand what is going on. 

In a simple application, you can simply examine req.uri in your
handler() function, and dispatch based on that. Here's an untested
example:


from mod_python import apache, util


def handler(req):
    # req.uri = the path portion of the URI.
    # "http://www.mycorp.org/myapp/topic.htm?a=3" -> "/myapp/topic.htm"
    page = req.uri
    if page == "/myapp/submit.htm":
        return submit(req)
    else:
        return view(req)

def view(req):
    req.write("""<html>
<body>
<form action='/myapp/submit.htm' method='POST'>
Please enter your name:
<input type='text' name='name' size='20' />
</form>
</body>
</html>
""")
    return apache.OK

def get_params(req):
    final = {}
    params = util.FieldStorage(req, 1).list
    if params is not None:
        for p in params:
            final[p.name] = p.value
    return final

def submit(req):
    params = get_params(req)
    req.write("Thank you, %s!" % params.get('name'))
    return apache.OK


Robert Brewer
MIS
Amor Ministries
fumanchu@amor.org

From jgentil at sebistar.net  Wed Oct 27 14:02:51 2004
From: jgentil at sebistar.net (Jon-Pierre Gentil)
Date: Wed Oct 27 14:03:05 2004
Subject: [mod_python] Bug when using Publisher with Callable Objects:
Message-ID: <417FE2CB.50209@sebistar.net>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: RIPEMD160

I get the following error when trying to use an instance of a callable
object instead of a function for the "functions" in Publisher.

Mod_python error: "PythonHandler mod_python.publisher"

Traceback (most recent call last):

  File "/usr/lib/python2.3/site-packages/mod_python/apache.py", line
299, in HandlerDispatch
    result = object(req)

  File "/usr/lib/python2.3/site-packages/mod_python/publisher.py",
line 136, in handler
    result = util.apply_fs_data(object, req.form, req=req)

  File "/usr/lib/python2.3/site-packages/mod_python/util.py", line
356, in apply_fs_data
    if not (fc.co_flags & 0x08):

UnboundLocalError: local variable 'fc' referenced before assignment

It appears taht apply_fs_data never expects for the object that is
passed to be a callable object instead of a function.

Any ideas on what to do?

Thanks!!!
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.5 (GNU/Linux)

iEYEAREDAAYFAkF/4ssACgkQOrVFmaIbww6HhQCgkP1m7Nx0GK0e7IHezuuVV1Ah
sygAniQ5j89jnW7JkzvCikqovuGDDrZM
=a+ph
-----END PGP SIGNATURE-----
From nferrier at tapsellferrier.co.uk  Wed Oct 27 15:10:51 2004
From: nferrier at tapsellferrier.co.uk (Nic Ferrier)
Date: Wed Oct 27 15:17:50 2004
Subject: [mod_python] newbie question
In-Reply-To: <CE90A4CF2E5E9C4890AE5D9D8A5EFAE30118979A@CINMLVEM10.e2k.ad.ge.com>
References: <CE90A4CF2E5E9C4890AE5D9D8A5EFAE30118979A@CINMLVEM10.e2k.ad.ge.com>
Message-ID: <87u0sgnfic.fsf@tapsellferrier.co.uk>

"Golawala, Moiz M \(GE Infrastructure\)" <Moiz.Golawala@ge.com> writes:

> Hi All, 
> 
> I guess, I didn't really describe what my problem was so I will
> include some code snippets to explain what I am confused about.
> 
> In my httpd.conf file:
> <Directory /var/www/html/>
> 	PythonHandler main
> 	PythonDebug on
> </Directory>
> 
> in my main.py file:
> 
> from cheetah.Template import Template
> from mod_python import apache
> 
> def handler(req):
> 	t = Template(file,"/var/www/html/main.tmpl")
> 	textlen = len(str(t))
> 	req.set_content(t)
> 	req.set_content_length(textlen)
> 	apache.OK	
> 
> in my main.tmpl file:
> 
> <html>
> <head></head>
> <body>
> 	<form action="valid.py">
> 	<input type="text" size="20" name="input1">
> 	<input type="text" size="20" name="input2">
> 	<input type="submit" name="submit" value="submit">
> 	</form
> </body>
> </html>
> 
> My problem is that the browser renders the page that is defined in
> the main.tmpl file. But once I enter the text and click submit. I
> want the browser to display the page that is defined the template
> used in valid.py (as the form tag shows) but some how I get the
> main.py page back. The reason this is happening is that once I click
> the submit button, I get back to the server and the handler is
> invoked and main.py is called. I can never go to another page.
> 
> I am sure I am doing something wrong. Please can someone help me
> out.. Or direct me to some place that show an example of how this
> mechanism works correctly.

The reason is that the request is being received by Apache and it is
consulting it's config file to see what it should do, this:

> <Directory /var/www/html/>
> 	PythonHandler main
> 	PythonDebug on
> </Directory>

The PythonHandler statement tells Apache to pass all requests to the
main.py handler so your valid.py doesn't get a look in.

Adding this to your config would be a quick fix:

  <Location /valid.py>
    SetHandler python-program
    PythonHandler valid
  </Location>

But consult the documentation for mod_python and the various handler
tools to establish alternatives that may suit you better.

-- 
Nic Ferrier
http://www.tapsellferrier.co.uk
From list at joreybump.com  Wed Oct 27 16:04:34 2004
From: list at joreybump.com (Jorey Bump)
Date: Wed Oct 27 16:04:47 2004
Subject: [mod_python] Authentification/Session Management
In-Reply-To: <417F70A6.2070500@open.ac.uk>
References: <417F70A6.2070500@open.ac.uk>
Message-ID: <417FFF52.3040107@joreybump.com>

Lukas Trejtnar wrote:

> I'm trying to implement a session management together with an 
> authentification procedure.
> 
> I have a folder which contains PSP (my_pages). When a user accesses 
> my_pages for the first time, an authentification dialogue box is 
> invoked, a user is authentified and new session is created (with timeout 
> 300s). User happily browses my_pages.
> 
> Now, if s/he is inactive for more than 300s and starts browsing again, 
> new session is created. It's fine, but I would like to force the 
> authentification dialogue box to appear again before a session creation.
> 
> How can I do that? Here is my code:

> def authenhandler(req):
> 
>     req.session = Session.Session(req, timeout=300)
> 
>     passwd = req.get_basic_auth_pw()
>     user = req.user
> 
>     if req.session.is_new():
>         req.session['passwd'] = passwd
>         req.session['user'] = user

Just a guess, but if you clear passwd & user here:

           passwd = ''
           user = ''

then authentication will fail only when the session is new and force the 
user to reauthenticate. Untested, but worth a try.

>     req.session.save()
> 
>     if  passwd == "spam" and user == "eggs":
>         return apache.OK
>     else:
>         return apache.HTTP_UNAUTHORIZED

You could also set a variable and test for it:

     newsession = 0

     if req.session.is_new():
         newsession = 1
         req.session['passwd'] = passwd
         req.session['user'] = user

     if  passwd == "spam" and user == "eggs" and newsession == 0:
         return apache.OK
     else:
         return apache.HTTP_UNAUTHORIZED


From toby at rcsreg.com  Wed Oct 27 09:57:36 2004
From: toby at rcsreg.com (Tobiah)
Date: Wed Oct 27 16:57:20 2004
Subject: [mod_python] Trying to use httpd.conf to modify environment for
	publisher handler
Message-ID: <417FA950.7020006@rcsreg.com>



I put:

	SetEnv PYTHONPATH /usr/local/lib/python

Into my httpd.conf, but when I restart apache and do:

	def index(req):

		out = ''
		for thing in os.environ:
			out += thing + " => " + os.environ[thing] + "\n"
		return out


I see my environment, but not the ones that I put in with SetEnv.
Am I missing something?

Thanks,

Toby

From nick at dd.revealed.net  Wed Oct 27 17:05:28 2004
From: nick at dd.revealed.net (Nick)
Date: Wed Oct 27 17:05:57 2004
Subject: [mod_python] Trying to use httpd.conf to modify environment for
	publisher handler
In-Reply-To: <417FA950.7020006@rcsreg.com>
References: <417FA950.7020006@rcsreg.com>
Message-ID: <41800D98.7010001@dd.revealed.net>

FYI, I've found that mod_env and mod_python interact badly when it comes to 
reading the CGI environment (apache 1.3).

Nick

Tobiah wrote:
> 
> 
> I put:
> 
>     SetEnv PYTHONPATH /usr/local/lib/python
> 
> Into my httpd.conf, but when I restart apache and do:
> 
>     def index(req):
> 
>         out = ''
>         for thing in os.environ:
>             out += thing + " => " + os.environ[thing] + "\n"
>         return out
> 
> 
> I see my environment, but not the ones that I put in with SetEnv.
> Am I missing something?
> 
> Thanks,
> 
> Toby
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

From nferrier at tapsellferrier.co.uk  Wed Oct 27 17:33:10 2004
From: nferrier at tapsellferrier.co.uk (Nic Ferrier)
Date: Wed Oct 27 17:37:39 2004
Subject: [mod_python] Trying to use httpd.conf to modify environment for 
	publisher handler
In-Reply-To: <417FA950.7020006@rcsreg.com>
References: <417FA950.7020006@rcsreg.com>
Message-ID: <873bzzonhl.fsf@tapsellferrier.co.uk>

Tobiah <toby@rcsreg.com> writes:

> I put:
> 
> 	SetEnv PYTHONPATH /usr/local/lib/python
> 
> Into my httpd.conf, but when I restart apache and do:
> 
> 	def index(req):
> 
> 		out = ''
> 		for thing in os.environ:
> 			out += thing + " => " + os.environ[thing] + "\n"
> 		return out
> 
> 
> I see my environment, but not the ones that I put in with SetEnv.
> Am I missing something?

I think it's documented that env's don't work for mod_python.

You can use:

http://www.modpython.org/live/mod_python-2.7.8/doc-html/dir-other-po.html


-- 
Nic Ferrier
http://www.tapsellferrier.co.uk
From terry.macdonald at dsl.pipex.com  Wed Oct 27 17:57:19 2004
From: terry.macdonald at dsl.pipex.com (Terry MacDonald)
Date: Wed Oct 27 17:57:28 2004
Subject: [mod_python] Authentification/Session Management
In-Reply-To: <417F70A6.2070500@open.ac.uk>
References: <417F70A6.2070500@open.ac.uk>
Message-ID: <1098914238.2712.44.camel@bigmac.taumu.com>

along the same lines...

def authenhandler( req ) :
    req.session = Session.Session(req, timeout=300)
    if req.session.is_new() :
        if 'eggs' == req.user and 'spam' == req.get_basic_auth_pw() :
            req.session.save()
        else:
            return apache.HTTP_UNAUTHORIZED
    return apache.OK

cheers

Terry    :)



Registered Linux User # 311806 
Get Firefox

From Joseph.Skora at jhuapl.edu  Wed Oct 27 19:12:16 2004
From: Joseph.Skora at jhuapl.edu (Skora, Joseph)
Date: Wed Oct 27 19:12:22 2004
Subject: [mod_python] Sessions Question
Message-ID: <D4948B7E0294E44EABDDF72BFDEC412B01FCFFF2@aplesfreedom.dom1.jhuapl.edu>

Please forgive me if this is covered somewhere, I have searched high and
low for a couple days.

I am expecting that using mod_python, sessions, and authentication, I
should be able to have a page that required login and re-requires the
login when the session expires.  I may be mixing apples and potatos
though, so please correct me.

I am put together a page requiring authentication (passwd='ok' for any
user) and then have the login timeout when the session expires.  My page
is

from mod_python import apache, Session

--------------------
def handler(req):
  req.content_type = 'text/html'
  user = req.session.has_key('user') and req.session['user'] or
'Unknown'
  req.write("Hello World (%s)!<br>" % user)
  return apache.OK
    
def authenhandler(req):
  req.session = Session.Session(req, timeout=10.0)
  passwd = req.get_basic_auth_pw()
  user = req.user
  if req.session.is_new():    
    req.session['passwd'] = passwd
    req.session['user'] = user  
  req.session.save()
  if passwd == 'ok':
    return apache.OK
  else:
    return apache.HTTP_UNAUTHORIZED
------------------------

It all appears to be setup ok, but the session expires without requiring
a new login.  How do I require a re-login when the session has expired?

Thanks,

Joe Skora
joseph.skora@jhuapl.edu

From grisha at modpython.org  Wed Oct 27 23:40:21 2004
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Wed Oct 27 23:40:29 2004
Subject: [mod_python] Authentification/Session Management
In-Reply-To: <1098914238.2712.44.camel@bigmac.taumu.com>
References: <417F70A6.2070500@open.ac.uk>
	<1098914238.2712.44.camel@bigmac.taumu.com>
Message-ID: <20041027233801.Q47039@onyx.ispol.com>



On Wed, 27 Oct 2004, Terry MacDonald wrote:

>        if 'eggs' == req.user and 'spam' == req.get_basic_auth_pw() :

will fail in some configurations

 	if 'spam' == req.get_basic_auth_pw() and 'eggs' == req.user:

should always work, however

(because get_basic_auth_pw() must be called before looking at req.user)

grisha
From davidf at sjsoft.com  Thu Oct 28 01:33:00 2004
From: davidf at sjsoft.com (David Fraser)
Date: Thu Oct 28 01:33:15 2004
Subject: [mod_python] Re: Apache/mod_python SSLMutex
In-Reply-To: <157482a157a16e.157a16e157482a@columbus.rr.com>
References: <157482a157a16e.157a16e157482a@columbus.rr.com>
Message-ID: <4180848C.1060902@sjsoft.com>

LeePatton@woh.rr.com wrote:

>Thanks a lot! I appreciate your time. I am not exactly sure what is happening either. If you're interested, here is when I'm seeing the problem:
>  
>
Sure. I think it would be better if you mailed the list as well rather 
than just me and Grisha :-)

>For a while I was attempting to write an accesshandler that was redirecting (util.redirect) to other scripts in the directory it was handling access for. The scripts that were getting the *new* request (it took me a while to realize they were new requests) would always hange when trying to get the session information. (i image because the *old* request wasn't unlocked?). Anyway, I would have to restart a number of times, sometimes getting the same error message your received about not being able to bind to 443. Finally, Apache wouldn't restart giving me the SSLMutex error.
>  
>
I don't know that much about session locking, maybe somebody on the list 
can help... but I do know that the ipcs aren't being freed. I'll feed 
back to the list if I make any progress on that...

Cheers
David

>Thanks again,
>  - Lee
>
>
>----- Original Message -----
>From: David Fraser <davidf@sjsoft.com>
>Date: Wednesday, October 27, 2004 10:15 am
>Subject: Re: Apache/mod_python SSLMutex
>
>  
>
>>LeePatton@woh.rr.com wrote:
>>
>>    
>>
>>>I found your post on the mod_python mailing list about  trouble w/ 
>>>      
>>>
>>apache not releasing the mutexes on restart:
>>    
>>
>>>http://www.modpython.org/pipermail/mod_python/2004-May/015619.html
>>>
>>>I am having that exact same problem. You mentioned adding some 
>>>      
>>>
>>code to your init script to get around it. I would greatly 
>>appreiciate it if you would post it or send it to me.
>>    
>>
>>>Thanks for your time,
>>> - Lee
>>> 
>>>
>>>      
>>>
>>Hi Lee
>>
>>Sorry, my code actually went to python-dev@httpd.apache.org for 
>>which I 
>>think there aren't easy public archives...
>>Anyway here is my patch:
>>
>>--- httpd.rpmsave       2004-05-28 16:43:58.000000000 +0200
>>+++ httpd       2004-06-29 18:20:47.000000000 +0200
>>@@ -66,6 +66,15 @@
>>       echo -n $"Stopping $prog: "
>>       killproc $httpd
>>       RETVAL=$?
>>+       removeipcs=`ipcs -s -c | grep apache | cut -d ' ' -f 1`
>>+       numipcs=`echo $removeipcs | wc -w`
>>+       if [ $numipcs != 0 ]
>>+       then
>>+               echo
>>+               echo -n $"and removing $numipcs ipcs: "
>>+               echo $removeipcs | xargs -n 1 ipcrm -s
>>+               sleep 2
>>+       fi
>>       echo
>>       [ $RETVAL = 0 ] && rm -f ${lockfile} ${pidfile}
>>}
>>
>>Note: I've just done this on a machine which has Apache 2 and 
>>Apache 1.3 
>>running concurrently. In this situation it gets a bit more tricky 
>>because the ipcrm command inadvertently kills the Apache 1.3 
>>process 
>>which has some ipcs open. So I have to restart it manually.
>>
>>I still haven't managed to debug exactly why this happens...
>>
>>David
>>
>>
>>
>>    
>>
>
>  
>

From l.trejtnar at open.ac.uk  Thu Oct 28 06:40:15 2004
From: l.trejtnar at open.ac.uk (Lukas Trejtnar)
Date: Thu Oct 28 06:40:45 2004
Subject: [mod_python] Authentification/Session Management
Message-ID: <4180CC8F.40907@open.ac.uk>

I tried both solutions and they don't work, unfortunately.

The first solution by Jorey Bump doesn't pass the first 
authentification. It keeps asking for a username and a password forever 
(newsession == 1 -> return apache.HTTP_UNAUTHORISED). Or did I miss 
something?

      newsession = 0

      if req.session.is_new():
          newsession = 1
          req.session['passwd'] = passwd
          req.session['user'] = user

      if  passwd == "spam" and user == "eggs" and newsession == 0:
          return apache.OK
      else:
          return apache.HTTP_UNAUTHORIZED


The second solution by Terry MacDonald doesn't solve the problem either. 
I modified the code a bit [1) a session has to be saved every time it's 
authentified otherwise it expires after timeout period since creation 
time (not last accessed)!!! 2) I always have to assign a value to 
req.user variable otherwise Apache throws an error?!?!?.]:

def authenhandler( req ) :
	req.session = Session.Session(req, timeout=5)
	if req.session.is_new() :
		if 'spam' == req.get_basic_auth_pw() and 'eggs' == req.user  :
			req.session['user'] = req.user
			#req.session.save()
		else:
			return apache.HTTP_UNAUTHORIZED
	req.user = req.session['user']
	req.session.save()
	return apache.OK


It doesn't work because when the session expires, a user is not asked 
for  a username and a password at all.

It seems that the Apache authentification procedure is executed before 
the mod_python authenhandler function is even called and its result is 
remembered for time a browser is opened.

I changed 'KepAlive' directive of the Apache config to 'Off', but it 
didn't help.

One solution would be to ask at the beginning of the authenhandler 
function if the session is already expired. Something like:

	if req.session.exists() and req.session.expired():
		return apache.HTTP_UNAUTHORISED

Unfortunately, I didn't find a way how to specify two functions 
mentioned above.

Any hint what I do wrong?

Thanks,
Lukas
From list at joreybump.com  Thu Oct 28 12:26:39 2004
From: list at joreybump.com (Jorey Bump)
Date: Thu Oct 28 12:26:44 2004
Subject: [mod_python] Authentification/Session Management
In-Reply-To: <4180CC8F.40907@open.ac.uk>
References: <4180CC8F.40907@open.ac.uk>
Message-ID: <41811DBF.5080206@joreybump.com>

Lukas Trejtnar wrote:

> The first solution by Jorey Bump doesn't pass the first 
> authentification. It keeps asking for a username and a password forever 
> (newsession == 1 -> return apache.HTTP_UNAUTHORISED). Or did I miss 
> something?

I think we both did. Your session handling code should appear in the 
section that handles successful authentication. Then you need to perform 
the *authorization* step by checking the validity of the session. If 
that test fails, you return apache.HTTP_UNAUTHORIZED (in addition to 
returning it where authentication fails):

  if passwd == "spam" and user == "eggs":
      session handling/tests here
      if passed:
          return apache.OK
      else:
          return apache.HTTP_UNAUTHORIZED
  else:
      return apache.HTTP_UNAUTHORIZED

Again, this is untested, and I'm no sessions guru. If I get a chance to 
work up any usable code, I'll post it.
From neel at mediapulse.com  Thu Oct 28 16:41:31 2004
From: neel at mediapulse.com (Michael C. Neel)
Date: Thu Oct 28 16:36:02 2004
Subject: [mod_python] [ANNOUNCE] SnakeSkin 1.0
Message-ID: <1098996090.3838.142.camel@mike.mediapulse.com>

We are proud to announce the release of version 1.0 of SnakeSkin, a
python application toolkit released under an Open Source BSD-Style
license, available at http://snakeskin.pseudocode.net/  Along with this
release, we have updated the CGI Demo to be easier to install and
follow.

Both of these releases can be found at (along with more information
including change logs):
http://sourceforge.net/project/showfiles.php?group_id=118346

Support for SnakeSkin is handled though SourceForge.Net.  The project
information page is at http://www.sourceforge.net/projects/snakeskin-tools
There you will find the bug tracking system, a feature request system, and
the main method of support, the SnakeSkin mailing list.

About SnakeSkin

In SnakeSkin, developers can customize the framework to the application,
unlike in traditional frameworks, such as PHP. For example, adding 
custom tags to the templating system is quick and easy. The goal of the 
project is to have a framework that scales down as well as up--a 
"Zope-lite" framework. SnakeSkin can scale down to be useful in a simple 
form-to-email or just to apply a clean-cut design skin. The toolkit can 
just as easily scale up to handle complex content managment systems, B2B 
extranets, and full-fledged e-commerce engines.  We do it all the time.

SnakeSkin, based upon the existing Albatross project maintained by 
Object Craft, runs under several webservers, including CGI based, 
Apache, FastCGI, and its own included webserver (used mainly for 
development).

SnakeSkin has several built in capabilities:

* Dynamic Macro Features (think server-side includes on steroids)
* SQL support in both the application and the template
* Support for Apache 2.0 Filters

... and includes Albatross features ...

* Clean separation of logic and design
* A simple-yet-robust templating system that is Web Designer-friendly 
(Plays nice with Dreamweaver)
* Secure Session Management in hidden fields, server-side data-stores, 
or through a session server

The SnakeSkin team.
http://snakeskin.pseudocode.net/



From list at joreybump.com  Thu Oct 28 20:43:17 2004
From: list at joreybump.com (Jorey Bump)
Date: Thu Oct 28 20:43:26 2004
Subject: [mod_python] Authentification/Session Management
In-Reply-To: <41811DBF.5080206@joreybump.com>
References: <4180CC8F.40907@open.ac.uk> <41811DBF.5080206@joreybump.com>
Message-ID: <41819225.80503@joreybump.com>

Jorey Bump wrote:

> I think we both did. Your session handling code should appear in the 
> section that handles successful authentication. Then you need to perform 
> the *authorization* step by checking the validity of the session. If 
> that test fails, you return apache.HTTP_UNAUTHORIZED (in addition to 
> returning it where authentication fails):
> 
>  if passwd == "spam" and user == "eggs":
>      session handling/tests here
>      if passed:
>          return apache.OK
>      else:
>          return apache.HTTP_UNAUTHORIZED
>  else:
>      return apache.HTTP_UNAUTHORIZED
> 
> Again, this is untested, and I'm no sessions guru. If I get a chance to 
> work up any usable code, I'll post it.

It seems that Session.timeout() isn't suitable for tracking inactivity, 
it merely imposes a finite lifespan on the session, regardless of last 
access (correct me if I'm wrong). Therefore, you need to set session 
variables to track time between requests. This isn't too hard. I used 
Publisher's builtin authentication instead of PythonAuthenHandler, 
because I'm more familiar with it.

The basic logic is this:

1. Set session variables when session is created.
2. For each request, look at session variables to measure inactivity.
3. If inactive too long, force user to reauthenticate.

For the last step, the session may be deleted to force session 
initialization code to run again.

To test the following, open a browser, visit the appropriate URL, 
authenticate (user=eggs, pwd=spam), hit refresh a few times, pause 
longer than 5 seconds, then hit refresh again. You should be forced to 
reauthenticate.

Tested on:

Apache 2.0.52
Python 2.3.4
mod_python 3.1.3


In httpd.conf:

   <Directory "/usr/local/apache2/htdocs">
       Order allow,deny
       Allow from all
       SetHandler python-program
       PythonHandler mod_python.publisher
       PythonDebug On
   </Directory>


This is hello.py (visit http://localhost/hello.py/say?what=something):

from mod_python.Session import Session
import time

# restrict access to this module with basic authentication
__auth_realm__ = "Restricted"

# allow these users
def __access__(req, user):
     if user == "eggs":
         return 1
     else:
         return 0

# check user and password
def __auth__(req, user, passwd):
     if user == "eggs" and passwd == "spam":
         # user has successfully authenticated
         sess = Session(req)
         if sess.has_key('max_inactive'):
             # this is an existing session

             # check length of inactivity
             elapsed = time.time() - sess['last']

             # reset timer for next request
             sess['last'] = time.time()
             sess.save()

             # compare elapsed inactivity to maximum allowed
             if elapsed > sess['max_inactive']:
                 # it's been too long

                 # uncomment to delete session (optional)
                 # sess.delete()

                 # force user to reauthenticate
                 return 0
             else:
                 # still within time limit
                 req.write("Authorized.\n\n")

                 # allow user to continue
                 return 1
         else:
             # this must be a new session, so set session variables

             # set maximum inactivity allowed, in seconds
             # use low value for testing
             sess['max_inactive'] = 5

             # initialize timer
             sess['last'] = time.time()

             sess.save()

             # do new session stuff here
             req.write("Session started.\n\n")

             # allow user to continue
             return 1
     else:
         # wrong user or password, force user to reauthenticate
         return 0

def say(req, what="NOTHING"):
     # all that, just to see this?
     return "I am saying %s." % what

From l.trejtnar at open.ac.uk  Fri Oct 29 09:03:17 2004
From: l.trejtnar at open.ac.uk (Lukas Trejtnar)
Date: Fri Oct 29 09:04:00 2004
Subject: [mod_python] Authentification/Session Management
In-Reply-To: <41819225.80503@joreybump.com>
References: <4180CC8F.40907@open.ac.uk> <41811DBF.5080206@joreybump.com>
	<41819225.80503@joreybump.com>
Message-ID: <41823F95.2020309@open.ac.uk>

Hi Jorey

Thank you for the examples. I tried the latter and it worked exactly as 
I wanted it to work. I reused this example in the PythonAuthenHandler 
and it worked fine, also. Great, many thanks.

I'm a bit curious if it is possible to use session's native functions 
for the same functionality instead of a reimplementation of the 
session's timeout.

Thanks,
Lukas

Jorey Bump wrote:
> Jorey Bump wrote:
> 
>> I think we both did. Your session handling code should appear in the 
>> section that handles successful authentication. Then you need to 
>> perform the *authorization* step by checking the validity of the 
>> session. If that test fails, you return apache.HTTP_UNAUTHORIZED (in 
>> addition to returning it where authentication fails):
>>
>>  if passwd == "spam" and user == "eggs":
>>      session handling/tests here
>>      if passed:
>>          return apache.OK
>>      else:
>>          return apache.HTTP_UNAUTHORIZED
>>  else:
>>      return apache.HTTP_UNAUTHORIZED
>>
>> Again, this is untested, and I'm no sessions guru. If I get a chance 
>> to work up any usable code, I'll post it.
> 
> 
> It seems that Session.timeout() isn't suitable for tracking inactivity, 
> it merely imposes a finite lifespan on the session, regardless of last 
> access (correct me if I'm wrong). Therefore, you need to set session 
> variables to track time between requests. This isn't too hard. I used 
> Publisher's builtin authentication instead of PythonAuthenHandler, 
> because I'm more familiar with it.
> 
> The basic logic is this:
> 
> 1. Set session variables when session is created.
> 2. For each request, look at session variables to measure inactivity.
> 3. If inactive too long, force user to reauthenticate.
> 
> For the last step, the session may be deleted to force session 
> initialization code to run again.
> 
> To test the following, open a browser, visit the appropriate URL, 
> authenticate (user=eggs, pwd=spam), hit refresh a few times, pause 
> longer than 5 seconds, then hit refresh again. You should be forced to 
> reauthenticate.
> 
> Tested on:
> 
> Apache 2.0.52
> Python 2.3.4
> mod_python 3.1.3
> 
> 
> In httpd.conf:
> 
>   <Directory "/usr/local/apache2/htdocs">
>       Order allow,deny
>       Allow from all
>       SetHandler python-program
>       PythonHandler mod_python.publisher
>       PythonDebug On
>   </Directory>
> 
> 
> This is hello.py (visit http://localhost/hello.py/say?what=something):
> 
> from mod_python.Session import Session
> import time
> 
> # restrict access to this module with basic authentication
> __auth_realm__ = "Restricted"
> 
> # allow these users
> def __access__(req, user):
>     if user == "eggs":
>         return 1
>     else:
>         return 0
> 
> # check user and password
> def __auth__(req, user, passwd):
>     if user == "eggs" and passwd == "spam":
>         # user has successfully authenticated
>         sess = Session(req)
>         if sess.has_key('max_inactive'):
>             # this is an existing session
> 
>             # check length of inactivity
>             elapsed = time.time() - sess['last']
> 
>             # reset timer for next request
>             sess['last'] = time.time()
>             sess.save()
> 
>             # compare elapsed inactivity to maximum allowed
>             if elapsed > sess['max_inactive']:
>                 # it's been too long
> 
>                 # uncomment to delete session (optional)
>                 # sess.delete()
> 
>                 # force user to reauthenticate
>                 return 0
>             else:
>                 # still within time limit
>                 req.write("Authorized.\n\n")
> 
>                 # allow user to continue
>                 return 1
>         else:
>             # this must be a new session, so set session variables
> 
>             # set maximum inactivity allowed, in seconds
>             # use low value for testing
>             sess['max_inactive'] = 5
> 
>             # initialize timer
>             sess['last'] = time.time()
> 
>             sess.save()
> 
>             # do new session stuff here
>             req.write("Session started.\n\n")
> 
>             # allow user to continue
>             return 1
>     else:
>         # wrong user or password, force user to reauthenticate
>         return 0
> 
> def say(req, what="NOTHING"):
>     # all that, just to see this?
>     return "I am saying %s." % what
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
> 
From list at joreybump.com  Fri Oct 29 12:12:55 2004
From: list at joreybump.com (Jorey Bump)
Date: Fri Oct 29 12:13:03 2004
Subject: [mod_python] Authentification/Session Management
In-Reply-To: <41823F95.2020309@open.ac.uk>
References: <4180CC8F.40907@open.ac.uk> <41811DBF.5080206@joreybump.com>
	<41819225.80503@joreybump.com> <41823F95.2020309@open.ac.uk>
Message-ID: <41826C07.2070207@joreybump.com>

Lukas Trejtnar wrote:

> Thank you for the examples. I tried the latter and it worked exactly as 
> I wanted it to work. I reused this example in the PythonAuthenHandler 
> and it worked fine, also. Great, many thanks.

No problem. I've been putting off learning more about sessions because I 
hate to use cookies. I'm glad you asked the question.

If you get a chance, check the code with a variety of browsers. I get 
perfect results  from the latest versions of IE and lynx. Mozilla 1.7.3 
works, but only displays the realm name in the first login box. 
Subsequent logins identify the realm as "" (this may be a display bug, 
since the Live HTTP headers plugin clearly shows the realm name being 
sent from the server -- I'll have to do a proper sniff to see if there 
is any difference).

Opera 7.54 begins the session, but returns an "internal communication 
error" instead of putting up a new login when the max time has elapsed. 
Both the session and authorization code work well standalone, but Opera 
doesn't like the way I combine them.

> I'm a bit curious if it is possible to use session's native functions 
> for the same functionality instead of a reimplementation of the 
> session's timeout.

My guess is that the timeout is really a server side housekeeping 
feature, since it doesn't affect the expiration date of the cookie. And 
the Session.last_accessed() always returns the current time (which is 
probably correct, but begs for the presence of 
Session.time_before_last_accessed()). I think Session.is_new() is meant 
to be used for initialization code, so destroying a user's session to 
gain this functionality seems less than optimum.

I got all of my info here:

  http://www.modpython.org/live/current/doc-html/pyapi-sess-classes.html

but it's a bit terse. Does anyone have an URL for the underlying apache 
session documentation? I can't find it, and the mod_usertrack page is 
pretty lean.

From sanders at apache.org  Fri Oct 29 13:41:08 2004
From: sanders at apache.org (Scott Sanders)
Date: Fri Oct 29 13:41:26 2004
Subject: [mod_python] Authentification/Session Management
In-Reply-To: <41826C07.2070207@joreybump.com>
References: <4180CC8F.40907@open.ac.uk> <41811DBF.5080206@joreybump.com>
	<41819225.80503@joreybump.com> <41823F95.2020309@open.ac.uk>
	<41826C07.2070207@joreybump.com>
Message-ID: <B71880C7-29D1-11D9-ABF4-000A95D2D288@apache.org>


On Oct 29, 2004, at 9:12 AM, Jorey Bump wrote:

> I got all of my info here:
>
>  http://www.modpython.org/live/current/doc-html/pyapi-sess-classes.html
>
> but it's a bit terse. Does anyone have an URL for the underlying 
> apache session documentation? I can't find it, and the mod_usertrack 
> page is pretty lean.

I could be wrong, but I believe that the session code is specific to 
mod_python, and does not use anything from apache.  It just relies on a 
cookie.  So, there is no underlying apache session to be documented.

Scott

From crxop at tiscali.it  Fri Oct 29 14:03:32 2004
From: crxop at tiscali.it (Daniele Cruciani)
Date: Fri Oct 29 14:03:37 2004
Subject: [mod_python] mod_python.publisher and __access__ value
Message-ID: <20041029180332.GC3844@fincos.homeip.net>

Hi,

first of all hello. I'm new to this list and relatively new to
mod_python. I looked at exampe in
http://modpython.org/example/psp_site/ . Next, downloaded the I just try:

http://modpython.org/example/psp_site/_base_url

and i get what I should not. I tried with a module and __access__=0 it
does not work too. I does not understand if still I can do
from module import * 
and having __access__ do something or I have to use
apache.import_module()

I did in siteutil.py
__access__=0
def getlang(req):
    ...
    ...
    return str

in index.py

from siteutil import getlang

and

http://fincos.homeip.net/getlang

give language (actually not exactly)

in .htaccess
SetHandler mod_python
PythonHandler mod_python.publisher

Also, I'm very confused on how to use mod_python because it give me
too freedom, but I prefer it to zope for resource consuming: there is
some hint and/or more example in simple way to use it?


Cheers,
Daniele.
From SmKeesle at syr.edu  Fri Oct 29 14:47:15 2004
From: SmKeesle at syr.edu (Sean Keesler)
Date: Fri Oct 29 14:47:27 2004
Subject: [mod_python] psp pages - I'm an idiot
Message-ID: <s18257fd.041@gwia201.syr.edu>

Skipped content of type multipart/alternative-------------- next part --------------
BEGIN:VCARD
VERSION:2.1
X-GWTYPE:USER
FN:Keesler, Sean
TEL;WORK:315-443-3450
ORG:;SUED Living School Book
TEL;PREF;FAX:325-443-
EMAIL;WORK;PREF;NGW:SmKeesle@syr.edu
N:Keesler;Sean
TITLE:Field Coordinator
END:VCARD

BEGIN:VCARD
VERSION:2.1
X-GWTYPE:USER
FN:Keesler, Sean
TEL;WORK:315-443-3450
ORG:;SUED Living School Book
TEL;PREF;FAX:325-443-
EMAIL;WORK;PREF;NGW:SmKeesle@syr.edu
N:Keesler;Sean
TITLE:Field Coordinator
END:VCARD

From eric at ericwalstad.com  Fri Oct 29 15:17:11 2004
From: eric at ericwalstad.com (Eric Walstad)
Date: Fri Oct 29 15:17:22 2004
Subject: [mod_python] psp pages - I'm an idiot
In-Reply-To: <s18257fd.041@gwia201.syr.edu>
References: <s18257fd.041@gwia201.syr.edu>
Message-ID: <200410291217.12432.eric@ericwalstad.com>

Hey Sean,

On Friday 29 October 2004 11:47 am, Sean Keesler wrote:
[...]
> File
> "C:/Program Files/Apache Group/Apache2/htdocs/psp/index.psp", line
> 3 for n in range(3):    ^SyntaxError: invalid syntaxWhat could be
> causing this?  Anything wrong in my config??

It looks like the index.psp file you posted isn't the one that 
mod_python is executing.  The debug code is showing "for n in 
range(3):"  which I'd guess has a syntax error relating to 
indentation.

Eric.
From huzaifa at hostway.com  Fri Oct 29 15:42:10 2004
From: huzaifa at hostway.com (Huzaifa Tapal)
Date: Fri Oct 29 15:45:52 2004
Subject: [mod_python] ImportError: No module named _apache
Message-ID: <20041029194549.A9030B59C@fiona.siteprotect.com>

I have followed all the steps outlined in your documentation for mod_python
3.1.3 for apache 2.0.  however, when executing the test script I am running
into a problem where I get the following error:

 

Traceback (most recent call last):

    File "mptest.py", line 1, in ?

        from mod_python import apache

    File
"/usr/local/python2.3.4/lib/python2.3/site-packages/mod_python/apache.py",
line 28, in ?

        import _apache

ImportError: No module named _apache

 

After digging around a whole lot, I see that the _apachemodule.c is getting
compiled into the mod_python.so binary.  I checked the init_apache() method
in _apachmodule.c and at one point if there is an error compiling the
_apache module into mod_python, it errors out silently without any
exceptions being raised.

 

I am afraid that the _apache module might be erroring out and as a result
mod_python is not functioning.

 

Can you please shed some light?

 

Huzaifa Tapal

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20041029/c0fa535f/attachment.html
From davidf at sjsoft.com  Fri Oct 29 17:56:55 2004
From: davidf at sjsoft.com (David Fraser)
Date: Fri Oct 29 17:57:03 2004
Subject: [mod_python] ImportError: No module named _apache
In-Reply-To: <20041029194549.A9030B59C@fiona.siteprotect.com>
References: <20041029194549.A9030B59C@fiona.siteprotect.com>
Message-ID: <4182BCA7.8000102@sjsoft.com>

Huzaifa Tapal wrote:

> I have followed all the steps outlined in your documentation for 
> mod_python 3.1.3 for apache 2.0. however, when executing the test 
> script I am running into a problem where I get the following error:
>
> Traceback (most recent call last):
>
> File ?mptest.py?, line 1, in ?
>
> from mod_python import apache
>
> File 
> ?/usr/local/python2.3.4/lib/python2.3/site-packages/mod_python/apache.py?, 
> line 28, in ?
>
> import _apache
>
> ImportError: No module named _apache
>
> After digging around a whole lot, I see that the _/apachemodule.c /is 
> getting compiled into the mod_python.so binary. I checked the 
> init_apache() method in _apachmodule.c and at one point if there is an 
> error compiling the _apache module into mod_python, it errors out 
> silently without any exceptions being raised.
>
> I am afraid that the _apache module might be erroring out and as a 
> result mod_python is not functioning.
>
> Can you please shed some light?
>
It would be great if you could say what platform you are using, and what 
the error compiling the _apache module into mod_python is ...

David
From wip at rpgmaker.net  Fri Oct 29 18:10:34 2004
From: wip at rpgmaker.net (August Trapper Bigelow)
Date: Fri Oct 29 18:10:42 2004
Subject: [mod_python] Request dropping
Message-ID: <4182BFDA.5090202@rpgmaker.net>

Seems that when I run my mod_python based website through the Apache 
Benchmarker (http://codeflux.com/ab/) I am dropping a considerable 
amount of requests. This problem does not occur when testing the 
psp_site from the website.

I am running Python 2.3.4 with Apache 2.0.52 and the lastest mod_python 
on Windows XP SP2. My first guess was a Windows XP connection limit, as 
I received an OS64 error in my error.log with a winnt exception inside 
it. However, I test PHP pages through the benchmarker and it doesn't 
drop any requests.

My second thought was I am doing too much processing on the pages, but 
there are some PHP pages that take forever, so I figured that wasn't it 
either.

Anybody have this proble and a solution?
From robert at worksofmagic.com  Fri Oct 29 18:34:47 2004
From: robert at worksofmagic.com (Robert Geller)
Date: Fri Oct 29 18:34:56 2004
Subject: [mod_python] mod_python and mysql
Message-ID: <003201c4be07$80061fb0$1e02a8c0@leet>

Hello all --
 
I am having trouble with mod_python 3.1.3 and MySQLdb 1.1.6 (recommended
by the Andy, the author of MySQL-db).
I'm just trying to get this to work, and have a test page setup, with a
mysql query and fetchall statement as follows:
 

from mod_python import apache
import MySQLdb
 
def handler(req):
        req.content_type = "text/html"
        req.write("Hello World!")
 
        db = MySQLdb.connect('localhost', 'root', 'tux5098nyu',
db='imagehost')
        c = db.cursor()
        c.execute("select * from users;")
        results = c.fetchall()

        return apache.OK

 
Now, I can't tell if the query is executing. I get NO errors from Mod
Python (debugging is on), but it only displays "Hello world!" in the
browser, as opposed to the results of the query rom my c.fetchall()
statement. I have tried it in the Python interactive shell, and it works
perfectly. I just can't tell why it won't display the query here.
 
I have also tried it in a separate function, as follows:
 

def mysql(req):
 
        db = MySQLdb.connect('localhost', 'root', 'tux5098nyu',
db='imagehost')
        c = db.cursor()
        c.execute("select * from users;")
        results = c.fetchall()
        return results
 
but to no avail.
 
Thanks for your help.
 
 

Robert Geller

robert@worksofmagic.com

 

 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20041029/cfcd8041/attachment-0001.html
From smkeesle at syr.edu  Fri Oct 29 22:54:21 2004
From: smkeesle at syr.edu (Sean Keesler)
Date: Fri Oct 29 22:54:06 2004
Subject: [mod_python] Re: mod_python and mysql
In-Reply-To: <200410292236.i9TMaiZl022581@modpython.org>
References: <200410292236.i9TMaiZl022581@modpython.org>
Message-ID: <4183025D.4010905@syr.edu>

The "results" returned is a list of arrays.  So:

	b = MySQLdb.connect('localhost', 'root', 'tux5098nyu', db='imagehost')
        c = db.cursor()
        c.execute("select * from users;")
        results = c.fetchall()

	for user in results:
	  req.write(str(user[0]) + str(user[1]))
        return apache.OK


From mark at gsoa.net  Fri Oct 29 23:54:44 2004
From: mark at gsoa.net (Mark McClain)
Date: Fri Oct 29 23:55:01 2004
Subject: [mod_python] Authentification/Session Management
In-Reply-To: <B71880C7-29D1-11D9-ABF4-000A95D2D288@apache.org>
References: <4180CC8F.40907@open.ac.uk> <41811DBF.5080206@joreybump.com>
	<41819225.80503@joreybump.com> <41823F95.2020309@open.ac.uk>
	<41826C07.2070207@joreybump.com>
	<B71880C7-29D1-11D9-ABF4-000A95D2D288@apache.org>
Message-ID: <6F2CA859-2A27-11D9-9609-000A95B33D28@gsoa.net>

The session code is native to mod_python.  I emailed a patch a while 
ago to address this very issue, but I did not get any feedback.  I've 
included it here if anyone is interested.  Basically, it changes last 
accessed from the current time to the time that the session was last 
saved.  For our production boxes this has worked quite well and 
produces predictable behavior.  If anyone has any feedback or 
improvements, let me know.

mark


-------------- next part --------------
A non-text attachment was scrubbed...
Name: Session.py.patch
Type: application/octet-stream
Size: 1068 bytes
Desc: not available
Url : http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20041029/4dd0697e/Session.py.obj
-------------- next part --------------



On Oct 29, 2004, at 1:41 PM, Scott Sanders wrote:

>
> On Oct 29, 2004, at 9:12 AM, Jorey Bump wrote:
>
>> I got all of my info here:
>>
>>   
>> http://www.modpython.org/live/current/doc-html/pyapi-sess- 
>> classes.html
>>
>> but it's a bit terse. Does anyone have an URL for the underlying  
>> apache session documentation? I can't find it, and the mod_usertrack  
>> page is pretty lean.
>
> I could be wrong, but I believe that the session code is specific to  
> mod_python, and does not use anything from apache.  It just relies on  
> a cookie.  So, there is no underlying apache session to be documented.
>
> Scott
>
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python
>
From trevor at thennion.demon.co.uk  Sat Oct 30 05:22:17 2004
From: trevor at thennion.demon.co.uk (Trevor Hennion)
Date: Sat Oct 30 05:22:42 2004
Subject: [mod_python] mod_python and mysql
In-Reply-To: <003201c4be07$80061fb0$1e02a8c0@leet>
References: <003201c4be07$80061fb0$1e02a8c0@leet>
Message-ID: <200410301022.28876.trevor@thennion.demon.co.uk>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On Friday 29 Oct 2004 23:34, Robert Geller wrote:
> Hello all --
>
> I am having trouble with mod_python 3.1.3 and MySQLdb 1.1.6 (recommended
> by the Andy, the author of MySQL-db).
> I'm just trying to get this to work, and have a test page setup, with a
> mysql query and fetchall statement as follows:
>
>
> from mod_python import apache
> import MySQLdb
>
> def handler(req):
>         req.content_type = "text/html"
>         req.write("Hello World!")
>
>         db = MySQLdb.connect('localhost', 'root', 'tux5098nyu',
> db='imagehost')
>         c = db.cursor()
>         c.execute("select * from users;")
>         results = c.fetchall()
>
>         return apache.OK
>
>
> Now, I can't tell if the query is executing. I get NO errors from Mod
> Python (debugging is on), but it only displays "Hello world!" in the
> browser, as opposed to the results of the query rom my c.fetchall()
> statement. I have tried it in the Python interactive shell, and it works
> perfectly. I just can't tell why it won't display the query here.
>
> I have also tried it in a separate function, as follows:
>
>
> def mysql(req):
>
>         db = MySQLdb.connect('localhost', 'root', 'tux5098nyu',
> db='imagehost')
>         c = db.cursor()
>         c.execute("select * from users;")
>         results = c.fetchall()
>         return results
>
> but to no avail.
>
> Thanks for your help.
>
>
>
> Robert Geller
>
> robert@worksofmagic.com

Robert,

I'm not an expert at mod_python - in fact I find it quite confusing! but
looks to me like you have the data in 'results', but you aren't doing anything 
with it - at least not in the code you have posted.
Try:
req.write(results)?   or even 
print "Results are:", results

HTH

Regards

Trevor Hennion
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.2 (GNU/Linux)

iD8DBQFBg11SH6bp7SfUeAARApCqAJwMmCHCk6pdvLSVVwVtqSSjlHEe2ACdGeqR
yFxOy3C7CC3+o/vgkGlzJsc=
=Dw2t
-----END PGP SIGNATURE-----

From robert at worksofmagic.com  Sat Oct 30 18:50:21 2004
From: robert at worksofmagic.com (Robert Geller)
Date: Sat Oct 30 18:50:32 2004
Subject: [mod_python] MarshalCookie vs. SignedCookie
Message-ID: <002401c4bed2$d8751d60$1e02a8c0@leet>

Hello all --
 
Could somebody please explain the difference between a SignedCookie and
a MarshalledCookie and the benefits of each? I don't really understand
the explanation in the documentation, as both of them are signed using
HMAC. It seems like you can put a value in for MarshalCookie and that
will be encoded as well, whereas with SignedCookie it won't. Is this the
only difference? 
 

Robert Geller

robert@worksofmagic.com

 

 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20041030/688517f7/attachment.html
From grisha at modpython.org  Sat Oct 30 19:53:11 2004
From: grisha at modpython.org (Gregory (Grisha) Trubetskoy)
Date: Sat Oct 30 19:53:26 2004
Subject: [mod_python] MarshalCookie vs. SignedCookie
In-Reply-To: <002401c4bed2$d8751d60$1e02a8c0@leet>
References: <002401c4bed2$d8751d60$1e02a8c0@leet>
Message-ID: <20041030195012.C19139@onyx.ispol.com>


A SignedCooke signs the cookie with a cryptographic signature using HMAC, 
which makes it impossible for the client to change the value of it without 
it being evident.

A MarshalCookie marshals the value of the cookie, which allows cookies to 
be not just strings, but more complex Python objects, such as lists and 
dictionaries.

HTH,

Grisha

On Sat, 30 Oct 2004, Robert Geller wrote:

> Hello all --
>
> Could somebody please explain the difference between a SignedCookie and
> a MarshalledCookie and the benefits of each? I don't really understand
> the explanation in the documentation, as both of them are signed using
> HMAC. It seems like you can put a value in for MarshalCookie and that
> will be encoded as well, whereas with SignedCookie it won't. Is this the
> only difference?
>
>
> Robert Geller
>
> robert@worksofmagic.com
>
>
>
>
>
From rune.hansen at scanmine.com  Sun Oct 31 10:47:04 2004
From: rune.hansen at scanmine.com (Rune Hansen)
Date: Sun Oct 31 10:47:10 2004
Subject: [mod_python] More on sessions
Message-ID: <1D0111F2-2B54-11D9-8F43-000A956CC60E@scanmine.com>

Hi, I've been following a discussion on sessions on this list. To day I 
had use for sessions my self.

The example provided by Amir Salihenfendic 
(http://www.modpython.org/pipermail/mod_python/2004-August/016057.html) 
works perfectly on my OS X pb... so naturally I didn't expect to get 
into trouble deploying it on Fedora Core 1, apache 2.0.50, python 
2.3.4(ucs4) and mod_python 3.1.3, but no such luck.

It seems to me that new_session.save() fails. The server returns 404 - 
no information is written to any log.

- /tmp is writable for all
- mod_python in general works as expected

I really don't know what to do other than scrap the system and rebuild 
it.

Any suggestions?

regards

/rune

"So as far as I'm concerned, SOAP is not XML, nor is it useful to even a
fraction of the degree to which it is destructive."
- Uche Ogbuji

From jubafre at atlas.ucpel.tche.br  Sun Oct 31 11:17:22 2004
From: jubafre at atlas.ucpel.tche.br (Juliano Freitas)
Date: Sun Oct 31 12:15:17 2004
Subject: [mod_python] textarea form size problem
Message-ID: <1099239441.2669.5.camel@swdb>

Hello!
i'm having problems with the size of textarea. i have to copy a xml
file  to the textarea, but i can't get the entire value using cgi
module. Why?

<TEXTAREA name="sign_swml" rows=10 wrap="off" cols=42></TEXTAREA>

import cgi
form =cgi.FieldStorage()
a = form.getvalue('sign_swml')

there are a limit size to get the value of textarea?

Juliano Freitas

From jubafre at atlas.ucpel.tche.br  Sun Oct 31 11:44:39 2004
From: jubafre at atlas.ucpel.tche.br (Juliano Freitas)
Date: Sun Oct 31 12:42:30 2004
Subject: [mod_python] textarea form size problem
In-Reply-To: <1099239441.2669.5.camel@swdb>
References: <1099239441.2669.5.camel@swdb>
Message-ID: <1099241079.2759.3.camel@swdb>

i'm sorry for this question, its a simple GET POST method problem!!!
hehe :) but i have another question why textarea dont get 'tags' for
example <dasdas>

Juliano Freitas

Em Dom, 2004-10-31 ?s 13:17, Juliano Freitas escreveu:
> Hello!
> i'm having problems with the size of textarea. i have to copy a xml
> file  to the textarea, but i can't get the entire value using cgi
> module. Why?
> 
> <TEXTAREA name="sign_swml" rows=10 wrap="off" cols=42></TEXTAREA>
> 
> import cgi
> form =cgi.FieldStorage()
> a = form.getvalue('sign_swml')
> 
> there are a limit size to get the value of textarea?
> 
> Juliano Freitas
> 
> _______________________________________________
> Mod_python mailing list
> Mod_python@modpython.org
> http://mailman.modpython.org/mailman/listinfo/mod_python

