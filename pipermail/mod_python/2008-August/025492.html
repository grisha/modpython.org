<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] intermittent bug with MySQLdb
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20intermittent%20bug%20with%20MySQLdb&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="025511.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] intermittent bug with MySQLdb</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Alec Matusis</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20intermittent%20bug%20with%20MySQLdb&In-Reply-To="
       TITLE="[mod_python] intermittent bug with MySQLdb">matusis at yahoo.com
       </A><BR>
    <I>Fri Aug  1 22:47:25 EDT 2008</I>
    <P><UL>
        
        <LI>Next message: <A HREF="025511.html">[mod_python] intermittent bug with MySQLdb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25492">[ date ]</a>
              <a href="thread.html#25492">[ thread ]</a>
              <a href="subject.html#25492">[ subject ]</a>
              <a href="author.html#25492">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I was stress- testing MySQL replication on my development setup and run into
a particularly nasty case of a hard-to-reproduced bug that I have
encountered earlier.

 

Under high concurrency, I sometimes get

 

build/bdist.linux-i686/egg/MySQLdb/connections.py:

OperationalError: (2003, &quot;Can't connect to MySQL server on ''10.18.0.2 (4)&quot;)

 

 

Here (4) stangs for:

 

#perror 4

OS error code   4:  Interrupted system call

 

I am using apache 2.2.6 with worker MPM , python 2.4.4 and mod_python 3.3.1.

 

10.18.0.2 is a remote DB test server.

I upgraded MySQLdb adapter from 1.2.0 to 1.2.2 and got the same error with
both versions. The adapters are compiled with 

mysqlclient_r , which is supposed to be thread-safe.

 

Then, I pointed MySQL connections to  localhost, which runs an identical
copy of the same database.

 

To get errors on localhost, I had to increase the request rate by about 10x
(no errors at all otherwise), and I got  

OperationalError: (2003, &quot;Can't connect to MySQL server on '127.0.0.1' (4)&quot;)

127.0.0.1 is my development machine, and I have never seen these errors
before, until I ran this stress test today, bringing the machine to load
average 8.0. 

 

127.0.0.1 and 10.18.0.2 are two different machines, with different kernels
and even different MySQL versions, so it is the  client machine that is a
problem.

 

I have written a single-threaded stand-alone python loop, that simply
connects to the DB on the remote server 10.18.0.2 and executes &quot;SELECT 1&quot;. I
have run several of these loops concurrently each doing about 10000
iterations, and they never gave a connection error.

 

MySQLdb README says:

        MySQLdb is an interface to the popular MySQL_ database server for

        Python.  The design goals are

        - Thread-safety

        - Thread-friendliness (threads will not block each other)

 

So my guess is that this is a thread-safety problem having to do with
mod_python.

 

I now recall that I have seen the problem earlier: 

I have several identically configured production  web servers connected to a
single DB server. I have seen these errors infrequently on 32bit webservers,
but extremely rarely or almost never on 64bit webservers.   I since phased
out 32bit web servers to serve static files only, so I do not have this data
anymore.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080801/0ce4a905/attachment.html">http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20080801/0ce4a905/attachment.html</A>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="025511.html">[mod_python] intermittent bug with MySQLdb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25492">[ date ]</a>
              <a href="thread.html#25492">[ thread ]</a>
              <a href="subject.html#25492">[ subject ]</a>
              <a href="author.html#25492">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
