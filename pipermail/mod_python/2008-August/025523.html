<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] ValueError: Failed to acquire global mutex lock
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20ValueError%3A%20Failed%20to%20acquire%20global%20mutex%20lock&In-Reply-To=C4BF2B03.3237%25david.cardozo%40apioutsourcing.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025521.html">
   <LINK REL="Next"  HREF="025527.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] ValueError: Failed to acquire global mutex lock</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20ValueError%3A%20Failed%20to%20acquire%20global%20mutex%20lock&In-Reply-To=C4BF2B03.3237%25david.cardozo%40apioutsourcing.com"
       TITLE="[mod_python] ValueError: Failed to acquire global mutex lock">graham.dumpleton at gmail.com
       </A><BR>
    <I>Wed Aug  6 19:23:08 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025521.html">[mod_python] ValueError: Failed to acquire global mutex lock
</A></li>
        <LI>Next message: <A HREF="025527.html">[mod_python] ValueError: Failed to acquire global mutex lock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25523">[ date ]</a>
              <a href="thread.html#25523">[ thread ]</a>
              <a href="subject.html#25523">[ subject ]</a>
              <a href="author.html#25523">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>2008/8/7 David Cardozo &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">david.cardozo at apioutsourcing.com</A>&gt;:
&gt;<i> I apologize by resurrecting this email thread, but I thought I would post
</I>&gt;<i> the &quot;what worked for me&quot; solution in case someone else ever come across it.
</I>&gt;<i>
</I>&gt;<i> For a quick history: when Mike Robokoff worked on this issue back in October
</I>&gt;<i> (we both worked together at the same company), we were able to work around
</I>&gt;<i> it by making changes to our python scripts to minimize the time spent
</I>&gt;<i> holding a lock to the Session.dbm file. This seemed to work fine for a
</I>&gt;<i> while. However, as our user load level increased, this problem started
</I>&gt;<i> manifesting itself again. I dedicated myself to this issue during this past
</I>&gt;<i> week and finally was able to narrow it down to the fix that solve it...
</I>&gt;<i> Hopefully once and for all.
</I>&gt;<i>
</I>&gt;<i> Here is my analysis of this issue; please correct me if you think something
</I>&gt;<i> doesn't sound right:
</I>&gt;<i>
</I>&gt;<i> The root cause of this problem was the use of a bad mutex implementation by
</I>&gt;<i> mod_python in Solaris.
</I>
No. The mod_python package just uses what APR has selected as the
default. If there is a problem with fcntl on Solaris then you need to
be asking the APR folks why they are defaulting to using that over
something that works properly. So, not strictly a mod_python problem
and the fact that you also had to set SSLMutex and AcceptMutex
reinforces that.

Note that --enable-nonportable-atomics wouldn't make a difference as
that likely only applies to in process replacement for certain uses of
local thread mutex. A global mutex is a lock that works across
processes and so no machine code level thing could in itself work as
far as I can see.

As far as mod_python goes, only change I can see you might benefit from is:

  <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-202">http://issues.apache.org/jira/browse/MODPYTHON-202</A>

That is, mod_python providing a directive akin to AcceptMutex to
override what type of mutex it uses. That way you wouldn't have to
change the code, but could configure it instead.

BTW, you don't have your Apache installation, including directory
where locks are, being served off an NFS partition do you. File based
locking used to at least have some issues with NFS. This was some time
back though in Solaris and presume they would have addressed it by
now.

Graham

&gt;<i> Mod_python relies on operating system mutexes to lock file system resources;
</I>&gt;<i> these mutexes are provided by the APR library (Apache Portable Runtime) by
</I>&gt;<i> invocation of the following method from mod_python.c:
</I>&gt;<i>
</I>&gt;<i>  apr_global_mutex_create(&amp;mutex[n], fname, APR_LOCK_DEFAULT, p);
</I>&gt;<i>
</I>&gt;<i> The above call defaults to use the operating system default mutex
</I>&gt;<i> implementation (fcntl) which, in my opinion, does not work properly in an
</I>&gt;<i> Apache worker MPM model under any type of load.
</I>&gt;<i>
</I>&gt;<i> by modifying the above call to:
</I>&gt;<i>
</I>&gt;<i> apr_global_mutex_create(&amp;mutex[n], fname,  APR_LOCK_POSIXSEM, p);
</I>&gt;<i>
</I>&gt;<i> which forces the use of the POSIX semaphores implementation of mutexes by
</I>&gt;<i> mod_python, the problem was minimized to a just a few instances of the
</I>&gt;<i> &quot;mutex&quot; error under a moderate load: 400 concurrent threads.
</I>&gt;<i>
</I>&gt;<i> The final change to make the problem go away completely was to modify the
</I>&gt;<i> AcceptMutex and SSLMutex properties in the httpd.conf file to &quot;posixsem&quot;.
</I>&gt;<i> This, together with the mod_python changed, made the &quot;mutex&quot; error go away
</I>&gt;<i> even for 6400 concurrent threads.
</I>&gt;<i>
</I>&gt;<i> I still ignore why the changes to AcceptMutex and SSLMutex are required
</I>&gt;<i> since our Apache installs were compiled with the
</I>&gt;<i> &quot;--enable-nonportable-atomics&quot; which, according to the Apache documentation
</I>&gt;<i> ( <A HREF="http://httpd.apache.org/docs/2.2/misc/perf-tuning.html#compiletime">http://httpd.apache.org/docs/2.2/misc/perf-tuning.html#compiletime</A>):
</I>&gt;<i>
</I>&gt;<i> &quot;Solaris on SPARC
</I>&gt;<i> By default, APR uses mutex-based atomics on Solaris/SPARC. If you configure
</I>&gt;<i> with --enable-nonportable-atomics, however, APR generates code that uses a
</I>&gt;<i> SPARC v8plus opcode for fast hardware compare-and-swap. If you configure
</I>&gt;<i> Apache with this option, the atomic operations will be more efficient
</I>&gt;<i> (allowing for lower CPU utilization and higher concurrency), but the
</I>&gt;<i> resulting executable will run only on UltraSPARC chips. &quot;
</I>&gt;<i>
</I>&gt;<i> Maybe, even though we compile with that option, something in the OS, Apache
</I>&gt;<i> or APR, still doesn't allow us to take advantage of atomic operations. This
</I>&gt;<i> is pure speculation.
</I>&gt;<i>
</I>&gt;<i> This is the email thread that pointed me to the right direction:
</I>&gt;<i> <A HREF="http://www.modpython.org/pipermail/mod_python/2006-November/022538.html">http://www.modpython.org/pipermail/mod_python/2006-November/022538.html</A>
</I>&gt;<i> I'm not using the ITK MPM, just straight worker MPM, but that change made
</I>&gt;<i> the trick for me.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> David.
</I>&gt;<i>
</I>&gt;<i> -------------- Last message in email thread ---------------------------
</I>&gt;<i>
</I>&gt;<i> [mod_python] ValueError: Failed to acquire global mutex lock
</I>&gt;<i> Graham Dumpleton graham.dumpleton at gmail.com
</I>&gt;<i> Wed Oct 24 23:04:05 EDT 2007
</I>&gt;<i>
</I>&gt;<i>     * Previous message: [mod_python] Problems with Apache
</I>&gt;<i>     * Next message: [mod_python] Multiple Django Applications
</I>&gt;<i>     * Messages sorted by: [ date ] [ thread ] [ subject ] [ author ]
</I>&gt;<i>
</I>&gt;<i> Going by errors posted by someone else for other thread, seems that if
</I>&gt;<i> semaphores exhausted, error would occur at mod_python startup not when
</I>&gt;<i> locking the mutex.
</I>&gt;<i>
</I>&gt;<i> I'll have to go back and read all your emails again. You said you were
</I>&gt;<i> using 'worker' MPM now didn't you. Your not using some strange MPM
</I>&gt;<i> like perchild or ITK-MPM are you. I know that these cause problems for
</I>&gt;<i> these mutexes in mod_python because of how different processes wanting
</I>&gt;<i> to lock the mutex run as different users.
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> On 24/10/2007, Michael Robokoff &lt;mike.robokoff at apioutsourcing.com&gt; wrote:
</I>&gt;&gt;<i> # ipcs
</I>&gt;&gt;<i> IPC status from &lt;running system&gt; as of Wed Oct 24 06:25:17 CDT 2007
</I>&gt;&gt;<i> T         ID      KEY        MODE        OWNER    GROUP
</I>&gt;&gt;<i> Message Queues:
</I>&gt;&gt;<i> Shared Memory:
</I>&gt;&gt;<i> Semaphores:
</I>&gt;&gt;<i> s          2   0          --ra-------      api    other
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Not sure how to read that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If the problem is the semaphores, Shouldn't I be able to use the following
</I>&gt;&gt;<i> set semsys:seminfo_semmni=2048
</I>&gt;&gt;<i> set semsys:seminfo_semmns=2048
</I>&gt;&gt;<i> set semsys:seminfo_semmnu=1024
</I>&gt;&gt;<i> set semsys:seminfo_semmsl=300
</I>&gt;&gt;<i> set semsys:seminfo_semopm=128
</I>&gt;&gt;<i> set semsys:seminfo_semume=64
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> to make more semaphores available?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried that but it didn't change anything, do you think that was not
</I>&gt;&gt;<i> enough?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --Mike
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Graham Dumpleton [mailto:graham.dumpleton at gmail.com]
</I>&gt;&gt;<i> Sent: Tuesday, October 23, 2007 7:08 PM
</I>&gt;&gt;<i> To: Michael Robokoff
</I>&gt;&gt;<i> Cc: mod_python
</I>&gt;&gt;<i> Subject: Re: [mod_python] ValueError: Failed to acquire global mutex lock
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you run 'ipcs' what is the output? Something must be using all the
</I>&gt;&gt;<i> semaphores, can't be anything else.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Graham
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 24/10/2007, Michael Robokoff &lt;mike.robokoff at apioutsourcing.com&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt; Ok the directive did take effect as the log entry below shows:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; [Tue Oct 23 07:20:32 2007] [notice] mod_python: Creating 4 session
</I>&gt;&gt;<i> &gt; mutexes
</I>&gt;&gt;<i> &gt; based on 6 max processes and 25 max threads.
</I>&gt;&gt;<i> &gt; [Tue Oct 23 07:20:32 2007] [notice] mod_python: using mutex_directory
</I>&gt;&gt;<i> &gt; /tmp
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Still see this however:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ValueError: Failed to acquire global mutex lock
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I will try recompiling with the option you mentioned and see what
</I>&gt;&gt;<i> &gt; happens.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; --Mike
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; -----Original Message-----
</I>&gt;&gt;<i> &gt; From: Graham Dumpleton [mailto:graham.dumpleton at gmail.com]
</I>&gt;&gt;<i> &gt; Sent: Tuesday, October 23, 2007 6:40 AM
</I>&gt;&gt;<i> &gt; To: Michael Robokoff
</I>&gt;&gt;<i> &gt; Cc: mod_python
</I>&gt;&gt;<i> &gt; Subject: Re: [mod_python] ValueError: Failed to acquire global mutex
</I>&gt;&gt;<i> &gt; lock
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; On 23/10/2007, Michael Robokoff &lt;mike.robokoff at apioutsourcing.com&gt;
</I>&gt;&gt;<i> &gt; wrote:
</I>&gt;&gt;<i> &gt; &gt; [Thu Oct 18 07:37:38 2007] [notice] mod_python: Creating 8 session
</I>&gt;&gt;<i> mutexes
</I>&gt;&gt;<i> &gt; &gt; based on 6 max processes and 25 max threads.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; BTW, what did you end up setting mod_python.mutex_locks to? If you use
</I>&gt;&gt;<i> &gt; 4 like I said, then it can't have been in correct part of Apache
</I>&gt;&gt;<i> &gt; configuration, outside of all VirtualHost, as error log still shows '8
</I>&gt;&gt;<i> &gt; session mutexes'.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; if you can't get this to work, you might rebuild mod_python and
</I>&gt;&gt;<i> &gt; specific --with-max-locks=4 option to configure to force lower value
</I>&gt;&gt;<i> &gt; to be compiled in.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Graham
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025521.html">[mod_python] ValueError: Failed to acquire global mutex lock
</A></li>
	<LI>Next message: <A HREF="025527.html">[mod_python] ValueError: Failed to acquire global mutex lock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25523">[ date ]</a>
              <a href="thread.html#25523">[ thread ]</a>
              <a href="subject.html#25523">[ subject ]</a>
              <a href="author.html#25523">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
