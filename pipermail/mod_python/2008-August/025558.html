<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Mod_Python not releasing memory?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mod_Python%20not%20releasing%20memory%3F&In-Reply-To=200808191356.m7JDu1eW012229%40modpython.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025557.html">
   <LINK REL="Next"  HREF="025559.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Mod_Python not releasing memory?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Martijn Moeling</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mod_Python%20not%20releasing%20memory%3F&In-Reply-To=200808191356.m7JDu1eW012229%40modpython.org"
       TITLE="[mod_python] Mod_Python not releasing memory?">martijn at xs4us.nu
       </A><BR>
    <I>Tue Aug 19 13:09:50 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025557.html">[mod_python] Mod_Python not releasing memory?
</A></li>
        <LI>Next message: <A HREF="025559.html">[mod_python] Mod_Python not releasing memory?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25558">[ date ]</a>
              <a href="thread.html#25558">[ thread ]</a>
              <a href="subject.html#25558">[ subject ]</a>
              <a href="author.html#25558">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hmm i had similar trouble with mysql. Turned out to be the connection  
to mysql must not be made global. My fix was to open it in my handler  
and to close it in the fixup by using req.register_cleanup

The connection to the db should be made within the req object: req.db  
= (make connection to your db) and like so with a cursor.

Also think 'stream'

Do not cursor.fetchall but fetchone, write the output after each fetch

If you load with fetchall and build the entire page, the data is I'm  
memory twice!! With streaming only one record is in apache process,  
you can handle way more request in the same memory and it greatly  
improves user experiance.

Hope it helps,
Martijn



Op 19 aug 2008 om 16:06 heeft &quot;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Scott.Chapman at VerizonWireless.com</A>&quot; &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Scott.Chapman at VerizonWireless.com</A> 
 &gt; het volgende geschreven:\

&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Graham Dumpleton [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>]
</I>&gt;&gt;<i> Sent: Monday, August 18, 2008 9:30 PM
</I>&gt;&gt;<i> To: Chapman, Scott Earl
</I>&gt;&gt;<i> Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;&gt;<i> Subject: Re: [mod_python] Mod_Python not releasing memory?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2008/8/19  &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Scott.Chapman at verizonwireless.com</A>&gt;:
</I>&gt;&gt;&gt;<i> I have Apache/2.2.8 (Unix) mod_python/3.3.1 Python/2.4.5 on Red Hat
</I>&gt;&gt;&gt;<i> Enterprise Linux AS release 4 (Nahant Update 6).
</I>&gt;&gt;&gt;<i> Apache compiled:
</I>&gt;&gt;&gt;<i> ./configure --with-mpm=prefork --enable-mods-shared=&quot;most proxy
</I>&gt;&gt;&gt;<i> charset_lite&quot; --with-expat=system
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Mod Python:
</I>&gt;&gt;&gt;<i> ./configure --with-apxs=/usr/local/apache2/bin/apxs
</I>&gt;&gt;&gt;<i> --with-python=/usr/local/bin/python2.4
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Python:
</I>&gt;&gt;&gt;<i> ./configure --enable-shared
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My application is using Cheetah to generate a very large
</I>&gt;&gt;<i> HTML table and
</I>&gt;&gt;&gt;<i> sending it back to the client, after retrieving a bunch of
</I>&gt;&gt;<i> database rows.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> One hit to Apache to generate one of these big tables runs
</I>&gt;&gt;<i> memory usage up
</I>&gt;&gt;&gt;<i> to 30.6% of system RAM:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> $ ps aux | grep 30316 | grep -v grep
</I>&gt;&gt;&gt;<i> USER       PID %CPU %MEM   VSZ  RSS TTY      STAT START
</I>&gt;&gt;<i> TIME COMMAND
</I>&gt;&gt;&gt;<i> web      30316  2.7 27.7 1559948 1122772 ?   Rl   12:48   1:21
</I>&gt;&gt;&gt;<i> /usr/local/apache2/bin/httpd -k start
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> $ ps aux | grep 30316 | grep -v grep
</I>&gt;&gt;&gt;<i> USER       PID %CPU %MEM   VSZ  RSS TTY      STAT START
</I>&gt;&gt;<i> TIME COMMAND
</I>&gt;&gt;&gt;<i> web      30316  2.7 30.6 1559948 1237948 ?   Rl   12:48   1:21
</I>&gt;&gt;&gt;<i> /usr/local/apache2/bin/httpd -k start
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> After the query is done and the results delivered to the
</I>&gt;&gt;<i> browser, the Apache
</I>&gt;&gt;&gt;<i> process is still holding about 25% of system memory.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I don't see any way to free that memory.
</I>&gt;&gt;&gt;<i> Once I &quot;return result&quot; to the browser, I can't do
</I>&gt;&gt;<i> &quot;result=None&quot; so I'm
</I>&gt;&gt;&gt;<i> relying on Python to release the memory and it is taking
</I>&gt;&gt;<i> way too long for
</I>&gt;&gt;&gt;<i> that to happen.  I do set the database result set to None
</I>&gt;&gt;<i> as soon as I can
</I>&gt;&gt;&gt;<i> and that helps some.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If I get a number of these big hits, OOM starts killing
</I>&gt;&gt;<i> PIDs which is a &quot;Bad
</I>&gt;&gt;&gt;<i> Thing&quot;.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Any clues on how to make that memory release sooner?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is normal behaviour. You need to do some reading/research on how
</I>&gt;&gt;<i> memory is used in operating systems.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In short though, in general once a process needs to allocate memory
</I>&gt;&gt;<i> from the operating system it is then marked as being in use by that
</I>&gt;&gt;<i> process for the life of the process, even if the individual memory
</I>&gt;&gt;<i> fragments are freed by code. Such freed memory can be reused within
</I>&gt;&gt;<i> the same process, but isn't released back to operating system for
</I>&gt;&gt;<i> other processes to use.
</I>&gt;<i>
</I>&gt;<i> If that were true, how would a processes memory usage ever spike and  
</I>&gt;<i> then go back down? I have seen this behavior plenty of times.
</I>&gt;<i>
</I>&gt;<i> Scott
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The information contained in this message and any attachment may be
</I>&gt;<i> proprietary, confidential, and privileged or subject to the work
</I>&gt;<i> product doctrine and thus protected from disclosure.  If the reader
</I>&gt;<i> of this message is not the intended recipient, or an employee or
</I>&gt;<i> agent responsible for delivering this message to the intended
</I>&gt;<i> recipient, you are hereby notified that any dissemination,
</I>&gt;<i> distribution or copying of this communication is strictly prohibited.
</I>&gt;<i> If you have received this communication in error, please notify me
</I>&gt;<i> immediately by replying to this message and deleting it and all
</I>&gt;<i> copies and backups thereof.  Thank you.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025557.html">[mod_python] Mod_Python not releasing memory?
</A></li>
	<LI>Next message: <A HREF="025559.html">[mod_python] Mod_Python not releasing memory?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25558">[ date ]</a>
              <a href="thread.html#25558">[ thread ]</a>
              <a href="subject.html#25558">[ subject ]</a>
              <a href="author.html#25558">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
