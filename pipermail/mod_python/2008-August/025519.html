<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] intermittent bug with MySQLdb
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20intermittent%20bug%20with%20MySQLdb&In-Reply-To=c70f1ac50808051810k19f4636byf5f503a14e50d4e5%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025514.html">
   <LINK REL="Next"  HREF="025520.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] intermittent bug with MySQLdb</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Alec Matusis</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20intermittent%20bug%20with%20MySQLdb&In-Reply-To=c70f1ac50808051810k19f4636byf5f503a14e50d4e5%40mail.gmail.com"
       TITLE="[mod_python] intermittent bug with MySQLdb">matusis at yahoo.com
       </A><BR>
    <I>Wed Aug  6 01:43:57 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025514.html">[mod_python] importing a configuration module
</A></li>
        <LI>Next message: <A HREF="025520.html">[mod_python] PyODBC makes me crazy... Is mxODBC working good?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25519">[ date ]</a>
              <a href="thread.html#25519">[ thread ]</a>
              <a href="subject.html#25519">[ subject ]</a>
              <a href="author.html#25519">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sending it back to the list:

I cannot get the errors with MaxRequestsPerChild 1 or MaxRequestsPerChild
20000 when I use prefork.
Have you tried prefork?

From: Buck Golemon [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">workitharder at gmail.com</A>] 
Sent: Tuesday, August 05, 2008 6:11 PM
To: Alec Matusis
Subject: Re: [mod_python] intermittent bug with MySQLdb

That's a pretty big &quot;or&quot;. I was convinced it was MySQL networking until you
posted this. Do you still have your +20000 setting above in effect?


On 8/5/08, Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at yahoo.com</A>&gt; wrote:
I am now convinced that this is either a mod_python or MySQLdb threading
bug.
I recompiled apache with prefork instead of worker, and these MySQLdb errors
disappeared.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alec Matusis [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at yahoo.com</A>]
</I>
&gt;<i> Sent: Tuesday, August 05, 2008 1:56 AM
</I>&gt;<i> To: 'Alec Matusis'; 'Buck Golemon'
</I>&gt;<i> Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;<i> Subject: RE: [mod_python] intermittent bug with MySQLdb
</I>&gt;<i>
</I>&gt;<i> PS.
</I>&gt;<i>
</I>&gt;<i> Found Another way to get rid of the error:
</I>&gt;<i>
</I>&gt;<i> I had
</I>&gt;<i> MaxRequestsPerChild 1
</I>&gt;<i> since this is my dev server and I wanted to be able to edit mod_python
</I>&gt;<i> scripts without restarting apache.
</I>&gt;<i> Increasing it to 10 does not fix it.
</I>&gt;<i> Increasing to 100 makes it very rare.
</I>&gt;<i> Increasing it to 20000 apparently fixes the problem (maybe I did not
</I>&gt;<i> wait
</I>&gt;<i> long enough)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Perhaps what happens is that while the child is waiting on the MySQL
</I>&gt;<i> connection, it gets EINTR event from the parent that is ready to die,
</I>&gt;<i> because more requests came in, and so it dies before the child's MySQL
</I>&gt;<i> connection is complete?
</I>&gt;<i>
</I>&gt;<i> &gt; -----Original Message-----
</I>&gt;<i> &gt; From: Alec Matusis [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at yahoo.com</A>]
</I>&gt;<i> &gt; Sent: Tuesday, August 05, 2008 1:25 AM
</I>&gt;<i> &gt; To: 'Buck Golemon'
</I>&gt;<i> &gt; Cc: '<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>'
</I>&gt;<i> &gt; Subject: RE: [mod_python] intermittent bug with MySQLdb
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; One more interesting piece of evidence: when I connect to the DB on
</I>&gt;<i> the
</I>&gt;<i> &gt; same physical machine were my web scripts are, I can reproduce this
</I>&gt;<i> &gt; only when I connect to 127.0.0.1. When I connect to localhost, I do
</I>&gt;<i> not
</I>&gt;<i> &gt; get the errors at all. This is because
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; <A HREF="http://dev.mysql.com/doc/refman/5.0/en/connecting.html">http://dev.mysql.com/doc/refman/5.0/en/connecting.html</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &quot;For connections to localhost, MySQL programs attempt to connect to
</I>&gt;<i> the
</I>&gt;<i> &gt; local server by using a Unix socket file. This occurs even if a --
</I>&gt;<i> port
</I>&gt;<i> &gt; or -P option is given to specify a port number. To ensure that the
</I>&gt;<i> &gt; client makes a TCP/IP connection to the local server, use --host or -
</I>&gt;<i> h
</I>&gt;<i> &gt; to specify a hostname value of 127.0.0.1&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This last thing makes me think it's a networking problem as you
</I>&gt;<i> &gt; suggest
</I>?
&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; From: Buck Golemon [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">workitharder at gmail.com</A>]
</I>&gt;<i> &gt; Sent: Sunday, August 03, 2008 9:24 PM
</I>&gt;<i> &gt; To: Alec Matusis
</I>&gt;<i> &gt; Subject: Re: [mod_python] intermittent bug with MySQLdb
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Have you considered that this may be just a general problem of
</I>&gt;<i> &gt; networking / MySQL? That's my conclusion. I've gotten similar errors
</I>&gt;<i> in
</I>&gt;<i> &gt; my high-concurrency applications (non mod-python) and to solve the
</I>&gt;<i> &gt; problem, wrote some code to re-try queryies on that error (among
</I>&gt;<i> &gt; others) and wrapped it around all my connections.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As a counter-argument (if you want one), try doing a similar stress
</I>&gt;<i> &gt; test using a completely different client (maybe perl?) and show that
</I>&gt;<i> &gt; the error does not occur under similar or higher loads.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --Buck
</I>&gt;<i> &gt; 2008/8/1 Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at yahoo.com</A>&gt;
</I>&gt;<i> &gt; I was stress- testing MySQL replication on my development setup and
</I>&gt;<i> run
</I>&gt;<i> &gt; into a particularly nasty case of a hard-to-reproduced bug that I
</I>&gt;<i> have
</I>&gt;<i> &gt; encountered earlier.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Under high concurrency, I sometimes get
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; build/bdist.linux-i686/egg/MySQLdb/connections.py:
</I>&gt;<i> &gt; OperationalError: (2003, &quot;Can't connect to MySQL server on
</I>&gt;<i> ''10.18.0.2
</I>&gt;<i> &gt; (4)&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here (4) stangs for:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #perror 4
</I>&gt;<i> &gt; OS error code&#160;&#160; 4:&#160;&#160;Interrupted system call
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am using apache 2.2.6 with worker MPM , python 2.4.4 and mod_python
</I>&gt;<i> &gt; 3.3.1.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 10.18.0.2 is a remote DB test server.
</I>&gt;<i> &gt; I upgraded MySQLdb adapter from 1.2.0 to 1.2.2 and got the same error
</I>&gt;<i> &gt; with both versions. The adapters are compiled with
</I>&gt;<i> &gt; mysqlclient_r , which is supposed to be thread-safe.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Then, I pointed MySQL connections to&#160;&#160;localhost, which runs an
</I>&gt;<i> &gt; identical copy of the same database.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; To get errors on localhost, I had to increase the request rate by
</I>&gt;<i> about
</I>&gt;<i> &gt; 10x (no errors at all otherwise), and I got
</I>&gt;<i> &gt; OperationalError: (2003, &quot;Can't connect to MySQL server on
</I>&gt;<i> '127.0.0.1'
</I>&gt;<i> &gt; (4)&quot;)
</I>&gt;<i> &gt; 127.0.0.1 is my development machine, and I have never seen these
</I>&gt;<i> errors
</I>&gt;<i> &gt; before, until I ran this stress test today, bringing the machine to
</I>&gt;<i> &gt; load average 8.0.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 127.0.0.1 and 10.18.0.2 are two different machines, with different
</I>&gt;<i> &gt; kernels and even different MySQL versions, so it is the&#160;&#160;client
</I>&gt;<i> machine
</I>&gt;<i> &gt; that is a problem.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have written a single-threaded stand-alone python loop, that simply
</I>&gt;<i> &gt; connects to the DB on the remote server 10.18.0.2 and executes
</I>&gt;<i> &quot;SELECT
</I>&gt;<i> &gt; 1&quot;. I have run several of these loops concurrently each doing about
</I>&gt;<i> &gt; 10000 iterations, and they never gave a connection error.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; MySQLdb README says:
</I>&gt;<i> &gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; MySQLdb is an interface to the popular MySQL_ database server
</I>&gt;<i> &gt; for
</I>&gt;<i> &gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Python.&#160;&#160;The design goals are
</I>&gt;<i> &gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - Thread-safety
</I>&gt;<i> &gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - Thread-friendliness (threads will not block each other)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So my guess is that this is a thread-safety problem having to do with
</I>&gt;<i> &gt; mod_python.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I now recall that I have seen the problem earlier:
</I>&gt;<i> &gt; I have several identically configured production&#160;&#160;web servers
</I>&gt;<i> connected
</I>&gt;<i> &gt; to a single DB server. I have seen these errors infrequently on 32bit
</I>&gt;<i> &gt; webservers, but extremely rarely or almost never on 64bit webservers.
</I>&gt;<i> &gt;&#160;&#160; I since phased out 32bit web servers to serve static files only, so
</I>&gt;<i> I
</I>&gt;<i> &gt; do not have this data anymore.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mod_python mailing list
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; Buck Golemon
</I>&gt;<i> &gt; AIM: bukzor
</I>&gt;<i> &gt; Cell: (480) 272-1153
</I>


-- 
Buck Golemon
AIM: bukzor
Cell: (480) 272-1153 


</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025514.html">[mod_python] importing a configuration module
</A></li>
	<LI>Next message: <A HREF="025520.html">[mod_python] PyODBC makes me crazy... Is mxODBC working good?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25519">[ date ]</a>
              <a href="thread.html#25519">[ thread ]</a>
              <a href="subject.html#25519">[ subject ]</a>
              <a href="author.html#25519">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
