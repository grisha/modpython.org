<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] intermittent bug with MySQLdb
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20intermittent%20bug%20with%20MySQLdb&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025492.html">
   <LINK REL="Next"  HREF="025517.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] intermittent bug with MySQLdb</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Alec Matusis</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20intermittent%20bug%20with%20MySQLdb&In-Reply-To="
       TITLE="[mod_python] intermittent bug with MySQLdb">matusis at yahoo.com
       </A><BR>
    <I>Tue Aug  5 04:55:41 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025492.html">[mod_python] intermittent bug with MySQLdb
</A></li>
        <LI>Next message: <A HREF="025517.html">[mod_python] intermittent bug with MySQLdb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25511">[ date ]</a>
              <a href="thread.html#25511">[ thread ]</a>
              <a href="subject.html#25511">[ subject ]</a>
              <a href="author.html#25511">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>PS.  

Found Another way to get rid of the error:

I had 
MaxRequestsPerChild 1 
since this is my dev server and I wanted to be able to edit mod_python
scripts without restarting apache.
Increasing it to 10 does not fix it.
Increasing to 100 makes it very rare.
Increasing it to 20000 apparently fixes the problem (maybe I did not wait
long enough) 


Perhaps what happens is that while the child is waiting on the MySQL
connection, it gets EINTR event from the parent that is ready to die,
because more requests came in, and so it dies before the child&#146;s MySQL
connection is complete?

&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alec Matusis [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at yahoo.com</A>]
</I>&gt;<i> Sent: Tuesday, August 05, 2008 1:25 AM
</I>&gt;<i> To: 'Buck Golemon'
</I>&gt;<i> Cc: '<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>'
</I>&gt;<i> Subject: RE: [mod_python] intermittent bug with MySQLdb
</I>&gt;<i> 
</I>&gt;<i> One more interesting piece of evidence: when I connect to the DB on the
</I>&gt;<i> same physical machine were my web scripts are, I can reproduce this
</I>&gt;<i> only when I connect to 127.0.0.1. When I connect to localhost, I do not
</I>&gt;<i> get the errors at all. This is because
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://dev.mysql.com/doc/refman/5.0/en/connecting.html">http://dev.mysql.com/doc/refman/5.0/en/connecting.html</A>
</I>&gt;<i> 
</I>&gt;<i> &#147;For connections to localhost, MySQL programs attempt to connect to the
</I>&gt;<i> local server by using a Unix socket file. This occurs even if a --port
</I>&gt;<i> or -P option is given to specify a port number. To ensure that the
</I>&gt;<i> client makes a TCP/IP connection to the local server, use --host or -h
</I>&gt;<i> to specify a hostname value of 127.0.0.1&#148;
</I>&gt;<i> 
</I>&gt;<i> This last thing makes me think it&#146;s a networking problem as you
</I>&gt;<i> suggest
</I>?
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> From: Buck Golemon [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">workitharder at gmail.com</A>]
</I>&gt;<i> Sent: Sunday, August 03, 2008 9:24 PM
</I>&gt;<i> To: Alec Matusis
</I>&gt;<i> Subject: Re: [mod_python] intermittent bug with MySQLdb
</I>&gt;<i> 
</I>&gt;<i> Have you considered that this may be just a general problem of
</I>&gt;<i> networking / MySQL? That's my conclusion. I've gotten similar errors in
</I>&gt;<i> my high-concurrency applications (non mod-python) and to solve the
</I>&gt;<i> problem, wrote some code to re-try queryies on that error (among
</I>&gt;<i> others) and wrapped it around all my connections.
</I>&gt;<i> 
</I>&gt;<i> As a counter-argument (if you want one), try doing a similar stress
</I>&gt;<i> test using a completely different client (maybe perl?) and show that
</I>&gt;<i> the error does not occur under similar or higher loads.
</I>&gt;<i> 
</I>&gt;<i> --Buck
</I>&gt;<i> 2008/8/1 Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at yahoo.com</A>&gt;
</I>&gt;<i> I was stress- testing MySQL replication on my development setup and run
</I>&gt;<i> into a particularly nasty case of a hard-to-reproduced bug that I have
</I>&gt;<i> encountered earlier.
</I>&gt;<i> 
</I>&gt;<i> Under high concurrency, I sometimes get
</I>&gt;<i> 
</I>&gt;<i> build/bdist.linux-i686/egg/MySQLdb/connections.py:
</I>&gt;<i> OperationalError: (2003, &quot;Can't connect to MySQL server on ''10.18.0.2
</I>&gt;<i> (4)&quot;)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Here (4) stangs for:
</I>&gt;<i> 
</I>&gt;<i> #perror 4
</I>&gt;<i> OS error code&#160;&#160; 4:&#160; Interrupted system call
</I>&gt;<i> 
</I>&gt;<i> I am using apache 2.2.6 with worker MPM , python 2.4.4 and mod_python
</I>&gt;<i> 3.3.1.
</I>&gt;<i> 
</I>&gt;<i> 10.18.0.2 is a remote DB test server.
</I>&gt;<i> I upgraded MySQLdb adapter from 1.2.0 to 1.2.2 and got the same error
</I>&gt;<i> with both versions. The adapters are compiled with
</I>&gt;<i> mysqlclient_r , which is supposed to be thread-safe.
</I>&gt;<i> 
</I>&gt;<i> Then, I pointed MySQL connections to &#160;localhost, which runs an
</I>&gt;<i> identical copy of the same database.
</I>&gt;<i> 
</I>&gt;<i> To get errors on localhost, I had to increase the request rate by about
</I>&gt;<i> 10x (no errors at all otherwise), and I got
</I>&gt;<i> OperationalError: (2003, &quot;Can't connect to MySQL server on '127.0.0.1'
</I>&gt;<i> (4)&quot;)
</I>&gt;<i> 127.0.0.1 is my development machine, and I have never seen these errors
</I>&gt;<i> before, until I ran this stress test today, bringing the machine to
</I>&gt;<i> load average 8.0.
</I>&gt;<i> 
</I>&gt;<i> 127.0.0.1 and 10.18.0.2 are two different machines, with different
</I>&gt;<i> kernels and even different MySQL versions, so it is the &#160;client machine
</I>&gt;<i> that is a problem.
</I>&gt;<i> 
</I>&gt;<i> I have written a single-threaded stand-alone python loop, that simply
</I>&gt;<i> connects to the DB on the remote server 10.18.0.2 and executes &quot;SELECT
</I>&gt;<i> 1&quot;. I have run several of these loops concurrently each doing about
</I>&gt;<i> 10000 iterations, and they never gave a connection error.
</I>&gt;<i> 
</I>&gt;<i> MySQLdb README says:
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; MySQLdb is an interface to the popular MySQL_ database server
</I>&gt;<i> for
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; Python.&#160; The design goals are
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; - Thread-safety
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; - Thread-friendliness (threads will not block each other)
</I>&gt;<i> 
</I>&gt;<i> So my guess is that this is a thread-safety problem having to do with
</I>&gt;<i> mod_python.
</I>&gt;<i> 
</I>&gt;<i> I now recall that I have seen the problem earlier:
</I>&gt;<i> I have several identically configured production &#160;web servers connected
</I>&gt;<i> to a single DB server. I have seen these errors infrequently on 32bit
</I>&gt;<i> webservers, but extremely rarely or almost never on 64bit webservers.
</I>&gt;<i> &#160;&#160;I since phased out 32bit web servers to serve static files only, so I
</I>&gt;<i> do not have this data anymore.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Buck Golemon
</I>&gt;<i> AIM: bukzor
</I>&gt;<i> Cell: (480) 272-1153
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025492.html">[mod_python] intermittent bug with MySQLdb
</A></li>
	<LI>Next message: <A HREF="025517.html">[mod_python] intermittent bug with MySQLdb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25511">[ date ]</a>
              <a href="thread.html#25511">[ thread ]</a>
              <a href="subject.html#25511">[ subject ]</a>
              <a href="author.html#25511">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
