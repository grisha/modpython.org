<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Problem with html quoted/unquoted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problem%20with%20html%20quoted/unquoted&In-Reply-To=1147837098.17770.175.camel%40pistachio.squirrel">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021126.html">
   <LINK REL="Next"  HREF="021138.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Problem with html quoted/unquoted</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Deron Meranda</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problem%20with%20html%20quoted/unquoted&In-Reply-To=1147837098.17770.175.camel%40pistachio.squirrel"
       TITLE="[mod_python] Problem with html quoted/unquoted">deron.meranda at gmail.com
       </A><BR>
    <I>Wed May 17 11:02:03 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021126.html">[mod_python] Problem with html quoted/unquoted
</A></li>
        <LI>Next message: <A HREF="021138.html">[mod_python] Problem with html quoted/unquoted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21136">[ date ]</a>
              <a href="thread.html#21136">[ thread ]</a>
              <a href="subject.html#21136">[ subject ]</a>
              <a href="author.html#21136">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/16/06, Wouter van Marle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">wouter at squirrel-systems.com</A>&gt; wrote:
&gt;<i> For html compatibility reasons, I store all the search data in the MySQL
</I>&gt;<i> database in html-quoted format. The term in question that I ran into is:
</I>&gt;<i> &quot;Jubil&#228;umsmodell&quot;, stored in the database as &quot;Jubil&amp;auml;umsmodell&quot;.
</I>&gt;<i>
</I>&gt;<i> The select in the html source, as presented to the browser, is fine (the
</I>&gt;<i> html line is abbreviated for here; it contains many more options):
</I>&gt;<i> &lt;select name=model&gt;
</I>&gt;<i>         &lt;option value=&quot;Jubil&amp;auml;umsmodell 40 Jahre&quot;&gt;Jubil&amp;auml;umsmodell 40
</I>&gt;<i> Jahre&lt;/option&gt;
</I>&gt;<i> &lt;/select&gt;
</I>&gt;<i>
</I>&gt;<i> It is rendered correctly of course by the browser.
</I>&gt;<i> Now when the user clicks go, and the POST is generated, the character is
</I>&gt;<i> sent back in what I guess is UTF-8 encoding
</I>
&gt;<i>From my experience, browsers will POST in the same character set/
</I>encoding as whatever the HTML page containing the &lt;form&gt; was
encoded in.  So if you output your HTML page in utf-8, then the POST
will also be UTF-8.

You can of course affect that somewhat if you explicitly output the
Accept-Encoding HTTP header, or the optional accept-charset
attribute of the &lt;form&gt; element.

Regardless though, you should use one of the above methods
rather than leaving it up to the browser.  My personal opinion
is to always use UTF-8 when communicating with browsers.
It is the best supported across all browsers, and will cause you
the least grief.

&gt;<i> (I assume it's that, as that's my default encoding) (again only a snippet):
</I>&gt;<i> &amp;model=Jubil%C3%A4umsmodell+40+Jahre
</I>
Yes, [0xc3, 0xa4] is in fact the two-byte UTF-8 encoding of the
unicode character U+00E4 (the a-diaeresis).

&gt;<i> So the end of the whole story, the actual question is now: how do I get
</I>&gt;<i> from this utf-8 encoding back to html quoted encoding, for searching in
</I>&gt;<i> the database?
</I>
What makes this more difficult is that you are using entity names rather
than character references.  For example, in HTML, all of these
&quot;escape&quot; strings can be used to reference the same character:

   &amp;auml;
   &amp;#228;
  &amp;#xe8;

The second decimal-numeric character reference is the most universal.
In fact it is what you must use if you ever want to use some other
XML-based languages rather than HTML.

Anyway, the first thing to do is to get the UTF-8 encoded string
turned back into a Python unicode string, such as

   s = s.decode('utf8')

Now that two-byte sequence has turned into a single unicode
character, \u00e8 (displayed as \xe8 when you print it).

Then you probably want to define a function which HTM-encodes
a Unicode string, turning all non-ASCII characters into references,
perhaps something like

def encodechar( c ):
    codepoint = ord(c)
    if codepoint &gt;= 128 or codepoint &lt; 32:
        return '&amp;#%d;' % codepoint
    else:
        return c

And HTML-encode your string like:

   encoded_s = ''.join( [encodechar(c) for c in s] )

If you are really tied to using entities rather than character references,
you may be able to do something like this instead:

import htmlentitydefs

def encodechar( c ):
    codepoint = ord(c)
    entityname = htmlentitydefs.codepoint2name.get( codepoint, None )
    if entityname:
        return '&amp;%s;' % entityname
    elif codepoint &gt;= 128 or codepoint &lt; 32:
        return '&amp;#%d;' % codepoint
    else:
        return c

Keep in mind though that not all browser versions understand
the complete list of HTML entity names.  That's why I would
strongly recommend against using entity names.

Also note that if you need apostrophes escaped too, you'll need to
put in another special case for that as the htmlentitydefs does
not have an entry for &quot;apos&quot; for some reason.

&gt;<i> And no, I'm not going to put the info in the database in
</I>&gt;<i> utf-8, that must remain html quoted for many other locations where it
</I>&gt;<i> goes wrong otherwise.
</I>
Your choice.  Actually though, MySQL handles Unicode brilliantly,
and if you could ever convert to that you'll make things a lot
easier on yourself in the future.
-- 
Deron Meranda

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021126.html">[mod_python] Problem with html quoted/unquoted
</A></li>
	<LI>Next message: <A HREF="021138.html">[mod_python] Problem with html quoted/unquoted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21136">[ date ]</a>
              <a href="thread.html#21136">[ thread ]</a>
              <a href="subject.html#21136">[ subject ]</a>
              <a href="author.html#21136">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
