<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Redirect and/or output regeneration with PSP files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Redirect%20and/or%20output%20regeneration%20with%20PSP%20files&In-Reply-To=447C75E5.2060508%40hatzis.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021273.html">
   <LINK REL="Next"  HREF="021275.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Redirect and/or output regeneration with PSP files</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jim Gallacher</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Redirect%20and/or%20output%20regeneration%20with%20PSP%20files&In-Reply-To=447C75E5.2060508%40hatzis.de"
       TITLE="[mod_python] Redirect and/or output regeneration with PSP files">jpg at jgassociates.ca
       </A><BR>
    <I>Tue May 30 14:31:10 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021273.html">[mod_python] Redirect and/or output regeneration with PSP files
</A></li>
        <LI>Next message: <A HREF="021275.html">[mod_python] Redirect and/or output regeneration with PSP files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21274">[ date ]</a>
              <a href="thread.html#21274">[ thread ]</a>
              <a href="subject.html#21274">[ subject ]</a>
              <a href="author.html#21274">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Anastasios Hatzis (Hatzis Edelstahlbearbeitung) wrote:
&gt;<i> Dear list members,
</I>&gt;<i> 
</I>&gt;<i> I'm still struggling with my PSP files. I like the embedding feature 
</I>&gt;<i> very much, but there is one issue I don't know how to solve and couldn't 
</I>&gt;<i> find a hint in the manual or web. It's about redirecting and/or 
</I>&gt;<i> re-generation of the HTML output depending on object states. I 
</I>&gt;<i> recognized that PSP obviously by default sends header/output directly to 
</I>&gt;<i> the client.
</I>&gt;<i> 
</I>&gt;<i> My first approach: I built a web-layer consisting of PSP-files only. 
</I>&gt;<i> They were called from a browser and each of them imported and accessed 
</I>&gt;<i> appropriate Python modules of my back-end application. These PSP files 
</I>&gt;<i> also included some other PSP files containing HTML snipplets. Structure 
</I>&gt;<i> was simplified like this
</I>&gt;<i> 
</I>&gt;<i> examplePage.psp:
</I>&gt;<i> a) include head.psp
</I>&gt;<i> b) do something with the back-end (imported Python modules with 
</I>&gt;<i> database-access) and build body
</I>&gt;<i> c) include foot.psp
</I>&gt;<i> 
</I>&gt;<i> head.psp and foot.psp also contained some condition-dependent output.
</I>&gt;<i> 
</I>&gt;<i> When specified conditions are met during processing of the request, it 
</I>&gt;<i> is necessary to either redirect to another URL - typical example would 
</I>&gt;<i> be a redirect to a sign-on form - or to re-generate partially or totally 
</I>&gt;<i> the HTML output. Unfortunatelly this can occur anywhere in a), b) or c), 
</I>&gt;<i> where PSP already have been included. I learned that I neither can clear 
</I>&gt;<i> and re-generate the already generated HTML output, nor use a 
</I>&gt;<i> util.redirect to another (PSP) file. Latter leads to the following error 
</I>&gt;<i> message:
</I>&gt;<i> 
</I>&gt;<i> IOError: Cannot redirect after headers have already been sent.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My second approach was to use mod_python.publisher instead of psp, where 
</I>&gt;<i> methods in py files are called, e.g.
</I>&gt;<i> <A HREF="http://www.modpython.org/examplePage.py/view?objectID=5">http://www.modpython.org/examplePage.py/view?objectID=5</A>
</I>&gt;<i> calling in examplePage.py the method view(req, objectID) which should 
</I>&gt;<i> then call an appropriate py-file which is responsible for importing the 
</I>&gt;<i> back-end modules and including PSP-files. For latter I used the template 
</I>&gt;<i> suggestion as made in the modpython manual:
</I>&gt;<i> 
</I>&gt;<i>        template = psp.PSP(self.oReq(), filename='../src/psp/head.psp')
</I>&gt;<i> 
</I>&gt;<i>        template.run({'txtPageTitle':'hello world'})
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Unfortunatelly this doesn't help since PSP.run() is also directly 
</I>&gt;<i> sending header to the browser.
</I>&gt;<i> 
</I>&gt;<i> So, I'm ending with the question if there are options or how-tos in 
</I>&gt;<i> order to
</I>&gt;<i> a) prevent PSP files from sending headers to the browser, so I can later 
</I>&gt;<i> in the process do a full re-direct, like util.redirect, if necessary
</I>&gt;<i> b) collecting PSP file outputs in objects and deciding myself which to 
</I>&gt;<i> send and which not to send, something like:
</I>&gt;<i> 
</I>&gt;<i> template = psp.PSP(self.oReq(), filename='../src/psp/head.psp')
</I>&gt;<i> 
</I>&gt;<i> htmlHead = template.run({'txtPageTitle':'hello world'})
</I>&gt;<i> 
</I>&gt;<i> template = psp.PSP(self.oReq(), filename='../src/psp/ExampleBody.psp')
</I>&gt;<i> 
</I>&gt;<i> htmlBody = template.run({'txtPageTitle':'hello world'})
</I>&gt;<i> 
</I>&gt;<i> template = psp.PSP(self.oReq(), filename='../src/psp/foot.psp')
</I>&gt;<i> 
</I>&gt;<i> htmlFoot = template.run({'txtPageTitle':'hello world'})
</I>&gt;<i> 
</I>&gt;<i> if simpleHead:
</I>&gt;<i> 
</I>&gt;<i>    htmlHead = '&lt;html&gt;&lt;body&gt;'
</I>&gt;<i> 
</I>&gt;<i> return htmlHead + htmlBody + htmlFoot
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> A link to documentation or how-to would be great or any good idea is 
</I>&gt;<i> appreciated.
</I>
No link, but perhaps a clarification. It's not really template.run() 
that is sending the headers.

Generating output with psp is a 2 step process.

1. Parse the psp template and generate python code. Any text outside the 
&quot;&lt;% %&gt;&quot; tag is wrapped in a req.write() call. Anything inside the tag is 
  treated as python code. Stuff inside &quot;&lt;%= %&gt;&quot; is treated as a python 
statement and wrapped by a req.write() call. All this happens in the 
psp.PSP() constructor.

2. Execute the code generated in step 1, with the vars copied into the 
global scope. This happens when run() is called. PSP does not concern 
itself with the response headers.

Ultimately it is the first call to req.write() that causes the headers 
to be flushed. You could still do a redirect in a psp template, but you 
need to make sure this happens *before* any output such as straight html 
or python code. This will not be a very robust solution however, since a 
single unwanted space or other character at the beginning of the 
template file will trigger a req.write() call.

You may find the following pattern more useful. Use publisher or some 
other handler to organize your back-end and page logic. Use a master 
template and pass sub-templates to the master in vars.

mptest.py
---------
def index(req):
     vars = {}
     if some_condition:
         vars['body'] = psp.PSP(req, filename='hi.tmpl')
     else:
         vars['body'] = psp.PSP(req, filename='bye.tmpl')

     master_tmpl = psp.PSP(req, filename='master.tmpl', vars=vars)
     return master_tmpl


master.tmpl
-----------
&lt;html&gt;
&lt;body&gt;
&lt;%= body %&gt;
&lt;/body&gt;
&lt;/html&gt;

hi.tmpl
---------
&lt;p&gt;Hello world&lt;/p&gt;

bye.tmpl
--------
&lt;p&gt;Goodbye world&lt;/p&gt;


When &lt;%= body %&gt; is encountered it's __str__ method is called. For a PSP 
instance this causes body.run() to be called. If you need access to vars 
in the sub-templates you'll need to pass vars to each in their constructors.

&gt;<i> Many thanks again and greetings from southern Germany (snowing here, 
</I>&gt;<i> hurrrr)
</I>
Now *that* is just crazy. (The snow part, not the fact that you are from 
Southern Germany. ;) )

Jim
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021273.html">[mod_python] Redirect and/or output regeneration with PSP files
</A></li>
	<LI>Next message: <A HREF="021275.html">[mod_python] Redirect and/or output regeneration with PSP files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21274">[ date ]</a>
              <a href="thread.html#21274">[ thread ]</a>
              <a href="subject.html#21274">[ subject ]</a>
              <a href="author.html#21274">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
