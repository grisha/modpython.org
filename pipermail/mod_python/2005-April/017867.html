<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] How to stop reimporting modules
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20How%20to%20stop%20reimporting%20modules&In-Reply-To=42581284.8030406%40copyrightwitness.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017866.html">
   <LINK REL="Next"  HREF="017870.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] How to stop reimporting modules</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jim Gallacher</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20How%20to%20stop%20reimporting%20modules&In-Reply-To=42581284.8030406%40copyrightwitness.net"
       TITLE="[mod_python] How to stop reimporting modules">jg.lists at sympatico.ca
       </A><BR>
    <I>Sat Apr  9 15:25:25 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017866.html">[mod_python] How to stop reimporting modules
</A></li>
        <LI>Next message: <A HREF="017870.html">[mod_python] How to stop reimporting modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17867">[ date ]</a>
              <a href="thread.html#17867">[ thread ]</a>
              <a href="subject.html#17867">[ subject ]</a>
              <a href="author.html#17867">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Barry,

Barry Pearce wrote:
&gt;<i> Hi Jim,
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> This is an interesting issue - I have my own handler but I have a 
</I>&gt;&gt;&gt;<i> problem where mod_python does NOT cause modules to be reloaded - 
</I>&gt;&gt;&gt;<i> despite having changed on the disk I would have expected the module 
</I>&gt;&gt;&gt;<i> to reload...but it stays the same until I restart the web server - 
</I>&gt;&gt;&gt;<i> perhaps there is something Im doing wrong!!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I really dont want to restart the apache server to upgrade my 
</I>&gt;&gt;&gt;<i> software - it kills all current sessions and downloads....
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Any ideas?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My impression is that the handler specified in the apache 
</I>&gt;&gt;<i> PythonHandler directive does not get reloaded when changed. Of course 
</I>&gt;&gt;<i> I may be completely off the mark here.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Ah. OK....thats why everything that it in turn imports also remains 
</I>&gt;<i> fixed in memory...its just a pain in the bum when I change something 
</I>&gt;<i> that the re-import does not take place.
</I>&gt;<i> 
</I>&gt;&gt;<i> For my code, the PythonHandler cms.publisher is just a stub that does 
</I>&gt;&gt;<i> a little pre-processing and then uses apache.import_module() to get my 
</I>&gt;&gt;<i> real handler. It's apache.import_module that does the reloading magic, 
</I>&gt;&gt;<i> and so I avoid restarting apache when my handler code changes. I 
</I>&gt;&gt;<i> figure once my code has pretty much settled down, I can change the 
</I>&gt;&gt;<i> PythonHandler to specify the real handler.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The issue comes during upgrade of live sites with many users with 
</I>&gt;<i> concurrent sessions and no 'quiet' period per say where a restart could 
</I>&gt;<i> be sensibly placed.
</I>&gt;<i> 
</I>&gt;<i> Interestingly I have been using a large number of python files and using 
</I>&gt;<i> the standard python import - however, if the top level module is not 
</I>&gt;<i> reimported it will never execute any of the other import statements.
</I>&gt;<i> 
</I>&gt;<i> Interesting...sorry im rambling...
</I>&gt;<i> 
</I>&gt;<i> Perhaps I need to re-evaluate my import strategy and call 
</I>&gt;<i> apache.import_module() instead of just relying on the python import...
</I>&gt;<i> 
</I>&gt;<i> Now I dont want it all checked on each request - but maybe I can write a 
</I>&gt;<i> handler that I can send a request to which re-evalutes all imported 
</I>&gt;<i> modules and then appropriately reloads them...
</I>
I don't think this will work in the apache prefork model. (I have no 
idea about the threaded model). In the prefork, each child process has 
it's own copy of the python interpreter and modules. Your call to the 
special handler will only cause the child that handles that request to 
reload. All the other children will still have a copy of the old 
modules. You have to make sure that each child gets a new copy - which 
is what happens when you restart apache. All the child processes are 
killed and then new ones created which will import the new modules.

So maybe your main handler can check a flag defined by a PythonOption 
directive and reload as necessary? Thus each child process will be 
forced to reload it's modules.

def handler(req):
    opts = req.get_options()
    reload_modules = int(opts.get('RELOAD_MODULES', '0'))

    if reload_modules:
         do_magic_module_reload()

    ... handle request ...

Edit your apache conf file for the site:
   PythonOption RELOAD_MODULES 1

Run 'apache reload' to read the config file changes. Subsequent requests 
will see the flag and reload of any modified modules. Once everything 
seems to be working change the flag back to 0 and run 'apache reload'.

Or how about having a version variable defined with module scope and a 
corresponding PythonOption directive.

# your publisher module
__version__ = 41

def handler(req):
    opts = req.get_options()
    if opts.has_key('MODULE_VERSION'):
        version = int(opts['MODULE_VERSION'])
        if __version__ &lt; version:
            do_magic_module_reload()
            __version__ = version

    ... handle request ...

And in your apache config:
PythonOption MODULE_VERSION 42

There, all you need to do now is write the code for 
do_magic_module_reload(). Oh, and send me copy when you're done. :)

But seriously, apache.import_module won't do what you want, but it looks 
like an interesting place to start. Python introspection is a new topic 
for me, but I don't think a solution to this problem is too difficult.

Regards,
Jim





</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017866.html">[mod_python] How to stop reimporting modules
</A></li>
	<LI>Next message: <A HREF="017870.html">[mod_python] How to stop reimporting modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17867">[ date ]</a>
              <a href="thread.html#17867">[ thread ]</a>
              <a href="subject.html#17867">[ subject ]</a>
              <a href="author.html#17867">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
