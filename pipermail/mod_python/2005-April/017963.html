<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] bug in apache.import_module
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20bug%20in%20apache.import_module&In-Reply-To=c298f2d705042901333282aa30%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017962.html">
   <LINK REL="Next"  HREF="017967.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] bug in apache.import_module</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Huzaifa Tapal</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20bug%20in%20apache.import_module&In-Reply-To=c298f2d705042901333282aa30%40mail.gmail.com"
       TITLE="[mod_python] bug in apache.import_module">huzaifa at hostway.com
       </A><BR>
    <I>Fri Apr 29 15:58:03 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017962.html">[mod_python] bug in apache.import_module
</A></li>
        <LI>Next message: <A HREF="017967.html">[mod_python] bug in apache.import_module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17963">[ date ]</a>
              <a href="thread.html#17963">[ thread ]</a>
              <a href="subject.html#17963">[ subject ]</a>
              <a href="author.html#17963">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I wanted to ask for a piece of advise.  So the fix that I have 
mentioned, I moved that fix (the method I replaced with the map(lambda) 
solution you had with a minor fix) to another &quot;SharedResources&quot; module 
that I import in my framework's handler.  From within the handler and my 
app, I am call that method passing in a path argument that it *fixes* 
and returns back the results.  Here is what the new method looks like:

def fix_paths( path ):
    &quot;&quot;&quot; Convenience method for checking and
    adding '/' to the end of paths for compatibility
    with mod_python's import_module. &quot;&quot;&quot;

    _lock.acquire()
    try:
        if path and type(path) == type([]):
            path = map(lambda entry : (entry!='' and entry[-1]!='/' and 
entry+'/') or entry,path)

        return path
    finally:
        _lock.release()

Should I have the thread-locking in place or can I get by without having 
it in place?  The reason I did add that was because the path value may 
get changed, in the process, I thought of making this method thread-safe.

Also Nicolas, if you notice I added another check in your lambda 
function to check if the entry is an empty string.  If that wasn't there 
then if an empty string path was passed in the list paths, the function 
would break.  Thought, i'd let you know if you were gonna add this 
functionality into the import_module method for apache.py

Thanks

Hozi

Nicolas Lehuen wrote:

&gt;<i>Sorry, reposting to the whole list :
</I>&gt;<i>
</I>&gt;<i>Hi,
</I>&gt;<i>
</I>&gt;<i>The change I've made for MODPYTHON-9 affects only the publisher
</I>&gt;<i>module. It solves the problem encountered when you had two pages, one
</I>&gt;<i>at /index.py, and the other at /foobar/index.py.
</I>&gt;<i>
</I>&gt;<i>Huzaifa, what I don't understand here is whether moduleA has the same
</I>&gt;<i>name as moduleB, and whether you are using mod_python.publisher or
</I>&gt;<i>not.
</I>&gt;<i>
</I>&gt;<i>If you use the publisher, your problem has been solved in the latest
</I>&gt;<i>development version, and the fix will be in the next release.
</I>&gt;<i>
</I>&gt;<i>Anyway, if we put aside the fix specific to the publisher, the problem
</I>&gt;<i>you describe is real, and the workaround you provide is correct.
</I>&gt;<i>
</I>&gt;<i>It is so correct that the only way I see of fixing that is to
</I>&gt;<i>integrate the workaround in the import_module function, that is to say
</I>&gt;<i>to check whether each path component passed in the path list argument
</I>&gt;<i>ends with a '/' (or '\'), and if not, add a '/' (or '\\'). This is
</I>&gt;<i>done easily in the first line of the function :
</I>&gt;<i>
</I>&gt;<i>if path:
</I>&gt;<i>   path = map(lambda entry : (entry[-1]!='/' and entry+'/') or entry,path)
</I>&gt;<i>
</I>&gt;<i>However, there is no easy way of telling what directory separator
</I>&gt;<i>should be used ; theoretically, os.sep gives us the correct directory
</I>&gt;<i>separator, but even under Win32 Apache admins are advised to use &quot;/&quot;
</I>&gt;<i>which is compatible (at the OS level). So, we might as well always use
</I>&gt;<i>&quot;/&quot;.
</I>&gt;<i>
</I>&gt;<i>What I fear is that adding all these checks to import_module will make
</I>&gt;<i>it a little bit too slow, so what about adding a line or two in the
</I>&gt;<i>documentation about the fact that all directories mentioned in the
</I>&gt;<i>path argument should end with a '/' ?
</I>&gt;<i>
</I>&gt;<i>Regards,
</I>&gt;<i>
</I>&gt;<i>Nicolas
</I>&gt;<i>
</I>&gt;<i>On 4/29/05, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>Nicolas, does the change you have already made for MODPYTHON-9
</I>&gt;&gt;<i>also address this slightly different variation on the problem?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Original report was based on same name module in parent and child
</I>&gt;&gt;<i>subdirectories, not sibling directories which share a common prefix
</I>&gt;&gt;<i>to the subdirectory name.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Graham
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Huzaifa Tapal wrote ..
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>For my fix, I patched this issue by passing the import_module function
</I>&gt;&gt;&gt;<i>the path with &quot;/&quot; in the end.  That way it distinguishes from
</I>&gt;&gt;&gt;<i>/home/user/dir1 and /home/user/dir123
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>hozi
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Graham Dumpleton wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>See:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>  <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-9">http://issues.apache.org/jira/browse/MODPYTHON-9</A>
</I>&gt;&gt;&gt;&gt;<i>  <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-10">http://issues.apache.org/jira/browse/MODPYTHON-10</A>
</I>&gt;&gt;&gt;&gt;<i>  <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-11">http://issues.apache.org/jira/browse/MODPYTHON-11</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>There are various known issues with using same name module in different
</I>&gt;&gt;&gt;&gt;<i>directories.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>The first one has been addressed for next version of mod_python.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>Graham
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>On 29/04/2005, at 8:22 AM, Huzaifa Tapal wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>        
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>I think there is a bug in apache.import_module.  I am using
</I>&gt;&gt;&gt;&gt;&gt;<i>apache.import_module passing in the path where I want the module
</I>&gt;&gt;&gt;&gt;&gt;<i>imported from.  I am seeing a very odd result as to sometimes, the
</I>&gt;&gt;&gt;&gt;&gt;<i>module that is loaded is not the right one.  Instead it loads a
</I>&gt;&gt;&gt;&gt;&gt;<i>module that is of the same name but in a different directory.  Here
</I>&gt;&gt;&gt;&gt;&gt;<i>is what is happening:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>I have two modules of same name in 2 different directories as follows;
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>/home/user/dir1/moduleA
</I>&gt;&gt;&gt;&gt;&gt;<i>/home/user/dir123/moduleB
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>Lets say I restart apache and load up moduleA.  At that point there
</I>&gt;&gt;&gt;&gt;&gt;<i>is an entry in sys.modules for moduleA.  Lets say then, I load up
</I>&gt;&gt;&gt;&gt;&gt;<i>moduleB, now the original entry for moduleA is overwritten by this
</I>&gt;&gt;&gt;&gt;&gt;<i>new entry.  Now when I go back to load moduleA, I get back moduleB
</I>&gt;&gt;&gt;&gt;&gt;<i>results. Here is why:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>In apache.import_module if I pass in the path to load moduleA from
</I>&gt;&gt;&gt;&gt;&gt;<i>'/home/user/dir1' and the last module was in '/home/user/dir123' then
</I>&gt;&gt;&gt;&gt;&gt;<i>the check in import_module to make sure both modules aren't the same
</I>&gt;&gt;&gt;&gt;&gt;<i>fails since it does a &quot;file.startswith()&quot; check on the path.  Since
</I>&gt;&gt;&gt;&gt;&gt;<i>the path moduleA is in the path to moduleB, it loads the wrong module.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>I see that somebody else had complained about this problem in
</I>&gt;&gt;&gt;&gt;&gt;<i>mod_python 1.3.1 but it still has not been patched.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>Any ideas?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>Hozi
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>_______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i>Mod_python mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;&gt;&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;&gt;&gt;&gt;<i>          
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>        
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>_______________________________________________
</I>&gt;&gt;<i>Mod_python mailing list
</I>&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Mod_python mailing list
</I>&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i><A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050429/979e07ea/attachment.html">http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20050429/979e07ea/attachment.html</A>
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017962.html">[mod_python] bug in apache.import_module
</A></li>
	<LI>Next message: <A HREF="017967.html">[mod_python] bug in apache.import_module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17963">[ date ]</a>
              <a href="thread.html#17963">[ thread ]</a>
              <a href="subject.html#17963">[ subject ]</a>
              <a href="author.html#17963">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
