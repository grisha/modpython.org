<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Fwd: Re: [mod_python] psp.PSP(req,
	string='hello world') causessegfault]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5BFwd%3A%20Re%3A%20%5Bmod_python%5D%20psp.PSP%28req%2C%0A%09string%3D%27hello%20world%27%29%20causessegfault%5D&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017945.html">
   <LINK REL="Next"  HREF="017951.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Fwd: Re: [mod_python] psp.PSP(req,
	string='hello world') causessegfault]</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5BFwd%3A%20Re%3A%20%5Bmod_python%5D%20psp.PSP%28req%2C%0A%09string%3D%27hello%20world%27%29%20causessegfault%5D&In-Reply-To="
       TITLE="[Fwd: Re: [mod_python] psp.PSP(req,
	string='hello world') causessegfault]">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Apr 26 21:02:11 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017945.html">[Fwd: Re: [mod_python] psp.PSP(req,
	string='hello world') causessegfault]
</A></li>
        <LI>Next message: <A HREF="017951.html">[Fwd: Re: [mod_python] psp.PSP(req, string='hello world')
	causessegfault]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17946">[ date ]</a>
              <a href="thread.html#17946">[ thread ]</a>
              <a href="subject.html#17946">[ subject ]</a>
              <a href="author.html#17946">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The code in PSP constructor where code is first put in cache should be:

            cached = mem_scache.get(string)
            if cached:
                self.code = cached
            else:
                source = _psp.parsestring(string)
                code = compile(source, &quot;__psp__&quot;, &quot;exec&quot;)
                mem_scache.store(string,code)
                self.code = code                                                

Ie., code wasn't actually being compiled. Not sure what should be put
for second argument. It only gets displayed in error messages according
to documentation. Normally it would be the name of the module, but
there isn't one here.

It seems to work for me now. I'll try and get all these changes together
and post a bug report on JIRA.

Graham

Graham Dumpleton wrote ..
&gt;<i> Following code in _psp_module_parsestring() looks suspect to me:
</I>&gt;<i> 
</I>&gt;<i>     yy_delete_buffer(bs, scanner);
</I>&gt;<i>     yylex_destroy(scanner);
</I>&gt;<i> 
</I>&gt;<i> There are already calls to yy_delete_buffer() in yylex_destroy(). If I
</I>&gt;<i> comment out the call to yy_delete_buffer() I no longer get the
</I>&gt;<i> double delete warning. I still get the Python error below though,
</I>&gt;<i> so that is the next thing to solve.
</I>&gt;<i> 
</I>&gt;<i> Graham
</I>&gt;<i> 
</I>&gt;<i> Graham Dumpleton wrote ..
</I>&gt;<i> &gt; It may not be your platform, but a problem in the C code part of PSP
</I>&gt;<i> &gt; modules after all. On Mac OSX, after making the Python changes you
</I>&gt;<i> &gt; give, it doesn't crash, but do get this warning in the logs.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; [Wed Apr 27 10:21:14 2005] [notice] Apache/2.0.51 (Unix) mod_python/3.1.3
</I>&gt;<i> &gt; Python/2.3 configured -- resuming normal operations
</I>&gt;<i> &gt; *** malloc[595]: Deallocation of a pointer not malloced: 0x528050; This
</I>&gt;<i> &gt; could be a double free(), or free() called with the middle of an allocated
</I>&gt;<i> &gt; block; Try setting environment variable MallocHelp to see tools to help
</I>&gt;<i> &gt; debug
</I>&gt;<i> &gt; *** malloc[595]: error for object 0x5102c0: Double free
</I>&gt;<i> &gt; [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
</I>&gt;<i> &gt; Traceback (most recent call last):
</I>&gt;<i> &gt; [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
</I>&gt;<i> &gt; File &quot;/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/apache.py&quot;,
</I>&gt;<i> &gt; line 308, in HandlerDispatch\n    result = object(req)
</I>&gt;<i> &gt; [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
</I>&gt;<i> &gt; File &quot;/Users/grahamd/Sites/psp_crash/_handler.py&quot;, line 6, in handler\n
</I>&gt;<i> &gt; content_file.run()
</I>&gt;<i> &gt; [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
</I>&gt;<i> &gt; File &quot;/System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/site-packages/mod_python/psp.py&quot;,
</I>&gt;<i> &gt; line 190, in run\n    if &quot;session&quot; in code.co_names:
</I>&gt;<i> &gt; [Wed Apr 27 10:21:16 2005] [error] [client 127.0.0.1] PythonHandler _handler:
</I>&gt;<i> &gt; AttributeError: 'str' object has no attribute 'co_names' 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I haven't looked at the Python traceback bit yet, but the fact that malloc
</I>&gt;<i> &gt; is complaining suggests that some sort of memory manipulation is
</I>&gt;<i> &gt; wrong.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Graham
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; dharana wrote ..
</I>&gt;<i> &gt; &gt; There where more typos. I think I've fixed them. I am now trying to
</I>&gt;<i> &gt; &gt; reproduce it in another machine. I'm starting to believe it must a
</I>&gt;<i> &gt; &gt; problem with my server setup what is causing the segfaults.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; -------- Original Message --------
</I>&gt;<i> &gt; &gt; Subject: Re: [mod_python] psp.PSP(req, string='hello world') causes
</I>&gt;<i> segfault
</I>&gt;<i> &gt; &gt; Date: Wed, 27 Apr 2005 00:49:08 +0200
</I>&gt;<i> &gt; &gt; From: dharana &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">dharana at dharana.net</A>&gt;
</I>&gt;<i> &gt; &gt; To: dharana &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">dharana at dharana.net</A>&gt;
</I>&gt;<i> &gt; &gt; CC: Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt;,  mod_python list 
</I>&gt;<i> &gt; &gt; &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>&gt;,  <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">python-dev at httpd.apache.org</A>
</I>&gt;<i> &gt; &gt; References: &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">426EB09B.60804 at dharana.net</A>&gt; 
</I>&gt;<i> &gt; &gt; &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">cd668e4f1acb033939973727c751beb6 at dscpl.com.au</A>&gt; 
</I>&gt;<i> &gt; &gt; &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">426EB7C7.4030307 at dharana.net</A>&gt; 
</I>&gt;<i> &gt; &gt; &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">9f4387af79e092bc1b49d90c29633edc at dscpl.com.au</A>&gt; 
</I>&gt;<i> &gt; &gt; &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">426EC2D1.7080401 at dharana.net</A>&gt;
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; There where 3 typos in psp.py. I could only fix them by temporarily
</I>&gt;<i> &gt; &gt; commenting out the _psp.parsestring call. I leave to you the C side
</I>&gt;<i> :)
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; I've included the patch file with the typos fixed. Hope it helps. I'm
</I>&gt;<i> &gt; &gt; also forwarding to python-dev because I believe I've crossed the line
</I>&gt;<i> &gt; again.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; -----------------------------------------------------------------------
</I>&gt;<i> &gt; &gt; --- /usr/src/mod_python-3.1.4/lib/python/mod_python/psp.py      Sat
</I>&gt;<i> Jan
</I>&gt;<i> &gt; &gt; 29 22:25:29 2005
</I>&gt;<i> &gt; &gt; +++ /usr/local/hosting/lib/python2.4/site-packages/mod_python/psp.py
</I>&gt;<i> &gt; &gt; Wed Apr 27 00:43:06 2005
</I>&gt;<i> &gt; &gt; @@ -111,12 +111,12 @@
</I>&gt;<i> &gt; &gt;               self.load_from_file()
</I>&gt;<i> &gt; &gt;           else:
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; -            cached = strcache.get(string)
</I>&gt;<i> &gt; &gt; +            cached = mem_scache.get(string)
</I>&gt;<i> &gt; &gt;               if cached:
</I>&gt;<i> &gt; &gt;                   self.code = cached
</I>&gt;<i> &gt; &gt;               else:
</I>&gt;<i> &gt; &gt;                   self.code = _psp.parsestring(string)
</I>&gt;<i> &gt; &gt; -                strcache.store(string)
</I>&gt;<i> &gt; &gt; +                mem_scache.store(string, self.code)
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt;       def cache_get(self, filename, mtime):
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; @@ -358,8 +358,8 @@
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt;       def get(self, key):
</I>&gt;<i> &gt; &gt;           if self.cache.has_key(key):
</I>&gt;<i> &gt; &gt; -            hist, val = self.cache[key]
</I>&gt;<i> &gt; &gt; -            self.cache[key] = (hits+1, code)
</I>&gt;<i> &gt; &gt; +            hits, val = self.cache[key]
</I>&gt;<i> &gt; &gt; +            self.cache[key] = (hits+1, val)
</I>&gt;<i> &gt; &gt;               return val
</I>&gt;<i> &gt; &gt;           else:
</I>&gt;<i> &gt; &gt;               return None
</I>&gt;<i> &gt; &gt; -----------------------------------------------------------------------
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; -- 
</I>&gt;<i> &gt; &gt; dharana
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mod_python mailing list
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017945.html">[Fwd: Re: [mod_python] psp.PSP(req,
	string='hello world') causessegfault]
</A></li>
	<LI>Next message: <A HREF="017951.html">[Fwd: Re: [mod_python] psp.PSP(req, string='hello world')
	causessegfault]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17946">[ date ]</a>
              <a href="thread.html#17946">[ thread ]</a>
              <a href="subject.html#17946">[ subject ]</a>
              <a href="author.html#17946">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
