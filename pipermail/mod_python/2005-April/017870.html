<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] How to stop reimporting modules
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20How%20to%20stop%20reimporting%20modules&In-Reply-To=42582C25.4090305%40sympatico.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017867.html">
   <LINK REL="Next"  HREF="017871.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] How to stop reimporting modules</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20How%20to%20stop%20reimporting%20modules&In-Reply-To=42582C25.4090305%40sympatico.ca"
       TITLE="[mod_python] How to stop reimporting modules">grahamd at dscpl.com.au
       </A><BR>
    <I>Sat Apr  9 17:43:55 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017867.html">[mod_python] How to stop reimporting modules
</A></li>
        <LI>Next message: <A HREF="017871.html">[mod_python] How to stop reimporting modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17870">[ date ]</a>
              <a href="thread.html#17870">[ thread ]</a>
              <a href="subject.html#17870">[ subject ]</a>
              <a href="author.html#17870">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am starting to sound like a broken record, but the module importing 
system in
Vampire addresses all these sorts of problems with modifications to sub 
imports
and will reload unchanged parent modules even when it is only a sub 
import that
has changed. Thus it is possible when using Vampire to make changes 
without
restarting Apache and they will all be picked up correctly.

There is so far only one class of problem I know of where when using 
Vampire one
would still need to do a restart. This is where objects are cached and 
type
comparisons are being done between cached objects and some class type 
they are
meant to be created from. This can still fail because on a reload the 
type
object itself could be replaced and therefore will not match the type 
object
of a cached instance of a previous version. This problem also occurs in 
the
standard mod_python module loading system and isn't Vampire specific 
though.

I'll go into this more or point to previous posts I have made on this 
topic if
you are genuinely interested in trying to switch to Vampire.

Note that Vampire isn't a framework which requires you to change 
absolutely
everything. It doesn't force you to use a specific templating system. 
Its main
purpose is to expand on the basic selection mechanism for handlers in 
mod_python
and address all these module reloading issues by providing an alternate 
module
loading system.

Graham

On 10/04/2005, at 5:25 AM, Jim Gallacher wrote:

&gt;<i> Hi Barry,
</I>&gt;<i>
</I>&gt;<i> Barry Pearce wrote:
</I>&gt;&gt;<i> Hi Jim,
</I>&gt;&gt;&gt;&gt;<i> This is an interesting issue - I have my own handler but I have a 
</I>&gt;&gt;&gt;&gt;<i> problem where mod_python does NOT cause modules to be reloaded - 
</I>&gt;&gt;&gt;&gt;<i> despite having changed on the disk I would have expected the module 
</I>&gt;&gt;&gt;&gt;<i> to reload...but it stays the same until I restart the web server - 
</I>&gt;&gt;&gt;&gt;<i> perhaps there is something Im doing wrong!!
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I really dont want to restart the apache server to upgrade my 
</I>&gt;&gt;&gt;&gt;<i> software - it kills all current sessions and downloads....
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Any ideas?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My impression is that the handler specified in the apache 
</I>&gt;&gt;&gt;<i> PythonHandler directive does not get reloaded when changed. Of 
</I>&gt;&gt;&gt;<i> course I may be completely off the mark here.
</I>&gt;&gt;<i> Ah. OK....thats why everything that it in turn imports also remains 
</I>&gt;&gt;<i> fixed in memory...its just a pain in the bum when I change something 
</I>&gt;&gt;<i> that the re-import does not take place.
</I>&gt;&gt;&gt;<i> For my code, the PythonHandler cms.publisher is just a stub that 
</I>&gt;&gt;&gt;<i> does a little pre-processing and then uses apache.import_module() to 
</I>&gt;&gt;&gt;<i> get my real handler. It's apache.import_module that does the 
</I>&gt;&gt;&gt;<i> reloading magic, and so I avoid restarting apache when my handler 
</I>&gt;&gt;&gt;<i> code changes. I figure once my code has pretty much settled down, I 
</I>&gt;&gt;&gt;<i> can change the PythonHandler to specify the real handler.
</I>&gt;&gt;<i> The issue comes during upgrade of live sites with many users with 
</I>&gt;&gt;<i> concurrent sessions and no 'quiet' period per say where a restart 
</I>&gt;&gt;<i> could be sensibly placed.
</I>&gt;&gt;<i> Interestingly I have been using a large number of python files and 
</I>&gt;&gt;<i> using the standard python import - however, if the top level module 
</I>&gt;&gt;<i> is not reimported it will never execute any of the other import 
</I>&gt;&gt;<i> statements.
</I>&gt;&gt;<i> Interesting...sorry im rambling...
</I>&gt;&gt;<i> Perhaps I need to re-evaluate my import strategy and call 
</I>&gt;&gt;<i> apache.import_module() instead of just relying on the python 
</I>&gt;&gt;<i> import...
</I>&gt;&gt;<i> Now I dont want it all checked on each request - but maybe I can 
</I>&gt;&gt;<i> write a handler that I can send a request to which re-evalutes all 
</I>&gt;&gt;<i> imported modules and then appropriately reloads them...
</I>&gt;<i>
</I>&gt;<i> I don't think this will work in the apache prefork model. (I have no 
</I>&gt;<i> idea about the threaded model). In the prefork, each child process has 
</I>&gt;<i> it's own copy of the python interpreter and modules. Your call to the 
</I>&gt;<i> special handler will only cause the child that handles that request to 
</I>&gt;<i> reload. All the other children will still have a copy of the old 
</I>&gt;<i> modules. You have to make sure that each child gets a new copy - which 
</I>&gt;<i> is what happens when you restart apache. All the child processes are 
</I>&gt;<i> killed and then new ones created which will import the new modules.
</I>&gt;<i>
</I>&gt;<i> So maybe your main handler can check a flag defined by a PythonOption 
</I>&gt;<i> directive and reload as necessary? Thus each child process will be 
</I>&gt;<i> forced to reload it's modules.
</I>&gt;<i>
</I>&gt;<i> def handler(req):
</I>&gt;<i>    opts = req.get_options()
</I>&gt;<i>    reload_modules = int(opts.get('RELOAD_MODULES', '0'))
</I>&gt;<i>
</I>&gt;<i>    if reload_modules:
</I>&gt;<i>         do_magic_module_reload()
</I>&gt;<i>
</I>&gt;<i>    ... handle request ...
</I>&gt;<i>
</I>&gt;<i> Edit your apache conf file for the site:
</I>&gt;<i>   PythonOption RELOAD_MODULES 1
</I>&gt;<i>
</I>&gt;<i> Run 'apache reload' to read the config file changes. Subsequent 
</I>&gt;<i> requests will see the flag and reload of any modified modules. Once 
</I>&gt;<i> everything seems to be working change the flag back to 0 and run 
</I>&gt;<i> 'apache reload'.
</I>&gt;<i>
</I>&gt;<i> Or how about having a version variable defined with module scope and a 
</I>&gt;<i> corresponding PythonOption directive.
</I>&gt;<i>
</I>&gt;<i> # your publisher module
</I>&gt;<i> __version__ = 41
</I>&gt;<i>
</I>&gt;<i> def handler(req):
</I>&gt;<i>    opts = req.get_options()
</I>&gt;<i>    if opts.has_key('MODULE_VERSION'):
</I>&gt;<i>        version = int(opts['MODULE_VERSION'])
</I>&gt;<i>        if __version__ &lt; version:
</I>&gt;<i>            do_magic_module_reload()
</I>&gt;<i>            __version__ = version
</I>&gt;<i>
</I>&gt;<i>    ... handle request ...
</I>&gt;<i>
</I>&gt;<i> And in your apache config:
</I>&gt;<i> PythonOption MODULE_VERSION 42
</I>&gt;<i>
</I>&gt;<i> There, all you need to do now is write the code for 
</I>&gt;<i> do_magic_module_reload(). Oh, and send me copy when you're done. :)
</I>&gt;<i>
</I>&gt;<i> But seriously, apache.import_module won't do what you want, but it 
</I>&gt;<i> looks like an interesting place to start. Python introspection is a 
</I>&gt;<i> new topic for me, but I don't think a solution to this problem is too 
</I>&gt;<i> difficult.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Jim
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017867.html">[mod_python] How to stop reimporting modules
</A></li>
	<LI>Next message: <A HREF="017871.html">[mod_python] How to stop reimporting modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17870">[ date ]</a>
              <a href="thread.html#17870">[ thread ]</a>
              <a href="subject.html#17870">[ subject ]</a>
              <a href="author.html#17870">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
