<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] psp.PSP(req, string='hello world') causes segfault
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20psp.PSP%28req%2C%20string%3D%27hello%20world%27%29%20causes%20segfault&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017940.html">
   <LINK REL="Next"  HREF="017942.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] psp.PSP(req, string='hello world') causes segfault</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20psp.PSP%28req%2C%20string%3D%27hello%20world%27%29%20causes%20segfault&In-Reply-To="
       TITLE="[mod_python] psp.PSP(req, string='hello world') causes segfault">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Apr 26 19:46:53 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017940.html">[mod_python] psp.PSP(req, string='hello world') causes segfault
</A></li>
        <LI>Next message: <A HREF="017942.html">[mod_python] psp.PSP(req, string='hello world') causes segfault
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17941">[ date ]</a>
              <a href="thread.html#17941">[ thread ]</a>
              <a href="subject.html#17941">[ subject ]</a>
              <a href="author.html#17941">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>dharana wrote ..
&gt;<i> -- site-packages/mod_python/psp.py snippet ---------------------
</I>&gt;<i>          if filename:
</I>&gt;<i> 
</I>&gt;<i>              # if filename is not absolute, default to our guess
</I>&gt;<i>              # of current directory
</I>&gt;<i>              if not os.path.isabs(filename):
</I>&gt;<i>                  base = os.path.split(req.filename)[0]
</I>&gt;<i>                  self.filename = os.path.join(base, filename)
</I>&gt;<i> 
</I>&gt;<i>              self.load_from_file()
</I>&gt;<i>          else:
</I>&gt;<i> 
</I>&gt;<i>              cached = mem_scache.get(string)
</I>&gt;<i>              if cached:
</I>&gt;<i>                  self.code = cached
</I>&gt;<i>              else:
</I>&gt;<i> (line 118)      self.code = _psp.parsestring(string)
</I>&gt;<i>                  mem_scache.store(string)
</I>&gt;<i> -----------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Commenting out line 118 and trying to run the script in the previous 
</I>&gt;<i> email (the one that is causing the segfault) gives me this error:
</I>&gt;<i> 
</I>&gt;<i> --- traceback -------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i> TypeError: store() takes exactly 3 arguments (2 given)
</I>&gt;<i> -------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> I don't know why this is failling, maybe it has something to do with the
</I>&gt;<i> problem. _psp.parsestring(string) shouldn't modify &quot;string&quot; in any way
</I>&gt;<i> nor should it be able to pass hidden args to the mem_scache.store() 
</I>&gt;<i> function, right?
</I>
The store() method is expecting a key and value argument. The string
would be the value argument, but what could the key be set to. Can't
see any way you could automagically produce a value for the key. You
can't use req.filename by itself as the file could create multiple PSP
objects with different strings.

My thinking is that you almost need to have the user of the PSP class
supply an argument to optionally tag the string based PSP object.
The default key could be req.filename and if that optional tag is set,
it could be appended to the req.filename separated by a &quot;?&quot; or other
magic character.

Thus:

  class PSP:
    
    def __init__(self, req, filename=None, string=None, vars={}, tag=&quot;&quot;): 

       ...

            key = &quot;%s?%s&quot; % (req.filename,tag)
            cached = mem_scache.get(key,string)
            if cached:
                self.code = cached
            else:
                self.code = _psp.parsestring(string)
                mem_scache.store(key,string)                                          

Graham
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017940.html">[mod_python] psp.PSP(req, string='hello world') causes segfault
</A></li>
	<LI>Next message: <A HREF="017942.html">[mod_python] psp.PSP(req, string='hello world') causes segfault
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17941">[ date ]</a>
              <a href="thread.html#17941">[ thread ]</a>
              <a href="subject.html#17941">[ subject ]</a>
              <a href="author.html#17941">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
