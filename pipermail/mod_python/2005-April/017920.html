<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Passing information through req.internal_redirect().
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Passing%20information%20through%20req.internal_redirect%28%29.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017919.html">
   <LINK REL="Next"  HREF="017921.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Passing information through req.internal_redirect().</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Passing%20information%20through%20req.internal_redirect%28%29.&In-Reply-To="
       TITLE="[mod_python] Passing information through req.internal_redirect().">grahamd at dscpl.com.au
       </A><BR>
    <I>Sat Apr 23 03:41:13 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017919.html">[mod_python] ANN: Vampire 1.6 is now available.
</A></li>
        <LI>Next message: <A HREF="017921.html">[mod_python] Passing information through req.internal_redirect().
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17920">[ date ]</a>
              <a href="thread.html#17920">[ thread ]</a>
              <a href="subject.html#17920">[ subject ]</a>
              <a href="author.html#17920">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>There has been a few times on the list where questions have been asked 
about
how to pass information through a &quot;req.internal_redirect()&quot; call. The 
problem
is that any data which is stashed in the &quot;req&quot; object isn't available 
to the
target of the internal redirect because Apache/mod_python constructs a 
new
&quot;req&quot; object for the subsequent handler invocation.

Turns out there is actually a way of passing at least some information. 
This
is done by adding new key/values to the &quot;req.subprocess_env&quot; table. 
This table
is held within Apache data structures associated with the request and 
contents
of it are propagated through to the target of the internal redirect. 
The only
trick is that the key names get modified when the redirect occurs. You 
also
can only store string values.

Take for example a handler which contains:

   from mod_python import apache
   import os

   def handler(req):
     req.subprocess_env.add(&quot;XXX&quot;,&quot;YYY&quot;)
     req.internal_redirect(os.path.split(req.uri)[0]+'/page')
     return apache.OK

and is accessed as:

   /~grahamd/redirect/redirect

And a second handler which is triggered as the target of the redirect 
which
contains:

   from mod_python import apache

   def handler(req):
     req.content_type = &quot;text/plain&quot;
     for key in req.subprocess_env.keys():
       print &gt;&gt; req, key, &quot;=&quot;, req.subprocess_env[key]
     return apache.OK

That is, URL for this is:

   /~grahamd/redirect/page

The result of making a request against the first URL is that 
redirection to
the second occurs, with the output being:

   REDIRECT_GATEWAY_INTERFACE = CGI/1.1
   REDIRECT_SERVER_PROTOCOL = HTTP/1.1
   REDIRECT_REQUEST_METHOD = GET
   REDIRECT_QUERY_STRING =
   REDIRECT_REQUEST_URI = /~grahamd/redirect/redirect
   REDIRECT_SCRIPT_NAME = /~grahamd/redirect/redirect
   REDIRECT_XXX = YYY
   REDIRECT_STATUS = 200
   GATEWAY_INTERFACE = CGI/1.1
   SERVER_PROTOCOL = HTTP/1.1
   REQUEST_METHOD = GET
   QUERY_STRING =
   REQUEST_URI = /~grahamd/redirect/redirect
   SCRIPT_NAME = /~grahamd/redirect/page

As can be seen, the key/value pair of &quot;XXX&quot; and &quot;YYY&quot; have persisted, 
although
the key name is now &quot;REDIRECT_XXX&quot;. One can also see that other 
preexisting
variables set by Apache for the original request are also propagated as 
well,
with similar key name change.

That one can pass a newly created value would be useful where for 
example a
initial handler had created a new session object as it could store the 
session
ID in this table such that it is accessible to the second handler. In 
the past
people have noticed how in redirects both handlers end up creating 
separate
new session IDs if the first handler had to create one, because the new 
session
ID is lost and not usable by the second handler.

The information propagated about the initial request is useful as well 
for the
fact that the original URI is present. This could be used by the second 
handler
in some way.

As an example, when using the ErrorDocument directive, Apache uses an 
internal
redirect to redirect to the page when it is a local URI. As documented 
in:

   <A HREF="http://httpd.apache.org/docs-2.0/custom-error.html">http://httpd.apache.org/docs-2.0/custom-error.html</A>

the req.subprocess_env would contain the &quot;REDIRECT_*&quot; values shown 
above. In
this case the internal redirect is being done in Apache itself, but 
there is
no reason that you couldn't implement your own version of the 
ErrorDocument
functionality in your own custom handler code.

Anyway, thought I would put together this ramble about this stuff when 
I found
that this could be done since it may have been a solution to problems a 
few
people had faced before, but that it could be done doesn't seem to have 
ever
been mentioned on the mailing list before. At least now anyone 
searching the
archives may find this. :-)

Enjoy.

Graham

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017919.html">[mod_python] ANN: Vampire 1.6 is now available.
</A></li>
	<LI>Next message: <A HREF="017921.html">[mod_python] Passing information through req.internal_redirect().
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17920">[ date ]</a>
              <a href="thread.html#17920">[ thread ]</a>
              <a href="subject.html#17920">[ subject ]</a>
              <a href="author.html#17920">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
