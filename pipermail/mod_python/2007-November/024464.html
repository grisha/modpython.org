<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Large File Upload Issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Large%20File%20Upload%20Issues&In-Reply-To=88e286470710181503t290d95bfn1c221fc87367baa5%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024463.html">
   <LINK REL="Next"  HREF="024465.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Large File Upload Issues</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Kurt Nordstrom</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Large%20File%20Upload%20Issues&In-Reply-To=88e286470710181503t290d95bfn1c221fc87367baa5%40mail.gmail.com"
       TITLE="[mod_python] Large File Upload Issues">knordstrom at library.unt.edu
       </A><BR>
    <I>Mon Nov 19 16:35:39 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024463.html">[mod_python] How declared correctly the way in the pg.html to the
	apache server can resolv the script python correctly
</A></li>
        <LI>Next message: <A HREF="024465.html">[mod_python] How declared correctly the way in the pg.html to
	the apache server can resolv the script python correctly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24464">[ date ]</a>
              <a href="thread.html#24464">[ thread ]</a>
              <a href="subject.html#24464">[ subject ]</a>
              <a href="author.html#24464">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Well, it's been a while, but my boss has nudged me into posting the fix 
we came up with for this issue.  Just y'know, in the interests of 
closure, and in case somebody else is trying something similar.  The 
working code looks like:

from mod_python import apache

import os

def handler(request):
    #request.content_type = &quot;text/plain&quot;
    content_length = int(request.headers_in[&quot;Content-Length&quot;])
    outPath = &quot;/home/vphill/test/upload_out.dat&quot;
    outFile = open(outPath, &quot;w&quot;)
    conn = request.connection
    i = 0
    buf = &quot;&quot;
    while i &lt; content_length:
        c = conn.read()
        if c == &quot;&quot;:
            break
        buf = buf + c
        if len(buf) &gt;= 102400:
            outFile.write(buf)
            outFile.flush()
            buf = &quot;&quot;
        i += len(c)
    if len(buf):
        outFile.write(buf)
        outFile.flush()
    outFile.close()
    talkBack = &quot;Recieved %s bytes\n&quot; % os.stat(outPath).st_size
    request.set_content_length(len(talkBack))
    request.write(talkBack)
    return apache.OK

We've had success using it (with curl as the sender) to receive files exceeding 2 GB in size.

So it just goes to show, if the programmer can't fix it, let the librarian look at it.

Hope this helps someone.



Graham Dumpleton wrote:
&gt;<i> Read one byte at a time is exceedingly inefficient. Rather than
</I>&gt;<i> reinvent the wheel, perhaps look at Tramline.
</I>&gt;<i>
</I>&gt;<i>   <A HREF="http://www.infrae.com/products/tramline">http://www.infrae.com/products/tramline</A>
</I>&gt;<i>
</I>&gt;<i> Personally I don't believe that Python is a good way of doing this and
</I>&gt;<i> for best performance it should be done as an Apache module in C code.
</I>&gt;<i> At least though the Tramline approach is more efficient than your
</I>&gt;<i> current approach.
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> On 19/10/2007, Kurt Nordstrom &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">knordstrom at library.unt.edu</A>&gt; wrote:
</I>&gt;<i>   
</I>&gt;&gt;<i> We're working on a webapp that will need to receive, from its clients,
</I>&gt;&gt;<i> fairly large files (it's an archival storage system).  The logical way
</I>&gt;&gt;<i> to do this seems to be to use http PUT, with appropriate code on the
</I>&gt;&gt;<i> server side to store the file to the proper place.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Borrowing and modifying some code posted back in '05 to this list by a
</I>&gt;&gt;<i> Jeremy Jones, I have been playing with this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> from mod_python import apache
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> import os
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> def handler(request):
</I>&gt;&gt;<i>     #request.content_type = &quot;text/plain&quot;
</I>&gt;&gt;<i>     content_length = int(request.headers_in[&quot;Content-Length&quot;])
</I>&gt;&gt;<i>     outPath = &quot;/home/webtmp/upload_out.dat&quot;
</I>&gt;&gt;<i>     outFile = open(outPath, &quot;w&quot;)
</I>&gt;&gt;<i>     conn = request.connection
</I>&gt;&gt;<i>     i = 0
</I>&gt;&gt;<i>     buf = &quot;&quot;
</I>&gt;&gt;<i>     while i &lt; content_length:
</I>&gt;&gt;<i>         c = conn.read(1)
</I>&gt;&gt;<i>         if c == &quot;&quot;:
</I>&gt;&gt;<i>             break
</I>&gt;&gt;<i>         buf = buf + c
</I>&gt;&gt;<i>         if len(buf) &gt;= 102400:
</I>&gt;&gt;<i>             outFile.write(buf)
</I>&gt;&gt;<i>             outFile.flush()
</I>&gt;&gt;<i>             buf = &quot;&quot;
</I>&gt;&gt;<i>         i += 1
</I>&gt;&gt;<i>     if len(buf):
</I>&gt;&gt;<i>         outFile.write(buf)
</I>&gt;&gt;<i>         outFile.flush()
</I>&gt;&gt;<i>     outFile.close()
</I>&gt;&gt;<i>     talkBack = &quot;Recieved %s bytes\n&quot; % os.stat(outPath).st_size
</I>&gt;&gt;<i>     request.set_content_length(len(talkBack))
</I>&gt;&gt;<i>     request.write(talkBack)
</I>&gt;&gt;<i>     return apache.OK
</I>&gt;&gt;<i>     
</I>

-- 
===
Kurt Nordstrom
Programmer
University of North Texas Libraries
Digital Projects Unit
(940) 891-6747

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024463.html">[mod_python] How declared correctly the way in the pg.html to the
	apache server can resolv the script python correctly
</A></li>
	<LI>Next message: <A HREF="024465.html">[mod_python] How declared correctly the way in the pg.html to
	the apache server can resolv the script python correctly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24464">[ date ]</a>
              <a href="thread.html#24464">[ thread ]</a>
              <a href="subject.html#24464">[ subject ]</a>
              <a href="author.html#24464">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
