<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Session Hanging Problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20Hanging%20Problems&In-Reply-To=223DABED-F63D-45B0-B1CF-B8F6A75E8E2A%40octopart.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024518.html">
   <LINK REL="Next"  HREF="024521.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Session Hanging Problems</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20Hanging%20Problems&In-Reply-To=223DABED-F63D-45B0-B1CF-B8F6A75E8E2A%40octopart.com"
       TITLE="[mod_python] Session Hanging Problems">graham.dumpleton at gmail.com
       </A><BR>
    <I>Mon Nov 26 16:38:57 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024518.html">[mod_python] Session Hanging Problems
</A></li>
        <LI>Next message: <A HREF="024521.html">[mod_python] Session Hanging Problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24520">[ date ]</a>
              <a href="thread.html#24520">[ thread ]</a>
              <a href="subject.html#24520">[ subject ]</a>
              <a href="author.html#24520">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/11/2007, Harish Agarwal &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">harish at octopart.com</A>&gt; wrote:
&gt;<i> I'm using session handling with ModPython 3.3.1.  Originally I was
</I>&gt;<i> using DbmSession and have since transitioned to a custom MySQL Session
</I>&gt;<i> handler.  With both session types, however, I've noticed that session
</I>&gt;<i> initialization intermittently hangs (not forever, but takes as long as
</I>&gt;<i> four minutes to complete), at a low-ish (a handful of times every
</I>&gt;<i> hour, while receiving, say, on order of a thousand or so requests
</I>&gt;<i> every hour) frequency which seems to scale with the amount of traffic
</I>&gt;<i> we're receiving.  I had read that long DbmSession cleanups can cause
</I>&gt;<i> problems, which is why I transitioned to the MySQL system, which takes
</I>&gt;<i> &lt; 1 second to complete, but I'm still noticing the long session init
</I>&gt;<i> times.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I put some debugging statements into the code and it seems to be
</I>&gt;<i> related to session locking.  In particular, it is this function call
</I>&gt;<i> in the lock method of the BaseSession class:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _apache._global_lock(self._req.server, self._sid)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> which is taking some time to complete. I'm not familiar with
</I>&gt;<i> _apache._global_lock (is it used to apply a mutex lock to the
</I>&gt;<i> session?) and am having trouble finding information describing its
</I>&gt;<i> usage - but it seems likely that this is the root cause.  In the past
</I>&gt;<i> I've had problems with session locking but have since transitioned the
</I>&gt;<i> code to ensure that only one session is created per request, as such:
</I>&gt;<i>
</I>&gt;<i> if not hasattr(req,'session'):
</I>&gt;<i>              req.session = Session.MySQLSession(req)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Can anyone tell me if this kind of behavior is normal or is indicative
</I>&gt;<i> of some common configuration or coding error?  Any help would be
</I>&gt;<i> greatly appreciated.
</I>
Ignoring hangs, how long does your longest request normally take to
execute? Are you perhaps performing file uploads that take a
significant amount of time and are holding a session locked for the
whole period of the request?

To at least allow some level of concurrency, from memory mod_python
holds a small pool of cross process mutex locks. Based on the session
ID (I think) it should consistently pick the same mutex lock each
time. Thus, if a request comes in with the same session ID it would be
blocked while the existing request for that session runs. If however
another request comes in with a different session ID, but where it
maps to the same mutex lock from the pool, it will also be blocked
until the request holding that lock has completed.

What this means is that the number of mutex locks in the pool
effectively dictates how many parallel session based requests you can
have executed across the whole of the Apache server. Thus, if you have
requests that take a long time while still holding the session lock,
it can lock out other requests until it completes.

One can makes things a bit better by increasing the number of mutex
locks in the pool, but you have to be careful not to create too many
in case it is using sysvsem and your OS doesn't allocate enough.

The only other thing to do is to release the lock explicitly as soon
as you no longer need it and don't rely on the cleanup handler for the
request to unlock it.

In other words, what your application is doing, your own code and how
you have written it could be the problem, and not necessarily
mod_python itself.

If my memory has totally faded and my description is wrong, someone
please correct me. :-)

Graham
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024518.html">[mod_python] Session Hanging Problems
</A></li>
	<LI>Next message: <A HREF="024521.html">[mod_python] Session Hanging Problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24520">[ date ]</a>
              <a href="thread.html#24520">[ thread ]</a>
              <a href="subject.html#24520">[ subject ]</a>
              <a href="author.html#24520">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
