<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Session Hanging Problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20Hanging%20Problems&In-Reply-To=21e523c20711261150u5095ca9di4f95d125607df510%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024515.html">
   <LINK REL="Next"  HREF="024518.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Session Hanging Problems</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Harish Agarwal</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20Hanging%20Problems&In-Reply-To=21e523c20711261150u5095ca9di4f95d125607df510%40mail.gmail.com"
       TITLE="[mod_python] Session Hanging Problems">harish at octopart.com
       </A><BR>
    <I>Mon Nov 26 15:08:28 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024515.html">[mod_python] Session Hanging Problems
</A></li>
        <LI>Next message: <A HREF="024518.html">[mod_python] Session Hanging Problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24517">[ date ]</a>
              <a href="thread.html#24517">[ thread ]</a>
              <a href="subject.html#24517">[ subject ]</a>
              <a href="author.html#24517">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Not sure if this helps at all, but I'm noticing that when the problem  
appears, it affects all of the incoming requests for a short  
duration.  The time logged to complete the call to  
_apache._global_lock decreases with each subsequent 'hung' request.

For instance, the last time I noticed a hang in the log files, the  
first hang took about 1000 seconds to complete (the hanging is getting  
much worse today as traffic has picked up after Thanksgiving), and the  
last hang in the 'batch' took about 70 seconds to complete.  The log  
statements were all printed out at more or less the same time, which  
makes me suspect that the requests came in at various points during  
the hang, which lasted a total of 1000 seconds, and then the hang was  
resolved at the same time for each one, at which point the log  
statements were printed.

I didn't have any problems accessing the site during this period of  
time, but that could be because I didn't hit the particular mod_python  
interpreter which was hanging.


Harish


On Nov 26, 2007, at 11:50 AM, David Janes wrote:

&gt;<i> I'd be certainly interested in a non-mod_python session handler, since
</I>&gt;<i> I'm suspecting we'll be going to a non-Apache solution soon (since we
</I>&gt;<i> don't really take advantage of any Apache features right now) and we
</I>&gt;<i> were considering writing a generic one -- or adapting mod_python's
</I>&gt;<i> handlers.
</I>&gt;<i>
</I>&gt;<i> On the other hand as Harish notes, it would be good to solve the
</I>&gt;<i> problem for mod_python as mod_python's been very good to us! I'm
</I>&gt;<i> wondering if there's any need at all to touch the Apache global lock
</I>&gt;<i> anyway, or if it can worked around another way.
</I>&gt;<i>
</I>&gt;<i> Regards, etc...
</I>&gt;<i>
</I>&gt;<i> PS: this is what I'm working on right now:
</I>&gt;<i> <A HREF="http://www.onaswarm.com">http://www.onaswarm.com</A>
</I>&gt;<i>
</I>&gt;<i> On Nov 26, 2007 2:21 PM, David Lenwell &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">dlenwell at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> yeah .. its very broken for me too .. What I am working on is my own
</I>&gt;&gt;<i> session handler.. I don't feel that mysql is a valid replacement
</I>&gt;&gt;<i> because it puts unnecessary load on your database server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We are debating on open sourcing the code I am working on. if I win
</I>&gt;&gt;<i> the argument that open source can be good for us then I will
</I>&gt;&gt;<i> contribute my code to the project.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Nov 26, 2007, at 10:55 AM, David Janes wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> All I can say is &quot;we too&quot; -- we're using FileSession. We have not  
</I>&gt;&gt;&gt;<i> been
</I>&gt;&gt;&gt;<i> able to come up with a cure, though we've minimized use of sessions
</I>&gt;&gt;&gt;<i> which brings the frequency down significantly.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Regards, etc...
</I>&gt;&gt;&gt;<i> David
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Nov 26, 2007 1:39 PM, Harish Agarwal &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">harish at octopart.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i> I'm using session handling with ModPython 3.3.1.  Originally I was
</I>&gt;&gt;&gt;&gt;<i> using DbmSession and have since transitioned to a custom MySQL
</I>&gt;&gt;&gt;&gt;<i> Session
</I>&gt;&gt;&gt;&gt;<i> handler.  With both session types, however, I've noticed that  
</I>&gt;&gt;&gt;&gt;<i> session
</I>&gt;&gt;&gt;&gt;<i> initialization intermittently hangs (not forever, but takes as long
</I>&gt;&gt;&gt;&gt;<i> as
</I>&gt;&gt;&gt;&gt;<i> four minutes to complete), at a low-ish (a handful of times every
</I>&gt;&gt;&gt;&gt;<i> hour, while receiving, say, on order of a thousand or so requests
</I>&gt;&gt;&gt;&gt;<i> every hour) frequency which seems to scale with the amount of  
</I>&gt;&gt;&gt;&gt;<i> traffic
</I>&gt;&gt;&gt;&gt;<i> we're receiving.  I had read that long DbmSession cleanups can  
</I>&gt;&gt;&gt;&gt;<i> cause
</I>&gt;&gt;&gt;&gt;<i> problems, which is why I transitioned to the MySQL system, which
</I>&gt;&gt;&gt;&gt;<i> takes
</I>&gt;&gt;&gt;&gt;<i> &lt; 1 second to complete, but I'm still noticing the long session  
</I>&gt;&gt;&gt;&gt;<i> init
</I>&gt;&gt;&gt;&gt;<i> times.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I put some debugging statements into the code and it seems to be
</I>&gt;&gt;&gt;&gt;<i> related to session locking.  In particular, it is this function  
</I>&gt;&gt;&gt;&gt;<i> call
</I>&gt;&gt;&gt;&gt;<i> in the lock method of the BaseSession class:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> _apache._global_lock(self._req.server, self._sid)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> which is taking some time to complete. I'm not familiar with
</I>&gt;&gt;&gt;&gt;<i> _apache._global_lock (is it used to apply a mutex lock to the
</I>&gt;&gt;&gt;&gt;<i> session?) and am having trouble finding information describing its
</I>&gt;&gt;&gt;&gt;<i> usage - but it seems likely that this is the root cause.  In the  
</I>&gt;&gt;&gt;&gt;<i> past
</I>&gt;&gt;&gt;&gt;<i> I've had problems with session locking but have since transitioned
</I>&gt;&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;&gt;<i> code to ensure that only one session is created per request, as  
</I>&gt;&gt;&gt;&gt;<i> such:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> if not hasattr(req,'session'):
</I>&gt;&gt;&gt;&gt;<i>            req.session = Session.MySQLSession(req)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Can anyone tell me if this kind of behavior is normal or is
</I>&gt;&gt;&gt;&gt;<i> indicative
</I>&gt;&gt;&gt;&gt;<i> of some common configuration or coding error?  Any help would be
</I>&gt;&gt;&gt;&gt;<i> greatly appreciated.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;&gt;<i> -Harish
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> --
</I>&gt;&gt;&gt;<i> David Janes
</I>&gt;&gt;&gt;<i> Founder, BlogMatrix
</I>&gt;&gt;&gt;<i> <A HREF="http://www.blogmatrix.com">http://www.blogmatrix.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://blogmatrix.blogmatrix.com">http://blogmatrix.blogmatrix.com</A>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i> David Janes
</I>&gt;<i> Founder, BlogMatrix
</I>&gt;<i> <A HREF="http://www.blogmatrix.com">http://www.blogmatrix.com</A>
</I>&gt;<i> <A HREF="http://blogmatrix.blogmatrix.com">http://blogmatrix.blogmatrix.com</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024515.html">[mod_python] Session Hanging Problems
</A></li>
	<LI>Next message: <A HREF="024518.html">[mod_python] Session Hanging Problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24517">[ date ]</a>
              <a href="thread.html#24517">[ thread ]</a>
              <a href="subject.html#24517">[ subject ]</a>
              <a href="author.html#24517">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
