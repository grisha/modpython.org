<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] mod_python or apache scalability?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20or%20apache%20scalability%3F&In-Reply-To=88e286470711040248l4a436c9awaa8bb1417e47e42a%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024402.html">
   <LINK REL="Next"  HREF="024404.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] mod_python or apache scalability?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Martijn Moeling</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20or%20apache%20scalability%3F&In-Reply-To=88e286470711040248l4a436c9awaa8bb1417e47e42a%40mail.gmail.com"
       TITLE="[mod_python] mod_python or apache scalability?">martijn at xs4us.nu
       </A><BR>
    <I>Sun Nov  4 08:16:23 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024402.html">[mod_python] mod_python or apache scalability?
</A></li>
        <LI>Next message: <A HREF="024404.html">[mod_python] mod_python or apache scalability?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24403">[ date ]</a>
              <a href="thread.html#24403">[ thread ]</a>
              <a href="subject.html#24403">[ subject ]</a>
              <a href="author.html#24403">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi,

I use Pil without any problems, a I do with MySQLdb.

I had similair problems however, they turned out to be MySQLdb  
related and not in a way you suspect

Never ever use a global database connection variable. Create the  
database connection within your handler,
end register a cleanup for closing it. I fixed a lot of trouble by  
altering my system by making all &quot;global&quot; stuff a method or property  
of the req object.

The cleanup procedure cleans all objects which do anything to 3rd  
party external (net connected) stuff (like imap, MySQL)


think of something like this:


def handler_cleanup(req):
	req.db.cursor.close()
	req.db.close()

Def handler (req):
	req.db=MySQLdb.connection(...........)
	req.cursor=req.db.cursor(...)

	....
	....
	....
	req.register_cleanup(handler_cleanup,req)
	return apache.OK

All my application specific code are classes, and instantated as a  
req.something and req is passed to all functions, which is neat since  
it is passed by reference meaning stacks stay small to

If you use MySQLdb with mod_python use the above method, my  
production server is rock stable and handled over 1mln requests since  
last december without any reboots or problems.

Martijn

On Nov 4, 2007, at 11:48 AM, Graham Dumpleton wrote:

&gt;<i> Hmmm, I do remember vaguely hearing questions about PIL thread safety
</I>&gt;<i> before, so it might be an issue. :-(
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> On 04/11/2007, Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at matusis.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> BTW, are you still using mod_python 3.1.4?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> No, we went to apache 2.2.6/ mod_python 3.3.1 combination.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I will get MySQLdb to work thread-safely, but with PIL I am not so
</I>&gt;&gt;<i> optimistic...
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;<i> From: Graham Dumpleton [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>]
</I>&gt;&gt;&gt;<i> Sent: Sunday, November 04, 2007 2:33 AM
</I>&gt;&gt;&gt;<i> To: Alec Matusis
</I>&gt;&gt;&gt;<i> Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;&gt;&gt;<i> Subject: Re: [mod_python] mod_python or apache scalability?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> BTW, are you still using mod_python 3.1.4? Older mod_python versions
</I>&gt;&gt;&gt;<i> have various bugs and you would be much better upgrading to 3.3.1 if
</I>&gt;&gt;&gt;<i> you haven't already.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 04/11/2007, Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at matusis.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Which indicates that some third party package you are using is not
</I>&gt;&gt;&gt;&gt;&gt;<i> thread safe. This can occur if you are also using PHP as  
</I>&gt;&gt;&gt;&gt;&gt;<i> various of
</I>&gt;&gt;&gt;&gt;&gt;<i> its third party packages are not thread safe.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> We are not using PHP, only python with mod_python.
</I>&gt;&gt;&gt;&gt;<i> The only third party packages we use are MySQLdb adapter and PIL
</I>&gt;&gt;&gt;<i> image
</I>&gt;&gt;&gt;&gt;<i> library.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> So I guess both PIL and MySQLdb have these problems.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;&gt;&gt;<i> From: Graham Dumpleton [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>]
</I>&gt;&gt;&gt;&gt;&gt;<i> Sent: Sunday, November 04, 2007 2:15 AM
</I>&gt;&gt;&gt;&gt;&gt;<i> To: Alec Matusis
</I>&gt;&gt;&gt;&gt;&gt;<i> Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> Subject: Re: [mod_python] mod_python or apache scalability?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On 04/11/2007, Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at matusis.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> FWIW, I personally would try and move from prefork to worker
</I>&gt;&gt;&gt;<i> MPM as
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> the number of Apache child processes you are running with is to
</I>&gt;&gt;&gt;<i> my
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> mind excessive. Using worker would certainly drop memory usage
</I>&gt;&gt;&gt;<i> for
</I>&gt;&gt;&gt;&gt;&gt;<i> a
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> start as you wouldn't need as many child processes to be
</I>&gt;&gt;&gt;<i> started.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> I am just following up on this, since we tried worker MPM this
</I>&gt;&gt;&gt;&gt;&gt;<i> weekend.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> On our dev/stage it worked perfectly.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> On live, worker MPM freed up about 2GB of memory compared to
</I>&gt;&gt;&gt;<i> prefork.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> However, on live, it turned out to be unstable.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> This is what we say in the main error log:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> [Sun Nov 04 01:37:45 2007] [notice] child pid 20347 exit signal
</I>&gt;&gt;&gt;&gt;&gt;<i> Segmentation
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> fault (11)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> [Sun Nov 04 01:37:45 2007] [notice] child pid 20460 exit signal
</I>&gt;&gt;&gt;&gt;&gt;<i> Aborted (6)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> [Sun Nov 04 01:37:45 2007] [notice] child pid 20515 exit signal
</I>&gt;&gt;&gt;&gt;&gt;<i> Segmentation
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> fault (11)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> *** glibc detected *** double free or corruption (!prev):
</I>&gt;&gt;&gt;&gt;&gt;<i> 0x0000000000762c50
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> ***
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> *** glibc detected *** double free or corruption (!prev):
</I>&gt;&gt;&gt;&gt;&gt;<i> 0x000000000075d100
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> ***
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> [Sun Nov 04 01:37:46 2007] [notice] child pid 20152 exit signal
</I>&gt;&gt;&gt;&gt;&gt;<i> Segmentation
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> fault (11)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> In the application log, we saw two types of errors:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> MySQLError: Connection to database failed
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> OperationalError: (2006, 'MySQL server has gone away')
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> and
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> IOError: image file is truncated (44 bytes not processed)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> The first type has to do with MySQLdb module, but the second one
</I>&gt;&gt;&gt;&gt;&gt;<i> occurred
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> when large images were uploaded.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Which indicates that some third party package you are using is not
</I>&gt;&gt;&gt;&gt;&gt;<i> thread safe. This can occur if you are also using PHP as  
</I>&gt;&gt;&gt;&gt;&gt;<i> various of
</I>&gt;&gt;&gt;&gt;&gt;<i> its third party packages are not thread safe. Also ensure that you
</I>&gt;&gt;&gt;<i> are
</I>&gt;&gt;&gt;&gt;&gt;<i> using the latest available Python database adapters and that they
</I>&gt;&gt;&gt;<i> are
</I>&gt;&gt;&gt;&gt;&gt;<i> compiled against thread safe reentrant libraries.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> We had to revert to prefork as a result of this.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> On another note, I managed to empirically find the maximum
</I>&gt;&gt;&gt;&gt;&gt;<i> ServerLimit for
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> prefork, before the machine dies from swapping.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> It is 380 with 4GB RAM.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> From: Graham Dumpleton [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>]
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Sent: Monday, October 01, 2007 6:47 PM
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> To: Alec Matusis
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Subject: Re: [mod_python] mod_python or apache scalability?
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> On 01/10/2007, Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at matusis.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> in the apache error log. We also got
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> kernel: possible SYN flooding on port 80. Sending cookies.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> in /var/log/messages system log.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Have you determined for certain that you aren't the target of
</I>&gt;&gt;&gt;<i> an
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> external SYN Flood DOS attack?
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Do a Google search for 'kernel: possible SYN flooding on port
</I>&gt;&gt;&gt;<i> 80.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Sending cookies' and you will find lots of stuff to read. Your
</I>&gt;&gt;&gt;&gt;&gt;<i> running
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> out of or having a large number of socket connections may be
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> symptomatic of a large number of half open connections being
</I>&gt;&gt;&gt;&gt;&gt;<i> created
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> and then being left in TIME_WAIT. Thus perhaps do some better
</I>&gt;&gt;&gt;&gt;&gt;<i> analysis
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> of socket connection states using netstat. If not a SYN Flood,
</I>&gt;&gt;&gt;<i> then
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> possibly follow some of the other suggestions in the pages you
</I>&gt;&gt;&gt;<i> will
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> find when you do the search.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> FWIW, I personally would try and move from prefork to worker
</I>&gt;&gt;&gt;<i> MPM as
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> the number of Apache child processes you are running with is to
</I>&gt;&gt;&gt;<i> my
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> mind excessive. Using worker would certainly drop memory usage
</I>&gt;&gt;&gt;<i> for
</I>&gt;&gt;&gt;&gt;&gt;<i> a
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> start as you wouldn't need as many child processes to be
</I>&gt;&gt;&gt;<i> started. I
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> wouldn't be concerned about running out of threads as when
</I>&gt;&gt;&gt;<i> running
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> worker I wouldn't suggest more than 25 threads per process as a
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> starting point anyway. If your mod_python application was
</I>&gt;&gt;&gt;<i> creating
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> lots of threads, you are likely to hit the thread limit with
</I>&gt;&gt;&gt;&gt;&gt;<i> prefork
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> and not just worker so which MPM is used shouldn't be an issue
</I>&gt;&gt;&gt;<i> in
</I>&gt;&gt;&gt;&gt;&gt;<i> that
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> case.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> BTW, what operating system are you using?
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024402.html">[mod_python] mod_python or apache scalability?
</A></li>
	<LI>Next message: <A HREF="024404.html">[mod_python] mod_python or apache scalability?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24403">[ date ]</a>
              <a href="thread.html#24403">[ thread ]</a>
              <a href="subject.html#24403">[ subject ]</a>
              <a href="author.html#24403">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
