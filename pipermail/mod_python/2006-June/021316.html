<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Initial configuration and persistence
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Initial%20configuration%20and%20persistence&In-Reply-To=200606051616.43515.richardlewis%40fastmail.co.uk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021314.html">
   <LINK REL="Next"  HREF="021324.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Initial configuration and persistence</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jim Gallacher</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Initial%20configuration%20and%20persistence&In-Reply-To=200606051616.43515.richardlewis%40fastmail.co.uk"
       TITLE="[mod_python] Initial configuration and persistence">jpg at jgassociates.ca
       </A><BR>
    <I>Mon Jun  5 13:55:03 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021314.html">[mod_python] Initial configuration and persistence
</A></li>
        <LI>Next message: <A HREF="021324.html">[mod_python] Initial configuration and persistence
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21316">[ date ]</a>
              <a href="thread.html#21316">[ thread ]</a>
              <a href="subject.html#21316">[ subject ]</a>
              <a href="author.html#21316">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Richard Lewis wrote:
&gt;<i> Hi there,
</I>&gt;<i> 
</I>&gt;<i> I'm new to mod_python and have nearly finished writing a module implementing a 
</I>&gt;<i> subset of Apache Cocoon's functionaiity, providing URI pattern matching, 
</I>&gt;<i> Berkeley DB XML-powered XQuery and libxslt-powered XSLT transformations.
</I>&gt;<i> 
</I>&gt;<i> There are a couple of things I'm stuck on, though.
</I>&gt;<i> 
</I>&gt;<i> My handler works fine when tested from the command line and it also works from 
</I>&gt;<i> Apache when I include my special XML configuration file directly in the 
</I>&gt;<i> handler source code. However, I'd like to be able to have the configuration 
</I>&gt;<i> file separate from the handler source code so that I can use the handler 
</I>&gt;<i> unaltered for multiple sites.
</I>&gt;<i> 
</I>&gt;<i> What I can't do is work out how to pass the file name of the XML configuration 
</I>&gt;<i> file as a parameter to mod_python from my Apache configuration file when my 
</I>&gt;<i> handler is initially loaded. I've added an Apache SetEnv directive and I can 
</I>&gt;<i> see it from apache.config_tree() but I can't work out how to get its value.
</I>&gt;<i> 
</I>&gt;<i> My VirtualHost configuration currently looks like this:
</I>&gt;<i> 
</I>&gt;<i> NameVirtualHost *
</I>&gt;<i> &lt;VirtualHost *&gt;
</I>&gt;<i>     ServerName www.studios.uea.ac.uk
</I>&gt;<i>     DocumentRoot /var/www-studio
</I>&gt;<i>     SetHandler mod_python
</I>&gt;<i>     PythonDebug On
</I>&gt;<i> 
</I>&gt;<i>     &lt;Directory /var/www-studio&gt;
</I>&gt;<i>         SetEnv sitemap_config sitemap.xml
</I>&gt;<i>         PythonHandler sitemap
</I>&gt;<i>     &lt;/Directory&gt;
</I>&gt;<i> &lt;/VirtualHost&gt;
</I>&gt;<i> 
</I>&gt;<i> Any ideas how to get that SetEnv's value from inside sitemap.py?
</I>
Use
     req.add_common_vars()
     env_dict = req.subprocess_env

Note that the keys in subprocess_env will be pre-pended with REDIRECT_ 
if you do an internal redirect.

Another option would be to use PythonOption.
     PythonOption yournamespace.config /path/to/config

and retrieve with
    option_dict = req.get_options()

Note that both of these are only usable when the request is being 
processed, not when the module is being imported. You could have your 
handler check if everything is initialized before proceeding. A more 
transparent way would be to do this check in an earlier phase such as 
PythonFixupHandler. That way it will be transparent to your handler.

&gt;<i> The other thing I'm stuck on is implementing persistence. I currently have my 
</I>&gt;<i> DB XML manager, some compiled XSLT stylesheets and other configuration data 
</I>&gt;<i> stored as global variables in my handler. However, from my Apache log, it 
</I>&gt;<i> looks as though it reloads my handler module every time a request is made, 
</I>&gt;<i> thus reloading the database connection, re-compiling the stylesheets etc. 
</I>&gt;<i> when I'd rather they just persisted between requests. Is there a way of 
</I>&gt;<i> making them persist? Or is it just my imagination that they are being 
</I>&gt;<i> reloaded?
</I>
You can turn off reloading with &quot;PythonAutoReload Off&quot;.

Persistence is tricky, depending on which apache-mpm you are using. For 
mpm-worker or mpm-prefork you'll have multiple processes, each with it's 
own interpreter. You can cache data at the module level, but recognize 
that you may have multiple copies of that data - changes in the data in 
one interpreter will not be reflected in another.

Modules loaded with the standard python import statement will not be 
reloaded by mod_python. That combined with the fact that each 
interpreter gets it's own namespace may open some other options for you. 
Something like this may work, but it is totally untested:

For each VirtualHost (n) in your apache config:

PythonPath &quot;['/path/to/site/virtualhost-n'] + sys.path&quot;

Each virtualhost gets its own siteconfig.py, but in directory virutalhost-n

In your handler module use:

import siteconfig

Hopefully (I did say untested, right?) each interpreter will import the 
correct siteconfig module. You could the use that same module for 
caching bits of data. The drawback is that you'll need to restart apache 
when you make any changes to siteconfig.py

Either way, you'll need to make sure you are accessing your module data 
in a thread-safe manner for mpm-worker.

Jim

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021314.html">[mod_python] Initial configuration and persistence
</A></li>
	<LI>Next message: <A HREF="021324.html">[mod_python] Initial configuration and persistence
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21316">[ date ]</a>
              <a href="thread.html#21316">[ thread ]</a>
              <a href="subject.html#21316">[ subject ]</a>
              <a href="author.html#21316">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
