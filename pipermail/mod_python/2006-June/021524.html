<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] COM errors on Win2K3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20COM%20errors%20on%20Win2K3&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021523.html">
   <LINK REL="Next"  HREF="021526.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] COM errors on Win2K3</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20COM%20errors%20on%20Win2K3&In-Reply-To="
       TITLE="[mod_python] COM errors on Win2K3">grahamd at dscpl.com.au
       </A><BR>
    <I>Thu Jun 29 18:43:00 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021523.html">[mod_python] COM errors on Win2K3
</A></li>
        <LI>Next message: <A HREF="021526.html">[mod_python] Problem with Mod Python Appending HTML
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21524">[ date ]</a>
              <a href="thread.html#21524">[ thread ]</a>
              <a href="subject.html#21524">[ subject ]</a>
              <a href="author.html#21524">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>douglas savitsky wrote ..
&gt;<i> I have an application that runs on mod_python/apache using the publisher
</I>&gt;<i> handler.  It uses an Access db as the backend (yes, I know, but the
</I>&gt;<i> amount of data is small so it should be fine) and connects via ADO.
</I>&gt;<i> In a
</I>&gt;<i> test environment on XP it runs fine, but when on a win2k3 server it will
</I>&gt;<i> load one page, but all subsequent page loads throw a
</I>&gt;<i> pythoncom.CoInitialize error until I restart the apache.
</I>&gt;<i> 
</I>&gt;<i> The structure is that the python script imports a module that contains
</I>&gt;<i> the ADO code.
</I>&gt;<i> 
</I>&gt;<i> Presumably, this is a threading issue, but I am not sure what the best
</I>&gt;<i> approach to fixing it is.  I tried putting
</I>&gt;<i> pythoncom.CoInitialize/pythoncom.CoUninitialize calls in the __init__
</I>&gt;<i> and __del__ methods of the modules, but this did not work. 
</I>
Modules do not have __init__ and __del__ methods, so that cannot work.

If you need to ensure that a specific bit of code is executed when Apache
starts up and that it is only executed once, you should stick it in a module
of its own and then use the PythonImport directive to tell mod_python
that that module should be loaded right at the start when mod_python
is initialised and before any requests are processed.

The code you put in this special module should be executed as a side
effect of the module import itself. In that way it acts like an __init__
method although there is not one. There is no safe way to have the
equivalent of __del__. Ie., no way you can have special code run when
Apache is being shutdown. Before you think that apache.register_cleanup()
or req.server.register_cleanup() might do it, it will not as that code has
been found to be unreliable and can cause Apache child process to
lock up on shutdown.

Also note that this special module imported using PythonImport should
not contain any handlers and should NOT be imported from handler code
using apache.import_module() otherwise it might be reloaded at run time
with initialisation then being performed more than once. Thus, use &quot;import&quot;
to import it instead. It is possible to have code within the module to protect
against reloading issues, but simply best to avoid it in the first place.

Graham

&gt;<i> Is this
</I>&gt;<i> something that needs to be done at a lower level? Should I wrap every
</I>&gt;<i> COM call or can I turn off threading somewhere?
</I>&gt;<i> 
</I>&gt;<i> This is mod_python 3.2, Python 2.3.5, apache2.0.*, win2k3, ado 2.8, and
</I>&gt;<i> the
</I>&gt;<i> server has 2 processors in case that matters.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The error I get is:
</I>&gt;<i> 
</I>&gt;<i> Mod_python error: &quot;PythonHandler mod_python.publisher&quot;
</I>&gt;<i> 
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i> 
</I>&gt;<i>   File &quot;C:\Python23\Lib\site-packages\mod_python\apache.py&quot;, line 299,
</I>&gt;<i> in
</I>&gt;<i> HandlerDispatch
</I>&gt;<i>     result = object(req)
</I>&gt;<i> 
</I>&gt;<i>   File &quot;C:\Python23\Lib\site-packages\mod_python\publisher.py&quot;, line 213,
</I>&gt;<i> in
</I>&gt;<i> handler
</I>&gt;<i>     published = publish_object(req, object)
</I>&gt;<i> 
</I>&gt;<i>   File &quot;C:\Python23\Lib\site-packages\mod_python\publisher.py&quot;, line 410,
</I>&gt;<i> in
</I>&gt;<i> publish_object
</I>&gt;<i>     return publish_object(req,util.apply_fs_data(object, req.form, req=req))
</I>&gt;<i> 
</I>&gt;<i>   File &quot;C:\Python23\Lib\site-packages\mod_python\util.py&quot;, line 439, in
</I>&gt;<i> apply_fs_data
</I>&gt;<i>     return object(**args)
</I>&gt;<i> 
</I>&gt;<i>   File &quot;E:\http_server\timeslips\index.py&quot;, line 84, in index
</I>&gt;<i>     rtn.append(ts_widget.make_employee_picker())
</I>&gt;<i> 
</I>&gt;<i>   File &quot;C:\Python23\lib\site-packages\ecptimeslips\ts_widget.py&quot;, line
</I>&gt;<i> 128,
</I>&gt;<i> in make_employee_picker
</I>&gt;<i>     rs = win32com.client.Dispatch(&quot;ADODB.Recordset&quot;)
</I>&gt;<i> 
</I>&gt;<i>   File &quot;C:\Python23\Lib\site-packages\win32com\client\__init__.py&quot;, line
</I>&gt;<i> 95,
</I>&gt;<i> in Dispatch
</I>&gt;<i>     dispatch, userName =
</I>&gt;<i> dynamic._GetGoodDispatchAndUserName(dispatch,userName,clsctx)
</I>&gt;<i> 
</I>&gt;<i>   File &quot;C:\Python23\Lib\site-packages\win32com\client\dynamic.py&quot;, line
</I>&gt;<i> 91,
</I>&gt;<i> in _GetGoodDispatchAndUserName
</I>&gt;<i>     return (_GetGoodDispatch(IDispatch, clsctx), userName)
</I>&gt;<i> 
</I>&gt;<i>   File &quot;C:\Python23\Lib\site-packages\win32com\client\dynamic.py&quot;, line
</I>&gt;<i> 79,
</I>&gt;<i> in _GetGoodDispatch
</I>&gt;<i>     IDispatch = pythoncom.CoCreateInstance(IDispatch, None, clsctx,
</I>&gt;<i> pythoncom.IID_IDispatch)
</I>&gt;<i> 
</I>&gt;<i> com_error: (-2147221008, 'CoInitialize has not been called.', None, None)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Even more strangely, with IE it will work for a bit and then die (but
</I>&gt;<i> only for one user), with Firefox it never works, and with Mozilla it
</I>&gt;<i> is in the middle -- maybe one page and then an error.
</I>&gt;<i> 
</I>&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> -d
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021523.html">[mod_python] COM errors on Win2K3
</A></li>
	<LI>Next message: <A HREF="021526.html">[mod_python] Problem with Mod Python Appending HTML
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21524">[ date ]</a>
              <a href="thread.html#21524">[ thread ]</a>
              <a href="subject.html#21524">[ subject ]</a>
              <a href="author.html#21524">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
