<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] kernel panic - Attempting to free lock with active
	waiting queue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20kernel%20panic%20-%20Attempting%20to%20free%20lock%20with%20active%0A%09waiting%20queue&In-Reply-To=42FB98A2.7070501%40sympatico.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018825.html">
   <LINK REL="Next"  HREF="018837.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] kernel panic - Attempting to free lock with active
	waiting queue</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Huzaifa Tapal</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20kernel%20panic%20-%20Attempting%20to%20free%20lock%20with%20active%0A%09waiting%20queue&In-Reply-To=42FB98A2.7070501%40sympatico.ca"
       TITLE="[mod_python] kernel panic - Attempting to free lock with active
	waiting queue">huzaifa at hostway.com
       </A><BR>
    <I>Fri Aug 12 17:47:12 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="018825.html">[mod_python] kernel panic - Attempting to free lock with active
	waiting queue
</A></li>
        <LI>Next message: <A HREF="018837.html">[mod_python] kernel panic - Attempting to free lock with active
	waiting queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18834">[ date ]</a>
              <a href="thread.html#18834">[ thread ]</a>
              <a href="subject.html#18834">[ subject ]</a>
              <a href="author.html#18834">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>No, no content was being served from ns, however, our sys dev team here 
did some investigation and here is what the found:

in mod_python.c for the  apr_status_t init_mutexes() method which I 
believe gets called for the Memory Session management, apache's 
apr_global_mutex_create() locking mechanism is being used to lock a file 
on the filesystem in cases of a mulit-process and multi-threaded apache 
configuration to share the session between different child processes.  
Apache's  apr_status_t init_mutexes() method is covered with flock() the 
handling of which in the debian kernel 2.6.12.4 has a bug under severe 
cases.

In our testing, under a very, very heavy load of over 800 concurrent 
connections using a jython-based tool called grinder, a race condiditon 
is happening at which point the kernel is panicking.  The solution to 
this problem as we see it is to either change apache's  apr_status_t 
init_mutexes() method ot use fnctl lock instead of flocks, or run apache 
with only one process at all times.

In the meantime, we are going to still moderately load test our cluster 
through out the weekend and see if we can replicate the panic under a 
moderate load but a long duration of time.

Hozi

Jim Gallacher wrote:

&gt;<i> Huzaifa Tapal wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hello All,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I was wondering if any of you have run into any kernel panics running 
</I>&gt;&gt;<i> apache2 w/ mod_python 3.13 (patches applied) on kernel 2.6.12.4?  
</I>&gt;&gt;<i> Under heavy load testing of approximately 520 concurrent users the 
</I>&gt;&gt;<i> server crashed with the message:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Kernel panic - Attempting to free lock with active waiting queue
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We previously had a stock debian kernel version 2.6.08 and we had 
</I>&gt;&gt;<i> noticed that under a load of 36 concurrent users, sporadically, the 
</I>&gt;&gt;<i> server would crash immediately as the load test was started.  In the 
</I>&gt;&gt;<i> current case, after upgrading the kernel, the server did not crash 
</I>&gt;&gt;<i> until it reached the peak of 550 concurrent users.  I am currently 
</I>&gt;&gt;<i> running the load test again after rebootin the server and the server 
</I>&gt;&gt;<i> is handling requests even at 559 concurrent users so the panic is 
</I>&gt;&gt;<i> sporadic.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Anybody have any ideas?  Anybody seen anything like this before?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Only what google tells me. Any chance you are serving content from nfs?
</I>&gt;<i>
</I>&gt;<i> Jim
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018825.html">[mod_python] kernel panic - Attempting to free lock with active
	waiting queue
</A></li>
	<LI>Next message: <A HREF="018837.html">[mod_python] kernel panic - Attempting to free lock with active
	waiting queue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18834">[ date ]</a>
              <a href="thread.html#18834">[ thread ]</a>
              <a href="subject.html#18834">[ subject ]</a>
              <a href="author.html#18834">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
