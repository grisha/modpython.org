<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Mod-Python / MySQL client libs causing apache to
	seg-fault
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mod-Python%20/%20MySQL%20client%20libs%20causing%20apache%20to%0A%09seg-fault&In-Reply-To=88e286470811281441l7473a875gca2e9fa2bd49acd4%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025850.html">
   <LINK REL="Next"  HREF="025842.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Mod-Python / MySQL client libs causing apache to
	seg-fault</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Luke Burden</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mod-Python%20/%20MySQL%20client%20libs%20causing%20apache%20to%0A%09seg-fault&In-Reply-To=88e286470811281441l7473a875gca2e9fa2bd49acd4%40mail.gmail.com"
       TITLE="[mod_python] Mod-Python / MySQL client libs causing apache to
	seg-fault">luke at demonware.net
       </A><BR>
    <I>Wed Dec 10 14:05:39 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025850.html">[mod_python] Difference between filter.pass_on() and
	filter.disable()?
</A></li>
        <LI>Next message: <A HREF="025842.html">[mod_python] ioerrors with worker thread mpm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25841">[ date ]</a>
              <a href="thread.html#25841">[ thread ]</a>
              <a href="subject.html#25841">[ subject ]</a>
              <a href="author.html#25841">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Just to follow up on this - using mpm_prefork instead of mpm_worker clears
up these mysterious mysqlclientlib problems in my instance.I don't know
whether it was the mysqlclientlib that isn't threadsafe, or whether it was
another library that introduced the instability.

On Fri, Nov 28, 2008 at 2:41 PM, Graham Dumpleton &lt;
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>&gt; wrote:

&gt;<i> Would be wise to ensure using recent MySQL client libraries and Python
</I>&gt;<i> wrappers if need be, as there are some dodgy versions that have been
</I>&gt;<i> known to cause problems under mod_python.
</I>&gt;<i>
</I>&gt;<i> Other than that, since you seemed to have checked PHP conflict
</I>&gt;<i> problems, only thing can mention is to make sure you don't have any
</I>&gt;<i> other Apache modules installed with use MySQL such as a
</I>&gt;<i> mod_auth_mysql.
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> 2008/11/29 Luke Burden &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">luke at demonware.net</A>&gt;:
</I>&gt;<i> &gt; Hi Graham,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm a developer for a internally facing web application, which uses
</I>&gt;<i> &gt; apache + mod_python + mysql.
</I>&gt;<i> &gt; As the application is being increasingly used, I've noticed several
</I>&gt;<i> &gt; errors occurring sporadically, but regularly enough to be cause for
</I>&gt;<i> &gt; concern.  Concern morphed into alarm when I found I could reproduce
</I>&gt;<i> &gt; the problems by quickly and repeatedly refreshing a page that causes a
</I>&gt;<i> &gt; number of queries to be executed!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The problem manifests itself in either bad behavior from the python
</I>&gt;<i> &gt; MySQLDb module:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; InterfaceError: (0, '')
</I>&gt;<i> &gt; OperationalError: (2013, 'Lost connection to MySQL server during query')
</I>&gt;<i> &gt; ProgrammingError: (2014, &quot;Commands out of sync; you can't run this
</I>&gt;<i> &gt; command now&quot;) (&lt;- might be unrelated)
</I>&gt;<i> &gt; .. and NoneType result sets where the data is basically not there,
</I>&gt;<i> &gt; when it should be.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Or in apache seg-faulting:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [Fri Nov 28 21:34:42 2008] [notice] mod_python: Creating 8 session
</I>&gt;<i> &gt; mutexes based on 6 max processes and 25 max threads.
</I>&gt;<i> &gt; [Fri Nov 28 21:34:42 2008] [notice] mod_python: using mutex_directory
</I>&gt;<i> /tmp
</I>&gt;<i> &gt; [Fri Nov 28 21:34:42 2008] [notice] Apache/2.2.4 (Ubuntu)
</I>&gt;<i> &gt; mod_python/3.3.1 Python/2.5.1 configured -- resuming normal operations
</I>&gt;<i> &gt; [Fri Nov 28 21:35:03 2008] [error] [client 192.168.179.1] File does
</I>&gt;<i> &gt; not exist: /var/www/favicon.ico
</I>&gt;<i> &gt; [Fri Nov 28 21:35:04 2008] [error] [client 192.168.179.1] File does
</I>&gt;<i> &gt; not exist: /var/www/favicon.ico
</I>&gt;<i> &gt; [Fri Nov 28 21:35:06 2008] [error] [client 192.168.179.1] File does
</I>&gt;<i> &gt; not exist: /var/www/favicon.ico
</I>&gt;<i> &gt; [Fri Nov 28 21:35:06 2008] [error] [client 192.168.179.1] File does
</I>&gt;<i> &gt; not exist: /var/www/favicon.ico
</I>&gt;<i> &gt; [Fri Nov 28 21:35:07 2008] [notice] child pid 17523 exit signal
</I>&gt;<i> &gt; Segmentation fault (11)
</I>&gt;<i> &gt; [Fri Nov 28 21:35:07 2008] [error] [client 192.168.179.1] File does
</I>&gt;<i> &gt; not exist: /var/www/favicon.ico
</I>&gt;<i> &gt; [Fri Nov 28 21:35:07 2008] [error] [client 192.168.179.1] File does
</I>&gt;<i> &gt; not exist: /var/www/favicon.ico
</I>&gt;<i> &gt; [Fri Nov 28 21:35:08 2008] [error] [client 192.168.179.1] File does
</I>&gt;<i> &gt; not exist: /var/www/favicon.ico
</I>&gt;<i> &gt; [Fri Nov 28 21:35:15 2008] [notice] child pid 17525 exit signal
</I>&gt;<i> &gt; Segmentation fault (11)
</I>&gt;<i> &gt; [Fri Nov 28 21:35:15 2008] [notice] child pid 17579 exit signal
</I>&gt;<i> &gt; Segmentation fault (11)
</I>&gt;<i> &gt; [Fri Nov 28 21:35:16 2008] [error] [client 192.168.179.1] File does
</I>&gt;<i> &gt; not exist: /var/www/favicon.ico
</I>&gt;<i> &gt; [Fri Nov 28 21:35:17 2008] [notice] child pid 17607 exit signal
</I>&gt;<i> &gt; Segmentation fault (11)
</I>&gt;<i> &gt; [Fri Nov 28 21:35:19 2008] [error] [client 192.168.179.1] File does
</I>&gt;<i> &gt; not exist: /var/www/favicon.ico
</I>&gt;<i> &gt; ... etc ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; A closer look at one of the segmentation faults:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *** glibc detected *** /usr/sbin/apache2: double free or corruption
</I>&gt;<i> (!prev):
</I>&gt;<i> &gt; 0x000000000212a1c0 ***
</I>&gt;<i> &gt; ======= Backtrace: =========
</I>&gt;<i> &gt; /lib/libc.so.6[0x2b6915ed7b0a]
</I>&gt;<i> &gt; /lib/libc.so.6(cfree+0x8c)[0x2b6915edb6fc]
</I>&gt;<i> &gt; /usr/lib/libmysqlclient_r.so.15(vio_delete+0x19)[0x2aaaadef6ff9]
</I>&gt;<i> &gt; /usr/lib/libmysqlclient_r.so.15(end_server+0x2f)[0x2aaaadef2eff]
</I>&gt;<i> &gt; /usr/lib/libmysqlclient_r.so.15(cli_safe_read+0x2b)[0x2aaaadef305b]
</I>&gt;<i> &gt;
</I>&gt;<i> /usr/lib/libmysqlclient_r.so.15(cli_advanced_command+0x195)[0x2aaaadef5675]
</I>&gt;<i> &gt; /usr/lib/libmysqlclient_r.so.15(mysql_ping+0x31)[0x2aaaadec71a1]
</I>&gt;<i> &gt; /var/lib/python-support/python2.5/_mysql.so[0x2aaaadc5e7e6]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalFrameEx+0x6335)[0x2b691a2ccd15]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalCodeEx+0x836)[0x2b691a2cdb06]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalFrameEx+0x553d)[0x2b691a2cbf1d]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalFrameEx+0x6564)[0x2b691a2ccf44]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalFrameEx+0x6564)[0x2b691a2ccf44]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalCodeEx+0x836)[0x2b691a2cdb06]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalFrameEx+0x553d)[0x2b691a2cbf1d]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalCodeEx+0x836)[0x2b691a2cdb06]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalFrameEx+0x553d)[0x2b691a2cbf1d]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalFrameEx+0x6564)[0x2b691a2ccf44]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyEval_EvalCodeEx+0x836)[0x2b691a2cdb06]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0[0x2b691a26dc5e]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyObject_Call+0x13)[0x2b691a24c323]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0[0x2b691a253aad]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyObject_Call+0x13)[0x2b691a24c323]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0[0x2b691a24c547]
</I>&gt;<i> &gt; /usr/lib/libpython2.5.so.1.0(PyObject_CallMethod+0xc0)[0x2b691a24e610]
</I>&gt;<i> &gt; /usr/lib/apache2/modules/mod_python.so[0x2b6919ff91bc]
</I>&gt;<i> &gt; /usr/lib/apache2/modules/mod_python.so[0x2b6919ffb687]
</I>&gt;<i> &gt; /usr/sbin/apache2(ap_run_handler+0x7a)[0x437c4a]
</I>&gt;<i> &gt; /usr/sbin/apache2(ap_invoke_handler+0x7c)[0x43affc]
</I>&gt;<i> &gt; /usr/sbin/apache2(ap_process_request+0x178)[0x447248]
</I>&gt;<i> &gt; /usr/sbin/apache2[0x44468c]
</I>&gt;<i> &gt; /usr/sbin/apache2(ap_run_process_connection+0x72)[0x43ec22]
</I>&gt;<i> &gt; /usr/sbin/apache2[0x44b696]
</I>&gt;<i> &gt; /lib/libpthread.so.0[0x2b6915a4d317]
</I>&gt;<i> &gt; /lib/libc.so.6(clone+0x6d)[0x2b6915f39d5d]
</I>&gt;<i> &gt; ======= Memory map: ========
</I>&gt;<i> &gt; [Fri Nov 28 02:52:57 2008] [notice] child pid 28387 exit signal Aborted
</I>&gt;<i> (6)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Seems to clearly point the finger at the mysql client library.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Google shows a few similar looking cases, usually solved by removing
</I>&gt;<i> &gt; PHP, which in this case is not installed.  Nor is expat XML parser
</I>&gt;<i> &gt; used.  Nor mhash.so. :)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The problem occurs on both Ubuntu 7.10, and 8.04 installs using the
</I>&gt;<i> &gt; default packages for apache, python, mod python, mysql.  From the 7.10
</I>&gt;<i> &gt; instance:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">luke at luke-ubuntu</A>:~$ dpkg -l | grep mysql
</I>&gt;<i> &gt; ii  libdbd-mysql-perl                          4.004-2
</I>&gt;<i> &gt;            A Perl5 database interface to the MySQL data
</I>&gt;<i> &gt; ii  libmysqlclient15off                        5.0.45-1ubuntu3.3
</I>&gt;<i> &gt;            MySQL database client library
</I>&gt;<i> &gt; ii  mysql-client-5.0                           5.0.45-1ubuntu3.3
</I>&gt;<i> &gt;            MySQL database client binaries
</I>&gt;<i> &gt; ii  mysql-common                               5.0.45-1ubuntu3.3
</I>&gt;<i> &gt;            MySQL database common files
</I>&gt;<i> &gt; ii  mysql-server                               5.0.45-1ubuntu3.3
</I>&gt;<i> &gt;            MySQL database server (meta package dependin
</I>&gt;<i> &gt; ii  mysql-server-5.0                           5.0.45-1ubuntu3.3
</I>&gt;<i> &gt;            MySQL database server binaries
</I>&gt;<i> &gt; ii  python-mysqldb                             1.2.2-3ubuntu1
</I>&gt;<i> &gt;            A Python interface to MySQL
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">luke at luke-ubuntu</A>:~$ dpkg -l | grep mod-python
</I>&gt;<i> &gt; ii  libapache2-mod-python                      3.3.1-2
</I>&gt;<i> &gt;            Apache 2 module that embeds Python within th
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; All running on Python 2.5.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm thinking of getting the source and building the libmysqlclient
</I>&gt;<i> &gt; myself now, but I'm hoping you've got some wise suggestions for me.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks very much for your time!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Regards,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Luke
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mod_python mailing list
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> ______________________________________________________________________
</I>&gt;<i> This email has been scanned by the MessageLabs Email Security System.
</I>&gt;<i> For more information please visit <A HREF="http://www.messagelabs.com/email">http://www.messagelabs.com/email</A>
</I>&gt;<i> ______________________________________________________________________
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20081210/fad2c71e/attachment.html">http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20081210/fad2c71e/attachment.html</A>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025850.html">[mod_python] Difference between filter.pass_on() and
	filter.disable()?
</A></li>
	<LI>Next message: <A HREF="025842.html">[mod_python] ioerrors with worker thread mpm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25841">[ date ]</a>
              <a href="thread.html#25841">[ thread ]</a>
              <a href="subject.html#25841">[ subject ]</a>
              <a href="author.html#25841">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
