<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] python rewrite of mod_usertrack (actual module this time)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20python%20rewrite%20of%20mod_usertrack%20%28actual%20module%20this%20time%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011209.html">
   <LINK REL="Next"  HREF="011211.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] python rewrite of mod_usertrack (actual module this time)</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>geoff at ijane.com</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20python%20rewrite%20of%20mod_usertrack%20%28actual%20module%20this%20time%29&In-Reply-To="
       TITLE="[mod_python] python rewrite of mod_usertrack (actual module this time)">geoff at ijane.com
       </A><BR>
    <I>Fri Jun 16 11:19:33 EST 2000</I>
    <P><UL>
        <LI>Previous message: <A HREF="011209.html">[mod_python] python rewrite of mod_usertrack
</A></li>
        <LI>Next message: <A HREF="011211.html">[mod_python] python rewrite of mod_usertrack (actual module this
 time)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11210">[ date ]</a>
              <a href="thread.html#11210">[ thread ]</a>
              <a href="subject.html#11210">[ subject ]</a>
              <a href="author.html#11210">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry.
I didn't realize that attachment didn't work.
Here is the module (usertrack.py):

&quot;&quot;&quot;This module is a shameless rewrite of mod_usertrack in python.  It should
operate in most respects like mod_usertrack.  The exception would be that it
always sets a 4 digit year for an expire date.

Logging
This will be handled by mod_log_config, the custom log module.  The cookie
will be available by using the token, &quot;%{session_cookie}n&quot;.
For example:

LogFormat &quot;%t \&quot;%r\&quot; %&gt;s \&quot;%{session_cookie}n\&quot;&quot; session
CustomLog /usr/local/apache/logs/session_log session

PythonOptions
There are three options that can be configured: CookieExpires, CookieName
and CookieTracking.   These basically work the same as mod_usertrack's
directives of the same name.

CookieExpires
This option sets an expiration time for the cookie generated by this module.
This time can be either a number of seconds or a string describing the
amount of time.  If this option does not exist the cookie will expire when
the browser's session does.  The time string must be quoted and is in the
format of a space separeated list of &quot;number label&quot; pairs.  Valid labels
are: years, months, weeks, days, hours, minutes, seconds.

CookieName
If this option exists the default name of the cookie will be whatever the
label specifies.

CookieTracking
This option is required if you will to use this module.  It's value must be
&quot;on&quot; for this module to operate.


httpd.conf example:

&lt;Directory /&gt;
    PythonPath &quot;['/usr/lib/python1.5', '/usr/lib/python1.5/site-packages']&quot;

    PythonDebug
    PythonOption CookieName k3WL_c00KI3_nAM3
    PythonOption CookieTracking on
    PythonOption CookieExpires &quot;10 years 4 months 2 weeks 3 days 2 hours 36
seconds&quot;
    PythonFixupHandler usertrack
&lt;/Directory&gt;

&quot;&quot;&quot;
__version__ = &quot;$Id: usertrack.py,v 1.1 2000/06/02 09:00:31 geoff Exp $&quot;
from mod_python import apache
import re, string, time, os

isDigit = re.compile(&quot;^\d+$&quot;)
isSpace = re.compile(&quot;\s+&quot;)

FACTOR = {
    'years': 60 * 60 * 24 * 365,
    'months': 60 * 60 * 24 * 30,
    'weeks': 60 * 60 * 24 * 7,
    'days': 60 * 60 * 24,
    'hours': 60 * 60,
    'minutes': 60,
    'seconds': 1,
    }            

COOKIE_NAME = &quot;Apache_Python&quot;

def fixuphandler(r):
    global COOKIE_NAME
    opt = r.get_options()
    if opt['CookieTracking'] != 'on':
        return apache.DECLINED
    else:
        if opt.has_key('CookieName'): COOKIE_NAME = opt['CookieName']
        try:
            m = re.search(&quot;(?:^|\s+)%s=(?P&lt;cookieValue&gt;[^;]+)&quot; %
COOKIE_NAME, \
                          r.headers_in['Cookie'])
            r.notes['session_cookie'] = m.group('cookieValue')
            return apache.DECLINED
        except:
            expires = 0
            if opt.has_key('CookieExpires'):
                expires = r.request_time + \
                                 parseExpire(opt['CookieExpires'])
            make_cookie(r, COOKIE_NAME, expires)
    return apache.OK
        
def make_cookie(r, name, expires):
    &quot;&quot;&quot;Set a unique cookie for user tracking.&quot;&quot;&quot;
    cookieValue = &quot;%s.%d%ld%ld&quot; % (r.hostname, os.getpid(), r.request_time,
\
                                   time.clock())
    if expires == 0:
        r.headers_out['Set-Cookie'] = &quot;%s=%s; path=/&quot; % (name, \
                                                         cookieValue)
    else:
        r.headers_out['Set-Cookie'] = &quot;%s=%s; path=/; expires=%s GMT&quot; % \
            (name, cookieValue, time.strftime(&quot;%A, %d-%b-%Y %H:%M:%S&quot;, \
            time.gmtime(expires)))  
    r.notes['session_cookie'] = cookieValue
    return

def parseExpire(expire):
    &quot;&quot;&quot;Return number of seconds from a formated string.&quot;&quot;&quot;
    if isDigit.search(expire): return expire
    seconds = 0
    t = isSpace.split(expire)
    tLen = len(t)
    i = 0
    while i &lt; tLen:
        if isDigit.search(t[i]):
            seconds = seconds + (FACTOR.get(string.lower(t[i + 1]), 0) * \
                                 string.atoi(t[i]))
        i = i + 2
    return seconds

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011209.html">[mod_python] python rewrite of mod_usertrack
</A></li>
	<LI>Next message: <A HREF="011211.html">[mod_python] python rewrite of mod_usertrack (actual module this
 time)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11210">[ date ]</a>
              <a href="thread.html#11210">[ thread ]</a>
              <a href="subject.html#11210">[ subject ]</a>
              <a href="author.html#11210">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
