<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Problems under windows: a first diagnostic
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problems%20under%20windows%3A%20a%20first%20diagnostic&In-Reply-To=010101bfcf1f%24b9407bd0%24885bfea9%40spirou">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007471.html">
   <LINK REL="Next"  HREF="007474.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
<table border=0 width="100%"><tr><td valign="top">
   <H1>[mod_python] Problems under windows: a first diagnostic</H1>
    <B>Greg Stein</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problems%20under%20windows%3A%20a%20first%20diagnostic&In-Reply-To=010101bfcf1f%24b9407bd0%24885bfea9%40spirou"
       TITLE="[mod_python] Problems under windows: a first diagnostic">gstein at lyra.org
       </A><BR>
    <I>Mon Jun  5 17:16:39 EST 2000</I>
    <P><UL>
        <LI>Previous message: <A HREF="007471.html">[mod_python] Problems under windows: a first diagnostic
</A></li>
        <LI>Next message: <A HREF="007474.html">[mod_python] Problems under windows: a first diagnostic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7472">[ date ]</a>
              <a href="thread.html#7472">[ thread ]</a>
              <a href="subject.html#7472">[ subject ]</a>
              <a href="author.html#7472">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 5 Jun 2000, [iso-8859-1] St&#233;phane Bidoul wrote:
&gt;<i>...
</I>&gt;<i> Now, in mod_python, threads are created by Apache, so they should
</I>&gt;<i> somehow be bootstrapped for python. 
</I>
Correct.

&gt;<i> In my understanding, mod_python only initializes one thread per
</I>&gt;<i> interpreter: the Apache thread that is happening to create the interpreter
</I>&gt;<i>  (using Py_NewInterpreter(), which in turns calls PyThreadState_New()
</I>&gt;<i> for the interpreter's &quot;main&quot; thread).
</I>&gt;<i> All other apache threads using that same interpreter will not call
</I>&gt;<i> PyThreadState_New()... hence the potential conflict.
</I>
ThreadState structures are not specific to a particular (OS) thread. You
can actually use them (not at the same time!) across different threads.
Given the protection of the global lock, it might be okay to even attempt
to use them at the same time.
[ haven't thought through this particular scenario fully yet ]

&gt;<i> To summarize, my understanding of the python doc is that there should
</I>&gt;<i> be one PyThreadState_New() for each (apache thread, python
</I>&gt;<i> interpreter) couple.
</I>
Theoretically: yes.

Python's central lock &quot;should&quot; arbitrate the use of the per-interpreter
thread state so that it can be used by multiple Apache threads. Probably
isn't the best idea, though.

Eek. Definitely wrong for the Apache scenario.

The scoop: if python_handler() calls into Python, then returns, then
tstate-&gt;frame should be NULL. In this scenario, you could do the
share-tstate thing.

However: somewhere down inside of python_handler's call into Python, it is
quite possible for Python to use Py_BEGIN_ALLOW_THREADS (unlock the global
lock). This will allow another python_handler to grab the tstate and
attempt execution. Let's say the thread execution then flips back to
normal: the original thread's tstate-&gt;frame is now *totally* wrong.

[ tstate-&gt;frame has a direct correspondence to the C stack; these must
  stay in sync or Bad Things happen ]

&gt;<i> AFAIK, threads are used only in the Windows version of Apache, 
</I>&gt;<i> so the problem should not occur on unix  (athough that will change with Apache 2). 
</I>&gt;<i> Also, if ThreadsPerChild is set to 1, the problem disappears,
</I>&gt;<i> which seems to confirm my diagnostic.
</I>&gt;<i> 
</I>&gt;<i> Again, bear with me if this is totally wrong...
</I>&gt;<i> If this is correct, however, I've no idea (yet) on how to fix it...
</I>
Your underlying hypothesis is quite correct. Above is a more detailed
breakdown of &quot;why&quot;.

&gt;<i> What do you think? 
</I>&gt;<i> Can a python threading expert confirm or infirm this diagnostic?
</I>
That would be me :-)

One other thing: if Apache is going to run threads, then Python *MUST* be
compiled with thread support. Otherwise, things will die very rapidly.
Presuming that you are using the standard Windows distribution, then the
thread support is automatically enabled. I would recommend that mod_python
barf with #error if it detects Apache/Win32 and WITH_THREAD is not
enabled.

Heh. All of this just supports my belief in &quot;free threading&quot; Python even
more... :-)

What is the solution? Each entry to python-handler should construct a
tstate on the fly, call into Python, then destroy the tstate. I used this
design for the Python/COM support in the Win32 distribution. That had to
deal with reentrancy issues, but (luckily) that isn't a problem here.

Presumably, you could also cache/pool tstates and yank them from your
pool on entry to python-handler, returning them on exit. If two threads
came into python-handler (against the same interp!), then additional
tstates would be constructed.

Cheers,
-g

-- 
Greg Stein, <A HREF="http://www.lyra.org/">http://www.lyra.org/</A>


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007471.html">[mod_python] Problems under windows: a first diagnostic
</A></li>
	<LI>Next message: <A HREF="007474.html">[mod_python] Problems under windows: a first diagnostic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7472">[ date ]</a>
              <a href="thread.html#7472">[ thread ]</a>
              <a href="subject.html#7472">[ subject ]</a>
              <a href="author.html#7472">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
