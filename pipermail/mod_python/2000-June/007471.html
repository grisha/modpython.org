<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Problems under windows: a first diagnostic
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problems%20under%20windows%3A%20a%20first%20diagnostic&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007477.html">
   <LINK REL="Next"  HREF="007472.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
<table border=0 width="100%"><tr><td valign="top">
   <H1>[mod_python] Problems under windows: a first diagnostic</H1>
    <B>St&#233;phane Bidoul</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Problems%20under%20windows%3A%20a%20first%20diagnostic&In-Reply-To="
       TITLE="[mod_python] Problems under windows: a first diagnostic">sbi at acse.be
       </A><BR>
    <I>Mon Jun  5 20:56:13 EST 2000</I>
    <P><UL>
        <LI>Previous message: <A HREF="007477.html">[mod_python] Leaking and cgi-handler
</A></li>
        <LI>Next message: <A HREF="007472.html">[mod_python] Problems under windows: a first diagnostic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7471">[ date ]</a>
              <a href="thread.html#7471">[ thread ]</a>
              <a href="subject.html#7471">[ subject ]</a>
              <a href="author.html#7471">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again,

I think I've got an explanation for the crashes under windows.

Disclaimer: I'm no apache expert, nor am I intimate with python threading,
so bear with me if the following is completely off-track.

In the python doc, I've found the following:

&lt;PythonDocExcerpt&gt;

[...] when threads are created from C, they don't have the global interpreter lock, nor is there a thread state data structure for them. Such threads must bootstrap themselves into existence, by first creating a thread state data structure [PyThreadState_New()?], then acquiring the lock, and finally storing their thread state pointer, before they can start using the Python/C API. When they are done, they should reset the thread state pointer, release the lock, and finally free their thread state data structure.

&lt;/PythonDocExcerpt&gt;

Now, in mod_python, threads are created by Apache, so they should
somehow be bootstrapped for python. 

In my understanding, mod_python only initializes one thread per
interpreter: the Apache thread that is happening to create the interpreter
 (using Py_NewInterpreter(), which in turns calls PyThreadState_New()
for the interpreter's &quot;main&quot; thread).
All other apache threads using that same interpreter will not call
PyThreadState_New()... hence the potential conflict.

To summarize, my understanding of the python doc is that there should
be one PyThreadState_New() for each (apache thread, python interpreter) couple.

AFAIK, threads are used only in the Windows version of Apache, 
so the problem should not occur on unix  (athough that will change with Apache 2). 
Also, if ThreadsPerChild is set to 1, the problem disappears,
which seems to confirm my diagnostic.

Again, bear with me if this is totally wrong...
If this is correct, however, I've no idea (yet) on how to fix it...

What do you think? 
Can a python threading expert confirm or infirm this diagnostic?

-Stephane
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">sbi at acse.be</A>




</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007477.html">[mod_python] Leaking and cgi-handler
</A></li>
	<LI>Next message: <A HREF="007472.html">[mod_python] Problems under windows: a first diagnostic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7471">[ date ]</a>
              <a href="thread.html#7471">[ thread ]</a>
              <a href="subject.html#7471">[ subject ]</a>
              <a href="author.html#7471">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
