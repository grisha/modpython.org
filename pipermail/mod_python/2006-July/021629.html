<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] modpython, mysqldb best paractice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20modpython%2C%20mysqldb%20best%20paractice&In-Reply-To=B6C73A5E30565245BB6D32B5F5DF7A520BEC85%40sense.emmastraat.pijnacker">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021627.html">
   <LINK REL="Next"  HREF="021632.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] modpython, mysqldb best paractice</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jim Gallacher</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20modpython%2C%20mysqldb%20best%20paractice&In-Reply-To=B6C73A5E30565245BB6D32B5F5DF7A520BEC85%40sense.emmastraat.pijnacker"
       TITLE="[mod_python] modpython, mysqldb best paractice">jpg at jgassociates.ca
       </A><BR>
    <I>Wed Jul 19 08:52:59 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021627.html">[mod_python] modpython, mysqldb best paractice
</A></li>
        <LI>Next message: <A HREF="021632.html">[mod_python] modpython, mysqldb best paractice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21629">[ date ]</a>
              <a href="thread.html#21629">[ thread ]</a>
              <a href="subject.html#21629">[ subject ]</a>
              <a href="author.html#21629">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Martijn Moeling wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I started the development of a specific kind of CMS over 2 years ago,
</I>&gt;<i> and due to sparse documentation I am still puzzled about a few things.
</I>&gt;<i> 
</I>&gt;<i> Basically it consist of one .py and a mysqldatabase with all the data
</I>&gt;<i> and templates, ALL pages are generated on the fly.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> First of all I am confused about PythonInterPerDirectory and
</I>&gt;<i> PythonInterpPerDirectory
</I>&gt;<i> 
</I>&gt;<i> In the way I use modpython.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> My apache has no configured virtual hosts since my CMS can handle this
</I>&gt;<i> on its own by looking at req.host
</I>&gt;<i> 
</I>&gt;<i> On one site which is running on my system ( <A HREF="http://www.mkbok.nl">http://www.mkbok.nl</A>
</I>&gt;<i> &lt;<A HREF="http://www.mkbok.nl/">http://www.mkbok.nl/</A>&gt;  ) we use different subdomains, so basically 
</I>&gt;<i> 
</I>&gt;<i> the page to be build is derived from the req.host (e.g.
</I>&gt;<i> xxx.yyy.mkbok.nl) where xxx and yyy are variable. 
</I>&gt;<i> 
</I>&gt;<i> This is done by DNS records like   *     A      ip1.ip2.ip3.ip4
</I>
You don't actually state what problem here. ;)

&gt;<i> My next problem seems mysql and mysqldb.
</I>&gt;<i> 
</I>&gt;<i> Since I do not know which website is requested (multiple are running on
</I>&gt;<i> that server) I open a database connection, do my stuff and close the
</I>&gt;<i> connection, 
</I>&gt;<i> 
</I>&gt;<i> Again the database selection comes from req.host, and here the
</I>&gt;<i> domainname is used for database selection.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> The system runs extremely well, but once in a while the webserver
</I>&gt;<i> becomes so busy that it does not respond to page request anymore. 
</I>&gt;<i> 
</I>&gt;<i> We suspect that mysql is the problem here since the only thing we can
</I>&gt;<i> see is mysql is consuming more and more swapspace and at some point it
</I>&gt;<i> runs out of resources and starts looping. At that point the system
</I>&gt;<i> (Linux) keeps running but with a 100% cpu utilization and we are unable
</I>&gt;<i> to login and investigate. 
</I>&gt;<i> 
</I>&gt;<i> So logging in to the UPS remotely and power down the system by virtually
</I>&gt;<i> unplugging the cable is the only (and BAD) solution.
</I>
Ouch. Maybe you can run a cron job every 5 minutes to check the load and
try to catch the problem before you hit 100%? I'm not suggesting this is
a permanent solution, just do it until you can track down the cause.

Is there a chance that mysql is hitting its connection limit? (although
I'm not sure if that would cause the behaviour you describe).

&gt;<i> 
</I>&gt;<i> So what is best practice when you have to connect to mysql with mysqldb
</I>&gt;<i> in a mod_python environment keeping in mind that the database connection
</I>&gt;<i> has to be build every time a visitor requests a page? Think in terms of
</I>&gt;<i> a &quot;globally&quot; available db or db.cursor connection.
</I>
I don't think the performance penalty for creating a connection to mysql
is too great - at least compared to some other databases. You might want
to google for more information.

&gt;<i> Since global variables are troublesome in the .py contaning the handler
</I>&gt;<i> I use a class from which an instance is created every time a client
</I>&gt;<i> connects and the DB connection is global to that class, ist that wrong?
</I>
This looks OK.

&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> What happenens if mod_python finds an error before my mysqldb connection
</I>&gt;<i> is closed (not that this happenes a lot, but it does happen, sorry)
</I>
It depends on how you handle the exception. This is why you should close
the connection in a registered cleanup function, which will always run.

&gt;<i> 
</I>&gt;<i> Also I do not understand the req.register_cleanup() method, what is
</I>&gt;<i> cleaned up and what not?
</I>
Whatever function you register is run during the cleanup phase (unless
mod_python segfaults - but then you've got other problems). The cleanup
phase occurs after the response has been sent and anything registered is
guaranteed to run, regardless of what happens in prior phases. Typical
usage looks like this:

def handler(req):
    conn = MySQLdb.connect(db='blah', user='blah', passwd='blah')
    req.register_cleanup(db_cleanup, conn)

    ... do your request handling ...

    return apache.OK


def db_cleanup(connection):
    connection.close()

Jim
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021627.html">[mod_python] modpython, mysqldb best paractice
</A></li>
	<LI>Next message: <A HREF="021632.html">[mod_python] modpython, mysqldb best paractice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21629">[ date ]</a>
              <a href="thread.html#21629">[ thread ]</a>
              <a href="subject.html#21629">[ subject ]</a>
              <a href="author.html#21629">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
