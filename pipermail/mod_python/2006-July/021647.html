<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] output filters: selection criteria and slowness
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20output%20filters%3A%20selection%20criteria%20and%20slowness&In-Reply-To=e9res3%2479s%241%40sea.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021646.html">
   <LINK REL="Next"  HREF="021648.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] output filters: selection criteria and slowness</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20output%20filters%3A%20selection%20criteria%20and%20slowness&In-Reply-To=e9res3%2479s%241%40sea.gmane.org"
       TITLE="[mod_python] output filters: selection criteria and slowness">grahamd at dscpl.com.au
       </A><BR>
    <I>Fri Jul 21 19:28:13 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021646.html">[mod_python] output filters: selection criteria and slowness
</A></li>
        <LI>Next message: <A HREF="021648.html">[mod_python] compile issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21647">[ date ]</a>
              <a href="thread.html#21647">[ thread ]</a>
              <a href="subject.html#21647">[ subject ]</a>
              <a href="author.html#21647">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 22/07/2006, at 6:53 AM, Rob Miller wrote:

&gt;<i> hi,
</I>&gt;<i>
</I>&gt;<i> i know python pretty well, but i'm a mod_python (mod_*, really)  
</I>&gt;<i> beginner, and i'm having some trouble getting an output filter to  
</I>&gt;<i> work for me.  i'm trying to apply a filter to content that is being  
</I>&gt;<i> served from a CMS and proxied through apache using RewriteRules.    
</I>&gt;<i> i've got it working, sort of, but there are a couple of major snags  
</I>&gt;<i> i've hit:
</I>&gt;<i>
</I>&gt;<i> - the content coming from the other system doesn't necessarily have  
</I>&gt;<i> a file extension.  i can use 'SetOutputFilter&quot; to apply the filter  
</I>&gt;<i> to everything, but i don't WANT to apply it to images or other  
</I>&gt;<i> binary data.  is there a way to use &quot;AddOutputFilter&quot; for files  
</I>&gt;<i> with no extension?  or to use it as an extension blacklist, rather  
</I>&gt;<i> than a whitelist?  or would this have to be done as logic in the  
</I>&gt;<i> filter itself?
</I>
It is probably easier to make the determination in the filter itself.  
Rather than:

     try:
         streambuffer = filter.req.streambuffer
     except AttributeError:
         filter.req.streambuffer = StringIO()
         streambuffer = filter.req.streambuffer

have something like:

     try:
         streambuffer = filter.req.streambuffer
     except AttributeError:

         # first time into the filter for this request
         # pass on stuff we don't want to deal with

         if filter.req.notheme:

           # pass on if no theme

           filter.pass_on()
           return

         elif not filter.req.headers_out.has_key(&quot;content-type):

           # pass on if no content type specified

           filter.pass_on()
           return

         elif not filter.req.headers_out[&quot;content-type&quot;].startswith 
(&quot;text/html&quot;)

            # pass on if not HTML

            filter.pass_on()
            return

         filter.req.streambuffer = StringIO()
         streambuffer = filter.req.streambuffer

Later on, you can also change:

         if filter.req.notheme:
             filter.write(streambuffer.getvalue())
         else:
             filter.write(appmap.publish(streambuffer.getvalue()))

to just:

          filter.write(appmap.publish(streambuffer.getvalue()))

as you have already passed on control to next filter in chain for  
stuff you do not
want.

&gt;<i> - when i apply the filter to static content coming from a hard  
</I>&gt;<i> drive, it works very well.  when i apply it to content from the  
</I>&gt;<i> CMS, however, it is extremely slow.  a single page can take  
</I>&gt;<i> anywhere from 15 to 45 seconds to return.  (note that if i browse  
</I>&gt;<i> directly to the CMS the page returns are also quite fast.) it seems  
</I>&gt;<i> like a lot of information comes down right away but firefox churns  
</I>&gt;<i> as though it's still waiting.  when i use wget, the page seems to  
</I>&gt;<i> get requested over and over again, with wget never realizing it's  
</I>&gt;<i> done.  my guess is it has something to do w/ the content-length  
</I>&gt;<i> header, but i've deleted it from request before writing to the  
</I>&gt;<i> filter object as shown in the examples i've found.
</I>
Add logging in your filter so track how long different things take.  
Ie., sprinkle in:

   filter.req.log_error(&quot;timestamp %d %f&quot; %  
(filter.req.connection.id,time.time()))

If you want the content length put back, setup Apache to pass the  
output through
the &quot;CONTENT_LENGTH&quot; filter as well. Because you accumulate all the  
data into
one block it will work. You could also just calculate it yourself and  
add it back.

&gt;<i> i'm using mod_python 3.1.4 and apache 2.0.55 from ubuntu dapper.   
</I>&gt;<i> the code of my filter is here: <A HREF="http://codespeak.net/svn/z3/">http://codespeak.net/svn/z3/</A> 
</I>&gt;<i> deliverance/branches/namespaced/mpfilter.py
</I>&gt;<i>
</I>&gt;<i> anyone have suggestions, or pointers to docs, that might help me?
</I>
Reading the general Apache filter FAQ may or may not be useful. It  
isn't mod_python
specific, but explains how it works underneath.

   <A HREF="http://www.projectcomputing.com/resources/apacheFilterFAQ/">http://www.projectcomputing.com/resources/apacheFilterFAQ/</A>

Graham
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021646.html">[mod_python] output filters: selection criteria and slowness
</A></li>
	<LI>Next message: <A HREF="021648.html">[mod_python] compile issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21647">[ date ]</a>
              <a href="thread.html#21647">[ thread ]</a>
              <a href="subject.html#21647">[ subject ]</a>
              <a href="author.html#21647">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
