<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] concurrent connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20concurrent%20connections&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021660.html">
   <LINK REL="Next"  HREF="021665.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] concurrent connections</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20concurrent%20connections&In-Reply-To="
       TITLE="[mod_python] concurrent connections">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Jul 25 00:20:01 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021660.html">[mod_python] concurrent connections
</A></li>
        <LI>Next message: <A HREF="021665.html">[mod_python] Pipes and security
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21661">[ date ]</a>
              <a href="thread.html#21661">[ thread ]</a>
              <a href="subject.html#21661">[ subject ]</a>
              <a href="author.html#21661">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jay Knight wrote ..
&gt;<i> 1.  I was just using firefox when I noticed this behavior.
</I>&gt;<i> 2. 2.0.58
</I>&gt;<i> 3. looks like it's prefork
</I>&gt;<i> 4. StartServers            2
</I>&gt;<i>     MinSpareServers         1
</I>&gt;<i>     MaxSpareServers         5
</I>&gt;<i>     MaxClients             64
</I>&gt;<i>     MaxRequestsPerChild  4000
</I>&gt;<i> 5. 3.1.4
</I>&gt;<i> 
</I>&gt;<i> I just now noticed that this behavior only happens when the same URL
</I>&gt;<i> is called.  For example, if I have a file test.py in this directory,
</I>&gt;<i> and call its url, the mptest.py is still used because it's defined as
</I>&gt;<i> the handler.  If I try to load mptest.py and test.py at the same time,
</I>&gt;<i> they will both return 5 seconds later, but calling the same URL twice
</I>&gt;<i> will invoke the problem.
</I>&gt;<i> 
</I>&gt;<i> Everything else running on this server has no trouble with
</I>&gt;<i> concurrancy, just these scripts, so I'm guessing it's not apache
</I>&gt;<i> itself.
</I>&gt;<i> 
</I>&gt;<i> Any more ideas?
</I>
As I suggested, use 'ab' from the command line to test it and take Firefox
out of the picture. It may be the browser. Also suggest put some logging
in the handler so you can see at what point things are executed.

For logging use something like:

from mod_python import apache
import time

def handler(req):
  apache.log_error('handler 1 %s %f' % (req.uri, time.time()))
  time.sleep(5.0)
  req.content_type = 'text/plain'
  req.write('hello')
  apache.log_error('handler 2 %s %f' % (req.uri, time.time()))
  return apache.OK

In the Apache error log you would then see:

[Tue Jul 25 14:16:09 2006] [error] handler 1 /~grahamd/mptest.py 1153800969.010983
[Tue Jul 25 14:16:09 2006] [error] handler 1 /~grahamd/mptest.py 1153800969.015628
[Tue Jul 25 14:16:09 2006] [error] handler 1 /~grahamd/mptest.py 1153800969.105815
[Tue Jul 25 14:16:09 2006] [error] handler 1 /~grahamd/mptest.py 1153800969.114988
[Tue Jul 25 14:16:09 2006] [error] handler 1 /~grahamd/mptest.py 1153800969.118962
[Tue Jul 25 14:16:14 2006] [error] handler 2 /~grahamd/mptest.py 1153800974.011605
[Tue Jul 25 14:16:14 2006] [error] handler 2 /~grahamd/mptest.py 1153800974.016111
[Tue Jul 25 14:16:14 2006] [error] handler 2 /~grahamd/mptest.py 1153800974.106389
[Tue Jul 25 14:16:14 2006] [error] handler 2 /~grahamd/mptest.py 1153800974.116681
[Tue Jul 25 14:16:14 2006] [error] handler 2 /~grahamd/mptest.py 1153800974.125160

I generated this with:

/usr/local/apache-2.0/bin/ab -n 5 -c 5 <A HREF="http://localhost:8082/~grahamd/mptest.py">http://localhost:8082/~grahamd/mptest.py</A>

The output from 'ab' was:

This is ApacheBench, Version 1.3d &lt;$Revision: 1.73 $&gt; apache-1.3
Copyright (c) 1996 Adam Twiss, Zeus Technology Ltd, <A HREF="http://www.zeustech.net/">http://www.zeustech.net/</A>
Copyright (c) 1998-2002 The Apache Software Foundation, <A HREF="http://www.apache.org/">http://www.apache.org/</A>

This is ApacheBench, Version 2.0.40-dev &lt;$Revision: 1.146 $&gt; apache-2.0
Copyright 1996 Adam Twiss, Zeus Technology Ltd, <A HREF="http://www.zeustech.net/">http://www.zeustech.net/</A>
Copyright 1997-2005 The Apache Software Foundation, <A HREF="http://www.apache.org/">http://www.apache.org/</A>

Benchmarking localhost (be patient).....done


Server Software:        Apache/2.2.2
Server Hostname:        localhost
Server Port:            8082

Document Path:          /~grahamd/mptest.py
Document Length:        5 bytes

Concurrency Level:      5
Time taken for tests:   5.123478 seconds
Complete requests:      5
Failed requests:        0
Write errors:           0
Total transferred:      890 bytes
HTML transferred:       25 bytes
Requests per second:    0.98 [#/sec] (mean)
Time per request:       5123.478 [ms] (mean)
Time per request:       1024.696 [ms] (mean, across all concurrent requests)
Transfer rate:          0.00 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.0      0       0
Processing:  5008 5071  56.7   5108    5122
Waiting:     5007 5070  56.4   5107    5121
Total:       5008 5071  56.7   5108    5122

Percentage of the requests served within a certain time (ms)
  50%   5103
  66%   5113
  75%   5113
  80%   5122
  90%   5122
  95%   5122
  98%   5122
  99%   5122
 100%   5122 (longest request)

See how time take for tests is 5 seconds and mean time per request is
also 5 seconds.

Now trying:

  /usr/local/apache-2.2/bin/ab -n 10 -c 5 <A HREF="http://localhost:8082/~grahamd/mptest.py">http://localhost:8082/~grahamd/mptest.py</A>

I get:

This is ApacheBench, Version 2.0.40-dev &lt;$Revision: 1.146 $&gt; apache-2.0
Copyright 1996 Adam Twiss, Zeus Technology Ltd, <A HREF="http://www.zeustech.net/">http://www.zeustech.net/</A>
Copyright 1997-2005 The Apache Software Foundation, <A HREF="http://www.apache.org/">http://www.apache.org/</A>

Benchmarking localhost (be patient).....done


Server Software:        Apache/2.2.2
Server Hostname:        localhost
Server Port:            8082

Document Path:          /~grahamd/mptest.py
Document Length:        5 bytes

Concurrency Level:      5
Time taken for tests:   10.68433 seconds
Complete requests:      10
Failed requests:        0
Write errors:           0
Total transferred:      1780 bytes
HTML transferred:       50 bytes
Requests per second:    0.99 [#/sec] (mean)
Time per request:       5034.216 [ms] (mean)
Time per request:       1006.843 [ms] (mean, across all concurrent requests)
Transfer rate:          0.10 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    9  12.4      9      34
Processing:  5005 5011   6.1   5010    5024
Waiting:     5000 5005   5.8   5006    5018
Total:       5005 5020  15.8   5019    5048

Percentage of the requests served within a certain time (ms)
  50%   5019
  66%   5022
  75%   5027
  80%   5047
  90%   5048
  95%   5048
  98%   5048
  99%   5048
 100%   5048 (longest request)

Mean time for each request is still 5 seconds, but overall test time is
10 seconds because did 10 request overall with 5 at a time. Thus
second set of 5 serialised behind the other so test itself takes twice
as long.

In summary, don't trust Firefox, use 'ab' as it will give you a more
accurate picture of what is going on.

Graham

&gt;<i> On 7/24/06, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
</I>&gt;<i> &gt; Jay Knight wrote ..
</I>&gt;<i> &gt; &gt; If you take the hello world example, and add a time.sleep(5) at the
</I>&gt;<i> &gt; &gt; beginning... like this:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; -----
</I>&gt;<i> &gt; &gt; import time
</I>&gt;<i> &gt; &gt; from mod_python import apache
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; def handler(req):
</I>&gt;<i> &gt; &gt;     time.sleep(5)
</I>&gt;<i> &gt; &gt;     req.content_type = &quot;text/plain&quot;
</I>&gt;<i> &gt; &gt;     req.write(&quot;Hello World!&quot;)
</I>&gt;<i> &gt; &gt;     return apache.OK
</I>&gt;<i> &gt; &gt; -----
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Then request that URL twice, it seems that the second one doesn't
</I>&gt;<i> &gt; &gt; start until the first one is completely finished, that is, I can't
</I>&gt;<i> &gt; &gt; make them run at the same time.  (And therefore, if I started 20 at
</I>&gt;<i> &gt; &gt; about the same time, the last one would not complete until about 100
</I>&gt;<i> &gt; &gt; seconds later, etc)  How would I go about making them run at the same
</I>&gt;<i> &gt; &gt; time?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I've got a pretty standard mod_python install on gentoo.  The
</I>&gt;<i> &gt; &gt; .htaccess for this directory is
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; -----
</I>&gt;<i> &gt; &gt; AddHandler mod_python .py
</I>&gt;<i> &gt; &gt; PythonHandler mptest
</I>&gt;<i> &gt; &gt; PythonDebug On
</I>&gt;<i> &gt; &gt; -----
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I know this must be possible.  But I don't know if it is a
</I>&gt;<i> &gt; &gt; configuration issue (.htaccess) or something within the code itself
</I>&gt;<i> &gt; &gt; (manually forking stuff off to handle multiple connections? bleh).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Apache should handle everything for you so as to allow concurrent
</I>&gt;<i> &gt; connections.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Some questions for you.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1. What client are you using to create the connections and test this?
</I>&gt;<i> &gt; Are you sure it isn't the client that is serialising the requests?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; One would normally use 'ab&quot; to do such a test. For example:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   ab -n 10 -c 5 <A HREF="http://localhost/some/path">http://localhost/some/path</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The '-n' option says 10 requests, with '-c' saying run 5 concurrently.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2. What version of Apache are you using?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 3. If Apache 2.X, what MPM is compiled in to it, worker or prefork?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; You can determine this by going:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   httpd -l
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; and then looking for either 'worker.c' or 'prefork.c' file being compiled
</I>&gt;<i> in.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 4. How is Apache configured in respect of number of child processes
</I>&gt;<i> &gt; to create etc.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; For example:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt;IfModule mpm_prefork_module&gt;
</I>&gt;<i> &gt;     StartServers          5
</I>&gt;<i> &gt;     MinSpareServers       5
</I>&gt;<i> &gt;     MaxSpareServers      10
</I>&gt;<i> &gt;     MaxClients          150
</I>&gt;<i> &gt;     MaxRequestsPerChild   0
</I>&gt;<i> &gt; &lt;/IfModule&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; or:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt;IfModule mpm_worker_module&gt;
</I>&gt;<i> &gt;     StartServers          2
</I>&gt;<i> &gt;     MaxClients          150
</I>&gt;<i> &gt;     MinSpareThreads      25
</I>&gt;<i> &gt;     MaxSpareThreads      75
</I>&gt;<i> &gt;     ThreadsPerChild      25
</I>&gt;<i> &gt;     MaxRequestsPerChild   0
</I>&gt;<i> &gt; &lt;/IfModule&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 5. What version of mod_python are you using?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Graham
</I>&gt;<i> &gt;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021660.html">[mod_python] concurrent connections
</A></li>
	<LI>Next message: <A HREF="021665.html">[mod_python] Pipes and security
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21661">[ date ]</a>
              <a href="thread.html#21661">[ thread ]</a>
              <a href="subject.html#21661">[ subject ]</a>
              <a href="author.html#21661">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
