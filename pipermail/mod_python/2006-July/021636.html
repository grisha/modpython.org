<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] modpython, mysqldb best paractice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20modpython%2C%20mysqldb%20best%20paractice&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021637.html">
   <LINK REL="Next"  HREF="021638.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] modpython, mysqldb best paractice</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Martijn Moeling</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20modpython%2C%20mysqldb%20best%20paractice&In-Reply-To="
       TITLE="[mod_python] modpython, mysqldb best paractice">martijn at xs4us.nu
       </A><BR>
    <I>Wed Jul 19 15:44:17 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021637.html">[mod_python] modpython, mysqldb best paractice
</A></li>
        <LI>Next message: <A HREF="021638.html">[mod_python] modpython, mysqldb best paractice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21636">[ date ]</a>
              <a href="thread.html#21636">[ thread ]</a>
              <a href="subject.html#21636">[ subject ]</a>
              <a href="author.html#21636">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Deron Meranda wrote:
&gt;<i> On 7/19/06, Martijn Moeling &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">martijn at xs4us.nu</A>&gt; wrote:
</I>&gt;&gt;<i> If mod python is running in Interpreter per directory mode, one
</I>&gt;&gt;<i> interpreter is created since all my content for mkbOK resides in / in
</I>&gt;&gt;<i> total over 1 in total over 14.000 different pages, and since we have
</I>&gt;&gt;<i> over 10.000 pageviews per day and aim for 100.000+ per day at the end
</I>of
&gt;&gt;<i> the year I am preparing for a second server (which my system can
</I>handle)
&gt;&gt;<i>
</I>&gt;&gt;<i> If mod python is running in Interpreter per directive mode I can and
</I>up
&gt;&gt;<i> with god knows how many interpreters.
</I>&gt;<i> 
</I>&gt;<i> There's probably no need for you to use multiple python interpreters
</I>&gt;<i> at all.  The only advantage is that it can provide you with some
</I>&gt;<i> level of isolation (but not perfect); it will not provide any
</I>performance
&gt;<i> benifits (and actually is more likely to decrease performance
</I>somewhat).
&gt;<i> But as you're using it, you don't need more than one interpreter.  So
</I>just
&gt;<i> avoid all the PythonInter* directives.
</I>&gt;<i> 
</I>&gt;&gt;<i> The register cleanup is clear now, since my system creates the
</I>database
&gt;&gt;<i> connection in the class module (the init call creates the class) I
</I>might
&gt;&gt;<i> have to alter that but.
</I>&gt;<i> 
</I>&gt;<i> Also don't forget about try:...finally:... blocks.  That's often the
</I>&gt;<i> simplest way to make sure you clean up after something.
</I>&gt;<i> 
</I>&gt;<i> If the database connection is made inside your class, perhaps you
</I>&gt;<i> should put a disconnect call in the class's destructor, __del__().  I
</I>&gt;<i> don't know if you're using new-style classes, or traditional classes,
</I>&gt;<i> but perhaps something like:
</I>&gt;<i> 
</I>&gt;<i>    class db_based_service(object):
</I>&gt;<i>        def __init__(self):
</I>&gt;<i>            self.db = None
</I>&gt;<i>        def __del__(self):
</I>&gt;<i>            self.disconnect()
</I>&gt;<i>        def connect(self):
</I>&gt;<i>            self.db = MySQLdb.connect( ..... )
</I>&gt;<i>        def disconnect(self):
</I>&gt;<i>            if self.db is not None:
</I>&gt;<i>                self.db.disconnect()
</I>&gt;<i>                self.db = None
</I>&gt;<i>        def init(self):
</I>&gt;<i>            self.connect()
</I>&gt;<i> 
</I>&gt;<i> Furthermore, if you're using transactions, you should make sure
</I>&gt;<i> that you don't have any lingering open transactions.  If you're
</I>&gt;<i> connecting and disconnecting on every request you probably don't
</I>&gt;<i> need to worry quite so much.  But if you ever re-use or pool your
</I>&gt;<i> database connections in the future, you may want to consider
</I>&gt;<i> insuring that all your transactions get terminated at the end of
</I>&gt;<i> the request.  Perhaps extending the framework to something like
</I>&gt;<i> 
</I>&gt;<i>    class ..... (same as above)
</I>&gt;<i>        def __init__(self):
</I>&gt;<i>            # same other stuff above
</I>&gt;<i>            self.in_trans = False
</I>&gt;<i>        def __del__(self):
</I>&gt;<i>             self.rollback()
</I>&gt;<i>             self.disconnect()
</I>&gt;<i>        def start_transaction(self):
</I>&gt;<i>            if self.in_trans:
</I>&gt;<i>                raise RuntimeError(&quot;Attempted nested transaction&quot;)
</I>&gt;<i>            self.db.begin()
</I>&gt;<i>            self.in_trans = True
</I>&gt;<i>        def commit(self):
</I>&gt;<i>            if self.in_trans:
</I>&gt;<i>                db.commit()
</I>&gt;<i>                self.in_trans = False
</I>&gt;<i>        def rollback(self):
</I>&gt;<i>            if self.in_trans:
</I>&gt;<i>                db.rollback()
</I>&gt;<i>                self.in_trans = False
</I>&gt;<i> 
</I>&gt;<i> Of course you may want to see if too-many-connections or
</I>&gt;<i> non-terminated transactions are even a problem.  Periodically
</I>&gt;<i> run the mysql &quot;show processlist&quot; command.  Maybe even an
</I>&gt;<i> occasional &quot;show status&quot; may be informative.
</I>&gt;<i> 
</I>&gt;&gt;<i> The system goes from normal cpu utilization to 100% within a few
</I>&gt;&gt;<i> microseconds, and it happens now and then, sometimes within a few
</I>hours
&gt;&gt;<i> after a reboot, sometimes it runs for weeks without trouble
</I>&gt;<i> 
</I>&gt;<i> Once it gets in that state will it ever eventually clear up?
</I>&gt;<i> 
</I>&gt;<i> Is your system going into an I/O paging fit?  Run the command
</I>&gt;<i> &quot;vmstat 5&quot; and watch the &quot;so&quot; and &quot;bo&quot; columns for a minute.
</I>&gt;<i> &quot;so&quot; should stay near 0, and &quot;bo&quot; should have faily low numbers
</I>&gt;<i> (say &lt;30), but really you should compare it against when the
</I>&gt;<i> system is running okay.
</I>&gt;<i> 
</I>&gt;<i> Also run &quot;top&quot; and determine exactly which process(es) are
</I>&gt;<i> charged with using the most cpu.
</I>&gt;<i> 
</I>&gt;&gt;<i> I tried multiple cron thingies to investigate, but even cron slows
</I>down
&gt;&gt;<i> so mutch that a &quot;service httpd restart, and/or a service mysql
</I>restart&quot;
&gt;&gt;<i> take hours to complete,
</I>&gt;<i> 
</I>&gt;<i> Certainly sounds like heavy paging or swapping.
</I>&gt;<i> 
</I>&gt;&gt;<i> in fact (but keep in mind I have had no interactive access) I think
</I>&gt;&gt;<i> mysql stops responding at all even to signals. I even tried &quot;nice&quot; in
</I>&gt;&gt;<i> the hope that mysql could not take 100% but that was not the case and
</I>it
&gt;&gt;<i> slowed down the page building process (not surprised haha). Even
</I>&gt;&gt;<i> installing a second CPU did not help.
</I>&gt;<i> 
</I>&gt;&gt;<i> The even more stupid thing is that this behavior does not happen on a
</I>&gt;&gt;<i> PIII 1 Ghz with a excact copy of the HDD (dd if=/dev/hd1 of=/dev/hd2)
</I>&gt;&gt;<i> Since the cpu in our production machine is 64 bit I suspected that,
</I>and
&gt;&gt;<i> build apache, and mod_python and python all from scratch,.. no luck.
</I>&gt;<i> 
</I>&gt;<i> What about the amount of memory.  That can have an even bigger
</I>&gt;<i> impact than the speed of the CPU.
</I>&gt;<i> 
</I>&gt;&gt;<i> Different mysql versions did not matter too.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The oddest thing is that after an update of my python code on the
</I>server
&gt;&gt;<i> (new release of my system) is takes 1 or 2 days before it happens,
</I>than
&gt;&gt;<i> it takes say 4 or 5 days, next it runs ok for weeks.
</I>&gt;<i> 
</I>&gt;<i> Perhaps you've got some suboptimal SQL.  For instance are you
</I>&gt;<i> doing a lot of sorts, or very large joins?
</I>&gt;<i> 
</I>&gt;<i> Also what MySQL storage engine are you using?  InnoDB, or
</I>&gt;<i> MyISAM, etc?
</I>
Also, I'm not sure if you told us anything about your OS, apache version
and mpm (prefork or worker) or mod_python version.

The fact is the mod_python has memory leaks. We are tracking them down -
3.2.8 is better than 3.1.4, and the next stable release will be better
yet. (Fixed a leak util.parse_qsl used in FieldStorage). Having
mod_python leak memory could impact mysql, causing heavy swapping when
trying to build a query result. Just a WAG and another thing to
consider.

Jim

-----------------------------

Thanx Jim, I did not know about the memory leaks, But you have a point
on the mysql behaviour, one of the implications of my system is lots of
queries
so the memory hunger of mysql seems justified.

I think I have mod_python 3.2.8, I will have a look

Considering memory leaks, do you think, altering the minserver,
maxserver, spare and alike parameters configuring apache, If there are
memory leaks killing the app in some automatic way does not clog up log
files etc. I rather have the overhead of process creation than then a
down server when I am windsurfing.  

Well this is the first time I really use open source for a development
project, although I have been heavily involved in the first real Linux
kernel, I saw possible trouble like this lurking around the corner.

what a laugh we had back in those days. I remember driving to my friend
with my development system attached to a small UPS which happened to be
the same size as my computer casing, keeping it running in the middle of
a debug session since I finally reproduces a serious memory leak in the
part of the TCP/IP stack we were developing, I guess you have a system
around running my code for doing a lot of hard work, sending and
receiving network information, and are very happy that leak finally
plugged with a decent piece of code, I know it is a frustrating process,
I have been there.

I set myself to fix this issue but found a pile of possibilities, thanx
guys

I did not name the versions I run for a few reasons

The most important one: I know updates are solving problems, but people
seem to forget that they almost always introduce a few new ones, 

I compute the following code:

for word in release_notes:
	if word in [&quot;better&quot;,&quot;increased&quot;,&quot;quicker&quot;,&quot;you get the point&quot;]:
		new_bug+=1

I first really try to investigate the problem and not try to solve what
I do not understand. Simply sending version numbers results in TRY that
new version.... I can go in deeper if I feel I need to, to help the
community solving things. (this is not a promise, I am really busy at
the moment)

I have another reason which is nice to know, I have some experience with
these noisy boxed not doing what I am asking, with that comes feelings,
and my feelings are telling me that I am wrong somewere.

Anyway, I'll report stuff

Martijn

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021637.html">[mod_python] modpython, mysqldb best paractice
</A></li>
	<LI>Next message: <A HREF="021638.html">[mod_python] modpython, mysqldb best paractice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21636">[ date ]</a>
              <a href="thread.html#21636">[ thread ]</a>
              <a href="subject.html#21636">[ subject ]</a>
              <a href="author.html#21636">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
