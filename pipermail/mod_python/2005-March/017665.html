<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] OS X / Apache 2 / mod_python bug
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20OS%20X%20/%20Apache%202%20/%20mod_python%20bug&In-Reply-To=3b4cd6a0e473e17c4a012732625f926e%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017661.html">
   <LINK REL="Next"  HREF="017666.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] OS X / Apache 2 / mod_python bug</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jamie Kirkpatrick</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20OS%20X%20/%20Apache%202%20/%20mod_python%20bug&In-Reply-To=3b4cd6a0e473e17c4a012732625f926e%40dscpl.com.au"
       TITLE="[mod_python] OS X / Apache 2 / mod_python bug">jkp at kirkconsulting.co.uk
       </A><BR>
    <I>Wed Mar 16 04:42:16 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017661.html">[mod_python] OS X / Apache 2 / mod_python bug
</A></li>
        <LI>Next message: <A HREF="017666.html">[mod_python] OS X / Apache 2 / mod_python bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17665">[ date ]</a>
              <a href="thread.html#17665">[ thread ]</a>
              <a href="subject.html#17665">[ subject ]</a>
              <a href="author.html#17665">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&lt;snip&gt;

&gt;<i> Next thing to try would be to add logging inside the 
</I>&gt;<i> get_interpreter() function.
</I>&gt;<i> Suggest logging the &quot;name&quot; input parameter supplied to the function, 
</I>&gt;<i> but more
</I>&gt;<i> importantly log whether the &quot;interpreters&quot; global variable is 
</I>&gt;<i> actually set when
</I>&gt;<i> the function is being called. Ie.,
</I>&gt;<i>
</I>&gt;<i>     if (!interpreters) {
</I>&gt;<i>         ap_log_rerror(APLOG_MARK, APLOG_NOERRNO|APLOG_ERR, 0, req,
</I>&gt;<i>                       &quot;python_handler: interpreters dictionary not 
</I>&gt;<i> initialised.&quot;);
</I>&gt;<i>         return NULL;
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i> There is a return near the end of the function as well which doesn't 
</I>&gt;<i> log anything
</I>&gt;<i> which you could add something for as well.
</I>&gt;<i>
</I>&gt;<i>         if (!idata-&gt;obcallback)
</I>&gt;<i>         {
</I>&gt;<i> #ifdef WITH_THREAD
</I>&gt;<i>             PyEval_ReleaseThread(tstate);
</I>&gt;<i> #endif
</I>&gt;<i>             PyThreadState_Delete(tstate);
</I>&gt;<i>             ap_log_rerror(APLOG_MARK, APLOG_NOERRNO|APLOG_ERR, 0, req,
</I>&gt;<i>                       &quot;python_handler: no interpreter callback 
</I>&gt;<i> found.&quot;);
</I>&gt;<i>
</I>&gt;<i>             return NULL;
</I>&gt;<i>         }
</I>
Firstly, not that this code is slightly different to that which you 
posted -&gt;

if (!idata-&gt;obcallback) {

         idata-&gt;obcallback = make_obcallback(srv);

         if (!idata-&gt;obcallback)
         {
#ifdef WITH_THREAD
             PyEval_ReleaseThread(tstate);
#endif
             PyThreadState_Delete(tstate);
             return NULL;
         }
     }

Anyway, I added the logging though I think you meant to tell me to use 
a different function (ap_log_error?)

I used something along the lines of
             ap_log_error(APLOG_MARK, APLOG_NOERRNO|APLOG_ERR, 0, srv,
              &quot;Error message here.&quot;);

Then I built things again installed and started with a start command.

The log showed this on a call to test.py

[Wed Mar 16 09:25:58 2005] [error] interpreter name that was passed is:
[Wed Mar 16 09:25:58 2005] [error] thegrove.homeip.net
[Wed Mar 16 09:25:59 2005] [notice] mod_python: (Re)importing module 
'test'
[Wed Mar 16 09:25:59 2005] [error] start import
[Wed Mar 16 09:25:59 2005] [error] end import
[Wed Mar 16 09:25:59 2005][error] start handler
[Wed Mar 16 09:25:59 2005] [error] end handler
[Wed Mar 16 09:25:59 2005] [error] interpreter name that was passed is:
[Wed Mar 16 09:26:05 2005] [notice] child pid 24966 exit signal Bus 
error (10)

That's interesting coz it seems that after the request has been 
fulfilled the function is getting called again.  It takes a minute for 
the child PID to die (presumably coz it has not data to work with?).  
Also, just to note that a start now seems to be invoking multiple 
instances of httpd

25282  ??  Ss     0:00.80 /opt/local/apache2/bin/httpd -k start
25283  ??  S      0:00.01 /opt/local/apache2/bin/httpd -k start
25284  ??  S      0:00.01 /opt/local/apache2/bin/httpd -k start
25285  ??  S      0:00.01 /opt/local/apache2/bin/httpd -k start
25286  ??  S      0:00.00 /opt/local/apache2/bin/httpd -k start
25287  ??  S      0:00.01 /opt/local/apache2/bin/httpd -k start

Next after a restart:  just after restarting, before calling anything I 
check the logs -

[Wed Mar 16 09:33:26 2005] [error] interpreter name that was passed is:
[Wed Mar 16 09:33:26 2005] [error] interpreter name that was passed is:
[Wed Mar 16 09:33:26 2005] [error] interpreter name that was passed is:
[Wed Mar 16 09:33:26 2005] [error] interpreter name that was passed is:
[Wed Mar 16 09:33:26 2005] [error] interpreter name that was passed is:

A minute or so later I check back and i see

[Wed Mar 16 09:33:32 2005] [warn] child process 25283 still did not 
exit, sending a SIGTERM
[Wed Mar 16 09:33:32 2005] [warn] child process 25284 still did not 
exit, sending a SIGTERM
[Wed Mar 16 09:33:32 2005] [warn] child process 25285 still did not 
exit, sending a SIGTERM
[Wed Mar 16 09:33:32 2005] [warn] child process 25286 still did not 
exit, sending a SIGTERM
[Wed Mar 16 09:33:32 2005] [warn] child process 25287 still did not 
exit, sending a SIGTERM

So for some reason it is spawing lots of children and then killing them 
off one by one after the restart.

Seems odd to me that it is calling the get_interpreter() function here 
on a restart ( I would have imagined that would only happen when you 
call a script), anyway...the bit that we were after - the logs relating 
to trying to pull the page up after the restart: (I did it two times, 
so you can see how the same sequence repeats each time)

[Wed Mar 16 09:34:43 2005] [error] interpreter name that was passed is:
[Wed Mar 16 09:34:43 2005] [error] thegrove.homeip.net
[Wed Mar 16 09:34:43 2005] [error] python_handler: interpreters 
dictionary not initialised.
[Wed Mar 16 09:35:10 2005] [error] interpreter name that was passed is:
[Wed Mar 16 09:35:10 2005] [error] thegrove.homeip.net
[Wed Mar 16 09:35:10 2005] [error] python_handler: interpreters 
dictionary not initialised.

So a name is passed in, but it seems that global variable is not 
getting set :/

Right - i'll wait for you to get back to me now.  I appoligise for not 
being able to take more initiative but I just havent got the time to 
lerarn the Apache API and to read all the code.  I would actually be 
interested in some of this at a later point though since I am keen to 
port an authentication module to apache2.

Look forward to hearing back from you.

Jamie

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017661.html">[mod_python] OS X / Apache 2 / mod_python bug
</A></li>
	<LI>Next message: <A HREF="017666.html">[mod_python] OS X / Apache 2 / mod_python bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17665">[ date ]</a>
              <a href="thread.html#17665">[ thread ]</a>
              <a href="subject.html#17665">[ subject ]</a>
              <a href="author.html#17665">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
