<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Question about vampire module loading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Question%20about%20vampire%20module%20loading&In-Reply-To=b16e3ab705032804374c7af36d%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017776.html">
   <LINK REL="Next"  HREF="017780.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Question about vampire module loading</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Question%20about%20vampire%20module%20loading&In-Reply-To=b16e3ab705032804374c7af36d%40mail.gmail.com"
       TITLE="[mod_python] Question about vampire module loading">grahamd at dscpl.com.au
       </A><BR>
    <I>Mon Mar 28 16:38:03 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017776.html">[mod_python] Question about vampire module loading
</A></li>
        <LI>Next message: <A HREF="017780.html">[mod_python] Internal redirect does not end processing and session
 is not saved on internal redirect - mpservlets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17781">[ date ]</a>
              <a href="thread.html#17781">[ thread ]</a>
              <a href="subject.html#17781">[ subject ]</a>
              <a href="author.html#17781">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>First off, need to pass request object as third argument to 
importModule()
if in that sub module you are intending to do global level config search
and additional imports. If this isn't done and you use __req__ from the
sub module it will be None. See changes below.

Also suggest better way of using HTMLTemplate below.

On 28/03/2005, at 10:37 PM, Keerati Inochanon wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I have been experimenting with vampire a little, and having problems
</I>&gt;<i> with module loading. I store handlers in $documentroot and some other
</I>&gt;<i> handlers in $documentroot/modules.
</I>&gt;<i>
</I>&gt;<i> Here is my rough directory structure:
</I>&gt;<i> $documentroot:
</I>&gt;<i> index.html index.py login.html login.py modules register.html 
</I>&gt;<i> register.py
</I>&gt;<i>
</I>&gt;<i> $documentroot/modules:
</I>&gt;<i> SessionManagement.py Settings.py UserManagement.py
</I>&gt;<i>
</I>&gt;<i> In my login.py file, I import the module using vampire importModule 
</I>&gt;<i> mechanism:
</I>&gt;<i>
</I>&gt;<i> config = vampire.loadConfig(__req__, &quot;.vampire&quot;)
</I>&gt;<i> directory = config.get(&quot;Modules&quot;, &quot;common&quot;)
</I>&gt;<i> UserManagement = vampire.importModule(&quot;UserManagement&quot;, directory)
</I>
Change this to:

   UserManagement = vampire.importModule(&quot;UserManagement&quot;, directory, 
__req__)

&gt;<i> SessionManagement = vampire.importModule(&quot;SessionManagement&quot;, 
</I>&gt;<i> directory)
</I>&gt;<i> --
</I>&gt;<i>
</I>&gt;<i> In my UserManagement.py, I also need some stuff from
</I>&gt;<i> SessionManagement, so I also do:
</I>&gt;<i>
</I>&gt;<i> config = vampire.loadConfig(__req__, &quot;.vampire&quot;)
</I>&gt;<i> directory = config.get(&quot;Modules&quot;, &quot;common&quot;)
</I>&gt;<i> SessionManagement = vampire.importModule(&quot;SessionManagement&quot;, 
</I>&gt;<i> directory)
</I>
Change this to:

   SessionManagement = vampire.importModule(&quot;SessionManagement&quot;, 
directory, __req__)

&gt;<i> Settings = vampire.importModule(&quot;Settings&quot;, directory)
</I>&gt;<i> --
</I>&gt;<i>
</I>&gt;<i> My handler_html in login.py:
</I>&gt;<i>
</I>&gt;<i> def handler_html(req, error=''):
</I>&gt;<i>   if not os.path.exists(req.filename):
</I>&gt;<i>     return apache.DECLINED
</I>&gt;<i>
</I>&gt;<i>   # Immediately redirect to the main page if session exists
</I>&gt;<i>   session = SessionManagement.checkSession(req)
</I>&gt;<i>   if session['isAuthorized'] and session['username']:
</I>&gt;<i>     util.redirect(req, 'main.html')
</I>&gt;<i>
</I>&gt;<i>   message = ''
</I>&gt;<i>   if error == 'invalid':
</I>&gt;<i>     message = 'invalid username/password'
</I>&gt;<i>
</I>&gt;<i>   def renderTemplate(template, error):
</I>&gt;<i>     template.result.content = error
</I>&gt;<i>
</I>&gt;<i>   html = open(req.filename, 'r')
</I>&gt;<i>   template = HTMLTemplate.Template(renderTemplate, html.read())
</I>&gt;<i>   html.close()
</I>
You can replace these five lines with:

   template = vampire.loadTemplate(req.filename)
   template.result.content = error

Ie., use Vampire's internal loading and caching system for HTMLTemplate.
It will do automatic reloading of source HTML when changes are made to 
it.

BTW, where do you render the page and return it. Ie.,

   req.content_type = &quot;text/html&quot;
   req.send_http_header()
   req.write(template.render())

&gt;<i>
</I>&gt;<i> def handler_html(req, error=''):
</I>&gt;<i>   if not os.path.exists(req.filename):
</I>&gt;<i>     return apache.DECLINED
</I>&gt;<i>
</I>&gt;<i>   # Immediately redirect to the main page if session exists
</I>&gt;<i>   session = SessionManagement.checkSession(req)
</I>&gt;<i>   if session['isAuthorized'] and session['username']:
</I>&gt;<i>     util.redirect(req, 'main.html')
</I>&gt;<i>
</I>&gt;<i>   message = '';
</I>&gt;<i>   if error == 'invalid':
</I>&gt;<i>     message = 'invalid username/password'
</I>&gt;<i>
</I>&gt;<i>   def renderTemplate(template, error):
</I>&gt;<i>     template.result.content = error
</I>&gt;<i>
</I>&gt;<i>   html = open(req.filename, 'r')
</I>&gt;<i>   template = HTMLTemplate.Template(renderTemplate, html.read())
</I>&gt;<i>   html.close()
</I>
Similarly:


   template = vampire.loadTemplate(req.filename)
   template.result.content = error

   req.content_type = &quot;text/html&quot;
   req.send_http_header()
   req.write(template.render())


&gt;<i> --
</I>&gt;<i>
</I>&gt;<i> My httpd.conf:
</I>&gt;<i>
</I>&gt;<i> &lt;Directory &quot;/home/www/testing&quot;&gt;
</I>&gt;<i>         PythonOption VampireDirectoryIndex index.html
</I>&gt;<i>         SetHandler python-program
</I>&gt;<i>         PythonHandler vampire
</I>&gt;<i>         PythonPath 'sys.path'
</I>&gt;<i> #       PythonOption VampireDefaultHandlers On
</I>&gt;<i>         PythonDebug On
</I>&gt;<i>         &lt;Files ~ &quot;^\.vampire&quot;&gt;
</I>&gt;<i>           Order allow,deny
</I>&gt;<i>           deny from all
</I>&gt;<i>         &lt;/Files&gt;
</I>&gt;<i> &lt;/Directory&gt;
</I>&gt;<i> --
</I>&gt;<i>
</I>&gt;<i> When accessing login.html, I get this error:
</I>&gt;<i> Mod_python error: &quot;PythonHandler vampire&quot;
</I>&gt;<i>
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i>
</I>&gt;<i>   File &quot;/usr/lib/python2.3/site-packages/mod_python/apache.py&quot;, line
</I>&gt;<i> 299, in HandlerDispatch
</I>&gt;<i>     result = object(req)
</I>&gt;<i>
</I>&gt;<i>   File &quot;/usr/lib/python2.3/site-packages/vampire/lookup.py&quot;, line 585,
</I>&gt;<i> in _handler
</I>&gt;<i>     module = _import(req,file)
</I>&gt;<i>
</I>&gt;<i>   File &quot;/usr/lib/python2.3/site-packages/vampire/lookup.py&quot;, line 53, 
</I>&gt;<i> in _import
</I>&gt;<i>     module = _moduleCache.importModule(name,directory,req)
</I>&gt;<i>
</I>&gt;<i>   File &quot;/usr/lib/python2.3/site-packages/vampire/cache.py&quot;, line 181,
</I>&gt;<i> in importModule
</I>&gt;<i>     execfile(file,module.__dict__)
</I>&gt;<i>
</I>&gt;<i>   File &quot;/home/www/testing/login.py&quot;, line 9, in ?
</I>&gt;<i>     UserManagement = vampire.importModule(&quot;UserManagement&quot;, directory)
</I>&gt;<i>
</I>&gt;<i>   File &quot;/usr/lib/python2.3/site-packages/vampire/cache.py&quot;, line 306,
</I>&gt;<i> in importModule
</I>&gt;<i>     return _moduleCache.importModule(name,path,req)
</I>&gt;<i>
</I>&gt;<i>   File &quot;/usr/lib/python2.3/site-packages/vampire/cache.py&quot;, line 181,
</I>&gt;<i> in importModule
</I>&gt;<i>     execfile(file,module.__dict__)
</I>&gt;<i>
</I>&gt;<i>   File &quot;/home/www/testing/modules/UserManagement.py&quot;, line 8, in ?
</I>&gt;<i>     config = vampire.loadConfig(__req__, &quot;.vampire&quot;)
</I>&gt;<i>
</I>&gt;<i>   File &quot;/usr/lib/python2.3/site-packages/vampire/config.py&quot;, line 263,
</I>&gt;<i> in loadConfig
</I>&gt;<i>     return _configCache.loadConfig(req,name)
</I>&gt;<i>
</I>&gt;<i>   File &quot;/usr/lib/python2.3/site-packages/vampire/config.py&quot;, line 198,
</I>&gt;<i> in loadConfig
</I>&gt;<i>     req.vampire = { &quot;config&quot;: {} }
</I>&gt;<i>
</I>&gt;<i> AttributeError: 'NoneType' object has no attribute 'vampire'
</I>&gt;<i> --
</I>&gt;<i>
</I>&gt;<i> I was wondering whether what I am doing is allowed or not. What should
</I>&gt;<i> I do to get around it? I am using vampire-1.5. Python, mod_python, and
</I>&gt;<i> vampire are still pretty new to me. Please let me know if you need any
</I>&gt;<i> further information. Thank you very much in advance.
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Keerati
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017776.html">[mod_python] Question about vampire module loading
</A></li>
	<LI>Next message: <A HREF="017780.html">[mod_python] Internal redirect does not end processing and session
 is not saved on internal redirect - mpservlets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17781">[ date ]</a>
              <a href="thread.html#17781">[ thread ]</a>
              <a href="subject.html#17781">[ subject ]</a>
              <a href="author.html#17781">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
