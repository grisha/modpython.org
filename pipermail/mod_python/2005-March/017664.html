<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] mod_python interpreter creation issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20interpreter%20creation%20issue&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017663.html">
   <LINK REL="Next"  HREF="017702.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] mod_python interpreter creation issue</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20mod_python%20interpreter%20creation%20issue&In-Reply-To="
       TITLE="[mod_python] mod_python interpreter creation issue">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Mar 15 23:19:25 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017663.html">[mod_python] mod_python interpreter creation issue
</A></li>
        <LI>Next message: <A HREF="017702.html">[mod_python] mod_python interpreter creation issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17664">[ date ]</a>
              <a href="thread.html#17664">[ thread ]</a>
              <a href="subject.html#17664">[ subject ]</a>
              <a href="author.html#17664">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>John Belmonte wrote ..
&gt;<i> Several months ago an installation of my application which uses 
</I>&gt;<i> mod_python/Quixote/ZODB/ZEO suddenly stopped working.  It appears to 
</I>&gt;<i> have been caused by a mod_python upgrade.  I'm on Debian and now using
</I>&gt;<i> 3.1.3, although I don't know what version I was using previously.
</I>&gt;<i> 
</I>&gt;<i> I traced the error to a &quot;ImportError: No module named copy_reg&quot; 
</I>&gt;<i> resulting from a cPickle.Pickler() call.  This is caused by Python 
</I>&gt;<i> thinking that it's in restricted execution mode.  The error is happening
</I>&gt;<i> within ZEO's client thread code.
</I>&gt;<i> 
</I>&gt;<i> The following mod_python list message &quot;Threads running in restricted 
</I>&gt;<i> mode?&quot; seems to detail similar problems, but no one responded to the issue.
</I>&gt;<i> 
</I>&gt;<i>    <A HREF="http://www.modpython.org/pipermail/mod_python/2005-January/017129.html">http://www.modpython.org/pipermail/mod_python/2005-January/017129.html</A>
</I>&gt;<i> 
</I>&gt;<i> Tim Peters speculates that mod_python might be starting a new 
</I>&gt;<i> interpreter from time to time using the Python C API.  The new 
</I>&gt;<i> interpreter will have distinct copies of the sys module, the sys.modules
</I>&gt;<i> dict, and the sys.path list, triggering Python's restricted execution mode.
</I>&gt;<i> 
</I>&gt;<i> Anyone have some insight to this problem?  Or at least, would someone 
</I>&gt;<i> explain how and when mod_python creates new interpreters?
</I>
For an explaination of interpreters and what gets created when, read:

  <A HREF="http://www.modpython.org/live/mod_python-3.1.2b/doc-html/pyapi-interps.html">http://www.modpython.org/live/mod_python-3.1.2b/doc-html/pyapi-interps.html</A>

The closest I have ever got to problems with restricted mode is the
runtime exception &quot;classes are read-only in restricted mode&quot;.

In my circumstance, which was probably pretty unique in terms of
what I was actually doing, I was trying to communicate between
subinterpreters within the one Apache process using a messaging
system (<A HREF="http://ose.sourceforge.net">http://ose.sourceforge.net</A>).

In order to do this the event system which runs the messaging system
is started up within its own thread from Python. The messaging system
then actually executes in its own right as C++ code, not Python code.

So that messages can come back into the Python world, callbacks are
registered in the C++ world for the Python functions to be called. At
some later point when the messaging system has something it will
execute the Python callback.

What happened though was that when the callback was executed I
got the Python run time error &quot;classes are read-only in restricted mode&quot;.

The cause of this turned out to be because I had created the initial
thread for the messaging system in a dedicated interpreter created
for that purpose by using PythonImport directive with a special
interpreter name.

A programming problem in OSE however meant that it saved away
the thread state corresponding to that special interpreter and it
tried to use that thread state when trying to callback into other
interpreters. Because the thread state wasn't associated with these
other interpreters, it would only execute code in restricted mode.

Correspondingly, the messaging system worked great for where
you wanted to communicate within the one interpreter and to outside
processes, but not between multiple interpreters created by mod_python
in the same Apache process. I have yet to fix OSE to make it work
but might be motivated now to do something about it.

How is this tale relevant. Well, it may if any of those packages you
are using have a C/C++ based component which operates a distinct
thread which at some point needs to callback into Python code.

Now you may think, &quot;but I don't create any extra interpreters&quot;, but
that may not matter. This is because there are some bugs in the
mod_python code which can cause multiple sub interpreters of the
same name to be errornously created if a web server is under load
immediately from the point it was started and you are using a
multithread MPM.

What the bug means is that an interpreter gets created with a specific
name but because of inadequate thread locking on the creation of
interpreters, a second interpreter of the same name can get created
at the same time. One of these will get thrown away, with possibly
leaking of resources and after that you wouldn't normally notice
anything.

Theorectically however, if the first of those interpreters initialised some
C/C++ based module which created an internal thread it may have
saved away the thread state for that interpreter. Now if the second
interpreter registered some callback with C/C++ code, when that
code executes the callback, the saved thread state could be wrong
for that interpreter and thus it may execute in restricted mode.

Now all this may be totally irrelevant, but thread state problems and
callbacks is the only way I have seen that restricted mode can be triggered,
so thus simple mentioning it in case it might be helpful.

As to what to do about it, first thing would be to patch the thread
problems in mod_python using patches at:

  <A HREF="http://www.dscpl.com.au/projects/vampire/PATCHES">http://www.dscpl.com.au/projects/vampire/PATCHES</A>

If however you aren't using a multithread MPM, this may make no
difference at all.

The only other thing I can add is to ask whether you are using a
multithreaded MPM? Do any of the third party packages create
internal threads? Do any of the third party packages have a C/C++
component to them?

Hope this helps.

Graham
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017663.html">[mod_python] mod_python interpreter creation issue
</A></li>
	<LI>Next message: <A HREF="017702.html">[mod_python] mod_python interpreter creation issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17664">[ date ]</a>
              <a href="thread.html#17664">[ thread ]</a>
              <a href="subject.html#17664">[ subject ]</a>
              <a href="author.html#17664">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
