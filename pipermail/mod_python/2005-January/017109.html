<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Cookie patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Cookie%20patch&In-Reply-To=c298f2d7050113094866ad223c%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017108.html">
   <LINK REL="Next"  HREF="017113.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Cookie patch</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Gregory (Grisha) Trubetskoy</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Cookie%20patch&In-Reply-To=c298f2d7050113094866ad223c%40mail.gmail.com"
       TITLE="[mod_python] Cookie patch">grisha at modpython.org
       </A><BR>
    <I>Fri Jan 14 13:02:26 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017108.html">[mod_python] Re: Cookie patch
</A></li>
        <LI>Next message: <A HREF="017113.html">[mod_python] Session initializatin failes - unsubscriptable object
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17109">[ date ]</a>
              <a href="thread.html#17109">[ thread ]</a>
              <a href="subject.html#17109">[ subject ]</a>
              <a href="author.html#17109">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Just a sidenote on this cookie stuff - just because there is an RFC, 
doesn't mean there is a standard, I had to learn this the hard way.

When making changes to the cookie code we need to make sure it actually 
works, rather than is RFC compliant, which is easier said than done. Most 
browsers out there only support the Netscape cookies (not the RFC) and the 
Netscape &quot;standard&quot; leaves some things to interpretation so behavior at 
times varies between browsers.

Grisha



On Thu, 13 Jan 2005, Nicolas Lehuen wrote:

&gt;<i> On Thu, 13 Jan 2005 09:23:03 -0700, Craig Warren
</I>&gt;<i> &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">craig.warren at encorp.com</A>&gt; wrote:
</I>&gt;&gt;<i>  I found an error while with Cookie module.  When the cookie module parses a
</I>&gt;&gt;<i> cookie, if that cooke has $Version or $Path in it you get an error. My
</I>&gt;&gt;<i> cookie is coming from a java libaray, that puts $Version and $Path in it.
</I>&gt;&gt;<i>  example =&quot;Cookie: $Version=0; pysid=34a9b38c34;$Path=/&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  RFC 2109 mentions $Version and $Path in Section 4.4
</I>&gt;&gt;<i>  <A HREF="http://www.faqs.org/rfcs/rfc2109.html">http://www.faqs.org/rfcs/rfc2109.html</A> 4.4 How an Origin Server Interprets
</I>&gt;&gt;<i> the Cookie Header A user agent returns much of the information in the
</I>&gt;&gt;<i> Set-Cookie header to the origin server when the Path attribute matches that
</I>&gt;&gt;<i> of a new request. When it receives a Cookie header, the origin server should
</I>&gt;&gt;<i> treat cookies with NAMEs whose prefix is $ specially, as an attribute for
</I>&gt;&gt;<i> the adjacent cookie. The value for such a NAME is to be interpreted as
</I>&gt;&gt;<i> applying to the lexically (left-to-right) most recent cookie whose name does
</I>&gt;&gt;<i> not have the $ prefix. If there is no previous cookie, the value applies to
</I>&gt;&gt;<i> the cookie mechanism as a whole. For example, consider the cookie Cookie:
</I>&gt;&gt;<i> $Version=&quot;1&quot;; Customer=&quot;WILE_E_COYOTE&quot;; $Path=&quot;/acme&quot; $Version applies to
</I>&gt;&gt;<i> the cookie mechanism as a whole (and gives the version number for the cookie
</I>&gt;&gt;<i> mechanism). $Path is an attribute whose value (/acme) defines the Path
</I>&gt;&gt;<i> attribute that was used when the Customer cookie was defined in a Set-Cookie
</I>&gt;&gt;<i> response header. In Cookie.py it looks like the code was in place to deal
</I>&gt;&gt;<i> with $Version and $Path, but not finished
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  from  _parse_cookie()
</I>&gt;&gt;<i>  line ~321
</I>&gt;&gt;<i>   l_key = key.lower()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          if (l_key in valid or key[0] == '$'):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>              # &quot;internal&quot; attribute, add to cookie
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>              if l_key == &quot;max-age&quot;:
</I>&gt;&gt;<i>                  l_key = &quot;max_age&quot;
</I>&gt;&gt;<i>              setattr(c, l_key, val)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   The above code checks for the $, but doesn't do anything with it and in
</I>&gt;&gt;<i> fact when it tries to do a setattr with $Version or $Path, you get an error.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  I modified the function to be
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  l_key = key.lower()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          if (l_key in valid or key[0] == '$'):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>              # &quot;internal&quot; attribute, add to cookie
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>              if l_key == &quot;max-age&quot;:
</I>&gt;&gt;<i>                  l_key = &quot;max_age&quot;
</I>&gt;&gt;<i>              if key[0] == '$':
</I>&gt;&gt;<i>                  l_key = l_key[1:]
</I>&gt;&gt;<i>              setattr(c, l_key, val)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  Don't know if this is exactly the correct fix, but it works for me and I
</I>&gt;&gt;<i> thought that I would email the list.  I tried to subscribe to
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">python-dev at httpd.apache.org</A>, but haven't gotten a response back yet, I CC
</I>&gt;&gt;<i> this message to <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">python-dev at httpd.apache.org</A> also.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  Craig Warren
</I>&gt;<i>
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Yeah, your fix seems correct.
</I>&gt;<i>
</I>&gt;<i> The Cookie class has a metaclass which defines slots, so you cannot
</I>&gt;<i> have arbitrary attribute names. The only valid attributes names are
</I>&gt;<i> defined on line 58 ( _valid_attr =...) of Cookie.py, and the version
</I>&gt;<i> and path attributes do not begin with a $. So the attribute names
</I>&gt;<i> which are parsed in _parse_cookie() must have their initial $ removed.
</I>&gt;<i>
</I>&gt;<i> The problem of the current code is that the _valid_attr check is
</I>&gt;<i> useless, but it's not totally spec compliant since the valid attribute
</I>&gt;<i> coming first (as the $Version attribute) should be applied to all
</I>&gt;<i> cookies. So I rewrote the whole function like this :
</I>&gt;<i>
</I>&gt;<i> def _parse_cookie(str, Class):
</I>&gt;<i>    # XXX problem is we should allow duplicate
</I>&gt;<i>    # strings
</I>&gt;<i>    result = {}
</I>&gt;<i>
</I>&gt;<i>    all_cookies_attribute = {}
</I>&gt;<i>
</I>&gt;<i>    valid = Cookie._valid_attr
</I>&gt;<i>
</I>&gt;<i>    c = None
</I>&gt;<i>    matchIter = _cookiePattern.finditer(str)
</I>&gt;<i>
</I>&gt;<i>    for match in matchIter:
</I>&gt;<i>
</I>&gt;<i>        key, val = match.group(&quot;key&quot;), match.group(&quot;val&quot;)
</I>&gt;<i>
</I>&gt;<i>        # we will check whether the cookie name is a valid attribute name
</I>&gt;<i>        # for the previous cookie.
</I>&gt;<i>        l_key = key.lower()
</I>&gt;<i>        # fix from Craig Warren
</I>&gt;<i>        if l_key[0]=='$':
</I>&gt;<i>            l_key=l_key[1:]
</I>&gt;<i>        if l_key == &quot;max-age&quot;:
</I>&gt;<i>            l_key = &quot;max_age&quot;
</I>&gt;<i>
</I>&gt;<i>        if l_key in valid:
</I>&gt;<i>            if not c:
</I>&gt;<i>                # 'global' attribute, will be added to all cookies
</I>&gt;<i>                all_cookies_attribute[l_key]=val
</I>&gt;<i>            else:
</I>&gt;<i>                # &quot;internal&quot; attribute, add to cookie
</I>&gt;<i>                setattr(c, l_key, val)
</I>&gt;<i>        else:
</I>&gt;<i>            # start a new cookie
</I>&gt;<i>            # we don't use l_key so that we keep the initial name
</I>&gt;<i>            # this way we are consistent with the creation of the first cookie
</I>&gt;<i>            # as done in the previous version of the function
</I>&gt;<i>            c = Class(key, val)
</I>&gt;<i>
</I>&gt;<i>            # XXX this is a bit heavyweight since usually we'll have only 0 or 1
</I>&gt;<i>            # global attribute...
</I>&gt;<i>            for key, val in all_cookies_attribute.items():
</I>&gt;<i>                setattr(c,key,val)
</I>&gt;<i>
</I>&gt;<i>            result[key] = c
</I>&gt;<i>
</I>&gt;<i>    return result
</I>&gt;<i>
</I>&gt;<i> Since you've already set up a testing environment, can you test this
</I>&gt;<i> new version of the parsing function ? If it works, I'll check it in.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Nicolas
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I></PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017108.html">[mod_python] Re: Cookie patch
</A></li>
	<LI>Next message: <A HREF="017113.html">[mod_python] Session initializatin failes - unsubscriptable object
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17109">[ date ]</a>
              <a href="thread.html#17109">[ thread ]</a>
              <a href="subject.html#17109">[ subject ]</a>
              <a href="author.html#17109">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
