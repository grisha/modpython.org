<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Catalog of mod_python.publisher problems.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Catalog%20of%20mod_python.publisher%20problems.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017214.html">
   <LINK REL="Next"  HREF="017220.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Catalog of mod_python.publisher problems.</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Catalog%20of%20mod_python.publisher%20problems.&In-Reply-To="
       TITLE="[mod_python] Catalog of mod_python.publisher problems.">grahamd at dscpl.com.au
       </A><BR>
    <I>Mon Jan 24 17:39:30 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="017214.html">[mod_python] psp_site example doesn't work
</A></li>
        <LI>Next message: <A HREF="017220.html">[mod_python] Catalog of mod_python.publisher problems.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17215">[ date ]</a>
              <a href="thread.html#17215">[ thread ]</a>
              <a href="subject.html#17215">[ subject ]</a>
              <a href="author.html#17215">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Graham Dumpleton wrote ..
&gt;<i> 
</I>&gt;<i> Do we need to document properly first the perceived problems and some
</I>&gt;<i> examples of errornous behaviour? This will help to ensure we fix
</I>&gt;<i> everything and provide a basis for some tests of any new implementation.
</I>&gt;<i> I know that such information can be noted against the bug tracker item,
</I>&gt;<i> but is it easier to thrash it out here first.
</I>
FWIW, here is my personal list of problems in mod_python.publisher that
I know about. Note that I have ignored totally the basic issue that sys.path
makes which module you get unpredictable if import_module() is used
directly. This is just mod_python.publisher problems which should in
themselves be fixable whatever may eventually be done about the
import_module() method. Let me know if you want these put on bug
tracker as one item or three items.


Continual reloading of modules
------------------------------

Create a subdirectory called &quot;publisher&quot;. In that directory create a
&quot;.htaccess&quot; file containing:

  SetHandler python-program
  PythonHandler mod_python.publisher
  PythonDebug On

Now create two subdirectories &quot;subdir-1&quot; and &quot;subdir-1&quot;. In both of these
subdirectories create an &quot;index.py&quot; file which contains:

  import os
  def index():
    return os.getpid(),__file__

Restart Apache to clear any cached modules and then cycle between the URLs
corresponding to the two subdirectories. In my case this is:

  /~grahamd/publisher/subdir-1
  /~grahamd/publisher/subdir-2
  /~grahamd/publisher/subdir-1
  /~grahamd/publisher/subdir-2
  ...

The output for each page was in turn:

  (462, '/Users/grahamd/Sites/publisher/subdir-1/index.py')
  (462, '/Users/grahamd/Sites/publisher/subdir-2/index.py')
  (462, '/Users/grahamd/Sites/publisher/subdir-1/index.pyc')
  (462, '/Users/grahamd/Sites/publisher/subdir-2/index.pyc')
  ...

If you look at the Apache error log file you will see something like:

  [Tue Jan 25 09:03:45 2005] [notice] mod_python: Creating 32 session mutexes
  based on 4 max processes and 25 max threads.
  [Tue Jan 25 09:03:45 2005] [notice] Apache/2.0.51 (Unix) mod_python/3.1.3
  Python/2.3 configured -- resuming normal operations

  [Tue Jan 25 09:04:02 2005] [notice] mod_python: (Re)importing module
  'mod_python.publisher'
  [Tue Jan 25 09:04:02 2005] [notice] mod_python: (Re)importing module 'index'
  with path set to '['/Users/grahamd/Sites/publisher/subdir-1']'
  [Tue Jan 25 09:04:16 2005] [notice] mod_python: (Re)importing module 'index'
  with path set to '['/Users/grahamd/Sites/publisher/subdir-2']'
  [Tue Jan 25 09:04:26 2005] [notice] mod_python: (Re)importing module 'index'
  with path set to '['/Users/grahamd/Sites/publisher/subdir-1']'
  [Tue Jan 25 09:04:40 2005] [notice] mod_python: (Re)importing module 'index'
  with path set to '['/Users/grahamd/Sites/publisher/subdir-2']'

You will see how as one cycles between the two URLs corresponding to the
modules, that the modules are reimported everytime.

Note that I ensured that only one Apache server process was initially
started so that all requests served by same process. One can also see this
is the response, which includes the process ID of the server process.

Overall what is returned is correct, but it isn't efficient because each
request is triggering a module import.

Cross contamination of modules
------------------------------

For the above case, change the code in &quot;subdir-1/index.py&quot; to:

  subdir1 = None
  def index():
    return &quot;subdir-1&quot;,globals().keys()

and &quot;subdir-2/index.py&quot; to:

  subdir2 = None
  def index():
    return &quot;subdir-2&quot;,globals().keys()

Accessing &quot;subdir-1&quot; the result is:

  ('subdir-1', ['index', '__mtime__', '__builtins__',
   '__file__', 'subdir1', '__name__', '__doc__'])

Now accessing &quot;subdir-2&quot; the result is:

  ('subdir-2', ['index', '__mtime__', '__builtins__',
   '__file__', 'subdir2', 'subdir1', '__name__', '__doc__'])

Back to &quot;subdir-1&quot; again:

  ('subdir-1', ['index', '__mtime__', '__builtins__',
   '__file__', 'subdir2', 'subdir1', '__name__', '__doc__'])

Because modules of the same name are reimported on top of the existing
module you can end up with cross contamination of modules in respect of
global variables, functions, class definitions, module imports etc.

The most obvious problem this causes with publisher, is that one can
suddenly have appear in a module a function from a different module. This
function then becomes accessible using an appropriate URL via the module
in which it doesn't belong.

Overall this is annoying and could be problematic for those unaware.

Sticky modules obscuring real module
------------------------------------

Create and &quot;index.py&quot;, &quot;subdir-1/index.py&quot; and &quot;subdir-2/index.py&quot; all
containing:

  import os
  def index():
    return os.getpid(),__file__

Now cycle through accessing these in the order:

  index.py
  subdir-1/index.py
  index.py
  subdir-2/index.py
  index.py
  subdir-1/index.py
  index.py
  subdir-2/index.py
  ...

In my case this is:

  /~grahamd/publisher
  /~grahamd/publisher/subdir-1
  /~grahamd/publisher
  /~grahamd/publisher/subdir-2
  /~grahamd/publisher
  /~grahamd/publisher/subdir-1
  /~grahamd/publisher
  /~grahamd/publisher/subdir-2
  /~grahamd/publisher
  ...

The result for this is:

  (521, '/Users/grahamd/Sites/publisher/index.py')
  (521, '/Users/grahamd/Sites/publisher/subdir-1/index.py')
  (521, '/Users/grahamd/Sites/publisher/subdir-1/index.py')
  (521, '/Users/grahamd/Sites/publisher/subdir-2/index.py')
  (521, '/Users/grahamd/Sites/publisher/subdir-2/index.py')
  (521, '/Users/grahamd/Sites/publisher/subdir-1/index.pyc')
  (521, '/Users/grahamd/Sites/publisher/subdir-1/index.pyc')
  (521, '/Users/grahamd/Sites/publisher/subdir-2/index.pyc')
  (521, '/Users/grahamd/Sites/publisher/subdir-2/index.pyc')

One can see that once one of the &quot;index.py&quot; files in the subdirectories is
accessed, they become sticky and the latest one accessed from a subdirectory
is returned instead of the top level one when it is accessed.

This one has got to be a bug.

--
Graham Dumpleton (<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>)

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017214.html">[mod_python] psp_site example doesn't work
</A></li>
	<LI>Next message: <A HREF="017220.html">[mod_python] Catalog of mod_python.publisher problems.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17215">[ date ]</a>
              <a href="thread.html#17215">[ thread ]</a>
              <a href="subject.html#17215">[ subject ]</a>
              <a href="author.html#17215">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
