<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Initializing the interpreter in python_init() instead of
 python_handler()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Initializing%20the%20interpreter%20in%20python_init%28%29%20instead%20of%0A%20python_handler%28%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005662.html">
   <LINK REL="Next"  HREF="005663.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Initializing the interpreter in python_init() instead of
 python_handler()</H1>
    <B>Jack Diederich</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Initializing%20the%20interpreter%20in%20python_init%28%29%20instead%20of%0A%20python_handler%28%29&In-Reply-To="
       TITLE="[mod_python] Initializing the interpreter in python_init() instead of
 python_handler()">jack_diederich at email.com
       </A><BR>
    <I>Mon Sep 16 13:19:25 EST 2002</I>
    <P><UL>
        <LI>Previous message: <A HREF="005662.html">[mod_python] Follow up on install problems.
</A></li>
        <LI>Next message: <A HREF="005663.html">[mod_python] signal handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5660">[ date ]</a>
              <a href="thread.html#5660">[ thread ]</a>
              <a href="subject.html#5660">[ subject ]</a>
              <a href="author.html#5660">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<table border=0 width="100%"><tr><td>
<!--beginarticle-->
<PRE>I just threw some of the python_handler() code into python_init() and it works!

This means that it is possible to do all the imports etc only once, instead of once per child.
I mentioned the possibility here
<A HREF="http://www.modpython.org/pipermail/mod_python/2002-July/002246.html">http://www.modpython.org/pipermail/mod_python/2002-July/002246.html</A>
and compared it to the mod_perl handler here
<A HREF="http://www.modpython.org/pipermail/mod_python/2002-July/002248.html">http://www.modpython.org/pipermail/mod_python/2002-July/002248.html</A>

Basically, we currently do more work than we have to because each child does the same work to initalize the interpreter.  In the easy case where we are using the PythonInterpreter directive to force everyone to use
the same name for the interpreter (in the below example 'MAIN') we can just do the one initilization in python_init() and the children inherit a clone of the result.  I'm not aware of any problems this might cause (wierd shared file handles or something) but I haven't tested it very extensively.  I do some calculations in the main of several of my modules, so having this done once is a decent speed boost at apache startup.

below is my replacement python_init(), it only works if you have

PythonInterpreter 'MAIN'

in your httpd.conf

modified python_init follows, based on ver 2.7.8
GLYPHS AND WARNINGS!
this is just a proof-of-concept, I don't do lots of neccessary error checking
and I've hard coded all my strings instead of reading the apache configuration.
After initializing the MAIN interpreter, it loads my module your_python_module_here.py
and calls its setup function do_our_one_time_global_setup().  The children then get all
the calculated stuff that was done in do_our_one_time_global_setup().

enjoy,

-jack

void python_init(server_rec *s, pool *p)
{

    char buff[255];
    PyObject *m;
    PyObject *obCallBack = NULL;
    interpreterdata *idata;
    PyThreadState *tstate;

    /* pool given to us in ChildInit. We use it for 
       server.register_cleanup() */
    pool *child_init_pool = NULL;

    /* mod_python version */
    ap_add_version_component(VERSION_COMPONENT);
    
    /* Python version */
    sprintf(buff, &quot;Python/%s&quot;, strtok((char *)Py_GetVersion(), &quot; &quot;));
    ap_add_version_component(buff);

    /* initialize global Python interpreter if necessary */
    if (! Py_IsInitialized()) 
    {

	/* initialze the interpreter */
	Py_Initialize();

#ifdef WITH_THREAD
	/* create and acquire the interpreter lock */
	PyEval_InitThreads();
#endif
	/* Release the thread state because we will never use 
	 * the main interpreter, only sub interpreters created later. */
        PyThreadState_Swap(NULL); 

	/* create the obCallBack dictionary */
	interpreters = PyDict_New();
	if (! interpreters) {
	    ap_log_error(APLOG_MARK, APLOG_NOERRNO|APLOG_ERR, s,
			 &quot;python_init: PyDict_New() failed! No more memory?&quot;);
	    exit(1);
	}

	/* NEW STUFF FROM HERE */
	idata = get_interpreter_data(&quot;MAIN&quot;, s);
	tstate = PyThreadState_New(idata-&gt;istate);
	PyThreadState_Swap(tstate);

	m = PyImport_ImportModule(&quot;your_python_module_here&quot;);
	if (!m) {
	  fprintf(stderr, &quot;Couldn't import module\n&quot;);
	} else {
	  obCallBack = PyObject_CallMethod(m, &quot;do_our_one_time_global_setup&quot;, NULL);
	  if (!obCallBack)
	    fprintf(stderr, &quot;CallFunc failed\n&quot;);
	  else
	    fprintf(stderr, &quot;I think it succeeded?\n&quot;);
	}

	PyThreadState_Swap(NULL);
	PyThreadState_Delete(tstate);
	/* TO HERE */

#ifdef WITH_THREAD
	/* release the lock; now other threads can run */
	PyEval_ReleaseLock();
#endif
    }
}



-- 
__________________________________________________________
Sign-up for your own FREE Personalized E-mail at Mail.com
<A HREF="http://www.mail.com/?sr=signup">http://www.mail.com/?sr=signup</A>


</PRE>
<!--endarticle-->
</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005662.html">[mod_python] Follow up on install problems.
</A></li>
	<LI>Next message: <A HREF="005663.html">[mod_python] signal handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5660">[ date ]</a>
              <a href="thread.html#5660">[ thread ]</a>
              <a href="subject.html#5660">[ subject ]</a>
              <a href="author.html#5660">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
