<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Protecting Web apps from to many simultaneous
	clicks/Hacking
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Protecting%20Web%20apps%20from%20to%20many%20simultaneous%0A%09clicks/Hacking&In-Reply-To=200405131416.01552.SAiello%40Jentoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015596.html">
   <LINK REL="Next"  HREF="015600.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Protecting Web apps from to many simultaneous
	clicks/Hacking</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Byron Ellacott</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Protecting%20Web%20apps%20from%20to%20many%20simultaneous%0A%09clicks/Hacking&In-Reply-To=200405131416.01552.SAiello%40Jentoo.com"
       TITLE="[mod_python] Protecting Web apps from to many simultaneous
	clicks/Hacking">bje at apnic.net
       </A><BR>
    <I>Fri May 14 13:39:48 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="015596.html">[mod_python] Protecting Web apps from to
	manysimultaneousclicks/Hacking
</A></li>
        <LI>Next message: <A HREF="015600.html">[mod_python] Protecting Web apps from to many simultaneous
	clicks/Hacking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15597">[ date ]</a>
              <a href="thread.html#15597">[ thread ]</a>
              <a href="subject.html#15597">[ subject ]</a>
              <a href="author.html#15597">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 2004-05-14 at 04:16, <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">SAiello at Jentoo.com</A> wrote:
&gt;<i> I was curious for ideas on how to protect a mod_python web application from 
</I>&gt;<i> someone submitting/requesting data very quickly repeatedly. An example, I am 
</I>
If you mean, 'how do I protect against someone maliciously trying to
overload my server' then the throttling/bandwidth limiting suggestions
already given are useful tools.  If you mean, 'how do I improve my
server's performance to handle high load' then read on.

&gt;<i> building an IMAP webmail application. Currently, if I click the view 'next 
</I>&gt;<i> set of messages in email box' quickly over and over again, that seems to 
</I>&gt;<i> spawn a bunch of apaches trying to service all those requests. One problem is 
</I>&gt;<i> that I really don't want one user being able to make my app take up alot of 
</I>&gt;<i> CPU load by doing this. Another is that I am storing the current message 
</I>&gt;<i> position in a session variable, by spawning a bunch of simultaneous requests 
</I>&gt;<i> I seem to be able to keep clicking 'next' above the total number of messages.
</I>
Use caching.  If you've only just asked the IMAP server for the contents
of message #404, there's no good reason to ask it again.  You could
cache the messages, the message indexes, or even the entire output of a
given request.

Also, you probably shouldn't be storing the 'current message position'
in a session.  This implies that the user is only viewing one page at
once, which in a lot of cases isn't true.  They might open a message in
a new window or tab, for instance, and have two messages open at once. 
Which one is 'current' in that situation?

A possibly better way would be to have the &quot;Next&quot; link, as generated in
response to a request to display a particular message, also include
information about which message should be considered the next message. 
For example, I would probably implement this as a method to display a
message by ID, and for each generated display, include a &quot;Next&quot; button
which generates a request to display message #(ID + 1).

If the functionality of &quot;Next&quot; means &quot;Next Unread&quot; or some such, I'd
probably generate a request to display the next unread message after
message #ID, so once again, the knowledge about the 'current' message is
tied to a particular display.

Another, more serious, problem is that you appear to have a race
condition.  One request might be getting the 'current' message ID,
comparing it to the maximum, then incrementing the session value. 
Another request does the same.  Unfortunately, due to the way
multiprocessing works, one of them preempted the other, and did its work
between the &quot;compare&quot; and the &quot;increment&quot; commands.  Thus, the first
increments the value again, making it too high.

This is serious because my understanding of mod_python.Session is that
it automatically does session locking.  In other words, there should
already be only one simultaneous request per session.

&gt;<i> A quick idea of mine to limit one simultaneous request per session, was at the 
</I>&gt;<i> start of the request, create a session variable that would store the total 
</I>&gt;<i> number of requests for that session. Then I could check the number of 
</I>&gt;<i> requests, and if the variable is greater than 1, sleep until it is lower than 
</I>&gt;<i> 1.
</I>
... so yes, the general idea is sound.  Your implementation is a little
flawed, however.  

&gt;<i> 1	sess=Session.Session(req, None, cookieSecret)
</I>&gt;<i> 2	if not sess.has_key('REQUESTS'):
</I>&gt;<i> 3		sess['REQUESTS']=1
</I>&gt;<i> 4		sess.save()
</I>&gt;<i> 5	else:
</I>&gt;<i> 6		sess['REQUESTS']+=1
</I>&gt;<i> 7		sess.save()
</I>&gt;<i> 8		while sess['REQUESTS']&gt;1:
</I>&gt;<i> 9			sleep(1)
</I>&gt;<i> 10	sess['REQUESTS']-=1
</I>&gt;<i> 11	sess.save()
</I>
I've added line numbers to help the discussion.  So, you create a
session object at line 1.  This is when the locking should already have
occurred.  In lines 2-4, you introduce a race condition: if a second
process preempts your request after line 2, but before line 4, that
process will also get False from sess.has_key('REQUESTS').  This means
two separate processes will reach line 3 thinking they have exclusive
access to the session.  A similar race condition exists between lines 6
and 7.

More problematic, lines 8 and 9 loop until sess['REQUESTS'] &lt;= 1. 
Unfortunately, you didn't refresh the session in that loop, so I would
expect any request entering that loop will never leave it.  You may need
a &quot;sess.load()&quot; in the loop.

Finally, at line 10 you decrement your own, local value, and save that
to the shared session.  This would immediately overwrite any other value
there.  Granted, if you had achieved a lock by this point, what's in
there would be what you expected to be in there.

For what it's worth, a quick test with Apache/2.0.47 (Debian GNU/Linux)
mod_python/3.1.3 Python/2.3.3 shows that &quot;s = Session.Session(req, None,
'foobar')&quot; does in fact do session locking.

In the context of the original request, I'd start by reducing the
response time of each request before I started finding ways to deny
excessive requests. :)

-- 
bje

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015596.html">[mod_python] Protecting Web apps from to
	manysimultaneousclicks/Hacking
</A></li>
	<LI>Next message: <A HREF="015600.html">[mod_python] Protecting Web apps from to many simultaneous
	clicks/Hacking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15597">[ date ]</a>
              <a href="thread.html#15597">[ thread ]</a>
              <a href="subject.html#15597">[ subject ]</a>
              <a href="author.html#15597">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
