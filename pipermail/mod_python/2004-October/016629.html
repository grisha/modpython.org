<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Udate python modules without restarting Apache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Udate%20python%20modules%20without%20restarting%20Apache&In-Reply-To=200410141251.i9ECpYkh076299%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016648.html">
   <LINK REL="Next"  HREF="016627.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Udate python modules without restarting Apache</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Udate%20python%20modules%20without%20restarting%20Apache&In-Reply-To=200410141251.i9ECpYkh076299%40dscpl.com.au"
       TITLE="[mod_python] Udate python modules without restarting Apache">grahamd at dscpl.com.au
       </A><BR>
    <I>Thu Oct 14 17:21:52 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="016648.html">[mod_python] bug in apache.build_cgi_env
</A></li>
        <LI>Next message: <A HREF="016627.html">[mod_python] Udate python modules without restarting Apache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16629">[ date ]</a>
              <a href="thread.html#16629">[ thread ]</a>
              <a href="subject.html#16629">[ subject ]</a>
              <a href="author.html#16629">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Oct 14 14:51, &quot;Nicolas Lehuen&quot; &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">nicolas at lehuen.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Subject: RE: [mod_python] Udate python modules without restarting Apache
</I>&gt;<i>
</I>&gt;<i> This __clone__() method is a very neat idea indeed ! For the moment I prefer
</I>&gt;<i> not to keep any data between reloads (what needs to be kept is in the
</I>&gt;<i> database), but there may be occurrences where such a mechanisms would be
</I>&gt;<i> handy.
</I>
The actual data may be in the database, but if one is using a database
connection pooling object, one has to keep that somewhere. That is one
candidate for types of objects that you may want to preserve across a
reload and not simply throw away.

&gt;<i> Right now I'm trying to use imp.new_module but I get curious results...
</I>&gt;<i> Apparently some classes that are imported from other modules are redefined
</I>&gt;<i> even though they should not. The net result is that some isinstance() tests
</I>&gt;<i> fail where they should not (reminds me of ClassLoader problems in Java). I
</I>&gt;<i> tried to build a simple test case exhibiting the problem, but it does not.
</I>&gt;<i> What's for sure, is that when I do :
</I>&gt;<i> 
</I>&gt;<i> exec source in module.__dict__
</I>&gt;<i> 
</I>&gt;<i> If module is a fake module object (a place holder class Module(object):
</I>&gt;<i> pass), all my code is OK. If it is a real module, I get weird behaviours.
</I>&gt;<i> I'm still investigating on the subject.
</I>
Reloading of modules can always be a problem when one is comparing the
type of objects as you have to be careful that something hasn't stashed away
a copy of an older class object for type comparison, or conversly is using a
newer version of the class object to check the type of an object created from
the older instance.

This was one of the issues that originally came up in prior email, specifically
the Servlet class from mpservlets. In that case it was because a module was
being imported using &quot;import&quot; in one place and &quot;apache.import_module()&quot;
in another. As such there were two actual instances of the Servlet class and
comparing the type of an instance based on one against the other class type
was going to fail.

The problem can still arise even when one consistently uses a module
import and caching mechanism, as such mechanisms typically only look at
the highest level import and not any sub imports that may have been done
by the object. Thus, you can have stale copies of modules still in memory
until the appropriate parent module is also reloaded, flushing out the stale
sub module.

BTW, the __clone__() method could also be conceivably used to copy across
classes as opposed to instances of classes. You might therefore have something
like:

  def __clone__(module):
    module.Interface = Interface

  if not globals().has_key(&quot;Interface&quot;):
    class Interface:
      def method(self,object):  pass

  class Implementation(Interface):
    def method(self,object):
      if isinstance(object,Interface):
        ...

That is, have a simple class definition which defines the interface, much like
interface objects in Java. Have the actual implementation derive from that.
In code create instances of the Implementation, but when doing isinstance()
checks, compare it to the Interface base class.

Thus, the Interface class definition is always the same actual class type object
because it is preserved across reloads. Although the derived class may be
called Implementation in every version of the module, it is actually a different
class type object in memory. To compare types of Implementation objects is
not going to work if instances are based on different versions, but if your
check is for them being a derived instance of Interface, you woud be okay.

Although for a robust system that can easily be updated if necessary without
restarting Apache you could go to this extent, I frankly doubt many, if any at
all would bother to do so.

I will be interested to here what is causing your problem in case there is
something I have missed about how this stuff operates.


--
Graham Dumpleton (<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>)
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016648.html">[mod_python] bug in apache.build_cgi_env
</A></li>
	<LI>Next message: <A HREF="016627.html">[mod_python] Udate python modules without restarting Apache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16629">[ date ]</a>
              <a href="thread.html#16629">[ thread ]</a>
              <a href="subject.html#16629">[ subject ]</a>
              <a href="author.html#16629">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
