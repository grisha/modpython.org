<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: [patch] vampire 1.1 remove unknown query variables
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20%5Bpatch%5D%20vampire%201.1%20remove%20unknown%20query%20variables&In-Reply-To=20041019205650.GD15993%40sventech.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016662.html">
   <LINK REL="Next"  HREF="016651.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: [patch] vampire 1.1 remove unknown query variables</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20%5Bpatch%5D%20vampire%201.1%20remove%20unknown%20query%20variables&In-Reply-To=20041019205650.GD15993%40sventech.com"
       TITLE="[mod_python] Re: [patch] vampire 1.1 remove unknown query variables">grahamd at dscpl.com.au
       </A><BR>
    <I>Wed Oct 20 03:54:40 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="016662.html">[mod_python] Re: [patch] vampire 1.1 remove unknown query variables
</A></li>
        <LI>Next message: <A HREF="016651.html">[mod_python] vampire form validation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16669">[ date ]</a>
              <a href="thread.html#16669">[ thread ]</a>
              <a href="subject.html#16669">[ subject ]</a>
              <a href="author.html#16669">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Oct 19 13:56, Johannes Erdfelt &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">johannes at erdfelt.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Subject: [patch] vampire 1.1 remove unknown query variables
</I>&gt;<i>
</I>&gt;<i> I've been using vampire the last couple of days and I like it, but it
</I>&gt;<i> has some problems some code I originally wrote didn't have.
</I>&gt;<i> 
</I>&gt;<i> This patch fixes a problem where unknown query variables (form
</I>&gt;<i> variables) could cause an internal server error.
</I>&gt;<i> 
</I>&gt;<i> Generally, this shouldn't happen and on a well designed site, it's the
</I>&gt;<i> users error for causing this to occur, but it causes some undue alarm
</I>&gt;<i> when looking at the logs, so I wrote up this patch to remove unknown
</I>&gt;<i> query variables before applying it to the called handler.
</I>&gt;<i> 
</I>&gt;<i> It also prints out an error message if variables are required by the
</I>&gt;<i> handler, but aren't given by the client (it doesn't have a default)
</I>&gt;<i> 
</I>&gt;<i> It applies to vampire 1.1
</I>&gt;<i> 
</I>&gt;<i> JE
</I>&gt;<i> 
</I>&gt;<i> diff -ur vampire-1.1-20041009.orig/packages/vampire/apache.py vampire-1.1-20041009/packages/
</I>vampire/apache.py
&gt;<i> --- vampire-1.1-20041009.orig/packages/vampire/apache.py
</I>	2004-10-08 18:31:50.000000000 -0700
&gt;<i> +++ vampire-1.1-20041009/packages/vampire/apache.py	2004-10-19 13:55:48.000000000 -0700
</I>&gt;<i> @@ -171,4 +171,40 @@
</I>&gt;<i>  
</I>&gt;<i>    # Execute the content handler.
</I>&gt;<i>  
</I>&gt;<i> -  return apply(function,(req,),args)
</I>&gt;<i> +  # Match up the arguments given by the client to the expected arguments
</I>&gt;<i> +  # from the method. We only remove non expected names and don't check for
</I>&gt;<i> +  # expected because the argument may have a default if not set. We use
</I>&gt;<i> +  # exceptions to catch the case where an argument does not have a default.
</I>&gt;<i> +  fc = function.func_code
</I>&gt;<i> +  expected = fc.co_varnames[0:fc.co_argcount]
</I>&gt;<i> + 
</I>&gt;<i> +  # Silently remove any unexpected arguments if we need to
</I>&gt;<i> +  if not fc.co_flags &amp; 0x000C:  # CO_VARARGS | CO_VARKEYWORDS
</I>&gt;<i> +    for name in args.keys():
</I>&gt;<i> +      if name not in expected:
</I>&gt;<i> +        del args[name]
</I>&gt;<i> +
</I>&gt;<i> +  try:
</I>&gt;<i> +    return apply(function,(req,),args)
</I>&gt;<i> +  except TypeError, vars:
</I>&gt;<i> +    missing = []
</I>&gt;<i> +
</I>&gt;<i> +    # Don't worry about the arguments with defaults
</I>&gt;<i> +    argcount = fc.co_argcount
</I>&gt;<i> +    if function.func_defaults:
</I>&gt;<i> +      argcount = argcount - len(function.func_defaults)
</I>&gt;<i> +    # Skip the first argument, which is the req
</I>&gt;<i> +    for name in fc.co_varnames[1:argcount]:
</I>&gt;<i> +      if name not in args:
</I>&gt;<i> +        missing.append(name)
</I>&gt;<i> +
</I>&gt;<i> +    if not len(missing):
</I>&gt;<i> +      raise
</I>&gt;<i> +
</I>&gt;<i> +    # We definately had some missing variables, let's let the user know
</I>&gt;<i> +    req.content_type = &quot;text/plain&quot;
</I>&gt;<i> +    req.status = apache.HTTP_INTERNAL_SERVER_ERROR
</I>&gt;<i> +    req.send_http_header()
</I>&gt;<i> +    req.write(&quot;Call is missing these variables: %s\n&quot; % &quot;, &quot;.join(missing))
</I>&gt;<i> +
</I>&gt;<i> +    return apache.OK
</I>
After looking at this and playing with it a bit, I am actually sort of inclined
to do the check even before the call of the handler even though it introduces
a little bit more overhead. Ie., something like:

@@ -168,6 +169,34 @@
       if len(args[arg]) == 1:
         args[arg] = args[arg][0]
 
+    fc = function.func_code
+
+    expected = fc.co_varnames[0:fc.co_argcount]
+
+    if not fc.co_flags &amp; 0x08:
+      for name in args.keys():
+       if name not in expected:
+         del args[name]
+
+    # Following identifies missing form parameters
+    # and returns a HTTP_BAD_REQUEST instead of a
+    # HTTP_INTERNAL_SERVER error. This at least gives
+    # a bit of an indication it was because of the
+    # request and not a problem with the server.
+
+    missing = []
+
+    argcount = fc.co_argcount
+    if function.func_defaults:
+      argcount = argcount - len(function.func_defaults)
+
+    for name in fc.co_varnames[1:argcount]:
+      if name not in args:
+       missing.append(name)
+
+    if missing:
+      return apache.HTTP_BAD_REQUEST
+
   # Execute the content handler.
 
   return apply(function,(req,),args)

BTW, the code which drops out form parameters that weren't expected
should probably only look for CO_VARKEYWORDS and not CO_VARARGS
as well.

Doing it the above way does mean that all one gets back is HTTP_BAD_REQUEST,
but this might at least be better than HTTP_INTERNAL_SERVER_ERROR as
it indicates that it is a problem with the request rather than the server. But
then, if the HTML page with the bad form post was on the server, one might
say it is a server error anyway as the user didn't formulate the request, your
HTML page did and thus it is your fault and not the users. If this is the case,
no point having the check at all.

One other thought I had was that the above forms processing code in total
could be a fallback in some way. In other words, only done if the code file
containing the content handler didn't provide some form of form handler 
or validation routine.

Think about how mod_python already has the concept of different phases of
processing. At the moment the one just before the content handler being
executed is defined by PythonFixupHandler.

What could perhaps be done with Vampire is between the fixup handler
and the content handler introduce a new phase of processing for dealing
with forms. This would be realised by the same code file as contains the
content handler defining a formhandler() method.

This new method could be passed the req object as with other handlers and
its job would be to use whatever mechanism it wants to validate the form
data and then put it into an appropriate way for supplying as arguments
to the actual content handler. These arguments would be passed back to
Vampire for use within the req object.

Thus, where Vampire finally calls:

  return apply(function,(req,),args)

the &quot;args&quot; would be what the formhandler() had prepared and passed back
through req.

When the formhandler() doesn't like the data, can generate appropriate error
respones if required and for example give back a list of missing fields in a
page if desired.

Hmmm, maybe this is a silly idea. The only thing it gives you, is that if you
want to have form parameters passed as arguments to the content handler,
is a way of generating a better error response if any are missing in the form.
All the other things can still be done as an initial phase of the content handler
anyway.

Based on other emails, it seems that if you want a robust forms processing
system, you are better off just accepting a req object and then use some
sort of form validation suite. Thus, any support for automatically decoding
form parameters in the server-framework (as someone else called it), is
redundant really.

I guess that if you really wanted all the form parameters to appear as normal
variables within the scope of the content handler, rather than doing it as
function arguments, the forms validation code could be passed locals() and
it could stick them straight into the scope of the function. Ie.,

  def validator(req,locals):
    # ...

    locals[&quot;user&quot;] = req.form[&quot;user']

  def handler(req):
    validator(req,locals())
    if user = &quot;...&quot;:
      ...

Anyone do anything like this in their form validator, or is it simpler to still access
it out of the form?

Anyway, people are probably getting sick of my rambling by now. I think I will
just add the kwargs support I need to add for now and leave it be for a while.
There are so many ways of still doing this within the context of the content
handler that any special support isn't really required. Any use of form values
passed as actual arguments to a content handler seems only to be useful for
simple stuff anyway.

--
Graham Dumpleton (<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>)
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016662.html">[mod_python] Re: [patch] vampire 1.1 remove unknown query variables
</A></li>
	<LI>Next message: <A HREF="016651.html">[mod_python] vampire form validation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16669">[ date ]</a>
              <a href="thread.html#16669">[ thread ]</a>
              <a href="subject.html#16669">[ subject ]</a>
              <a href="author.html#16669">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
