<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Mod Python Issue?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mod%20Python%20Issue%3F&In-Reply-To=000001c3f237%24f8544060%247801a8c0%40Mobile">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015028.html">
   <LINK REL="Next"  HREF="015030.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Mod Python Issue?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>David Fraser</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mod%20Python%20Issue%3F&In-Reply-To=000001c3f237%24f8544060%247801a8c0%40Mobile"
       TITLE="[mod_python] Mod Python Issue?">davidf at sjsoft.com
       </A><BR>
    <I>Fri Feb 13 15:54:50 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="015028.html">[mod_python] Status of a running mod_python
</A></li>
        <LI>Next message: <A HREF="015030.html">[mod_python] Mod Python Issue?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15029">[ date ]</a>
              <a href="thread.html#15029">[ thread ]</a>
              <a href="subject.html#15029">[ subject ]</a>
              <a href="author.html#15029">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>ntimm wrote:

&gt;<i>Are you saying import the module with pythonimport command?  Her is a
</I>&gt;<i>piece of one of the scripts basically all scripts look like this except
</I>&gt;<i>different query and results.   I have looked at sql relay  but just
</I>&gt;<i>don't want to change all our code to support it.
</I>&gt;<i>I have tried the pythonImport command but didn't know the correct
</I>&gt;<i>syntax.
</I>&gt;<i>  
</I>&gt;<i>
</I>I don't think the PythonImport command is relevant here, your problem 
isn't with importing modules but connection caching...

&gt;<i>The varweb module contains a lot of the session handling.
</I>&gt;<i>  
</I>&gt;<i>
</I>How many database connections are you getting? I presume you are running 
this under Unix?
Are you aware that you get one connection for each Apache process? It 
may be that you have 20 or more processes, that is why you are seeing 
multiple connections

David

&gt;<i>import sys, shelve, random, pg, md5, time, string
</I>&gt;<i>sys.path.insert(0, &quot;/home/varlog/lib&quot;)
</I>&gt;<i>from mod_python import apache
</I>&gt;<i>#db = pg.connect('varlog','localhost')
</I>&gt;<i>from varweb import *
</I>&gt;<i>
</I>&gt;<i>def default(req,sid):
</I>&gt;<i>        sid = '%s'%(sid)
</I>&gt;<i>        if check_session(sid) == 1:
</I>&gt;<i> 
</I>&gt;<i>[user,auth_level,sla_level,org_id,host_id,ip]=get_sess_info(sid)
</I>&gt;<i>                orgid = '%s' %(org_id)
</I>&gt;<i>                hid = '%s' %(host_id)
</I>&gt;<i>                vquery = &quot;select * from vuln_scan where o_id = %s and
</I>&gt;<i>h_id = %s order by level desc limit 50;&quot; %(orgid,hid)
</I>&gt;<i>                output = vuln(sid,vquery)
</I>&gt;<i>        else:
</I>&gt;<i>                output = var_login_redirect()
</I>&gt;<i>        return output
</I>&gt;<i>
</I>&gt;<i>def vuln(sid,query):
</I>&gt;<i>        table = ['']
</I>&gt;<i>        for data in db.query(query).dictresult():
</I>&gt;<i>                Hid = data['h_id']
</I>&gt;<i>                Oid = data['o_id']
</I>&gt;<i>                Id = data['id']
</I>&gt;<i>                Ip = data['ip']
</I>&gt;<i>                Port = data['port']
</I>&gt;<i>                Nid = data['nessus_id']
</I>&gt;<i>                Adv = data['advisory']
</I>&gt;<i>                Lev = data['level']
</I>&gt;<i>                Date = data['time']
</I>&gt;<i>                dat = '&lt;a
</I>&gt;<i>href=&quot;/text.py/default?sid=%s&amp;id=%s&quot;&gt;Details&lt;/a&gt;' %(sid,Id)
</I>&gt;<i>                False = data['is_false']
</I>&gt;<i>                if False == 0:
</I>&gt;<i>                        False = '&lt;a
</I>&gt;<i>href=&quot;/vulnerabilities.py/false?sid=%s&amp;id=%s&quot;&gt;No&lt;/a&gt;' %(sid,Id)
</I>&gt;<i>                else:
</I>&gt;<i>                        False = 'Yes'
</I>&gt;<i>                html =
</I>&gt;<i>sub_table_r([Hid,Oid,Id,Ip,Port,Nid,Adv,Lev,Date,dat,False])
</I>&gt;<i>                table.append(html)
</I>&gt;<i>        table_html = string.join(table,'\n')
</I>&gt;<i>        output =
</I>&gt;<i>sub_pattern_mult('/var/www/ids-events.com/templates/vuln.html',
</I>&gt;<i>table_html,sid)
</I>&gt;<i>        return output
</I>&gt;<i>
</I>&gt;<i>-----Original Message-----
</I>&gt;<i>From: David Fraser [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">davidf at sjsoft.com</A>] 
</I>&gt;<i>Sent: Friday, February 13, 2004 12:47 AM
</I>&gt;<i>To: ntimm
</I>&gt;<i>Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;<i>Subject: Re: [mod_python] Mod Python Issue?
</I>&gt;<i>
</I>&gt;<i>ntimm wrote:
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>I am running mod python 3.0.4 with apache 2.0.47 connecting to a 
</I>&gt;&gt;<i>postgresql database. The only issue I am having is that each time a 
</I>&gt;&gt;<i>mod python script is called that has a db query in all just select 
</I>&gt;&gt;<i>statements if leaves a instance of postgres running and eventually my 
</I>&gt;&gt;<i>max connection to postgres is hit. I have tried the db.close 
</I>&gt;&gt;<i>statements but then that cause sporadic errors with the connection not
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>being valid. The only way I have found to close the postgres instance 
</I>&gt;&gt;<i>is either restart apache or postgres. I there some mod python variable
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>that I can use or any type of connection pooling Or maybe a apache 
</I>&gt;&gt;<i>config option I have tried messing with the apache config but with no 
</I>&gt;&gt;<i>luck.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I have tried to use PythonImport variable but couldn't get it to work 
</I>&gt;&gt;<i>with the pg module at all.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Any help would be appreciated.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>If you post some of the relevant code it will be easier to see what the
</I>&gt;<i>problem is...
</I>&gt;<i>But basically if you import the pg module, it will not be re-imported
</I>&gt;<i>for each call.
</I>&gt;<i>So you want to set up a global variable that is the connection, then
</I>&gt;<i>just create a new cursor each time the script is run, and close the
</I>&gt;<i>cursor at the end.
</I>&gt;<i>Running under Unix, you will still get multiple connections because
</I>&gt;<i>there are multiple Python Interpreters - one for each Apache process -
</I>&gt;<i>but there will be a limit.
</I>&gt;<i>Not sure about the connection pooling, but have a look at
</I>&gt;<i><A HREF="http://sqlrelay.sourceforge.net/">http://sqlrelay.sourceforge.net/</A> - I haven't used it, but it seems to be
</I>&gt;<i>the kind of thing you want...
</I>&gt;<i>
</I>&gt;<i>David
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015028.html">[mod_python] Status of a running mod_python
</A></li>
	<LI>Next message: <A HREF="015030.html">[mod_python] Mod Python Issue?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15029">[ date ]</a>
              <a href="thread.html#15029">[ thread ]</a>
              <a href="subject.html#15029">[ subject ]</a>
              <a href="author.html#15029">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
