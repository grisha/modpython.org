<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Mod Python Issue?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mod%20Python%20Issue%3F&In-Reply-To=000501c3f253%24db416810%246601a8c0%40forensics">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015031.html">
   <LINK REL="Next"  HREF="015026.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Mod Python Issue?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Juli&#225;n Ciccal&#232;</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Mod%20Python%20Issue%3F&In-Reply-To=000501c3f253%24db416810%246601a8c0%40forensics"
       TITLE="[mod_python] Mod Python Issue?">jciccale at mac.com
       </A><BR>
    <I>Fri Feb 13 18:30:10 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="015031.html">[mod_python] Mod Python Issue?
</A></li>
        <LI>Next message: <A HREF="015026.html">[mod_python] Detecting if running under mod_python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15032">[ date ]</a>
              <a href="thread.html#15032">[ thread ]</a>
              <a href="subject.html#15032">[ subject ]</a>
              <a href="author.html#15032">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I do the following with psycopg:

In my app, at module level, a connection is opened using a specified user
and password and dbname.

So within your mod_python app, you could use a module that opens a
connection at module level and leaves it there. Suppose your module is
called &quot;db.py&quot; (something like this):

import psycopg as pg

con = db.connect( &quot;username=testuser password=testpass dbname=testdb&quot; )


Then you could use it like this:

import db

 def my_func():
	cur = db.cursor()
	cur.execute( &quot;select col1, col2 from table&quot; )
	t = cur.dictfetchall()
	for row in t:
		print &quot;Col1 is &quot; + row[ &quot;col1&quot; ]
		print &quot;Col2 is &quot; + row[ &quot;col2&quot; ]


psycopg implements DB API 2.0 of python so you could you read the docs 
at python.org on DB API 2.0 specs.

The connection pooling and everything is implemented in C, so you would have
to look there to see the code.

The connection gets released when apache is restarted.

Julian

-----Original Message-----
From: Neal Timm [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">ntimm at intellithreat.com</A>] 
Sent: viernes, 13 de febrero de 2004 18:07
To: 'Juli&#225;n Ciccal&#232;'
Subject: RE: [mod_python] Mod Python Issue?

Yea I just installed psycopg will just have to port a lot of code to it.
Can you show me how it does the pooling is it a script or variable I
just did a couple of queries with it and had the same issue of it
leaving a posgres instance open. I couldn't find a lot of docs on it's
usage.

-----Original Message-----
From: Juli&#225;n Ciccal&#232; [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jciccale at mac.com</A>] 
Sent: Friday, February 13, 2004 9:45 AM
To: 'David Fraser'; 'Neal Timm'
Cc: 'ModPython mail list'
Subject: RE: [mod_python] Mod Python Issue?


Neal,

	Im using the psycopg module to connect to postgres, that does
connection pooling itself and is thread safe. I'm running apache 2.0.48
and mod_python 3.1.2b and works great.

You can find psycopg at www.initd.org .

Hope it helps.

Julian

-----Original Message-----
From: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python-bounces at modpython.org</A>
[mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python-bounces at modpython.org</A>] On Behalf Of David Fraser
Sent: viernes, 13 de febrero de 2004 16:17
To: Neal Timm
Cc: ModPython mail list
Subject: Re: [mod_python] Mod Python Issue?

Neal

The danger with closing the connections is that you may have 
multithreaded code trying to use the connection you have closed.
Generally you want to keep some connections open, because it is 
time-consuming opening them, and to do so for each request makes them
slow. How many apache processes are you getting, and how many database 
connections? It should be the same number...
But I'm not sure I'm answering you, maybe somebody else on the list can 
help...

David

Neal Timm wrote:

&gt;<i>Shouldn't these
</I>&gt;<i> postgres: varlog varlog [local] idle
</I>&gt;<i>Die when the apache connection is dropped.
</I>&gt;<i>The only way I can get rid of them is to restart apache or postgres. 
</I>&gt;<i>And ventually when the max db connections is hit it doesn't except any 
</I>&gt;<i>more cause of all these idle process.  I have tried using a db.close 
</I>&gt;<i>statement but then I have come connection issues saying connection is 
</I>&gt;<i>not valid.  Is there any other way I can close these or reuse them. 
</I>&gt;<i>Varweb calls the db with db =pg.DB()
</I>&gt;<i>
</I>&gt;<i>-----Original Message-----
</I>&gt;<i>From: David Fraser [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">davidf at sjsoft.com</A>]
</I>&gt;<i>Sent: Friday, February 13, 2004 7:55 AM
</I>&gt;<i>To: ntimm
</I>&gt;<i>Cc: ModPython mail list
</I>&gt;<i>Subject: Re: [mod_python] Mod Python Issue?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>ntimm wrote:
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>Are you saying import the module with pythonimport command?  Her is a
</I>&gt;&gt;<i>piece of one of the scripts basically all scripts look like this
</I>except
&gt;&gt;<i>different query and results.   I have looked at sql relay  but just
</I>&gt;&gt;<i>don't want to change all our code to support it.
</I>&gt;&gt;<i>I have tried the pythonImport command but didn't know the correct 
</I>&gt;&gt;<i>syntax.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>I don't think the PythonImport command is relevant here, your problem
</I>&gt;<i>isn't with importing modules but connection caching...
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>The varweb module contains a lot of the session handling.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>How many database connections are you getting? I presume you are 
</I>&gt;<i>running
</I>&gt;<i>
</I>&gt;<i>this under Unix?
</I>&gt;<i>Are you aware that you get one connection for each Apache process? It
</I>&gt;<i>may be that you have 20 or more processes, that is why you are seeing 
</I>&gt;<i>multiple connections
</I>&gt;<i>
</I>&gt;<i>David
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>import sys, shelve, random, pg, md5, time, string sys.path.insert(0,
</I>&gt;&gt;<i>&quot;/home/varlog/lib&quot;) from mod_python import apache
</I>&gt;&gt;<i>#db = pg.connect('varlog','localhost')
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>from varweb import *
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>def default(req,sid):
</I>&gt;&gt;<i>       sid = '%s'%(sid)
</I>&gt;&gt;<i>       if check_session(sid) == 1:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>[user,auth_level,sla_level,org_id,host_id,ip]=get_sess_info(sid)
</I>&gt;&gt;<i>               orgid = '%s' %(org_id)
</I>&gt;&gt;<i>               hid = '%s' %(host_id)
</I>&gt;&gt;<i>               vquery = &quot;select * from vuln_scan where o_id = %s and
</I>&gt;&gt;<i>h_id = %s order by level desc limit 50;&quot; %(orgid,hid)
</I>&gt;&gt;<i>               output = vuln(sid,vquery)
</I>&gt;&gt;<i>       else:
</I>&gt;&gt;<i>               output = var_login_redirect()
</I>&gt;&gt;<i>       return output
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>def vuln(sid,query):
</I>&gt;&gt;<i>       table = ['']
</I>&gt;&gt;<i>       for data in db.query(query).dictresult():
</I>&gt;&gt;<i>               Hid = data['h_id']
</I>&gt;&gt;<i>               Oid = data['o_id']
</I>&gt;&gt;<i>               Id = data['id']
</I>&gt;&gt;<i>               Ip = data['ip']
</I>&gt;&gt;<i>               Port = data['port']
</I>&gt;&gt;<i>               Nid = data['nessus_id']
</I>&gt;&gt;<i>               Adv = data['advisory']
</I>&gt;&gt;<i>               Lev = data['level']
</I>&gt;&gt;<i>               Date = data['time']
</I>&gt;&gt;<i>               dat = '&lt;a
</I>&gt;&gt;<i>href=&quot;/text.py/default?sid=%s&amp;id=%s&quot;&gt;Details&lt;/a&gt;' %(sid,Id)
</I>&gt;&gt;<i>               False = data['is_false']
</I>&gt;&gt;<i>               if False == 0:
</I>&gt;&gt;<i>                       False = '&lt;a 
</I>&gt;&gt;<i>href=&quot;/vulnerabilities.py/false?sid=%s&amp;id=%s&quot;&gt;No&lt;/a&gt;' %(sid,Id)
</I>&gt;&gt;<i>               else:
</I>&gt;&gt;<i>                       False = 'Yes'
</I>&gt;&gt;<i>               html =
</I>&gt;&gt;<i>sub_table_r([Hid,Oid,Id,Ip,Port,Nid,Adv,Lev,Date,dat,False])
</I>&gt;&gt;<i>               table.append(html)
</I>&gt;&gt;<i>       table_html = string.join(table,'\n')
</I>&gt;&gt;<i>       output = 
</I>&gt;&gt;<i>sub_pattern_mult('/var/www/ids-events.com/templates/vuln.html',
</I>&gt;&gt;<i>table_html,sid)
</I>&gt;&gt;<i>       return output
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>-----Original Message-----
</I>&gt;&gt;<i>From: David Fraser [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">davidf at sjsoft.com</A>]
</I>&gt;&gt;<i>Sent: Friday, February 13, 2004 12:47 AM
</I>&gt;&gt;<i>To: ntimm
</I>&gt;&gt;<i>Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;&gt;<i>Subject: Re: [mod_python] Mod Python Issue?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>ntimm wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>I am running mod python 3.0.4 with apache 2.0.47 connecting to a 
</I>&gt;&gt;&gt;<i>postgresql database. The only issue I am having is that each time a 
</I>&gt;&gt;&gt;<i>mod python script is called that has a db query in all just select 
</I>&gt;&gt;&gt;<i>statements if leaves a instance of postgres running and eventually my
</I>
&gt;&gt;&gt;<i>max connection to postgres is hit. I have tried the db.close 
</I>&gt;&gt;&gt;<i>statements but then that cause sporadic errors with the connection 
</I>&gt;&gt;&gt;<i>not
</I>&gt;&gt;&gt;<i>   
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>being valid. The only way I have found to close the postgres instance
</I>
&gt;&gt;&gt;<i>is either restart apache or postgres. I there some mod python 
</I>&gt;&gt;&gt;<i>variable
</I>&gt;&gt;&gt;<i>   
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>that I can use or any type of connection pooling Or maybe a apache 
</I>&gt;&gt;&gt;<i>config option I have tried messing with the apache config but with no
</I>
&gt;&gt;&gt;<i>luck.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>I have tried to use PythonImport variable but couldn't get it to work
</I>
&gt;&gt;&gt;<i>with the pg module at all.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Any help would be appreciated.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Thanks,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>If you post some of the relevant code it will be easier to see what 
</I>&gt;&gt;<i>the
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>problem is... But basically if you import the pg module, it will not 
</I>&gt;&gt;<i>be
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>re-imported for each call.
</I>&gt;&gt;<i>So you want to set up a global variable that is the connection, then 
</I>&gt;&gt;<i>just create a new cursor each time the script is run, and close the 
</I>&gt;&gt;<i>cursor at the end. Running under Unix, you will still get multiple 
</I>&gt;&gt;<i>connections because there are multiple Python Interpreters - one for 
</I>&gt;&gt;<i>each Apache process - but there will be a limit.
</I>&gt;&gt;<i>Not sure about the connection pooling, but have a look at
</I>&gt;&gt;<i><A HREF="http://sqlrelay.sourceforge.net/">http://sqlrelay.sourceforge.net/</A> - I haven't used it, but it seems to
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>be
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>the kind of thing you want...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>David
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>
_______________________________________________
Mod_python mailing list
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015031.html">[mod_python] Mod Python Issue?
</A></li>
	<LI>Next message: <A HREF="015026.html">[mod_python] Detecting if running under mod_python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15032">[ date ]</a>
              <a href="thread.html#15032">[ thread ]</a>
              <a href="subject.html#15032">[ subject ]</a>
              <a href="author.html#15032">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
