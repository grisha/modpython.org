<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Segfault with Vampire
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Segfault%20with%20Vampire&In-Reply-To=435AC6A1.4010608%40physics.ox.ac.uk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019392.html">
   <LINK REL="Next"  HREF="019396.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Segfault with Vampire</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Segfault%20with%20Vampire&In-Reply-To=435AC6A1.4010608%40physics.ox.ac.uk"
       TITLE="[mod_python] Segfault with Vampire">grahamd at dscpl.com.au
       </A><BR>
    <I>Sat Oct 22 19:41:03 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="019392.html">[mod_python] Segfault with Vampire
</A></li>
        <LI>Next message: <A HREF="019396.html">[mod_python] Segfault with Vampire
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19394">[ date ]</a>
              <a href="thread.html#19394">[ thread ]</a>
              <a href="subject.html#19394">[ subject ]</a>
              <a href="author.html#19394">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 23/10/2005, at 9:09 AM, Ian Stokes-Rees wrote:

&gt;<i> OK, That looks like it is probably it (changing to just mod_python  
</I>&gt;<i> and then importing pyexpat does cause the seg fault).
</I>&gt;<i>
</I>&gt;<i> The problem is that after upgrading the installed library to expat  
</I>&gt;<i> 1.95.8 (same as Python -- see below), and restarting Apache, I  
</I>&gt;<i> still get seg faults.
</I>&gt;<i>
</I>&gt;<i> Do I need to rebuild Apache, mod_python, or vampire?  I wouldn't  
</I>&gt;<i> have thought so if they are dynamically linked...
</I>
Depending on how old the OS expat was, there is a chance that Apache
may been to be rebuilt but I also wouldn't have expected that it would
be needed. I don't believe that mod_python would need to be rebuilt and
Vampire is just pure Python code so nothing to rebuild there. I am
presuming that when you say it still crashes that that is only when
pyexpat is being imported???

Did you try an actual Apache &quot;stop&quot; and then &quot;start&quot;, rather than a  
&quot;restart&quot;.
There shouldn't be a different but one never knows? If possible can you
reboot the box in case some sort of strange caching is occurring?

Did you also confirm using &quot;ldd&quot; that the &quot;httpd&quot; Apache application  
is picking
up the one in /usr/lib that you replaced. I wouldn't have expected it on
Linux where libexpat is a standard library, but I know that on other  
systems
where expat isn't available, Apache will install its own version  
elsewhere.

A few other things I can suggest to try and debug things. First is,  
after
restarting Apache but before making a request against any mod_python
code, find the process ID of one of Apache process and run:

   /usr/sbin/lsof -p 3625 | grep expat

You will probably need to run this as root or yourself if you ran Apache
manually. This should yield something like:

   httpd   3625 root  mem    REG     253,0   123552    6409040 /usr/ 
lib/libexpat.so.0.5.0

and tells you exactly which libexpat shared library is being used in  
case
ldd actually lied for some reason. Obviously you want it to be using the
new library.

Without involving Apache at all, I think you can induce the same  
conditions
by forcing Python to load libexpat.so when it is run, this is done  
using the
LD_PRELOAD environment variable. I have set it here on the command line
the same time I ran Python.

   [<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl</A> grahamd]$ LD_PRELOAD=/usr/lib/libexpat.so python
   Python 2.3.3 (#1, May  7 2004, 10:31:40)
   [GCC 3.3.3 20040412 (Red Hat Linux 3.3.3-7)] on linux2
   Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more  
information.
   &gt;&gt;&gt; import pyexpat
   &gt;&gt;&gt; pyexpat.version_info
   (1, 95, 8)
   &gt;&gt;&gt;

If there is still a problem, I would expect that loading of pyexpat  
would possibly
cause this to crash as well, but not totally sure. You can run &quot;lsof&quot;  
against this
Python process to confirm it did load libexpat.so.

Anyway, a few things for you to try. Let us know how you go.

Graham

&gt;<i> Python 2.4.1 (#1, Aug 31 2005, 15:59:42)
</I>&gt;<i> [GCC 3.2.3 20030502 (Red Hat Linux 3.2.3-42)] on linux2
</I>&gt;<i> Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
</I>&gt;<i> &gt;&gt;&gt; import pyexpat
</I>&gt;<i> &gt;&gt;&gt; pyexpat.version_info
</I>&gt;<i> (1, 95, 8)
</I>&gt;<i>
</I>&gt;<i> [<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">stokes at grid</A> stokes]$ strings /usr/lib/libexpat* | grep expat_
</I>&gt;<i> expat_external.h
</I>&gt;<i> expat_1.95.8
</I>&gt;<i> expat_1.95.8
</I>&gt;<i> expat_1.95.8
</I>&gt;<i> expat_1.95.5
</I>&gt;<i> expat_1.95.8
</I>&gt;<i>
</I>&gt;<i> Graham Dumpleton wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Vampire imports xmlrpclib, so you may be affected by the expat  
</I>&gt;&gt;<i> library
</I>&gt;&gt;<i> version mismatch problem. See:
</I>&gt;&gt;<i>   <A HREF="http://www.modpython.org/pipermail/mod_python/2005-October/">http://www.modpython.org/pipermail/mod_python/2005-October/</A> 
</I>&gt;&gt;<i> 019348.html
</I>&gt;&gt;<i> for some details. Use the prev/next links for that mailing list  
</I>&gt;&gt;<i> thread to
</I>&gt;&gt;<i> go back through the discussion to get the context.
</I>&gt;&gt;<i> Simplest way to check is to put PythonHandler back to &quot;boo&quot; and in
</I>&gt;&gt;<i> &quot;boo.py&quot; add:
</I>&gt;&gt;<i>   import xmlrpclib
</I>&gt;&gt;<i> If it crashes when access, it is the expat problem and nothing to  
</I>&gt;&gt;<i> do with
</I>&gt;&gt;<i> Vampire itself.
</I>&gt;&gt;<i> In short, upgrade expat to a newer version, or at least the same  
</I>&gt;&gt;<i> version
</I>&gt;&gt;<i> as embedded in Python. See mailing list discussion for how to find  
</I>&gt;&gt;<i> out.
</I>&gt;&gt;<i> Graham
</I>&gt;&gt;<i> On 22/10/2005, at 5:46 AM, Ian Stokes-Rees wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have Apache, Python, and mod_python setup as follows:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  Apache/2.0.53 (Unix) mod_python/3.1.4 Python/2.4.1
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> mod_python works fine, however when I try to use Vampire I get a  
</I>&gt;&gt;&gt;<i> seg fault:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [Fri Oct 21 20:31:38 2005] [notice] mod_python: (Re)importing  
</I>&gt;&gt;&gt;<i> module 'vampire'
</I>&gt;&gt;&gt;<i> [Fri Oct 21 20:31:39 2005] [notice] child pid 23753 exit signal  
</I>&gt;&gt;&gt;<i> Segmentation fault (11)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I can't figure out what the source of the seg fault is.  Vampire  
</I>&gt;&gt;&gt;<i> is in the sys.path.  The only thing I change in the .htaccess is  
</I>&gt;&gt;&gt;<i> &quot;myprob&quot; to &quot;vampire&quot; for the PythonHandler, and I don't touch  
</I>&gt;&gt;&gt;<i> the actual file (resource).  Any thoughts on the source of this  
</I>&gt;&gt;&gt;<i> would be greatly appreciated.  Below are my .htaccess file and  
</I>&gt;&gt;&gt;<i> myprob.py.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Ian.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> .htaccess:
</I>&gt;&gt;&gt;<i> SetHandler mod_python
</I>&gt;&gt;&gt;<i> PythonHandler vampire
</I>&gt;&gt;&gt;<i> PythonDebug On
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> myprob.py:
</I>&gt;&gt;&gt;<i> from mod_python import apache
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> def handler(req):
</I>&gt;&gt;&gt;<i>     req.content_type = &quot;text/plain&quot;
</I>&gt;&gt;&gt;<i>     req.write(&quot;boo&quot;)
</I>&gt;&gt;&gt;<i>     return apache.OK
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;<i>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019392.html">[mod_python] Segfault with Vampire
</A></li>
	<LI>Next message: <A HREF="019396.html">[mod_python] Segfault with Vampire
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19394">[ date ]</a>
              <a href="thread.html#19394">[ thread ]</a>
              <a href="subject.html#19394">[ subject ]</a>
              <a href="author.html#19394">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
