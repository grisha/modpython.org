<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] PyThreadState_Delete: tstate is still current
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20PyThreadState_Delete%3A%20tstate%20is%20still%20current&In-Reply-To=bb84149f0510111633m3e4090c5n2e8b520df4e1b7fb%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019260.html">
   <LINK REL="Next"  HREF="019251.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] PyThreadState_Delete: tstate is still current</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20PyThreadState_Delete%3A%20tstate%20is%20still%20current&In-Reply-To=bb84149f0510111633m3e4090c5n2e8b520df4e1b7fb%40mail.gmail.com"
       TITLE="[mod_python] PyThreadState_Delete: tstate is still current">grahamd at dscpl.com.au
       </A><BR>
    <I>Wed Oct 12 18:04:34 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="019260.html">[mod_python] python server pages
</A></li>
        <LI>Next message: <A HREF="019251.html">[mod_python] PyThreadState_Delete: tstate is still current
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19250">[ date ]</a>
              <a href="thread.html#19250">[ thread ]</a>
              <a href="subject.html#19250">[ subject ]</a>
              <a href="author.html#19250">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Okay, I am blind. Unfortunate that the thread state problem didn't
go away, but only just noticed in the error messages the init()
call argument mismatch.

The problem you are having is that the Apache module is for
mod_python 3.2, but it is still finding the Python modules, ie.,
the mod_python.apache module, from your old mod_python 2.7
installation.

In 2.7, init() took no arguments. In 3.2 it takes two arguments.

Sorry, didn't notice that before. Thus, get rid of the mod_python 2.7
Python modules and ensure 3.2 versions are installed correctly.

Still think something isn't right with the thread state deletion
code. Are you absolutely sure that your newly compiled Apache
module is being used?

Graham

On 12/10/2005, at 9:33 AM, Peter Sanchez wrote:
&gt;<i> Well, I did the patches you suggested, and it didn't help much.  
</I>&gt;<i> Here is the log snippet:
</I>&gt;<i>
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] Apache/2.0.54 (FreeBSD) PHP/ 
</I>&gt;<i> 4.4.0 mod_python/3.2.0b Python/2.4.1 configured -- resuming normal  
</I>&gt;<i> operati
</I>&gt;<i> ons
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 71664 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 71663 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 71660 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 71654 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 71640 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 71634 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 71624 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 69509 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 69490 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 69470 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [notice] child pid 69437 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:07 2005] [error] make_obcallback: could not call  
</I>&gt;<i> init.\n
</I>&gt;<i> TypeError: init() takes exactly 2 arguments (0 given)
</I>&gt;<i> Fatal Python error: PyThreadState_Delete: tstate is still current
</I>&gt;<i> [Tue Oct 11 16:17:08 2005] [notice] child pid 71632 exit signal  
</I>&gt;<i> Abort trap (6)
</I>&gt;<i> [Tue Oct 11 16:17:09 2005] [error] make_obcallback: could not call  
</I>&gt;<i> init.\n
</I>&gt;<i> TypeError: init() takes exactly 2 arguments (0 given)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Over and over again ;) I went back to 3.1.4, since I am testing on  
</I>&gt;<i> a live server (no other choice unfortunately.)
</I>&gt;<i>
</I>&gt;<i> I also tried writing a basic function that does nothing but display  
</I>&gt;<i> a session id, no other modules included and it gave the same  
</I>&gt;<i> results. You guys probably knew that was the case, but just an FYI.
</I>&gt;<i>
</I>&gt;<i> Thanks again,
</I>&gt;<i>
</I>&gt;<i> Peter
</I>&gt;<i>
</I>&gt;<i> On 10/11/05, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote: Making  
</I>&gt;<i> an educated guess (???), in src/mod_python.c, can you modify the
</I>&gt;<i> release_interpreter() function and change:
</I>&gt;<i>
</I>&gt;<i> static void release_interpreter(void)
</I>&gt;<i> {
</I>&gt;<i>     PyThreadState *tstate = PyThreadState_Get();
</I>&gt;<i> #ifdef WITH_THREAD
</I>&gt;<i>     PyEval_ReleaseThread(tstate);
</I>&gt;<i> #endif
</I>&gt;<i>     PyThreadState_Delete(tstate);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> to:
</I>&gt;<i>
</I>&gt;<i> static void release_interpreter(void)
</I>&gt;<i> {
</I>&gt;<i>     PyThreadState *tstate = PyThreadState_Get();
</I>&gt;<i> #ifdef WITH_THREAD
</I>&gt;<i>     PyEval_ReleaseThread(tstate);
</I>&gt;<i> #else
</I>&gt;<i>     PyThreadState_Swap(NULL);
</I>&gt;<i> #endif
</I>&gt;<i>     PyThreadState_Delete(tstate);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> The original doesn't seem quite right to me because it wouldn't revert
</I>&gt;<i> the thread state before deleting it when threads aren't used. There  
</I>&gt;<i> is a
</I>&gt;<i> similar bit of code in get_interpreter() where it has:
</I>&gt;<i>
</I>&gt;<i>         if (!idata-&gt;obcallback)
</I>&gt;<i>         {
</I>&gt;<i> #ifdef WITH_THREAD
</I>&gt;<i>             PyEval_ReleaseThread(tstate);
</I>&gt;<i> #endif                           PyThreadState_Delete(tstate);
</I>&gt;<i>
</I>&gt;<i> which perhaps should be:
</I>&gt;<i>
</I>&gt;<i>         if (!idata-&gt;obcallback)
</I>&gt;<i>         {
</I>&gt;<i> #ifdef WITH_THREAD
</I>&gt;<i>                     PyEval_ReleaseThread(tstate);
</I>&gt;<i> #else
</I>&gt;<i>                     PyThreadState_Swap(NULL);
</I>&gt;<i> #endif
</I>&gt;<i>                     PyThreadState_Delete(tstate);
</I>&gt;<i>
</I>&gt;<i> In this case it only gets invoked when mod_python callback can't be
</I>&gt;<i> created.
</I>&gt;<i>
</I>&gt;<i> If this is indeed the problem, in mod_python 3.1.3, the callback  
</I>&gt;<i> may be
</I>&gt;<i> created okay so it only dies in release_interpreter(). In  
</I>&gt;<i> mod_python 3.2
</I>&gt;<i> though, maybe the callback creation itself is failing meaning it would
</I>&gt;<i> die everytime a child process is created.
</I>&gt;<i>
</I>&gt;<i> If someone has the time and a non BSD platform could you independently
</I>&gt;<i> build a version of Python without thread support and then build
</I>&gt;<i> mod_python 3.2 and see if you get similar crashes. Ie., I feel this
</I>&gt;<i> could be wrong for no threads and not be BSD specific. From what I  
</I>&gt;<i> have
</I>&gt;<i> seen, FreeBSD is the only platform that still doesn't build in threads
</I>&gt;<i> to Python by default and thus why it isn't seen more. I can't do it
</I>&gt;<i> personally as have MacOS X and one has to be careful with multiple
</I>&gt;<i> Python installations there in case one trashes system one  
</I>&gt;<i> accidentally.
</I>&gt;<i> Would rather not risk it. :-)
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> Peter Sanchez wrote ..
</I>&gt;<i> &gt; Thanks for the reference. I tried adding the following line, no  
</I>&gt;<i> real help.
</I>&gt;<i> &gt; So I rebuilt apache2 and mod_python and made sure it didn't have  
</I>&gt;<i> threads
</I>&gt;<i> &gt; support. Now, I still get the same error message, but the entire  
</I>&gt;<i> page is
</I>&gt;<i> &gt; loading correctly?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Same log entries though:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Fatal Python error: PyThreadState_Delete: tstate is still current
</I>&gt;<i> &gt; [Tue Oct 11 13:05:15 2005] [notice] child pid 256 exit signal  
</I>&gt;<i> Abort trap
</I>&gt;<i> &gt; (6)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am wondering if at this point, its not related to Cheetah  
</I>&gt;<i> Template engine,
</I>&gt;<i> &gt; which I use for my templates (will be converting to psp template  
</I>&gt;<i> system
</I>&gt;<i> &gt; very
</I>&gt;<i> &gt; soon) I am not sure if that attempts any threaded functions, etc.  
</I>&gt;<i> Also,
</I>&gt;<i> &gt; I
</I>&gt;<i> &gt; dont know that if it was trying something like that, if it would  
</I>&gt;<i> effect
</I>&gt;<i> &gt; mod_python in this way.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is there any traces I can run, etc. to help debug this issue?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Peter
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 10/11/05, Jim Gallacher &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jg.lists at sympatico.ca</A>&gt; wrote:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Peter Sanchez wrote:
</I>&gt;<i> &gt; &gt; &gt; OK, I tried 3.2.2b from source. Now, when I start apache, the  
</I>&gt;<i> logs
</I>&gt;<i> &gt; just
</I>&gt;<i> &gt; &gt; &gt; go into a loop with the same errors as before :)
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] Apache/2.0.54 (FreeBSD)  
</I>&gt;<i> PHP/4.4.0
</I>&gt;<i> &gt; &gt; &gt; mod_python/3.2.0b Python/2.4.1 configured -- resuming normal  
</I>&gt;<i> operations
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 26791 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 26318 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 26317 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 24178 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 24162 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 24148 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 24133 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 24122 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 24050 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 24033 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 23318 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 23285 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 23266 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [notice] child pid 23195 exit  
</I>&gt;<i> signal Abort
</I>&gt;<i> &gt; &gt; &gt; trap (6)
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [error] make_obcallback: could not  
</I>&gt;<i> call
</I>&gt;<i> &gt; &gt; init.\n
</I>&gt;<i> &gt; &gt; &gt; TypeError: init() takes exactly 2 arguments (0 given)
</I>&gt;<i> &gt; &gt; &gt; Fatal Python error: PyThreadState_Delete: tstate is still  
</I>&gt;<i> current
</I>&gt;<i> &gt; &gt; &gt; [Tue Oct 11 10:26:14 2005] [error] make_obcallback: could not  
</I>&gt;<i> call
</I>&gt;<i> &gt; &gt; init.\n
</I>&gt;<i> &gt; &gt; &gt; TypeError: init() takes exactly 2 arguments (0 given)
</I>&gt;<i> &gt; &gt; &gt; Fatal Python error: PyThreadState_Delete: tstate is still  
</I>&gt;<i> current
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Note, these were being given while NOT loading my mod_python  
</I>&gt;<i> code,
</I>&gt;<i> &gt; I
</I>&gt;<i> &gt; &gt; &gt; think it was doing this for every 'normal' apache instance. I  
</I>&gt;<i> quickly
</I>&gt;<i> &gt; &gt; &gt; reverted back to the last setup (mod_pyton/3.1.4)
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Any other ideas guys?
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Thanks,
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Peter
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; This sounds like the problem I was having trying to get the  
</I>&gt;<i> 3.2.2b unit
</I>&gt;<i> &gt; &gt; tests to pass on FreeBSD. This was discussed on the python-dev  
</I>&gt;<i> list
</I>&gt;<i> &gt; &gt; around Sept 10.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; You can read the archive on gmane at
</I>&gt;<i> &gt; &gt; <A HREF="http://comments.gmane.org/gmane.comp.apache.mod-python.devel/1465">http://comments.gmane.org/gmane.comp.apache.mod-python.devel/1465</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Grisha suggested you can see this sort of problem on FreeBSD where
</I>&gt;<i> &gt; &gt; Python is threaded and Apache is not and offered the following:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; If you built apache without thread support, you may need to add  
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; following lines to $PREFIX/sbin/envvars:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; LD_PRELOAD=/usr/lib/libc_r.so
</I>&gt;<i> &gt; &gt; export LD_PRELOAD
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Regards,
</I>&gt;<i> &gt; &gt; Jim
</I>&gt;<i> &gt; &gt;
</I>&gt;<i>
</I>



</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019260.html">[mod_python] python server pages
</A></li>
	<LI>Next message: <A HREF="019251.html">[mod_python] PyThreadState_Delete: tstate is still current
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19250">[ date ]</a>
              <a href="thread.html#19250">[ thread ]</a>
              <a href="subject.html#19250">[ subject ]</a>
              <a href="author.html#19250">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
