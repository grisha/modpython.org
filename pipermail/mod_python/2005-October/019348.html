<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] The DOs and DONTs of mod_python: second problem
	maybecornered.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20The%20DOs%20and%20DONTs%20of%20mod_python%3A%20second%20problem%0A%09maybecornered.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019347.html">
   <LINK REL="Next"  HREF="019353.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] The DOs and DONTs of mod_python: second problem
	maybecornered.</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20The%20DOs%20and%20DONTs%20of%20mod_python%3A%20second%20problem%0A%09maybecornered.&In-Reply-To="
       TITLE="[mod_python] The DOs and DONTs of mod_python: second problem
	maybecornered.">grahamd at dscpl.com.au
       </A><BR>
    <I>Wed Oct 19 00:16:48 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="019347.html">[mod_python] Gentoo Linux - mod_python - not working
</A></li>
        <LI>Next message: <A HREF="019353.html">[mod_python] The DOs and DONTs of mod_python: second problem
	maybecornered.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19348">[ date ]</a>
              <a href="thread.html#19348">[ thread ]</a>
              <a href="subject.html#19348">[ subject ]</a>
              <a href="author.html#19348">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Philippe C. Martin wrote ..
&gt;<i> Got it I think: you mean more than one library are on my disk ?
</I>
Not quite. The version embedded in the pyexpat module of Python is what
is effectively called statically linked. The libexpat.so in your lib
directory would be dynamically loaded as a shared library at some point
because of some dependency on that library by something else. Usually
this is Apache itself and it will get loaded as soon as Apache is started.

For those who understand what I am talking about, yes I know that the
Python module is dynamically loaded into Python, but the expat part is
statically linked into the Python module .so which is loaded.

&gt;<i> If so, that's the only I found in the LIB path: /usr/lib/libexpat.so.0.5.0.
</I>&gt;<i> 
</I>&gt;<i> So that would mean that apache and python use the same right ?
</I>
No. When Python is run from the command line and pyexpat is imported,
it uses the version statically linked into the Python module .so. When
Apache starts up it will load the libexpat.so from lib.

Now, when mod_python is run in the context of Apache, when the
pyexpat module is imported, because Apache has already loaded libexpat.so
from the lib directory, the version of expat statically linked into the Python
module .so is actually ignored and it uses the version that Apache had
already loaded.

Going back to my machine here (different one this time), from command
line:

  <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at fiona</A>:public_html$ python
  Python 2.3.5 (#1, Aug 12 2005, 10:35:05) 
  [GCC 3.3.2] on sunos5
  Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
  &gt;&gt;&gt; import pyexpat   
  &gt;&gt;&gt; pyexpat.version_info
  (1, 95, 7)

If I run &quot;ldd&quot; on the Apache httpd program to see what version of libexpat
it is using I get:

  <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at fiona</A>:public_html$ ldd /usr/local/sys/apache/bin/httpd 
        libaprutil-0.so.0 =&gt;     /usr/local/lib/libaprutil-0.so.0
        libexpat.so.0 =&gt;         /usr/local/lib/libexpat.so.0
        libapr-0.so.0 =&gt;         /usr/local/lib/libapr-0.so.0
        libsendfile.so.1 =&gt;      /usr/lib/libsendfile.so.1
        librt.so.1 =&gt;    /usr/lib/librt.so.1
        libm.so.1 =&gt;     /usr/lib/libm.so.1
        libsocket.so.1 =&gt;        /usr/lib/libsocket.so.1
        libnsl.so.1 =&gt;   /usr/lib/libnsl.so.1
        libresolv.so.2 =&gt;        /usr/lib/libresolv.so.2
        libpthread.so.1 =&gt;       /usr/lib/libpthread.so.1
        libdl.so.1 =&gt;    /usr/lib/libdl.so.1
        libthread.so.1 =&gt;        /usr/lib/libthread.so.1
        libc.so.1 =&gt;     /usr/lib/libc.so.1
        libaio.so.1 =&gt;   /usr/lib/libaio.so.1
        libmd5.so.1 =&gt;   /usr/lib/libmd5.so.1
        libmp.so.2 =&gt;    /usr/lib/libmp.so.2
        /usr/platform/SUNW,UltraAX-i2/lib/libc_psr.so.1
        /usr/platform/SUNW,UltraAX-i2/lib/libmd5_psr.so.1

The version number on the library itself is useless, so run &quot;strings&quot;
command to get the version number out of the library itself.

  <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at fiona</A>:public_html$ strings /usr/local/lib/libexpat.so.0 | grep expat_
  expat_1.95.2

Thus Apache is actually using 1.95.2 whereas the Python module .so for
pyexpat has 1.95.7 embedded into it.

Now if I create a mod_python.publisher function:

  import pyexpat

  def index():
    return pyexpat.version_info

and access that page, I get returned:

  1952

I don't quite understand why it is returning an integer rather than a tuple,
it may actually indicate a problem. As one can see though, it is now actually
using 1.95.2 which Apache loaded and not that embedded in the pyexpat
Python module .so.

The important bit in the above which you didn't do was to run &quot;strings&quot; on
libexpat.so file. Hopefully this will find that string I was picking up which
indicated which version was used.

BTW, you may be able to confirm whether the expat version is the problem
by simply creating a handler which all it does is import &quot;pyexpat&quot; as above.
If that crashes Apache you probably have a problem as I recollect that just
loading pyexpat will cause the crash, you don't actually have to use it. This
though may only be the case on certain platforms. Another module you
can try importing is &quot;xmlrpclib&quot;. This one from memory definitely crashed
Apache for me when I personally had this expat library version problem on
a Linux platform, even without trying to use the functionality of the module.

Hope I made it clear this time.

Graham

&gt;<i> On Wednesday 19 October 2005 01:33 am, Graham Dumpleton wrote:
</I>&gt;<i> &gt; Philippe C. Martin wrote ..
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Hi,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I'm not sure that's enough info:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Just for my knowledge, why would that have an effect in apache and
</I>&gt;<i> not
</I>&gt;<i> &gt; &gt; the
</I>&gt;<i> &gt; &gt; command line ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Imagine if each version of expat used a slightly different structure
</I>&gt;<i> &gt; layout or structure size for something. An object created in the code
</I>&gt;<i> of
</I>&gt;<i> &gt; the shared library when accessed by C code compiled against the library,
</I>&gt;<i> &gt; but that of a different version, could access the wrong bit of the
</I>&gt;<i> &gt; object and thus follow a bogus pointer and thus crash.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Consider this platform I have access to:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cinderella$ python
</I>&gt;<i> &gt; Python 2.3.4 (#1, Nov 25 2004, 17:05:37)
</I>&gt;<i> &gt; [GCC 3.3.2] on sunos5
</I>&gt;<i> &gt; Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; import pyexpat
</I>&gt;<i> &gt; &gt;&gt;&gt; pyexpat.version_info
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; (1, 95, 7)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; ^D
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cinderella$ cd /usr/local/lib
</I>&gt;<i> &gt; cinderella$ strings libexpat.so | grep expat_
</I>&gt;<i> &gt; expat_1.95.4
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The libexpat.so installed on the system has an older version than that
</I>&gt;<i> &gt; compiled into Python. If something causes the libexpat.so to be linked
</I>&gt;<i> &gt; into Apache at the same time as the Python code executing from
</I>&gt;<i> &gt; mod_python is using the embedded one, if there is an incompatability,
</I>&gt;<i> &gt; there may be a problem.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In this case, I should be looking at upgrading the one installed in the
</I>&gt;<i> &gt; operating system.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Depending on your system the libexpat.so might be in /lib, /usr/lib,
</I>&gt;<i> &gt; /usr/local/lib or elsewhere.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Graham
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; [<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">philippe at pcmsc</A> philippe]$ python
</I>&gt;<i> &gt; &gt; Python 2.4.2 (#1, Oct 18 2005, 04:32:14)
</I>&gt;<i> &gt; &gt; [GCC 3.4.1 (Mandrakelinux 10.1 3.4.1-4mdk)] on linux2
</I>&gt;<i> &gt; &gt; Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; import pyexpat
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; pyexpat.version_info
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; (1, 95, 8)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; import expat
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Traceback (most recent call last):
</I>&gt;<i> &gt; &gt;   File &quot;&lt;stdin&gt;&quot;, line 1, in ?
</I>&gt;<i> &gt; &gt; ImportError: No module named expat
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; [<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">philippe at pcmsc</A> SC]$ find /usr/lib/python2.4/ -name '*expat*' -exec
</I>&gt;<i> ls
</I>&gt;<i> &gt; &gt; -l {}
</I>&gt;<i> &gt; &gt; \;
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 2586 Oct 18
</I>&gt;<i> &gt; &gt; 04:35 /usr/lib/python2.4/test/output/test_pyexpat
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 12012 Oct 18
</I>&gt;<i> &gt; &gt; 04:35 /usr/lib/python2.4/test/test_pyexpat.py
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 11514 Oct 18
</I>&gt;<i> &gt; &gt; 04:36 /usr/lib/python2.4/test/test_pyexpat.pyc
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 11514 Oct 18
</I>&gt;<i> &gt; &gt; 04:36 /usr/lib/python2.4/test/test_pyexpat.pyo
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 36379 Oct 18
</I>&gt;<i> &gt; &gt; 04:35 /usr/lib/python2.4/xml/dom/expatbuilder.py
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 31084 Oct 18
</I>&gt;<i> &gt; &gt; 04:36 /usr/lib/python2.4/xml/dom/expatbuilder.pyc
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 30453 Oct 18
</I>&gt;<i> &gt; &gt; 04:36 /usr/lib/python2.4/xml/dom/expatbuilder.pyo
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 112 Oct 18
</I>&gt;<i> &gt; &gt; 04:35 /usr/lib/python2.4/xml/parsers/expat.py
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 273 Oct 18
</I>&gt;<i> &gt; &gt; 04:36 /usr/lib/python2.4/xml/parsers/expat.pyc
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 273 Oct 18
</I>&gt;<i> &gt; &gt; 04:36 /usr/lib/python2.4/xml/parsers/expat.pyo
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 14408 Oct 18
</I>&gt;<i> &gt; &gt; 04:35 /usr/lib/python2.4/xml/sax/expatreader.py
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 13471 Oct 18
</I>&gt;<i> &gt; &gt; 04:36 /usr/lib/python2.4/xml/sax/expatreader.pyc
</I>&gt;<i> &gt; &gt; -rw-r--r--  1 root root 13471 Oct 18
</I>&gt;<i> &gt; &gt; 04:36 /usr/lib/python2.4/xml/sax/expatreader.pyo
</I>&gt;<i> &gt; &gt; -rwxr-xr-x  1 root root 436290 Oct 18
</I>&gt;<i> &gt; &gt; 04:33 /usr/lib/python2.4/lib-dynload/pyexpat.so
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; On Wednesday 19 October 2005 12:35 am, Graham Dumpleton wrote:
</I>&gt;<i> &gt; &gt; &gt; Philippe C. Martin wrote ..
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; Hi,
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; If any of you wish to look at this: this code works in command
</I>&gt;<i> line,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; and
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; crashes with apache. Something I'm doing is really anoying minidom.
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; you can fetch the xml file responsible at:
</I>&gt;<i> &gt; &gt; &gt; &gt; www.snakecard.com/mod_python
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; Any help is greatly appreciated.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; I you are using a module which does XML processing and it is literally
</I>&gt;<i> &gt; &gt; &gt; crashing, look at what version of the expat libraries that are
</I>&gt;<i> &gt; &gt; &gt; installed on your system.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; A problem that can occur is that Python embeds a version of expat
</I>&gt;<i> &gt; &gt; &gt; within its pyexpat module. If an incompatible version of expat is
</I>&gt;<i> also
</I>&gt;<i> &gt; &gt; &gt; linked in as a shared library, a crash generally occurs.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; To determine the version of expat embedded in Python, do from a command
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; line run Python:
</I>&gt;<i> &gt; &gt; &gt; &gt;&gt;&gt; import pyexpat
</I>&gt;<i> &gt; &gt; &gt; &gt;&gt;&gt; pyexpat.version_info
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; (1, 95, 6)
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Ensure that the version of any expat shared library is at least newer
</I>&gt;<i> &gt; &gt; &gt; than that embedded into Python, or the same version if possible.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Graham
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; --
</I>&gt;<i> &gt; &gt; *************************************
</I>&gt;<i> &gt; &gt; Philippe C. Martin
</I>&gt;<i> &gt; &gt; SnakeCard, LLC
</I>&gt;<i> &gt; &gt; www.snakecard.com
</I>&gt;<i> &gt; &gt; +1 405 694 8098
</I>&gt;<i> &gt; &gt; *************************************
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> *************************************
</I>&gt;<i> Philippe C. Martin
</I>&gt;<i> SnakeCard, LLC
</I>&gt;<i> www.snakecard.com
</I>&gt;<i> +1 405 694 8098
</I>&gt;<i> *************************************
</I></PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019347.html">[mod_python] Gentoo Linux - mod_python - not working
</A></li>
	<LI>Next message: <A HREF="019353.html">[mod_python] The DOs and DONTs of mod_python: second problem
	maybecornered.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19348">[ date ]</a>
              <a href="thread.html#19348">[ thread ]</a>
              <a href="subject.html#19348">[ subject ]</a>
              <a href="author.html#19348">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
