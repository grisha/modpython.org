<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Session Pickling Error II - 3.2.2b
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20Pickling%20Error%20II%20-%203.2.2b&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019179.html">
   <LINK REL="Next"  HREF="019183.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Session Pickling Error II - 3.2.2b</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20Pickling%20Error%20II%20-%203.2.2b&In-Reply-To="
       TITLE="[mod_python] Session Pickling Error II - 3.2.2b">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Oct  4 19:12:45 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="019179.html">[mod_python] Multi-tier functionality
</A></li>
        <LI>Next message: <A HREF="019183.html">[mod_python] Session Pickling Error II - 3.2.2b
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19180">[ date ]</a>
              <a href="thread.html#19180">[ thread ]</a>
              <a href="subject.html#19180">[ subject ]</a>
              <a href="author.html#19180">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Terence MacDonald wrote ..
&gt;<i> 
</I>&gt;<i> On Wed, 2005-10-05 at 07:28 +1000, Graham Dumpleton wrote:
</I>&gt;<i> &gt; The only way I can see there possibly being a problem is if the
</I>&gt;<i> &gt; apache.import_module() method were being used to import
</I>&gt;<i> &gt; pyPgSQL module and it was getting reloaded. I would expect
</I>&gt;<i> &gt; though that pyPgSQL is a standard module in site-packages
</I>&gt;<i> &gt; though so would be imported using &quot;import&quot;. Yes/No?
</I>&gt;<i> &gt; 
</I>&gt;<i> the PyPgSQL module PgSQL.py is imported using the usual &quot;import&quot;, this
</I>&gt;<i> import resides in my database module which itself is imported, by my
</I>&gt;<i> processing modules, using apache.import_module(). I have PythonOption
</I>&gt;<i> AutoReload set to 'on'
</I>&gt;<i> 
</I>&gt;<i> I have stopped using apache.import_module inline to import my database
</I>&gt;<i> module when required and resorted to 'top of the file' import instead.
</I>&gt;<i> The problem appears (fingers crossed!) to have gone away.
</I>&gt;<i> 
</I>&gt;<i> I am still not sure what the problem or the solution is/was, except that
</I>&gt;<i> it is related to import_module, pickling session data that has object
</I>&gt;<i> instances and a pickling helper function (in this case a function named
</I>&gt;<i> _B that aids in pickling PgBoolean instances and is declared in the
</I>&gt;<i> init.py file of the PyPgSQL package) not being at the same address....
</I>&gt;<i> If that makes sense
</I>
In short, in mod_python 3.1.4 and earlier, pickling of anything which
depends on a function object which resides in a module imported using
apache.import_module() will not be reliable. With the changes in 3.2, it
simply will not work.

Lets start with the following tests:

# &gt;&gt;&gt; import pickle
# &gt;&gt;&gt; def a(): pass
# ... 
# &gt;&gt;&gt; pickle.dumps(a)
# 'c__main__\na\np0\n.'
# &gt;&gt;&gt; z = a
# &gt;&gt;&gt; pickle.dumps(z)
# 'c__main__\na\np0\n.'

As you can see, it is possible to pickle the function object. This can
be done even through a copy of the function object by reference,
although in that case the pickled object still refers to the original
function object.

Now lets delete the original function object and pickle the copy again.

# &gt;&gt;&gt; del a
# &gt;&gt;&gt; pickle.dumps(z)
# Traceback (most recent call last):
# ....... deleted traceback
# pickle.PicklingError: Can't pickle &lt;function a at 0x612b0&gt;: it's not found as __main__.a

Because the original function object was deleted from where it was
created, one cannot now even pickle the copy.

Now lets recreate the original function object.

# &gt;&gt;&gt; def a(): pass
# ... 
# &gt;&gt;&gt; pickle.dumps(z)
# Traceback (most recent call last):
# ....... deleted traceback
# pickle.PicklingError: Can't pickle &lt;function a at 0x612b0&gt;: it's not the same object as __main__.a

Notice how the exception message has changed. It recognises that &quot;a&quot;
exists but realises that it is actually a different function object from
which the &quot;z&quot; copy was originally made.

Where problems can start occuring in mod_python 3.1.4 and earlier is if
the function object is cached in some data object which is held outside
of the module the function object was defined in. If the original module
holding the original function object were now reloaded because of the
automatic module reloading mechanism implemented by the
apache.import_module() function, an attempt to pickle the data object
which had cached the function object will fail. This is because the
original function object which had been copied from will have been
overrwritten by a new one when the module was reloaded.

This sort of problem although it will not occur for an instance of a
class object, will occur for the class object type itself.

# &gt;&gt;&gt; class B: pass
# ... 
# &gt;&gt;&gt; b=B()
# &gt;&gt;&gt; pickle.dumps(b)
# '(i__main__\nB\np0\n(dp1\nb.'
# &gt;&gt;&gt; del B
# &gt;&gt;&gt; pickle.dumps(b)
# '(i__main__\nB\np0\n(dp1\nb.'

# &gt;&gt;&gt; class B: pass
# ... 
# &gt;&gt;&gt; pickle.dumps(B)
# 'c__main__\nB\np0\n.'
# &gt;&gt;&gt; C = B
# &gt;&gt;&gt; pickle.dumps(C)
# 'c__main__\nB\np0\n.'
# &gt;&gt;&gt; del B
# &gt;&gt;&gt; pickle.dumps(C)
# Traceback (most recent call last):
# ........ deleted traceback
# pickle.PicklingError: Can't pickle &lt;class __main__.B at 0x53ab0&gt;: it's not found as __main__.B

Thus, in practice, even in mod_python 3.1.4 and earlier I would not
recommend trying to pickle function objects or class object types,
unless you are absolutely gauranteed that the module that the original
function object instance or class object type resides in is only
imported using &quot;import&quot; and is never in anyway reloaded.

If wanted to ensure that no strange problems were going to occur, I
would possibly go as far as suggesting that only basic Python types,
ie., scalars, tuples, lists and dictionaries, be pickled along with
Session objects.

One other obscure area that would worry me in respect of pickling and
mod_python is that different parts of a web site can have different
PythonPath settings. The issue here is that when unpickling certain
objects, such as function objects and class object types, the original
module containing a type must be importable within the context that the
unpickling is occuring. This is so that if it hasn't already been
imported it can be automatically imported.

What though happens when the pickling occurs in one part of the
namespace of a web site and it is unpickled in another where PythonPath
is set differently and the required module hadn't already been imported,
but doesn't appear in any directory specificed by PythonPath. Because of
how mod_python can overlay same named modules over the top of each other
in mod_python 3.1.4, it may also not import the correct module, plus
there is a mixing of the &quot;import&quot; and &quot;apache.import_module()&quot;
mechanisms.

I may be overly paranoid, but that is what defensive programming is all
about if you really want to ensure you are building a robust system
where you avoid any hint of trouble. :-)

Anyway, hope this might help in some way to explain your problems.

Graham




</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019179.html">[mod_python] Multi-tier functionality
</A></li>
	<LI>Next message: <A HREF="019183.html">[mod_python] Session Pickling Error II - 3.2.2b
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19180">[ date ]</a>
              <a href="thread.html#19180">[ thread ]</a>
              <a href="subject.html#19180">[ subject ]</a>
              <a href="author.html#19180">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
