<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] multiple requests to authenhandler for a single url
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20multiple%20requests%20to%20authenhandler%20for%20a%20single%20url&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019182.html">
   <LINK REL="Next"  HREF="019185.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] multiple requests to authenhandler for a single url</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>reghigh</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20multiple%20requests%20to%20authenhandler%20for%20a%20single%20url&In-Reply-To="
       TITLE="[mod_python] multiple requests to authenhandler for a single url">reghigh at thefactz.org
       </A><BR>
    <I>Wed Oct  5 12:04:37 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="019182.html">[mod_python] Multi-tier functionality
</A></li>
        <LI>Next message: <A HREF="019185.html">[mod_python] multiple requests to authenhandler for a single url
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19184">[ date ]</a>
              <a href="thread.html#19184">[ thread ]</a>
              <a href="subject.html#19184">[ subject ]</a>
              <a href="author.html#19184">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am encountering the following issue (which has already been raised on 
this list about a year ago~[1]) relating to multiple calls to 
authenhandler. To demonstrate I have the following:

apache2 httpd.conf
******************

&lt;VirtualHost *:80&gt;
   ServerName static
   DocumentRoot &lt;omitted&gt;

   PythonPath &quot;['&lt;omitted&gt;'] + sys.path&quot;
   PythonAuthenHandler test
   PythonDebug On

   &lt;Location /&gt;
       AuthType Basic
       AuthName &quot;Restricted Area&quot;
       Require valid-user
   &lt;/Location&gt;
&lt;/VirtualHost&gt;

test.py
*******

from mod_python import apache

count = 0

def authenhandler(req):

     pw = req.get_basic_auth_pw()
     user = req.user
     global count
     count += 1
     raise Exception('%s, %s, %s, %s, %s, %s' % \
         (req.handler, req.unparsed_uri,
         req.path_info, req.used_path_info))

Results
*******

Note output is trimmed for readability~[2]

url: <A HREF="http://static/x">http://static/x</A>

Exception: None, /x, , 2

url: <A HREF="http://static/x/y">http://static/x/y</A>

Exception: None, /y, , 2
Exception: None, /x/y, /y, 2

url: <A HREF="http://static/x/y/z">http://static/x/y/z</A>

Exception: None, /z, , 2
Exception: None, /y/z, /y, 2
Exception: None, /x/y/z, /y/z, 2

etc

Note that this is invariant to url naming used: /&lt;1&gt;/&lt;2&gt;/.../&lt;n&gt;

produces exceptions with unparsed uri sections:
   /&lt;n&gt;
   /&lt;n-1&gt;/&lt;n&gt;
   ......

 From now on will use notation &lt;url&gt; -&gt; (url1, url2, ....) to mean a 
given url produced an exceptions in order with unparsed_uri = url1, url2 
etc

Varying Location Directive
==========================

Now experimentation yielded the following. If Location directive was 
changed say to

&lt;Location /x&gt;

Then

   /x -&gt; (/x) = 1 request
   /xx -&gt; not processed by handler
   /x/y -&gt; (/x/y) = 1 request
   /x/x/y -&gt; (/x/y, /x/x/y) = 2 requests

&lt;Location ~ &quot;^/[xy]&quot;&gt;
(NB: this all works with &lt;LocationMatch &quot;^/[xy]&quot;&gt;)

Then

   /x -&gt; (/x) = 1R
   /xx -&gt; (/xx) = 1R
   /x/y -&gt; (/y, /x/y) = 2R
   /x/z/ -&gt; (/x/z) = 1R
   /x/y/z -&gt; (/y/z, /x/y/z) = 2R
   /x/y/z/x -&gt; (/y/z/x, /x/y/z/x) = 2R
   /x/y/x -&gt; (/x, /y/x, /x/y/x) = 3R
   /x/y/ -&gt; (/y/, /x/y/) = 2R

This suggests that somehow the Location directive (i have also confirmed 
similar behaviour using the &lt;Directory&gt;) gives rise to multiple requests 
to authenhandler. However this matching to generate requests as shown 
above does not occur in any simple way (it seems to match from the left 
hand side of the url string but once it encounters a non-match it halts).

Multiple calls not only cause serious overhead if authenticating off a 
database but also play havoc with a system based access control via urls 
since you want to match against the full url but the authenhandler gets 
the full url last out of all the urls it gets passed. What i want is for 
the Location directive to generate a single call to the authenhandler 
with the whole uri being passed.

Does anyone have any ideas what is causing this and how I could solve 
the problem.

Regards,

Tristan

------------------

[1] <A HREF="http://www.modpython.org/pipermail/mod_python/2004-November/016750.html">http://www.modpython.org/pipermail/mod_python/2004-November/016750.html</A>
Complete summary here: <A HREF="http://www.scanmine.com/mp/mod_python_b_p.html">http://www.scanmine.com/mp/mod_python_b_p.html</A>

[2] For example

Exception: None, /y, , 2, None
Exception: None, /x/y, /y, 2, None

in full was:

&lt;pre&gt;
Mod_python error: &quot;PythonAuthenHandler test&quot;

Traceback (most recent call last):

   File 
&quot;/Library/Frameworks/Python.framework/Versions/2.4/lib/python2.4/site-packages/mod_python/apache.py&quot;, 
line 299, in HandlerDispatch
     result = object(req)

   File &quot;/Users/rgrp/Sites/python/test.py&quot;, line 11, in authenhandler
     raise Exception('%s, %s, %s, %s, %s' % \

Exception: None, /y, , 2, None

&lt;/pre&gt;

&lt;pre&gt;
Mod_python error: &quot;PythonAuthenHandler test&quot;

Traceback (most recent call last):

   File 
&quot;/Library/Frameworks/Python.framework/Versions/2.4/lib/python2.4/site-packages/mod_python/apache.py&quot;, 
line 299, in HandlerDispatch
     result = object(req)

   File &quot;/Users/rgrp/Sites/python/test.py&quot;, line 11, in authenhandler
     raise Exception('%s, %s, %s, %s, %s' % \

Exception: None, /x/y, /y, 2, None

&lt;/pre&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019182.html">[mod_python] Multi-tier functionality
</A></li>
	<LI>Next message: <A HREF="019185.html">[mod_python] multiple requests to authenhandler for a single url
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19184">[ date ]</a>
              <a href="thread.html#19184">[ thread ]</a>
              <a href="subject.html#19184">[ subject ]</a>
              <a href="author.html#19184">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
