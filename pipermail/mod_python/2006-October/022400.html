<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] util.FieldStorage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20util.FieldStorage&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022404.html">
   <LINK REL="Next"  HREF="022401.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] util.FieldStorage</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20util.FieldStorage&In-Reply-To="
       TITLE="[mod_python] util.FieldStorage">grahamd at dscpl.com.au
       </A><BR>
    <I>Thu Oct 26 20:45:31 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="022404.html">[mod_python] util.FieldStorage
</A></li>
        <LI>Next message: <A HREF="022401.html">[SPAM] [Fwd: Re: [mod_python] util.FieldStorage]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22400">[ date ]</a>
              <a href="thread.html#22400">[ thread ]</a>
              <a href="subject.html#22400">[ subject ]</a>
              <a href="author.html#22400">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Mike Looijmans wrote ..
&gt;<i> Being the one who moved all that code around, I'm probably the one to 
</I>&gt;<i> explain why.
</I>&gt;<i> 
</I>&gt;<i> In the original version, there was a 'bad' way of detecting whether 
</I>&gt;<i> objects were files or not. If one used the callback mechanism, and 
</I>&gt;<i> provided a file-like object, this object would not be recognised as a 
</I>&gt;<i> file by that code, and that either resulted in the whole file being read
</I>&gt;<i> into memory as a string or in some obscure exception being thrown.
</I>
Okay, so more than just performance issues with field access.

Anyway, I have committed some changes into repository now which
fixes the issue with add_field() but also does things in such a way that
code such as Trac which creates Field instances direct and adds them
to the the list of form fields will still work. It does this by using a
derived list class instance which invalidates the key lookup table on
changes to the list so that the lookup table is rebuilt the next time
it is required. Doing this wasn't as bad as I first thought it would be
as hadn't gone to the extent of properly understanding the code before.
Also include a semi hack in Field class constructor to detect old style
use where code expects more than just the name of the field as
argument and do appropriate initialisation as appropriate.

I'd add a comment to JIRA, but it seems to be playing up at the moment
or at least firewall where I work is screwing up as it tends to do a bit
when JIRA is accessed using https from here.

In all, what the changes allow is for the following to work:

from mod_python import util
from StringIO import StringIO

def index(req):
  req.content_type = 'text/plain'

  req.write('%s\n\n' % req.form.keys())

  for key in req.form.keys():
    req.write('%s %s\n' % (key, req.form.getlist(key)))

  req.write('\n')

  req.form.add_field('e', 'f')

  req.form.list.append(util.Field('g', StringIO('h'),
      &quot;text/plain&quot;, {}, None, {}))
  req.form.list.extend([util.Field('i', StringIO('j'),
      &quot;text/plain&quot;, {}, None, {})])
  req.form.list += [util.Field('k', StringIO('l'),
      &quot;text/plain&quot;, {}, None, {})]

  req.write('%s\n\n' % req.form.keys())

  for key in req.form.keys():
    req.write('%s %s\n' % (key, req.form.getlist(key)))

  req.write('\n')

  return None

If this is accessed with:

  <A HREF="http://localhost:8002/~grahamd/form/?a=b&amp;c=d&amp;e=f">http://localhost:8002/~grahamd/form/?a=b&amp;c=d&amp;e=f</A>

I get:

['a', 'c', 'e']

a [Field('a', 'b')]
c [Field('c', 'd')]
e [Field('e', 'f')]

['a', 'c', 'e', 'g', 'i', 'k']

a [Field('a', 'b')]
c [Field('c', 'd')]
e [Field('e', 'f'), Field('e', 'f')]
g [Field('g', 'h')]
i [Field('i', 'j')]
k [Field('k', 'l')]

As the req.form.keys() method works off the lookup table, you can see
how updates direct to list work okay, meaning stuff like Trac should
work.

You will also note that the 'dictionary' attribute has gone and is hidden
elsewhere. Hopefully people will not try and directly access the
equivalent, but some stern notes in the documentation saying only
to use documented interface might help. :-)

If you can test the updates and especially if someone can test it with
older versions of Trac that would be great.

Graham

&gt;<i> Graham Dumpleton wrote:
</I>&gt;<i> &gt; I'd probably hold off trying to work out any patches yourself. The more
</I>&gt;<i> &gt; I look at FieldStorage the less I understand why some of the changes
</I>&gt;<i> &gt; were made. I'm not talking about how a dictionary based index was
</I>&gt;<i> &gt; added, but more how some of the code was shifted around when it
</I>&gt;<i> &gt; probably didn't need to, with the result being that the code then became
</I>&gt;<i> &gt; incompatible with versions of Trac which were out at the time. It would
</I>&gt;<i> &gt; not have been that hard to maintain compatibility with Trac and still
</I>&gt;<i> get
</I>&gt;<i> &gt; the desired gains they were after. I can see myself therefore doing a
</I>&gt;<i> bit
</I>&gt;<i> &gt; or reorganisation of the code to fix the identified issue, but also 
</I>&gt;<i> &gt; reinstate
</I>&gt;<i> &gt; Trac compatibility.
</I></PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022404.html">[mod_python] util.FieldStorage
</A></li>
	<LI>Next message: <A HREF="022401.html">[SPAM] [Fwd: Re: [mod_python] util.FieldStorage]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22400">[ date ]</a>
              <a href="thread.html#22400">[ thread ]</a>
              <a href="subject.html#22400">[ subject ]</a>
              <a href="author.html#22400">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
