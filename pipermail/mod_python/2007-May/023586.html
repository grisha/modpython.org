<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Multiple loading of same module with winnt MPM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Multiple%20loading%20of%20same%20module%20with%20winnt%20MPM&In-Reply-To=88e286470705091500l43c18808qe095ca20b8f238c3%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023584.html">
   <LINK REL="Next"  HREF="023587.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Multiple loading of same module with winnt MPM</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Michael Sanders</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Multiple%20loading%20of%20same%20module%20with%20winnt%20MPM&In-Reply-To=88e286470705091500l43c18808qe095ca20b8f238c3%40mail.gmail.com"
       TITLE="[mod_python] Multiple loading of same module with winnt MPM">m.r.sanders at gmail.com
       </A><BR>
    <I>Thu May 10 06:26:44 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023584.html">[mod_python] Multiple loading of same module with winnt MPM
</A></li>
        <LI>Next message: <A HREF="023587.html">[mod_python] Multiple loading of same module with winnt MPM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23586">[ date ]</a>
              <a href="thread.html#23586">[ thread ]</a>
              <a href="subject.html#23586">[ subject ]</a>
              <a href="author.html#23586">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Graham,

Here is the test PSP file. In my test, this is loaded twice 
(simultaneously) with a newly re-started Apache by an HTML file 
containing two Javascript 'XMLHttpRequest()' calls. (I can post the HTML 
if required).

Note: replacing the '~' in the path passed to apache.import_module with 
the full path gives no change in behaviour.

---- test.psp -------------------------
&lt;%
#import os
#import sys
#ourpath = os.path.dirname(psp.req.canonical_filename)
#sys.path.append(ourpath)
#import mymod

mymod = apache.import_module(&quot;~/mymod.py&quot;)
mymod.logger.warning('test')

%&gt;
test
---------------------------------------


The imported module. Note: a random number is generated when the module 
is imported and this number is appended to all logged messages, so as to 
identify the logged messages with instance of the imported module (e.g. 
see 'mylog.log' below).

---- mymod.py -------------------------
import sys
import logging
import random
rnd = random.random()
log_file = &quot;c:/temp/mylog.log&quot;
logger = logging.getLogger()

log_handler = logging.FileHandler(log_file,&quot;a&quot;)
log_handler.setFormatter(logging.Formatter(fmt='%(asctime)s %(message)s 
'+str(rnd)))
logger.addHandler(log_handler)
logger.warning(&quot;added a new log handler&quot;)
---------------------------------------


The Apache .htaccess file. The only mod_python related directive in 
httpd.conf is the 'LoadModule' line. There is no PythonPath set in 
httpd.conf and no system PYTHONPATH environment variable set.

---- .htaccess file -------------------
AddHandler mod_python .psp
PythonHandler mod_python.psp
PythonDebug on

&lt;FilesMatch &quot;\.py&quot;&gt;
     Order allow,deny
     Deny from all
&lt;/FilesMatch&gt;
&lt;FilesMatch &quot;$\.ht&quot;&gt;
     Order allow,deny
     Deny from all
&lt;/FilesMatch&gt;
---------------------------------------


The Apache access log:

---- access.log -----------------------
10.5.9.120 - - [10/May/2007:10:43:12 +0100] &quot;GET /webapp/test.html 
HTTP/1.1&quot; 304 -
10.5.9.120 - - [10/May/2007:10:43:12 +0100] &quot;GET 
/webapp/test.psp?sid=0.3172181574260018 HTTP/1.1&quot; 200 8
10.5.9.120 - - [10/May/2007:10:43:12 +0100] &quot;GET 
/webapp/test.psp?sid=0.05203795490300955 HTTP/1.1&quot; 200 8
---------------------------------------


The Apache error log:

---- error.log ------------------------
[Thu May 10 10:43:12 2007] [notice] mod_python (pid=5632, 
interpreter='DELL14.mydomain.local'): Importing module 'C:\\Program 
Files\\Apache Software Foundation\\Apache2.2\\htdocs\\webapp\\mymod.py'
[Thu May 10 10:43:12 2007] [notice] mod_python (pid=5632, 
interpreter='DELL14.mydomain.local'): Reimporting module 'C:\\Program 
Files\\Apache Software Foundation\\Apache2.2\\htdocs\\webapp\\mymod.py'
---------------------------------------


The log created by test.psp. This shows two logging handlers being 
created - one when the module is first imported, and the second when the 
module is re-imported. The 'added a new log handler' and test' messages 
generated by the second call to 'test.psp' are therefore logged twice, 
once by each handler.

---- mylog.log ------------------------
2007-05-10 10:43:12,404 added a new log handler 0.884955893555
2007-05-10 10:43:12,404 test 0.884955893555
2007-05-10 10:43:12,420 added a new log handler 0.884955893555
2007-05-10 10:43:12,420 added a new log handler 0.644262952239
2007-05-10 10:43:12,420 test 0.884955893555
2007-05-10 10:43:12,420 test 0.644262952239
---------------------------------------


Changing 'test.psp' to use the standard Python module importer (by 
uncommenting the appropriate lines and commenting out the line 
containing 'apache.import_module'), the following logs are generated:

---- mylog.log ------------------------
2007-05-10 10:55:10,733 added a new log handler 0.851457438205
2007-05-10 10:55:10,733 test 0.851457438205
2007-05-10 10:55:10,733 test 0.851457438205
---------------------------------------

---- access.log -----------------------
10.5.9.120 - - [10/May/2007:10:55:10 +0100] &quot;GET /webapp/test.html 
HTTP/1.1&quot; 304 -
10.5.9.120 - - [10/May/2007:10:55:10 +0100] &quot;GET 
/webapp/test.psp?sid=0.5035066189141854 HTTP/1.1&quot; 200 8
10.5.9.120 - - [10/May/2007:10:55:10 +0100] &quot;GET 
/webapp/test.psp?sid=0.239310630890464 HTTP/1.1&quot; 200 8
---------------------------------------


I forgot to mention in my first mail, that I'm using Python 2.5.

Thanks again for your help.
Michael

Graham Dumpleton wrote:
&gt;<i> Post the snippet of PSP code you are doing the import from.
</I>&gt;<i> 
</I>&gt;<i> Post the Apache configuration snippet you are using so it can be seen
</I>&gt;<i> whether you are setting PythonPath to include a directory which
</I>&gt;<i> overlaps the document area and whether you are using Apache style
</I>&gt;<i> forward slashes in paths or Windows backwards slashes.
</I>&gt;<i> 
</I>&gt;<i> Post the snippets of the log files which show when the module is being
</I>&gt;<i> loaded so can see the paths it is being loaded under. Especially post
</I>&gt;<i> any warnings output about a path appearing in sys.path as well as
</I>&gt;<i> mod_python module importer path.
</I>&gt;<i> 
</I>&gt;<i> The only issue I know of with PSP and the new module importer is that
</I>&gt;<i> if you use 'import' rather than 'apache.import_module()', the 'import'
</I>&gt;<i> will always use standard Python module importer and not
</I>&gt;<i> 'apache.import_module()'. Thus if you were trying to import a module
</I>&gt;<i> from the same directory it by default will not work. If you fiddled
</I>&gt;<i> PythonPath to include that directory, thus creating an overlap in the
</I>&gt;<i> two systems, it will import but thus may be imported separately by
</I>&gt;<i> both mechanisms.
</I>&gt;<i> 
</I>&gt;<i> To address this latter problem, PSP needs to be changed to fake up
</I>&gt;<i> some information in the page pseudo module so that it thinks it was
</I>&gt;<i> imported used mod_python importer in the first place and will thus map
</I>&gt;<i> 'import' through to 'apache.import_module()' properly.
</I>&gt;<i> 
</I>&gt;<i> Graham
</I>&gt;<i> 
</I>&gt;<i> On 09/05/07, Michael Sanders &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">m.r.sanders at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> Environment:
</I>&gt;&gt;<i> - mod_python 3.3.1
</I>&gt;&gt;<i> - Apache 2.2.3 running on Windows XP
</I>&gt;&gt;<i> - PSP request handler
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [Issue 4] described at the following link still appears to be present in
</I>&gt;&gt;<i> mod_python 3.3.1:
</I>&gt;&gt;<i> <A HREF="http://www.dscpl.com.au/wiki/ModPython/Articles/ModuleImportingIsBroken#line-50">http://www.dscpl.com.au/wiki/ModPython/Articles/ModuleImportingIsBroken#line-50</A> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a PSP file that imports a module using 'apache.import_module'. If
</I>&gt;&gt;<i> I re-start Apache and then fire two simultaneous requests at the PSP
</I>&gt;&gt;<i> file, mod_python loads the module twice. (The module in question when
</I>&gt;&gt;<i> imported  sets up a logging handler. The initial entry written by this
</I>&gt;&gt;<i> module to the log file is duplicated and subsequent calls to this
</I>&gt;&gt;<i> handler also give duplicate entries in the log file).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I import the module using the standard Python 'import', this problem
</I>&gt;&gt;<i> does not occur. Likewise, if I use the 'vampire.importModule' method,
</I>&gt;&gt;<i> the problem does not occur. The issue only happens when using
</I>&gt;&gt;<i> 'apache.import_module'.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Has anyone else experienced this? Is there a fix?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Many thanks,
</I>&gt;&gt;<i> Michael Sanders
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023584.html">[mod_python] Multiple loading of same module with winnt MPM
</A></li>
	<LI>Next message: <A HREF="023587.html">[mod_python] Multiple loading of same module with winnt MPM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23586">[ date ]</a>
              <a href="thread.html#23586">[ thread ]</a>
              <a href="subject.html#23586">[ subject ]</a>
              <a href="author.html#23586">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
