<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Multiple loading of same module with winnt MPM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Multiple%20loading%20of%20same%20module%20with%20winnt%20MPM&In-Reply-To=4642F364.6030208%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023586.html">
   <LINK REL="Next"  HREF="023588.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Multiple loading of same module with winnt MPM</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Multiple%20loading%20of%20same%20module%20with%20winnt%20MPM&In-Reply-To=4642F364.6030208%40gmail.com"
       TITLE="[mod_python] Multiple loading of same module with winnt MPM">graham.dumpleton at gmail.com
       </A><BR>
    <I>Thu May 10 07:01:25 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023586.html">[mod_python] Multiple loading of same module with winnt MPM
</A></li>
        <LI>Next message: <A HREF="023588.html">[mod_python] Multiple loading of same module with winnt MPM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23587">[ date ]</a>
              <a href="thread.html#23587">[ thread ]</a>
              <a href="subject.html#23587">[ subject ]</a>
              <a href="author.html#23587">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I can't explain why a 'reimport' is occurring almost immediately off
the top of my head, but you should be aware that the sort of code you
are putting in the module shouldn't be put in a module which is a
candidate for reloading.

In short, you shouldn't put code into a module which is a candidate
for reloading which is additive to global data. The easiest example of
this is:

  sys.path.append(&quot;/some/directory&quot;)

Every time the module containing this is touched and therefore
reloaded, that path would be added to sys.path again. If that module
were changed 10 times you would have that path appearing in sys.path
that many times as well.

Thus, you should put such code in normal Python modules which can't be
reloaded and which are preferably outside of your document tree,
unless your code specifically checks that it shouldn't do something
because it has already been done. For example:

  if not &quot;/some/directory&quot; in sys.path:
    sys.path.append(&quot;/some/directory&quot;)

This is why you get multiple logger instances being created.

As to why the reimport happens I am not sure. Might be something
strange to do with granularity of  system time and modification times
of files on Windows.

I'll have a think about it.

Graham

On 10/05/07, Michael Sanders &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">m.r.sanders at gmail.com</A>&gt; wrote:
&gt;<i> Graham,
</I>&gt;<i>
</I>&gt;<i> Here is the test PSP file. In my test, this is loaded twice
</I>&gt;<i> (simultaneously) with a newly re-started Apache by an HTML file
</I>&gt;<i> containing two Javascript 'XMLHttpRequest()' calls. (I can post the HTML
</I>&gt;<i> if required).
</I>&gt;<i>
</I>&gt;<i> Note: replacing the '~' in the path passed to apache.import_module with
</I>&gt;<i> the full path gives no change in behaviour.
</I>&gt;<i>
</I>&gt;<i> ---- test.psp -------------------------
</I>&gt;<i> &lt;%
</I>&gt;<i> #import os
</I>&gt;<i> #import sys
</I>&gt;<i> #ourpath = os.path.dirname(psp.req.canonical_filename)
</I>&gt;<i> #sys.path.append(ourpath)
</I>&gt;<i> #import mymod
</I>&gt;<i>
</I>&gt;<i> mymod = apache.import_module(&quot;~/mymod.py&quot;)
</I>&gt;<i> mymod.logger.warning('test')
</I>&gt;<i>
</I>&gt;<i> %&gt;
</I>&gt;<i> test
</I>&gt;<i> ---------------------------------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The imported module. Note: a random number is generated when the module
</I>&gt;<i> is imported and this number is appended to all logged messages, so as to
</I>&gt;<i> identify the logged messages with instance of the imported module (e.g.
</I>&gt;<i> see 'mylog.log' below).
</I>&gt;<i>
</I>&gt;<i> ---- mymod.py -------------------------
</I>&gt;<i> import sys
</I>&gt;<i> import logging
</I>&gt;<i> import random
</I>&gt;<i> rnd = random.random()
</I>&gt;<i> log_file = &quot;c:/temp/mylog.log&quot;
</I>&gt;<i> logger = logging.getLogger()
</I>&gt;<i>
</I>&gt;<i> log_handler = logging.FileHandler(log_file,&quot;a&quot;)
</I>&gt;<i> log_handler.setFormatter(logging.Formatter(fmt='%(asctime)s %(message)s
</I>&gt;<i> '+str(rnd)))
</I>&gt;<i> logger.addHandler(log_handler)
</I>&gt;<i> logger.warning(&quot;added a new log handler&quot;)
</I>&gt;<i> ---------------------------------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The Apache .htaccess file. The only mod_python related directive in
</I>&gt;<i> httpd.conf is the 'LoadModule' line. There is no PythonPath set in
</I>&gt;<i> httpd.conf and no system PYTHONPATH environment variable set.
</I>&gt;<i>
</I>&gt;<i> ---- .htaccess file -------------------
</I>&gt;<i> AddHandler mod_python .psp
</I>&gt;<i> PythonHandler mod_python.psp
</I>&gt;<i> PythonDebug on
</I>&gt;<i>
</I>&gt;<i> &lt;FilesMatch &quot;\.py&quot;&gt;
</I>&gt;<i>      Order allow,deny
</I>&gt;<i>      Deny from all
</I>&gt;<i> &lt;/FilesMatch&gt;
</I>&gt;<i> &lt;FilesMatch &quot;$\.ht&quot;&gt;
</I>&gt;<i>      Order allow,deny
</I>&gt;<i>      Deny from all
</I>&gt;<i> &lt;/FilesMatch&gt;
</I>&gt;<i> ---------------------------------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The Apache access log:
</I>&gt;<i>
</I>&gt;<i> ---- access.log -----------------------
</I>&gt;<i> 10.5.9.120 - - [10/May/2007:10:43:12 +0100] &quot;GET /webapp/test.html
</I>&gt;<i> HTTP/1.1&quot; 304 -
</I>&gt;<i> 10.5.9.120 - - [10/May/2007:10:43:12 +0100] &quot;GET
</I>&gt;<i> /webapp/test.psp?sid=0.3172181574260018 HTTP/1.1&quot; 200 8
</I>&gt;<i> 10.5.9.120 - - [10/May/2007:10:43:12 +0100] &quot;GET
</I>&gt;<i> /webapp/test.psp?sid=0.05203795490300955 HTTP/1.1&quot; 200 8
</I>&gt;<i> ---------------------------------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The Apache error log:
</I>&gt;<i>
</I>&gt;<i> ---- error.log ------------------------
</I>&gt;<i> [Thu May 10 10:43:12 2007] [notice] mod_python (pid=5632,
</I>&gt;<i> interpreter='DELL14.mydomain.local'): Importing module 'C:\\Program
</I>&gt;<i> Files\\Apache Software Foundation\\Apache2.2\\htdocs\\webapp\\mymod.py'
</I>&gt;<i> [Thu May 10 10:43:12 2007] [notice] mod_python (pid=5632,
</I>&gt;<i> interpreter='DELL14.mydomain.local'): Reimporting module 'C:\\Program
</I>&gt;<i> Files\\Apache Software Foundation\\Apache2.2\\htdocs\\webapp\\mymod.py'
</I>&gt;<i> ---------------------------------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The log created by test.psp. This shows two logging handlers being
</I>&gt;<i> created - one when the module is first imported, and the second when the
</I>&gt;<i> module is re-imported. The 'added a new log handler' and test' messages
</I>&gt;<i> generated by the second call to 'test.psp' are therefore logged twice,
</I>&gt;<i> once by each handler.
</I>&gt;<i>
</I>&gt;<i> ---- mylog.log ------------------------
</I>&gt;<i> 2007-05-10 10:43:12,404 added a new log handler 0.884955893555
</I>&gt;<i> 2007-05-10 10:43:12,404 test 0.884955893555
</I>&gt;<i> 2007-05-10 10:43:12,420 added a new log handler 0.884955893555
</I>&gt;<i> 2007-05-10 10:43:12,420 added a new log handler 0.644262952239
</I>&gt;<i> 2007-05-10 10:43:12,420 test 0.884955893555
</I>&gt;<i> 2007-05-10 10:43:12,420 test 0.644262952239
</I>&gt;<i> ---------------------------------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Changing 'test.psp' to use the standard Python module importer (by
</I>&gt;<i> uncommenting the appropriate lines and commenting out the line
</I>&gt;<i> containing 'apache.import_module'), the following logs are generated:
</I>&gt;<i>
</I>&gt;<i> ---- mylog.log ------------------------
</I>&gt;<i> 2007-05-10 10:55:10,733 added a new log handler 0.851457438205
</I>&gt;<i> 2007-05-10 10:55:10,733 test 0.851457438205
</I>&gt;<i> 2007-05-10 10:55:10,733 test 0.851457438205
</I>&gt;<i> ---------------------------------------
</I>&gt;<i>
</I>&gt;<i> ---- access.log -----------------------
</I>&gt;<i> 10.5.9.120 - - [10/May/2007:10:55:10 +0100] &quot;GET /webapp/test.html
</I>&gt;<i> HTTP/1.1&quot; 304 -
</I>&gt;<i> 10.5.9.120 - - [10/May/2007:10:55:10 +0100] &quot;GET
</I>&gt;<i> /webapp/test.psp?sid=0.5035066189141854 HTTP/1.1&quot; 200 8
</I>&gt;<i> 10.5.9.120 - - [10/May/2007:10:55:10 +0100] &quot;GET
</I>&gt;<i> /webapp/test.psp?sid=0.239310630890464 HTTP/1.1&quot; 200 8
</I>&gt;<i> ---------------------------------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I forgot to mention in my first mail, that I'm using Python 2.5.
</I>&gt;<i>
</I>&gt;<i> Thanks again for your help.
</I>&gt;<i> Michael
</I>&gt;<i>
</I>&gt;<i> Graham Dumpleton wrote:
</I>&gt;<i> &gt; Post the snippet of PSP code you are doing the import from.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Post the Apache configuration snippet you are using so it can be seen
</I>&gt;<i> &gt; whether you are setting PythonPath to include a directory which
</I>&gt;<i> &gt; overlaps the document area and whether you are using Apache style
</I>&gt;<i> &gt; forward slashes in paths or Windows backwards slashes.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Post the snippets of the log files which show when the module is being
</I>&gt;<i> &gt; loaded so can see the paths it is being loaded under. Especially post
</I>&gt;<i> &gt; any warnings output about a path appearing in sys.path as well as
</I>&gt;<i> &gt; mod_python module importer path.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The only issue I know of with PSP and the new module importer is that
</I>&gt;<i> &gt; if you use 'import' rather than 'apache.import_module()', the 'import'
</I>&gt;<i> &gt; will always use standard Python module importer and not
</I>&gt;<i> &gt; 'apache.import_module()'. Thus if you were trying to import a module
</I>&gt;<i> &gt; from the same directory it by default will not work. If you fiddled
</I>&gt;<i> &gt; PythonPath to include that directory, thus creating an overlap in the
</I>&gt;<i> &gt; two systems, it will import but thus may be imported separately by
</I>&gt;<i> &gt; both mechanisms.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; To address this latter problem, PSP needs to be changed to fake up
</I>&gt;<i> &gt; some information in the page pseudo module so that it thinks it was
</I>&gt;<i> &gt; imported used mod_python importer in the first place and will thus map
</I>&gt;<i> &gt; 'import' through to 'apache.import_module()' properly.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Graham
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 09/05/07, Michael Sanders &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">m.r.sanders at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; Environment:
</I>&gt;<i> &gt;&gt; - mod_python 3.3.1
</I>&gt;<i> &gt;&gt; - Apache 2.2.3 running on Windows XP
</I>&gt;<i> &gt;&gt; - PSP request handler
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; [Issue 4] described at the following link still appears to be present in
</I>&gt;<i> &gt;&gt; mod_python 3.3.1:
</I>&gt;<i> &gt;&gt; <A HREF="http://www.dscpl.com.au/wiki/ModPython/Articles/ModuleImportingIsBroken#line-50">http://www.dscpl.com.au/wiki/ModPython/Articles/ModuleImportingIsBroken#line-50</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I have a PSP file that imports a module using 'apache.import_module'. If
</I>&gt;<i> &gt;&gt; I re-start Apache and then fire two simultaneous requests at the PSP
</I>&gt;<i> &gt;&gt; file, mod_python loads the module twice. (The module in question when
</I>&gt;<i> &gt;&gt; imported  sets up a logging handler. The initial entry written by this
</I>&gt;<i> &gt;&gt; module to the log file is duplicated and subsequent calls to this
</I>&gt;<i> &gt;&gt; handler also give duplicate entries in the log file).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; If I import the module using the standard Python 'import', this problem
</I>&gt;<i> &gt;&gt; does not occur. Likewise, if I use the 'vampire.importModule' method,
</I>&gt;<i> &gt;&gt; the problem does not occur. The issue only happens when using
</I>&gt;<i> &gt;&gt; 'apache.import_module'.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Has anyone else experienced this? Is there a fix?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Many thanks,
</I>&gt;<i> &gt;&gt; Michael Sanders
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Mod_python mailing list
</I>&gt;<i> &gt;&gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023586.html">[mod_python] Multiple loading of same module with winnt MPM
</A></li>
	<LI>Next message: <A HREF="023588.html">[mod_python] Multiple loading of same module with winnt MPM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23587">[ date ]</a>
              <a href="thread.html#23587">[ thread ]</a>
              <a href="subject.html#23587">[ subject ]</a>
              <a href="author.html#23587">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
