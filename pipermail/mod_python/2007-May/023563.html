<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Help with session.save and register_cleanup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Help%20with%20session.save%20and%20register_cleanup&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023562.html">
   <LINK REL="Next"  HREF="023564.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Help with session.save and register_cleanup</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jeff Hinrichs - DM&amp;T</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Help%20with%20session.save%20and%20register_cleanup&In-Reply-To="
       TITLE="[mod_python] Help with session.save and register_cleanup">jeffh at dundeemt.com
       </A><BR>
    <I>Sat May  5 22:43:43 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023562.html">[mod_python] implications of multiple interpreters
</A></li>
        <LI>Next message: <A HREF="023564.html">[mod_python] Help with session.save and register_cleanup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23563">[ date ]</a>
              <a href="thread.html#23563">[ thread ]</a>
              <a href="subject.html#23563">[ subject ]</a>
              <a href="author.html#23563">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I know that I am missing something here but googling and banging my
head aren't working so I'll ask.

I'm trying to register the session.save method from the Session I've
attached to the req object in the req.register_cleanup()  like this:

# housekeeping setup for a request

def housekeeping(fn):

    def _setup(req, *args, **kwargs):

        #if session isn't part of the req object, add it

        if not hasattr(req,&quot;session&quot;):

            req.session = Session.Session(req)

            req.session['housekeeped']=1

        #register session.save as a cleanup

        req.register_cleanup(req.session.save)

        #now call the original

        return fn(req,*args,**kwargs)

    return _setup


@housekeeping
def login(req):

    req.session['foo']='bar'

    return &quot;We are in login() %s&quot; % req.session.keys()

Everything seems peachy, the results returned are:

  We are in login() ['foo', 'housekeeped']

However, the register_cleanup fails to save the session, and is
returning the following err:

[notice] vampire: Reimporting module
'/usr/home/apache22/lakota.dundeemt.pri/dora/index.py'
[error] [client 192.168.2.52] python_cleanup: Error calling cleanup
object &lt;bound method DbmSession.save of {'housekeeped': 1}&gt;
[error] [client 192.168.2.52]     exceptions.TypeError: save() takes
exactly 1 argument (2 given)

I've tried changing the register_cleanup to call req.session.save()
(as opposed to .save) but that complains, correctly, that save() is
not callable.

First question, can I register multiple items with multiple calls to
req.register_cleanup? i.e.
req.register_cleanup(_closedb, req)
req.register_cleanup(req.session.save)

or is that my problem?  Or have I just been at the keyboard too long
to see the error that probably is staring me in the face?  The db
cleanup appears to be working without error nor phantom connections.

Thanks,

Jeff Hinrichs
<A HREF="http://www.OmahaPython.org/">http://www.OmahaPython.org/</A>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023562.html">[mod_python] implications of multiple interpreters
</A></li>
	<LI>Next message: <A HREF="023564.html">[mod_python] Help with session.save and register_cleanup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23563">[ date ]</a>
              <a href="thread.html#23563">[ thread ]</a>
              <a href="subject.html#23563">[ subject ]</a>
              <a href="author.html#23563">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
