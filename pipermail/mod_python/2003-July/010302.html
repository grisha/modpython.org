<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] A few questions about requestobject.c
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20A%20few%20questions%20about%20requestobject.c&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010301.html">
   <LINK REL="Next"  HREF="010303.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
<table border=0 width="100%"><tr><td valign="top">
   <H1>[mod_python] A few questions about requestobject.c</H1>
    <B>IndrekJ&#228;rve</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20A%20few%20questions%20about%20requestobject.c&In-Reply-To="
       TITLE="[mod_python] A few questions about requestobject.c">indrek at inversion.ee
       </A><BR>
    <I>Wed Jul 30 11:33:51 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="010301.html">[mod_python] qdemo/publish_error not working for IE with mod_python
</A></li>
        <LI>Next message: <A HREF="010303.html">[mod_python] A few questions about requestobject.c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10302">[ date ]</a>
              <a href="thread.html#10302">[ thread ]</a>
              <a href="subject.html#10302">[ subject ]</a>
              <a href="author.html#10302">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I've been messing around in requestobject.c for a few hours and started
wondering about the way a few things work. Since I'm not sure whether
they are design decisions, apache related stuff or just weird things, I
thought I'd ask the list :)

1. The use of apr_palloc

Multipart POST forms are parsed in util.py/FieldStorage using req's
req_readline function, which happily apr_palloc'ates enough memory to
read the remaining request data into memory, but never seems to free it
(nasty if the users have a habit of uploading 100+MB files, especially
once multiplied with the number of apache processes). Since the pool
used is attached to the apache request, I'm not sure I should freely
apr_pool_clear() or apr_pool_destroy() it either.

I managed to release memory by replacing apr_palloc with malloc and
adding a few free()s where required, but is this the right approach?

2. The use of PyString_FromStringAndSize()

Again in the req_readline() function, the result variable is initialized
at the size of the full remaining request data. Could the result
variable initialization perhaps be moved a bit further down to

a) when checking if rbuff from previous reads has a '\n' in it (perhaps
check with strchr and then initialize if needed) and 
b) after reading data from request and before copying it to the result.

At both these places it should be more obvious how much memory needs to
be allocated.


If I managed to make no sense at all and got something mixed up, please
let me know. However, I feel that at least the first point could use
some attention, as it creates a problem when uploading big files through
mod_python enabled scripts.

Regards,
Indrek

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010301.html">[mod_python] qdemo/publish_error not working for IE with mod_python
</A></li>
	<LI>Next message: <A HREF="010303.html">[mod_python] A few questions about requestobject.c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10302">[ date ]</a>
              <a href="thread.html#10302">[ thread ]</a>
              <a href="subject.html#10302">[ subject ]</a>
              <a href="author.html#10302">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
