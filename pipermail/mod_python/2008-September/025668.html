<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20Mod_Python%2C%20Mod_Proxy%2C%20and%20Set-Cookie&In-Reply-To=ed756d900809291759g2517afcej76439686876df841%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025667.html">
   <LINK REL="Next"  HREF="025669.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Re%3A%20Mod_Python%2C%20Mod_Proxy%2C%20and%20Set-Cookie&In-Reply-To=ed756d900809291759g2517afcej76439686876df841%40mail.gmail.com"
       TITLE="[mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie">graham.dumpleton at gmail.com
       </A><BR>
    <I>Mon Sep 29 21:21:58 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025667.html">[mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie
</A></li>
        <LI>Next message: <A HREF="025669.html">[mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25668">[ date ]</a>
              <a href="thread.html#25668">[ thread ]</a>
              <a href="subject.html#25668">[ subject ]</a>
              <a href="author.html#25668">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>It may be that your assumption that setting headers_out in a authnz
handler will always ensure that it appears in response, where authnz
handler is not providing the final response, is just wrong. The
correct way of ensuring this is possibly to use an output filter. That
way the setting of additional headers is from after true handler had
started returning response and so after when it has set headers
itself. That way no chance that content handler will ignore what you
may have already set in headers_out as you are overriding what it has
set. So, have a look at req.add_output_filter(). Only thing I don't
remember is whether mod_python output filters are registered at
correct level to allow modifications to response headers.

Graham

2008/9/30 Tom Wells &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">drshade at gmail.com</A>&gt;:
&gt;<i> Hi Mod_Pythonians,
</I>&gt;<i>
</I>&gt;<i> So I managed to solve it - and it's clearly a bug in Apache 2.2.9 mod_proxy
</I>&gt;<i> as far as I can tell. I will be posting the bug to the Apache bug list, but
</I>&gt;<i> thought I would give you a quick explanation as I've found many a golden
</I>&gt;<i> nugget during my travels on this mailing list.
</I>&gt;<i>
</I>&gt;<i> Basically if you're trying to set a cookie within a handler (mod_python or
</I>&gt;<i> otherwise I assume) and the response from the proxied resource starts with
</I>&gt;<i> the &quot;HTTP/1.1 100 Continue&quot; status line (because the request was a POST and
</I>&gt;<i> had an &quot;Expect: 100-Continue&quot;) then you can forget about mod_proxy merging
</I>&gt;<i> the Set-Cookie in your out_headers from your handler with the response from
</I>&gt;<i> the proxied resource. I've been through most of the mod_proxy code this
</I>&gt;<i> evening and I can understand why, there are some hairy things in there
</I>&gt;<i> (around backwards compatibility and the ever changing HTTP goal posts of
</I>&gt;<i> long ago I suppose). Regular POSTs work great, which explains the mixed
</I>&gt;<i> results we were seeing between our various back-end web servers.
</I>&gt;<i>
</I>&gt;<i> Of course everything works just perfectly in Apache 2.2.4 which happened to
</I>&gt;<i> be our development Apache version, and so we didn't stumble upon the issue
</I>&gt;<i> until during deployment on the production machines (which the ops team keep
</I>&gt;<i> patched to the latest Apache version).
</I>&gt;<i>
</I>&gt;<i> Best Regards,
</I>&gt;<i> Tom
</I>&gt;<i>
</I>&gt;<i> On Mon, Sep 29, 2008 at 10:05 AM, Tom Wells &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">drshade at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi Group
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm facing an interesting problem at the moment and wondered if anyone
</I>&gt;&gt;<i> could give me a pointer. Our setup is the following:
</I>&gt;&gt;<i> Apache running mod_python and mod_proxy, with python handlers for Authen
</I>&gt;&gt;<i> and Authz, we have an Oracle Application Server and a JRUN Application
</I>&gt;&gt;<i> Server in the back, which are where mod_proxy is configured to forward to.
</I>&gt;&gt;<i> Our python Authen and Authz handlers are responsible for getting and setting
</I>&gt;&gt;<i> session related cookies before proxying, or to redirect the user if the
</I>&gt;&gt;<i> session cookie is bad or he is not logged in (no cookie). Even if the user
</I>&gt;&gt;<i> has a valid cookie we refresh it every 2 minutes, i.e. generate a new
</I>&gt;&gt;<i> cookie, add the Set-Cookie header, then allow the request to continue (i.e.
</I>&gt;&gt;<i> mod_proxy kicks in and forwards the request to oracle or jrun). This is nice
</I>&gt;&gt;<i> because we have a single authentication model up front for multiple
</I>&gt;&gt;<i> disparate web applications in the back.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now the good news is that this works really well, mostly. Browser requests
</I>&gt;&gt;<i> to and from the webserver correctly get and update cookies and
</I>&gt;&gt;<i> allow/disallow requests to be proxied. More specifically the &quot;Set-Cookie&quot;
</I>&gt;&gt;<i> header is present in responses where the cookie has been updated. This is
</I>&gt;&gt;<i> true for both the oracle and jrun application servers being proxied to.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HOWEVER - we have a rich client (desktop) app written in C# which has been
</I>&gt;&gt;<i> designed to POST to some of the oracle url's in order to fetch data, after
</I>&gt;&gt;<i> it performs a login. So it logs in, gets a fresh new cookie and regularly
</I>&gt;&gt;<i> hits the backend for data. For each request our Authen and Authz handlers
</I>&gt;&gt;<i> process the cookie and ensure the session is valid etc, and allow or
</I>&gt;&gt;<i> disallow the request (i.e. return apache.OK or do a
</I>&gt;&gt;<i> mod_python_util.redirect() to get rid of him). The problem is that requests
</I>&gt;&gt;<i> from this app don't ever get back a refreshed cookie (after 2 minutes) -
</I>&gt;&gt;<i> there is every indication according to my apache logs that my Authz handler
</I>&gt;&gt;<i> is calling the mod_python.Cookie.add_cookie(req, newCookie) function to set
</I>&gt;&gt;<i> the new cookie, and even printing out the list of headers_in and headers_out
</I>&gt;&gt;<i> in a fixuphandler shows the Set-Cookie header is present. BUT the Set-Cookie
</I>&gt;&gt;<i> never makes it back to the app as we have used fiddler2 and httpdebugger to
</I>&gt;&gt;<i> monitor the traffic.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So I blame the Oracle Application Server for eating the cookie somehow,
</I>&gt;&gt;<i> but surely as the cookie is added to the headers_out of the request it MUST
</I>&gt;&gt;<i> go back to the browser regardless of how it was proxied or whatever the
</I>&gt;&gt;<i> proxied application responds with?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please help - getting desperate for a solution - any pointers as to track
</I>&gt;&gt;<i> down the issue would be greatly appreciated!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Tom
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> <A HREF="http://www.tomwells.org">http://www.tomwells.org</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> <A HREF="http://www.tomwells.org">http://www.tomwells.org</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025667.html">[mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie
</A></li>
	<LI>Next message: <A HREF="025669.html">[mod_python] Re: Mod_Python, Mod_Proxy, and Set-Cookie
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25668">[ date ]</a>
              <a href="thread.html#25668">[ thread ]</a>
              <a href="subject.html#25668">[ subject ]</a>
              <a href="author.html#25668">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
