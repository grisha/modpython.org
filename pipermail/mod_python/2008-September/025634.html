<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] requests are blocking when using req.sendfile
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025633.html">
   <LINK REL="Next"  HREF="025635.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] requests are blocking when using req.sendfile</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Matt Barnicle</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To="
       TITLE="[mod_python] requests are blocking when using req.sendfile">mattb at wageslavery.org
       </A><BR>
    <I>Tue Sep 23 03:55:29 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025633.html">[mod_python] My web application is now up and running
</A></li>
        <LI>Next message: <A HREF="025635.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25634">[ date ]</a>
              <a href="thread.html#25634">[ thread ]</a>
              <a href="subject.html#25634">[ subject ]</a>
              <a href="author.html#25634">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>i'm having an issue with our site, which seems to be directly
related to using req.sendfile.  on our site, we have secure music
downloads.  the user has to go through a series of steps in order to
gain access to the music (fyi, we run a legitimate service, not a
pirate or warez site).  just some background info..  basically we
can't offer a direct download link or the security can be bypassed. 
so downloading is done through the handler, which runs the checks,
and if everything looks good, the file is sent to the browser using
req.sendfile with the local path to the file on disk.

it works..  but the problem is, requests start backing up whenever a
download is being sent.  it looks like new requests are being sent
to the apache process that is tied up sending the download file.  i
don't understand why this is happening though.  i would think that
while it's sending the file, no new requests would be queued in that
process.  i can verify this easily by downloading a file, and while
it's downloading, clicking on a link on the site from the same
window in which i downloaded in.  the request will stay in the WAIT
state (according to mod_status) until the download is finished, then
the page will load and the queue will clear up.  now if i change the
download link to a static file, served directly by apache, this
problem disappears.

what can i do to fix this?  it's a major issue right now.  many
times a day you can go to the site and it will hang for perhaps 1 to
3 minutes, then it will load, due to the above described situation.

version notes:

CentOS release 5 (Final)
apache 2.2.3
mod_python 3.2

using prefork compiled into apache.  misc apache configuration:

KeepAlive Off

&lt;IfModule prefork.c&gt;
 StartServers       8
 MinSpareServers    5
 MaxSpareServers   20
 ServerLimit      256
 MaxClients       256
 MaxRequestsPerChild  4000
&lt;/IfModule&gt;

thank you for your time and consideration..

- m@

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025633.html">[mod_python] My web application is now up and running
</A></li>
	<LI>Next message: <A HREF="025635.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25634">[ date ]</a>
              <a href="thread.html#25634">[ thread ]</a>
              <a href="subject.html#25634">[ subject ]</a>
              <a href="author.html#25634">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
