<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] requests are blocking when using req.sendfile
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To=52303.75.62.111.62.1222222024.squirrel%40webmail.wageslavery.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025646.html">
   <LINK REL="Next"  HREF="025648.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] requests are blocking when using req.sendfile</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To=52303.75.62.111.62.1222222024.squirrel%40webmail.wageslavery.org"
       TITLE="[mod_python] requests are blocking when using req.sendfile">graham.dumpleton at gmail.com
       </A><BR>
    <I>Tue Sep 23 21:55:58 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025646.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
        <LI>Next message: <A HREF="025648.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25647">[ date ]</a>
              <a href="thread.html#25647">[ thread ]</a>
              <a href="subject.html#25647">[ subject ]</a>
              <a href="author.html#25647">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>2008/9/24 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
&gt;&gt;<i> Are you setting a content length on the response before calling
</I>&gt;&gt;<i> req.sendfile()?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How many concurrent requests for these files are you receiving and
</I>&gt;&gt;<i> how
</I>&gt;&gt;<i> long does it take to download a file?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> yes, i believe so..  now that you mention it, i haven't verified the
</I>&gt;<i> file size from the code below, i will do that to be sure.  here is
</I>&gt;<i> the code:
</I>&gt;<i>
</I>&gt;<i> file_path = self.conf.run.app_folder + 'public' + download.path
</I>&gt;<i> file_stat = os.stat(file_path)
</I>&gt;<i> file_size = str(file_stat.st_size)
</I>&gt;<i>
</I>&gt;<i> self.req.headers_out['Content-Length'] = file_size
</I>&gt;<i> self.req.headers_out['Content-Disposition'] = 'attachment;
</I>&gt;<i> filename=%s' % os.path.basename(file_path)
</I>&gt;<i>
</I>&gt;<i> bytes_sent = self.req.sendfile(file_path)
</I>
BTW, now that you are using mod_python 3.3.1, instead of using
req.sendfile(), you could possibly delegate serving of the static file
back to Apache. From memory this can be done using:

  req.filename = self.conf.run.app_folder + 'public' + download.path
  req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
  return apache.DECLINED

By returning apache.DECLINED you say mod_python handler will not
actually handle it, and by having updated req.filename and
req.fileinfo updated to new file, when it falls through to
default-handler it should serve it as static file.

Doing it this way should bypass prior Apache access control checks.
Thus file doesn't need to be in Apache document tree or anywhere else
that is accessible.

I believe doing it this way also has benefit that Apache will
automatically set various headers that you probably wouldn't be.

Please let us know if this alternate method works.

Graham
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025646.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
	<LI>Next message: <A HREF="025648.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25647">[ date ]</a>
              <a href="thread.html#25647">[ thread ]</a>
              <a href="subject.html#25647">[ subject ]</a>
              <a href="author.html#25647">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
