<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] requests are blocking when using req.sendfile
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To=50221.76.201.171.202.1222554099.squirrel%40webmail.wageslavery.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025659.html">
   <LINK REL="Next"  HREF="025663.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] requests are blocking when using req.sendfile</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To=50221.76.201.171.202.1222554099.squirrel%40webmail.wageslavery.org"
       TITLE="[mod_python] requests are blocking when using req.sendfile">graham.dumpleton at gmail.com
       </A><BR>
    <I>Sat Sep 27 19:34:35 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025659.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
        <LI>Next message: <A HREF="025663.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25662">[ date ]</a>
              <a href="thread.html#25662">[ thread ]</a>
              <a href="subject.html#25662">[ subject ]</a>
              <a href="author.html#25662">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I haven't read this latest response, but have one guess al the same. I
will say first that working out what the problem has been has been
made more difficult by you not offering up any source code for your
handler to show exactly what you are doing.

Anyway, one viable explanation for the problem is that you are using
mod_python session objects. Session objects are not normally unlocked
until cleanup handler, which is after all response content has been
returned. Thus if sending a lot of data back, requests from the same
user will be locked out, as well as other users who are unfortunate
enough to have the session keys fall into the same session mutex lock
bucket.

If you are using sessions, just before you return from handler, do
something like:

  req.session.save() # if necessary
  req.session.unlock()

I only say 'req.session' here as that is recommended convention for
where you store it, you may well have it stored elsewhere.

Graham

2008/9/28 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
&gt;&gt;<i> I ask again what I asked before and which you didn't answer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How many concurrent requests for these files are you receiving and
</I>&gt;<i> how
</I>&gt;&gt;<i> long does it take to download a file?
</I>&gt;<i>
</I>&gt;<i> sorry for not answering that earlier.  there aren't all that many.
</I>&gt;<i> we get one or two requests for various pages about every 30 seconds
</I>&gt;<i> during normal traffic, sometimes that number goes up.  we only get
</I>&gt;<i> requests for downloads occassionally.  a much smaller percentage of
</I>&gt;<i> the requests are for the downloads.  they are various sizes.  the
</I>&gt;<i> one that is getting the most requests right now is an 18 MB zip
</I>&gt;<i> file.  it takes around 30 seconds to 2 minutes on a DSL connection
</I>&gt;<i> to complete the download.  you can see for yourself here:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://giveback.net/download/music/3">http://giveback.net/download/music/3</A>
</I>&gt;<i>
</I>&gt;<i> i kept the site hidden earlier, because i've posted some code from
</I>&gt;<i> of our infrastructure and thought i should keep who i'm working for
</I>&gt;<i> hidden for that reason, but i think it may help toward getting the
</I>&gt;<i> problem solved and i'm not so concerned anymore..  apologies if that
</I>&gt;<i> has hindered the process in any way.
</I>&gt;<i>
</I>&gt;&gt;<i> In respect of your original comment
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> it works..  but the problem is, requests start backing up whenever a
</I>&gt;&gt;&gt;<i> download is being sent.  it looks like new requests are being sent
</I>&gt;&gt;&gt;<i> to the apache process that is tied up sending the download file.  i
</I>&gt;&gt;&gt;<i> don't understand why this is happening though.  i would think that
</I>&gt;&gt;&gt;<i> while it's sending the file, no new requests would be queued in that
</I>&gt;&gt;&gt;<i> process.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you are truly using prefork MPM, then new requests cant be sent to
</I>&gt;&gt;<i> the busy process as requests are effectively accepted by a process
</I>&gt;&gt;<i> only when it is ready to handle a request.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please verify which MPM is being used by running:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   httpd -V
</I>&gt;<i>
</I>&gt;<i> # httpd -V
</I>&gt;<i> Server version: Apache/2.2.3
</I>&gt;<i> Server built:   Jan 15 2008 20:33:41
</I>&gt;<i> Server's Module Magic Number: 20051115:3
</I>&gt;<i> Server loaded:  APR 1.2.7, APR-Util 1.2.7
</I>&gt;<i> Compiled using: APR 1.2.7, APR-Util 1.2.7
</I>&gt;<i> Architecture:   64-bit
</I>&gt;<i> Server MPM:     Prefork
</I>&gt;<i>  threaded:     no
</I>&gt;<i>  forked:     yes (variable process count)
</I>&gt;<i> Server compiled with....
</I>&gt;<i>  -D APACHE_MPM_DIR=&quot;server/mpm/prefork&quot;
</I>&gt;<i>  -D APR_HAS_SENDFILE
</I>&gt;<i>  -D APR_HAS_MMAP
</I>&gt;<i>  -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)
</I>&gt;<i>  -D APR_USE_SYSVSEM_SERIALIZE
</I>&gt;<i>  -D APR_USE_PTHREAD_SERIALIZE
</I>&gt;<i>  -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT
</I>&gt;<i>  -D APR_HAS_OTHER_CHILD
</I>&gt;<i>  -D AP_HAVE_RELIABLE_PIPED_LOGS
</I>&gt;<i>  -D DYNAMIC_MODULE_LIMIT=128
</I>&gt;<i>
</I>&gt;&gt;<i> How many httpd processes are running at the time you are making
</I>&gt;&gt;<i> requests that appear to be blocked?
</I>&gt;<i>
</I>&gt;<i> it varies.  could be less than 10, could be between 10 and 40.  i've
</I>&gt;<i> seen it happening with any number of processes, it doesn't seem to
</I>&gt;<i> affect things.
</I>&gt;<i>
</I>&gt;&gt;<i> What happens if you make requests at same time from a different web
</I>&gt;&gt;<i> browser or from another box, are they also stalled?
</I>&gt;<i>
</I>&gt;<i> it depends.  if i download in one browser, then surf around in
</I>&gt;<i> another one, i may very well be able to click around in the other
</I>&gt;<i> the entire time without any problems.  but i may also get the
</I>&gt;<i> blocking issue.  and sometimes i will load the site fresh for the
</I>&gt;<i> first time on some days, and it won't load at all for a few minutes,
</I>&gt;<i> then it will.  and in these times, i will check /server-status and
</I>&gt;<i> see a lot of requests in the WAIT state, and always when it's like
</I>&gt;<i> this, there are one ore more downloads happening.
</I>&gt;<i>
</I>&gt;&gt;<i> Are you using any AJAX stuff on client side for handling the
</I>&gt;&gt;<i> download?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> no.  there is a lot of AJAX on the site, but none of it related to
</I>&gt;<i> downloads.
</I>&gt;<i>
</I>&gt;<i> i wonder if this could be related to something else, maybe the
</I>&gt;<i> database pooling?  i can't really imagine why, but i do wonder now..
</I>&gt;<i>  as you said above, new requests really shouldn't be sent to busy
</I>&gt;<i> processes.  so i'm baffled.
</I>&gt;<i>
</I>&gt;<i> - m@
</I>&gt;<i>
</I>&gt;&gt;<i> 2008/9/27 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;<i> sorry maybe i wasn't being clear..  i did get your code
</I>&gt;&gt;&gt;<i> suggestions
</I>&gt;&gt;&gt;<i> working, so that i've replaced the req.sendfile code with the
</I>&gt;&gt;&gt;<i> apache.DECLINED code.  and it is sending the file ok and i'm
</I>&gt;&gt;&gt;<i> downloading it ok, but it doesn't fix the problem as i originally
</I>&gt;&gt;&gt;<i> posted, that the downloading is causing apache to block me when i
</I>&gt;&gt;&gt;<i> click on links while the download is happening.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> - m@
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> What does your handler actually do? The following works for me no
</I>&gt;&gt;&gt;&gt;<i> problems.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> from mod_python import apache
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> def handler(req):
</I>&gt;&gt;&gt;&gt;<i>     req.filename = '/etc/services'
</I>&gt;&gt;&gt;&gt;<i>     req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
</I>&gt;&gt;&gt;&gt;<i>     return apache.DECLINED
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Does the file exist prior to calling apr.stat()?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Apache even sets the output headers okay:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> HTTP/1.1 200 OK
</I>&gt;&gt;&gt;&gt;<i> Date: Fri, 26 Sep 2008 09:50:33 GMT
</I>&gt;&gt;&gt;&gt;<i> Server: Apache/2.2.8 (Unix) mod_python/3.3.2-dev-20080311
</I>&gt;&gt;&gt;&gt;<i> Python/2.5.1
</I>&gt;&gt;&gt;&gt;<i> mod_ssl/2.2.8 OpenSSL/0.9.7l DAV/2 mod_wsgi/3.0-TRUNK
</I>&gt;&gt;&gt;&gt;<i> Last-Modified: Sun, 23 Sep 2007 21:37:31 GMT
</I>&gt;&gt;&gt;&gt;<i> ETag: &quot;535d-a5847-43ad44fac1cc0&quot;
</I>&gt;&gt;&gt;&gt;<i> Accept-Ranges: bytes
</I>&gt;&gt;&gt;&gt;<i> Content-Length: 677959
</I>&gt;&gt;&gt;&gt;<i> Connection: close
</I>&gt;&gt;&gt;&gt;<i> Content-Type: text/plain
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Ie., ETag and length etc.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> 2008/9/26 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;&gt;&gt;<i> nope  :-(
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> One last thing to add then. If this doesn't work, I'll have to
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> just
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> try it myself. :-)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>   req.handler = 'default-handler'
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2008/9/26 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> ok, that worked..  but unfortunately the blocking issue is
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> still
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> happening.  i've verified that the download controller is
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> returning
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> apache.DECLINED and the file downloads ok.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> - m@
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Try adding:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   req.path_info = ''
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> 2008/9/26 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> 2008/9/25 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> 2008/9/24 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Are you setting a content length on the response before
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> calling
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> req.sendfile()?
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> How many concurrent requests for these files are you
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> receiving
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> and
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> how long does it take to download a file?
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> yes, i believe so..  now that you mention it, i haven't
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> verified
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> the file size from the code below, i will do that to be
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> sure.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> here
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> is the code:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> file_path = self.conf.run.app_folder + 'public' +
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> download.path
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> file_stat = os.stat(file_path)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> file_size = str(file_stat.st_size)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> self.req.headers_out['Content-Length'] = file_size
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> self.req.headers_out['Content-Disposition'] =
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> 'attachment;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> filename=%s' % os.path.basename(file_path)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> bytes_sent = self.req.sendfile(file_path)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> BTW, now that you are using mod_python 3.3.1, instead of
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> using
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> req.sendfile(), you could possibly delegate serving of
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> static file
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> back to Apache. From memory this can be done using:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   req.filename = self.conf.run.app_folder + 'public' +
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> download.path
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   req.finfo = apache.stat(req.filename,
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> apache.APR_FINFO_MIN)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   return apache.DECLINED
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> By returning apache.DECLINED you say mod_python handler
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> will
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> not
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> actually handle it, and by having updated req.filename
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> and
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> req.fileinfo updated to new file, when it falls through
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> to
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> default-handler it should serve it as static file.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Doing it this way should bypass prior Apache access
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> control
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> checks.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Thus file doesn't need to be in Apache document tree or
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> anywhere
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> else
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> that is accessible.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> I believe doing it this way also has benefit that Apache
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> will
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> automatically set various headers that you probably
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> wouldn't
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> be.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Please let us know if this alternate method works.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> i tried the following but it doesn't seem to do what i
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> want:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> DocumentRoot /var/www/my/application/public
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> &lt;Directory /var/www/my/application/public&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>  AddHandler python-program .py
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>  PythonHandler myhandler
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> &lt;/Directory&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Use SetHandler instead of AddHandler.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   DocumentRoot /var/www/my/application/public
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   &lt;Directory /var/www/my/application/public&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>    SetHandler python-program
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>    PythonHandler myhandler
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   &lt;/Directory&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> ok, getting closer..  now i get a 404 error in the browser
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> saying
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> 'The requested URL /download/file/3 was not found on this
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> server.'
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> and in the apache logs:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> File does not exist:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> /var/www/application/public/downloads/music/music.zip/file/3
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> so it looks like it's taking the last part of the URI and
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> appending
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> it to the physical filename and looking for that...  the
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> request
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> URI
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> is '<A HREF="http://example.com/download/file/3'.">http://example.com/download/file/3'.</A>  the 'download'
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> controller
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> is what manages the music downloads.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> - m@
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025659.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
	<LI>Next message: <A HREF="025663.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25662">[ date ]</a>
              <a href="thread.html#25662">[ thread ]</a>
              <a href="subject.html#25662">[ subject ]</a>
              <a href="author.html#25662">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
