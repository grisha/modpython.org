<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] requests are blocking when using req.sendfile
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To=88e286470809260251x4348b7dbr7e001fbba606edcc%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025655.html">
   <LINK REL="Next"  HREF="025658.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] requests are blocking when using req.sendfile</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Matt Barnicle</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To=88e286470809260251x4348b7dbr7e001fbba606edcc%40mail.gmail.com"
       TITLE="[mod_python] requests are blocking when using req.sendfile">mattb at wageslavery.org
       </A><BR>
    <I>Fri Sep 26 21:58:56 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025655.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
        <LI>Next message: <A HREF="025658.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25657">[ date ]</a>
              <a href="thread.html#25657">[ thread ]</a>
              <a href="subject.html#25657">[ subject ]</a>
              <a href="author.html#25657">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>sorry maybe i wasn't being clear..  i did get your code suggestions
working, so that i've replaced the req.sendfile code with the
apache.DECLINED code.  and it is sending the file ok and i'm
downloading it ok, but it doesn't fix the problem as i originally
posted, that the downloading is causing apache to block me when i
click on links while the download is happening.

- m@

&gt;<i> What does your handler actually do? The following works for me no
</I>&gt;<i> problems.
</I>&gt;<i>
</I>&gt;<i> from mod_python import apache
</I>&gt;<i>
</I>&gt;<i> def handler(req):
</I>&gt;<i>     req.filename = '/etc/services'
</I>&gt;<i>     req.finfo = apache.stat(req.filename, apache.APR_FINFO_MIN)
</I>&gt;<i>     return apache.DECLINED
</I>&gt;<i>
</I>&gt;<i> Does the file exist prior to calling apr.stat()?
</I>&gt;<i>
</I>&gt;<i> Apache even sets the output headers okay:
</I>&gt;<i>
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Date: Fri, 26 Sep 2008 09:50:33 GMT
</I>&gt;<i> Server: Apache/2.2.8 (Unix) mod_python/3.3.2-dev-20080311
</I>&gt;<i> Python/2.5.1
</I>&gt;<i> mod_ssl/2.2.8 OpenSSL/0.9.7l DAV/2 mod_wsgi/3.0-TRUNK
</I>&gt;<i> Last-Modified: Sun, 23 Sep 2007 21:37:31 GMT
</I>&gt;<i> ETag: &quot;535d-a5847-43ad44fac1cc0&quot;
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> Content-Length: 677959
</I>&gt;<i> Connection: close
</I>&gt;<i> Content-Type: text/plain
</I>&gt;<i>
</I>&gt;<i> Ie., ETag and length etc.
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> 2008/9/26 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;<i> nope  :-(
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> One last thing to add then. If this doesn't work, I'll have to
</I>&gt;&gt;&gt;<i> just
</I>&gt;&gt;&gt;<i> try it myself. :-)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   req.handler = 'default-handler'
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2008/9/26 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;&gt;<i> ok, that worked..  but unfortunately the blocking issue is still
</I>&gt;&gt;&gt;&gt;<i> happening.  i've verified that the download controller is
</I>&gt;&gt;&gt;&gt;<i> returning
</I>&gt;&gt;&gt;&gt;<i> apache.DECLINED and the file downloads ok.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> - m@
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Try adding:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>   req.path_info = ''
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> 2008/9/26 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> 2008/9/25 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> 2008/9/24 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Are you setting a content length on the response before
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> calling
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> req.sendfile()?
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> How many concurrent requests for these files are you
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> receiving
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> and
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> how long does it take to download a file?
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> yes, i believe so..  now that you mention it, i haven't
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> verified
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> the file size from the code below, i will do that to be
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> sure.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> here
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> is the code:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> file_path = self.conf.run.app_folder + 'public' +
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> download.path
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> file_stat = os.stat(file_path)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> file_size = str(file_stat.st_size)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> self.req.headers_out['Content-Length'] = file_size
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> self.req.headers_out['Content-Disposition'] = 'attachment;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> filename=%s' % os.path.basename(file_path)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> bytes_sent = self.req.sendfile(file_path)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> BTW, now that you are using mod_python 3.3.1, instead of
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> using
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> req.sendfile(), you could possibly delegate serving of the
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> static file
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> back to Apache. From memory this can be done using:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   req.filename = self.conf.run.app_folder + 'public' +
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> download.path
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   req.finfo = apache.stat(req.filename,
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> apache.APR_FINFO_MIN)
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   return apache.DECLINED
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> By returning apache.DECLINED you say mod_python handler
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> will
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> not
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> actually handle it, and by having updated req.filename and
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> req.fileinfo updated to new file, when it falls through to
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> default-handler it should serve it as static file.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Doing it this way should bypass prior Apache access control
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> checks.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Thus file doesn't need to be in Apache document tree or
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> anywhere
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> else
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> that is accessible.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> I believe doing it this way also has benefit that Apache
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> will
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> automatically set various headers that you probably
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> wouldn't
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> be.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Please let us know if this alternate method works.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> i tried the following but it doesn't seem to do what i want:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> DocumentRoot /var/www/my/application/public
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> &lt;Directory /var/www/my/application/public&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>  AddHandler python-program .py
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>  PythonHandler myhandler
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> &lt;/Directory&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Use SetHandler instead of AddHandler.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   DocumentRoot /var/www/my/application/public
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   &lt;Directory /var/www/my/application/public&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>    SetHandler python-program
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>    PythonHandler myhandler
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>   &lt;/Directory&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> ok, getting closer..  now i get a 404 error in the browser
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> saying
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 'The requested URL /download/file/3 was not found on this
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> server.'
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> and in the apache logs:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> File does not exist:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> /var/www/application/public/downloads/music/music.zip/file/3
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> so it looks like it's taking the last part of the URI and
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> appending
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> it to the physical filename and looking for that...  the
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> request
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> URI
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> is '<A HREF="http://example.com/download/file/3'.">http://example.com/download/file/3'.</A>  the 'download'
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> controller
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> is what manages the music downloads.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> - m@
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025655.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
	<LI>Next message: <A HREF="025658.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25657">[ date ]</a>
              <a href="thread.html#25657">[ thread ]</a>
              <a href="subject.html#25657">[ subject ]</a>
              <a href="author.html#25657">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
