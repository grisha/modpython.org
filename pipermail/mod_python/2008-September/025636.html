<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] requests are blocking when using req.sendfile
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To=88e286470809230105l268e5aefh391107b552cb50fd%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025635.html">
   <LINK REL="Next"  HREF="025638.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] requests are blocking when using req.sendfile</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Matt Barnicle</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20requests%20are%20blocking%20when%20using%20req.sendfile&In-Reply-To=88e286470809230105l268e5aefh391107b552cb50fd%40mail.gmail.com"
       TITLE="[mod_python] requests are blocking when using req.sendfile">mattb at wageslavery.org
       </A><BR>
    <I>Tue Sep 23 15:07:13 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="025635.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
        <LI>Next message: <A HREF="025638.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25636">[ date ]</a>
              <a href="thread.html#25636">[ thread ]</a>
              <a href="subject.html#25636">[ subject ]</a>
              <a href="author.html#25636">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>well, there are a couple reasons why i didn't try that straight
away.  i'm not really the best at sysadmin type stuff.  if something
were to go wrong this is our one and only live server at the moment
so i avoid upgrading packages unless i know it's necessary.  i
didn't realize before but we're actually using v3.2.8.  it's pretty
recent, however if you think that the installing the latest version
is essential towards figuring out the problem i will do it.

- m@

&gt;<i> And what happens if you stop using an older version of mod_python
</I>&gt;<i> and use the latest version?
</I>&gt;<i>
</I>&gt;<i> In other words, upgrade to mod_python 3.3.1 and then we may be
</I>able to
&gt;<i> help. The older versions have various bugs in them and there is no
</I>&gt;<i> point us trying to debug an issue that may have already been fixed.
</I>&gt;<i>
</I>&gt;<i> Graham
</I>&gt;<i>
</I>&gt;<i> 2008/9/23 Matt Barnicle &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mattb at wageslavery.org</A>&gt;:
</I>&gt;&gt;<i> i'm having an issue with our site, which seems to be directly
</I>&gt;&gt;<i> related to using req.sendfile.  on our site, we have secure music
</I>&gt;&gt;<i> downloads.  the user has to go through a series of steps in order
</I>&gt;&gt;<i> to
</I>&gt;&gt;<i> gain access to the music (fyi, we run a legitimate service, not a
</I>&gt;&gt;<i> pirate or warez site).  just some background info..  basically we
</I>&gt;&gt;<i> can't offer a direct download link or the security can be
</I>&gt;&gt;<i> bypassed.
</I>&gt;&gt;<i> so downloading is done through the handler, which runs the checks,
</I>&gt;&gt;<i> and if everything looks good, the file is sent to the browser
</I>&gt;&gt;<i> using
</I>&gt;&gt;<i> req.sendfile with the local path to the file on disk.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> it works..  but the problem is, requests start backing up whenever
</I>&gt;&gt;<i> a
</I>&gt;&gt;<i> download is being sent.  it looks like new requests are being sent
</I>&gt;&gt;<i> to the apache process that is tied up sending the download file.
</I>&gt;&gt;<i> i
</I>&gt;&gt;<i> don't understand why this is happening though.  i would think that
</I>&gt;&gt;<i> while it's sending the file, no new requests would be queued in
</I>&gt;&gt;<i> that
</I>&gt;&gt;<i> process.  i can verify this easily by downloading a file, and
</I>&gt;&gt;<i> while
</I>&gt;&gt;<i> it's downloading, clicking on a link on the site from the same
</I>&gt;&gt;<i> window in which i downloaded in.  the request will stay in the
</I>&gt;&gt;<i> WAIT
</I>&gt;&gt;<i> state (according to mod_status) until the download is finished,
</I>&gt;&gt;<i> then
</I>&gt;&gt;<i> the page will load and the queue will clear up.  now if i change
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> download link to a static file, served directly by apache, this
</I>&gt;&gt;<i> problem disappears.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> what can i do to fix this?  it's a major issue right now.  many
</I>&gt;&gt;<i> times a day you can go to the site and it will hang for perhaps 1
</I>&gt;&gt;<i> to
</I>&gt;&gt;<i> 3 minutes, then it will load, due to the above described
</I>&gt;&gt;<i> situation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> version notes:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> CentOS release 5 (Final)
</I>&gt;&gt;<i> apache 2.2.3
</I>&gt;&gt;<i> mod_python 3.2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> using prefork compiled into apache.  misc apache configuration:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> KeepAlive Off
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;IfModule prefork.c&gt;
</I>&gt;&gt;<i>  StartServers       8
</I>&gt;&gt;<i>  MinSpareServers    5
</I>&gt;&gt;<i>  MaxSpareServers   20
</I>&gt;&gt;<i>  ServerLimit      256
</I>&gt;&gt;<i>  MaxClients       256
</I>&gt;&gt;<i>  MaxRequestsPerChild  4000
</I>&gt;&gt;<i> &lt;/IfModule&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> thank you for your time and consideration..
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - m@
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025635.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
	<LI>Next message: <A HREF="025638.html">[mod_python] requests are blocking when using req.sendfile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25636">[ date ]</a>
              <a href="thread.html#25636">[ thread ]</a>
              <a href="subject.html#25636">[ subject ]</a>
              <a href="author.html#25636">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
