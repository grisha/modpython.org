<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] how to handle xforms with publisher handler
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20how%20to%20handle%20xforms%20with%20publisher%20handler&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023031.html">
   <LINK REL="Next"  HREF="023028.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] how to handle xforms with publisher handler</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20how%20to%20handle%20xforms%20with%20publisher%20handler&In-Reply-To="
       TITLE="[mod_python] how to handle xforms with publisher handler">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Jan 16 16:55:49 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023031.html">[mod_python] sending post data using xmlhttprequest
</A></li>
        <LI>Next message: <A HREF="023028.html">[mod_python] how to handle xforms with publisher handler
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23027">[ date ]</a>
              <a href="thread.html#23027">[ thread ]</a>
              <a href="subject.html#23027">[ subject ]</a>
              <a href="author.html#23027">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Emiliano Moscato wrote ..
&gt;<i> Hi all:
</I>&gt;<i> 
</I>&gt;<i> I've added this few lines to FieldStorage and it works fine for me:
</I>&gt;<i> 
</I>&gt;<i>         if ctype.lower() == &quot;application/xml&quot;:
</I>&gt;<i>             from xml.dom.minidom import parseString
</I>&gt;<i>             xml = req.read(clen)
</I>&gt;<i>             try:
</I>&gt;<i>                 parseString(xml)
</I>&gt;<i>             except:
</I>&gt;<i>                 raise apache.SERVER_RETURN, apache.HTTP_BAD_REQUEST
</I>&gt;<i>             req.xml = xml
</I>&gt;<i>             return
</I>&gt;<i> 
</I>&gt;<i> Is this interesting for a patch?
</I>&gt;<i> Regards
</I>&gt;<i> 
</I>&gt;<i> Emiliano
</I>
It doesn't really fit in with what FieldStorage is meant to do which is to
decode a post request and convert form parameters into a dictionary
for use. All your code does is leave the content as an attribute of req
for something else to deal with. In essence, all you are doing is hacking
FieldStorage to get around the limitation described in:

  <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-29">http://issues.apache.org/jira/browse/MODPYTHON-29</A>

If you just want to get around that limitation, you might want to instead
look at 'vampire::publisher' from:

  <A HREF="http://www.dscpl.com.au/projects/vampire/">http://www.dscpl.com.au/projects/vampire/</A>

Vampire contains a distinct implementation of publisher which does not
have  the limitation and so in your published function you would be
able to simply do:

  def index(req):
    if req.headers_in['Content-Type'] == 'application/xml':
      ...

This will work because 'vampire::publisher' doesn't error when content type
doesn't equate to something FieldStorage can't handle, instead it just lets
the function deal with it.

For any change to FieldStorage to be accepted in this area, it would have
to properly decode any xforms POST into key/value lists as appropriate and
populate the FieldStorage data structure. That is if that makes sense as I
haven't looked at what is in an xforms POST and whether it is equivalent
to normal form POST but just a different format.

Graham

&gt;<i> 2007/1/12, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt;:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If you are using mod_python 3.2.10 or earlier, try 3.3.0b as it has some
</I>&gt;<i> &gt; fixesto FieldStorage class. Can be downloaded from:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   <A HREF="http://httpd.apache.org/modules/python-download.cgi">http://httpd.apache.org/modules/python-download.cgi</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I suspect though that it still will not work though, as code is:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;         # figure out boundary
</I>&gt;<i> &gt;         try:
</I>&gt;<i> &gt;             i = ctype.lower().rindex(&quot;boundary=&quot;)
</I>&gt;<i> &gt;             boundary = ctype[i+9:]
</I>&gt;<i> &gt;             if len(boundary) &gt;= 2 and boundary[0] == boundary[-1] ==
</I>&gt;<i> '&quot;':
</I>&gt;<i> &gt;                 boundary = boundary[1:-1]
</I>&gt;<i> &gt;             boundary = re.compile(&quot;--&quot; + re.escape(boundary) +
</I>&gt;<i> &gt; &quot;(--)?\r?\n&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Ie., it assumes that boundary is last field on content type line which
</I>&gt;<i> is
</I>&gt;<i> &gt; a
</I>&gt;<i> &gt; bad assumption.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Graham
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 13/01/2007, at 8:41 AM, Emiliano Moscato wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hi all!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks for your answers.
</I>&gt;<i> &gt; I've been looking the code of FieldStorage and publisher. I think it
</I>&gt;<i> is
</I>&gt;<i> &gt; not soo dificult to patch FieldStorage, but: Is anybody else interested
</I>&gt;<i> in
</I>&gt;<i> &gt; patch FieldStorage? If so I'll try it on monday.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On the other hand, I've trying to use another method to send my xforms
</I>&gt;<i> &gt; which uses &quot;multipart/related&quot; as Content-type and I realized that mozilla
</I>&gt;<i> &gt; xforms plugin sends a boundary that is bad handled by
</I>&gt;<i> &gt; publisher-FieldStorage. This is what browser sends:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [...]
</I>&gt;<i> &gt; Content-Length: 522
</I>&gt;<i> &gt; Content-Type: multipart/related;
</I>&gt;<i> &gt; boundary=---------------------------13592280651221337293469391600;
</I>&gt;<i> &gt; type=&quot;application/xml&quot;; start=&quot;&lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">4c599da9.58c746e8 at mozilla.org</A> &gt;&quot;
</I>&gt;<i> &gt; Cookie: lang=1
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -----------------------------13592280651221337293469391600
</I>&gt;<i> &gt; Content-Type: application/xml
</I>&gt;<i> &gt; Content-ID: &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">4c599da9.58c746e8 at mozilla.org</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
</I>&gt;<i> &gt; &lt;idioma xmlns:xf=&quot;<A HREF="http://www.w3.org/2002/xforms&quot;">http://www.w3.org/2002/xforms&quot;</A> xmlns:ev=&quot;<A HREF="http://www.w3.org/2001/xml-events&quot;">http://www.w3.org/2001/xml-events&quot;</A>
</I>&gt;<i> &gt; xmlns:xsi=&quot;<A HREF="http://www.w3.org/2001/XMLSchema-instance&quot;">http://www.w3.org/2001/XMLSchema-instance&quot;</A> xmlns:xsd=&quot;<A HREF="http://www.w3.org/2001/XMLSchema">http://www.w3.org/2001/XMLSchema</A>
</I>&gt;<i> &gt; &quot;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;       &lt;H__interface&gt;main&lt;/H__interface&gt;
</I>&gt;<i> &gt;       &lt;idioma&gt;adadsfasd&lt;/idioma&gt;
</I>&gt;<i> &gt;     &lt;/idioma&gt;
</I>&gt;<i> &gt; -----------------------------13592280651221337293469391600--
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But FieldStorage parse the content-type line up to the end trying to
</I>&gt;<i> get
</I>&gt;<i> &gt; boundary, getting this as boundary:
</I>&gt;<i> &gt; -----------------------------7393760691212604279930853199;
</I>&gt;<i> &gt; type=&quot;application/xml&quot;; start=&quot;&lt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">b8f2849.19571884 at mozilla.org</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is this a firefox problem or a FieldStorage problem?
</I>&gt;<i> &gt; Regards, enjoy the weekend :)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Emiliano
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2007/1/12, Jim Gallacher &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jpg at jgassociates.ca</A>&gt;:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Graham Dumpleton wrote:
</I>&gt;<i> &gt; &gt; &gt; Jim Gallacher wrote ..
</I>&gt;<i> &gt; &gt; &gt;&gt; Emiliano Moscato wrote:
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; Hi all!
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; I'm getting crazy trying to receive xforms xml data with mod_python
</I>&gt;<i> &gt; &gt; +
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; publisher handler.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; In what way are you using mod_python.publisher? Depending to what
</I>&gt;<i> &gt; &gt; &gt; degree you are using it, mod_python 3.3 offers some alternate
</I>&gt;<i> &gt; &gt; mechanisms
</I>&gt;<i> &gt; &gt; &gt; for doing basic dispatch against different resources which might
</I>&gt;<i> be
</I>&gt;<i> &gt; &gt; more
</I>&gt;<i> &gt; &gt; &gt; useful and allow you to still access content of response to decode
</I>&gt;<i> it.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; In a normal HTML form, the data would be sent as
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; application/x-www-form-urlencoded, in the XForms world however,
</I>&gt;<i> this
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; information is sent as XML formatted data (application/xml).
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; Up to now I've used cherryPy as web server and I've got my xml
</I>&gt;<i> data
</I>&gt;<i> &gt; &gt; with
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; cherrypy.threadData.xform.
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; I've read that PHP receive this in $HTTP_RAW_POST_DATA variable.
</I>&gt;<i> If
</I>&gt;<i> &gt; &gt; I
</I>&gt;<i> &gt; &gt; &gt;&gt; send
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; the form to a php script all work fine.
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; But when I try to submit a xforms with method POST to a script
</I>&gt;<i> &gt; &gt; managed
</I>&gt;<i> &gt; &gt; &gt;&gt; by
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; publisher handler I get an error with no log in my apache server
</I>&gt;<i> &gt; &gt; error
</I>&gt;<i> &gt; &gt; &gt;&gt; log.
</I>&gt;<i> &gt; &gt; &gt;&gt;&gt; Any help?
</I>&gt;<i> &gt; &gt; &gt;&gt; You'll need to elaborate on the error you are getting, but I think
</I>&gt;<i> &gt; &gt; part
</I>&gt;<i> &gt; &gt; &gt;&gt; of the problem is that you are bumping up against part of the
</I>&gt;<i> &gt; &gt; internal
</I>&gt;<i> &gt; &gt; &gt;&gt; &quot;magic&quot; of publisher.
</I>&gt;<i> &gt; &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt; Publisher automatically creates a FieldStorage instance.
</I>&gt;<i> &gt; &gt; Unfortunately
</I>&gt;<i> &gt; &gt; &gt;&gt; FieldStorage assumes that the content-type starts with either
</I>&gt;<i> &gt; &gt; &gt;&gt; &quot;application/x-www-form-urlencoded&quot; or &quot;multipart/&quot;. If I had to
</I>&gt;<i> &gt; &gt; guess
</I>&gt;<i> &gt; &gt; &gt;&gt; I'd say that you are getting &quot;501 Not Implemented error&quot; as a result.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt; Here are a couple of solutions that you might consider as a
</I>&gt;<i> &gt; &gt; workaround:
</I>&gt;<i> &gt; &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt; 1. Hack util.FieldStorage to properly handle your content-type.
</I>&gt;<i> If
</I>&gt;<i> &gt; &gt; you
</I>&gt;<i> &gt; &gt; &gt;&gt; do this feel free to submit a patch so FieldStorage can be fixed.
</I>&gt;<i> ;)
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Hmmm, xforms is quite different.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;   <A HREF="http://www.w3.org/TR/xforms/">http://www.w3.org/TR/xforms/</A>
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Looks like a lot of work.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Probably. I certainly wasn't offering to do it. ;)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt; 2. Hack publisher to skip the automatic creation of FieldStorage.
</I>&gt;<i> &gt; &gt; (Line
</I>&gt;<i> &gt; &gt; &gt;&gt; 424 in publisher.py for mod_python 3.3.0b). You can then use req.read
</I>&gt;<i> &gt; &gt; ()
</I>&gt;<i> &gt; &gt; &gt;&gt; to read and process the POST'd data within your content handler.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; I've raised this issue before about publisher not being able to accept
</I>&gt;<i> &gt; &gt; other
</I>&gt;<i> &gt; &gt; &gt; content types. See:
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;   <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-29">http://issues.apache.org/jira/browse/MODPYTHON-29</A>
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Also, like PSP now does, publisher could be made to use 'req.form'
</I>&gt;<i> if
</I>&gt;<i> &gt; &gt; it
</I>&gt;<i> &gt; &gt; &gt; already existed. This would allow a stacked response handler before
</I>&gt;<i> &gt; &gt; &gt; publisher to decide whether some other form content was supplied,
</I>&gt;<i> &gt; &gt; decode
</I>&gt;<i> &gt; &gt; &gt; it and set req.form to a compatible class to FieldStorage. I don't
</I>&gt;<i> &gt; &gt; know that I
</I>&gt;<i> &gt; &gt; &gt; have created an issue for that idea before, but have certainly thought
</I>&gt;<i> &gt; &gt; &gt; about it and perhaps mentioned it on the mailing list.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; That seems like a reasonable solution.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;&gt; 3. Use a PythonFixupHandler before the content handler. In the
</I>&gt;<i> &gt; &gt; &gt;&gt; fixuphandler use req.read() to grab the raw data and adjust the
</I>&gt;<i> &gt; &gt; &gt;&gt; content-type header so that FieldStorage doesn't bomb out. Note
</I>&gt;<i> that
</I>&gt;<i> &gt; &gt; if
</I>&gt;<i> &gt; &gt; &gt;&gt; you want to pass xml field data as parameters to your handler method
</I>&gt;<i> &gt; &gt; &gt;&gt; you'll need to do a bit more work. For example
</I>&gt;<i> &gt; &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt; def index(foo=&quot;bar&quot;):
</I>&gt;<i> &gt; &gt; &gt;&gt;      return &quot;whatever&quot;
</I>&gt;<i> &gt; &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt; &gt;&gt; won't get foo from your xml data. You can likely work around this
</I>&gt;<i> but
</I>&gt;<i> &gt; &gt; &gt;&gt; you'll need to take a look at the source for FieldStorage and
</I>&gt;<i> &gt; &gt; publisher
</I>&gt;<i> &gt; &gt; &gt;&gt; to work out a strategy.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; If you are talking about modifying the input stream, an input filter
</I>&gt;<i> &gt; &gt; would
</I>&gt;<i> &gt; &gt; &gt; perhaps be better. Not sure that that will help since xforms is quite
</I>&gt;<i> &gt; &gt; &gt; different and isn't just a matter of changing content type.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; No, I was just thinking you could get the raw data with req.read()
</I>&gt;<i> &gt; &gt; (parsing the xml or whatever) and then set the content-type to
</I>&gt;<i> &gt; &gt; application/x-www-form-urlencoded. That way the subsequent call to
</I>&gt;<i> &gt; &gt; FieldStorage within publisher won't bomb out. The code would look
</I>&gt;<i> &gt; &gt; something like this:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; def fixuphandler(req):
</I>&gt;<i> &gt; &gt;      if req.headers_in.has_key(&quot;content-type&quot;):
</I>&gt;<i> &gt; &gt;          ctype = req.headers_in[&quot;content-type&quot;]
</I>&gt;<i> &gt; &gt;          if ctype.startswith(&quot;application/xml&quot;):
</I>&gt;<i> &gt; &gt;              req.data = parse_the_xml_data_or_whatever(req.read())
</I>&gt;<i> &gt; &gt;              req.headers_in[&quot;content-type&quot;] =
</I>&gt;<i> &gt; &gt;                       &quot;application/x-www-form-urlencoded&quot;
</I>&gt;<i> &gt; &gt;      return apache.OK
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; A little too hackish perhaps? (Assuming it would even work).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Jim
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; Mod_python mailing list
</I>&gt;<i> &gt; &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt; &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; mOsKi
</I>&gt;<i> &gt; &quot;No hay nada que uno haga mal , lo que hay es poco vino.&quot; Autor Anonimo
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mod_python mailing list
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> mOsKi
</I>&gt;<i> &quot;No hay nada que uno haga mal , lo que hay es poco vino.&quot; Autor Anonimo
</I></PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023031.html">[mod_python] sending post data using xmlhttprequest
</A></li>
	<LI>Next message: <A HREF="023028.html">[mod_python] how to handle xforms with publisher handler
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23027">[ date ]</a>
              <a href="thread.html#23027">[ thread ]</a>
              <a href="subject.html#23027">[ subject ]</a>
              <a href="author.html#23027">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
