<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] strange behaviour with compressed response
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20strange%20behaviour%20with%20compressed%20response&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022915.html">
   <LINK REL="Next"  HREF="022920.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] strange behaviour with compressed response</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20strange%20behaviour%20with%20compressed%20response&In-Reply-To="
       TITLE="[mod_python] strange behaviour with compressed response">grahamd at dscpl.com.au
       </A><BR>
    <I>Tue Jan  2 22:07:55 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="022915.html">[mod_python] strange behaviour with compressed response
</A></li>
        <LI>Next message: <A HREF="022920.html">[mod_python] strange behaviour with compressed response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22916">[ date ]</a>
              <a href="thread.html#22916">[ thread ]</a>
              <a href="subject.html#22916">[ subject ]</a>
              <a href="author.html#22916">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Apologies if this comes through twice on the list, having problems with my
site running reaaaaaalllllllllyyyyyyyy slow and don't think if got through last
time. Graham

m.banaouas wrote ..
&gt;<i> hi,
</I>&gt;<i> what is the difference between serving a file directly or by calling a
</I>&gt;<i> script function?
</I>&gt;<i> case 1: <A HREF="http://localhost/myfile.xml">http://localhost/myfile.xml</A>
</I>&gt;<i> case 2: <A HREF="http://localhost/mydir/boo/getfile">http://localhost/mydir/boo/getfile</A>
</I>&gt;<i> Must I do special call to apache api when compression is activated?
</I>&gt;<i> With Firefox, every thing works fine in two cases.
</I>&gt;<i> With a http client component I'm using in my developpements, both case
</I>&gt;<i> 1 
</I>&gt;<i> and case 2 works fine if I don't ask for compressed data. If I do 
</I>&gt;<i> (Accept-Encoding: gzip), case 1 works fine but case 2 fails.
</I>
Your Apache configuration only enables the DEFLATE output filter for static
files in your htdocs directory, it doesn't enable it for anything under mydir
so unless DEFLATE is being enable somehow elsewhere in the Apache configuration
the output of your published functions would never be compressed.

See other notes further done mixed in with your code and configuration.

&gt;<i> I noticed that returning apache.OK adds unexpected extra &quot;0&quot; on the output.
</I>
Which would be what one expects as functions published using
mod_python.publisher are not the same as basic mod_python handlers. When using
mod_python.publisher the result of the published function is converted to a
string and written back as response content. In a basic mod_python handler the
response is a status indicating success of otherwise of the handler. Look at
the documentation again to see the difference.

&gt;<i> thanks.
</I>&gt;<i> 
</I>&gt;<i> DocumentRoot &quot;C:/Apache/htdocs&quot;
</I>&gt;<i> &lt;Directory /&gt;
</I>&gt;<i>     Options FollowSymLinks
</I>&gt;<i>     AllowOverride None
</I>&gt;<i>     Order deny,allow
</I>&gt;<i>     Deny from all
</I>&gt;<i>     Satisfy all
</I>&gt;<i>     SetOutputFilter DEFLATE
</I>&gt;<i> &lt;/Directory&gt;
</I>&gt;<i> 
</I>&gt;<i> Alias /mydir &quot;C:/MYDIR&quot;
</I>&gt;<i> &lt;Directory C:/MYDIR&gt;
</I>&gt;<i>     Allow from All
</I>&gt;<i>     SetHandler mod_python
</I>&gt;<i>     PythonHandler mod_python.publisher
</I>
Because this is a separate physical directory with distinct Directory
directive, you would also need here:

      SetOutputFilter DEFLATE

to have response from published functions be compressed.

Do take heed of the Apache documentation I pointed you to originally in
regard to DEFLATE module and a possible need to ensure you don't enable
it for some clients because of broken compressed data implementations
in those clients. Also, you shouldn't enable DEFLATE for all file types as files
such as images are usually already compressed and compressing them
again is a pointless exercise.

Another alternative with mod_python 3.3 is to actually make the judgement
within the published function as to whether for a specific response the output
should be compressed or not. To do this, before writing back any content
from the function, call:

    req.add_output_filter('DEFLATE')

This is the same as having using 'SetOutputFilter' in the Apache configuration.

&gt;<i> &lt;/Directory&gt;
</I>&gt;<i> 
</I>&gt;<i> here is the simple boo.py script:
</I>&gt;<i> #---------------------------
</I>&gt;<i> # -*- coding: ISO-8859-1 -*-
</I>&gt;<i> #
</I>&gt;<i> # boo.py
</I>&gt;<i> #
</I>&gt;<i> import os, sys
</I>&gt;<i> from mod_python import apache
</I>&gt;<i> #
</I>&gt;<i> def getfile(req):
</I>&gt;<i>   req.content_type = 'text/xml'
</I>&gt;<i>   req.send_http_header()
</I>&gt;<i>   #
</I>&gt;<i>   f = file('c:/apache/htdocs/myfile.xml','r')
</I>&gt;<i>   xmldata = f.read()
</I>&gt;<i>   f.close()
</I>&gt;<i>   req.write(xmldata)
</I>
This is inefficient. Read the documentation and instead simply try:

  req.sendfile('c:/apache/htdocs/myfile.xml')

What I don't know off hand though is if the file contents still go through
the output filters. I have a feeling they don't as it is actually dropping
down and writing it direct out on the socket for efficiency.

&gt;<i>   #return apache.OK
</I>
Should not return apache.OK in published functions.

&gt;<i> #
</I>&gt;<i> def index(req):
</I>&gt;<i>   return &quot;We are in index()&quot;
</I>&gt;<i> #---------------------------
</I>&gt;<i> 
</I>&gt;<i> and here three traces from a tcp viwer:
</I>&gt;<i> 
</I>&gt;<i> #--MyHttpClient/func_access/without_gzip
</I>&gt;<i> Resolving Remote Host
</I>&gt;<i> Remote Host resolved to 127.0.0.1
</I>&gt;<i> Local Port (8080) opened
</I>&gt;<i> Waiting for connections
</I>&gt;<i> 400: Client connected; 127.0.0.1:4657
</I>&gt;<i> 400: Connecting to Server
</I>&gt;<i> 400: Client to Server (188 bytes)
</I>&gt;<i> GET /mydir/boo/getfile HTTP/1.0
</I>&gt;<i> Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> User-Agent: Mozilla/4.0 (compatible; ICS)
</I>&gt;<i> Host: localhost:80
</I>&gt;<i> 
</I>&gt;<i> 400: Connected to Server
</I>&gt;<i> 400: Server to Client (255 bytes)
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Date: Wed, 03 Jan 2007 00:26:55 GMT
</I>&gt;<i> Server: Apache/2.2.3 (Win32) mod_python/3.3.0b Python/2.4.4
</I>&gt;<i> Vary: Accept-Encoding
</I>&gt;<i> Connection: close
</I>&gt;<i> Content-Type: text/xml
</I>&gt;<i> 
</I>&gt;<i> &lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;
</I>&gt;<i> &lt;document&gt;Hello&lt;/document&gt;
</I>&gt;<i> 
</I>&gt;<i> 400: Server disconnected
</I>&gt;<i> 400: Disconnected from Client
</I>&gt;<i> 
</I>&gt;<i> #-MyHttpClient/func_access/with_gzip
</I>&gt;<i> Resolving Remote Host
</I>&gt;<i> Remote Host resolved to 127.0.0.1
</I>&gt;<i> Local Port (8080) opened
</I>&gt;<i> Waiting for connections
</I>&gt;<i> 488: Client connected; 127.0.0.1:4665
</I>&gt;<i> 488: Connecting to Server
</I>&gt;<i> 488: Client to Server (211 bytes)
</I>&gt;<i> GET /mydir/boo/getfile HTTP/1.0
</I>&gt;<i> Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> Accept-Encoding: gzip
</I>&gt;<i> User-Agent: Mozilla/4.0 (compatible; ICS)
</I>&gt;<i> Host: localhost:80
</I>&gt;<i> 
</I>&gt;<i> 488: Connected to Server
</I>&gt;<i> 488: Server to Client (217 bytes)
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Date: Wed, 03 Jan 2007 00:29:42 GMT
</I>&gt;<i> Server: Apache/2.2.3 (Win32) mod_python/3.3.0b Python/2.4.4
</I>&gt;<i> Vary: Accept-Encoding
</I>&gt;<i> Content-Encoding: gzip
</I>&gt;<i> Connection: close
</I>&gt;<i> Content-Type: text/xml
</I>&gt;<i> 
</I>&gt;<i> 488: Server to Client (74 bytes)
</I>&gt;<i> 0000  B3 B1 AF C8 CD 51 28 4B  2D 2A CE CC CF B3 55 32  .....Q(K-*....U2
</I>&gt;<i> 0010  D4 33 50 52 48 CD 4B CE  4F C9 CC 4B B7 55 F2 0C  .3PRH.K.O..K.U..
</I>&gt;<i> 0020  F6 D7 B5 B0 30 B5 D4 35  54 B2 B7 E3 B2 49 C9 4F  ....0..5T....I.O
</I>&gt;<i> 0030  2E CD 4D CD 2B B1 F3 48  CD C9 C9 B7 D1 87 F3 B9  ..M.+..H........
</I>&gt;<i> 0040  B8 00 86 D4 95 DA 48 00  00 00                    ......H...    
</I>&gt;<i> 488: Server disconnected
</I>&gt;<i> 488: Disconnected from Client
</I>&gt;<i> 
</I>&gt;<i> #--MyHttpClient/file_access/with_gzip
</I>&gt;<i> Resolving Remote Host
</I>&gt;<i> Remote Host resolved to 127.0.0.1
</I>&gt;<i> Local Port (8080) opened
</I>&gt;<i> Waiting for connections
</I>&gt;<i> 428: Client connected; 127.0.0.1:4674
</I>&gt;<i> 428: Connecting to Server
</I>&gt;<i> 428: Connected to Server
</I>&gt;<i> 428: Client to Server (204 bytes)
</I>&gt;<i> GET /myfile.xml HTTP/1.0
</I>&gt;<i> Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> Accept-Encoding: gzip
</I>&gt;<i> User-Agent: Mozilla/4.0 (compatible; ICS)
</I>&gt;<i> Host: localhost:80
</I>&gt;<i> 
</I>&gt;<i> 428: Server to Client (452 bytes)
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Date: Wed, 03 Jan 2007 00:37:41 GMT
</I>&gt;<i> Server: Apache/2.2.3 (Win32) mod_python/3.3.0b Python/2.4.4
</I>&gt;<i> Last-Modified: Tue, 02 Jan 2007 23:30:43 GMT
</I>&gt;<i> ETag: &quot;f832-4b-1e6eace9&quot;
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> Vary: Accept-Encoding
</I>&gt;<i> Content-Encoding: gzip
</I>&gt;<i> Content-Length: 87
</I>&gt;<i> Keep-Alive: timeout=5, max=100
</I>&gt;<i> Connection: Keep-Alive
</I>&gt;<i> Content-Type: application/xml
</I>&gt;<i> 
</I>&gt;<i> 0187  D4 33 50 52 48 CD 4B CE  4F C9 CC 4B B7 55 F2 0C  .3PRH.K.O..K.U..
</I>&gt;<i> 0197  F6 D7 B5 B0 30 B5 D4 35  54 B2 B7 E3 E5 B2 49 C9  ....0..5T.....I.
</I>&gt;<i> 01A7  4F 2E CD 4D CD 2B B1 F3  48 CD C9 C9 B7 D1 87 F3  O..M.+..H.......
</I>&gt;<i> 01B7  79 B9 78 B9 00 CB E5 71  9D 4B 00 00 00           y.x....q.K... 
</I>&gt;<i> 428: Server disconnected
</I>&gt;<i> 428: Disconnected from Client
</I>&gt;<i> 
</I>&gt;<i> #--Firefox--------------------------
</I>&gt;<i> Resolving Remote Host
</I>&gt;<i> Remote Host resolved to 127.0.0.1
</I>&gt;<i> Local Port (8080) opened
</I>&gt;<i> Waiting for connections
</I>&gt;<i> 512: Client connected; 127.0.0.1:4669
</I>&gt;<i> 512: Connecting to Server
</I>&gt;<i> 512: Connected to Server
</I>&gt;<i> 512: Client to Server (439 bytes)
</I>&gt;<i> GET /mydir/boo/getfile HTTP/1.1
</I>&gt;<i> Host: localhost:80
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; fr; rv:1.8.1.1) 
</I>&gt;<i> Gecko/20061204 Firefox/2.0.0.1
</I>&gt;<i> Accept: 
</I>&gt;<i> text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
</I>&gt;<i> Accept-Language: fr,fr-fr;q=0.8,en-us;q=0.5,en;q=0.3
</I>&gt;<i> Accept-Encoding: gzip,deflate
</I>&gt;<i> Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
</I>&gt;<i> Keep-Alive: 300
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 512: Server to Client (287 bytes)
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Date: Wed, 03 Jan 2007 00:32:06 GMT
</I>&gt;<i> Server: Apache/2.2.3 (Win32) mod_python/3.3.0b Python/2.4.4
</I>&gt;<i> Vary: Accept-Encoding
</I>&gt;<i> Content-Encoding: gzip
</I>&gt;<i> Keep-Alive: timeout=5, max=100
</I>&gt;<i> Connection: Keep-Alive
</I>&gt;<i> Transfer-Encoding: chunked
</I>&gt;<i> Content-Type: text/xml
</I>&gt;<i> 
</I>&gt;<i> a
</I>&gt;<i> 512: Server to Client (85 bytes)
</I>&gt;<i> 0000  34 61 0D 0A B3 B1 AF C8  CD 51 28 4B 2D 2A CE CC  4a.......Q(K-*..
</I>&gt;<i> 0010  CF B3 55 32 D4 33 50 52  48 CD 4B CE 4F C9 CC 4B  ..U2.3PRH.K.O..K
</I>&gt;<i> 0020  B7 55 F2 0C F6 D7 B5 B0  30 B5 D4 35 54 B2 B7 E3  .U......0..5T...
</I>&gt;<i> 0030  B2 49 C9 4F 2E CD 4D CD  2B B1 F3 48 CD C9 C9 B7  .I.O..M.+..H....
</I>&gt;<i> 0040  D1 87 F3 B9 B8 00 86 D4  95 DA 48 00 00 00 0D 0A  ..........H.....
</I>&gt;<i> 0050  30 0D 0A 0D 0A                                    0....         
</I>&gt;<i> 512: Server disconnected
</I>&gt;<i> 512: Disconnected from Client
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I></PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022915.html">[mod_python] strange behaviour with compressed response
</A></li>
	<LI>Next message: <A HREF="022920.html">[mod_python] strange behaviour with compressed response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22916">[ date ]</a>
              <a href="thread.html#22916">[ thread ]</a>
              <a href="subject.html#22916">[ subject ]</a>
              <a href="author.html#22916">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
