<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] 2006 &quot;MySQL server has gone away&quot; failures
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%202006%20%22MySQL%20server%20has%20gone%20away%22%20failures&In-Reply-To=B6C73A5E30565245BB6D32B5F5DF7A521202CE%40sense.emmastraat.pijnacker">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022985.html">
   <LINK REL="Next"  HREF="022994.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] 2006 &quot;MySQL server has gone away&quot; failures</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jorey Bump</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%202006%20%22MySQL%20server%20has%20gone%20away%22%20failures&In-Reply-To=B6C73A5E30565245BB6D32B5F5DF7A521202CE%40sense.emmastraat.pijnacker"
       TITLE="[mod_python] 2006 &quot;MySQL server has gone away&quot; failures">list at joreybump.com
       </A><BR>
    <I>Fri Jan 12 12:31:26 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="022985.html">[mod_python] 2006 &quot;MySQL server has gone away&quot; failures
</A></li>
        <LI>Next message: <A HREF="022994.html">[mod_python] 2006 &quot;MySQL server has gone away&quot; failures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22987">[ date ]</a>
              <a href="thread.html#22987">[ thread ]</a>
              <a href="subject.html#22987">[ subject ]</a>
              <a href="author.html#22987">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Martijn Moeling wrote:

&gt;<i> First you should create a database connection non globally the best way
</I>&gt;<i> to do so is to create it as part of the req object in your handler
</I>&gt;<i> 
</I>&gt;<i> I suggest you do in your handler routine:
</I>&gt;<i> 
</I>&gt;<i> def handler(req):
</I>&gt;<i> 	req.database=whatever to connect to your database
</I>&gt;<i> 	req.cursor=req.database.cursor()
</I>&gt;<i> 	req.register_cleanup(closedb,req)	
</I>&gt;<i> 	... # dor the rest of your stuff
</I>&gt;<i> 
</I>&gt;<i> Note the register cleanup line, this is always called, even  if the
</I>&gt;<i> request fails with a python error:
</I>&gt;<i> 
</I>&gt;<i> def closedb(req):
</I>&gt;<i> 	req.cursor.close()
</I>&gt;<i> 	req.database.close()
</I>&gt;<i> 	
</I>&gt;<i> Now the connections get closed nicely and mysql does not run out of
</I>&gt;<i> resources anymore.
</I>
Interesting solution, but aren't you now (briefly) opening a database 
connection for every page view, regardless of it actually needing one?

Also, it looks like the OP is using the PSP handler, not a custom one. 
In that case, the best solution might be to explicitly open and close 
the db handle before and after every query (or tightly grouped series of 
queries). Recent versions of MySQLdb have made it difficult to create 
persistent db connections, and users are advised against it, since the 
overhead of creating new connections is negligible. I had to rewrite a 
number of applications that imported a shared db handle, due to this 
change. Bummer. :(


</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022985.html">[mod_python] 2006 &quot;MySQL server has gone away&quot; failures
</A></li>
	<LI>Next message: <A HREF="022994.html">[mod_python] 2006 &quot;MySQL server has gone away&quot; failures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22987">[ date ]</a>
              <a href="thread.html#22987">[ thread ]</a>
              <a href="subject.html#22987">[ subject ]</a>
              <a href="author.html#22987">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
