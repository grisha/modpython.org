<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] 2006 &quot;MySQL server has gone away&quot; failures
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%202006%20%22MySQL%20server%20has%20gone%20away%22%20failures&In-Reply-To=200701121045.22939.fred%40urlbit.us">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022984.html">
   <LINK REL="Next"  HREF="022985.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] 2006 &quot;MySQL server has gone away&quot; failures</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Roger</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%202006%20%22MySQL%20server%20has%20gone%20away%22%20failures&In-Reply-To=200701121045.22939.fred%40urlbit.us"
       TITLE="[mod_python] 2006 &quot;MySQL server has gone away&quot; failures">crosseyedpenguin at cox.net
       </A><BR>
    <I>Sat Jan 13 11:00:11 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="022984.html">[mod_python] 2006 &quot;MySQL server has gone away&quot; failures
</A></li>
        <LI>Next message: <A HREF="022985.html">[mod_python] 2006 &quot;MySQL server has gone away&quot; failures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23000">[ date ]</a>
              <a href="thread.html#23000">[ thread ]</a>
              <a href="subject.html#23000">[ subject ]</a>
              <a href="author.html#23000">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Fred of UrlBit.Us wrote:
&gt;<i> Hello, all.
</I>&gt;<i>
</I>&gt;<i> I intend to use mod_python for a couple of major websites, but I am running 
</I>&gt;<i> into an annoying problem.
</I>&gt;<i>
</I>&gt;<i> I've seen something similar posted elsewhere, but no firm resolution.
</I>&gt;<i>
</I>&gt;<i> My mod_python server will run just fine for a while following a restart of 
</I>&gt;<i> Apache, but after some time I get the following OperationalError exception:
</I>&gt;<i>
</I>&gt;<i> OperationalError: (2006, 'MySQL server has gone away')
</I>&gt;<i>
</I>&gt;<i> I can't seem to nail this one down, or even why it would happen. I even tried 
</I>&gt;<i> pinging the connection early on in the handler, but still no dice.
</I>&gt;<i>
</I>&gt;<i> A restart of the server eliminates the problem for a while. Also, sometimes 
</I>&gt;<i> the problem goes away on its own (but comes back later). And of course, when 
</I>&gt;<i> I am sitting there trying to reproduce the problem, it works perfectly!
</I>&gt;<i>
</I>&gt;<i> Any clues or suggestions would be extremely helpful.
</I>&gt;<i>
</I>&gt;<i> Setup: Apache 2, Python 2.5, mod_python 3.2.10
</I>&gt;<i>
</I>&gt;<i> stack dump:
</I>&gt;<i>
</I>&gt;<i> ERROR In PyClops plugin &lt;module 'app.urlbit' 
</I>&gt;<i> from '/home/urlbit/site/web/php/app/urlbit/__init__.py'&gt; 
</I>&gt;<i>             Traceback (most recent call last):
</I>&gt;<i>   File &quot;/home/ecms/py/pyclops/plugins/__init__.py&quot;, line 34, in 
</I>&gt;<i> _application_dispatcher
</I>&gt;<i>     if plug.handle(pyreq):
</I>&gt;<i>   File &quot;/home/urlbit/site/web/php/app/urlbit/__init__.py&quot;, line 52, in handle
</I>&gt;<i>     psp.handle(pyreq)
</I>&gt;<i>   File &quot;/home/ecms/py/pyclops/psp.py&quot;, line 25, in handle
</I>&gt;<i>     p.run()
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/site-packages/mod_python/psp.py&quot;, line 213, 
</I>&gt;<i> in run
</I>&gt;<i>     exec code in global_scope
</I>&gt;<i>   File &quot;/home/urlbit/site/web/create.html&quot;, line 100, in &lt;module&gt;
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/site-packages/MySQLdb/cursors.py&quot;, line 163, 
</I>&gt;<i> in execute
</I>&gt;<i>     self.errorhandler(self, exc, value)
</I>&gt;<i>   File &quot;/usr/local/lib/python2.5/site-packages/MySQLdb/connections.py&quot;, line 
</I>&gt;<i> 35, in defaulterrorhandler
</I>&gt;<i>     raise errorclass, errorvalue
</I>&gt;<i> OperationalError: (2006, 'MySQL server has gone away')
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>   
</I>You didn't say what versions of MySQL and MySQLdb you are using.  If 
your connection is lost after being idle for 8 hours and it is version 
MySQL 5, then this from
<A HREF="http://dev.mysql.com/doc/refman/5.0/en/upgrading-from-4-1.html">http://dev.mysql.com/doc/refman/5.0/en/upgrading-from-4-1.html</A> is a
clue:

'''
The reconnect flag in the MYSQL structure is set to 0 by
mysql_real_connect(). Only those client programs which did not
explicitly set this flag to 0 or 1 after mysql_real_connect()
experience a change. Having automatic reconnection enabled by default
was considered too dangerous (due to the fact that table locks,
temporary tables, user variables, and session variables are lost after
reconnection).
'''

The problem is MySQLdb isn't setting the reconnect flag required by 
version MySQL 5.  A mysqldb patch can be found here:
<A HREF="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1483074&amp;group_id=22307&amp;atid=374934">http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1483074&amp;group_id=22307&amp;atid=374934</A>

If you are restarting your application daily to take backups of your 
database or for some other reason, then an alternative is to just up the 
default timeout from 8 hours to 25 hours by adding a wait_timeout to  
/etc/my.cnf.

'''
[mysqld]
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
# Default to using old password format for compatibility with mysql 3.x
# clients (those using the mysqlclient10 compatibility package).
old_passwords=1
# rdh 2006-12-27 fix for OperationalError: (2006, 'MySQL server has gone 
away')
wait_timeout=90000
    
[mysql.server]
user=mysql
basedir=/var/lib

[mysqld_safe]
log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid
'''

The default MySQL timeout is set to 8 hours, you can see it by doing a:
   /usr/libexec/mysqld --help --verbose

Roger


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022984.html">[mod_python] 2006 &quot;MySQL server has gone away&quot; failures
</A></li>
	<LI>Next message: <A HREF="022985.html">[mod_python] 2006 &quot;MySQL server has gone away&quot; failures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23000">[ date ]</a>
              <a href="thread.html#23000">[ thread ]</a>
              <a href="subject.html#23000">[ subject ]</a>
              <a href="author.html#23000">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
