<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] The new module loader
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20The%20new%20module%20loader&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020924.html">
   <LINK REL="Next"  HREF="020926.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] The new module loader</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20The%20new%20module%20loader&In-Reply-To="
       TITLE="[mod_python] The new module loader">grahamd at dscpl.com.au
       </A><BR>
    <I>Thu Apr 20 21:04:51 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020924.html">[mod_python] PythonAuthzHandler not working
</A></li>
        <LI>Next message: <A HREF="020926.html">[SPAM] Re: [mod_python] The new module loader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20925">[ date ]</a>
              <a href="thread.html#20925">[ thread ]</a>
              <a href="subject.html#20925">[ subject ]</a>
              <a href="author.html#20925">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dan Eloff wrote ..
&gt;<i> Yay! I've got it now, and it compiled fine. I suspect something that will
</I>&gt;<i> still be a hitch is the need for that __clone__() method you talked about.
</I>&gt;<i> How do I use it, is it documented anywhere, or is there an example
</I>&gt;<i> __clone__() method I can see?
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> -Dan
</I>
Note that the __clone__() method is something that I added because of
a need I saw. I doubt that anyone else has burrowed into the code for
the importer deep enough yet to understand what it is necessarily all
about and thus the whole concept hasn't been peer reviewed as such.
Thus whether it is included at all, or in the form as it currently exists
is not final.

That said, I have attached a very contrived set of examples of migrating
data from an old module to a new. It looks messy purely because of
the different examples and support for multithreading. If a module is
complicated and you want to be able to support multithreading and
module reloading, it will be complicated. I've seen a bit of dubious code
posted in the past which given the right conditions would blow up,
but without a proper solution have generally refrained from pointing
out the problems.

Put the attached file in a directory configured for mod_python.publisher
with a configuration something like:

  PythonInterpreter testing
  AddHandler mod_python .py
  PythonHandler mod_python.publisher
  PythonDebug On
  PythonAutoReload On

The &quot;testing&quot; interpreter is the one I have the new module importer
enabled for. Ie., in main Apache configuration, outside of all container
directives have:

  PythonOption mod_python.future.importer testing

Check that all works by accessing page as &quot;child.py&quot;. Once it works,
copy &quot;child.py&quot; to &quot;parent.py&quot; and add at the start the line:

  import child

Then access &quot;parent.py&quot;.

Now for some fun, update modification time on &quot;parent.py&quot; by touching
it or resaving it. Watch how reload counter increments. Touch it again
and see how transfer counter increments. Work out from code what
each of the bits is doing and why certain things are done certain ways.
If you don't understand, ask.

Now for some tricky stuff. Touch the &quot;child.py&quot; file, but still access
&quot;parent.py&quot;. See how the parent module gets reloaded. Keep touching
&quot;child.py&quot; if you don't believe what is happening. Also access &quot;child.py&quot;
from browser as well to see how was also reloaded.

What is happening here is that new module importer doesn't just look
at page you are accessing, but looks at modules it imports and if the
child changes, the parent gets reloaded automatically along with the
child. With this working, you avoid all the horrible problems that exist
now of having to force reloads by touching all files or restarting Apache.

Finally, note how the reload is occurring even though child was imported
using &quot;import&quot; statement. This is because underneath it is magically
mapping to apache.import_module(). Change the &quot;import&quot; from:

  import child

to:

  child = apache.import_module(&quot;child&quot;)

and you will see it works the same.

The rules are as per that incomplete document I referred you to
about the module importer.

BTW, you cant totally avoid Apache restarts when you start using
__clone__() unless you are quite careful that it handles gracefully
not finding the data in an existing module that it is looking to copy
across. Anyway, experiment and you will see what I mean.

You might also see if you can work out what __purge__() function
does by looking at source code. :-)

Hope this provides you with hours of fun.

Graham

&gt;<i> On 4/20/06, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Quoting from some of Jim's notes:
</I>&gt;<i> &gt;    To access the Subversion repositories anonymously, you will need a
</I>&gt;<i> &gt; Subversion client.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    Choose the branch you would like to work on and check it out. For
</I>&gt;<i> &gt; example, to get the
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    current development branch (trunk), use:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      svn co <A HREF="http://svn.apache.org/repos/asf/httpd/mod_python/trunk">http://svn.apache.org/repos/asf/httpd/mod_python/trunk</A>
</I>&gt;<i> &gt; mod_python
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Graham
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 21/04/2006, at 4:17 AM, Dan Eloff wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Excellent, now I just have to figure out how to get it from the
</I>&gt;<i> &gt; &gt; svn. There's no instructions (that I found) on the mod_python site,
</I>&gt;<i> &gt; &gt; probably because it's something everybody but me knows.I downloaded
</I>&gt;<i> &gt; &gt; TortoiseSVN because that seems to be what you need on windows, and
</I>&gt;<i> &gt; &gt; it when I click on checkout it wants to know the url of the
</I>&gt;<i> &gt; &gt; repository.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; <A HREF="http://svn.apache.org">http://svn.apache.org</A> and <A HREF="http://svn.apache.org/httpd/mod_python/">http://svn.apache.org/httpd/mod_python/</A>
</I>&gt;<i> &gt; &gt; do not work.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; What's the url (and am I even going about this the right way?)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Thanks,
</I>&gt;<i> &gt; &gt; -Dan
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; On 4/19/06, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote: Dan
</I>&gt;<i> &gt; &gt; Eloff wrote ..
</I>&gt;<i> &gt; &gt; &gt; It sounds interesting, it might just finally solve all my
</I>&gt;<i> &gt; &gt; importing woes.
</I>&gt;<i> &gt; &gt; &gt; How do I enable this UMI?
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Thanks,
</I>&gt;<i> &gt; &gt; &gt; -Dan
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; See:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;    <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-143#action_12370976">http://issues.apache.org/jira/browse/MODPYTHON-143#action_12370976</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Graham
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; On 4/19/06, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; Dan Eloff wrote ..
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; I am interested in how this unified module importer works and
</I>&gt;<i> &gt; &gt; how it
</I>&gt;<i> &gt; &gt; &gt; &gt; avoids
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; these problems.
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; I'd really appreciate a brief description of it's
</I>&gt;<i> &gt; &gt; architecture, not
</I>&gt;<i> &gt; &gt; &gt; that
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; you
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; usually need all that much encouraging ;)
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; Thanks,
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; -Dan
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; Bit busy today to elaborate too much, but you can start by
</I>&gt;<i> &gt; &gt; reading my
</I>&gt;<i> &gt; &gt; &gt; &gt; far from complete document on it:
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt;   <A HREF="http://www.dscpl.com.au/articles/modpython-007.html">http://www.dscpl.com.au/articles/modpython-007.html</A>
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; Graham
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; On 4/19/06, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">grahamd at dscpl.com.au</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; On 20/04/2006, at 8:06 AM, Dan Eloff wrote:
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; I went digging through the mod_python files and
</I>&gt;<i> &gt; &gt; discovered how
</I>&gt;<i> &gt; &gt; &gt; the
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; new
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; publisher loader works (using ModuleCache) and I borrowed
</I>&gt;<i> &gt; &gt; the idea
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; to
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; import modules for my handler.
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; Note that mod_python 3.3 will like be discarding that
</I>&gt;<i> &gt; &gt; module loader
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; and the original one and replacing it with a grand unified
</I>&gt;<i> &gt; &gt; module
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; reloader. :-)
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; The purpose of ModuleCache was to avoid sys.modules right?
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; Yes.
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; I'm having some trouble with this, and I eventually
</I>&gt;<i> &gt; &gt; tracked it
</I>&gt;<i> &gt; &gt; &gt; down
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; to
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; multiple versions of a dependancy module being loaded.
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; Known issue. See:
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; <A HREF="http://www.dscpl.com.au/articles/">http://www.dscpl.com.au/articles/</A>
</I>&gt;<i> &gt; &gt; modpython-003.html#multiple-module-
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; instances
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; My handler loads one version, with empty module
</I>&gt;<i> &gt; &gt; variables, while
</I>&gt;<i> &gt; &gt; &gt; the
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; actual modules for the pages load different version(s)
</I>&gt;<i> &gt; &gt; and populate
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; them with data. The changes are never reflected in the
</I>&gt;<i> &gt; &gt; version
</I>&gt;<i> &gt; &gt; &gt; kept
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; by
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; my handler (because they are not the same)
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; This all makes sense, and is probably the intended
</I>&gt;<i> &gt; &gt; effect, but
</I>&gt;<i> &gt; &gt; &gt; what
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; do
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; you do for modules like Session in mod_python, where
</I>&gt;<i> &gt; &gt; MemorySession
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; uses a static class member to store sessions? Wouldn't
</I>&gt;<i> &gt; &gt; the page
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; modules each get their own version and thusly prevent
</I>&gt;<i> &gt; &gt; sessions
</I>&gt;<i> &gt; &gt; &gt; from
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; working?
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; Also see:
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; <A HREF="http://www.dscpl.com.au/articles/modpython-003.html#transfer-of-">http://www.dscpl.com.au/articles/modpython-003.html#transfer-of-</A>
</I>&gt;<i> &gt; &gt; module-
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; data
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; I need to be able to reload modified modules, but also to
</I>&gt;<i> &gt; &gt; make
</I>&gt;<i> &gt; &gt; &gt; use
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; of
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; shared modules. These seem to be conflicting needs,
</I>&gt;<i> &gt; &gt; however. Does
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; anybody have any inisght into this situation that they
</I>&gt;<i> &gt; &gt; can share?
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; Only that mod_python 3.3 will hopefully fix a lot of this
</I>&gt;<i> &gt; &gt; stuff.
</I>&gt;<i> &gt; &gt; &gt; If
</I>&gt;<i> &gt; &gt; &gt; &gt; you
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; are prepared to give 3.3 source code out of subversion
</I>&gt;<i> &gt; &gt; repository
</I>&gt;<i> &gt; &gt; &gt; a go
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; to see if things work as you expect, let me know and will
</I>&gt;<i> &gt; &gt; tell you
</I>&gt;<i> &gt; &gt; &gt; the
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; magic to enable the unified module importer in 3.3 as at
</I>&gt;<i> &gt; &gt; moment it
</I>&gt;<i> &gt; &gt; &gt; is
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; still off by default.
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; Note though that even in 3.3, the &quot;transfer of module data&quot;
</I>&gt;<i> &gt; &gt; issue
</I>&gt;<i> &gt; &gt; &gt; &gt; still
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; has to be explicitly dealt with in some way. Although not
</I>&gt;<i> &gt; &gt; confirmed
</I>&gt;<i> &gt; &gt; &gt; &gt; how
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; this will be done, the new module importer as it stands now
</I>&gt;<i> &gt; &gt; allows
</I>&gt;<i> &gt; &gt; &gt; a
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; module to define a __clone__() method which will be called
</I>&gt;<i> &gt; &gt; and which
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; can be used to transfer data from an old module to a new
</I>&gt;<i> &gt; &gt; where data
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; needs
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; to be preserved across reloads.
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; As I said, if interested I'll go into it more later.
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; Graham
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: child.py
Type: application/octet-stream
Size: 3068 bytes
Desc: not available
Url : <A HREF="http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20060420/3b236b50/child.obj">http://mm_cfg_has_not_been_edited_to_set_host_domains/pipermail/mod_python/attachments/20060420/3b236b50/child.obj</A>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020924.html">[mod_python] PythonAuthzHandler not working
</A></li>
	<LI>Next message: <A HREF="020926.html">[SPAM] Re: [mod_python] The new module loader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20925">[ date ]</a>
              <a href="thread.html#20925">[ thread ]</a>
              <a href="subject.html#20925">[ subject ]</a>
              <a href="author.html#20925">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
