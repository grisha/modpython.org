<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Output Filters Redeaux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Output%20Filters%20Redeaux&In-Reply-To=001101c6623d%2416fa7e40%240301a8c0%40uberbox">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020878.html">
   <LINK REL="Next"  HREF="020871.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Output Filters Redeaux</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Output%20Filters%20Redeaux&In-Reply-To=001101c6623d%2416fa7e40%240301a8c0%40uberbox"
       TITLE="[mod_python] Output Filters Redeaux">grahamd at dscpl.com.au
       </A><BR>
    <I>Mon Apr 17 17:34:29 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020878.html">[mod_python] Output Filters Redeaux
</A></li>
        <LI>Next message: <A HREF="020871.html">[mod_python] Output Filters Redeaux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20879">[ date ]</a>
              <a href="thread.html#20879">[ thread ]</a>
              <a href="subject.html#20879">[ subject ]</a>
              <a href="author.html#20879">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>BTW, since you are modifying the length of the content, you must  
ensure you
delete any content length header in the req.headers_out, otherwise it  
will
disagree with what is actually sent and clients may hang waiting for  
data or
prematurely truncate data.

The deletion of the header must be done before the first call to  
filter.write().

On 18/04/2006, at 2:36 AM, Lee Brown wrote:

&gt;<i> Greetings!
</I>&gt;<i>
</I>&gt;<i> This is the code for a Mod Python output filter that performs an  
</I>&gt;<i> XSLT transform on XML data that I published a few weeks ago.  I've  
</I>&gt;<i> restructured it as an example application of the filter template:
</I>&gt;<i>
</I>&gt;<i> from mod_python import apache
</I>&gt;<i> from cStringIO import StringIO
</I>&gt;<i> import lxml.etree
</I>&gt;<i> import time
</I>&gt;<i>
</I>&gt;<i> name = 'LXML'
</I>&gt;<i> timestring = 'Time to process XML/XSLT files using %s: %.3f  
</I>&gt;<i> milliseconds (%s pages per second) [%s pass]\n'
</I>&gt;<i>
</I>&gt;<i> xsltfile = open('c:/webdev/sites/crashtest/templates/ 
</I>&gt;<i> template.xslt', 'rU')
</I>&gt;<i> styledoc = lxml.etree.parse(StringIO(xsltfile.read()))
</I>&gt;<i> transformer = lxml.etree.XSLT(styledoc)
</I>&gt;<i> xsltfile.close()
</I>&gt;<i>
</I>&gt;<i> def outputfilter (filter):
</I>&gt;<i>     try:
</I>&gt;<i>         streambuffer = filter.req.streambuffer
</I>&gt;<i>     except AttributeError:
</I>
            try:
              del filter.req.headers_out[&quot;Content-Length&quot;]
            except:
              pass

&gt;<i>         filter.req.streambuffer = StringIO()
</I>&gt;<i>         streambuffer = filter.req.streambuffer
</I>&gt;<i>         filter.req.start = time.clock()
</I>&gt;<i>         filter.req.passes = 0
</I>&gt;<i>
</I>&gt;<i>     streamlet = filter.read()
</I>&gt;<i>     while streamlet:
</I>&gt;<i>         filter.req.passes += 1
</I>&gt;<i>         streambuffer.write(streamlet.replace('\r\n', '\n'))
</I>&gt;<i>         streamlet = filter.read()
</I>&gt;<i>
</I>&gt;<i>     if streamlet is None:
</I>&gt;<i>         doc = lxml.etree.parse(streambuffer)
</I>&gt;<i>         doc.xinclude()
</I>&gt;<i>         result = str(transformer(doc))
</I>&gt;<i>         end = time.clock()
</I>&gt;<i>         start = filter.req.start
</I>&gt;<i>         passes = filter.req.passes
</I>&gt;<i>         ms = (end-start)*1000
</I>&gt;<i>         pps = int(1/(end-start))
</I>&gt;<i>         timestamp = timestring % (name, ms, pps, passes)
</I>&gt;<i>         filter.write(result.replace('benchmark', timestamp))
</I>&gt;<i>         filter.close()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Best Regards,
</I>&gt;<i> Lee E. Brown
</I>&gt;<i> (<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">leebrown at leebrown.org</A>)
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020878.html">[mod_python] Output Filters Redeaux
</A></li>
	<LI>Next message: <A HREF="020871.html">[mod_python] Output Filters Redeaux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20879">[ date ]</a>
              <a href="thread.html#20879">[ thread ]</a>
              <a href="subject.html#20879">[ subject ]</a>
              <a href="author.html#20879">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
