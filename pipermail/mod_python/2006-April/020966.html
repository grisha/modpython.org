<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] PythonAuthzHandler not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20PythonAuthzHandler%20not%20working&In-Reply-To=4555C0AA-078E-41FE-8E21-6458AE29918D%40dscpl.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020961.html">
   <LINK REL="Next"  HREF="020967.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] PythonAuthzHandler not working</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jim Gallacher</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20PythonAuthzHandler%20not%20working&In-Reply-To=4555C0AA-078E-41FE-8E21-6458AE29918D%40dscpl.com.au"
       TITLE="[mod_python] PythonAuthzHandler not working">jpg at jgassociates.ca
       </A><BR>
    <I>Sun Apr 23 22:23:16 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020961.html">[mod_python] PythonAuthzHandler not working
</A></li>
        <LI>Next message: <A HREF="020967.html">[mod_python] PythonAuthzHandler not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20966">[ date ]</a>
              <a href="thread.html#20966">[ thread ]</a>
              <a href="subject.html#20966">[ subject ]</a>
              <a href="author.html#20966">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Problem solved, discussion below. Thanks for your help Graham. The 
mod_python project is *very* lucky to have you on board.

Graham Dumpleton wrote:
&gt;<i> 
</I>&gt;<i> On 23/04/2006, at 11:43 AM, Graham Dumpleton wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 23/04/2006, at 8:19 AM, Graham Dumpleton wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 23/04/2006, at 5:22 AM, Jim Gallacher wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Graham Dumpleton wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Add to config:
</I>&gt;&gt;&gt;&gt;&gt;<i>   AuthAuthoritative Off
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> That doesn't really make sense to me. Nothing like this is mentioned 
</I>&gt;&gt;&gt;&gt;<i> for other auth modules like mod_auth_ldap.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I couldn't even find it documented. It is mentioned in source code 
</I>&gt;&gt;&gt;<i> for 2.0.
</I>&gt;&gt;&gt;<i> Turns of inbuilt auth.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> BTW, if you are using Apache 2.2, you might actually need both:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   AuthzDefaultAuthoritative Off
</I>&gt;&gt;<i>   AuthzUserAuthoritative Off
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I didn't check before if it had changed form 2.0 to 2.2.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'll do some tests and get back to you on what is required for 2.2 if 
</I>&gt;&gt;<i> that
</I>&gt;&gt;<i> is what you are using.
</I>&gt;<i> 
</I>&gt;<i> Done testing, and on Apache 2.2, you don't need either of the above.
</I>&gt;<i> 
</I>&gt;<i> Here is a summary of what I found. Note that I am using mod_python 3.3
</I>&gt;<i> from trunk. First off, am using the handlers:
</I>&gt;<i> 
</I>&gt;<i>     from mod_python import apache
</I>&gt;<i> 
</I>&gt;<i>     def authenhandler(req):
</I>&gt;<i>         apache.log_error(&quot;authenhandler&quot;)
</I>&gt;<i>         req.phases = [&quot;authenhandler&quot;]
</I>&gt;<i>         req.user = &quot;grumpy&quot;
</I>&gt;<i>         req.ap_auth_type = req.auth_type()
</I>&gt;<i>         return apache.OK
</I>&gt;<i> 
</I>&gt;<i>     def authzhandler(req):
</I>&gt;<i>         apache.log_error(&quot;authzhandler&quot;)
</I>&gt;<i>         req.phases.append(&quot;authzhandler&quot;)
</I>&gt;<i>         return apache.OK
</I>&gt;<i> 
</I>&gt;<i>     def handler(req):
</I>&gt;<i>         apache.log_error(&quot;handler&quot;)
</I>&gt;<i>         req.phases.append(&quot;handler&quot;)
</I>&gt;<i>         req.content_type = &quot;text/plain&quot;
</I>&gt;<i>         req.write(req.ap_auth_type+&quot;\n&quot;)
</I>&gt;<i>         req.write(req.user+&quot;\n&quot;)
</I>&gt;<i>         req.write(str(req.phases)+&quot;\n&quot;)
</I>&gt;<i>         return apache.OK
</I>&gt;<i> 
</I>&gt;<i> For Apache 2.0, the configuration that works is:
</I>&gt;<i> 
</I>&gt;<i>     SetHandler mod_python
</I>&gt;<i> 
</I>&gt;<i>     PythonAuthenHandler authz_1
</I>&gt;<i>     PythonAuthzHandler authz_1
</I>&gt;<i>     PythonHandler authz_1
</I>&gt;<i>     PythonDebug On
</I>&gt;<i> 
</I>&gt;<i>     AuthType authztest
</I>&gt;<i>     Require group grumpy
</I>&gt;<i>     #AuthAuthoritative Off
</I>&gt;<i> 
</I>&gt;<i> The result in the browser is:
</I>&gt;<i> 
</I>&gt;<i>     authztest
</I>&gt;<i>     grumpy
</I>&gt;<i>     ['authenhandler', 'authzhandler', 'handler']
</I>&gt;<i> 
</I>&gt;<i> Note that I am not using AuthAuthoritative in the end here.
</I>&gt;<i> 
</I>&gt;<i> Now, if I instead use either:
</I>&gt;<i> 
</I>&gt;<i>     Require user grumpy
</I>&gt;<i> 
</I>&gt;<i> or:
</I>&gt;<i> 
</I>&gt;<i>     Require valid-user
</I>&gt;<i> 
</I>&gt;<i> even if set in conjunction with:
</I>&gt;<i> 
</I>&gt;<i>     Require group grumpy
</I>&gt;<i> 
</I>&gt;<i> the result is:
</I>&gt;<i> 
</I>&gt;<i>     authztest
</I>&gt;<i>     grumpy
</I>&gt;<i>     ['authenhandler', 'handler']
</I>&gt;<i> 
</I>&gt;<i> Thus, no authzhandler run. This is because builtin mod_authz is getting 
</I>&gt;<i> run before
</I>&gt;<i> my authzhandler and the user condition is being satisfied and so my 
</I>&gt;<i> handler never
</I>&gt;<i> gets to run.
</I>&gt;<i> 
</I>&gt;<i> If you want to have something like 'valid-user' or 'user', you need to 
</I>&gt;<i> call it something
</I>&gt;<i> else. For example, thus:
</I>&gt;<i> 
</I>&gt;<i>     Require authztest::valid-user
</I>&gt;<i> 
</I>&gt;<i> If I do that alone though, I get authorization required response and 
</I>&gt;<i> error log says:
</I>&gt;<i> 
</I>&gt;<i>     [Sun Apr 23 13:21:58 2006] [error] [client ::1] access to 
</I>&gt;<i> /testing/authz-1/ failed, reason: unknown require 
</I>&gt;<i> directive:&quot;authztest::valid-user&quot;
</I>&gt;<i> 
</I>&gt;<i> To get past that, that is where in Apache 2.0 I need to set 
</I>&gt;<i> AuthAuthoritative.
</I>&gt;<i> 
</I>&gt;<i>     SetHandler mod_python
</I>&gt;<i> 
</I>&gt;<i>     PythonAuthenHandler authz_1
</I>&gt;<i>     PythonAuthzHandler authz_1
</I>&gt;<i>     PythonHandler authz_1
</I>&gt;<i>     PythonDebug On
</I>&gt;<i> 
</I>&gt;<i>     AuthType authztest
</I>&gt;<i>     Require authztest::valid-user
</I>&gt;<i>     AuthAuthoritative Off
</I>&gt;<i> 
</I>&gt;<i> Thus I again get:
</I>&gt;<i> 
</I>&gt;<i>     authztest
</I>&gt;<i>     grumpy
</I>&gt;<i>     ['authenhandler', 'authzhandler', 'handler']
</I>&gt;<i> 
</I>&gt;<i> In Apache 2.2, things are slightly different. Using:
</I>&gt;<i> 
</I>&gt;<i>     SetHandler mod_python
</I>&gt;<i> 
</I>&gt;<i>     PythonAuthenHandler authz_1
</I>&gt;<i>     PythonAuthzHandler authz_1
</I>&gt;<i>     PythonHandler authz_1
</I>&gt;<i>     PythonDebug On
</I>&gt;<i> 
</I>&gt;<i>     AuthType authztest
</I>&gt;<i>     Require group grumpy
</I>&gt;<i> 
</I>&gt;<i> still works okay. Using:
</I>&gt;<i> 
</I>&gt;<i>     Require user grumpy
</I>&gt;<i> 
</I>&gt;<i> or:
</I>&gt;<i> 
</I>&gt;<i>     Require valid-user
</I>&gt;<i> 
</I>&gt;<i> still results in:
</I>&gt;<i> 
</I>&gt;<i>     authztest
</I>&gt;<i>     grumpy
</I>&gt;<i>     ['authenhandler', 'handler']
</I>&gt;<i> 
</I>&gt;<i> In Apache 2.2, if I use:
</I>&gt;<i> 
</I>&gt;<i>     SetHandler mod_python
</I>&gt;<i> 
</I>&gt;<i>     PythonAuthenHandler authz_1
</I>&gt;<i>     PythonAuthzHandler authz_1
</I>&gt;<i>     PythonHandler authz_1
</I>&gt;<i>     PythonDebug On
</I>&gt;<i> 
</I>&gt;<i>     AuthType authztest
</I>&gt;<i>     Require authztest::valid-user
</I>&gt;<i> 
</I>&gt;<i> I get:
</I>&gt;<i> 
</I>&gt;<i>     authztest
</I>&gt;<i>     grumpy
</I>&gt;<i>     ['authenhandler', 'authzhandler', 'handler']
</I>&gt;<i> 
</I>&gt;<i> So, no need to have any equivalent to AuthAuthoritative in Apache 2.2.
</I>&gt;<i> 
</I>&gt;<i> In summary, situation seems to be that if you want to perform 
</I>&gt;<i> authorization based
</I>&gt;<i> on group member ship, okay to still use:
</I>&gt;<i> 
</I>&gt;<i>     Require group grumpy
</I>
Woot, Woot, Woot! We have a solution! 10,000 Thank-yous and as much 
virtual beer as you can drink, Graham. It never occurred to me to *not* 
use &quot;Require valid-user&quot;. Any discussion I've seen on 
PythonAuthenHandler indicated the valid-user was *required* to get the 
authenhandler to run.

&gt;<i> But you should not set AuthGroupFile, because if you do then the 
</I>&gt;<i> builting authz handler
</I>&gt;<i> will try and do the interpretation itself.
</I>&gt;<i> 
</I>&gt;<i> If you want equivalents to 'valid-user' or 'user' where your 
</I>&gt;<i> authzhandler interprets them,
</I>&gt;<i> you need to qualify them to avoid builtin authz module interpreting 
</I>&gt;<i> them. Thus use something
</I>&gt;<i> like:
</I>&gt;<i> 
</I>&gt;<i>     Require authztest::valid-user
</I>&gt;<i>     Require authztest::user grumpy
</I>&gt;<i> 
</I>&gt;<i> and the check req.requires for pertinent tags and data.
</I>&gt;<i> 
</I>&gt;<i> Going back to your original configuration:
</I>&gt;<i> 
</I>&gt;<i>     &lt;Directory /srv/projects/aos/html/aos-admin/&gt;
</I>&gt;<i>       DirectoryIndex index.py
</I>&gt;<i> 
</I>&gt;<i> Take note of DirectoryIndex problems recorded in:
</I>&gt;<i> 
</I>&gt;<i>     <A HREF="http://issues.apache.org/jira/browse/MODPYTHON-146">http://issues.apache.org/jira/browse/MODPYTHON-146</A>
</I>&gt;<i> 
</I>&gt;<i> This would be an issue if you are trying to pass data in req through 
</I>&gt;<i> from these handlers
</I>&gt;<i> to content handler. Plus notes and subprocess_env values can get 
</I>&gt;<i> duplicated.
</I>&gt;<i> 
</I>&gt;<i>       AllowOverride None
</I>&gt;<i>       AddHandler mod_python .py
</I>&gt;<i> 
</I>&gt;<i>       AuthType PyCookie
</I>&gt;<i>       AuthName &quot;Restricted&quot;
</I>&gt;<i>       Require valid-user
</I>&gt;<i> 
</I>&gt;<i> If req.user is set, use of 'valid-user' would cause inbuilt authz 
</I>&gt;<i> handler to return
</I>&gt;<i> OK and so your authzhandler would not run. If though req.user hadn't been
</I>&gt;<i> set by authenhandler, you probably get an error occur.
</I>
That is correct, but the error is generated in mod_python.c, 
irrespective of the existence of &quot;Require valid-user&quot;. Looking at that 
code makes me think there is an unreported bug, which may also explain 
some of the confusion over the AuthAuthorative business. More on this below.

&gt;<i>       Require admin
</I>&gt;<i> 
</I>&gt;<i> The &quot;admin&quot; tag is not one known of by Apache. If you were using Apache 2.0
</I>&gt;<i> you would most like be getting:
</I>&gt;<i> 
</I>&gt;<i>     [Sun Apr 23 13:41:06 2006] [error] [client ::1] access to 
</I>&gt;<i> /testing/authz-1/ failed, reason: unknown require directive:&quot;admin&quot;
</I>
This is not a problem as long as Require [valid-user|user|group] is set. 
  An error will not be raised as long as one of those is set. Strings 
set with Require can be retrieved with req.requires().

&gt;<i> Thus, in Apache 2.0, you would need to have AuthAuthoritative set. In 
</I>&gt;<i> Apache 2.2
</I>&gt;<i> you wouldn't need to.
</I>&gt;<i> 
</I>&gt;<i>       PythonAccessHandler mprest.authtest
</I>&gt;<i>       PythonAuthenHandler mprest.authtest
</I>&gt;<i>       PythonAuthzHandler mprest.authtest
</I>&gt;<i>       PythonHandler mprest.authtest
</I>&gt;<i> 
</I>&gt;<i>     &lt;/Directory&gt;
</I>&gt;<i> 
</I>&gt;<i> Now, what was the final configuration you were trying to use and what 
</I>&gt;<i> version of
</I>&gt;<i> Apache were you using?
</I>
Just for the record here is the conf that worked for me with Apache 
2.0.55 and mp 3.3.0-dev (with both new and old module importers). One of 
the directories contains dynamic content, while the other is static 
content. Note the absence of Require valid-user. Require group is 
sufficient to get both PythonAuthenHandler and PythonAuthzHandler to fire.

&lt;Directory /path/to/html/adminonly/&gt;
   AddHandler mod_python .py
   AuthType PyCookie
   AuthName &quot;Restricted - Administrators Only&quot;
   Require group
   Require pygroup admin
   PythonAuthenHandler mprest.auth
   PythonAuthzHandler mprest.auth
   PythonHandler mprest.publisher
&lt;/Directory&gt;

There is no PythonHandler in the next example, as the directory only 
contains static content, but I want to use the same authen/authz 
mechanism to protect this resource.

&lt;Directory /path/to/html/membersonly/&gt;
   AuthType PyCookie
   AuthName &quot;Restricted - Members Only&quot;
   Require group
   Require pygroup member admin
   PythonAuthenHandler mprest.auth
   PythonAuthzHandler mprest.auth
&lt;/Directory&gt;

I'll make some notes to stick in the documentation so some other poor 
sob can avoid the trouble this caused me.

Ultimately however it seems to me there is a bug in mod_python.c related 
to the whole AuthAthoritative business. Consider the following code 
pulled from the python_handler function. (mod_python.c line 1412 
revision 396250):

    if (strcmp(phase, &quot;PythonAuthenHandler&quot;) == 0) {
          ... snip ...

          if (result == HTTP_UNAUTHORIZED)
          {
               if   (! conf-&gt;authoritative)
                     result = DECLINED;


conf-&gt;authoritative is initialized to 1, but we don't have an Apache 
directive to set the value. I wonder if the assumption was that this was 
set by AuthAuthoritative, or if it there was an oversight in not adding 
a new directive? Either way it's a bug. Mod_python should not concern 
itself with AuthAuthoritative, as that is for use by mod_auth, so we 
really need our on directive.

As confirmation I modified python_handler to log conf-&gt;authoritative and 
indeed it's value is unaffected by the AuthAthoritative setting. In it's 
current state, PythonAuthenHander will *always* be authoritative.

Other mod_auth_* modules define their own  authoritative directives, for 
example: AuthDBMAuthoritative, AuthLDAPAuthoritative, 
AuthMySQLAuthoritative and Anonymous_Authoritative. Following the most 
common pattern I would suggest we add AuthPythonAuthoritative.

This issue may also be important to 
<A HREF="http://issues.apache.org/jira/browse/MODPYTHON-129">http://issues.apache.org/jira/browse/MODPYTHON-129</A>

Jim
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020961.html">[mod_python] PythonAuthzHandler not working
</A></li>
	<LI>Next message: <A HREF="020967.html">[mod_python] PythonAuthzHandler not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20966">[ date ]</a>
              <a href="thread.html#20966">[ thread ]</a>
              <a href="subject.html#20966">[ subject ]</a>
              <a href="author.html#20966">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
