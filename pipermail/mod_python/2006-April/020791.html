<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] ValueError with Flash 8 FileReference.upload(url)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20ValueError%20with%20Flash%208%20FileReference.upload%28url%29&In-Reply-To=5B0ECC1928CB6C479A734A6BD6209EF0DDDE23%40exchange.Giant-Steps.local">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020790.html">
   <LINK REL="Next"  HREF="020794.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] ValueError with Flash 8 FileReference.upload(url)</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20ValueError%20with%20Flash%208%20FileReference.upload%28url%29&In-Reply-To=5B0ECC1928CB6C479A734A6BD6209EF0DDDE23%40exchange.Giant-Steps.local"
       TITLE="[mod_python] ValueError with Flash 8 FileReference.upload(url)">grahamd at dscpl.com.au
       </A><BR>
    <I>Wed Apr  5 17:56:36 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020790.html">[mod_python] ValueError with Flash 8 FileReference.upload(url)
</A></li>
        <LI>Next message: <A HREF="020794.html">[mod_python] ValueError with Flash 8 FileReference.upload(url)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20791">[ date ]</a>
              <a href="thread.html#20791">[ thread ]</a>
              <a href="subject.html#20791">[ subject ]</a>
              <a href="author.html#20791">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 06/04/2006, at 2:17 AM, Harold J. Ship wrote:

&gt;<i> Maybe so, but on another platform using cgi it's ok.
</I>
If it isn't formatted per the standards for how multipart forms are
meant to be formatted, that it may be accepted on platform does
not matter as there are no guarantees it will be accepted on
another.

Anyway, to settle this, capture your post data again using that
handler, but change the handler to:

from mod_python import apache
import base64

def handler(req):

     data = open(&quot;/some/path/post.dat&quot;, &quot;wb&quot;)
     data.write(base64.encodestring(req.read()))
     data.close()

     req.content_type = 'text/plain'
     req.write(&quot;Done&quot;)

     return apache.OK

By encoding it as base64 before being sent, we know for sure that
nothing about how it was written to file or dealt with by any mail
software will stuff up CR LF sequences and we can see exactly
what was received.

Graham


&gt;<i> -----Original Message-----
</I>&gt;<i> From: Jim Gallacher
</I>&gt;<i> Sent: Wednesday, April 05, 2006 2:32 PM
</I>&gt;<i> To: Graham Dumpleton
</I>&gt;<i> Cc: Harold J. Ship; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;<i> Subject: Re: [mod_python] ValueError with Flash 8
</I>&gt;<i> FileReference.upload(url)
</I>&gt;<i>
</I>&gt;<i> I don't have time to look at this in any detail right now, but I agree
</I>&gt;<i> that it looks malformed. The last part of post.dat really shoud be:
</I>&gt;<i>
</I>&gt;<i> ------------KM7GI3gL6cH2gL6gL6cH2gL6cH2KM7\r\n
</I>&gt;<i> Content-Disposition: form-data; name=&quot;Upload&quot;\r\n \r\n Submit Query 
</I>&gt;<i> \r\n
</I>&gt;<i> ------------KM7GI3gL6cH2gL6gL6cH2gL6cH2KM7
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> mod_python 3.2.8 should handle embedded \r\n or \r\r sequences in the
</I>&gt;<i> file contents correctly. There is even a unit test for this. ;)
</I>&gt;<i>
</I>&gt;<i> Jim
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Graham Dumpleton wrote:
</I>&gt;&gt;<i> I am coming to the conclusion that the file produced by Flash is
</I>&gt;&gt;<i> malformed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Even if I were to get rid of the double \r\r sequences, replacing
</I>&gt;&gt;<i> them with a single \r, you end up with no blank like after:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   Content-Disposition: form-data; name=&quot;Upload&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> which means that:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   Submit Query
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> gets interpreted as a header and thus why it dies as there is no
</I>&gt;&gt;<i> colon on that line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Anyone got any better ideas?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Bedtime for me now.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Graham
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 05/04/2006, at 9:32 PM, Graham Dumpleton wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 05/04/2006, at 9:28 PM, Harold J. Ship wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Ok, here's the output.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ------------KM7GI3gL6cH2gL6gL6cH2gL6cH2KM7
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Content-Disposition: form-data; name=&quot;Filename&quot;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> sample.txt
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ------------KM7GI3gL6cH2gL6gL6cH2gL6cH2KM7
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Content-Disposition: form-data; name=&quot;Filedata&quot;;
</I>&gt;<i> filename=&quot;sample.txt&quot;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Content-Type: application/octet-stream
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Start of Sample Text File Contents
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> End of Sample Text File Contents
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ------------KM7GI3gL6cH2gL6gL6cH2gL6cH2KM7
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Content-Disposition: form-data; name=&quot;Upload&quot;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Submit Query
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ------------KM7GI3gL6cH2gL6gL6cH2gL6cH2KM7
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm not an expert on FieldStorage as I stayed out of all the
</I>&gt;&gt;&gt;<i> discussions on it when it was being improved. I am also not up on
</I>&gt;&gt;&gt;<i> what the content  type application/x-www-form-urlencoded is all
</I>&gt;&gt;&gt;<i> about. All the same, I'll  share what I found so far in case it  
</I>&gt;&gt;&gt;<i> helps
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> someone else.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> First off, I don't get an error, but I don't believe I get correct
</I>&gt;&gt;&gt;<i> results either.
</I>&gt;&gt;&gt;<i> To test, what I did was create a handler containing:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> from mod_python import apache, util
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> def handler(req):
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     apache.log_error('headers_in=%s'%req.headers_in)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     req.content_type = 'text/plain'
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     form = util.FieldStorage(req)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     for field in form.list:
</I>&gt;&gt;&gt;<i>         apache.log_error('name=%s' % `field.name`)
</I>&gt;&gt;&gt;<i>         apache.log_error('value=%s' % `field.value`)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     req.write('done')
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     return apache.OK
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I then used &quot;ab&quot; to post your file to a URL mapping to that handler.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   ab -p post.dat -T 'multipart/form-data; boundary=----------
</I>&gt;&gt;&gt;<i> KM7GI3gL6cH2gL6gL6cH2gL6cH2KM7^M' <A HREF="http://localhost:8082/testing/">http://localhost:8082/testing/</A>
</I>&gt;&gt;&gt;<i> upload-1/dummy
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Note that that is actually a real \r (CR) where ^M is shown in the
</I>&gt;&gt;&gt;<i> boundary.
</I>&gt;&gt;&gt;<i> Without that it wouldn't work. I am not sure though whether that is
</I>&gt;&gt;&gt;<i> simply due to CR LF weirdness in way file was created and then  
</I>&gt;&gt;&gt;<i> how it
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> is being interpreted by &quot;ab&quot; on Mac OS X when given to it as input.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Anyway, result of that is:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [Wed Apr 05 21:26:24 2006] [error] headers_in={'Content-type':
</I>&gt;&gt;&gt;<i> 'multipart/form-data; boundary=----------
</I>&gt;&gt;&gt;<i> KM7GI3gL6cH2gL6gL6cH2gL6cH2KM7\r', 'Content-length': '498',
</I>&gt;<i> 'Accept':
</I>&gt;&gt;&gt;<i> '*/*', 'Host': 'localhost:8082', 'User-Agent':  'ApacheBench/1.3d'}
</I>&gt;&gt;&gt;<i> [Wed Apr 05 21:26:24 2006] [error] [client 127.0.0.1] PythonHandler
</I>&gt;&gt;&gt;<i> upload: Traceback (most recent call last):
</I>&gt;&gt;&gt;<i> [Wed Apr 05 21:26:24 2006] [error] [client 127.0.0.1] PythonHandler
</I>&gt;&gt;&gt;<i> upload:   File &quot;/System/Library/Frameworks/Python.framework/
</I>&gt;&gt;&gt;<i> Versions/2.3/lib/python2.3/site-packages/mod_python/apache.py&quot;,   
</I>&gt;&gt;&gt;<i> line
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> 308, in HandlerDispatch\n    result = object(req)
</I>&gt;&gt;&gt;<i> [Wed Apr 05 21:26:24 2006] [error] [client 127.0.0.1] PythonHandler
</I>&gt;&gt;&gt;<i> upload:   File &quot;/Users/grahamd/Workspaces/testing/upload-1/
</I>&gt;&gt;&gt;<i> upload.py&quot;, line 9, in handler\n    form = util.FieldStorage(req)
</I>&gt;&gt;&gt;<i> [Wed Apr 05 21:26:24 2006] [error] [client 127.0.0.1] PythonHandler
</I>&gt;&gt;&gt;<i> upload:   File &quot;/System/Library/Frameworks/Python.framework/
</I>&gt;&gt;&gt;<i> Versions/2.3/lib/python2.3/site-packages/mod_python/util.py&quot;, line
</I>&gt;&gt;&gt;<i> 180, in __init__\n    h, v = line.split(&quot;:&quot;, 1)
</I>&gt;&gt;&gt;<i> [Wed Apr 05 21:26:24 2006] [error] [client 127.0.0.1] PythonHandler
</I>&gt;&gt;&gt;<i> upload: ValueError: unpack list of wrong size
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thus, have duplicated it.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Note that this may possibly be something to do with strangeness in
</I>&gt;&gt;&gt;<i> line endings.
</I>&gt;&gt;&gt;<i> First their was the issue above with CR, but there are other   
</I>&gt;&gt;&gt;<i> nasties
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> in input with CR LF. See following &quot;od&quot; dump.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 0000000    -   -   -   -   -   -   -   -   -   -   -   -   K    
</I>&gt;&gt;&gt;<i> M    7
</I>&gt;<i> G
</I>&gt;&gt;&gt;<i> 0000020    I   3   g   L   6   c   H   2   g   L   6   g   L    
</I>&gt;&gt;&gt;<i> 6    c
</I>&gt;<i> H
</I>&gt;&gt;&gt;<i> 0000040    2   g   L   6   c   H   2   K   M   7  \r  \r  \n    
</I>&gt;&gt;&gt;<i> C    o
</I>&gt;<i> n
</I>&gt;&gt;&gt;<i> 0000060    t   e   n   t   -   D   i   s   p   o   s   i   t    
</I>&gt;&gt;&gt;<i> i    o
</I>&gt;<i> n
</I>&gt;&gt;&gt;<i> 0000100    :       f   o   r   m   -   d   a   t   a   ;        
</I>&gt;&gt;&gt;<i> n    a
</I>&gt;<i> m
</I>&gt;&gt;&gt;<i> 0000120    e   =   &quot;   F   i   l   e   n   a   m   e   &quot;  \r   
</I>&gt;&gt;&gt;<i> \r   \n
</I>&gt;<i> \r
</I>&gt;&gt;&gt;<i> 0000140   \r  \n   s   a   m   p   l   e   .   t   x   t  \r   
</I>&gt;&gt;&gt;<i> \r   \n
</I>&gt;<i> -
</I>&gt;&gt;&gt;<i> 0000160    -   -   -   -   -   -   -   -   -   -   -   K   M    
</I>&gt;&gt;&gt;<i> 7    G
</I>&gt;<i> I
</I>&gt;&gt;&gt;<i> 0000200    3   g   L   6   c   H   2   g   L   6   g   L   6    
</I>&gt;&gt;&gt;<i> c    H
</I>&gt;<i> 2
</I>&gt;&gt;&gt;<i> 0000220    g   L   6   c   H   2   K   M   7  \r  \r  \n   C    
</I>&gt;&gt;&gt;<i> o    n
</I>&gt;<i> t
</I>&gt;&gt;&gt;<i> 0000240    e   n   t   -   D   i   s   p   o   s   i   t   i    
</I>&gt;&gt;&gt;<i> o    n
</I>&gt;<i> :
</I>&gt;&gt;&gt;<i> 0000260        f   o   r   m   -   d   a   t   a   ;       n    
</I>&gt;&gt;&gt;<i> a    m
</I>&gt;<i> e
</I>&gt;&gt;&gt;<i> 0000300    =   &quot;   F   i   l   e   d   a   t   a   &quot;   ;        
</I>&gt;&gt;&gt;<i> f    i
</I>&gt;<i> l
</I>&gt;&gt;&gt;<i> 0000320    e   n   a   m   e   =   &quot;   s   a   m   p   l    
</I>&gt;&gt;&gt;<i> e   .    t
</I>&gt;<i> x
</I>&gt;&gt;&gt;<i> 0000340    t   &quot;  \r  \r  \n   C   o   n   t   e   n   t   -    
</I>&gt;&gt;&gt;<i> T    y
</I>&gt;<i> p
</I>&gt;&gt;&gt;<i> 0000360    e   :       a   p   p   l   i   c   a   t   i   o     
</I>&gt;&gt;&gt;<i> n   /
</I>&gt;<i> o
</I>&gt;&gt;&gt;<i> 0000400    c   t   e   t   -   s   t   r   e   a   m  \r  \r   
</I>&gt;&gt;&gt;<i> \n   \r
</I>&gt;<i> \r
</I>&gt;&gt;&gt;<i> 0000420   \n   S   t   a   r   t       o   f       S   a   m    
</I>&gt;&gt;&gt;<i> p    l
</I>&gt;<i> e
</I>&gt;&gt;&gt;<i> 0000440        T   e   x   t       F   i   l   e       C   o    
</I>&gt;&gt;&gt;<i> n    t
</I>&gt;<i> e
</I>&gt;&gt;&gt;<i> 0000460    n   t   s  \r  \r  \n   E   n   d       o   f        
</I>&gt;&gt;&gt;<i> S    a
</I>&gt;<i> m
</I>&gt;&gt;&gt;<i> 0000500    p   l   e       T   e   x   t       F   i   l    
</I>&gt;&gt;&gt;<i> e        C
</I>&gt;<i> o
</I>&gt;&gt;&gt;<i> 0000520    n   t   e   n   t   s  \r  \r  \n  \r  \r  \n   -    
</I>&gt;&gt;&gt;<i> -    -
</I>&gt;<i> -
</I>&gt;&gt;&gt;<i> 0000540    -   -   -   -   -   -   -   -   K   M   7   G   I    
</I>&gt;&gt;&gt;<i> 3    g
</I>&gt;<i> L
</I>&gt;&gt;&gt;<i> 0000560    6   c   H   2   g   L   6   g   L   6   c   H   2    
</I>&gt;&gt;&gt;<i> g    L
</I>&gt;<i> 6
</I>&gt;&gt;&gt;<i> 0000600    c   H   2   K   M   7  \r  \r  \n   C   o   n   t    
</I>&gt;&gt;&gt;<i> e    n
</I>&gt;<i> t
</I>&gt;&gt;&gt;<i> 0000620    -   D   i   s   p   o   s   i   t   i   o    
</I>&gt;&gt;&gt;<i> n   :        f
</I>&gt;<i> o
</I>&gt;&gt;&gt;<i> 0000640    r   m   -   d   a   t   a   ;       n   a   m   e    
</I>&gt;&gt;&gt;<i> =    &quot;
</I>&gt;<i> U
</I>&gt;&gt;&gt;<i> 0000660    p   l   o   a   d   &quot;  \r  \r  \n   S   u   b   m   i   t
</I>&gt;&gt;&gt;<i> 0000700    Q   u   e   r   y  \r  \r  \n   -   -   -   -   -    
</I>&gt;&gt;&gt;<i> -    -
</I>&gt;<i> -
</I>&gt;&gt;&gt;<i> 0000720    -   -   -   -   K   M   7   G   I   3   g   L   6    
</I>&gt;&gt;&gt;<i> c    H
</I>&gt;<i> 2
</I>&gt;&gt;&gt;<i> 0000740    g   L   6   g   L   6   c   H   2   g   L   6   c    
</I>&gt;&gt;&gt;<i> H    2
</I>&gt;<i> K
</I>&gt;&gt;&gt;<i> 0000760    M   7
</I>&gt;&gt;&gt;<i> 0000762
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> See the &quot;\r  \r  \n  \r  \r  \n&quot; sequences.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Not sure that I'll have much more time to play with this  
</I>&gt;&gt;&gt;<i> tonight,  so
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> posting this progress in case someone else wants to pick up and
</I>&gt;&gt;&gt;<i> continue.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020790.html">[mod_python] ValueError with Flash 8 FileReference.upload(url)
</A></li>
	<LI>Next message: <A HREF="020794.html">[mod_python] ValueError with Flash 8 FileReference.upload(url)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20791">[ date ]</a>
              <a href="thread.html#20791">[ thread ]</a>
              <a href="subject.html#20791">[ subject ]</a>
              <a href="author.html#20791">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
