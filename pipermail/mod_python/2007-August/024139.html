<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] stumped by inputfilter infinite repeat
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20stumped%20by%20inputfilter%20infinite%20repeat&In-Reply-To=88e286470708201557u39337615ubed1ab010208192f%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024138.html">
   <LINK REL="Next"  HREF="024140.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] stumped by inputfilter infinite repeat</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Ken Manheimer</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20stumped%20by%20inputfilter%20infinite%20repeat&In-Reply-To=88e286470708201557u39337615ubed1ab010208192f%40mail.gmail.com"
       TITLE="[mod_python] stumped by inputfilter infinite repeat">ken.manheimer at gmail.com
       </A><BR>
    <I>Mon Aug 20 20:19:21 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024138.html">[mod_python] stumped by inputfilter infinite repeat
</A></li>
        <LI>Next message: <A HREF="024140.html">[mod_python] stumped by inputfilter infinite repeat
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24139">[ date ]</a>
              <a href="thread.html#24139">[ thread ]</a>
              <a href="subject.html#24139">[ subject ]</a>
              <a href="author.html#24139">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/20/07, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>&gt; wrote:
&gt;<i> On 21/08/07, Ken Manheimer &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">ken.manheimer at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; On 8/18/07, Graham Dumpleton &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; Which version of mod_python and Apache are you using?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; The Tramline author suspected there existed a problem in mod_python
</I>&gt;<i> &gt; &gt; and/or Apache that caused some issues. They suggest in their
</I>&gt;<i> &gt; &gt; documentation a change that should be made to mod_python, although it
</I>&gt;<i> &gt; &gt; hasn't been done in official releases as it wouldn't seem to be the
</I>&gt;<i> &gt; &gt; correct thing to do. One issue was fixed in filter code in mod_python
</I>&gt;<i> &gt; &gt; in recent versions which may have caused issues, but not the same
</I>&gt;<i> &gt; &gt; change they suggested. They also felt that certain older versions of
</I>&gt;<i> &gt; &gt; Apache may have had some problem.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; For some more details see:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;   <A HREF="https://issues.apache.org/jira/browse/MODPYTHON-76">https://issues.apache.org/jira/browse/MODPYTHON-76</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; thanks much, graham, for your reply.  i did know about the need to
</I>&gt;<i> &gt; inihbit filter.flush() - it's described in the tramline install
</I>&gt;<i> &gt; instructions.  i also factored tramline completely out of the picture,
</I>&gt;<i> &gt; reproducing the behavior using instead some trivial artifical
</I>&gt;<i> &gt; inputfilter and outputfilter functions:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   def inputfilter(filter):
</I>&gt;<i> &gt;       &quot;stub input filter&quot;
</I>&gt;<i> &gt;       filter.req.log_error(&quot;klm input filter&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   def outputfilter(filter):
</I>&gt;<i> &gt;       &quot;stub output filter&quot;
</I>&gt;<i> &gt;       filter.req.log_error(&quot;klm output filter&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; running without pdb enabled but through the rewrite rule i mentioned
</I>&gt;<i> &gt; earlier, to Zope, yields an infinite stream of the &quot;klm input filter&quot;
</I>&gt;<i> &gt; messages, and no &quot;klm output filter&quot; ones.  (the problem does *not*
</I>&gt;<i> &gt; happen when the Zope backend is not running.)
</I>&gt;<i>
</I>&gt;<i> As I would expect, as the input filter is neither consuming the data
</I>&gt;<i> or passing it on. Try something like:
</I>&gt;<i>
</I>&gt;<i> from mod_python import apache
</I>&gt;<i>
</I>&gt;<i> def inputfilter(filter):
</I>&gt;<i>
</I>&gt;<i>     s = filter.read()
</I>&gt;<i>     while s:
</I>&gt;<i>         filter.write(s)
</I>&gt;<i>         s = filter.read()
</I>&gt;<i>
</I>&gt;<i>     if s is None:
</I>&gt;<i>         filter.close()
</I>&gt;<i>
</I>&gt;<i> Similar for output filter.
</I>
hmm!

the lack of any input handling in my routine was really dumb.  but in
any case, this may point to something that gets tramline working.

the tramline input filter is intended to only intervene for main POST
requests that consist of multipart/form-data.  for other requests it
would do a filter.pass_on() and return:

    def inputfilter(filter):
        # we're done if we're in a subrequest
        if filter.req.main is not None:
            filter.pass_on()
            return

        # we only handle POST requests
        if filter.req.method != 'POST':
            filter.pass_on()
            return

        # we only handle multipart/form-data
        enctype = filter.req.headers_in.get('Content-Type')
        if enctype[:19] != 'multipart/form-data':
            filter.pass_on()
            return

        [do some real stuff, otherwise]

i the assume that the filter.pass_on() was supposed to do the right
thing, but i tried that in my stub filters (after confirming that your
filter.read()/filter.write() handling did in fact work, graham), and
it didn't.  so i replaced the above with:

    def inputfilter(filter):

        enctype = filter.req.headers_in.get('Content-Type')
        if ((filter.req.main is not None)   # we are in a subrequest
            or (filter.req.method != 'POST')# this is not a POST
request
            or (enctype[:19] != 'multipart/form-data')): # not
multipart/form-data:
            s = filter.read()
            while s:
                filter.write(s)
                s = filter.read()
            if s is None:
                filter.close()
            return

        [do some real stuff, otherwise]

and i don't get the hang.  i have to test the intended tramline
operation, and don't understand enough yet about it or mod_python
filters to be confident that i have something right, but at least i
have something to work with now!

can you say why the filter.pass_on() is not sufficient, by the way?
even with and added filter.flush() the infinite repeat still happens.

&gt;<i> &gt; i did reread the bug report, and it occurred to me to try the current
</I>&gt;<i> &gt; apache svn version, as the bug report mentions - an off chance,
</I>&gt;<i> &gt; though, since the features of the svn version around the time of the
</I>&gt;<i> &gt; bug report should have seen released by now.  unfortunately, that
</I>&gt;<i> &gt; works worse.  i'm getting a fatal error trying to run the latest svn
</I>&gt;<i> &gt; version with mod_python installed:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; httpd: Syntax error on line 116 of /usr/local/apache2/conf/httpd.conf:
</I>&gt;<i> &gt; Cannot load /usr/local/apache2/modules/mod_python.so into server:
</I>&gt;<i> &gt; /usr/local/apache2/modules/mod_python.so: undefined symbol:
</I>&gt;<i> &gt; ap_requires
</I>&gt;<i> &gt; err 1:  2811  /usr/local/apache2/bin/apachectl configtest
</I>&gt;<i>
</I>&gt;<i> Do you have multiple versions of Apache on your system? This error
</I>&gt;<i> suggest the mod_python source code has been compiled against a
</I>&gt;<i> different version of Apache than you are trying to use it with.
</I>
now that i have something to work with using the current apache
version (which i put back in place from a tarball i created before
trying the install of the svn version), i don't need to resolve the
svn version problems.  still, here are the details:

i do have an older installation, but i'm not running it, and i build
(configure) mod_python with the apxs of the new version.  checked that
a bunch of times, and examined config.status, besides.

  ./configure --with-apxs=/usr/local/apache2/bin/apxs
--with-python=/usr/local/bin/python2.4 --with-max-locks=32

i've been running a version of apache2 out of /usr/local/apache2 for a
few months, though with very light use.  i actually deleted the older
apache2 installation before installing the svn checkout one, to avoid
cross-version contamination.

&gt;<i> &gt; this obstacle on obstacle is discouraging.  a google search reveals no
</I>&gt;<i> &gt; other reports of this particular error, and i have no reason to be
</I>&gt;<i> &gt; confident that getting it working would actually improve the original
</I>&gt;<i> &gt; inputfilter problem.  i plan to inquire on the tramline and plone
</I>&gt;<i> &gt; lists for alternatives.  i am interested to hear insights on this, but
</I>&gt;<i> &gt; think i'm better off pursuing other avenues (there's some alpha plone
</I>&gt;<i> &gt; accommodations for blobs in the zodb), and if that works, giving up on
</I>&gt;<i> &gt; mod_python.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; i did solve one interesting incidental problem along the way, that
</I>&gt;<i> &gt; might be of value to someone else.  when the interminable inputfilter
</I>&gt;<i> &gt; invocation is happening i have to kill apache with a KILL signal (9).
</I>&gt;<i> &gt; doing that lead to mutex leaks, soon leading to apache start failures,
</I>&gt;<i> &gt; with an error_log complaint like this:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [Fri Aug 17 12:00:00 2007] [error] (28)No space left on device:
</I>&gt;<i> &gt; mod_python: Failed to create global mutex 0 of 32 (/tmp/mpmtx125450).
</I>&gt;<i>
</I>&gt;<i> You need to make sure you kill off the zombie Apache parent processes
</I>&gt;<i> as well if any exist. It will only be when they have gone that the
</I>&gt;<i> mutexes will be released.
</I>
i am usually running apache in non-daemon mode, in order to interact
with the pdb session, when this happens:

  /usr/local/apache2/bin/httpd -k start -X -DONE_PROCESS

^C or default kill signal doesn't kill it.  no other httpd processes
exist.  i don't think the problem is due to running in the foreground,
however - i think the server is blocking on some kind of IO.  it
happens whether or not PythonDebugPdb is set, but it doesn't happen
when i do a regular apachectl start - then killing the lead httpd
processes results in an eventual KILL signal from some supervisor.
the mutex leaks don't happen then.

&gt;<i> &gt; investigating, i learned about ipcs to report semaphores and ipcrm to
</I>&gt;<i> &gt; remove them, and created a little script that did the job for me:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ipcs -s | while read key id garbage; do
</I>&gt;<i> &gt;   case &quot;$id&quot; in
</I>&gt;<i> &gt;     [0-9]* ) echo -n &quot;$id &quot;
</I>&gt;<i> &gt;              ipcrm -s $id;;
</I>&gt;<i> &gt;     * ) : ;;
</I>&gt;<i> &gt;   esac
</I>&gt;<i> &gt; done
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; handy.
</I>&gt;<i>
</I>&gt;<i> Hmmm, wont this be dangerous if something is using them. Things other
</I>&gt;<i> than Apache use these things.
</I>
whoops again.  i have an exclusive-use machine, for now, and was
taking that overmuch for granted.

this should be a better focused approach, though still requires
caution, since it will screw over a properly running apache.  (it
removes the mutexes owned by the apache user, which is the one i'm
using.)

trash_mutexes () {
  ipcs -s | while read key id owner garbage; do
    case &quot;$owner&quot; in
      apache ) echo -n &quot;$id &quot;
               ipcrm -s $id;;
      * ) : ;;
    esac
  done
}

the important thing is that i have something to go on with tramline,
even if it's not quite right, yet.  thanks much!

ken

&gt;<i> &gt; also, in case anyone still thinks attention to mod_python and tramline
</I>&gt;<i> &gt; is worthwhile, here are my web server details, from mod_python's
</I>&gt;<i> &gt; mpinfo:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   Apache/2.2.4 (Unix) mod_ssl/2.2.4  OpenSSL/0.9.7a  DAV/2  mod_python/3.3.1
</I>&gt;<i> &gt;   Python/2.4.3
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; and host server os and hardware: linux kernel 2.6.9-42.ELsmp on an AMD
</I>&gt;<i> &gt; Athlon 64 X2
</I>&gt;<i> &gt; Dual Core Processor 4200+.  (it's actually running redhat 4.1, alas.)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; ken
</I>&gt;<i> &gt; <A HREF="http://myriadicity.net">http://myriadicity.net</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; On 19/08/07, Ken Manheimer &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">ken.manheimer at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; &gt; hi, all.  i'm using mod_python with a downloads/uploads handler,
</I>&gt;<i> &gt; &gt; &gt; tramline ( <A HREF="http://infrae.com/products/tramline">http://infrae.com/products/tramline</A> ) with a content
</I>&gt;<i> &gt; &gt; &gt; management system (plone).  when the tramline input and output filters
</I>&gt;<i> &gt; &gt; &gt; are hooked in (using SetInputFilter and SetOutputFilter) and i visit
</I>&gt;<i> &gt; &gt; &gt; the zope/plone site via a redirect, i get infinite repeated calls to
</I>&gt;<i> &gt; &gt; &gt; the input filter.  (i can observe the this by setting PythonEnablePdb
</I>&gt;<i> &gt; &gt; &gt; - from the perspective of the web browser, no page is returned.)  i
</I>&gt;<i> &gt; &gt; &gt; can provide more details, and realize that this may be a tramline
</I>&gt;<i> &gt; &gt; &gt; problem, but it seems like a behavior that might be familiar to
</I>&gt;<i> &gt; &gt; &gt; mod_python experts, so i thought i'd run it by you all first.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; things like mpinfo and mptest.py work fine.  visiting the regular,
</I>&gt;<i> &gt; &gt; &gt; file-based mockup site yields no problems - only the embedded zope
</I>&gt;<i> &gt; &gt; &gt; site, via a rewrite rule:
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;   RewriteRule ^/testbed(.*)
</I>&gt;<i> &gt; &gt; &gt; <A HREF="http://127.0.0.1:8080/VirtualHostBase/http/%{HTTP_HOST}:80/VirtualHostRoot/_vh_testbed/$1">http://127.0.0.1:8080/VirtualHostBase/http/%{HTTP_HOST}:80/VirtualHostRoot/_vh_testbed/$1</A>
</I>&gt;<i> &gt; &gt; &gt; [L,P]
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; (the elaborate VirtualHostRoot stuff is for a zope virtual hosting provision.)
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; does any of this sound familiar to anyone?  suggestions about
</I>&gt;<i> &gt; &gt; &gt; debugging it?  (stepping through the input and output filters using
</I>&gt;<i> &gt; &gt; &gt; PythonEnablePdb yields little or no illumination - they just keep
</I>&gt;<i> &gt; &gt; &gt; getting invoked.  i don't know what to look for tracing added to
</I>&gt;<i> &gt; &gt; &gt; importer.py FilterDispatch, which i tried instead of using
</I>&gt;<i> &gt; &gt; &gt; PythonEnablePdb.)
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; any help would be appreciated!
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024138.html">[mod_python] stumped by inputfilter infinite repeat
</A></li>
	<LI>Next message: <A HREF="024140.html">[mod_python] stumped by inputfilter infinite repeat
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24139">[ date ]</a>
              <a href="thread.html#24139">[ thread ]</a>
              <a href="subject.html#24139">[ subject ]</a>
              <a href="author.html#24139">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
