<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Session class or Memcache to reduce load?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20class%20or%20Memcache%20to%20reduce%20load%3F&In-Reply-To=003e01c7d8c5%24f0f14890%24d2d3d9b0%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024113.html">
   <LINK REL="Next"  HREF="024115.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Session class or Memcache to reduce load?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Mike Looijmans</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20class%20or%20Memcache%20to%20reduce%20load%3F&In-Reply-To=003e01c7d8c5%24f0f14890%24d2d3d9b0%24%40com"
       TITLE="[mod_python] Session class or Memcache to reduce load?">nlv11281 at natlab.research.philips.com
       </A><BR>
    <I>Tue Aug  7 05:07:43 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024113.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
        <LI>Next message: <A HREF="024115.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24114">[ date ]</a>
              <a href="thread.html#24114">[ thread ]</a>
              <a href="subject.html#24114">[ subject ]</a>
              <a href="author.html#24114">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Instead of trying to &quot;fix&quot; apache and creating yet more workarounds for other workarounds, work 
together with the client's browser.

The last-modified header should be derived from your database data, not from the thumbnail file. 
 From your description, i understand that the thumbnails never change, but the database does change 
parameters for a thumbnail. (even if thumbnails do change, just change the filename when updating it 
instead of simply replacing the contents to enforce that thumbnail files never change)

Store a last-modified date/time in the DB for the particular item. Then, when a request comes in 
from the client:
- Get the associated last-modified date from the database.
- Get the &quot;if-modified-since&quot; header that the client sent.
- If the date matches, just send back a &quot;304 Not Modified&quot; response. You're done.
- Otherwise, send the image data and be sure to add the Last-Modified header you got from the DB.

This will allow the data to be cached on the client's machine, which is much more efficient. It will 
also allow you to change to another image (with the same URL) without the need of a &quot;purge&quot; function.

Don't try to cache the file contents. The OS will probably do a better job at that. (For example, 
MySQL relies completely on the OS for any file caching and only caches index data)

Note that if you know in advance that the thumbnail will not change for some time, you can add an 
&quot;Expires&quot; header to the outgoing data. This will cause the client not to request an update until 
that date arrives (and you can still use the last-modified system in that case).


Mike Looijmans
Philips Natlab / Topic Automation


Alec Matusis wrote:
&gt;<i> Hi Colin, thanks for the tip.
</I>&gt;<i> 
</I>&gt;<i> I converted to req.sendfile, and then we run into issues with browser
</I>&gt;<i> caching of these thumbnail images.
</I>&gt;<i> 
</I>&gt;<i> When I use req.sendfile, is there a way to retrieve the last modification
</I>&gt;<i> time of the image file automatically (without using os.stat(image_path)) and
</I>&gt;<i> send it to the client in Last-Modified header?
</I>&gt;<i> 
</I>&gt;<i> It looks like I would have to do this additional os.stat(image_path) per
</I>&gt;<i> thumbnail retrieval to make correct use of If-Modified-Since client header
</I>&gt;<i> to keep the browser cache current.
</I>&gt;<i> 
</I>&gt;<i> Alec.
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Colin Bean [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">ccbean at gmail.com</A>]
</I>&gt;&gt;<i> Sent: Monday, August 06, 2007 2:45 PM
</I>&gt;&gt;<i> To: Alec Matusis
</I>&gt;&gt;<i> Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;&gt;<i> Subject: Re: [mod_python] Session class or Memcache to reduce load?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hey Alec,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For starters, you should use req.sendfile instead of manually reading
</I>&gt;&gt;<i> / sending the file in Python.
</I>&gt;&gt;<i> I believe you'd still have to set the content type manually, so you'd
</I>&gt;&gt;<i> still have to determine that.  This looks like it would be an easy
</I>&gt;&gt;<i> change to implement, and hopefully will help your performance
</I>&gt;&gt;<i> immediately.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Graham described a potentially faster method here (with the warning
</I>&gt;&gt;<i> that it's &quot;slightly theoretical&quot; -- I've not tried it, but reading the
</I>&gt;&gt;<i> thread might be helpful)
</I>&gt;&gt;<i> <A HREF="http://www.modpython.org/pipermail/mod_python/2007-July/024061.html">http://www.modpython.org/pipermail/mod_python/2007-July/024061.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -Colin
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 8/6/07, Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at matusis.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;&gt;<i> From: Graham Dumpleton [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>]
</I>&gt;&gt;&gt;&gt;<i> Sent: Monday, August 06, 2007 2:25 AM
</I>&gt;&gt;&gt;&gt;&gt;<i> Hello, I am sorry if my question is too basic. I would like to
</I>&gt;&gt;<i> reduce
</I>&gt;&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;&gt;&gt;<i> load on apache 2.0 (on 2.6.9 linux) that is running with prefork
</I>&gt;&gt;<i> MPM.
</I>&gt;&gt;&gt;&gt;&gt;<i> There are two main things that are causing the load:
</I>&gt;&gt;&gt;&gt;<i> How do you know that these two things are causing the load?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Because all this apache server (this physical machine) does is
</I>&gt;&gt;<i> serving
</I>&gt;&gt;&gt;<i> thumbnails.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> a) Thumbnail images that are requested repeatedly
</I>&gt;&gt;&gt;&gt;<i> Are you serving up the thumbnails from Python code dynamically or
</I>&gt;&gt;&gt;&gt;<i> allowing Apache to serve them up form a static file?
</I>&gt;&gt;&gt;<i> Dynamically.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> b) A simple DB query is necessary to locate an image file after
</I>&gt;&gt;<i> the
</I>&gt;&gt;&gt;&gt;<i> request.
</I>&gt;&gt;&gt;&gt;&gt;<i> The result of the query does not change. DB is located on another
</I>&gt;&gt;&gt;&gt;<i> machine.
</I>&gt;&gt;&gt;&gt;&gt;<i> My first question, do we need to cache \thumbnail images at all,
</I>&gt;&gt;<i> or
</I>&gt;&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;&gt;&gt;<i> file-caching by the OS is sufficient?
</I>&gt;&gt;&gt;&gt;<i> OS file caching probably will not make much difference. Where one
</I>&gt;&gt;<i> can
</I>&gt;&gt;&gt;&gt;<i> waste a lot of cycles though is by using Python code to serve up
</I>&gt;&gt;<i> the
</I>&gt;&gt;&gt;&gt;<i> images. Thus, if Python is involved in serving up the images, how
</I>&gt;&gt;<i> is
</I>&gt;&gt;&gt;&gt;<i> it being done?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The URI in the client's request contains an image code. Python
</I>&gt;&gt;<i> queries the
</I>&gt;&gt;&gt;<i> DB (on a separate machine) to convert the URI into the image file
</I>&gt;&gt;<i> location,
</I>&gt;&gt;&gt;<i> and then uses
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         f =  open(file_path)
</I>&gt;&gt;&gt;<i>         im_data = f.read()
</I>&gt;&gt;&gt;<i>         f.close()
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> then it determines image type using PIL
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>           im = Image.open(file_path)
</I>&gt;&gt;&gt;<i>           im_type = im.format.lower()
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> (Image.open() is a lazy operation in PIL, so I think it does not have
</I>&gt;&gt;<i> to do
</I>&gt;&gt;&gt;<i> much to determine the image format)
</I>&gt;&gt;&gt;<i> Then python writes the data to the client
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         self.req.content_type = 'image/' + im_type
</I>&gt;&gt;&gt;<i>         self.req.headers_out['Content-Length'] = str(len(im_data))
</I>&gt;&gt;&gt;<i>         self.dict['bin_data'] = im_data
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Second question, to cache the results of the query, should we use
</I>&gt;&gt;&gt;&gt;&gt;<i> mod_python's Session class ( wich will use DbmSession since we
</I>&gt;&gt;<i> are
</I>&gt;&gt;&gt;&gt;<i> using
</I>&gt;&gt;&gt;&gt;&gt;<i> prefork MPM), or memcache?
</I>&gt;&gt;&gt;&gt;<i> Traditionally people use memcached for this.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Why? For performance reasons?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> For certain reasons in the application logic we cannot use
</I>&gt;&gt;<i> apache's
</I>&gt;&gt;&gt;&gt;&gt;<i> mod_cache.
</I>&gt;&gt;&gt;&gt;<i> What reasons?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Because sometimes the images are dynamically banned (flagged) by
</I>&gt;&gt;<i> users, and
</I>&gt;&gt;&gt;<i> in that case we need to render a special image. The DB query that we
</I>&gt;&gt;<i> use
</I>&gt;&gt;&gt;<i> gives None for the image file path when it's banned. So when the
</I>&gt;&gt;<i> image
</I>&gt;&gt;&gt;<i> status changes, we will need to dynamically purge the file path of
</I>&gt;&gt;<i> the image
</I>&gt;&gt;&gt;<i> that is be cached.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Graham
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Mod_python mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024113.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
	<LI>Next message: <A HREF="024115.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24114">[ date ]</a>
              <a href="thread.html#24114">[ thread ]</a>
              <a href="subject.html#24114">[ subject ]</a>
              <a href="author.html#24114">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
