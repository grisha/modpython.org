<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Session class or Memcache to reduce load?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20class%20or%20Memcache%20to%20reduce%20load%3F&In-Reply-To=88e286470708060225v37e8a162pfeab4169fce432f1%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024106.html">
   <LINK REL="Next"  HREF="024111.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Session class or Memcache to reduce load?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Alec Matusis</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20class%20or%20Memcache%20to%20reduce%20load%3F&In-Reply-To=88e286470708060225v37e8a162pfeab4169fce432f1%40mail.gmail.com"
       TITLE="[mod_python] Session class or Memcache to reduce load?">matusis at matusis.com
       </A><BR>
    <I>Mon Aug  6 16:53:09 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024106.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
        <LI>Next message: <A HREF="024111.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24110">[ date ]</a>
              <a href="thread.html#24110">[ thread ]</a>
              <a href="subject.html#24110">[ subject ]</a>
              <a href="author.html#24110">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

&gt;<i> -----Original Message-----
</I>&gt;<i> From: Graham Dumpleton [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>]
</I>&gt;<i> Sent: Monday, August 06, 2007 2:25 AM
</I>&gt;<i> &gt; Hello, I am sorry if my question is too basic. I would like to reduce
</I>&gt;<i> the
</I>&gt;<i> &gt; load on apache 2.0 (on 2.6.9 linux) that is running with prefork MPM.
</I>&gt;<i> &gt; There are two main things that are causing the load:
</I>&gt;<i> 
</I>&gt;<i> How do you know that these two things are causing the load?
</I>&gt;<i> 
</I>
Because all this apache server (this physical machine) does is serving
thumbnails. 

&gt;<i> &gt; a) Thumbnail images that are requested repeatedly
</I>&gt;<i> 
</I>&gt;<i> Are you serving up the thumbnails from Python code dynamically or
</I>&gt;<i> allowing Apache to serve them up form a static file?
</I>
Dynamically.
 
&gt;<i> 
</I>&gt;<i> &gt; b) A simple DB query is necessary to locate an image file after the
</I>&gt;<i> request.
</I>&gt;<i> &gt; The result of the query does not change. DB is located on another
</I>&gt;<i> machine.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My first question, do we need to cache \thumbnail images at all, or
</I>&gt;<i> the
</I>&gt;<i> &gt; file-caching by the OS is sufficient?
</I>&gt;<i> 
</I>&gt;<i> OS file caching probably will not make much difference. Where one can
</I>&gt;<i> waste a lot of cycles though is by using Python code to serve up the
</I>&gt;<i> images. Thus, if Python is involved in serving up the images, how is
</I>&gt;<i> it being done?
</I>&gt;<i> 
</I>
The URI in the client's request contains an image code. Python queries the
DB (on a separate machine) to convert the URI into the image file location,
and then uses 

        f =  open(file_path)
        im_data = f.read()
        f.close()

then it determines image type using PIL

	  im = Image.open(file_path)
	  im_type = im.format.lower()

(Image.open() is a lazy operation in PIL, so I think it does not have to do
much to determine the image format)
Then python writes the data to the client

        self.req.content_type = 'image/' + im_type
        self.req.headers_out['Content-Length'] = str(len(im_data))
        self.dict['bin_data'] = im_data

 
&gt;<i> &gt; Second question, to cache the results of the query, should we use
</I>&gt;<i> &gt; mod_python's Session class ( wich will use DbmSession since we are
</I>&gt;<i> using
</I>&gt;<i> &gt; prefork MPM), or memcache?
</I>&gt;<i> 
</I>&gt;<i> Traditionally people use memcached for this.
</I>&gt;<i> 
</I>Why? For performance reasons?

&gt;<i> &gt; For certain reasons in the application logic we cannot use apache's
</I>&gt;<i> &gt; mod_cache.
</I>&gt;<i> What reasons?
</I>&gt;<i> 
</I>
Because sometimes the images are dynamically banned (flagged) by users, and
in that case we need to render a special image. The DB query that we use
gives None for the image file path when it's banned. So when the image
status changes, we will need to dynamically purge the file path of the image
that is be cached.  

&gt;<i> Graham
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024106.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
	<LI>Next message: <A HREF="024111.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24110">[ date ]</a>
              <a href="thread.html#24110">[ thread ]</a>
              <a href="subject.html#24110">[ subject ]</a>
              <a href="author.html#24110">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
