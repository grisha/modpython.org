<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Session class or Memcache to reduce load?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20class%20or%20Memcache%20to%20reduce%20load%3F&In-Reply-To=46B9D957.7090605%40jgassociates.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024115.html">
   <LINK REL="Next"  HREF="024120.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Session class or Memcache to reduce load?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Alec Matusis</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20class%20or%20Memcache%20to%20reduce%20load%3F&In-Reply-To=46B9D957.7090605%40jgassociates.ca"
       TITLE="[mod_python] Session class or Memcache to reduce load?">matusis at matusis.com
       </A><BR>
    <I>Wed Aug  8 16:58:56 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024115.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
        <LI>Next message: <A HREF="024120.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24119">[ date ]</a>
              <a href="thread.html#24119">[ thread ]</a>
              <a href="subject.html#24119">[ subject ]</a>
              <a href="author.html#24119">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks everybody for responding.
I implemented 
&gt;<i> For starters, you should use req.sendfile instead of manually reading
</I>&gt;<i> / sending the file in Python.
</I>
This reduced load average from 13.0 to 10.0

&gt;<i> Using DbmSession may actually increase your load for a couple of
</I>&gt;<i> reasons. For starters access to the database is serialized by a global
</I>&gt;<i> lock which may be a bottleneck.
</I>
In this regard, I have another question: should each request open it's own
MySQL connection (the connection to our DB slave servers), or only one
connection should be opened, and passed around between requests using
DbmSession or some other means?

&gt;<i> -----Original Message-----
</I>&gt;<i> From: Jim Gallacher [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">jpg at jgassociates.ca</A>]
</I>&gt;<i> Sent: Wednesday, August 08, 2007 7:55 AM
</I>&gt;<i> To: Alec Matusis
</I>&gt;<i> Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;<i> Subject: Re: [mod_python] Session class or Memcache to reduce load?
</I>&gt;<i> 
</I>&gt;<i> Other folks have already replied with good advice, but I want to add a
</I>&gt;<i> few comments on session handling.
</I>&gt;<i> 
</I>&gt;<i> Alec Matusis wrote:
</I>&gt;<i> &gt; Hello, I am sorry if my question is too basic. I would like to reduce
</I>&gt;<i> the
</I>&gt;<i> &gt; load on apache 2.0 (on 2.6.9 linux) that is running with prefork MPM.
</I>&gt;<i> &gt; There are two main things that are causing the load:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; a) Thumbnail images that are requested repeatedly
</I>&gt;<i> &gt; b) A simple DB query is necessary to locate an image file after the
</I>&gt;<i> request.
</I>&gt;<i> &gt; The result of the query does not change. DB is located on another
</I>&gt;<i> machine.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My first question, do we need to cache \thumbnail images at all, or
</I>&gt;<i> the
</I>&gt;<i> &gt; file-caching by the OS is sufficient?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Second question, to cache the results of the query, should we use
</I>&gt;<i> &gt; mod_python's Session class ( wich will use DbmSession since we are
</I>&gt;<i> using
</I>&gt;<i> &gt; prefork MPM), or memcache?
</I>&gt;<i> 
</I>&gt;<i> Using DbmSession may actually increase your load for a couple of
</I>&gt;<i> reasons. For starters access to the database is serialized by a global
</I>&gt;<i> lock which may be a bottleneck.
</I>&gt;<i> 
</I>&gt;<i> More seriously, a cleanup of expired sessions is performed after
</I>&gt;<i> approximately 1000 requests per child. During this cleanup the db will
</I>&gt;<i> also be locked. If you have a really large number of  sessions (greater
</I>&gt;<i> than 10,000 for example) the time required for the cleanup will not be
</I>&gt;<i> trivial and the rate at which requests are served may drop
</I>&gt;<i> significantly. I did some benchmarking on this and saw the rate at
</I>&gt;<i> which
</I>&gt;<i> requests were served drop by 90% in some circumstances (IIRC). If
</I>&gt;<i> you're
</I>&gt;<i> really interested you can look in the mail archives on the developer's
</I>&gt;<i> list.
</I>&gt;<i> 
</I>&gt;<i> This cleanup side effect was something I noticed when developing the
</I>&gt;<i> FileSession class (introduced in 3.2.7). FileSession has a couple of
</I>&gt;<i> features that avoid the cleanup problems. DbmSession can't be fixed due
</I>&gt;<i> to some limitations of dbm.
</I>&gt;<i> 
</I>&gt;<i> If you decide you do need to use sessions make sure you run some
</I>&gt;<i> benchmarks first. If you see a problem then either use FileSession or
</I>&gt;<i> create a backend for a proper relational database where the cleanup can
</I>&gt;<i> be extremely fast.
</I>&gt;<i> 
</I>&gt;<i> Jim
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024115.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
	<LI>Next message: <A HREF="024120.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24119">[ date ]</a>
              <a href="thread.html#24119">[ thread ]</a>
              <a href="subject.html#24119">[ subject ]</a>
              <a href="author.html#24119">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
