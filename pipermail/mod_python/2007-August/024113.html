<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Session class or Memcache to reduce load?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20class%20or%20Memcache%20to%20reduce%20load%3F&In-Reply-To=003e01c7d8c5%24f0f14890%24d2d3d9b0%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024112.html">
   <LINK REL="Next"  HREF="024114.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Session class or Memcache to reduce load?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Graham Dumpleton</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Session%20class%20or%20Memcache%20to%20reduce%20load%3F&In-Reply-To=003e01c7d8c5%24f0f14890%24d2d3d9b0%24%40com"
       TITLE="[mod_python] Session class or Memcache to reduce load?">graham.dumpleton at gmail.com
       </A><BR>
    <I>Tue Aug  7 04:42:12 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024112.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
        <LI>Next message: <A HREF="024114.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24113">[ date ]</a>
              <a href="thread.html#24113">[ thread ]</a>
              <a href="subject.html#24113">[ subject ]</a>
              <a href="author.html#24113">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/08/07, Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at matusis.com</A>&gt; wrote:
&gt;<i> Hi Colin, thanks for the tip.
</I>&gt;<i>
</I>&gt;<i> I converted to req.sendfile, and then we run into issues with browser
</I>&gt;<i> caching of these thumbnail images.
</I>
The problem may be that if you URL actually matches to a physical file
which is the handler, then Apache may be using attributes of that
handler file in response headers.

If you are having issues with caching occurring when you don't want it
to happen, set:

  req.no_cache = 1

This should cause Apache to set appropriate headers to prevent caching
by intermediaries or browser.

&gt;<i> When I use req.sendfile, is there a way to retrieve the last modification
</I>&gt;<i> time of the image file automatically (without using os.stat(image_path))
</I>
No way of avoiding the stat() call when using req.sendfile().

&gt;<i> and
</I>&gt;<i> send it to the client in Last-Modified header?
</I>
In preference to setting header directly, see req.update_mtime() and
req.set_last_modified(). Also look at req.meets_conditions() in case
it is useful. These methods just reflect Apache API versions, ie.,
ap_update_mtime(), ap_set_last_modified() and ap_meets_condition(), so
you may have to try and find some documentation on Apache itself to
work out how to use them though, as mod_python documentation is pretty
sparse in that respect. All the same, make sure you look through:

  <A HREF="http://www.modpython.org/live/current/doc-html/pyapi-mprequest.html">http://www.modpython.org/live/current/doc-html/pyapi-mprequest.html</A>

&gt;<i> It looks like I would have to do this additional os.stat(image_path) per
</I>&gt;<i> thumbnail retrieval to make correct use of If-Modified-Since client header
</I>&gt;<i> to keep the browser cache current.
</I>
The past mailing list post that was referenced in respect of setting
req.filename, req.finfo and return apache.DECLINED, should allow
Apache to do a lot of this stuff for you. So perhaps give it a try and
see what it does.

Graham

&gt;<i> &gt; -----Original Message-----
</I>&gt;<i> &gt; From: Colin Bean [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">ccbean at gmail.com</A>]
</I>&gt;<i> &gt; Sent: Monday, August 06, 2007 2:45 PM
</I>&gt;<i> &gt; To: Alec Matusis
</I>&gt;<i> &gt; Cc: <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">mod_python at modpython.org</A>
</I>&gt;<i> &gt; Subject: Re: [mod_python] Session class or Memcache to reduce load?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hey Alec,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; For starters, you should use req.sendfile instead of manually reading
</I>&gt;<i> &gt; / sending the file in Python.
</I>&gt;<i> &gt; I believe you'd still have to set the content type manually, so you'd
</I>&gt;<i> &gt; still have to determine that.  This looks like it would be an easy
</I>&gt;<i> &gt; change to implement, and hopefully will help your performance
</I>&gt;<i> &gt; immediately.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Graham described a potentially faster method here (with the warning
</I>&gt;<i> &gt; that it's &quot;slightly theoretical&quot; -- I've not tried it, but reading the
</I>&gt;<i> &gt; thread might be helpful)
</I>&gt;<i> &gt; <A HREF="http://www.modpython.org/pipermail/mod_python/2007-July/024061.html">http://www.modpython.org/pipermail/mod_python/2007-July/024061.html</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -Colin
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 8/6/07, Alec Matusis &lt;<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">matusis at matusis.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; -----Original Message-----
</I>&gt;<i> &gt; &gt; &gt; From: Graham Dumpleton [mailto:<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">graham.dumpleton at gmail.com</A>]
</I>&gt;<i> &gt; &gt; &gt; Sent: Monday, August 06, 2007 2:25 AM
</I>&gt;<i> &gt; &gt; &gt; &gt; Hello, I am sorry if my question is too basic. I would like to
</I>&gt;<i> &gt; reduce
</I>&gt;<i> &gt; &gt; &gt; the
</I>&gt;<i> &gt; &gt; &gt; &gt; load on apache 2.0 (on 2.6.9 linux) that is running with prefork
</I>&gt;<i> &gt; MPM.
</I>&gt;<i> &gt; &gt; &gt; &gt; There are two main things that are causing the load:
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; How do you know that these two things are causing the load?
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Because all this apache server (this physical machine) does is
</I>&gt;<i> &gt; serving
</I>&gt;<i> &gt; &gt; thumbnails.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; a) Thumbnail images that are requested repeatedly
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Are you serving up the thumbnails from Python code dynamically or
</I>&gt;<i> &gt; &gt; &gt; allowing Apache to serve them up form a static file?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Dynamically.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; b) A simple DB query is necessary to locate an image file after
</I>&gt;<i> &gt; the
</I>&gt;<i> &gt; &gt; &gt; request.
</I>&gt;<i> &gt; &gt; &gt; &gt; The result of the query does not change. DB is located on another
</I>&gt;<i> &gt; &gt; &gt; machine.
</I>&gt;<i> &gt; &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; My first question, do we need to cache \thumbnail images at all,
</I>&gt;<i> &gt; or
</I>&gt;<i> &gt; &gt; &gt; the
</I>&gt;<i> &gt; &gt; &gt; &gt; file-caching by the OS is sufficient?
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; OS file caching probably will not make much difference. Where one
</I>&gt;<i> &gt; can
</I>&gt;<i> &gt; &gt; &gt; waste a lot of cycles though is by using Python code to serve up
</I>&gt;<i> &gt; the
</I>&gt;<i> &gt; &gt; &gt; images. Thus, if Python is involved in serving up the images, how
</I>&gt;<i> &gt; is
</I>&gt;<i> &gt; &gt; &gt; it being done?
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; The URI in the client's request contains an image code. Python
</I>&gt;<i> &gt; queries the
</I>&gt;<i> &gt; &gt; DB (on a separate machine) to convert the URI into the image file
</I>&gt;<i> &gt; location,
</I>&gt;<i> &gt; &gt; and then uses
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;         f =  open(file_path)
</I>&gt;<i> &gt; &gt;         im_data = f.read()
</I>&gt;<i> &gt; &gt;         f.close()
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; then it determines image type using PIL
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;           im = Image.open(file_path)
</I>&gt;<i> &gt; &gt;           im_type = im.format.lower()
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; (Image.open() is a lazy operation in PIL, so I think it does not have
</I>&gt;<i> &gt; to do
</I>&gt;<i> &gt; &gt; much to determine the image format)
</I>&gt;<i> &gt; &gt; Then python writes the data to the client
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;         self.req.content_type = 'image/' + im_type
</I>&gt;<i> &gt; &gt;         self.req.headers_out['Content-Length'] = str(len(im_data))
</I>&gt;<i> &gt; &gt;         self.dict['bin_data'] = im_data
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; Second question, to cache the results of the query, should we use
</I>&gt;<i> &gt; &gt; &gt; &gt; mod_python's Session class ( wich will use DbmSession since we
</I>&gt;<i> &gt; are
</I>&gt;<i> &gt; &gt; &gt; using
</I>&gt;<i> &gt; &gt; &gt; &gt; prefork MPM), or memcache?
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Traditionally people use memcached for this.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; Why? For performance reasons?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; &gt; For certain reasons in the application logic we cannot use
</I>&gt;<i> &gt; apache's
</I>&gt;<i> &gt; &gt; &gt; &gt; mod_cache.
</I>&gt;<i> &gt; &gt; &gt; What reasons?
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Because sometimes the images are dynamically banned (flagged) by
</I>&gt;<i> &gt; users, and
</I>&gt;<i> &gt; &gt; in that case we need to render a special image. The DB query that we
</I>&gt;<i> &gt; use
</I>&gt;<i> &gt; &gt; gives None for the image file path when it's banned. So when the
</I>&gt;<i> &gt; image
</I>&gt;<i> &gt; &gt; status changes, we will need to dynamically purge the file path of
</I>&gt;<i> &gt; the image
</I>&gt;<i> &gt; &gt; that is be cached.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Graham
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; Mod_python mailing list
</I>&gt;<i> &gt; &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> &gt; &gt; <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024112.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
	<LI>Next message: <A HREF="024114.html">[mod_python] Session class or Memcache to reduce load?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24113">[ date ]</a>
              <a href="thread.html#24113">[ thread ]</a>
              <a href="subject.html#24113">[ subject ]</a>
              <a href="author.html#24113">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
