<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Request sendfile question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Request%20sendfile%20question&In-Reply-To=Pine.LNX.4.64.0603241213590.11098%40wolf.ebi.ac.uk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020641.html">
   <LINK REL="Next"  HREF="020643.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Request sendfile question</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jim Gallacher</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Request%20sendfile%20question&In-Reply-To=Pine.LNX.4.64.0603241213590.11098%40wolf.ebi.ac.uk"
       TITLE="[mod_python] Request sendfile question">jpg at jgassociates.ca
       </A><BR>
    <I>Fri Mar 24 08:34:23 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020641.html">[mod_python] Request sendfile question
</A></li>
        <LI>Next message: <A HREF="020643.html">[mod_python] Request sendfile question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20642">[ date ]</a>
              <a href="thread.html#20642">[ thread ]</a>
              <a href="subject.html#20642">[ subject ]</a>
              <a href="author.html#20642">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ville Silventoinen wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> is there a way to send a file using a file handle?
</I>&gt;<i> 
</I>&gt;<i> I've got a file archive, which stores files in gzip format. When a 
</I>&gt;<i> client downloads the file, I'd like to send the file uncompressed, 
</I>&gt;<i> without creating a temporary file.
</I>&gt;<i> 
</I>&gt;<i> I'm sending the file like this (bit simplified):
</I>&gt;<i> 
</I>&gt;<i>     req.filename = fname
</I>&gt;<i>     req.content_type = ctype
</I>&gt;<i>     req.set_content_length = flen
</I>                             ^^^^^^^^

I assume this is a typo but just in case it's not, 
req.set_content_length is a method, not an attribute.


&gt;<i>     fh = gzip.GzipFile(fpath, 'rb', 9)
</I>&gt;<i>     block_size = 1024
</I>&gt;<i>     while 1:
</I>&gt;<i>         data = fh.read(block_size)
</I>&gt;<i>         if not data:
</I>&gt;<i>             break
</I>&gt;<i>         req.write(data)
</I>&gt;<i>     fh.close()
</I>&gt;<i> 
</I>&gt;<i>     return apache.OK
</I>&gt;<i> 
</I>&gt;<i> I've tested this with different files, it seems to work ok. I was 
</I>&gt;<i> looking at the requestobject.c. Would it be easy to implement something 
</I>&gt;<i> like req_sendfh in addition to req_sendfile?
</I>
It is probably possible to implement such a thing, but it wouldn't work 
for your use case.

In your example you have a GzipFile instance, which is a *file-like* 
object. This object wraps the real file object and provides the &quot;zippy&quot; 
behaviour. The real file handle is not exposed, and would be useless 
even if it was available since reading from it would just give you the 
compressed stream. (Correctly speaking you could use 
fh.fileobj.fileno(), but it really is not meant to be used directly). If 
you take look at gzip.py in the python lib I think you'll see what I mean.

So in short, your current solution is the correct one.


Jim
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020641.html">[mod_python] Request sendfile question
</A></li>
	<LI>Next message: <A HREF="020643.html">[mod_python] Request sendfile question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20642">[ date ]</a>
              <a href="thread.html#20642">[ thread ]</a>
              <a href="subject.html#20642">[ subject ]</a>
              <a href="author.html#20642">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
