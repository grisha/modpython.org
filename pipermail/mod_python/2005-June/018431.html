<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] req.sendfile() questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20req.sendfile%28%29%20questions&In-Reply-To=1119275952.24491.95.camel%40cm61-18-245-172.hkcable.com.hk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018429.html">
   <LINK REL="Next"  HREF="018452.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] req.sendfile() questions</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jim Gallacher</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20req.sendfile%28%29%20questions&In-Reply-To=1119275952.24491.95.camel%40cm61-18-245-172.hkcable.com.hk"
       TITLE="[mod_python] req.sendfile() questions">jg.lists at sympatico.ca
       </A><BR>
    <I>Mon Jun 20 11:43:34 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="018429.html">[mod_python] req.sendfile() questions
</A></li>
        <LI>Next message: <A HREF="018452.html">[mod_python] req.sendfile() questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18431">[ date ]</a>
              <a href="thread.html#18431">[ thread ]</a>
              <a href="subject.html#18431">[ subject ]</a>
              <a href="author.html#18431">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Wouter van Marle wrote:
&gt;<i> On Mon, 2005-06-20 at 08:37 -0400, Jim Gallacher wrote:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i>I'm looking into a way of sending out specific files, and detect whether
</I>&gt;&gt;&gt;<i>or not the download was successful.
</I>&gt;&gt;&gt;<i>For sending the file I think I can best use req.sendfile(path,[offset,
</I>&gt;&gt;&gt;<i>len]). That seems easy enough to implement.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>But how to detect whether the download was aborted (if so: at what
</I>&gt;&gt;&gt;<i>stage), or whether it has finished successful, etc. What I understand
</I>&gt;&gt;&gt;<i>after searching the web, is that req.sendfile does come back: just no
</I>&gt;&gt;&gt;<i>documentation on what it comes back with!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>It will raise an IOError exception if the client disconnects. Otherwise 
</I>&gt;&gt;<i>it will return the number of bytes sent.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> OK, I understand.
</I>&gt;<i> So basically I should say something like this (totally untested for
</I>&gt;<i> now):
</I>&gt;<i> 
</I>&gt;<i> def send_file(req):
</I>&gt;<i> 	filename = &quot;/path/to/file.zip&quot;
</I>&gt;<i> 	try:
</I>&gt;<i> 		bytes_sent = req.sendfile(filename)
</I>&gt;<i> 		success = True
</I>&gt;<i> 	except IOError:
</I>&gt;<i> 		# client disconnected!
</I>&gt;<i> 		success = False
</I>
Seems reasonable.

&gt;<i> I've already noticed you have to add a line like:
</I>&gt;<i> req.headers_out['Content-Disposition'] = 'attachment; filename=file.zip'
</I>&gt;<i> to give the browser a file name for saving (and in case of Mozilla at
</I>&gt;<i> least forces the saving of an mp3 file instead of playing immediately),
</I>&gt;<i> and:
</I>&gt;<i> req.content_type = mimetype
</I>&gt;<i> to set the correct mime type. 
</I>&gt;<i> 
</I>&gt;<i> Another, related problem that I ran into: how to write some data to the
</I>&gt;<i> browser window, and then send the file? That didn't work. Or after the
</I>&gt;<i> download is finished, to write some data to the browser. It seems I have
</I>&gt;<i> to start a new request or so? Changing the content_type does not help!
</I>
This is a limitation of HTTP. The content type is sent with the response 
header. Once you start sending content, it's too late to change anything 
in the header. Basically, you get one content_type per request.

You could try either req.internal_redirect() and util.redirect() but I'm 
not hopeful. I suspect they'll both complain about the headers already 
being sent.

&gt;<i> 
</I>&gt;&gt;<i>req.sendfile is a wrapper around the apache function ap_send_fd(). A 
</I>&gt;&gt;<i>quick look at this tells me that nbytes is set to 0 on failure, so there 
</I>&gt;&gt;<i>is no way for mod_python to determine the progress if the client 
</I>&gt;&gt;<i>disconnects.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> That's less important to me; complete or not is the main issue here.
</I>&gt;<i> By the way, does the req.sendfile() function support resuming a
</I>&gt;<i> download?
</I>
Ah, so it *is* important to you. :) ap_send_fd() sets the number of 
bytes sent to 0 on failure - ie the client disconnects. There is no way 
for req.sendfile to know the number of bytes sent, so there is no way 
for it to resume a download, since it would not know where in the file 
to start sending.

You may be able to manipulate the http headers to get what you want. 
Take a look at headers such as Accept-Ranges, Content-Length, Range, 
etc. This will depend on the client also being able to resume downloads 
and sending the appropriate request. You will need to examine the 
request header to determine what part of the file to send in response.

See <A HREF="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html</A>

Regards,
Jim
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018429.html">[mod_python] req.sendfile() questions
</A></li>
	<LI>Next message: <A HREF="018452.html">[mod_python] req.sendfile() questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18431">[ date ]</a>
              <a href="thread.html#18431">[ thread ]</a>
              <a href="subject.html#18431">[ subject ]</a>
              <a href="author.html#18431">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
