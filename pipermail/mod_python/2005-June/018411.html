<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Threading and apache.import_module
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Threading%20and%20apache.import_module&In-Reply-To=4817b6fc05061712095453abac%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018410.html">
   <LINK REL="Next"  HREF="018412.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Threading and apache.import_module</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>michael bayer</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Threading%20and%20apache.import_module&In-Reply-To=4817b6fc05061712095453abac%40mail.gmail.com"
       TITLE="[mod_python] Threading and apache.import_module">mike_mp at zzzcomputing.com
       </A><BR>
    <I>Sat Jun 18 15:29:46 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="018410.html">[mod_python] Threading and apache.import_module
</A></li>
        <LI>Next message: <A HREF="018412.html">[mod_python] Threading and apache.import_module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18411">[ date ]</a>
              <a href="thread.html#18411">[ thread ]</a>
              <a href="subject.html#18411">[ subject ]</a>
              <a href="author.html#18411">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I use the &quot;two-check&quot; approach to this, which allows multiple threads  
to get at an already-imported resource without blocking each other,  
while allowing the actual import to occur in a threadsafe  
manner...suppose every access of a module calls &quot;verify_module&quot; which  
reloads the module if needed, using the functions _needs_reload to  
perform a check and _reload_module to do the actual reload:

    import threading
    mutex = threading.RLock()

    def verify_module(module):
        if _needs_reload(module):
           mutex.acquire()
           try:
               if _needs_reload(module):
                    _reload_module(module)
           finally:
               mutex.release()

in the normal case, threads will call _needs_reload() without  
synchronization and return, without any bottleneck occuring.  when  
the reload is actually required, threads will line up onto the  
mutex.acquire() and re-check once entering the critical section, thus  
allowing only the first thread inside to actually perform the reload.

an additional optimization is to use a unique mutex for each  
module...that way multiple threads that are reloading several  
different modules also don't block each other.

the issue of other threads executing code against the module while  
its being reloaded is not really addressed here.  as a normal reload 
() or imp.load_module() doesnt remove any of the old module values,  
its usually (but not always) the case that nothing really  
happens....unless there are persistent pointers to the module's  
globals lying around elsewhere, which then become outdated.    I did  
see a reload() implementation that loads a new module under a  
temporary name, then moved it's dictionary over, which attempts to be  
more atomic...I havent tried it but its over at http:// 
lists.canonical.org/pipermail/kragen-hacks/2002-January/000302.html .

On Jun 17, 2005, at 3:09 PM, Dan Eloff wrote:

&gt;<i> Well this is the biggest problem in my otherwise threadsafe code. From
</I>&gt;<i> what I've read, importing/reloading modules in a threaded environment
</I>&gt;<i> is just plain dangerous. There could be any number of requests
</I>&gt;<i> executing code from and accessing global variables in a module when it
</I>&gt;<i> changes and gets reloaded. Then you have the two level problem of what
</I>&gt;<i> happens to the executing requests, as well as what happens when
</I>&gt;<i> multiple incoming requests all spot that the module has changed, and
</I>&gt;<i> reload it multiple times in quick succession, re-executing code in the
</I>&gt;<i> module scope (this is pretty much worst case)
</I>&gt;<i>
</I>&gt;<i> I know Graham knows a lot more about this than I do (help!).
</I>&gt;<i>
</I>&gt;<i> I do have a lot of flexibility here, since I'm using my own publisher
</I>&gt;<i> I do not have to use apache.import_module. In fact I would prefer to
</I>&gt;<i> not have the whole importing/reloading business affect my code outside
</I>&gt;<i> of the publisher, that way I can change things internally at will.
</I>&gt;<i> Clearly one option is to create a simple import function that imports
</I>&gt;<i> once only in a production environment, and every time in a development
</I>&gt;<i> env, but I'm still interested in exploring the options.
</I>&gt;<i>
</I>&gt;<i> -Dan
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mod_python mailing list
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
</I>&gt;<i> <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>
</I>&gt;<i>
</I></PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018410.html">[mod_python] Threading and apache.import_module
</A></li>
	<LI>Next message: <A HREF="018412.html">[mod_python] Threading and apache.import_module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18411">[ date ]</a>
              <a href="thread.html#18411">[ thread ]</a>
              <a href="subject.html#18411">[ subject ]</a>
              <a href="author.html#18411">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
