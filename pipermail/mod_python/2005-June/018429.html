<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] req.sendfile() questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20req.sendfile%28%29%20questions&In-Reply-To=42B6B897.30507%40sympatico.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018428.html">
   <LINK REL="Next"  HREF="018431.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] req.sendfile() questions</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Wouter van Marle</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20req.sendfile%28%29%20questions&In-Reply-To=42B6B897.30507%40sympatico.ca"
       TITLE="[mod_python] req.sendfile() questions">wouter at squirrel-systems.com
       </A><BR>
    <I>Mon Jun 20 09:59:11 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="018428.html">[mod_python] req.sendfile() questions
</A></li>
        <LI>Next message: <A HREF="018431.html">[mod_python] req.sendfile() questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18429">[ date ]</a>
              <a href="thread.html#18429">[ thread ]</a>
              <a href="subject.html#18429">[ subject ]</a>
              <a href="author.html#18429">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 2005-06-20 at 08:37 -0400, Jim Gallacher wrote:

&gt;<i> &gt; I'm looking into a way of sending out specific files, and detect whether
</I>&gt;<i> &gt; or not the download was successful.
</I>&gt;<i> &gt; For sending the file I think I can best use req.sendfile(path,[offset,
</I>&gt;<i> &gt; len]). That seems easy enough to implement.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; But how to detect whether the download was aborted (if so: at what
</I>&gt;<i> &gt; stage), or whether it has finished successful, etc. What I understand
</I>&gt;<i> &gt; after searching the web, is that req.sendfile does come back: just no
</I>&gt;<i> &gt; documentation on what it comes back with!
</I>&gt;<i> 
</I>&gt;<i> It will raise an IOError exception if the client disconnects. Otherwise 
</I>&gt;<i> it will return the number of bytes sent.
</I>&gt;<i> 
</I>
OK, I understand.
So basically I should say something like this (totally untested for
now):

def send_file(req):
	filename = &quot;/path/to/file.zip&quot;
	try:
		bytes_sent = req.sendfile(filename)
		success = True
	except IOError:
		# client disconnected!
		success = False

I've already noticed you have to add a line like:
req.headers_out['Content-Disposition'] = 'attachment; filename=file.zip'
to give the browser a file name for saving (and in case of Mozilla at
least forces the saving of an mp3 file instead of playing immediately),
and:
req.content_type = mimetype
to set the correct mime type. 

Another, related problem that I ran into: how to write some data to the
browser window, and then send the file? That didn't work. Or after the
download is finished, to write some data to the browser. It seems I have
to start a new request or so? Changing the content_type does not help!

&gt;<i> req.sendfile is a wrapper around the apache function ap_send_fd(). A 
</I>&gt;<i> quick look at this tells me that nbytes is set to 0 on failure, so there 
</I>&gt;<i> is no way for mod_python to determine the progress if the client 
</I>&gt;<i> disconnects.
</I>&gt;<i> 
</I>
That's less important to me; complete or not is the main issue here.
By the way, does the req.sendfile() function support resuming a
download?

Wouter.

&gt;<i> I'll add this to the documentation.
</I>&gt;<i> 
</I>&gt;<i> Jim
</I>&gt;<i> 
</I>&gt;<i> 
</I>
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018428.html">[mod_python] req.sendfile() questions
</A></li>
	<LI>Next message: <A HREF="018431.html">[mod_python] req.sendfile() questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18429">[ date ]</a>
              <a href="thread.html#18429">[ thread ]</a>
              <a href="subject.html#18429">[ subject ]</a>
              <a href="author.html#18429">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
