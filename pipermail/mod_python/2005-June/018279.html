<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] PythonAuthenHandler Question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20PythonAuthenHandler%20Question&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018278.html">
   <LINK REL="Next"  HREF="018280.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] PythonAuthenHandler Question</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Al Pacifico</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20PythonAuthenHandler%20Question&In-Reply-To="
       TITLE="[mod_python] PythonAuthenHandler Question">pacifico at drizzle.com
       </A><BR>
    <I>Sat Jun  4 19:54:47 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="018278.html">[mod_python] Accessing objects loaded with PythonImport
</A></li>
        <LI>Next message: <A HREF="018280.html">[mod_python] Source code displayed by Mozilla/Firefox
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18279">[ date ]</a>
              <a href="thread.html#18279">[ thread ]</a>
              <a href="subject.html#18279">[ subject ]</a>
              <a href="author.html#18279">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So, I'm perhaps partly able to answer my previous question(s) and will post
some code once I get it working perfectly. At present, I've gotten much
closer using the requires() method of request object.

My error log is cropping up with:
	'access to &lt;page&gt; failed, reason unknown require directive:
&quot;administrator&quot;'
	'access to &lt;page&gt; failed, reason user &lt;user name&gt; not allowed
access'

My authentication handler seems to execute correctly, but then a core apache
handler is picking up the request and canning it.
I've been using the require directive as &quot;require administrator&quot; and therein
lies the problem. But I wish to allocate access on a per-directory basis to
members of the administrator group.

Two questions:
1. How do I remove the core handler from my request's authentication phase
handler chain on a per-directory basis, so that my handler is the only one
registered to authenticate?
2. If I can't do that, how do I pass information on a per-directory basis
from httpd.conf to my handler? If I can do that by some technique, then I
can change 'require administrator' to 'require valid-user' (simply to
trigger the authentication handler) and call it good.

I can think of lots of ugly solutions. One is to place a file in each
directory encoding which groups are able to access that directory and have
my handler read it in (and probably cache it in a dictionary to speed future
authentications), but I prefer the elegance of the httpd.conf solution.

Again, mod_auth_ldap probably will not work with ldap sasl queries, which I
am compelled to use. Grepping the source code for 'sasl' comes up empty.
 
now my httpd.conf contains:

	&lt;snip&gt;
User apache
Group apache
ServerAdmin <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">root at localhost</A>
ServerName powell:80
UseCanonicalName Off
DocumentRoot &quot;/usr/var/www/htdocs&quot;
PythonPath &quot;sys.path+['/usr/var/www/lib']&quot;
# Following did not work as expected
# PythonImport PMHx_Config powell
&lt;Directory /&gt;
    Options FollowSymLinks
    AllowOverride None
&lt;/Directory&gt;
&lt;Directory &quot;/usr/var/www/htdocs&quot;&gt;
    AddHandler mod_python .psp
    PythonHandler mod_python.psp
    PythonDebug On
    Options Indexes FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
&lt;/Directory&gt;
&lt;Directory &quot;/usr/var/www/htdocs/administration&quot;&gt;
    AddHandler mod_python .psp
    PythonHandler mod_python.psp
	PythonAuthenHandler authenticate
	PythonDebug On
	AuthType Basic
	AuthName &quot;Restricted Area&quot;
	require administrator
&lt;/Directory&gt;
	&lt;snip&gt;
Al Pacifico
Seattle, WA

Apologies in advance because I come from an Apache 1.3 / mod_perl background
and am rusty at that to boot.

I'm wondering how to use PythonAuthenHandler to set my client's directory
viewing permissions. I'm authenticating against an openLDAP server and the
basic authentication works.

Depending on the identity of the client, some directories should be
accessible and some should not. With a little additional code, I can assign
the client a category. I figure that I should be using a require &lt;usertype&gt;
directive within my httpd.conf and setting a variable in the request object
to describe the category. Alternatively, I might need to write a
PythonAuthzHandler, but the documentation on this is sparse and I'd rather
not bind to the LDAP server twice if I can avoid it.

I thought about using mod_auth_ldap instead, but review of documentation
suggest that it doesn't know how to bind to openLDAP using SASL
authentication, and I cannot change to another authentication scheme.

Could someone provide an example or suggest changes to my handler and
corresponding changes to http.conf ?

On a side note, will a 'finally:' clause be executed even if the 'except:'
clause contains 'return' ? Or should I have result = apache.&lt;whatever&gt; and
place return result in the finally clause ?

Here is my authentication handler:

from mod_python import apache
import ldap,ldap.sasl
import MyConfig

def authenhandler(req):

	# import our configuration file to find our LDAP server
	config = MyConfig.Config()

	# show the password dialog, retrieve password and user
	pw = req.get_basic_auth_pw()
	email = req.user

	# get a sasl authentication object
	
sasl_auth=ldap.sasl.sasl({ldap.sasl.CB_AUTHNAME:email,ldap.sasl.CB_PASS:pw},
'DIGEST-MD5')
	
	# open a connection to our LDAP server
	try:
		l = ldap.open(config[&quot;LDAP:server&quot;])

		# attempt to bind to the LDAP server
		try:
			l.sasl_interactive_bind_s(&quot;&quot;,sasl_auth)
			dn = l.whoami_s()
			l.unbind()
			return apache.OK
		except ldap.LDAPError,e:
			l.unbind()
			return apache.HTTP_UNAUTHORIZED
	except ldap.LDAPError,e:
		l.unbind()
		return apache.HTTP_UNAUTHORIZED

and my httpd.conf contains:

	&lt;snip&gt;
User apache
Group apache
ServerAdmin <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">root at localhost</A>
ServerName powell:80
UseCanonicalName Off
DocumentRoot &quot;/usr/var/www/htdocs&quot;
PythonPath &quot;sys.path+['/usr/var/www/lib']&quot;
# Following did not work as expected
# PythonImport PMHx_Config powell
&lt;Directory /&gt;
    Options FollowSymLinks
    AllowOverride None
&lt;/Directory&gt;
&lt;Directory &quot;/usr/var/www/htdocs&quot;&gt;
    AddHandler mod_python .psp
    PythonHandler mod_python.psp
    PythonDebug On
    Options Indexes FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
&lt;/Directory&gt;
&lt;Directory &quot;/usr/var/www/htdocs/administration&quot;&gt;
    AddHandler mod_python .psp
    PythonHandler mod_python.psp
	PythonAuthenHandler authenticate
	PythonDebug On
	AuthType Basic
	AuthName &quot;Restricted Area&quot;
	require valid-user
&lt;/Directory&gt;
	&lt;snip&gt;

Thanks
-al



_______________________________________________
Mod_python mailing list
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">Mod_python at modpython.org</A>
<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">http://mailman.modpython.org/mailman/listinfo/mod_python</A>




</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018278.html">[mod_python] Accessing objects loaded with PythonImport
</A></li>
	<LI>Next message: <A HREF="018280.html">[mod_python] Source code displayed by Mozilla/Firefox
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18279">[ date ]</a>
              <a href="thread.html#18279">[ thread ]</a>
              <a href="subject.html#18279">[ subject ]</a>
              <a href="author.html#18279">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "000000";
google_color_url = "666666";
google_color_text = "333333";
//--></script>
<script type="text/javascript"
  src="DISABLEhttp://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
