<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Is external redirect supposed to send a cookie
	(mpservlets)?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Is%20external%20redirect%20supposed%20to%20send%20a%20cookie%0A%09%28mpservlets%29%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018446.html">
   <LINK REL="Next"  HREF="018441.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Is external redirect supposed to send a cookie
	(mpservlets)?</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Scott Chapman</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Is%20external%20redirect%20supposed%20to%20send%20a%20cookie%0A%09%28mpservlets%29%3F&In-Reply-To="
       TITLE="[mod_python] Is external redirect supposed to send a cookie
	(mpservlets)?">scott_list at mischko.com
       </A><BR>
    <I>Mon Jun 20 15:08:11 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="018446.html">[mod_python] mod_python and execfile
</A></li>
        <LI>Next message: <A HREF="018441.html">[mod_python] Is external redirect supposed to send a cookie
	(mpservlets)?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18440">[ date ]</a>
              <a href="thread.html#18440">[ thread ]</a>
              <a href="subject.html#18440">[ subject ]</a>
              <a href="author.html#18440">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

I'm having problems with session cookies and redirects.  Can this be
resolved or is this the way things work?

If a user requests a page that requires a login login and they are not
logged in (and they have no cookies), I automatically redirect
(external) them to the login screen, after setting a &quot;returnto&quot; session
entry.  The returnto is lost because the cookie is not sent with the 302
response.

Here's code in my auth method that sets the session returnto value and
redirects them:

&gt;<i> if requiresLogin:
</I>&gt;<i>     self.req.log_error('AUTH - page: %s requires login' % methodName)
</I>&gt;<i>     userID = self.session.get('userid', None)
</I>&gt;<i>     # Check to see if the user is logged in
</I>&gt;<i>     if not userID:
</I>&gt;<i>         self.req.log_error('AUTH - user not logged in')
</I>&gt;<i>         self.session['returnto'] = self.req.unparsed_uri
</I>&gt;<i>         self.req.log_error('AUTH - sid when returnto set: ' + str(self.session.id()))
</I>&gt;<i>         self.req.log_error('AUTH - returnto: ' + self.session['returnto'])
</I>&gt;<i>         self.req.log_error('AUTH - external redirect to login')
</I>&gt;<i>         self.external_redirect('/login')
</I>
Here's the code in my /login screen which is supposed to catch the
returnto and send them on their way:

&gt;<i> user_id = data_object.checkLoginAndPassword(login, password)
</I>&gt;<i> if user_id:
</I>&gt;<i>     # The login information is valid.
</I>&gt;<i>     uberServlet.session['userid'] = user_id
</I>&gt;<i>     uberServlet.req.log_error('LOGIN - username and password confirmed')
</I>&gt;<i>     uberServlet.req.log_error('LOGIN - userid,email: %s, %s' % (user_id,login))
</I>&gt;<i>     uberServlet.req.log_error('LOGIN - session id: ' + str(uberServlet.session.id()))
</I>&gt;<i>     return_to = uberServlet.session.pop('returnto: ','/index')
</I>&gt;<i>     uberServlet.req.log_error('LOGIN - return_to' + return_to)
</I>&gt;<i>     util.redirect(uberServlet.req,return_to)
</I>
Here's the log:

&gt;<i> HANDLER-calling prep
</I>&gt;<i> HANDLER-calling auth
</I>&gt;<i> AUTH - methodName: change_password
</I>&gt;<i> AUTH - method found
</I>&gt;<i> AUTH - page: change_password requires login
</I>&gt;<i> AUTH - user not logged in
</I>&gt;<i> AUTH - sid when returnto set: 82d588854c0a23ac67c7f986ab86ad79
</I>&gt;<i> AUTH - returnto: /change_password
</I>&gt;<i> AUTH - external redirect to login
</I>&gt;<i> HANDLER-calling prep
</I>&gt;<i> HANDLER-calling auth
</I>&gt;<i> AUTH - methodName: login
</I>&gt;<i> HANDLER-calling respond
</I>&gt;<i> UBERSERVLET RESPOND - method name: login
</I>&gt;<i> UBERSERVLET RESPOND - calling method
</I>&gt;<i> HANDLER-calling wrapup
</I>&gt;<i> =========== login screen ===========
</I>&gt;<i> HANDLER-calling prep, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> HANDLER-calling auth, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> AUTH - methodName: login, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> HANDLER-calling respond, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - Converting form to dict, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - Form Entry Type: &lt;class 'mod_python.util.StringField'&gt;, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - key: login, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - Single Item, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - Form Entry Type: &lt;class 'mod_python.util.StringField'&gt;, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - key: password, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - Single Item, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - form dict: {'login': '<A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">scott at mischko.com</A>', 'password': 'letmein'}, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - method name: login, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - calling method, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> LOGIN - username and password confirmed, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> LOGIN - userid,email: 1, <A HREF="http://mailman.modpython.org/mailman/listinfo/mod_python">scott at mischko.com</A>, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> LOGIN - session id: e17247d6be677abadf19748044acb0bf, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> LOGIN - return_to/index, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> HANDLER-calling prep, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> HANDLER-calling auth, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> AUTH - methodName: index, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> AUTH - method found, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> AUTH - page: index does not require login, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> HANDLER-calling respond, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - method name: index, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> UBERSERVLET RESPOND - calling method, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> HANDLER-calling wrapup, referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>

And here's the HTTP live capture of headers:

&gt;<i> <A HREF="http://nsnserver/change_password">http://nsnserver/change_password</A>                                                                           
</I>&gt;<i>                                                                                                            
</I>&gt;<i> GET /change_password HTTP/1.1                                                                              
</I>&gt;<i> Host: nsnserver                                                                                            
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.8) Gecko/20050511 Firefox/1.0.4         
</I>&gt;<i> Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
</I>&gt;<i> Accept-Language: en-us,en;q=0.5                                                                            
</I>&gt;<i> Accept-Encoding: gzip,deflate                                                                              
</I>&gt;<i> Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7                                                             
</I>&gt;<i> Keep-Alive: 300                                                                                            
</I>&gt;<i> Connection: keep-alive                                                                                     
</I>&gt;<i>                                                                                                            
</I>&gt;<i> HTTP/1.x 302 Found                                                                                         
</I>&gt;<i> Date: Fri, 17 Jun 2005 21:50:24 GMT                                                                        
</I>&gt;<i> Server: Apache/2.0.53 (Unix) mod_ssl/2.0.53 OpenSSL/0.9.7d mod_python/3.1.4 Python/2.4.1c2 PHP/4.3.10      
</I>&gt;<i> Location: /login                                                                                           
</I>&gt;<i> Content-Length: 336                                                                                        
</I>&gt;<i> Keep-Alive: timeout=15, max=100                                                                            
</I>&gt;<i> Connection: Keep-Alive                                                                                     
</I>&gt;<i> Content-Type: text/html; charset=iso-8859-1                                                                
</I>&gt;<i> ----------------------------------------------------------                                                 
</I>&gt;<i> <A HREF="http://nsnserver/login">http://nsnserver/login</A>                                                                                     
</I>&gt;<i>                                                                                                            
</I>&gt;<i> GET /login HTTP/1.1                                                                                        
</I>&gt;<i> Host: nsnserver                                                                                            
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.8) Gecko/20050511 Firefox/1.0.4         
</I>&gt;<i> Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
</I>&gt;<i> Accept-Language: en-us,en;q=0.5                                                                            
</I>&gt;<i> Accept-Encoding: gzip,deflate                                                                              
</I>&gt;<i> Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7                                                             
</I>&gt;<i> Keep-Alive: 300                                                                                            
</I>&gt;<i> Connection: keep-alive                                                                                     
</I>&gt;<i>                                                                                                            
</I>&gt;<i> HTTP/1.x 200 OK                                                                                            
</I>&gt;<i> Date: Fri, 17 Jun 2005 21:50:25 GMT                                                                        
</I>&gt;<i> Server: Apache/2.0.53 (Unix) mod_ssl/2.0.53 OpenSSL/0.9.7d mod_python/3.1.4 Python/2.4.1c2 PHP/4.3.10      
</I>&gt;<i> Cache-Control: no-cache=&quot;set-cookie&quot;                                                                       
</I>&gt;<i> Set-Cookie: pysid=e17247d6be677abadf19748044acb0bf; path=/                                                 
</I>&gt;<i> Keep-Alive: timeout=15, max=99                                                                             
</I>&gt;<i> Connection: Keep-Alive                                                                                     
</I>&gt;<i> Transfer-Encoding: chunked                                                                                 
</I>&gt;<i> Content-Type: text/html                                                                                    
</I>&gt;<i> ----------------------------------------------------------                                                 
</I>&gt;<i> ==========login screen in web browser here=====================
</I>&gt;<i> <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> 
</I>&gt;<i> POST /login HTTP/1.1
</I>&gt;<i> Host: nsnserver
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.8) Gecko/20050511 Firefox/1.0.4
</I>&gt;<i> Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
</I>&gt;<i> Accept-Language: en-us,en;q=0.5
</I>&gt;<i> Accept-Encoding: gzip,deflate
</I>&gt;<i> Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
</I>&gt;<i> Keep-Alive: 300
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> Referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> Cookie: pysid=e17247d6be677abadf19748044acb0bf; testSessionCookie=Enabled
</I>&gt;<i> Content-Type: application/x-www-form-urlencoded
</I>&gt;<i> Content-Length: 42
</I>&gt;<i> login=scott%40mischko.com&amp;password=letmein
</I>&gt;<i> HTTP/1.x 302 Found
</I>&gt;<i> Date: Fri, 17 Jun 2005 21:51:12 GMT
</I>&gt;<i> Server: Apache/2.0.53 (Unix) mod_ssl/2.0.53 OpenSSL/0.9.7d mod_python/3.1.4 Python/2.4.1c2 PHP/4.3.10
</I>&gt;<i> Location: /index
</I>&gt;<i> Keep-Alive: timeout=15, max=100
</I>&gt;<i> Connection: Keep-Alive
</I>&gt;<i> Transfer-Encoding: chunked
</I>&gt;<i> Content-Type: text/plain
</I>&gt;<i> ----------------------------------------------------------
</I>&gt;<i> <A HREF="http://nsnserver/index">http://nsnserver/index</A>
</I>&gt;<i> 
</I>&gt;<i> GET /index HTTP/1.1
</I>&gt;<i> Host: nsnserver
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.8) Gecko/20050511 Firefox/1.0.4
</I>&gt;<i> Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
</I>&gt;<i> Accept-Language: en-us,en;q=0.5
</I>&gt;<i> Accept-Encoding: gzip,deflate
</I>&gt;<i> Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
</I>&gt;<i> Keep-Alive: 300
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> Referer: <A HREF="http://nsnserver/login">http://nsnserver/login</A>
</I>&gt;<i> Cookie: pysid=e17247d6be677abadf19748044acb0bf; testSessionCookie=Enabled
</I>&gt;<i> 
</I>&gt;<i> HTTP/1.x 200 OK
</I>&gt;<i> Date: Fri, 17 Jun 2005 21:51:14 GMT
</I>&gt;<i> Server: Apache/2.0.53 (Unix) mod_ssl/2.0.53 OpenSSL/0.9.7d mod_python/3.1.4 Python/2.4.1c2 PHP/4.3.10
</I>&gt;<i> Keep-Alive: timeout=15, max=100
</I>&gt;<i> Connection: Keep-Alive
</I>&gt;<i> Transfer-Encoding: chunked
</I>&gt;<i> Content-Type: text/html
</I>


</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018446.html">[mod_python] mod_python and execfile
</A></li>
	<LI>Next message: <A HREF="018441.html">[mod_python] Is external redirect supposed to send a cookie
	(mpservlets)?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18440">[ date ]</a>
              <a href="thread.html#18440">[ thread ]</a>
              <a href="subject.html#18440">[ subject ]</a>
              <a href="author.html#18440">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
