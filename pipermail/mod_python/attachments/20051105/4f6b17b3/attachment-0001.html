<tt>
&lt;HTML&gt;&lt;BODY&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-khtml-nbsp-mode:&nbsp;space;&nbsp;-khtml-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;DIV&gt;All, &lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt;I&nbsp;don't&nbsp;think&nbsp;this&nbsp;is&nbsp;the&nbsp;right&nbsp;mailing&nbsp;list&nbsp;to&nbsp;send&nbsp;this&nbsp;but&nbsp;here&nbsp;it&nbsp;goes.&nbsp;(Let&nbsp;me&nbsp;know&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;developers&nbsp;list).&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt;The&nbsp;current&nbsp;3.1&nbsp;mod_python&nbsp;implementation&nbsp;of&nbsp;mod_python.util.StorageField.read_to_boudary&nbsp;reads&nbsp;as&nbsp;follows:&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt; &nbsp; 203 &nbsp; &nbsp; &nbsp;def&nbsp;read_to_boundary(self,&nbsp;req,&nbsp;boundary,&nbsp;file):&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;204 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;delim&nbsp;=&nbsp;&quot;&quot;&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;205 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;line&nbsp;=&nbsp;req.readline()&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;206 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sline&nbsp;=&nbsp;line.strip()&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;207 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;last_bound&nbsp;=&nbsp;boundary&nbsp;+&nbsp;&quot;--&quot;&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;208 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;while&nbsp;line&nbsp;and&nbsp;sline&nbsp;!=&nbsp;boundary&nbsp;and&nbsp;sline&nbsp;!=&nbsp;last_bound:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;209 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;odelim&nbsp;=&nbsp;delim&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;210 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;line[-2:]&nbsp;==&nbsp;&quot;\r\n&quot;:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;211 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;delim&nbsp;=&nbsp;&quot;\r\n&quot;&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;212 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;line&nbsp;=&nbsp;line[:-2]&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;213 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;elif&nbsp;line[-1:]&nbsp;==&nbsp;&quot;\n&quot;:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;214 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;delim&nbsp;=&nbsp;&quot;\n&quot;&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;215 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;line&nbsp;=&nbsp;line[:-1]&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;216 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;file.write(odelim&nbsp;+&nbsp;line)&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;217 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;line&nbsp;=&nbsp;req.readline()&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;218 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sline&nbsp;=&nbsp;line.strip()&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt;As&nbsp;we&nbsp;have&nbsp;discussed&nbsp;previously: &lt;/DIV&gt;&lt;DIV&gt;&lt;A&nbsp;href=&quot;http://www.modpython.org/pipermail/mod_python/2005-March/017754.html&quot;&gt;http://www.modpython.org/pipermail/mod_python/2005-March/017754.html&lt;/A&gt;&lt;/DIV&gt;&lt;DIV&gt;&lt;A&nbsp;href=&quot;http://www.modpython.org/pipermail/mod_python/2005-March/017756.html&quot;&gt;http://www.modpython.org/pipermail/mod_python/2005-March/017756.html&lt;/A&gt;&lt;/DIV&gt;&lt;DIV&gt;&lt;A&nbsp;href=&quot;http://www.modpython.org/pipermail/mod_python/2005-November/019460.html&quot;&gt;http://www.modpython.org/pipermail/mod_python/2005-November/019460.html&lt;/A&gt;&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt;This&nbsp;triggered&nbsp;couple&nbsp;of&nbsp;changes&nbsp;in&nbsp;mod_python&nbsp;3.2&nbsp;Beta&nbsp;which&nbsp;reads&nbsp;as&nbsp;follows:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp; 33 &nbsp;#&nbsp;Fixes&nbsp;memory&nbsp;error&nbsp;when&nbsp;upload&nbsp;large&nbsp;files&nbsp;such&nbsp;as&nbsp;700+MB&nbsp;ISOs.&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp;34 &nbsp;readBlockSize&nbsp;=&nbsp;65368&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp;35&lt;/DIV&gt;&lt;DIV&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;&lt;FONT&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#B09091&quot;&nbsp;face=&quot;Consolas&quot;&nbsp;size=&quot;3&quot;&gt;&lt;SPAN&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-size:&nbsp;13px;&quot;&gt;&lt;B&gt;...&lt;/B&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;&lt;DIV&gt; &nbsp; 225 &nbsp;  &nbsp;def&nbsp;read_to_boundary(self,&nbsp;req,&nbsp;boundary,&nbsp;file):&lt;/DIV&gt;&lt;DIV&gt;...&lt;/DIV&gt;&lt;DIV&gt; &nbsp; 234 &nbsp; &nbsp; &nbsp;  &nbsp;delim&nbsp;=&nbsp;''&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;235 &nbsp; &nbsp; &nbsp;  &nbsp;lastCharCarried&nbsp;=&nbsp;False&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;236 &nbsp; &nbsp; &nbsp;  &nbsp;last_bound&nbsp;=&nbsp;boundary&nbsp;+&nbsp;'--'&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;237 &nbsp; &nbsp; &nbsp;  &nbsp;roughBoundaryLength&nbsp;=&nbsp;len(last_bound)&nbsp;+&nbsp;128&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;238 &nbsp; &nbsp; &nbsp;  &nbsp;line&nbsp;=&nbsp;req.readline(readBlockSize)&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;239 &nbsp; &nbsp; &nbsp;  &nbsp;lineLength&nbsp;=&nbsp;len(line)&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;240 &nbsp; &nbsp; &nbsp;  &nbsp;if&nbsp;lineLength&nbsp;&amp;lt;&nbsp;roughBoundaryLength:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;241 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;sline&nbsp;=&nbsp;line.strip()&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;242 &nbsp; &nbsp; &nbsp;  &nbsp;else:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;243 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;sline&nbsp;=&nbsp;''&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;244 &nbsp; &nbsp; &nbsp;  &nbsp;while&nbsp;lineLength&nbsp;&amp;gt;&nbsp;0&nbsp;and&nbsp;sline&nbsp;!=&nbsp;boundary&nbsp;and&nbsp;sline&nbsp;!=&nbsp;last_bound:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;245 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;if&nbsp;not&nbsp;lastCharCarried:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;246 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;file.write(delim)&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;247 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;delim&nbsp;=&nbsp;''&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;248 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;else:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;249 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;lastCharCarried&nbsp;=&nbsp;False&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;250 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;cutLength&nbsp;=&nbsp;0&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;251 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;if&nbsp;lineLength&nbsp;==&nbsp;readBlockSize:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;252 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;if&nbsp;line[-1:]&nbsp;==&nbsp;'\r':&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;253 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;delim&nbsp;=&nbsp;'\r'&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;254 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;cutLength&nbsp;=&nbsp;-1&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;lastCharCarried&nbsp;=&nbsp;True&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;256 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;if&nbsp;line[-2:]&nbsp;==&nbsp;'\r\n':&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;257 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;delim&nbsp;+=&nbsp;'\r\n'&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;258 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;cutLength&nbsp;=&nbsp;-2&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;259 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;elif&nbsp;line[-1:]&nbsp;==&nbsp;'\n':&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;260 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;delim&nbsp;+=&nbsp;'\n'&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;261 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;cutLength&nbsp;=&nbsp;-1&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;262 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;if&nbsp;cutLength&nbsp;!=&nbsp;0:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;263 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;file.write(line[:cutLength])&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;264 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;else:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;265 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;file.write(line)&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;266 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;line&nbsp;=&nbsp;req.readline(readBlockSize)&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;267 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;lineLength&nbsp;=&nbsp;len(line)&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;268 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;if&nbsp;lineLength&nbsp;&amp;lt;&nbsp;roughBoundaryLength:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;269 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;sline&nbsp;=&nbsp;line.strip()&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;270 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;else:&lt;/DIV&gt;&lt;DIV&gt;  &nbsp;271 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp;sline&nbsp;=&nbsp;''&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt;This&nbsp;function&nbsp;has&nbsp;a&nbsp;mysterious&nbsp;bug&nbsp;in&nbsp;it...&nbsp;For&nbsp;some&nbsp;files&nbsp;which&nbsp;I&nbsp;could&nbsp;disclose&nbsp;(one&nbsp;of&nbsp;them&nbsp;been&nbsp;the&nbsp;PDF&nbsp;file&nbsp;for&nbsp;Apple&nbsp;Pages&nbsp;User&nbsp;Manual&nbsp;in&nbsp;Italian)&nbsp;the&nbsp;uploaded&nbsp;file&nbsp;in&nbsp;the&nbsp;server&nbsp;ends&nbsp;up&nbsp;with&nbsp;the&nbsp;same&nbsp;length&nbsp;but&nbsp;different&nbsp;sha512&nbsp;(the&nbsp;only&nbsp;digest&nbsp;that&nbsp;I'm&nbsp;using). &nbsp;The&nbsp;problem&nbsp;is&nbsp;a&nbsp;'\r'&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;chunk&nbsp;of&nbsp;data&nbsp;that&nbsp;is&nbsp;much&nbsp;larger&nbsp;than readBlockSize.&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt;Anyhow,&nbsp;I&nbsp;wrote&nbsp;a&nbsp;new&nbsp;function,&nbsp;which&nbsp;I&nbsp;believe&nbsp;is&nbsp;much&nbsp;simpler,&nbsp;and&nbsp;test&nbsp;it&nbsp;with&nbsp;thousands&nbsp;and&nbsp;thousands&nbsp;of&nbsp;different&nbsp;files&nbsp;and&nbsp;so&nbsp;far&nbsp;it&nbsp;seems&nbsp;to&nbsp;work&nbsp;fine. &nbsp;It&nbsp;reads&nbsp;as&nbsp;follows:&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt;def&nbsp;read_to_boundary(self,&nbsp;req,&nbsp;boundary,&nbsp;file):&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp;'''&nbsp;read&nbsp;from&nbsp;the&nbsp;request&nbsp;object&nbsp;line&nbsp;by&nbsp;line&nbsp;with&nbsp;a&nbsp;maximum&nbsp;size,&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp;until&nbsp;the&nbsp;new&nbsp;line&nbsp;starts&nbsp;with&nbsp;boundary&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp;'''&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp;previous_delimiter&nbsp;=&nbsp;''&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp;while&nbsp;1:&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp;line&nbsp;=&nbsp;req.readline(1&amp;lt;&amp;lt;16)&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;line.startswith(boundary):&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;break&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;line.endswith('\r\n'):&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;file.write(previous_delimiter&nbsp;+&nbsp;line[:-2])&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;previous_delimiter&nbsp;=&nbsp;'\r\n'&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp;elif&nbsp;line.endswith('\r')&nbsp;or&nbsp;line.endswith('\n'):&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;file.write(previous_delimiter&nbsp;+&nbsp;line[:-1])  &nbsp;&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;previous_delimiter&nbsp;=&nbsp;line[-1:]&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp;else:&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;file.write(previous_delimiter&nbsp;+&nbsp;line)&lt;/DIV&gt;&lt;DIV&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;previous_delimiter&nbsp;=&nbsp;''&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;DIV&gt;Mod_python&nbsp;developers,&nbsp;let&nbsp;me&nbsp;know&nbsp;any&nbsp;comments&nbsp;on&nbsp;it&nbsp;and&nbsp;if&nbsp;you&nbsp;test&nbsp;it&nbsp;and&nbsp;fails&nbsp;please&nbsp;also&nbsp;let&nbsp;me&nbsp;know. &lt;/DIV&gt;&lt;DIV&gt;/amn&lt;/DIV&gt;&lt;DIV&gt;&lt;BR&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/DIV&gt;&lt;/BODY&gt;&lt;/HTML&gt;
</tt>
