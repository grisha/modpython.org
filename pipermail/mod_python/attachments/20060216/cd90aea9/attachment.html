<tt>
&amp;quot;in-place&nbsp;unicode&nbsp;to&nbsp;string&nbsp;conversion&nbsp;is&nbsp;quite&nbsp;difficult&nbsp;to&nbsp;achieve&amp;quot;&lt;br&gt;&lt;br&gt;Oh&nbsp;you're&nbsp;right&nbsp;about&nbsp;that,&nbsp;I'd&nbsp;never&nbsp;attempt&nbsp;it,&nbsp;I&nbsp;was&nbsp;merely&nbsp;hoping&nbsp;to&nbsp;avoid&nbsp;redundant&nbsp;copies&nbsp;like&nbsp;creating&nbsp;a&nbsp;python&nbsp;string&nbsp;by&nbsp;copying&nbsp;the&nbsp;character&nbsp;buffer&nbsp;bit&nbsp;for&nbsp;bit&nbsp;when&nbsp;it&nbsp;could&nbsp;be&nbsp;reused.<br>
&lt;br&gt;&lt;br&gt;You're&nbsp;right&nbsp;of&nbsp;course&nbsp;about&nbsp;doing&nbsp;the&nbsp;psp&nbsp;module&nbsp;in&nbsp;C&nbsp;or&nbsp;C++.&nbsp;Now&nbsp;that&nbsp;I&nbsp;think&nbsp;about&nbsp;I&nbsp;don't&nbsp;know&nbsp;why&nbsp;I&nbsp;am&nbsp;rewriting&nbsp;it&nbsp;in&nbsp;C++&nbsp;instead&nbsp;of&nbsp;python,&nbsp;other&nbsp;than&nbsp;because&nbsp;mod_python&nbsp;did&nbsp;that.&nbsp;Now&nbsp;I&nbsp;feel&nbsp;stupid,&nbsp;lol.&nbsp;The&nbsp;parsing&nbsp;would&nbsp;be&nbsp;much&nbsp;faster&nbsp;in&nbsp;C++,&nbsp;which&nbsp;means&nbsp;very&nbsp;little&nbsp;unless&nbsp;you&nbsp;have&nbsp;to&nbsp;reparse&nbsp;it&nbsp;frequently&nbsp;(depends&nbsp;how&nbsp;often&nbsp;the&nbsp;apache&nbsp;process&nbsp;gets&nbsp;killed&nbsp;and&nbsp;restarted.)&nbsp;Parsing&nbsp;the&nbsp;psp&nbsp;files&nbsp;is&nbsp;probably&nbsp;the&nbsp;most&nbsp;expensive&nbsp;part&nbsp;of&nbsp;my&nbsp;website&nbsp;initialization,&nbsp;simply&nbsp;because&nbsp;I&nbsp;have&nbsp;so&nbsp;many&nbsp;psp&nbsp;pages&nbsp;(and&nbsp;growing.)&nbsp;I&nbsp;haven't&nbsp;profiled&nbsp;it,&nbsp;but&nbsp;even&nbsp;just&nbsp;reading&nbsp;in&nbsp;all&nbsp;those&nbsp;files&nbsp;should&nbsp;be&nbsp;more&nbsp;expensive&nbsp;than&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;initialization&nbsp;process.<br>
&lt;br&gt;&lt;br&gt;The&nbsp;flex&nbsp;business&nbsp;was&nbsp;a&nbsp;mess,&nbsp;I&nbsp;was&nbsp;planning&nbsp;to&nbsp;just&nbsp;ignore&nbsp;it&nbsp;all&nbsp;and&nbsp;handcoded&nbsp;the&nbsp;parser,&nbsp;I&nbsp;only&nbsp;use&nbsp;a&nbsp;subset&nbsp;of&nbsp;the&nbsp;psp&nbsp;features&nbsp;anyway,&nbsp;so&nbsp;I&nbsp;only&nbsp;needed&nbsp;support&nbsp;for&nbsp;&amp;lt;%%&amp;gt;&nbsp;and&nbsp;&amp;lt;%=%&amp;gt;.&nbsp;&lt;br&gt;&lt;br&gt;The&nbsp;C++&nbsp;code&nbsp;will&nbsp;still&nbsp;run&nbsp;slightly&nbsp;faster&nbsp;I&nbsp;imagine,&nbsp;mostly&nbsp;because&nbsp;the&nbsp;write&nbsp;function&nbsp;is&nbsp;then&nbsp;implemented&nbsp;natively&nbsp;and&nbsp;doesn't&nbsp;have&nbsp;the&nbsp;overhead&nbsp;of&nbsp;python&nbsp;function&nbsp;calls&nbsp;inside&nbsp;the&nbsp;function.&nbsp;Big&nbsp;deal,&nbsp;it&nbsp;wouldn't&nbsp;even&nbsp;be&nbsp;noticed&nbsp;in&nbsp;the&nbsp;face&nbsp;of&nbsp;all&nbsp;the&nbsp;other&nbsp;things&nbsp;going&nbsp;on&nbsp;in&nbsp;serving&nbsp;up&nbsp;a&nbsp;page&nbsp;in&nbsp;mod_python&nbsp;and&nbsp;in&nbsp;running&nbsp;the&nbsp;psp&nbsp;and&nbsp;database&nbsp;queries&nbsp;etc.<br>
&lt;br&gt;&lt;br&gt;So&nbsp;I'm&nbsp;going&nbsp;to&nbsp;leave&nbsp;the&nbsp;C++&nbsp;code&nbsp;now,&nbsp;and&nbsp;do&nbsp;this&nbsp;in&nbsp;Python.&nbsp;I'm&nbsp;just&nbsp;annoyed&nbsp;at&nbsp;myself&nbsp;for&nbsp;having&nbsp;prototyped&nbsp;everything&nbsp;in&nbsp;C++&nbsp;before&nbsp;writing&nbsp;it&nbsp;as&nbsp;python.&nbsp;It&nbsp;shouldn't&nbsp;take&nbsp;me&nbsp;long&nbsp;at&nbsp;least.&lt;br&gt;&lt;br&gt;Thanks&nbsp;a&nbsp;lot&nbsp;for&nbsp;your&nbsp;input!<br>
&lt;br&gt;&lt;br&gt;-Dan&lt;br&gt;&lt;br&gt;&amp;nbsp;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;2/16/06,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Nicolas&nbsp;Lehuen&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:nicolas@lehuen.com&quot;&gt;nicolas@lehuen.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
2006/2/16,&nbsp;Dan&nbsp;Eloff&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:dan.eloff@gmail.com&quot;&gt;dan.eloff@gmail.com&lt;/a&gt;&amp;gt;:&lt;br&gt;&amp;gt;&nbsp;With&nbsp;the&nbsp;same&nbsp;input&nbsp;and&nbsp;outut&nbsp;encoding,&nbsp;there&nbsp;isn't&nbsp;any&nbsp;conversions&nbsp;done&nbsp;to&lt;br&gt;&amp;gt;&nbsp;the&nbsp;static&nbsp;content,&nbsp;because&nbsp;I&nbsp;encode&nbsp;static&nbsp;content&nbsp;directly&nbsp;into&nbsp;the&nbsp;output<br>
&lt;br&gt;&amp;gt;&nbsp;encoding.&nbsp;I've&nbsp;also&nbsp;done&nbsp;things&nbsp;in&nbsp;such&nbsp;a&nbsp;way&nbsp;that&nbsp;regular&nbsp;strings&nbsp;can&nbsp;be&lt;br&gt;&amp;gt;&nbsp;encoded&nbsp;as&nbsp;utf-8&nbsp;without&nbsp;any&nbsp;conversion&nbsp;as&nbsp;well.&nbsp;For&nbsp;now&nbsp;I&nbsp;do&nbsp;this&nbsp;by&lt;br&gt;&amp;gt;&nbsp;assuming&nbsp;the&nbsp;string&nbsp;is&nbsp;ascii&nbsp;and&nbsp;therefore&nbsp;valid&nbsp;utf-8.&nbsp;I'm&nbsp;90%&nbsp;sure&nbsp;that's<br>
&lt;br&gt;&amp;gt;&nbsp;fine,&nbsp;because&nbsp;passing&nbsp;a&nbsp;string&nbsp;in&nbsp;any&nbsp;other&nbsp;encoding&nbsp;is&nbsp;just&nbsp;looking&nbsp;for&lt;br&gt;&amp;gt;&nbsp;trouble,&nbsp;there's&nbsp;no&nbsp;way&nbsp;I&nbsp;can&nbsp;guess&nbsp;what&nbsp;it's&nbsp;encoded&nbsp;as&nbsp;so&nbsp;I&nbsp;could&nbsp;fix&nbsp;it&lt;br&gt;&amp;gt;&nbsp;or&nbsp;raise&nbsp;an&nbsp;error,&nbsp;this&nbsp;puts&nbsp;the&nbsp;responsibility&nbsp;for&nbsp;encoding&nbsp;regular&nbsp;strings<br>
&lt;br&gt;&amp;gt;&nbsp;on&nbsp;the&nbsp;developer,&nbsp;where&nbsp;it&nbsp;should&nbsp;be.&nbsp;But&nbsp;for&nbsp;any&nbsp;other&nbsp;object&nbsp;I&nbsp;convert&nbsp;to&lt;br&gt;&amp;gt;&nbsp;unicode&nbsp;and&nbsp;then&nbsp;encode&nbsp;it&nbsp;with&nbsp;the&nbsp;output&nbsp;encoding.&nbsp;This&nbsp;ensures&lt;br&gt;&amp;gt;&nbsp;__unicode__&nbsp;is&nbsp;called&nbsp;preferentially&nbsp;over&nbsp;__str__.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;&amp;gt;&nbsp;My&nbsp;trouble&nbsp;currently&nbsp;is&nbsp;how&nbsp;to&nbsp;implement&nbsp;the&nbsp;encoding&nbsp;and&nbsp;decoding,&nbsp;the&nbsp;only&lt;br&gt;&amp;gt;&nbsp;part&nbsp;I&nbsp;have&nbsp;working&nbsp;is&nbsp;converting&nbsp;the&nbsp;unicode&nbsp;objects&nbsp;to&nbsp;the&nbsp;output&nbsp;encoding&lt;br&gt;&amp;gt;&nbsp;(by&nbsp;using&nbsp;PyString_AsEncodedObject).&nbsp;I'd&nbsp;like&nbsp;to&nbsp;do&nbsp;the&nbsp;conversion&nbsp;using<br>
&lt;br&gt;&amp;gt;&nbsp;python's&nbsp;encoding/decoding&nbsp;abilites&nbsp;and&nbsp;without&nbsp;creating&nbsp;redundant&nbsp;extra&lt;br&gt;&amp;gt;&nbsp;copies&nbsp;(like&nbsp;those&nbsp;created&nbsp;by&nbsp;copying&nbsp;a&nbsp;char&nbsp;buffer&nbsp;into&nbsp;a&nbsp;python&nbsp;string&nbsp;and&lt;br&gt;&amp;gt;&nbsp;then&nbsp;converting.)&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;I'd&nbsp;love&nbsp;to&nbsp;hear&nbsp;what&nbsp;you&nbsp;think&nbsp;about&nbsp;this,&nbsp;I&nbsp;will&nbsp;send&nbsp;you&nbsp;my&nbsp;code&nbsp;when<br>
&lt;br&gt;&amp;gt;&nbsp;it's&nbsp;finished&nbsp;and&nbsp;you&nbsp;can&nbsp;pull&nbsp;it&nbsp;apart&nbsp;and&nbsp;reuse&nbsp;the&nbsp;bits&nbsp;you&nbsp;like.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;-Dan&lt;br&gt;&lt;br&gt;If&nbsp;you&nbsp;are&nbsp;using&nbsp;the&nbsp;C&nbsp;API,&nbsp;I&nbsp;don't&nbsp;think&nbsp;there&nbsp;are&nbsp;more&nbsp;efficient&lt;br&gt;ways&nbsp;than&nbsp;using&nbsp;PyString_AsEncodedObject&nbsp;and&nbsp;try&nbsp;not&nbsp;to&nbsp;think&nbsp;about<br>
&lt;br&gt;the&nbsp;various&nbsp;extra&nbsp;objects&nbsp;that&nbsp;are&nbsp;created&nbsp;in&nbsp;the&nbsp;process...&lt;br&gt;&lt;br&gt;In-place&nbsp;unicode&nbsp;to&nbsp;string&nbsp;conversion&nbsp;is&nbsp;quite&nbsp;difficult&nbsp;to&nbsp;achieve,&lt;br&gt;because&nbsp;in&nbsp;the&nbsp;general&nbsp;case&nbsp;you&nbsp;may&nbsp;end&nbsp;up&nbsp;with&nbsp;more&nbsp;bytes&nbsp;than&lt;br&gt;unicode&nbsp;characters.&nbsp;The&nbsp;Java&nbsp;NIO&nbsp;library&nbsp;doesn't&nbsp;encode&nbsp;nor&nbsp;decode<br>
&lt;br&gt;in-place,&nbsp;and&nbsp;given&nbsp;the&nbsp;efforts&nbsp;they&nbsp;made&nbsp;to&nbsp;remove&nbsp;data&nbsp;copy,&nbsp;I&nbsp;think&lt;br&gt;it's&nbsp;pretty&nbsp;safe&nbsp;to&nbsp;say&nbsp;that's&nbsp;it's&nbsp;not&nbsp;easily&nbsp;feasable.&lt;br&gt;&lt;br&gt;I&nbsp;really&nbsp;think&nbsp;you&nbsp;should&nbsp;first&nbsp;worry&nbsp;about&nbsp;having&nbsp;the&nbsp;input&nbsp;and&lt;br&gt;output&nbsp;coding&nbsp;right,&nbsp;then&nbsp;profile&nbsp;your&nbsp;code&nbsp;to&nbsp;see&nbsp;where&nbsp;the<br>
&lt;br&gt;performance&nbsp;problems&nbsp;are.&nbsp;Most&nbsp;likely,&nbsp;you'll&nbsp;find&nbsp;that&nbsp;they&nbsp;are&nbsp;in&lt;br&gt;mod_python&nbsp;rather&nbsp;than&nbsp;in&nbsp;the&nbsp;psp&nbsp;module&nbsp;;).&lt;br&gt;&lt;br&gt;To&nbsp;me,&nbsp;the&nbsp;fact&nbsp;that&nbsp;PSP&nbsp;is&nbsp;implemented&nbsp;in&nbsp;C&nbsp;is&nbsp;a&nbsp;perfect&nbsp;case&nbsp;of&lt;br&gt;premature&nbsp;optimisation.&nbsp;It's&nbsp;a&nbsp;quite&nbsp;complicated&nbsp;piece&nbsp;of&nbsp;C&nbsp;code,<br>
&lt;br&gt;parts&nbsp;of&nbsp;it&nbsp;being&nbsp;generated&nbsp;by&nbsp;flex.&nbsp;As&nbsp;a&nbsp;result,&nbsp;it's&nbsp;difficult&nbsp;to&lt;br&gt;maintain&nbsp;and&nbsp;solving&nbsp;the&nbsp;Unicode&nbsp;issues&nbsp;in&nbsp;this&nbsp;context&nbsp;could&nbsp;be&nbsp;quite&lt;br&gt;difficult.&nbsp;And&nbsp;it's&nbsp;not&nbsp;like&nbsp;it's&nbsp;proven&nbsp;that&nbsp;writing&nbsp;this&nbsp;module&nbsp;in&lt;br&gt;<br>
pure&nbsp;C&nbsp;is&nbsp;really&nbsp;useful&nbsp;as&nbsp;far&nbsp;as&nbsp;global&nbsp;performance&nbsp;are&nbsp;concerned.&lt;br&gt;&lt;br&gt;If&nbsp;it&nbsp;were&nbsp;up&nbsp;to&nbsp;me,&nbsp;I&nbsp;would&nbsp;reimplement&nbsp;it&nbsp;in&nbsp;pure&nbsp;Python,&nbsp;and&nbsp;I&lt;br&gt;don't&nbsp;think&nbsp;the&nbsp;performance&nbsp;loss&nbsp;would&nbsp;be&nbsp;so&nbsp;big.&nbsp;Granted,&nbsp;compilation&lt;br&gt;would&nbsp;be&nbsp;a&nbsp;little&nbsp;slower,&nbsp;but&nbsp;once&nbsp;the&nbsp;PSP&nbsp;is&nbsp;compiled,&nbsp;performance<br>
&lt;br&gt;should&nbsp;be&nbsp;exactly&nbsp;the&nbsp;same&nbsp;-&nbsp;and&nbsp;implementing&nbsp;a&nbsp;compiler&nbsp;cache&nbsp;is&lt;br&gt;extremely&nbsp;easy.&nbsp;Plus,&nbsp;the&nbsp;code&nbsp;being&nbsp;more&nbsp;easy&nbsp;to&nbsp;maintain,&nbsp;we&nbsp;could&lt;br&gt;easily&nbsp;optimize&nbsp;it.&nbsp;Call&nbsp;it&nbsp;&amp;quot;doing&nbsp;it&nbsp;the&nbsp;PyPy&nbsp;way&amp;quot;&nbsp;if&nbsp;you&nbsp;like&nbsp;;).<br>
&lt;br&gt;&lt;br&gt;Regards,&lt;br&gt;Nicolas&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
