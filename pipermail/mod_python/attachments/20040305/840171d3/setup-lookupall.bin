--- dist.orig/setup.py.in	2003-07-24 19:46:09.000000000 +0200
+++ dist/setup.py.in	2004-03-05 10:10:47.000000000 +0200
@@ -1,50 +1,85 @@
 
 # $Id: setup.py.in,v 1.5 2003/07/24 17:46:09 grisha Exp $
 
-APXS = r"@APXS@"
-VER = "@MP_VERSION@"
-
 from distutils.core import setup, Extension
 
 import sys
+import re
+import os.path
 
-if len(sys.argv) > 1 and sys.argv[1] == "bdist_wininst":
-    moddir = ""
-#    mpso = "mod_python.so"
+def getconfigure_option(option_name):
+  """gets an option from the config.status file"""
+  config_status_file = os.path.join(os.path.dirname(__file__), '..', 'config.status')
+  if not os.path.exists(config_status_file):
+    raise AssertionError("config.status not found in expected location (%s)" % config_status_file)
+  header = open(config_status_file,'r')
+  r = re.compile('s,@%s@,(?P<OPTION_STRING>[^,]+),' % (option_name))
+  for line in header.readlines():
+    m = r.search(line)
+    if m is not None:
+      return m.group('OPTION_STRING')
+  raise AssertionError("unable to find @%s@ definition in %s", (option_name, config_status_file))
+
+def getmp_version():
+  """finds out the version of mod_python"""
+  # first try and get it from configure...
+  try:
+    return getconfigure_option("MP_VERSION")
+  except AssertionError:
+    pass
+  # if that fails, read it from the source file ourselves...
+  mpversion_file = os.path.join(os.path.dirname(__file__), '..', 'src', 'include', 'mpversion.h')
+  if not os.path.exists(mpversion_file):
+    raise AssertionError("mpversion.h not found in expected location (%s)" % mpversion_file)
+  header = open(mpversion_file,'r')
+  r = re.compile('#define\s+MPV_STRING\s+"(?P<MPV_STRING>[^"]+)"')
+  for line in header.readlines():
+    m = r.search(line)
+    if m is not None:
+      return m.group('MPV_STRING')
+  raise AssertionError("unable to find MPV_STRING in %s", mpversion_file)
+
+def getapxs_location():
+  """finds the location of apxs from the config.status file"""
+  return getconfigure_option("APXS")
 
-    setup(name="mod_python",
-          version=VER,
-          description="Apache/Python Integration",
-          author="Gregory Trubetskoy et al",
-          author_email="mod_python@modpython.org",
-          url="http://www.modpython.org/",
-          packages=["mod_python"],
-          package_dir = {"mod_python":"../lib/python/mod_python"},
-          scripts=["win32_postinstall.py"],
-          data_files=[(moddir, ["mod_python.so"])])
+VER = getmp_version()
 
-else:
-#    import commands
-#    moddir = commands.getoutput("%s -q LIBEXECDIR" % APXS)
-#    mpso = "../src/mod_python.so"
-
-    setup(name="mod_python",
-          version=VER,
-          description="Apache/Python Integration",
-          author="Gregory Trubetskoy et al",
-          author_email="mod_python@modpython.org",
-          url="http://www.modpython.org/",
-          packages=["mod_python"],
-          ext_modules=[Extension("mod_python._psp",
-                                 ["src/psp_string.c",
-                                  "src/psp_parser.c",
-                                  "src/_pspmodule.c"],
-                                 include_dirs=["src/include"]
-                                 )
-                       ]
-          )
-          
+winbuild = (len(sys.argv) > 1 and sys.argv[1] == "bdist_wininst")
 
+if winbuild:
+    moddir = ""
+    package_dir = {"mod_python":"../lib/python/mod_python"}
+    scripts = ["win32_postinstall.py"]
+    data_files = [(moddir, ["mod_python.so"])]
+    ext_modules = []
+else:
+    # import commands
+    # APXS = getapxs_location()
+    # moddir = commands.getoutput("%s -q LIBEXECDIR" % APXS)
+    # mpso = "../src/mod_python.so"
+    package_dir = {}
+    scripts = []
+    data_files = []
+    ext_modules=[Extension("mod_python._psp",
+                           ["src/psp_string.c",
+                            "src/psp_parser.c",
+                            "src/_pspmodule.c"],
+                           include_dirs=["src/include"]
+                           )
+                 ]
+
+setup(name="mod_python",
+      version=VER,
+      description="Apache/Python Integration",
+      author="Gregory Trubetskoy et al",
+      author_email="mod_python@modpython.org",
+      url="http://www.modpython.org/",
+      packages=["mod_python"],
+      package_dir=package_dir,
+      scripts=scripts,
+      data_files=data_files,
+      ext_modules=ext_modules)
 
 # makes emacs go into python mode
 ### Local Variables:
