<tt>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2008/4/17&nbsp;Graham&nbsp;Dumpleton&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:graham.dumpleton@gmail.com&quot;&gt;graham.dumpleton@gmail.com&lt;/a&gt;&amp;gt;:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
2008/4/17&nbsp;Rados≈Çaw&nbsp;Rymaszewski&nbsp;&amp;lt;rrymaszewski@contentforces.pl&amp;gt;:&lt;br&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Wj3C7c&quot;&gt;&amp;gt;&nbsp;Hello&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;I&nbsp;was&nbsp;trying&nbsp;to&nbsp;find&nbsp;out&nbsp;solution&nbsp;for&nbsp;my&nbsp;problem&nbsp;but&nbsp;there&nbsp;were&nbsp;no&nbsp;answers,&lt;br&gt;<br>
&amp;gt;&nbsp;so&nbsp;I&nbsp;decided&nbsp;to&nbsp;write&nbsp;here.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;We&nbsp;are&nbsp;using&nbsp;mod_python&nbsp;filters&nbsp;for&nbsp;our&nbsp;system&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Infrastructure&nbsp;description:&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;INTERNET&nbsp;&amp;lt;---&amp;gt;&nbsp;APACHE&nbsp;2.8.3&nbsp;with&nbsp;mod_python&nbsp;3.3.1&nbsp;+&nbsp;output&nbsp;filters&nbsp;&amp;lt;--&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Apache&nbsp;proxy&nbsp;module&nbsp;&amp;lt;--&amp;gt;&nbsp;TOMCAT&nbsp;5.5.2x&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;our&nbsp;filters&nbsp;concat&nbsp;chunked&nbsp;content&nbsp;from&nbsp;tomcat&nbsp;and&nbsp;write&nbsp;to&nbsp;client&nbsp;whole&lt;br&gt;<br>
&amp;gt;&nbsp;changed&nbsp;content.&nbsp;It&amp;#39;s&nbsp;important&nbsp;for&nbsp;us&nbsp;to&nbsp;get&nbsp;whole&nbsp;response&nbsp;from&nbsp;tomcat&nbsp;and&lt;br&gt;<br>
&amp;gt;&nbsp;after&nbsp;it&nbsp;process.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;problem&nbsp;is&nbsp;when&nbsp;filter.read()&nbsp;reach&nbsp;last&nbsp;byte&nbsp;(filter.read()&nbsp;==&nbsp;None)&nbsp;then&lt;br&gt;<br>
&amp;gt;&nbsp;there&nbsp;is&nbsp;no&nbsp;possibility&nbsp;to&nbsp;overwrite&nbsp;request&nbsp;headers.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;There&nbsp;is&nbsp;no&nbsp;such&nbsp;problem&nbsp;during&nbsp;reading&nbsp;content&nbsp;and&nbsp;when&nbsp;we&nbsp;serve&nbsp;static&lt;br&gt;<br>
&amp;gt;&nbsp;pages&nbsp;from&nbsp;apache&nbsp;www&nbsp;server.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;mod_python&nbsp;receive&nbsp;such&nbsp;headers&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;1&nbsp;chunk&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;[Wed&nbsp;Apr&nbsp;16&nbsp;05:52:15&nbsp;2008]&nbsp;[error]&nbsp;{&amp;#39;Via&amp;#39;:&nbsp;&amp;#39;1.1&nbsp;domain&amp;#39;,&nbsp;&amp;#39;Set-Cookie&amp;#39;:&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;JSESSIONID=sessionXXX;&nbsp;Path=/path&amp;#39;,&nbsp;&amp;#39;Date&amp;#39;:&nbsp;&amp;#39;Fri,&nbsp;18&nbsp;Apr&nbsp;2008&nbsp;19:47:06&lt;br&gt;<br>
&amp;gt;&nbsp;GMT&amp;#39;,&nbsp;&amp;#39;Cache-Control&amp;#39;:&nbsp;&amp;#39;no-store&amp;#39;,&nbsp;&amp;#39;Cache-Control&amp;#39;:&nbsp;&amp;#39;no-cache&amp;#39;,&nbsp;&amp;#39;Expires&amp;#39;:&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;Thu,&nbsp;01&nbsp;Jan&nbsp;1970&nbsp;00:00:00&nbsp;GMT&amp;#39;,&nbsp;&amp;#39;Pragma&amp;#39;:&nbsp;&amp;#39;No-cache&amp;#39;,&nbsp;&amp;#39;Server&amp;#39;:&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;Apache-Coyote&amp;#39;}&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;2&nbsp;chunk&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;[Wed&nbsp;Apr&nbsp;16&nbsp;05:52:15&nbsp;2008]&nbsp;[error]&nbsp;{&amp;#39;Content-Type&amp;#39;:&nbsp;&amp;#39;text/plain&amp;#39;,&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;Transfer-Encoding&amp;#39;:&nbsp;&amp;#39;chunked&amp;#39;,&nbsp;&amp;#39;Connection&amp;#39;:&nbsp;&amp;#39;Keep-Alive&amp;#39;,&nbsp;&amp;#39;Keep-Alive&amp;#39;:&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;timeout=15,&nbsp;max=100&amp;#39;,&nbsp;&amp;#39;Via&amp;#39;:&nbsp;&amp;#39;1.1&nbsp;domain&amp;#39;,&nbsp;&amp;#39;Set-Cookie&amp;#39;:&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;JSESSIONID=sessionXXX;&nbsp;Path=/path&amp;#39;,&nbsp;&amp;#39;Cache-Control&amp;#39;:&nbsp;&amp;#39;No-cache&amp;#39;,&nbsp;&amp;#39;Expires&amp;#39;:&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;0&amp;#39;,&nbsp;&amp;#39;Pragma&amp;#39;:&nbsp;&amp;#39;No-cache&amp;#39;}&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;3&nbsp;chunk&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;nbsp;[Wed&nbsp;Apr&nbsp;16&nbsp;05:52:15&nbsp;2008]&nbsp;[error]&nbsp;{&amp;#39;Content-Type&amp;#39;:&nbsp;&amp;#39;text/plain&amp;#39;,&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;Transfer-Encoding&amp;#39;:&nbsp;&amp;#39;chunked&amp;#39;,&nbsp;&amp;#39;Connection&amp;#39;:&nbsp;&amp;#39;Keep-Alive&amp;#39;,&nbsp;&amp;#39;Keep-Alive&amp;#39;:&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;timeout=15,&nbsp;max=100&amp;#39;,&nbsp;&amp;#39;Via&amp;#39;:&nbsp;&amp;#39;1.1&nbsp;domain&amp;#39;,&nbsp;&amp;#39;Set-Cookie&amp;#39;:&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;JSESSIONID=sessionXXX;&nbsp;Path=/path&amp;#39;,&nbsp;&amp;#39;Cache-Control&amp;#39;:&nbsp;&amp;#39;No-cache&amp;#39;,&nbsp;&amp;#39;Expires&amp;#39;:&lt;br&gt;<br>
&amp;gt;&nbsp;&amp;#39;0&amp;#39;,&nbsp;&amp;#39;Pragma&amp;#39;:&nbsp;&amp;#39;No-cache&amp;#39;}&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;when&nbsp;I&nbsp;finish&nbsp;process&nbsp;on&nbsp;first&nbsp;or&nbsp;second&nbsp;chunk&nbsp;I&nbsp;can&nbsp;modify&nbsp;headers&nbsp;without&lt;br&gt;<br>
&amp;gt;&nbsp;any&nbsp;problems.&nbsp;after&nbsp;third&nbsp;one&nbsp;there&nbsp;is&nbsp;no&nbsp;such&nbsp;possibility&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;Do&nbsp;You&nbsp;know&nbsp;what&nbsp;could&nbsp;be&nbsp;wrong&nbsp;?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;As&nbsp;soon&nbsp;as&nbsp;any&nbsp;filter&nbsp;following&nbsp;yours&nbsp;has&nbsp;caused&nbsp;any&nbsp;chunk&nbsp;of&nbsp;data&nbsp;to&lt;br&gt;<br>
be&nbsp;written&nbsp;back&nbsp;to&nbsp;client,&nbsp;it&nbsp;is&nbsp;too&nbsp;late&nbsp;to&nbsp;change&nbsp;headers.&nbsp;This&nbsp;is&lt;br&gt;<br>
because&nbsp;headers&nbsp;are&nbsp;sent&nbsp;before&nbsp;the&nbsp;data.&lt;br&gt;<br>
&lt;br&gt;<br>
Thus,&nbsp;headers&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably&nbsp;changed&nbsp;upon&nbsp;reading&nbsp;first&nbsp;chunk&lt;br&gt;<br>
and&nbsp;before&nbsp;it&nbsp;is&nbsp;written&nbsp;to&nbsp;next&nbsp;filter.&nbsp;Only&nbsp;other&nbsp;choice&nbsp;is&nbsp;to&lt;br&gt;<br>
buffer&nbsp;the&nbsp;whole&nbsp;content&nbsp;in&nbsp;your&nbsp;filter,&nbsp;fixup&nbsp;any&nbsp;headers&nbsp;based&nbsp;on&lt;br&gt;<br>
that&nbsp;content&nbsp;and&nbsp;then&nbsp;write&nbsp;the&nbsp;whole&nbsp;content.&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;thank&nbsp;You&nbsp;for&nbsp;your&nbsp;reply.&lt;br&gt;<br>
&lt;br&gt;Tomcat&nbsp;content&nbsp;is&nbsp;buffered&nbsp;as&nbsp;You&nbsp;see&nbsp;below.&lt;br&gt;&lt;br&gt;Could&nbsp;You&nbsp;explain&nbsp;in&nbsp;which&nbsp;place&nbsp;in&nbsp;code&nbsp;below<br>
headers&nbsp;are&nbsp;send&nbsp;to&nbsp;client&amp;nbsp;&nbsp;?&nbsp;I&nbsp;thought&nbsp;that&nbsp;in&nbsp;same&nbsp;time&nbsp;when<br>
script&nbsp;execute&nbsp;filter.write(),&nbsp;because&nbsp;client&nbsp;always&nbsp;get&nbsp;header&nbsp;from&nbsp;last&nbsp;chunk&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;try:&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;buffer&nbsp;=&nbsp;filter.req.buffer&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;except&nbsp;AttributeError:&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;filter.req.buffer&nbsp;=&nbsp;Buffer()&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;buffer&nbsp;=&nbsp;filter.req.buffer&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;s=filter.read()&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;while&nbsp;s:&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;buffer.append(s)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;s=filter.read()&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;s&nbsp;is&nbsp;None:&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;filter.req.headers_out[&lt;div&nbsp;id=&quot;1gvz&quot;&nbsp;class=&quot;ArwC7c&nbsp;ckChnd&quot;&gt;&amp;#39;content-type&amp;#39;]&nbsp;=&nbsp;&amp;quot;text/html;&nbsp;charset=UTF-8&amp;quot;&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;filter.req.headers_out[&amp;#39;content-length&amp;#39;]&nbsp;=&nbsp;str(len(buffer.string))&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;filter.req.content_type&nbsp;=&nbsp;&amp;quot;text/html;&nbsp;charset=UTF-8&amp;quot;&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;filter.req.set_content_length(len(buffer.string))&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;data&nbsp;=&nbsp;buffer.string&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;else:&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;filter.write(data)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;filter.close()&lt;br&gt;&lt;br&gt;br&lt;br&gt;--&lt;br&gt;Radoslaw&nbsp;Rymaszewski&lt;br&gt;&lt;/div&gt;&amp;nbsp;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;
</tt>
