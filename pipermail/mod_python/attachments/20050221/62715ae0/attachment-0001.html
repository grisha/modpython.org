<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.01&nbsp;Transitional//EN&quot;&gt;<br>
&lt;html&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;charset=ISO-8859-1&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
I&nbsp;have&nbsp;a&nbsp;custom&nbsp;handler&nbsp;that&nbsp;i&nbsp;have&nbsp;built&nbsp;that&nbsp;calls&nbsp;instantiates&nbsp;a&nbsp;web<br>
application&nbsp;framework&nbsp;I&nbsp;have&nbsp;written&nbsp;and&nbsp;asks&nbsp;it&nbsp;process&nbsp;the&nbsp;request.&amp;nbsp;<br>
Since&nbsp;this&nbsp;web&nbsp;app&nbsp;framework&nbsp;originally&nbsp;was&nbsp;designed&nbsp;for&nbsp;CGI&nbsp;and&nbsp;was<br>
used&nbsp;in&nbsp;CGI,&nbsp;I&nbsp;am&nbsp;calling&nbsp;the&nbsp;apache.setup_cgi()&nbsp;to&nbsp;make&nbsp;the&nbsp;env<br>
seamless&nbsp;for&nbsp;the&nbsp;framework.&amp;nbsp;&nbsp;I&nbsp;am&nbsp;running&nbsp;this&nbsp;under&nbsp;a&nbsp;multithreaded<br>
mpm&nbsp;apache&nbsp;configuration&nbsp;and&nbsp;am&nbsp;running&nbsp;into&nbsp;problems&nbsp;with&nbsp;race<br>
conditions&nbsp;with&nbsp;multiple&nbsp;threads&nbsp;accessing&nbsp;shared&nbsp;resources&nbsp;in&nbsp;memory.&lt;br&gt;<br>
&lt;br&gt;<br>
Since&nbsp;my&nbsp;customer&nbsp;handler&nbsp;kind&nbsp;of&nbsp;resembles&nbsp;the&nbsp;provided&nbsp;cgihandler<br>
which&nbsp;is&nbsp;not&nbsp;suited&nbsp;for&nbsp;a&nbsp;multithreaded&nbsp;env,&nbsp;I&nbsp;am&nbsp;wondering&nbsp;I&nbsp;am&nbsp;right<br>
in&nbsp;doing&nbsp;the&nbsp;apache.setup_cgi()&nbsp;like&nbsp;I&nbsp;am.&amp;nbsp;&nbsp;My&nbsp;handler&nbsp;code&nbsp;looks&nbsp;like<br>
as&nbsp;follows:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&gt;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;def&nbsp;handler(req):&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#_lock.acquire()&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#try:&amp;nbsp;&amp;nbsp;&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#&nbsp;setup&nbsp;the&nbsp;cgi&nbsp;environment&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;env,&nbsp;si,&nbsp;so&nbsp;=&nbsp;apache.setup_cgi(req)&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#&nbsp;write&nbsp;the&nbsp;content&nbsp;type&nbsp;for&nbsp;testing<br>
purposes&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#sys.stdout.write(&quot;content-type:<br>
text/html\r\n\r\n&quot;)&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;cache&nbsp;=&nbsp;req.get_options().get(&quot;CACHE&quot;,<br>
&quot;Off&quot;)&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;cache&nbsp;==&nbsp;&quot;Off&quot;:&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;cache&nbsp;=&nbsp;0&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;try:&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#&nbsp;load&nbsp;the&nbsp;driver&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;driver&nbsp;=<br>
GlobalCache.getCachedItem(&quot;Driver&quot;)&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;not&nbsp;driver:&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;driver&nbsp;=&nbsp;Driver([&quot;./Driver.py&quot;],<br>
cache_projects=cache,&nbsp;modpy_req=req)&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#&nbsp;cache&nbsp;if&nbsp;we&nbsp;have&nbsp;caching&nbsp;objects<br>
turned&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;cache:&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;<br>
GlobalCache.setCachedItem(&quot;Driver&quot;,driver)&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#&nbsp;process&nbsp;the&nbsp;request&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;driver.process()&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;except:&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;pass&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;apache.restore_nocgi(env,&nbsp;si,&nbsp;so)&nbsp;&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;apache.OK&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#finally:&lt;/font&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;_lock.release()&lt;/font&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
Any&nbsp;help&nbsp;would&nbsp;be&nbsp;appreciated.&amp;nbsp;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
Hozi&lt;br&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
