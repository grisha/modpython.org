<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.01&nbsp;Transitional//EN&quot;&gt;<br>
&lt;html&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;charset=ISO-8859-1&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
Folks--&lt;br&gt;<br>
&lt;br&gt;<br>
I'm&nbsp;having&nbsp;a&nbsp;problem&nbsp;embedding&nbsp;Berkeley&nbsp;DB&nbsp;XML&nbsp;into&nbsp;Apache&nbsp;with<br>
mod_python.&nbsp;The&nbsp;first&nbsp;attempt&nbsp;to&nbsp;create&nbsp;an&nbsp;XmlManager&nbsp;causes&nbsp;a&nbsp;lockup<br>
in&nbsp;Python--the&nbsp;Global&nbsp;Interpreter&nbsp;Lock&nbsp;is&nbsp;deadlocked,&nbsp;I&nbsp;think.&nbsp;(Stack<br>
trace&nbsp;below.)&nbsp;Any&nbsp;ideas&nbsp;of&nbsp;how&nbsp;to&nbsp;debug?&nbsp;Is&nbsp;there&nbsp;a&nbsp;BDB&nbsp;XML&nbsp;Python<br>
expert?&nbsp;I&nbsp;checked&nbsp;Google&nbsp;without&nbsp;success.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;code&nbsp;to&nbsp;demonstrate&nbsp;the&nbsp;problem&nbsp;is&nbsp;simple&nbsp;and&nbsp;shown&nbsp;below.&nbsp;When&nbsp;the<br>
line&nbsp;&quot;xmlManager&nbsp;=&nbsp;dbxml.XmlManager()&quot;&nbsp;is&nbsp;commented&nbsp;out,&nbsp;the&nbsp;code&nbsp;runs<br>
ok.&nbsp;Commented&nbsp;in,&nbsp;Apache&nbsp;locks&nbsp;up.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;most&nbsp;recent&nbsp;mod_python&nbsp;has&nbsp;this&nbsp;comment&nbsp;at<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;<br>
&nbsp;href=&quot;http://www.modpython.org/live/mod_python-3.3.1/doc-html/app-changes.html:&quot;&gt;http://www.modpython.org/live/mod_python-3.3.1/doc-html/app-changes.html:&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&gt;Third&nbsp;party&nbsp;C&nbsp;modules&nbsp;that&nbsp;use&nbsp;the&nbsp;simplified&nbsp;API&nbsp;for&nbsp;the<br>
Global&nbsp;Interpreter&nbsp;Lock&nbsp;(GIL),&nbsp;as&nbsp;described&nbsp;in&nbsp;PEP&nbsp;311,&nbsp;can&nbsp;now&nbsp;be<br>
used.&nbsp;The&nbsp;only&nbsp;requirement&nbsp;is&nbsp;that&nbsp;such&nbsp;modules&nbsp;can&nbsp;only&nbsp;be&nbsp;used&nbsp;in&nbsp;the<br>
context&nbsp;of&nbsp;the&nbsp;&quot;main_interpreter&quot;.&nbsp;&lt;i&gt;(More&nbsp;info&nbsp;at<br>
&nbsp;&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;<br>
&nbsp;href=&quot;http://issues.apache.org/jira/browse/MODPYTHON-77&quot;&gt;http://issues.apache.org/jira/browse/MODPYTHON-77&lt;/a&gt;.)&lt;/i&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
The&nbsp;documentation&nbsp;for&nbsp;mod_python&nbsp;at<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;<br>
&nbsp;href=&quot;http://www.modpython.org/live/current/doc-html/pyapi-interps.html&quot;&gt;http://www.modpython.org/live/current/doc-html/pyapi-interps.html&lt;/a&gt;<br>
says:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&gt;Note&nbsp;that&nbsp;if&nbsp;any&nbsp;third&nbsp;party&nbsp;module&nbsp;is&nbsp;being&nbsp;used&nbsp;which&nbsp;has<br>
a&nbsp;C&nbsp;code&nbsp;component&nbsp;that&nbsp;uses&nbsp;the&nbsp;simplified&nbsp;API&nbsp;for&nbsp;access&nbsp;to&nbsp;the<br>
Global&nbsp;Interpreter&nbsp;Lock&nbsp;(GIL)&nbsp;for&nbsp;Python&nbsp;extension&nbsp;modules,&nbsp;then&nbsp;the<br>
interpreter&nbsp;name&nbsp;must&nbsp;be&nbsp;forcibly&nbsp;set&nbsp;to&nbsp;be&nbsp;&quot;main_interpreter&quot;.&nbsp;This&nbsp;is<br>
necessary&nbsp;as&nbsp;such&nbsp;a&nbsp;module&nbsp;will&nbsp;only&nbsp;work&nbsp;correctly&nbsp;if&nbsp;run&nbsp;within&nbsp;the<br>
context&nbsp;of&nbsp;the&nbsp;first&nbsp;Python&nbsp;interpreter&nbsp;created&nbsp;by&nbsp;the&nbsp;process.&nbsp;&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
Conforming&nbsp;to&nbsp;this,&nbsp;I&nbsp;set&nbsp;the&nbsp;interpreter&nbsp;name&nbsp;in&nbsp;the&nbsp;httpd.conf&nbsp;file<br>
using&nbsp;the&nbsp;directive&nbsp;&quot;PythonInterpreter&nbsp;main_interpreter&quot;&nbsp;and&nbsp;I&nbsp;verified<br>
this&nbsp;by&nbsp;printing&nbsp;the&nbsp;interpreter&nbsp;name&nbsp;from&nbsp;my&nbsp;Python&nbsp;code.&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;dbxml-2.3.10/dbxml/src/python,&nbsp;there's&nbsp;some&nbsp;code&nbsp;relating&nbsp;to&nbsp;the&nbsp;GIL<br>
in&nbsp;dbxml_python_wrap.cpp.&nbsp;If&nbsp;someone&nbsp;else&nbsp;has&nbsp;already&nbsp;beaten&nbsp;this<br>
problem&nbsp;into&nbsp;submission,&nbsp;I'd&nbsp;rather&nbsp;not&nbsp;duplicate&nbsp;the&nbsp;effort.&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&nbsp;--&nbsp;David&nbsp;Schachter&lt;br&gt;<br>
&lt;br&gt;<br>
#!&nbsp;/usr/bin/python&lt;br&gt;<br>
&lt;br&gt;<br>
import&nbsp;dbxml&lt;br&gt;<br>
from&nbsp;mod_python&nbsp;import&nbsp;apache&lt;br&gt;<br>
import&nbsp;os&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
def&nbsp;handler(req):&lt;br&gt;<br>
&amp;nbsp;&nbsp;id&nbsp;=&nbsp;&quot;pid&nbsp;%d,&nbsp;interpreter&nbsp;'%s'&quot;&nbsp;%&nbsp;(os.getpid(),&nbsp;req.interpreter)&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;nbsp;&nbsp;apache.log_error(&quot;About&nbsp;to&nbsp;start&nbsp;BDB&nbsp;XML&nbsp;from&nbsp;%s.&quot;&nbsp;%&nbsp;id)&lt;br&gt;<br>
&amp;nbsp;&nbsp;xmlManager&nbsp;=&nbsp;dbxml.XmlManager()&lt;br&gt;<br>
&amp;nbsp;&nbsp;apache.log_error(&quot;Started&nbsp;BDB&nbsp;XML.&quot;)&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;nbsp;&nbsp;req.write(&quot;Hi&nbsp;from&nbsp;%s.&quot;&nbsp;%&nbsp;id)&lt;br&gt;<br>
&amp;nbsp;&nbsp;return&nbsp;apache.OK&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
STACK&nbsp;TRACE&nbsp;IS:&lt;br&gt;<br>
&lt;br&gt;<br>
(gdb)&nbsp;bt&lt;br&gt;<br>
#0&amp;nbsp;&nbsp;0xffffe410&nbsp;in&nbsp;__kernel_vsyscall&nbsp;()&lt;br&gt;<br>
#1&amp;nbsp;&nbsp;0xb7e97af0&nbsp;in&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;<br>
&nbsp;href=&quot;mailto:sem_wait@GLIBC_2.0&quot;&gt;sem_wait@GLIBC_2.0&lt;/a&gt;&nbsp;()&nbsp;from<br>
/lib/tls/i686/cmov/libpthread.so.0&lt;br&gt;<br>
#2&amp;nbsp;&nbsp;0x00000004&nbsp;in&nbsp;??&nbsp;()&lt;br&gt;<br>
#3&amp;nbsp;&nbsp;0xb7ce7a00&nbsp;in&nbsp;PyThread_acquire_lock&nbsp;(lock=0x0,&nbsp;waitflag=1)&nbsp;at<br>
thread_pthread.h:298&lt;br&gt;<br>
#4&amp;nbsp;&nbsp;0xb7cb5689&nbsp;in&nbsp;PyEval_RestoreThread&nbsp;(tstate=0x810f888)&nbsp;at<br>
Python/ceval.c:305&lt;br&gt;<br>
#5&amp;nbsp;&nbsp;0xb7ce16e7&nbsp;in&nbsp;&lt;font&nbsp;color=&quot;#ff0000&quot;&gt;PyGILState_Ensure&nbsp;()&lt;/font&gt;&nbsp;at<br>
Python/pystate.c:512&lt;br&gt;<br>
#6&amp;nbsp;&nbsp;0xb78282f9&nbsp;in&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;_wrap_new_XmlManager&lt;/font&gt;<br>
(self=0x0,&nbsp;args=0xb7b9102c)&nbsp;at&nbsp;dbxml_python_wrap.cpp:898&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;font&nbsp;color=&quot;#3366ff&quot;&gt;(The&nbsp;reference&nbsp;to&nbsp;line&nbsp;898&nbsp;is&nbsp;correct&nbsp;but<br>
surprising,&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;macro&nbsp;expansion&nbsp;at&nbsp;line&nbsp;4195.&nbsp;--D.S.)&lt;/font&gt;&lt;br&gt;<br>
#7&amp;nbsp;&nbsp;0xb7c65967&nbsp;in&nbsp;PyObject_Call&nbsp;(func=0x0,&nbsp;arg=0xfffffffc,<br>
kw=0xfffffffc)&nbsp;at&nbsp;Objects/abstract.c:1795&lt;br&gt;<br>
#8&amp;nbsp;&nbsp;0xb7cb9e1d&nbsp;in&nbsp;PyEval_EvalFrame&nbsp;(f=0x822cdbc)&nbsp;at&nbsp;Python/ceval.c:3845&lt;br&gt;<br>
#9&amp;nbsp;&nbsp;0xb7cbd719&nbsp;in&nbsp;PyEval_EvalCodeEx&nbsp;(co=0xb6b12e20,&nbsp;globals=0xfffffffc,<br>
locals=0x0,&nbsp;args=0x0,&nbsp;argcount=1,&nbsp;&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;kws=0x0,&nbsp;kwcount=0,&nbsp;defs=0x0,&nbsp;defcount=0,&nbsp;closure=0x0)&nbsp;at<br>
Python/ceval.c:2741&lt;br&gt;<br>
#10&nbsp;0xb7d0d6be&nbsp;in&nbsp;function_call&nbsp;(func=0xb6b0902c,&nbsp;arg=0xb6b892ac,<br>
kw=0x0)&nbsp;at&nbsp;Objects/funcobject.c:548&lt;br&gt;<br>
#11&nbsp;0xb7c65967&nbsp;in&nbsp;PyObject_Call&nbsp;(func=0x0,&nbsp;arg=0xfffffffc,<br>
kw=0xfffffffc)&nbsp;at&nbsp;Objects/abstract.c:1795&lt;br&gt;<br>
#12&nbsp;0xb7c6e389&nbsp;in&nbsp;instancemethod_call&nbsp;(func=0xfffffffc,&nbsp;arg=0xb6b892ac,<br>
kw=0xfffffffc)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;at&nbsp;Objects/classobject.c:2532&lt;br&gt;<br>
#13&nbsp;0xb7c65967&nbsp;in&nbsp;PyObject_Call&nbsp;(func=0x0,&nbsp;arg=0xfffffffc,<br>
kw=0xfffffffc)&nbsp;at&nbsp;Objects/abstract.c:1795&lt;br&gt;<br>
#14&nbsp;0xb7c99728&nbsp;in&nbsp;slot_tp_init&nbsp;(self=0xb6af1fac,&nbsp;args=0xfffffffc,<br>
kwds=0xfffffffc)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;at&nbsp;Objects/typeobject.c:4774&lt;br&gt;<br>
#15&nbsp;0xb7c91ad4&nbsp;in&nbsp;type_call&nbsp;(type=0xb7c99675,&nbsp;args=0xb7b9102c,<br>
kwds=0x0)&nbsp;at&nbsp;Objects/typeobject.c:435&lt;br&gt;<br>
#16&nbsp;0xb7c65967&nbsp;in&nbsp;PyObject_Call&nbsp;(func=0x0,&nbsp;arg=0xfffffffc,<br>
kw=0xfffffffc)&nbsp;at&nbsp;Objects/abstract.c:1795&lt;br&gt;<br>
#17&nbsp;0xb7cba239&nbsp;in&nbsp;PyEval_EvalFrame&nbsp;(f=0x820f224)&nbsp;at&nbsp;Python/ceval.c:3776&lt;br&gt;<br>
#18&nbsp;0xb7cbd0eb&nbsp;in&nbsp;PyEval_EvalFrame&nbsp;(f=0x8195854)&nbsp;at&nbsp;Python/ceval.c:3651&lt;br&gt;<br>
#19&nbsp;0xb7cbd0eb&nbsp;in&nbsp;PyEval_EvalFrame&nbsp;(f=0x81c9ac4)&nbsp;at&nbsp;Python/ceval.c:3651&lt;br&gt;<br>
#20&nbsp;0xb7cbd719&nbsp;in&nbsp;PyEval_EvalCodeEx&nbsp;(co=0xb6b87e20,&nbsp;globals=0xfffffffc,<br>
locals=0x0,&nbsp;args=0x7,&nbsp;argcount=0,&nbsp;&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;kws=0x8282440,&nbsp;kwcount=7,&nbsp;defs=0x0,&nbsp;defcount=0,&nbsp;closure=0x0)&nbsp;at<br>
Python/ceval.c:2741&lt;br&gt;<br>
#21&nbsp;0xb7cbb46a&nbsp;in&nbsp;PyEval_EvalFrame&nbsp;(f=0x82822a4)&nbsp;at&nbsp;Python/ceval.c:3660&lt;br&gt;<br>
#22&nbsp;0xb7cbd719&nbsp;in&nbsp;PyEval_EvalCodeEx&nbsp;(co=0xb6b87ee0,&nbsp;globals=0xfffffffc,<br>
locals=0x0,&nbsp;args=0x0,&nbsp;argcount=2,&nbsp;&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;kws=0x0,&nbsp;kwcount=0,&nbsp;defs=0x0,&nbsp;defcount=0,&nbsp;closure=0x0)&nbsp;at<br>
Python/ceval.c:2741&lt;br&gt;<br>
#23&nbsp;0xb7d0d6be&nbsp;in&nbsp;function_call&nbsp;(func=0xb6af3a74,&nbsp;arg=0xb6b7c78c,<br>
kw=0x0)&nbsp;at&nbsp;Objects/funcobject.c:548&lt;br&gt;<br>
#24&nbsp;0xb7c65967&nbsp;in&nbsp;PyObject_Call&nbsp;(func=0x0,&nbsp;arg=0xfffffffc,<br>
kw=0xfffffffc)&nbsp;at&nbsp;Objects/abstract.c:1795&lt;br&gt;<br>
#25&nbsp;0xb7c6e389&nbsp;in&nbsp;instancemethod_call&nbsp;(func=0xfffffffc,&nbsp;arg=0xb6b7c78c,<br>
kw=0xfffffffc)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;at&nbsp;Objects/classobject.c:2532&lt;br&gt;<br>
#26&nbsp;0xb7c65bf6&nbsp;in&nbsp;PyObject_CallMethod&nbsp;(o=0x0,&nbsp;name=0xb6b891ec&nbsp;&quot;\001&quot;,<br>
format=0xb6b891ec&nbsp;&quot;\001&quot;)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;at&nbsp;Objects/abstract.c:1795&lt;br&gt;<br>
#27&nbsp;0xb7c5f505&nbsp;in&nbsp;python_handler&nbsp;(req=0x828a7b8,&nbsp;phase=0xb7d16e59<br>
&quot;PythonHandler&quot;)&nbsp;at&nbsp;mod_python.c:1652&lt;br&gt;<br>
#28&nbsp;0x08073daf&nbsp;in&nbsp;ap_run_handler&nbsp;(r=0x828a7b8)&nbsp;at&nbsp;config.c:157&lt;br&gt;<br>
#29&nbsp;0x080741b1&nbsp;in&nbsp;ap_invoke_handler&nbsp;(r=0x828a7b8)&nbsp;at&nbsp;config.c:372&lt;br&gt;<br>
---Type&nbsp;&amp;lt;return&amp;gt;&nbsp;to&nbsp;continue,&nbsp;or&nbsp;q&nbsp;&amp;lt;return&amp;gt;&nbsp;to&nbsp;quit---&lt;br&gt;<br>
#30&nbsp;0x0808ba77&nbsp;in&nbsp;ap_process_request&nbsp;(r=0x828a7b8)&nbsp;at&nbsp;http_request.c:258&lt;br&gt;<br>
#31&nbsp;0x0808929b&nbsp;in&nbsp;ap_process_http_connection&nbsp;(c=0x8185638)&nbsp;at<br>
http_core.c:184&lt;br&gt;<br>
#32&nbsp;0x0807a599&nbsp;in&nbsp;ap_run_process_connection&nbsp;(c=0x8185638)&nbsp;at<br>
connection.c:43&lt;br&gt;<br>
#33&nbsp;0x0809e55a&nbsp;in&nbsp;child_main&nbsp;(child_num_arg=-4)&nbsp;at&nbsp;prefork.c:640&lt;br&gt;<br>
#34&nbsp;0x0809e7a8&nbsp;in&nbsp;make_child&nbsp;(s=0x80c9c80,&nbsp;slot=0)&nbsp;at&nbsp;prefork.c:680&lt;br&gt;<br>
#35&nbsp;0x0809ee53&nbsp;in&nbsp;ap_mpm_run&nbsp;(_pconf=0xbf86d6f0,&nbsp;plog=0x81031a0,<br>
s=0xbf86d6f4)&nbsp;at&nbsp;prefork.c:956&lt;br&gt;<br>
#36&nbsp;0x080622c8&nbsp;in&nbsp;main&nbsp;(argc=2,&nbsp;argv=0xbf86d8b4)&nbsp;at&nbsp;main.c:717&lt;br&gt;<br>
(gdb)&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
