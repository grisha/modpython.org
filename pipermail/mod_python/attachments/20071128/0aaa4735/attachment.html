<tt>
&lt;META&nbsp;HTTP-EQUIV=&quot;Content-Type&quot;&nbsp;CONTENT=&quot;text/html;&nbsp;charset=iso-8859-1&quot;&gt;<br>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;3.2//EN&quot;&gt;<br>
&lt;HTML&gt;<br>
&lt;HEAD&gt;<br>
<br>
&lt;META&nbsp;NAME=&quot;Generator&quot;&nbsp;CONTENT=&quot;MS&nbsp;Exchange&nbsp;Server&nbsp;version&nbsp;6.5.7638.1&quot;&gt;<br>
&lt;TITLE&gt;Re:&nbsp;[mod_python]&nbsp;Session&nbsp;Hanging&nbsp;Problems&lt;/TITLE&gt;<br>
&lt;/HEAD&gt;<br>
&lt;BODY&gt;<br>
&lt;DIV&nbsp;id=idOWAReplyText81046&nbsp;dir=ltr&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;color=#000000&nbsp;size=2&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;See&nbsp;below&nbsp;what&nbsp;<br>
I&nbsp;did&nbsp;to&nbsp;use&nbsp;MySQL&amp;nbsp;as&nbsp;a&nbsp;session&nbsp;store.&lt;/FONT&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&nbsp;size=2&gt;This&nbsp;is&nbsp;done&nbsp;since&nbsp;I&nbsp;use&nbsp;multiple&nbsp;<br>
mod_python&nbsp;frond&nbsp;ends&nbsp;to&nbsp;connect&nbsp;to&nbsp;one&nbsp;DB&nbsp;server.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&nbsp;size=2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&nbsp;size=2&gt;Martijn&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&nbsp;size=2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&nbsp;size=2&gt;(these&nbsp;are&nbsp;changes&nbsp;made&nbsp;to&nbsp;the&nbsp;<br>
original&nbsp;Session.py&nbsp;from&nbsp;the&nbsp;mod_python&nbsp;package)&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;color=#000000&nbsp;size=2&gt;&lt;FONT&nbsp;<br>
face=&quot;Courier&nbsp;New&quot;&gt;&lt;/FONT&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;color=#000000&nbsp;size=2&gt;&lt;FONT&nbsp;<br>
face=&quot;Courier&nbsp;New&quot;&gt;&lt;/FONT&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;color=#000000&nbsp;size=2&gt;&lt;FONT&nbsp;<br>
face=&quot;Courier&nbsp;New&quot;&gt;###########################################################################&lt;BR&gt;##&nbsp;<br>
MySQLSession&lt;BR&gt;##&nbsp;M.&nbsp;Moeling,&nbsp;&lt;/FONT&gt;&lt;A&nbsp;href=&quot;mailto:martijn@xs4us.nu&quot;&gt;&lt;FONT&nbsp;<br>
face=&quot;Courier&nbsp;New&quot;&gt;martijn@xs4us.nu&lt;/FONT&gt;&lt;/A&gt;&lt;BR&gt;&lt;FONT&nbsp;<br>
face=&quot;Courier&nbsp;New&quot;&gt;##&lt;BR&gt;##&nbsp;In&nbsp;order&nbsp;to&nbsp;use&nbsp;MySQLSession:&lt;BR&gt;##&nbsp;in&nbsp;your&nbsp;<br>
handler.py:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;BR&gt;##&nbsp;import&nbsp;<br>
MySQLdb&lt;BR&gt;##&lt;BR&gt;##&amp;nbsp;&nbsp;Use:&lt;BR&gt;##&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
req.db&nbsp;=&nbsp;<br>
MySQLdb.connect(host=Chost,user=Cuser,passwd=Cpasswd,db=Cdb)&lt;BR&gt;##&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
req.cursor&nbsp;=&nbsp;req.db.cursor()&lt;BR&gt;##&nbsp;&lt;BR&gt;##&amp;nbsp;&nbsp;When&nbsp;req.cursor&nbsp;is&nbsp;existing,&nbsp;<br>
Session.py&nbsp;will&nbsp;default&nbsp;to&nbsp;MySQLSession&lt;BR&gt;##&amp;nbsp;&nbsp;Can&nbsp;be&nbsp;overruled&nbsp;with&nbsp;<br>
pythonoptions&nbsp;in&nbsp;apacheconfig&lt;BR&gt;##&lt;BR&gt;##&nbsp;To&nbsp;create&nbsp;table&nbsp;in&nbsp;MySQL&nbsp;use&nbsp;the&nbsp;<br>
following:&lt;BR&gt;##&nbsp;CREATE&nbsp;TABLE&nbsp;`Session`&nbsp;(&lt;BR&gt;##&amp;nbsp;&nbsp;`sid`&nbsp;varchar(50)&nbsp;NOT&nbsp;<br>
NULL,&lt;BR&gt;##&amp;nbsp;&nbsp;`store`&nbsp;text&nbsp;NOT&nbsp;NULL,&lt;BR&gt;##&amp;nbsp;&nbsp;PRIMARY&nbsp;KEY&amp;nbsp;&nbsp;<br>
(`sid`)&lt;BR&gt;##&nbsp;)&nbsp;TYPE=MyISAM;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
&lt;BR&gt;def&nbsp;MySQL_cleanup(req):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;req.cursor.execute(&quot;Select&nbsp;*&nbsp;<br>
from&nbsp;Session&quot;)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;AllSessions&nbsp;=&nbsp;<br>
req.cursor.fetchall()&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;stale=0&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
total=0&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;for&nbsp;record&nbsp;in&nbsp;<br>
AllSessions:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
total+=1&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;session&nbsp;=&nbsp;<br>
cPickle.loads(record[1])&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;<br>
(time.time()&nbsp;-&nbsp;session[&quot;_accessed&quot;])&nbsp;&amp;gt;&nbsp;<br>
session[&quot;_timeout&quot;]:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
stale+=1&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
req.cursor.execute(&quot;DELETE&nbsp;FROM&nbsp;Session&nbsp;where&nbsp;<br>
sid='&quot;+record[0]+&quot;'&quot;)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;req.log_error(&quot;MySQLSession:&nbsp;Removed:&nbsp;&quot;+str(stale)+&quot;&nbsp;<br>
stale&nbsp;records&nbsp;from&nbsp;&quot;+str(total)+&quot;&nbsp;in&nbsp;<br>
total&quot;,apache.APLOG_NOTICE)&lt;/FONT&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&nbsp;color=#000000&nbsp;<br>
size=2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;BR&gt;class&nbsp;<br>
MySQLSession(BaseSession):&lt;/FONT&gt;&lt;/DIV&gt;&lt;FONT&nbsp;color=#000000&nbsp;size=2&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;BR&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;<br>
req,&nbsp;sid=0,&nbsp;secret=None,&nbsp;timeout=0,&nbsp;lock=1):&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
BaseSession.__init__(self,&nbsp;req,&nbsp;sid=sid,&nbsp;<br>
secret=secret,&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
timeout=timeout,&nbsp;lock=lock)&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;<br>
do_cleanup(self):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._req.register_cleanup(MySQL_cleanup,&nbsp;<br>
self._req)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._req.log_error(&quot;MySQLSession:&nbsp;registered&nbsp;session&nbsp;<br>
cleanup.&quot;,apache.APLOG_NOTICE)&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;<br>
do_load(self):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._req.cursor.execute(&quot;Select&nbsp;store&nbsp;from&nbsp;Session&nbsp;where&nbsp;<br>
sid='&quot;+self._sid+&quot;'&quot;)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
store=self._req.cursor.fetchone()&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
if&nbsp;<br>
self._req.cursor.rowcount==1:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
return&nbsp;<br>
cPickle.loads(store[0].encode('utf-8'))&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
return&nbsp;None&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;do_save(self,&nbsp;<br>
dict):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._req.cursor.execute(&quot;Select&nbsp;store&nbsp;from&nbsp;Session&nbsp;where&nbsp;<br>
sid='&quot;+self._sid+&quot;'&quot;)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
store=self._req.cursor.fetchone()&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
if&nbsp;<br>
self._req.cursor.rowcount==1:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
Query=&quot;Update&nbsp;Session&nbsp;set&nbsp;store=\&quot;&quot;+cPickle.dumps(dict)+&quot;\&quot;&nbsp;where&nbsp;<br>
sid='&quot;+self._sid+&quot;'&quot;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
else:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
Query=&quot;Insert&nbsp;into&nbsp;Session&nbsp;(sid,store)&nbsp;values&nbsp;<br>
(\&quot;&quot;+self._sid+&quot;\&quot;,\&quot;&quot;+cPickle.dumps(dict)+&quot;\&quot;)&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._req.cursor.execute(Query)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;<br>
do_delete(self):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
try:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._req.cursor.execute(&quot;DELETE&nbsp;FROM&nbsp;Session&nbsp;where&nbsp;<br>
sid='&quot;+self._sid+&quot;'&quot;)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
except:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
pass&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;BR&gt;&lt;FONT&nbsp;<br>
face=&quot;Courier&nbsp;New&quot;&gt;###########################################################################&lt;BR&gt;##&nbsp;<br>
Session&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;##&nbsp;Changes&nbsp;made&nbsp;for&nbsp;MySQLSession&lt;BR&gt;##&nbsp;the&nbsp;<br>
application&nbsp;should&nbsp;set&nbsp;req.cursor&nbsp;as&nbsp;an&nbsp;MySQLdb&nbsp;cursor&nbsp;object&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;BR&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;def&nbsp;Session(req,&nbsp;sid=0,&nbsp;secret=None,&nbsp;<br>
timeout=0,&nbsp;lock=1):&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;opts&nbsp;=&nbsp;<br>
req.get_options()&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;<br>
opts.has_key('session'):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#&nbsp;Check&nbsp;<br>
the&nbsp;apache&nbsp;config&nbsp;for&nbsp;the&nbsp;type&nbsp;of&nbsp;<br>
session&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;sess_type&nbsp;=&nbsp;<br>
opts['session']&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
else:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;##&nbsp;MySQLSession&nbsp;is&nbsp;default&nbsp;<br>
when&nbsp;req.cursor&nbsp;exists&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;<br>
req.cursor:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
sess_type&nbsp;=&nbsp;'MySQLSession'&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
else:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;##&nbsp;END&nbsp;of&nbsp;MySQLSession&nbsp;<br>
modification&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
#&nbsp;no&nbsp;session&nbsp;class&nbsp;in&nbsp;config&nbsp;so&nbsp;get&nbsp;the&nbsp;default&nbsp;for&nbsp;the&nbsp;<br>
platform&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
threaded&nbsp;=&nbsp;<br>
_apache.mpm_query(apache.AP_MPMQ_IS_THREADED)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
forked&nbsp;=&nbsp;<br>
_apache.mpm_query(apache.AP_MPMQ_IS_FORKED)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
daemons&nbsp;=&amp;nbsp;&nbsp;<br>
_apache.mpm_query(apache.AP_MPMQ_MAX_DAEMONS)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
if&nbsp;(threaded&nbsp;and&nbsp;((not&nbsp;forked)&nbsp;or&nbsp;(daemons&nbsp;==&nbsp;<br>
1))):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
sess_type&nbsp;=&nbsp;<br>
'MemorySession'&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
else:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
sess_type&nbsp;=&nbsp;'DbmSession'&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;sess_type&nbsp;==&nbsp;<br>
'FileSession':&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;sess&nbsp;=&amp;nbsp;&nbsp;<br>
FileSession&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;elif&nbsp;sess_type&nbsp;==&nbsp;<br>
'DbmSession':&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;sess&nbsp;=&nbsp;<br>
DbmSession&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;elif&nbsp;sess_type&nbsp;==&nbsp;<br>
'MemorySession':&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;sess&nbsp;=&nbsp;<br>
MemorySession&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;##&nbsp;Added&nbsp;for&nbsp;<br>
MySQLSession&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;elif&nbsp;sess_type&nbsp;==&nbsp;<br>
'MySQLSession':&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;sess&nbsp;=&nbsp;<br>
MySQLSession&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
else:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#&nbsp;TODO&nbsp;Add&nbsp;capability&nbsp;to&nbsp;<br>
load&nbsp;a&nbsp;user&nbsp;defined&nbsp;class&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#&nbsp;For&nbsp;<br>
now,&nbsp;just&nbsp;raise&nbsp;an&nbsp;exception.&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
raise&nbsp;Exception,&nbsp;'Unknown&nbsp;session&nbsp;type&nbsp;%s'&nbsp;%&nbsp;sess_type&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;FONT&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;sess(req,&nbsp;<br>
sid=sid,&nbsp;<br>
secret=secret,&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
timeout=timeout,&nbsp;lock=lock)&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;BR&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&gt;&lt;BR&gt;<br>
&lt;HR&nbsp;tabIndex=-1&gt;<br>
&lt;FONT&nbsp;face=Tahoma&nbsp;size=2&gt;&lt;B&gt;Van:&lt;/B&gt;&nbsp;mod_python-bounces@modpython.org&nbsp;namens&nbsp;<br>
David&nbsp;Janes&lt;BR&gt;&lt;B&gt;Verzonden:&lt;/B&gt;&nbsp;di&nbsp;27.11.2007&nbsp;20:06&lt;BR&gt;&lt;B&gt;Aan:&lt;/B&gt;&nbsp;Harish&nbsp;<br>
Agarwal&lt;BR&gt;&lt;B&gt;CC:&lt;/B&gt;&nbsp;mod_python@modpython.org;&nbsp;Graham&nbsp;<br>
Dumpleton&lt;BR&gt;&lt;B&gt;Onderwerp:&lt;/B&gt;&nbsp;Re:&nbsp;[mod_python]&nbsp;Session&nbsp;Hanging&nbsp;<br>
Problems&lt;BR&gt;&lt;/FONT&gt;&lt;BR&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;size=2&gt;Here's&nbsp;what&nbsp;I'm&nbsp;experimenting&nbsp;with&nbsp;right&nbsp;now&nbsp;--&nbsp;I'm&nbsp;<br>
subclassing&lt;BR&gt;FileSession&nbsp;and&nbsp;overriding&nbsp;all&nbsp;the&nbsp;lock&nbsp;methods.&nbsp;Obviously&nbsp;this&nbsp;<br>
will&lt;BR&gt;have&nbsp;to&nbsp;be&nbsp;adapted&nbsp;for&nbsp;people&nbsp;not&nbsp;working&nbsp;in&nbsp;the&nbsp;FileSession&nbsp;<br>
world.&lt;BR&gt;&lt;BR&gt;Regards,&nbsp;etc...&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;class&nbsp;<br>
BMFileSession(Session.FileSession):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
def&nbsp;__init__(self,&nbsp;req,&nbsp;sid&nbsp;=&nbsp;<br>
None):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self.bm_lockf&nbsp;=&nbsp;<br>
None&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;...&nbsp;<br>
more&nbsp;init&nbsp;stuff&nbsp;...&lt;BR&gt;&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;<br>
lock(self):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
if&nbsp;<br>
self._lock:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self.bm_lock(self._req.server,&nbsp;<br>
self._sid)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._locked&nbsp;=&nbsp;<br>
1&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._req.register_cleanup(Session.unlock_session_cleanup,&nbsp;<br>
self)&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;<br>
unlock(self):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
if&nbsp;self._lock&nbsp;and&nbsp;<br>
self._locked:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self.bm_unlock(self._req.server,&nbsp;<br>
self._sid)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._locked&nbsp;=&nbsp;0&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;<br>
lock_file(self):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
if&nbsp;not&nbsp;<br>
self._locked:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self.bm_lock(self._req.server,&nbsp;<br>
self._sid)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._locked&nbsp;=&nbsp;1&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;<br>
unlock_file(self):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
if&nbsp;self._locked&nbsp;and&nbsp;not&nbsp;<br>
self._lock:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self.bm_unlock(self._req.server,&nbsp;<br>
self._sid)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self._locked&nbsp;=&nbsp;0&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;<br>
bm_lockfile(self,&nbsp;<br>
sid):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
lockdir&nbsp;=&nbsp;os.path.join(self._sessdir,&nbsp;<br>
sid[:2])&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
if&nbsp;not&nbsp;<br>
os.path.exists(lockdir):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
os.makedirs(lockdir)&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
return&amp;nbsp;&nbsp;os.path.join(lockdir,&nbsp;<br>
sid)&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;bm_lock(self,&nbsp;server,&nbsp;<br>
sid):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;<br>
self.bm_lockf:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
try:&nbsp;<br>
self.bm_lockf.close()&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
except:&nbsp;<br>
pass&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self.bm_lockf&nbsp;=&nbsp;open(self.bm_lockfile(sid),&nbsp;<br>
'a+')&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
fcntl.lockf(self.bm_lockf,&nbsp;<br>
fcntl.LOCK_EX)&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;<br>
bm_unlock(self,&nbsp;server,&nbsp;<br>
sid):&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;<br>
self.bm_lockf:&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
fcntl.lockf(self.bm_lockf,&nbsp;<br>
fcntl.LOCK_UN)&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
try:&nbsp;<br>
self.bm_lockf.close()&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
except:&nbsp;<br>
pass&lt;BR&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
self.bm_lockf&nbsp;=&nbsp;<br>
None&lt;BR&gt;_______________________________________________&lt;BR&gt;Mod_python&nbsp;mailing&nbsp;<br>
list&lt;BR&gt;Mod_python@modpython.org&lt;BR&gt;&lt;A&nbsp;<br>
href=&quot;http://mailman.modpython.org/mailman/listinfo/mod_python&quot;&gt;http://mailman.modpython.org/mailman/listinfo/mod_python&lt;/A&gt;&lt;BR&gt;&lt;/FONT&gt;&lt;/P&gt;&lt;/DIV&gt;<br>
<br>
&lt;/BODY&gt;<br>
&lt;/HTML&gt;
</tt>
