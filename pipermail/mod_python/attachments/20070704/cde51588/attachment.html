<tt>
&lt;div&gt;quite&nbsp;right,&nbsp;thanks&nbsp;a&nbsp;lot:)&lt;/div&gt;<br>
&lt;div&gt;Then&nbsp;is&nbsp;the&nbsp;connection&nbsp;object&nbsp;suitable&nbsp;for&nbsp;my&nbsp;case?&nbsp;It&nbsp;seems&nbsp;request&nbsp;based&nbsp;handling&nbsp;is&nbsp;just&nbsp;for&nbsp;short&nbsp;connections,&nbsp;and&nbsp;conn_write()&nbsp;has&nbsp;its&nbsp;own&nbsp;pool&nbsp;mgmt&nbsp;code:&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(len)&nbsp;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;buff&nbsp;=&nbsp;apr_pmemdup(c-&amp;gt;pool,&nbsp;PyString_AS_STRING(s),&nbsp;len);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;bb&nbsp;=&nbsp;apr_brigade_create(c-&amp;gt;pool,&nbsp;c-&amp;gt;bucket_alloc);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;b&nbsp;=&nbsp;apr_bucket_pool_create(buff,&nbsp;len,&nbsp;c-&amp;gt;pool,&nbsp;c-&amp;gt;bucket_alloc);<br>
&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;APR_BRIGADE_INSERT_TAIL(bb,&nbsp;b);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;/*&nbsp;Make&nbsp;sure&nbsp;the&nbsp;data&nbsp;is&nbsp;flushed&nbsp;to&nbsp;the&nbsp;client&nbsp;*/&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;b&nbsp;=&nbsp;apr_bucket_flush_create(c-&amp;gt;bucket_alloc);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;APR_BRIGADE_INSERT_TAIL(bb,&nbsp;b);&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;ap_pass_brigade(c-&amp;gt;output_filters,&nbsp;bb);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}&amp;nbsp;&amp;nbsp;&nbsp;&lt;/div&gt;<br>
&lt;div&gt;&amp;nbsp;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;7/4/07,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Graham&nbsp;Dumpleton&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:graham.dumpleton@gmail.com&quot;&gt;graham.dumpleton@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;PADDING-LEFT:&nbsp;1ex;&nbsp;MARGIN:&nbsp;0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;&nbsp;BORDER-LEFT:&nbsp;#ccc&nbsp;1px&nbsp;solid&quot;&gt;On&nbsp;04/07/07,&nbsp;Graham&nbsp;Dumpleton&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:graham.dumpleton@gmail.com&quot;&gt;graham.dumpleton@gmail.com&lt;/a&gt;<br>
&amp;gt;&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;On&nbsp;04/07/07,&nbsp;Graham&nbsp;Dumpleton&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:graham.dumpleton@gmail.com&quot;&gt;graham.dumpleton@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;On&nbsp;03/07/07,&nbsp;yubing&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:trueice@gmail.com&quot;&gt;trueice@gmail.com<br>
&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&amp;gt;&nbsp;Anyhow,&nbsp;it&amp;#39;s&nbsp;clear&nbsp;that&nbsp;ap_rflush&nbsp;is&nbsp;the&nbsp;root&nbsp;cause&nbsp;of&nbsp;this&nbsp;memory&nbsp;leak,&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&amp;gt;&nbsp;maybe&nbsp;we&nbsp;should&nbsp;find&nbsp;a&nbsp;new&nbsp;API&nbsp;for&nbsp;this&nbsp;(maybe&nbsp;we&nbsp;should&nbsp;also&nbsp;add&nbsp;a&nbsp;new&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;&amp;gt;&nbsp;method&nbsp;to&nbsp;the&nbsp;request_object&nbsp;).<br>
&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;It&nbsp;is&nbsp;not&nbsp;just&nbsp;ap_rflush()&nbsp;but&nbsp;also&nbsp;ap_rwrite(),&nbsp;as&nbsp;it&nbsp;is&nbsp;also&nbsp;using&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;the&nbsp;request&nbsp;pool.&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;To&nbsp;avoid&nbsp;the&nbsp;problem&nbsp;would&nbsp;mean&nbsp;creating&nbsp;a&nbsp;separate&nbsp;pool&nbsp;just&nbsp;for&nbsp;the<br>
&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;one&nbsp;operation&nbsp;and&nbsp;for&nbsp;the&nbsp;buckets&nbsp;to&nbsp;be&nbsp;allocated&nbsp;from&nbsp;that,&nbsp;with&nbsp;the&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;pool&nbsp;destroyed&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;call.&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;Unfortunately&nbsp;it&nbsp;isn&amp;#39;t&nbsp;perhaps&nbsp;quite&nbsp;as&nbsp;simple&nbsp;as&nbsp;that&nbsp;though.&nbsp;This&nbsp;is<br>
&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;because&nbsp;one&nbsp;can&nbsp;only&nbsp;use&nbsp;a&nbsp;separate&nbsp;pool&nbsp;if&nbsp;you&nbsp;know&nbsp;the&nbsp;buckets&nbsp;would&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;be&nbsp;used&nbsp;up&nbsp;and&nbsp;no&nbsp;longer&nbsp;required&nbsp;after&nbsp;the&nbsp;call.&nbsp;When&nbsp;doing&nbsp;a&nbsp;flush&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;this&nbsp;may&nbsp;be&nbsp;the&nbsp;case,&nbsp;but&nbsp;need&nbsp;to&nbsp;check.&nbsp;Definitely&nbsp;not&nbsp;the&nbsp;case&nbsp;if<br>
&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;not&nbsp;doing&nbsp;a&nbsp;flush&nbsp;though.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;Okay,&nbsp;I&amp;#39;m&nbsp;confused&nbsp;now.&nbsp;The&nbsp;bucket&nbsp;functions&nbsp;aren&amp;#39;t&nbsp;supposed&nbsp;to&nbsp;be&lt;br&gt;&amp;gt;&nbsp;allocating&nbsp;memory&nbsp;out&nbsp;of&nbsp;the&nbsp;resource&nbsp;pool.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;/**&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;*&nbsp;Create&nbsp;a&nbsp;new&nbsp;bucket&nbsp;brigade.&amp;nbsp;&amp;nbsp;The&nbsp;bucket&nbsp;brigade&nbsp;is&nbsp;originally&nbsp;empty.<br>
&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;*&nbsp;@param&nbsp;p&nbsp;The&nbsp;pool&nbsp;to&nbsp;associate&nbsp;with&nbsp;the&nbsp;brigade.&amp;nbsp;&amp;nbsp;Data&nbsp;is&nbsp;not&nbsp;allocated&nbsp;out&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;*&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;of&nbsp;the&nbsp;pool,&nbsp;but&nbsp;a&nbsp;cleanup&nbsp;is&nbsp;registered.&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;*&nbsp;@param&nbsp;list&nbsp;The&nbsp;bucket&nbsp;allocator&nbsp;to&nbsp;use&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;*&nbsp;@return&nbsp;The&nbsp;empty&nbsp;bucket&nbsp;brigade<br>
&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;*/&lt;br&gt;&amp;gt;&nbsp;APU_DECLARE(apr_bucket_brigade&nbsp;*)&nbsp;apr_brigade_create(apr_pool_t&nbsp;*p,&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;apr_bucket_alloc_t&nbsp;*list);&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;Ie.,&nbsp;it&nbsp;takes&nbsp;buckets&nbsp;from&nbsp;a&nbsp;bucket&nbsp;list,&nbsp;to&nbsp;which&nbsp;buckets&nbsp;are<br>
&lt;br&gt;&amp;gt;&nbsp;returned&nbsp;for&nbsp;reuse&nbsp;when&nbsp;the&nbsp;bucket&nbsp;brigade&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;at&nbsp;the&lt;br&gt;&amp;gt;&nbsp;completion&nbsp;of&nbsp;the&nbsp;operation.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;The&nbsp;only&nbsp;reason&nbsp;the&nbsp;request&nbsp;pool&nbsp;is&nbsp;required&nbsp;is&nbsp;so&nbsp;that&nbsp;the&nbsp;bucket&lt;br&gt;&amp;gt;&nbsp;brigade&nbsp;can&nbsp;be&nbsp;cleaned&nbsp;up&nbsp;automatically&nbsp;if&nbsp;the&nbsp;code&nbsp;forgets&nbsp;to<br>
&lt;br&gt;&amp;gt;&nbsp;explicitly&nbsp;destroy&nbsp;it&nbsp;before&nbsp;the&nbsp;request&nbsp;is&nbsp;over.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;So,&nbsp;looks&nbsp;like&nbsp;I&nbsp;have&nbsp;some&nbsp;more&nbsp;research&nbsp;to&nbsp;do&nbsp;to&nbsp;understand&nbsp;all&nbsp;this.&nbsp;:-(&lt;br&gt;&lt;br&gt;Understand&nbsp;now.&nbsp;The&nbsp;buckets&nbsp;themselves&nbsp;are&nbsp;reused,&nbsp;but&nbsp;the&nbsp;bucket<br>
&lt;br&gt;brigade&nbsp;object&nbsp;is&nbsp;not.&nbsp;Thus&nbsp;for&nbsp;each&nbsp;ap_rwrite()/ap_rflush()&nbsp;memory&lt;br&gt;will&nbsp;increase&nbsp;still&nbsp;because&nbsp;of&nbsp;the&nbsp;bucket&nbsp;brigade&nbsp;object.&nbsp;What&nbsp;is&nbsp;also&lt;br&gt;odd&nbsp;is&nbsp;that&nbsp;the&nbsp;bucket&nbsp;brigade&nbsp;isn&amp;#39;t&nbsp;even&nbsp;notionally&nbsp;destroyed,&lt;br&gt;meaning&nbsp;that&nbsp;the&nbsp;cleanup&nbsp;handler&nbsp;isn&amp;#39;t&nbsp;killed&nbsp;off&nbsp;and&nbsp;would&nbsp;appear&nbsp;to<br>
&lt;br&gt;hang&nbsp;around&nbsp;until&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;request&nbsp;at&nbsp;which&nbsp;point&nbsp;it&nbsp;would&nbsp;be&lt;br&gt;called.&nbsp;If&nbsp;you&nbsp;have&nbsp;lots&nbsp;of&nbsp;bucket&nbsp;brigade&nbsp;objects&nbsp;created,&nbsp;that&nbsp;could&lt;br&gt;be&nbsp;a&nbsp;lot&nbsp;of&nbsp;cleanup&nbsp;handlers&nbsp;needing&nbsp;to&nbsp;be&nbsp;killed.&lt;br&gt;&lt;br&gt;Anyway,&nbsp;I&nbsp;will&nbsp;not&nbsp;post&nbsp;any&nbsp;more&nbsp;on&nbsp;this.&nbsp;I&amp;#39;ll&nbsp;work&nbsp;out&nbsp;a&nbsp;solution&nbsp;for<br>
&lt;br&gt;mod_wsgi&nbsp;and&nbsp;then&nbsp;create&nbsp;a&nbsp;JIRA&nbsp;issue&nbsp;for&nbsp;mod_python&nbsp;describing&nbsp;what&lt;br&gt;might&nbsp;be&nbsp;done&nbsp;for&nbsp;mod_python&nbsp;when&nbsp;we&nbsp;get&nbsp;around&nbsp;to&nbsp;doing&nbsp;more&nbsp;changes&lt;br&gt;to&nbsp;it.&lt;br&gt;&lt;br&gt;Graham&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;br&gt;--&nbsp;&lt;br&gt;<br>
truly&nbsp;yours&lt;br&gt;ice&nbsp;<br>

</tt>
