<tt>
&lt;div&gt;Now,&nbsp;the&nbsp;python&nbsp;streamer&nbsp;only&nbsp;issue&nbsp;one&nbsp;flush&nbsp;about&nbsp;every&nbsp;30&nbsp;frames,&nbsp;the&nbsp;memory&nbsp;usage&nbsp;grows&nbsp;very&nbsp;slow:)&lt;br&gt;&lt;br&gt;Maybe&nbsp;Apache&nbsp;is&nbsp;too&nbsp;complicated&nbsp;for&nbsp;me,&nbsp;its&nbsp;default&nbsp;output&nbsp;filters&nbsp;requires&nbsp;the&nbsp;buckets&nbsp;and&nbsp;brigades.&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;&amp;nbsp;&lt;/div&gt;<br>
&lt;div&gt;apr_brigade_create&nbsp;does&nbsp;actually&nbsp;do&nbsp;the&nbsp;pool&nbsp;allocation:&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&gt;APU_DECLARE(apr_bucket_brigade&nbsp;*)&nbsp;apr_brigade_create(apr_pool_t&nbsp;*p,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;apr_bucket_alloc_t&nbsp;*list)&lt;br&gt;{&amp;nbsp;&amp;nbsp;&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;apr_bucket_brigade&nbsp;*b;&lt;/p&gt;<br>
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;b&nbsp;=&nbsp;apr_palloc(p,&nbsp;sizeof(*b));&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;b-&amp;gt;p&nbsp;=&nbsp;p;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;b-&amp;gt;bucket_alloc&nbsp;=&nbsp;list;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;APR_RING_INIT(&amp;amp;b-&amp;gt;list,&nbsp;apr_bucket,&nbsp;link);&lt;/p&gt;<br>
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;apr_pool_cleanup_register(b-&amp;gt;p,&nbsp;b,&nbsp;brigade_cleanup,&nbsp;apr_pool_cleanup_null);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;b;&lt;br&gt;}&amp;nbsp;&nbsp;&lt;/p&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;7/4/07,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Graham&nbsp;Dumpleton&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:graham.dumpleton@gmail.com&quot;&gt;graham.dumpleton@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;PADDING-LEFT:&nbsp;1ex;&nbsp;MARGIN:&nbsp;0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;&nbsp;BORDER-LEFT:&nbsp;#ccc&nbsp;1px&nbsp;solid&quot;&gt;On&nbsp;04/07/07,&nbsp;Graham&nbsp;Dumpleton&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:graham.dumpleton@gmail.com&quot;&gt;graham.dumpleton@gmail.com&lt;/a&gt;<br>
&amp;gt;&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;On&nbsp;03/07/07,&nbsp;yubing&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:trueice@gmail.com&quot;&gt;trueice@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;Anyhow,&nbsp;it&amp;#39;s&nbsp;clear&nbsp;that&nbsp;ap_rflush&nbsp;is&nbsp;the&nbsp;root&nbsp;cause&nbsp;of&nbsp;this&nbsp;memory&nbsp;leak,&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;maybe&nbsp;we&nbsp;should&nbsp;find&nbsp;a&nbsp;new&nbsp;API&nbsp;for&nbsp;this&nbsp;(maybe&nbsp;we&nbsp;should&nbsp;also&nbsp;add&nbsp;a&nbsp;new<br>
&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&nbsp;method&nbsp;to&nbsp;the&nbsp;request_object&nbsp;).&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;It&nbsp;is&nbsp;not&nbsp;just&nbsp;ap_rflush()&nbsp;but&nbsp;also&nbsp;ap_rwrite(),&nbsp;as&nbsp;it&nbsp;is&nbsp;also&nbsp;using&lt;br&gt;&amp;gt;&nbsp;the&nbsp;request&nbsp;pool.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;To&nbsp;avoid&nbsp;the&nbsp;problem&nbsp;would&nbsp;mean&nbsp;creating&nbsp;a&nbsp;separate&nbsp;pool&nbsp;just&nbsp;for&nbsp;the<br>
&lt;br&gt;&amp;gt;&nbsp;one&nbsp;operation&nbsp;and&nbsp;for&nbsp;the&nbsp;buckets&nbsp;to&nbsp;be&nbsp;allocated&nbsp;from&nbsp;that,&nbsp;with&nbsp;the&lt;br&gt;&amp;gt;&nbsp;pool&nbsp;destroyed&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;call.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;Unfortunately&nbsp;it&nbsp;isn&amp;#39;t&nbsp;perhaps&nbsp;quite&nbsp;as&nbsp;simple&nbsp;as&nbsp;that&nbsp;though.&nbsp;This&nbsp;is&lt;br&gt;&amp;gt;&nbsp;because&nbsp;one&nbsp;can&nbsp;only&nbsp;use&nbsp;a&nbsp;separate&nbsp;pool&nbsp;if&nbsp;you&nbsp;know&nbsp;the&nbsp;buckets&nbsp;would<br>
&lt;br&gt;&amp;gt;&nbsp;be&nbsp;used&nbsp;up&nbsp;and&nbsp;no&nbsp;longer&nbsp;required&nbsp;after&nbsp;the&nbsp;call.&nbsp;When&nbsp;doing&nbsp;a&nbsp;flush&lt;br&gt;&amp;gt;&nbsp;this&nbsp;may&nbsp;be&nbsp;the&nbsp;case,&nbsp;but&nbsp;need&nbsp;to&nbsp;check.&nbsp;Definitely&nbsp;not&nbsp;the&nbsp;case&nbsp;if&lt;br&gt;&amp;gt;&nbsp;not&nbsp;doing&nbsp;a&nbsp;flush&nbsp;though.&lt;br&gt;&lt;br&gt;Okay,&nbsp;I&amp;#39;m&nbsp;confused&nbsp;now.&nbsp;The&nbsp;bucket&nbsp;functions&nbsp;aren&amp;#39;t&nbsp;supposed&nbsp;to&nbsp;be<br>
&lt;br&gt;allocating&nbsp;memory&nbsp;out&nbsp;of&nbsp;the&nbsp;resource&nbsp;pool.&lt;br&gt;&lt;br&gt;/**&lt;br&gt;*&nbsp;Create&nbsp;a&nbsp;new&nbsp;bucket&nbsp;brigade.&amp;nbsp;&amp;nbsp;The&nbsp;bucket&nbsp;brigade&nbsp;is&nbsp;originally&nbsp;empty.&lt;br&gt;*&nbsp;@param&nbsp;p&nbsp;The&nbsp;pool&nbsp;to&nbsp;associate&nbsp;with&nbsp;the&nbsp;brigade.&amp;nbsp;&amp;nbsp;Data&nbsp;is&nbsp;not&nbsp;allocated&nbsp;out&lt;br&gt;*&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;of&nbsp;the&nbsp;pool,&nbsp;but&nbsp;a&nbsp;cleanup&nbsp;is&nbsp;registered.<br>
&lt;br&gt;*&nbsp;@param&nbsp;list&nbsp;The&nbsp;bucket&nbsp;allocator&nbsp;to&nbsp;use&lt;br&gt;*&nbsp;@return&nbsp;The&nbsp;empty&nbsp;bucket&nbsp;brigade&lt;br&gt;*/&lt;br&gt;APU_DECLARE(apr_bucket_brigade&nbsp;*)&nbsp;apr_brigade_create(apr_pool_t&nbsp;*p,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;apr_bucket_alloc_t&nbsp;*list);<br>
&lt;br&gt;&lt;br&gt;Ie.,&nbsp;it&nbsp;takes&nbsp;buckets&nbsp;from&nbsp;a&nbsp;bucket&nbsp;list,&nbsp;to&nbsp;which&nbsp;buckets&nbsp;are&lt;br&gt;returned&nbsp;for&nbsp;reuse&nbsp;when&nbsp;the&nbsp;bucket&nbsp;brigade&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;at&nbsp;the&lt;br&gt;completion&nbsp;of&nbsp;the&nbsp;operation.&lt;br&gt;&lt;br&gt;The&nbsp;only&nbsp;reason&nbsp;the&nbsp;request&nbsp;pool&nbsp;is&nbsp;required&nbsp;is&nbsp;so&nbsp;that&nbsp;the&nbsp;bucket<br>
&lt;br&gt;brigade&nbsp;can&nbsp;be&nbsp;cleaned&nbsp;up&nbsp;automatically&nbsp;if&nbsp;the&nbsp;code&nbsp;forgets&nbsp;to&lt;br&gt;explicitly&nbsp;destroy&nbsp;it&nbsp;before&nbsp;the&nbsp;request&nbsp;is&nbsp;over.&lt;br&gt;&lt;br&gt;So,&nbsp;looks&nbsp;like&nbsp;I&nbsp;have&nbsp;some&nbsp;more&nbsp;research&nbsp;to&nbsp;do&nbsp;to&nbsp;understand&nbsp;all&nbsp;this.&nbsp;:-(&lt;br&gt;&lt;br&gt;Graham&lt;br&gt;&lt;/blockquote&gt;<br>
&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;br&gt;--&nbsp;&lt;br&gt;truly&nbsp;yours&lt;br&gt;ice&nbsp;<br>

</tt>
