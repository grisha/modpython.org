<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Headers not being sent when input/output is over a
	certain size
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Headers%20not%20being%20sent%20when%20input/output%20is%20over%20a%0A%09certain%20size&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024189.html">
   <LINK REL="Next"  HREF="024191.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Headers not being sent when input/output is over a
	certain size</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Sidnei da Silva</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Headers%20not%20being%20sent%20when%20input/output%20is%20over%20a%0A%09certain%20size&In-Reply-To="
       TITLE="[mod_python] Headers not being sent when input/output is over a
	certain size">sidnei at enfoldsystems.com
       </A><BR>
    <I>Wed Sep  5 12:21:27 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024189.html">[mod_python] Howto force reload of all modules
</A></li>
        <LI>Next message: <A HREF="024191.html">[mod_python] [SPAM] Great Service
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24190">[ date ]</a>
              <a href="thread.html#24190">[ thread ]</a>
              <a href="subject.html#24190">[ subject ]</a>
              <a href="author.html#24190">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok, I was finally able to figure out part of the problem and a solution for 
it.

The issue is that if the response fits in 'io_buffer_size' which defaults to 
8k, then the output filters get all called in the same iteration. In 
particular, there's one filter called 'HTTP_HEADER' which is responsible for 
emitting the headers. Obviously, to make things work right, it should be the 
last one to be called, which it is apparently.

However, when the response is larger than io_buffer_size, the filters get 
called multiple times. Unfortunately, HTTP_HEADER is one such filter, so the 
first time around the mod_python filter gets called, but hasn't seen EOS, so 
it doesn't change the headers. Then the HTTP_HEADER gets called and sends 
the headers. Then after that you can't change the headers anymore.

My initial hack was to set 'req.assbackwards', which prevented the 
HTTP_HEADER from doing it's thing, and then when the mod_python filter sees 
EOS then I set 'req.assbackwards' to 1 and call 
req.add_output_filter('HTTP_HEADER'). That works, but depends on filter 
implementation internals, so I felt I needed a better fix.

Then I stumble upon 'mod_filter', which has lots of interesting 
configuration knobs. The interesting one is 'FilterProtocol', which lets you 
specify if your filter will change the content length and if it supports 
byte ranges, and also that you want your filter to be the first one in the 
chain. So I toggled those settings, and it magically works.

Here's my configuration file:
<A HREF="https://svn.enfoldsystems.com/browse/public/enfold.lxml/trunk/docs/sample-apache.conf?rev=1321&amp;view=auto">https://svn.enfoldsystems.com/browse/public/enfold.lxml/trunk/docs/sample-apache.conf?rev=1321&amp;view=auto</A>

It would be great to document this somewhere, so that the next person 
doesn't have to suffer that much. Maybe add some notes to mod_python docs? I 
will certainly write a blog entry.

-- 
Sidnei da Silva
Enfold Systems, Inc. 

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024189.html">[mod_python] Howto force reload of all modules
</A></li>
	<LI>Next message: <A HREF="024191.html">[mod_python] [SPAM] Great Service
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24190">[ date ]</a>
              <a href="thread.html#24190">[ thread ]</a>
              <a href="subject.html#24190">[ subject ]</a>
              <a href="author.html#24190">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
