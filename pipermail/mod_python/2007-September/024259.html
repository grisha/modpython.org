<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mod_python] Concurrence and virtual host interpreter python
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Concurrence%20and%20virtual%20host%20interpreter%20python&In-Reply-To=W3S1N5kG.1190971173.8215010.pfreixes%40milnou.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024252.html">
   <LINK REL="Next"  HREF="024260.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mod_python] Concurrence and virtual host interpreter python</H1>
<table border=0 width="100%"><tr><td valign="top">
    <B>Jim Gallacher</B> 
    <A HREF="mailto:mod_python%40modpython.org?Subject=%5Bmod_python%5D%20Concurrence%20and%20virtual%20host%20interpreter%20python&In-Reply-To=W3S1N5kG.1190971173.8215010.pfreixes%40milnou.net"
       TITLE="[mod_python] Concurrence and virtual host interpreter python">jpg at jgassociates.ca
       </A><BR>
    <I>Sat Sep 29 15:25:27 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024252.html">[mod_python] Concurrence and virtual host interpreter python
</A></li>
        <LI>Next message: <A HREF="024260.html">[mod_python] Concurrence and virtual host interpreter python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24259">[ date ]</a>
              <a href="thread.html#24259">[ thread ]</a>
              <a href="subject.html#24259">[ subject ]</a>
              <a href="author.html#24259">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Pau Freixes wrote:
&gt;<i> Hi to all, Im new in a list.
</I>&gt;<i> 
</I>&gt;<i> Well, this last days I was work for testing and learn how work with multi
</I>&gt;<i> thread and multi interpreter environment in embedding python in C
</I>&gt;<i> applications, and of course mod_python it's a excellent place for
</I>&gt;<i> understand this.
</I>
You'll need to throw multi-process into the mix of things to understand.
  I'm not actually sure if mod_python *is* an excellent environment for
your learning endeavours as there are a number of complicating factors 
introduced by apache and your browser.

The behaviour that you'll see will depend on which apache mpm you are
using: prefork, worker or winnt. If you haven't already done so you
should take a look at <A HREF="http://httpd.apache.org/docs/2.0/mpm.html">http://httpd.apache.org/docs/2.0/mpm.html</A>

In order to effectively answer your questions you'll need to let us know
  us know which mpm you are using. Also, what are you using as your
client?

&gt;<i> Ok, with my lectures and test with mod_python code, i have a some
</I>&gt;<i> questions, somebody can help me for understand this concepts ?
</I>&gt;<i> 
</I>&gt;<i> 1. I was try multi concurrence in a virtual host python script with this
</I>&gt;<i> easy code
</I>&gt;<i> 
</I>&gt;<i> def handler(req):
</I>&gt;<i> 
</I>&gt;<i>     # Request Content Type
</I>&gt;<i>     req.content_type = &quot;text/plain&quot;
</I>&gt;<i> 
</I>&gt;<i>     VALUE2 = 1
</I>&gt;<i>     for i in range(1,10):
</I>&gt;<i>         req.write(&quot;Value is %d\r\n&quot; % VALUE2)
</I>&gt;<i>         time.sleep(5)
</I>&gt;<i> 
</I>&gt;<i>         # change global variable
</I>&gt;<i>         VALUE2 = VALUE2 + 1;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     req.write(&quot;Hellow World&quot;)
</I>&gt;<i>     return apache.OK
</I>&gt;<i> 
</I>&gt;<i> And my surprise it's that apache only process the next request when the
</I>&gt;<i> previous request has been served. !!
</I>&gt;<i> I don't understand this strange behavior, because mod_python it's made
</I>&gt;<i> for accept concurrent threads in same interpreter, and i test a similar
</I>&gt;<i> situation  in a c code and it's possible do run some threads at same
</I>&gt;<i> time in same interpreter.
</I>&gt;<i> 
</I>&gt;<i> time.sleep(5) it's a pretty situation for python core for change the
</I>&gt;<i> context and release GIL and assign to this to other thread. yes ?
</I>
Are you sure you're not seeing an artifact of the browser keeping the 
connection open? If this is the case then your request is being 
serialized by apache and the GIL doesn't enter into it.

You could play with your apache config (KeepAlive off and so on), but 
it's likely easier to use a different test client such as wget. Also, 
modify your req.write() calls to immediately flush the data, which will 
make it easier to see what's going on. eg. req.write(&quot;something&quot;,1)

Open multiple terminals and run the following in each simultaneously (or 
as near as you can make it).

wget -S -O - <A HREF="http://..../index.py">http://..../index.py</A>

I think you'll see that mod_python is behaving exactly as you'd expect.

&gt;<i> 
</I>&gt;<i> 2. And de second question it's in similar situation, when you reuse a
</I>&gt;<i> interpreter for all request to same virtual host, with this code :
</I>&gt;<i> 
</I>&gt;<i> import time
</I>&gt;<i> 
</I>&gt;<i> VALUE = 1
</I>&gt;<i> 
</I>&gt;<i> def handler(req):
</I>&gt;<i>     global VALUE
</I>&gt;<i> 
</I>&gt;<i>     # Request Content Type
</I>&gt;<i>     req.content_type = &quot;text/plain&quot;
</I>&gt;<i> 
</I>&gt;<i>     for i in range(1,10):
</I>&gt;<i>         req.write(&quot;Value is %d\r\n&quot; % VALUE)
</I>&gt;<i>         time.sleep(5)
</I>&gt;<i> 
</I>&gt;<i>         # change global variable
</I>&gt;<i>         VALUE = VALUE + 1;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     req.write(&quot;Hellow World&quot;)
</I>&gt;<i>     return apache.OK
</I>&gt;<i> 
</I>&gt;<i> VALUE it's a global variable for de index.py, and subsequent request for
</I>&gt;<i> the same url (<A HREF="http://...../index.py">http://...../index.py</A>) show one incremental value for
</I>&gt;<i> VALUE. For example, this two request produced this two results
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://...../index.py">http://...../index.py</A>
</I>&gt;<i> 
</I>&gt;<i> Value is 1
</I>&gt;<i> Value is 2
</I>&gt;<i> Value is 3
</I>&gt;<i> Value is 4
</I>&gt;<i> Value is 5
</I>&gt;<i> Value is 6
</I>&gt;<i> Value is 7
</I>&gt;<i> Value is 8
</I>&gt;<i> Value is 9
</I>&gt;<i> Hellow World
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://...../index.py">http://...../index.py</A>
</I>&gt;<i> 
</I>&gt;<i> Value is 10
</I>&gt;<i> Value is 11
</I>&gt;<i> Value is 12
</I>&gt;<i> Value is 13
</I>&gt;<i> Value is 14
</I>&gt;<i> Value is 15
</I>&gt;<i> Value is 16
</I>&gt;<i> Value is 17
</I>&gt;<i> Value is 18
</I>&gt;<i> Hellow World
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Ok, this situation it's really and i think its very normal because only
</I>&gt;<i> callback to handler it's made with the same interpreter and VALUE is
</I>&gt;<i> not re assigned to value 1, may be ?
</I>
The statement &quot;VALUE = 1&quot; is only evaluated when the module (index.py)
is first loaded. It is not re-evaluated for each request. Note however
that VALUE should *not* be considered a global variable. Depending on
which apache mpm is being used you could have multiple, independent
copies of VALUE. Using the mpm-prefork and the default MaxClients value
of 256, you could potentially have 256 copies of VALUE if your server is
under a heavy load. A similar situation exists with mpm-worker where you
could still have a number of independent multi-threaded child processes.

&gt;<i> 3. And the most important question, why mod_python not use a separate
</I>&gt;<i> interpreters for all request ?
</I>
I'm not 100% sure what you are asking. Do you mean a separate
interpreter for each request? If so then the resource usage would be
unacceptably high. The default is to have a separate subinterpreter for
each virtual host.

Jim


</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024252.html">[mod_python] Concurrence and virtual host interpreter python
</A></li>
	<LI>Next message: <A HREF="024260.html">[mod_python] Concurrence and virtual host interpreter python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24259">[ date ]</a>
              <a href="thread.html#24259">[ thread ]</a>
              <a href="subject.html#24259">[ subject ]</a>
              <a href="author.html#24259">[ author ]</a>
         </LI>
       </UL>

</td>
<td align="right" valign="top">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42971867-2', 'modpython.org');
  ga('send', 'pageview');
</script>

</td>
</table>

<hr>
<a href="http://mailman.modpython.org/mailman/listinfo/mod_python">More information about the Mod_python
mailing list</a><br>
</body></html>
